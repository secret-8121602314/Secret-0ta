var he=Object.defineProperty;var pe=(c,e,t)=>e in c?he(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t;var g=(c,e,t)=>pe(c,typeof e!="symbol"?e+"":e,t);import{s as l}from"./auth-SOvlGLRs.js";import{n as fe,a as y,i as se,b as oe,S as O,U as ye,T as re}from"./chat-services-C2lvwS7G.js";import{b as be,c as G,j as I,d as W}from"./core-services-z2li2Njd.js";class Se{constructor(){g(this,"memoryCache",new Map);g(this,"DEFAULT_TTL",300*1e3);g(this,"CACHE_TABLE","app_cache");g(this,"MAX_MEMORY_CACHE_SIZE",100);g(this,"pendingRequests",new Map)}async set(e,t,s=this.DEFAULT_TTL,r="general",a){const n=Date.now()+s;this.memoryCache.set(e,{value:t,expires:n}),console.log(`[CacheService] Stored in memory cache: ${e}`);try{console.log(`[CacheService] Storing in Supabase: ${e} (type: ${r}, user: ${a||"none"})`);const{error:o}=await l.from(this.CACHE_TABLE).upsert({key:e,value:JSON.stringify(t),expires_at:new Date(n).toISOString(),updated_at:new Date().toISOString(),cache_type:r,user_id:a||null,size_bytes:JSON.stringify(t).length});o?console.warn(`[CacheService] Failed to store cache in Supabase for key ${e}:`,o):console.log(`[CacheService] Successfully stored in Supabase: ${e}`)}catch(o){console.warn(`[CacheService] Supabase cache unavailable for key ${e}, using memory only:`,o)}this.memoryCache.size>this.MAX_MEMORY_CACHE_SIZE&&this.cleanupMemoryCache()}async get(e,t=!1){if(this.pendingRequests.has(e))return console.log(`[CacheService] Request deduplication: waiting for pending request for key: ${e}`),await this.pendingRequests.get(e);const s=this.memoryCache.get(e);if(s&&Date.now()<=s.expires)return console.log(`[CacheService] Cache HIT (memory): ${e}`),s.value;if(s&&this.memoryCache.delete(e),t)return console.log(`[CacheService] Cache MISS (memory-only mode): ${e}`),null;const r=this.fetchFromSupabase(e);this.pendingRequests.set(e,r);try{return await r}finally{this.pendingRequests.delete(e)}}async fetchFromSupabase(e){try{console.log(`[CacheService] Cache MISS (memory), trying Supabase: ${e}`);const{data:t,error:s}=await l.from(this.CACHE_TABLE).select("value, expires_at").eq("key",e).maybeSingle();if(s)return console.warn(`[CacheService] Supabase error for key ${e}:`,s),null;if(!t)return console.log(`[CacheService] Cache MISS (Supabase): ${e}`),null;const r=new Date(t.expires_at).getTime();if(Date.now()>r)return console.log(`[CacheService] Cache EXPIRED (Supabase): ${e}`),await this.delete(e),null;console.log(`[CacheService] Cache HIT (Supabase): ${e}`);const a=JSON.parse(typeof t.value=="string"?t.value:"{}");return this.memoryCache.set(e,{value:a,expires:r}),a}catch(t){return console.warn(`[CacheService] Error retrieving cache for key ${e}:`,t),null}}async has(e){return await this.get(e)!==null}async delete(e){const t=this.memoryCache.delete(e);try{const{error:s}=await l.from(this.CACHE_TABLE).delete().eq("key",e);s&&console.warn("[CacheService] Failed to delete cache from Supabase:",s)}catch(s){console.warn("[CacheService] Error deleting cache:",s)}return t}async clear(){this.memoryCache.clear(),this.pendingRequests.clear();try{const{error:e}=await l.from(this.CACHE_TABLE).delete().neq("key","never_delete");e&&console.warn("[CacheService] Failed to clear Supabase cache:",e)}catch(e){console.warn("[CacheService] Error clearing cache:",e)}}async cleanup(){const e=Date.now();this.cleanupMemoryCache();try{const{error:t}=await l.from(this.CACHE_TABLE).delete().lt("expires_at",new Date(e).toISOString());t&&console.warn("[CacheService] Failed to cleanup Supabase cache:",t)}catch(t){console.warn("[CacheService] Error cleaning up cache:",t)}}cleanupMemoryCache(){const e=Date.now(),t=Array.from(this.memoryCache.entries());t.forEach(([s,r])=>{e>r.expires&&this.memoryCache.delete(s)}),this.memoryCache.size>this.MAX_MEMORY_CACHE_SIZE&&t.filter(([a])=>this.memoryCache.has(a)).sort((a,n)=>a[1].expires-n[1].expires).slice(0,this.memoryCache.size-this.MAX_MEMORY_CACHE_SIZE).forEach(([a])=>this.memoryCache.delete(a))}getStats(){return{memorySize:this.memoryCache.size,memoryKeys:Array.from(this.memoryCache.keys())}}async getSupabaseStats(){try{const{data:e,error:t}=await l.rpc("get_cache_stats");return t?(console.warn("[CacheService] Failed to get Supabase stats:",t),null):e}catch(e){return console.warn("[CacheService] Error getting Supabase stats:",e),null}}async getPerformanceMetrics(){try{const{data:e,error:t}=await l.rpc("get_cache_performance_metrics");return t?(console.warn("[CacheService] Failed to get performance metrics:",t),null):e}catch(e){return console.warn("[CacheService] Error getting performance metrics:",e),null}}async getUserCacheEntries(e){try{const{data:t,error:s}=await l.rpc("get_user_cache_entries",{p_user_id:e});return s?(console.warn("[CacheService] Failed to get user cache entries:",s),[]):t||[]}catch(t){return console.warn("[CacheService] Error getting user cache entries:",t),[]}}async clearUserCache(e){try{const{data:t,error:s}=await l.rpc("clear_user_cache",{p_user_id:e});return s?(console.warn("[CacheService] Failed to clear user cache:",s),0):t||0}catch(t){return console.warn("[CacheService] Error clearing user cache:",t),0}}async setChatContext(e,t){await this.set(`chat_context:${e}`,t,2160*60*60*1e3,"context",e)}async getChatContext(e){return await this.get(`chat_context:${e}`)}async setUserMemory(e,t){await this.set(`user_memory:${e}`,t,365*24*60*60*1e3,"memory",e)}async getUserMemory(e){return await this.get(`user_memory:${e}`)}async setGameContext(e,t,s){await this.set(`game_context:${e}:${t}`,s,2160*60*60*1e3,"context",e)}async getGameContext(e,t){return await this.get(`game_context:${e}:${t}`)}async setUser(e,t){await this.set(`user:${e}`,t,365*24*60*60*1e3,"user",e)}async getUser(e){return await this.get(`user:${e}`)}async setRateLimit(e,t){await this.set(`rate_limit:${e}`,t,900*1e3,"rate_limit")}async getRateLimit(e){return await this.get(`rate_limit:${e}`)}async setConversation(e,t,s){await this.set(`conversation:${e}`,t,365*24*60*60*1e3,"conversation",s)}async getConversation(e){return await this.get(`conversation:${e}`)}async initializeCacheTable(){try{const{error:e}=await l.from(this.CACHE_TABLE).select("key").limit(1);e&&e.code==="PGRST116"&&(console.log("[CacheService] Creating cache table..."),console.warn("[CacheService] Cache table needs to be created in Supabase"))}catch{}}}const w=new Se;w.initializeCacheTable().catch(()=>{});setInterval(()=>{w.cleanup()},300*1e3);class H{static handle(e,t,s){if(this.errorCount++,this.isErrorRateLimited()){console.warn("[ErrorService] Error rate limit exceeded, suppressing error:",e);return}console.error(`[${t}]`,{message:e.message,stack:e.stack,context:t,timestamp:new Date().toISOString(),errorCount:this.errorCount}),s&&this.showUserMessage(s),this.reportError(e,t)}static handleAuthError(e,t){const s=this.getAuthErrorMessage(t);this.handle(e,`AuthService:${t}`,s)}static handleWebSocketError(e,t){const s=this.getWebSocketErrorMessage(t);this.handle(e,`WebSocketService:${t}`,s)}static handleConversationError(e,t){const s=this.getConversationErrorMessage(t);this.handle(e,`ConversationService:${t}`,s)}static handleDatabaseError(e,t){const s=this.getDatabaseErrorMessage(t);this.handle(e,`DatabaseService:${t}`,s)}static isErrorRateLimited(){const e=Date.now();return this.recentErrors=this.recentErrors.filter(t=>e-t<this.errorWindow),this.recentErrors.push(e),this.recentErrors.length>this.maxErrorsPerMinute}static showUserMessage(e){console.warn(`[User Message] ${e}`)}static reportError(e,t){console.warn("[Error Reporting] Would report error to monitoring service:",{error:e.message,context:t,timestamp:new Date().toISOString()})}static getAuthErrorMessage(e){return{signIn:"Failed to sign in. Please check your credentials and try again.",signOut:"Failed to sign out. Please try again.",loadUser:"Failed to load user data. Please refresh the page.",createUser:"Failed to create user account. Please try again.",refreshUser:"Failed to refresh user data. Please try again."}[e]||"An authentication error occurred. Please try again."}static getWebSocketErrorMessage(e){return{connect:"Failed to connect to server. Please check your internet connection.",send:"Failed to send message. Please try again.",disconnect:"Failed to disconnect. Please try again."}[e]||"A connection error occurred. Please try again."}static getConversationErrorMessage(e){return{create:"Failed to create conversation. Please try again.",load:"Failed to load conversations. Please refresh the page.",save:"Failed to save conversation. Please try again.",delete:"Failed to delete conversation. Please try again."}[e]||"A conversation error occurred. Please try again."}static getDatabaseErrorMessage(e){return{save:"Failed to save data. Please try again.",load:"Failed to load data. Please refresh the page.",update:"Failed to update data. Please try again.",delete:"Failed to delete data. Please try again."}[e]||"A database error occurred. Please try again."}static getStats(){return{totalErrors:this.errorCount,recentErrors:this.recentErrors.length,isRateLimited:this.isErrorRateLimited()}}static reset(){this.errorCount=0,this.recentErrors=[]}}g(H,"errorCount",0),g(H,"maxErrorsPerMinute",10),g(H,"errorWindow",60*1e3),g(H,"recentErrors",[]);class we{constructor(){g(this,"toasts",[]);g(this,"listeners",new Set);g(this,"maxToasts",5)}subscribe(e){return this.listeners.add(e),e(this.toasts),()=>{this.listeners.delete(e)}}notify(){this.listeners.forEach(e=>e([...this.toasts]))}show(e,t="info",s={}){const r=`toast-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,a={id:r,message:e,type:t,duration:s.duration??this.getDefaultDuration(t),action:s.action,dismissible:s.dismissible??!0};return this.toasts.unshift(a),this.toasts.length>this.maxToasts&&(this.toasts=this.toasts.slice(0,this.maxToasts)),this.notify(),a.duration&&a.duration>0&&setTimeout(()=>this.dismiss(r),a.duration),r}success(e,t){return this.show(e,"success",{duration:3e3,...t})}error(e,t){return this.show(e,"error",{duration:7e3,dismissible:!0,...t})}warning(e,t){return this.show(e,"warning",{duration:5e3,...t})}info(e,t){return this.show(e,"info",{duration:4e3,...t})}dismiss(e){const t=this.toasts.findIndex(s=>s.id===e);t!==-1&&(this.toasts.splice(t,1),this.notify())}dismissAll(){this.toasts=[],this.notify()}getDefaultDuration(e){switch(e){case"success":return 3e3;case"error":return 7e3;case"warning":return 5e3;case"info":return 4e3;default:return 4e3}}loading(e){const t=this.show(e,"info",{duration:0,dismissible:!1});return()=>this.dismiss(t)}async promise(e,t){const s=this.loading(t.loading);try{const r=await e;s();const a=typeof t.success=="function"?t.success(r):t.success;return this.success(a),r}catch(r){s();const a=typeof t.error=="function"?t.error(r):t.error;throw this.error(a),r}}}const Y=new we,st=Object.freeze(Object.defineProperty({__proto__:null,toastService:Y},Symbol.toStringTag,{value:"Module"})),P=class P{constructor(){}static getInstance(){return P.instance||(P.instance=new P),P.instance}async getOnboardingStatus(e){try{console.log("ðŸŽ¯ [OnboardingService] Getting onboarding status for user:",e);const{data:t,error:s}=await l.rpc("get_user_onboarding_status",{p_user_id:e});if(s)return console.error("ðŸŽ¯ [OnboardingService] Error getting onboarding status:",s),null;if(console.log("ðŸŽ¯ [OnboardingService] Onboarding status raw data:",t),!t||t.length===0)return console.log("ðŸŽ¯ [OnboardingService] No onboarding data found for user"),null;const r=t[0];return console.log("ðŸŽ¯ [OnboardingService] Onboarding status (first element):",r),r}catch(t){return console.error("ðŸŽ¯ [OnboardingService] Error getting onboarding status:",t),null}}async updateOnboardingStatus(e,t,s={}){try{const{error:r}=await l.rpc("update_user_onboarding_status",{p_user_id:e,p_step:t,p_data:s});return r?(console.error("Error updating onboarding status:",r),!1):!0}catch(r){return console.error("Error updating onboarding status:",r),!1}}async getOnboardingProgress(e){try{const{data:t,error:s}=await l.from("onboarding_progress").select("*").eq("user_id",e).order("completed_at",{ascending:!0});return s?(console.error("Error getting onboarding progress:",s),[]):(t||[]).map(r=>({step:r.step,completed_at:r.created_at||"",data:r.data||{}}))}catch(t){return console.error("Error getting onboarding progress:",t),[]}}async markSplashScreensSeen(e){return this.updateOnboardingStatus(e,"initial",{splash_screens_seen:!0,timestamp:new Date().toISOString()})}async markProfileSetupComplete(e,t){try{const{error:s}=await l.from("users").update({has_profile_setup:!0,profile_data:t,updated_at:new Date().toISOString()}).eq("auth_user_id",e);return s?(console.error("Error marking profile setup complete:",s),!1):!0}catch(s){return console.error("Error marking profile setup complete:",s),!1}}async markWelcomeMessageShown(e){return this.updateOnboardingStatus(e,"complete",{welcome_message_shown:!0,timestamp:new Date().toISOString()})}async markOnboardingComplete(e){return this.updateOnboardingStatus(e,"complete",{onboarding_complete:!0,timestamp:new Date().toISOString()})}getBooleanValue(e,t=!1){return e==null?t:!!e}async getNextOnboardingStep(e){try{console.log("ðŸŽ¯ [OnboardingService] Getting next step for user:",e);const t=await this.getOnboardingStatus(e);if(console.log("ðŸŽ¯ [OnboardingService] User status:",t),!t)return console.log("ðŸŽ¯ [OnboardingService] No status found, returning login"),"login";const s=this.getBooleanValue(t.has_seen_splash_screens),r=this.getBooleanValue(t.has_seen_how_to_use),a=this.getBooleanValue(t.has_seen_features_connected),n=this.getBooleanValue(t.has_seen_pro_features),o=this.getBooleanValue(t.pc_connected),i=this.getBooleanValue(t.pc_connection_skipped);return console.log("ðŸŽ¯ [OnboardingService] Processed values:",{hasSeenSplashScreens:s,hasSeenHowToUse:r,hasSeenFeaturesConnected:a,hasSeenProFeatures:n,pcConnected:o,pcConnectionSkipped:i}),s?s&&!r?(console.log("ðŸŽ¯ [OnboardingService] User needs to see how-to-use screen, returning how-to-use"),"how-to-use"):r&&o&&!a?(console.log("ðŸŽ¯ [OnboardingService] PC connected, showing features-connected screen"),"features-connected"):r&&!o&&i&&!n?(console.log("ðŸŽ¯ [OnboardingService] PC connection skipped, showing pro-features screen"),"pro-features"):r&&!o&&!i?(console.log("ðŸŽ¯ [OnboardingService] PC connection failed, returning to how-to-use screen"),"how-to-use"):a&&!n?(console.log("ðŸŽ¯ [OnboardingService] User needs to see pro-features screen, returning pro-features"),"pro-features"):n?(console.log("ðŸŽ¯ [OnboardingService] User has seen pro features, onboarding complete"),"complete"):(console.warn("ðŸŽ¯ [OnboardingService] WARNING: Unexpected flow state, returning to how-to-use"),"how-to-use"):(console.log("ðŸŽ¯ [OnboardingService] User hasn't seen splash screens, returning initial"),"initial")}catch(t){return console.error("ðŸŽ¯ [OnboardingService] Error getting next onboarding step:",t),"login"}}async shouldShowOnboarding(e){try{const t=await this.getOnboardingStatus(e);return t?!t.onboarding_completed:!0}catch(t){return console.error("Error checking if should show onboarding:",t),!0}}async trackOnboardingStep(e,t,s,r={}){try{await l.from("user_analytics").insert({user_id:e,event_type:"onboarding_step",event_data:{step:t,action:s,data:r,timestamp:new Date().toISOString()}})}catch(a){console.error("Error tracking onboarding step:",a)}}async trackOnboardingDropOff(e,t,s,r={}){try{await l.from("user_analytics").insert({user_id:e,event_type:"onboarding_dropoff",event_data:{step:t,reason:s,data:r,timestamp:new Date().toISOString()}})}catch(a){console.error("Error tracking onboarding dropoff:",a)}}async resetOnboarding(e){try{const{error:t}=await l.from("onboarding_progress").delete().eq("user_id",e);if(t)return console.error("Error clearing onboarding progress:",t),!1;const{error:s}=await l.from("users").update({is_new_user:!0,has_seen_splash_screens:!1,has_profile_setup:!1,has_welcome_message:!1,onboarding_completed:!1,onboarding_data:{}}).eq("id",e);return s?(console.error("Error resetting user onboarding flags:",s),!1):!0}catch(t){return console.error("Error resetting onboarding:",t),!1}}async getOnboardingStats(){try{const{count:e}=await l.from("users").select("*",{count:"exact",head:!0}),{count:t}=await l.from("users").select("*",{count:"exact",head:!0}).eq("onboarding_completed",!0),{data:s}=await l.from("user_analytics").select("event_data").eq("event_type","onboarding_dropoff"),r={};return s&&s.forEach(a=>{const n=a.event_data;if(typeof n=="object"&&n!==null&&!Array.isArray(n)){const o=n.step;typeof o=="string"&&(r[o]=(r[o]||0)+1)}}),{total_users:e||0,completed_onboarding:t||0,dropoff_by_step:r}}catch(e){return console.error("Error getting onboarding stats:",e),{total_users:0,completed_onboarding:0,dropoff_by_step:{}}}}};g(P,"instance");let J=P;const rt=J.getInstance();let h=null;const ve="wss://otakon-relay.onrender.com";let K=0;const Te=5e3,V=[];let j=null,E=null,T=null;const Ce=3e4,ie=(c,e,t,s,r)=>{if(h&&(h.readyState===WebSocket.OPEN||h.readyState===WebSocket.CONNECTING))return;if(!/^\d{6}$/.test(c)){s("Invalid code format. Please enter a 6-digit code.");return}j=c,E={onOpen:e,onMessage:t,onError:s,onClose:r};const a=`${ve}/${c}`;try{h=new WebSocket(a)}catch(n){const o=n instanceof Error?n.message:"An unknown error occurred.";s(`Connection failed: ${o}. Please check the URL and your network connection.`);return}h.onopen=()=>{for(K=0,e();V.length&&h&&h.readyState===WebSocket.OPEN;){const n=V.shift();try{h.send(JSON.stringify(n))}catch{}}T&&(clearInterval(T),T=null),T=window.setInterval(()=>{if(h&&h.readyState===WebSocket.OPEN)try{h.send(JSON.stringify({type:"ping",ts:Date.now()}))}catch{}},Ce)},h.onmessage=n=>{try{const o=JSON.parse(n.data);t(o)}catch{}},h.onerror=()=>{},h.onclose=n=>{if(n.wasClean,!n.wasClean){let o="Connection closed unexpectedly.";n.code===1006?o="Connection to the server failed. Please check your network, verify the code, and ensure the PC client is running.":n.reason&&(o=`Connection closed: ${n.reason}`),s(o)}if(h=null,r(),T&&(clearInterval(T),T=null),j&&E){K+=1;const o=Math.min(Te,500*Math.pow(2,K-1)),i=Math.random()*300,u=o+i;setTimeout(()=>{!h&&E&&ie(j,E.onOpen,E.onMessage,E.onError,E.onClose)},u)}}},_e=c=>{h&&h.readyState===WebSocket.OPEN?h.send(JSON.stringify(c)):V.push(c)},Ee=()=>{h&&(h.close(1e3,"User disconnected"),h=null),K=0,T&&(clearInterval(T),T=null),j=null,E=null},at=Object.freeze(Object.defineProperty({__proto__:null,connect:ie,disconnect:Ee,send:_e},Symbol.toStringTag,{value:"Module"}));class nt{static async addToWaitlist(e,t="landing_page"){try{console.log("Adding to waitlist using direct table operations");const{data:s,error:r}=await l.from("waitlist").insert({email:e,source:t,status:"pending"}).select();if(r){if(console.error("Error adding to waitlist:",r),console.error("Insert error details:",{message:r.message,code:r.code,details:r.details,hint:r.hint}),r.code==="23505")return{success:!0,alreadyExists:!0,error:"You're already on our waitlist! We'll email you when access is ready."};const{data:a,error:n}=await l.from("waitlist").select("email, status, created_at").eq("email",e).maybeSingle();return n?(console.error("Error checking existing email:",n),{success:!1,error:`Failed to add to waitlist: ${r.message}`}):a?{success:!0,alreadyExists:!0,error:"You're already on our waitlist! We'll email you when access is ready."}:{success:!1,error:`Failed to add to waitlist: ${r.message}`}}return console.log("Successfully added to waitlist:",s),{success:!0,alreadyExists:!1,error:void 0}}catch(s){return console.error("Waitlist service error:",s),{success:!1,error:"An unexpected error occurred"}}}static async getWaitlistCount(){try{const{count:e,error:t}=await l.from("waitlist").select("*",{count:"exact",head:!0});return t?(console.error("Error getting waitlist count:",t),{error:"Failed to get count"}):{count:e||0}}catch(e){return console.error("Error getting waitlist count:",e),{error:"Failed to get count"}}}static async getWaitlistStats(){try{const{data:e,error:t}=await l.from("waitlist").select("status");if(t)return console.error("Error fetching waitlist stats:",t),{total:137,pending:137,invited:0,converted:0};const s={total:e.length,pending:0,invited:0,converted:0};return e.forEach(r=>{const a=r.status||"pending";a==="pending"?s.pending++:a==="approved"?s.invited++:a==="rejected"&&s.converted++}),s}catch(e){return console.error("Error fetching waitlist stats:",e),{total:137,pending:137,invited:0,converted:0}}}}class N{static get(e,t){try{const s=localStorage.getItem(e);return s?JSON.parse(s):t}catch(s){return console.error(`Error getting ${e} from localStorage:`,s),t}}static set(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(s){console.error(`Error setting ${e} in localStorage:`,s)}}static remove(e){try{localStorage.removeItem(e)}catch(t){console.error(`Error removing ${e} from localStorage:`,t)}}static clear(){try{localStorage.clear()}catch(e){console.error("Error clearing localStorage:",e)}}}class Ae{constructor(){g(this,"CONVERSATION_TTL",720*60*60*1e3);g(this,"CONTEXT_TTL",1440*60*1e3)}async saveConversation(e,t){const s=`conversation:${e.id}`;await w.set(s,e,this.CONVERSATION_TTL,"conversation",t)}async loadConversation(e){const t=`conversation:${e}`;return await w.get(t)}async saveChatContext(e,t){await w.setChatContext(e,t)}async loadChatContext(e){return await w.getChatContext(e)}async saveUserMemory(e,t){await w.setUserMemory(e,t)}async loadUserMemory(e){return await w.getUserMemory(e)}async saveConversationSummary(e,t){const s=`conversation_summary:${e}`;await w.set(s,t,this.CONTEXT_TTL)}async loadConversationSummary(e){const t=`conversation_summary:${e}`;return await w.get(t)}async saveGameContext(e,t,s){await w.setGameContext(e,t,s)}async loadGameContext(e,t){return await w.getGameContext(e,t)}async getUserConversations(e){return[]}async clearUserChatData(e){await w.clearUserCache(e)}}const ot=new Ae,it=c=>{const e=new Map,t=/\[OTAKON_([A-Z_]+):\s*(.*?)\]/g;let s=c,r;for(;(r=t.exec(c))!==null;){const a=r[1];let n=r[2].trim();console.log(`ðŸ” [OtakonTags] Found tag: ${a}, raw value: "${n}"`);try{n.startsWith("{")&&n.endsWith("}")&&(n=JSON.parse(n),console.log("ðŸ” [OtakonTags] Parsed as JSON object:",n)),n.startsWith("[")&&n.endsWith("]")&&(n=JSON.parse(n.replace(/'/g,'"')),console.log("ðŸ” [OtakonTags] Parsed as JSON array:",n))}catch{console.log("ðŸ” [OtakonTags] JSON parsing failed, keeping as string:",n)}e.set(a,n),s=s.replace(r[0],"")}return s=s.replace(/^Hint:\s*\n\s*Hint:\s*/gm,"Hint: ").replace(/^Hint:\s*\n\s*Hint:\s*/gm,"Hint: ").replace(/\s*\]\s*$/,"").replace(/\s*\[\s*$/,"").replace(/^\s*\]\s*/,"").replace(/^\s*\[\s*/,"").replace(/\*\*\s+([^*]+?)\s+\*\*/g,"**$1**").replace(/\*\*\s+([^*]+?):/g,"**$1:**").replace(/^Hint:/i,"**Hint:**").replace(/\nHint:/gi,`

**Hint:**`).replace(/\nLore:/gi,`

**Lore:**`).replace(/\nPlaces of Interest:/gi,`

**Places of Interest:**`).replace(/\nStrategy:/gi,`

**Strategy:**`).replace(/\nWhat to focus on:/gi,`

**What to focus on:**`).replace(/\n{3,}/g,`

`).replace(/^\s+|\s+$/g,"").trim(),{cleanContent:s,tags:e}},R=class R{constructor(){}static getInstance(){return R.instance||(R.instance=new R),R.instance}generateProfileSpecificTabs(e,t){const s=[];return e.playerFocus==="Story-Driven"&&s.push({id:"narrative_themes",title:"Narrative Themes",type:"story",priority:"high",isProfileSpecific:!0,instruction:this.getNarrativeThemesInstruction(e.hintStyle)}),e.playerFocus==="Completionist"&&s.push({id:"secret_hunting",title:"Secret Hunting",type:"tips",priority:"high",isProfileSpecific:!0,instruction:this.getSecretHuntingInstruction(e.hintStyle)}),e.playerFocus==="Strategist"&&s.push({id:"optimization_guide",title:"Optimization Guide",type:"strategies",priority:"high",isProfileSpecific:!0,instruction:this.getOptimizationInstruction(e.hintStyle)}),t!=null&&t.playthroughCount&&t.playthroughCount>1&&s.push({id:"playthrough_comparison",title:"Playthrough Comparison",type:"tips",priority:"medium",isProfileSpecific:!0,instruction:this.getPlaythroughComparisonInstruction(e)}),s}getNarrativeThemesInstruction(e){const t={Cryptic:"Provide subtle hints about story themes without revealing major plot points. Use metaphorical language and thematic connections.",Balanced:"Discuss narrative elements with moderate detail, balancing spoiler avoidance with meaningful insight into themes and character arcs.",Direct:"Explain story themes clearly while maintaining appropriate spoiler warnings. Provide direct analysis of narrative elements encountered so far."};return t[e]||t.Balanced}getSecretHuntingInstruction(e){const t={Cryptic:"Give mysterious clues about hidden content locations. Use environmental riddles and subtle hints that require exploration.",Balanced:"Provide clear directions to secrets with some exploration challenge. Balance helpfulness with maintaining the joy of discovery.",Direct:"Give precise locations and requirements for finding secrets. Include step-by-step instructions and exact coordinates when helpful."};return t[e]||t.Balanced}getOptimizationInstruction(e){const t={Cryptic:"Suggest optimization strategies through hints and examples. Let the player discover the optimal path with guidance.",Balanced:"Provide balanced optimization advice with clear explanations. Suggest effective approaches while leaving room for experimentation.",Direct:"Give specific optimization recommendations with detailed steps. Provide exact stat allocations, builds, and strategies for maximum efficiency."};return t[e]||t.Direct}getPlaythroughComparisonInstruction(e){return`Compare different playthrough approaches based on ${e.playerFocus} style and ${e.hintStyle} preferences. Highlight what's different this time and suggest new strategies to explore.`}prioritizeTabsForProfile(e,t){return e.sort((s,r)=>{if(s.isProfileSpecific&&!r.isProfileSpecific)return-1;if(!s.isProfileSpecific&&r.isProfileSpecific)return 1;const a={high:3,medium:2,low:1};return a[r.priority]-a[s.priority]})}getHintStyleModifier(e){const t={Cryptic:"Use subtle, metaphorical hints. Avoid direct answers. Make the player think and discover.",Balanced:"Provide clear guidance while leaving room for exploration. Balance helpfulness with discovery.",Direct:"Give explicit, step-by-step instructions. Be precise and comprehensive in explanations."};return t[e]||t.Balanced}getPlayerFocusModifier(e){const t={"Story-Driven":"Emphasize narrative elements, character development, and story context. Prioritize lore and thematic content.",Completionist:"Focus on collectibles, hidden items, side quests, and 100% completion strategies. Highlight missable content.",Strategist:"Prioritize optimal strategies, build optimization, and efficient progression. Focus on mechanics and systems."};return t[e]||t.Strategist}getSpoilerToleranceModifier(e){const t={Strict:"NEVER mention future events, characters, or plot points. Only discuss content up to current progress.",Moderate:"You may hint at upcoming content in vague terms, but avoid specific spoilers.",Relaxed:"You can discuss future content more freely, but still mark major spoilers clearly."};return t[e]||t.Strict}getToneModifier(e){const t={Encouraging:"Use an enthusiastic, supportive tone. Celebrate achievements and provide positive reinforcement.",Professional:"Maintain a knowledgeable, respectful tone. Provide expertise without excessive casualness.",Casual:"Use a friendly, conversational tone. Feel free to use gaming terminology and be relaxed."};return t[e]||t.Professional}buildProfileContext(e){return[`Hint Style: ${this.getHintStyleModifier(e.hintStyle)}`,`Player Focus: ${this.getPlayerFocusModifier(e.playerFocus)}`,`Spoiler Tolerance: ${this.getSpoilerToleranceModifier(e.spoilerTolerance)}`,`Tone: ${this.getToneModifier(e.preferredTone)}`].join(`
`)}getDefaultProfile(){return{hintStyle:"Balanced",playerFocus:"Strategist",preferredTone:"Professional",spoilerTolerance:"Strict"}}};g(R,"instance");let X=R;const U=X.getInstance(),Q=`
You MUST use the following tags to structure your response. Do not put them in a code block.
- [OTAKON_GAME_ID: Game Name]: The full, official name of the game you've identified.
- [OTAKON_CONFIDENCE: high|low]: Your confidence in the game identification.
- [OTAKON_GENRE: Genre]: The primary genre of the identified game. Must be one of:
  â€¢ Action RPG - Action-focused RPGs with real-time combat (Dark Souls, God of War, etc.)
  â€¢ RPG - Traditional role-playing games with deep stories and character progression
  â€¢ Souls-like - Challenging action games inspired by Dark Souls (Elden Ring, Sekiro, Hollow Knight, etc.)
  â€¢ Metroidvania - Non-linear exploration platformers with ability-gated progression
  â€¢ Open-World - Large open-world games with exploration focus (GTA, Zelda: BOTW, etc.)
  â€¢ Survival-Crafting - Survival games with resource gathering and crafting mechanics
  â€¢ First-Person Shooter - FPS games
  â€¢ Strategy - Strategy and tactical games (RTS, turn-based, 4X)
  â€¢ Adventure - Story-driven adventure and narrative games
  â€¢ Simulation - Simulation and management games
  â€¢ Sports - Sports games and sports management sims
  â€¢ Multiplayer Shooter - Competitive multiplayer FPS games
  â€¢ Multiplayer Sports - Competitive multiplayer sports games
  â€¢ Racing - Racing games and driving sims
  â€¢ Fighting - Fighting games
  â€¢ Battle Royale - Battle royale games
  â€¢ MMORPG - Massively multiplayer online RPGs
  â€¢ Puzzle - Puzzle games
  â€¢ Horror - Horror and survival horror games
  â€¢ Default - Use this only if none of the above genres fit
  **Important**: Use the EXACT genre names listed above. Choose the MOST SPECIFIC genre that fits the game.
- [OTAKON_GAME_STATUS: unreleased]: ONLY include this tag if the game is NOT YET RELEASED. Verify the release date before including this tag.
- [OTAKON_IS_FULLSCREEN: true|false]: Whether the screenshot shows fullscreen gameplay (not menus, launchers, or non-game screens).
- [OTAKON_TRIUMPH: {"type": "boss_defeated", "name": "Boss Name"}]: When analyzing a victory screen.
- [OTAKON_OBJECTIVE_SET: {"description": "New objective"}]: When a new player objective is identified.
- [OTAKON_INSIGHT_UPDATE: {"id": "sub_tab_id", "content": "content"}]: To update a specific sub-tab.
- [OTAKON_INSIGHT_MODIFY_PENDING: {"id": "sub_tab_id", "title": "New Title", "content": "New content"}]: When user asks to modify a subtab via @command.
- [OTAKON_INSIGHT_DELETE_REQUEST: {"id": "sub_tab_id"}]: When user asks to delete a subtab via @command.
- [OTAKON_SUGGESTIONS: ["suggestion1", "suggestion2", "suggestion3"]]: Three contextual follow-up prompts for the user. Make these short, specific questions that help the user learn more about the current situation, get tips, or understand what to do next.
`,Oe=`
**Command Centre - Subtab Management:**
Users can manage subtabs using @ commands:
1. **@<tab_name> <instruction>**: Update a subtab with new information
   - Example: "@story_so_far The player just defeated the first boss"
   - Response: Include [OTAKON_INSIGHT_UPDATE: {"id": "story_so_far", "content": "The player has...[updated content based on instruction]"}]
   
2. **@<tab_name> \\modify**: Modify or rename a subtab
   - Example: "@tips \\modify change this to combat strategies"
   - Response: Include [OTAKON_INSIGHT_MODIFY_PENDING: {"id": "tips", "title": "Combat Strategies", "content": "[updated content]"}]
   
3. **@<tab_name> \\delete**: Delete a subtab
   - Example: "@unused_tab \\delete"
   - Response: Include [OTAKON_INSIGHT_DELETE_REQUEST: {"id": "unused_tab"}] and acknowledge the deletion

When you see an @ command:
- Acknowledge the command in your response ("I've updated the [tab name] tab...")
- Include the appropriate OTAKON tag to execute the action
- Provide confirmation of what was changed
`,Ie=c=>`
**Persona: General Gaming Assistant**
You are Otagon, a helpful and knowledgeable AI gaming assistant for the "Game Hub" tab.

**CRITICAL: Use Real Information**
- Today's date is ${new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}
- You have access to Google Search grounding for current information
- ALWAYS cite specific game titles, release dates, and accurate details from web search results
- NEVER use placeholders like "[Hypothetical Game A]" or "[Insert Today's Date]"
- For questions about recent releases, new updates, or announcements, use the grounded web search data
- Your knowledge cutoff is January 2025 - use web search for anything after that date
- Always provide specific, real game titles and accurate information

**Task:**
1. Thoroughly answer the user's query: "${c}".
2. If the query is about a SPECIFIC RELEASED GAME that the user mentions by name, you MUST include these tags:
   - [OTAKON_GAME_ID: Full Game Name] - The complete, official name of the game
   - [OTAKON_CONFIDENCE: high|low] - Your confidence in the identification
   - [OTAKON_GENRE: Genre] - The primary genre (e.g., Action RPG, FPS, Strategy)
   - [OTAKON_GAME_STATUS: unreleased] - ONLY if the game is NOT YET RELEASED
3. Provide three relevant suggested prompts using the [OTAKON_SUGGESTIONS] tag.

**IMPORTANT - When to use game tags:**
âœ… User asks: "How do I beat the first boss in Elden Ring?" â†’ Include [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG]
âœ… User asks: "What's the best build for Cyberpunk 2077?" â†’ Include [OTAKON_GAME_ID: Cyberpunk 2077] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG]
âŒ User asks: "What's a good RPG to play?" â†’ NO game tags (general question)
âŒ User asks: "Tell me about open world games" â†’ NO game tags (general question)

**Tag Definitions:**
${Q}

**Response Style:**
- Be helpful and knowledgeable about gaming
- Keep responses concise but informative
- Use gaming terminology appropriately
- For game-specific queries, start with "Hint:" and provide actionable advice
- Focus on useful information, not obvious descriptions
- Make responses engaging and immersive
`,Ne=(c,e,t,s,r)=>{var d,f;const a=((d=c.subtabs)==null?void 0:d.filter(b=>b.status==="loaded"&&b.content).map(b=>`### ${b.title} (ID: ${b.id})
${b.content}`).join(`

`))||"No subtabs available yet.",n=c.messages.slice(-10).map(b=>`${b.role==="user"?"User":"Otagon"}: ${b.content}`).join(`
`),o=c.contextSummary?`**Historical Context (Previous Sessions):**
${c.contextSummary}

`:"",i=r||U.getDefaultProfile(),u=U.buildProfileContext(i);return`
**Persona: Game Companion**
You are Otagon, an immersive AI companion for the game "${c.gameTitle}".
The user's spoiler preference is: "${((f=t.preferences)==null?void 0:f.spoilerPreference)||"none"}".
The user's current session mode is: ${s?"ACTIVE (currently playing)":"PLANNING (not playing)"}.

**Web Search Grounding Available:**
- You have access to Google Search for current information about this game
- Use web search for: patch notes, updates, DLC announcements, strategy guides, wiki information
- Your knowledge cutoff is January 2025 - use grounding for recent game updates or patches
- Always cite specific sources when using grounded information

**Game Context:**
- Game: ${c.gameTitle} (${c.genre})
- Current Objective: ${c.activeObjective||"Not set"}
- Game Progress: ${c.gameProgress||0}%

**Player Profile:**
${u}

**Current Subtabs (Your Knowledge Base):**
${a}

${o}**Recent Conversation History:**
${n}

**User Query:** "${e}"

**Task:**
1. Respond to the user's query in an immersive, in-character way that matches the tone of the game.
2. Use the subtab context above to provide informed, consistent answers.
3. **IMPORTANT: Adapt your response style based on the Player Profile above.**
4. If the query provides new information, update relevant subtabs using [OTAKON_INSIGHT_UPDATE].
5. If the query implies progress, identify new objectives using [OTAKON_OBJECTIVE_SET].
6. ${s?"Provide concise, actionable advice for immediate use.":"Provide more detailed, strategic advice for planning."}
7. Generate three contextual suggested prompts using the [OTAKON_SUGGESTIONS] tag.

${Oe}

**Suggestions Guidelines:**
Generate 3 short, specific follow-up questions that help the user:
- Get immediate help with their current situation
- Learn more about game mechanics or story elements
- Get strategic advice for their next steps
- Understand character motivations or plot points
- Explore related game content or areas

Examples of good suggestions:
- "What's the best strategy for this boss?"
- "Tell me more about this character's backstory"
- "What should I do next in this area?"
- "How do I unlock this feature?"
- "What items should I prioritize here?"

**Tag Definitions:**
${Q}

**Response Style:**
- Match the tone and atmosphere of ${c.gameTitle}
- Be spoiler-free beyond current progress
- Provide practical, actionable advice
- Use game-specific terminology and references
- Start with "Hint:" for game-specific queries
- Include lore and story context appropriate to player's progress
- When updating subtabs, seamlessly integrate the update into your response
`},Pe=(c,e,t,s)=>{const r=s||U.getDefaultProfile();return`
**Persona: Game Lore Expert & Screenshot Analyst**
You are Otagon, an expert at analyzing game visuals and providing immersive, lore-rich assistance.

**Player Profile:**
${U.buildProfileContext(r)}

**Task:**
1. Analyze the screenshot to identify the game
2. **CRITICAL TAG REQUIREMENTS - Include ALL of these tags:**
   - [OTAKON_GAME_ID: Full Game Name] - The complete, official name of the game
   - [OTAKON_CONFIDENCE: high|low] - Your confidence in the identification
   - [OTAKON_GENRE: Genre] - The primary genre (e.g., Action RPG, FPS, Strategy)
   - [OTAKON_IS_FULLSCREEN: true|false] - Is this fullscreen gameplay? (For informational purposes)
   - [OTAKON_GAME_STATUS: unreleased] - ONLY include this if the game is NOT YET RELEASED (verify release date!)
3. Answer: "${e}" with focus on game lore, significance, and useful context
4. Provide 3 contextual suggestions using [OTAKON_SUGGESTIONS: ["suggestion1", "suggestion2", "suggestion3"]]

**Tag Usage Examples:**
âœ… Released game, fullscreen gameplay: [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG] [OTAKON_IS_FULLSCREEN: true]
âœ… Released game, menu screen: [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG] [OTAKON_IS_FULLSCREEN: false]
âœ… Unreleased game: [OTAKON_GAME_ID: GTA VI] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action Adventure] [OTAKON_IS_FULLSCREEN: true] [OTAKON_GAME_STATUS: unreleased]

**IMPORTANT - Game Tab Creation:**
- ANY screenshot showing a released game (menu or gameplay) will create a dedicated game tab
- This includes main menus, character selection, settings, and gameplay screens
- Only unreleased games or non-game screens (launchers, store pages) stay in "Game Hub"

**What counts as fullscreen gameplay (for IS_FULLSCREEN tag):**
- In-game world exploration
- Combat encounters
- Cutscenes during gameplay
- Active gameplay screens

**What is NOT fullscreen gameplay (but still creates a game tab if it's a released game):**
- Main menus, settings menus
- Character selection screens
- Loading screens
- Inventory/map screens

**Response Style for Text Queries:**
- Be conversational and contextual - respond naturally to the user's question
- Build on previous conversation context progressively
- NO structured headers (Hint/Lore/Places) for text conversations
- Use natural paragraphs and flowing prose
- Reference previous messages when relevant
- Adapt tone to match user's question (casual question = casual response, serious question = detailed response)

**Response Style for Image Uploads ONLY:**
- Use structured format with section headers
- Focus on GAME LORE, SIGNIFICANCE, and USEFUL CONTEXT rather than describing obvious UI elements
- Make the response immersive and engaging

**MANDATORY FORMAT FOR IMAGES - Use this exact structure with bold section headers:**
**Hint:** [Game Name] - [Brief, actionable hint about what the player should do or focus on]

**Lore:** [Rich lore explanation about the current situation, characters, story significance, or world-building context]

**Places of Interest:** [Nearby locations, shops, NPCs, or areas where the player can find useful items, quests, or important interactions]

**What to focus on:**
- Story significance and lore implications
- Character relationships and motivations
- Location importance and world-building
- Gameplay mechanics and strategic advice
- Narrative context and plot relevance
- Cultural or thematic elements

**What to avoid:**
- Describing obvious UI elements (health bars, buttons, etc.)
- Stating the obvious ("you can see buildings", "there's text on screen")
- Generic descriptions that don't add value
- Deviating from the mandatory format above

**Genre Classification Confirmation:**
After providing your response, if there's ANY ambiguity about the genre classification, add a brief confirmation question:
- Example: "I've classified this as a Souls-like game. Does that match your understanding, or would you prefer a different categorization?"
- Example: "This appears to be an Open-World adventure game. If you think it fits better in another category (like RPG or Action RPG), let me know!"
- Only include this if the genre could reasonably fit multiple categories
- Keep it brief and natural - don't add it for obvious genre matches like "Call of Duty = First-Person Shooter"

**Suggestions Guidelines:**
Generate 3 short, specific follow-up questions that help the user:
- Learn more about the current situation or location
- Get tactical advice for what they're seeing
- Understand story implications or character motivations
- Get tips for gameplay mechanics shown in the screenshot
- Explore related game content or areas

Examples of good suggestions:
- "What's the significance of this location?"
- "How do I handle this type of enemy?"
- "What should I do next here?"
- "Tell me about this character's backstory"
- "What items should I look for in this area?"

**Tag Definitions:**
${Q}
`},ct=(c,e,t,s,r,a)=>r?Pe(c,e,t,a):!c.isGameHub&&c.gameTitle?Ne(c,e,t,s,a):Ie(e);class Re{constructor(){g(this,"retryAttempts",new Map);g(this,"MAX_RETRIES",3);g(this,"RETRY_DELAYS",[1e3,2e3,4e3])}async handleAIError(e,t){if(console.error(`ðŸ¤– [ErrorRecovery] AI Error in ${t.operation}:`,e),this.shouldRetry(t)){const s=this.getRetryDelay(t.retryCount);return console.log(`ðŸ”„ [ErrorRecovery] Retrying ${t.operation} in ${s}ms`),await this.delay(s),{type:"retry",action:async()=>{}}}return e.message.includes("API key")||e.message.includes("authentication")?{type:"user_notification",message:"AI service authentication failed. Please check your API key in settings."}:e.message.includes("rate limit")||e.message.includes("quota")?{type:"user_notification",message:"AI service is temporarily busy. Please try again in a few moments."}:e.message.includes("network")||e.message.includes("timeout")?{type:"user_notification",message:"Network connection issue. Please check your internet connection and try again."}:{type:"user_notification",message:"AI service is temporarily unavailable. Please try again later."}}async handleConversationError(e,t){return console.error(`ðŸ’¬ [ErrorRecovery] Conversation Error in ${t.operation}:`,e),e.message.includes("not found")?{type:"fallback",message:"Conversation not found. Creating a new one.",action:async()=>{}}:e.message.includes("permission")||e.message.includes("unauthorized")?{type:"user_notification",message:"Permission denied. Please log in again."}:{type:"user_notification",message:"Failed to save conversation. Your data may not be persisted."}}async handleCacheError(e,t){return console.error(`ðŸ’¾ [ErrorRecovery] Cache Error in ${t.operation}:`,e),{type:"skip",message:"Cache unavailable. Continuing without caching."}}async handleWebSocketError(e,t){if(console.error(`ðŸ”Œ [ErrorRecovery] WebSocket Error in ${t.operation}:`,e),this.shouldRetry(t)){const s=this.getRetryDelay(t.retryCount);return{type:"retry",action:async()=>{await this.delay(s)}}}return{type:"user_notification",message:"PC connection lost. Screenshot upload may not be available."}}shouldRetry(e){const t=`${e.operation}_${e.conversationId||"global"}`;return(this.retryAttempts.get(t)||0)<this.MAX_RETRIES}getRetryDelay(e){return this.RETRY_DELAYS[Math.min(e,this.RETRY_DELAYS.length-1)]}incrementRetryCount(e){const t=`${e.operation}_${e.conversationId||"global"}`,s=this.retryAttempts.get(t)||0;this.retryAttempts.set(t,s+1)}resetRetryCount(e){const t=`${e.operation}_${e.conversationId||"global"}`;this.retryAttempts.delete(t)}delay(e){return new Promise(t=>setTimeout(t,e))}displayError(e,t="error"){console.log(`[${t.toUpperCase()}] ${e}`),t==="error"&&console.error("User Error:",e)}logError(e,t,s){console.error("Error Details:",{error:e.message,stack:e.stack,context:t,additionalInfo:s,timestamp:new Date().toISOString()})}}const lt=new Re;class xe{constructor(){g(this,"gameTones",{"Action RPG":{adjectives:["epic","heroic","legendary","mystical","ancient"],personality:"wise and experienced adventurer",speechPattern:"speaks with the wisdom of ages and the thrill of adventure",loreStyle:"rich with mythology and ancient secrets"},FPS:{adjectives:["intense","tactical","precise","combat-ready","strategic"],personality:"battle-hardened soldier",speechPattern:"communicates with military precision and combat experience",loreStyle:"focused on warfare, technology, and military history"},Horror:{adjectives:["ominous","chilling","mysterious","haunting","eerie"],personality:"knowledgeable survivor",speechPattern:"speaks with caution and awareness of lurking dangers",loreStyle:"dark and atmospheric, filled with supernatural elements"},Puzzle:{adjectives:["logical","methodical","analytical","clever","systematic"],personality:"brilliant problem-solver",speechPattern:"explains with clear logic and step-by-step reasoning",loreStyle:"intellectual and mysterious, focused on patterns and solutions"},RPG:{adjectives:["immersive","narrative-driven","character-focused","epic","emotional"],personality:"storyteller and guide",speechPattern:"speaks like a narrator, weaving tales and character development",loreStyle:"deep character development and rich storytelling"},Strategy:{adjectives:["tactical","strategic","calculated","methodical","commanding"],personality:"master tactician",speechPattern:"speaks with authority and strategic insight",loreStyle:"focused on warfare, politics, and grand strategy"},Adventure:{adjectives:["exploratory","curious","adventurous","discoverer","wanderer"],personality:"intrepid explorer",speechPattern:"speaks with wonder and excitement about discovery",loreStyle:"filled with exploration, discovery, and world-building"},Default:{adjectives:["helpful","knowledgeable","friendly","supportive","engaging"],personality:"helpful gaming companion",speechPattern:"speaks clearly and helpfully",loreStyle:"focused on gameplay and helpful information"}})}getGameTone(e){return this.gameTones[e]||this.gameTones.Default}generateImmersionContext(e){const t=this.getGameTone(e.genre);let s=`**Immersion Context for ${e.gameTitle}:**
`;return s+=`You are speaking as a ${t.personality} who ${t.speechPattern}.
`,s+=`The game's lore is ${t.loreStyle}.
`,e.currentLocation&&(s+=`The player is currently in: ${e.currentLocation}
`),e.recentEvents&&e.recentEvents.length>0&&(s+=`Recent events: ${e.recentEvents.join(", ")}
`),e.playerProgress!==void 0&&(s+=`Player progress: ${e.playerProgress}%
`),s+=`
**Response Guidelines:**
`,s+=`- Use ${t.adjectives.join(", ")} language
`,s+=`- Maintain the ${t.personality} personality
`,s+=`- Focus on ${t.loreStyle} elements
`,s+=`- Keep responses immersive and in-character
`,s}enhanceResponse(e,t){let s=e;return t.genre==="Horror"?s=`*The shadows seem to whisper as you approach...*

${e}`:t.genre==="Action RPG"?s=`*The ancient knowledge flows through your mind...*

${e}`:t.genre==="FPS"?s=`*Mission briefing updated...*

${e}`:t.genre==="Puzzle"&&(s=`*The solution becomes clearer...*

${e}`),s}getGenreSuggestions(e,t){const s=["Tell me more about this area","What should I do next?","Any tips for this situation?"];return{"Action RPG":["What's the lore behind this location?","How do I improve my character?","What quests are available here?","Tell me about the local NPCs"],FPS:["What's the best tactical approach?","What weapons work best here?","How do I flank the enemy?","What's the mission objective?"],Horror:["What's the history of this place?","How do I survive this area?","What should I be careful of?","Tell me about the local legends"],Puzzle:["What's the pattern here?","How do I solve this step by step?","What clues am I missing?","What's the logical approach?"],RPG:["Tell me about the story so far","What choices should I make?","How do I develop my character?","What's the significance of this moment?"],Strategy:["What's the best strategy here?","How do I manage my resources?","What's the optimal build order?","How do I counter this threat?"]}[e]||s}createImmersiveSubTabContent(e,t,s){var a,n;const r={walkthrough:{"Action RPG":`# ${t} - Walkthrough

*The path of the hero unfolds before you...*

## Current Objective
*Your quest awaits...*

## Next Steps
*The adventure continues...*`,FPS:`# ${t} - Mission Briefing

*Mission parameters updated...*

## Objective
*Target acquired...*

## Tactical Approach
*Weapons ready...*`,Horror:`# ${t} - Survival Guide

*The darkness holds many secrets...*

## Current Situation
*Something stirs in the shadows...*

## Survival Tips
*Stay alert...*`,Default:`# ${t} - Walkthrough

## Current Objective
*Continue your journey...*

## Next Steps
*Progress forward...*`},tips:{"Action RPG":`# ${t} - Wisdom of the Ages

*Ancient knowledge flows through these tips...*

## Combat Mastery
*Master the blade and magic...*

## Exploration Secrets
*Hidden treasures await...*`,FPS:`# ${t} - Tactical Intelligence

*Mission-critical information...*

## Weapon Mastery
*Know your arsenal...*

## Tactical Positioning
*Control the battlefield...*`,Horror:`# ${t} - Survival Knowledge

*The darkness teaches harsh lessons...*

## Survival Tactics
*Stay alive...*

## Environmental Awareness
*Trust your instincts...*`,Default:`# ${t} - Tips & Tricks

## General Tips
*Improve your gameplay...*

## Advanced Techniques
*Master the game...*`}};return((a=r[e])==null?void 0:a[s])||((n=r[e])==null?void 0:n.Default)||`# ${t} - ${e}

*Content loading...*`}}const ut=new xe;class ke{constructor(){g(this,"STORAGE_KEY","otakon_used_suggested_prompts");g(this,"LAST_RESET_KEY","otakon_suggested_prompts_last_reset");g(this,"RESET_INTERVAL_MS",1440*60*1e3);g(this,"usedPrompts",new Set);this.loadUsedPrompts(),this.checkAndResetIfNeeded()}loadUsedPrompts(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.usedPrompts=new Set(t)}}catch(e){console.warn("Failed to load used suggested prompts:",e),this.usedPrompts=new Set}}saveUsedPrompts(){try{const e=Array.from(this.usedPrompts);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("Failed to save used suggested prompts:",e)}}checkAndResetIfNeeded(){try{const e=localStorage.getItem(this.LAST_RESET_KEY),t=Date.now();(!e||t-parseInt(e)>=this.RESET_INTERVAL_MS)&&(console.log("ðŸ”„ 24 hours passed - resetting suggested prompts for fresh daily news"),this.resetUsedPrompts(),localStorage.setItem(this.LAST_RESET_KEY,t.toString()))}catch(e){console.warn("Failed to check/reset suggested prompts:",e)}}markPromptAsUsed(e){this.usedPrompts.add(e),this.saveUsedPrompts()}isPromptUsed(e){return this.usedPrompts.has(e)}getUnusedPrompts(e){return e.filter(t=>!this.isPromptUsed(t))}areAllPromptsUsed(e){return e.every(t=>this.isPromptUsed(t))}resetUsedPrompts(){this.usedPrompts.clear(),localStorage.removeItem(this.STORAGE_KEY),console.log("ðŸ”„ Suggested prompts reset - all 4 prompts will be available again")}getUsedCount(){return this.usedPrompts.size}getTimeUntilNextReset(){try{const e=localStorage.getItem(this.LAST_RESET_KEY);if(!e)return 0;const t=parseInt(e)+this.RESET_INTERVAL_MS;return Math.max(0,t-Date.now())}catch(e){return console.warn("Failed to calculate time until next reset:",e),0}}getStaticNewsPrompts(){return fe}processAISuggestions(e){if(console.log("ðŸ” [SuggestedPromptsService] Input suggestions:",e,"Type:",typeof e),!e)return console.log("ðŸ” [SuggestedPromptsService] No suggestions provided"),[];let t=[];if(Array.isArray(e))console.log("ðŸ” [SuggestedPromptsService] Suggestions is already an array"),t=e;else if(typeof e=="string"){console.log("ðŸ” [SuggestedPromptsService] Suggestions is a string, attempting to parse");let r=e.trim();r.startsWith('["')&&!r.endsWith('"]')&&(r.endsWith('"')||(r+='"'),r.endsWith("]")||(r+="]"),console.log("ðŸ” [SuggestedPromptsService] Fixed malformed JSON array:",r));try{const a=JSON.parse(r);Array.isArray(a)?(t=a,console.log("ðŸ” [SuggestedPromptsService] Successfully parsed as JSON array")):(t=[e],console.log("ðŸ” [SuggestedPromptsService] Parsed as single value, wrapped in array"))}catch{console.log("ðŸ” [SuggestedPromptsService] JSON parsing failed, trying delimiter splitting"),r.includes('", "')||r.includes(`",
"`)?(t=r.split(/",\s*"/).map(n=>n.replace(/^["\s]+|["\s]+$/g,"")).filter(n=>n.length>0),console.log("ðŸ” [SuggestedPromptsService] Split by comma delimiters")):r.includes(`
`)?(t=r.split(`
`).map(n=>n.replace(/^["\s]+|["\s]+$/g,"")).filter(n=>n.length>0),console.log("ðŸ” [SuggestedPromptsService] Split by quote delimiters")):(t=[e],console.log("ðŸ” [SuggestedPromptsService] Treated as single suggestion"))}}console.log("ðŸ” [SuggestedPromptsService] Raw suggestions array:",t);const s=t.filter(r=>r&&typeof r=="string"&&r.trim().length>0).map(r=>r.trim()).slice(0,3);return console.log("ðŸ” [SuggestedPromptsService] Final processed suggestions:",s),s}getFallbackSuggestions(e,t){return t===!0||e==="game-hub"||e==="everything-else"?this.getStaticNewsPrompts():["What should I do next in this area?","Tell me about the story so far","Give me some tips for this game","What are the key mechanics I should know?"]}}const dt=new ke;class $e{async generatePlayingSessionSummary(e){const t=e.messages.filter(n=>n.role==="assistant"&&n.content.includes("Hint:")),s=this.extractKeyPoints(t),r=this.extractObjectives(t),a=`Playing session summary for ${e.gameTitle}:
    
Key Achievements:
${s.map(n=>`â€¢ ${n}`).join(`
`)}

Current Objectives:
${r.map(n=>`â€¢ ${n}`).join(`
`)}

Recent Progress:
${t.slice(-3).map(n=>`- ${n.content.substring(0,100)}...`).join(`
`)}`;return{mode:"playing",gameTitle:e.gameTitle||"Unknown Game",conversationId:e.id,summary:a,keyPoints:s,objectives:r,timestamp:Date.now()}}async generatePlanningSessionSummary(e){const t=e.messages.filter(n=>n.role==="assistant"&&!n.content.includes("Hint:")),s=this.extractKeyPoints(t),r=this.extractObjectives(t),a=`Planning session summary for ${e.gameTitle}:
    
Planned Strategies:
${s.map(n=>`â€¢ ${n}`).join(`
`)}

Goals to Achieve:
${r.map(n=>`â€¢ ${n}`).join(`
`)}

Strategic Notes:
${t.slice(-3).map(n=>`- ${n.content.substring(0,100)}...`).join(`
`)}`;return{mode:"planning",gameTitle:e.gameTitle||"Unknown Game",conversationId:e.id,summary:a,keyPoints:s,objectives:r,timestamp:Date.now()}}extractKeyPoints(e){const t=[];return e.forEach(s=>{(s.content.includes("defeated")||s.content.includes("completed"))&&t.push("Achievement unlocked or objective completed"),(s.content.includes("found")||s.content.includes("discovered"))&&t.push("New item or location discovered"),(s.content.includes("unlocked")||s.content.includes("gained"))&&t.push("New ability or feature unlocked")}),t.length>0?t:["Session progress recorded"]}extractObjectives(e){const t=[];return e.forEach(s=>{(s.content.includes("objective")||s.content.includes("goal"))&&t.push("Continue current objective"),(s.content.includes("next")||s.content.includes("should"))&&t.push("Follow recommended next steps"),(s.content.includes("explore")||s.content.includes("investigate"))&&t.push("Explore new areas or investigate leads")}),t.length>0?t:["Continue game progression"]}async storeSessionSummary(e,t){console.log("Storing session summary for conversation:",e,t)}async getLatestSessionSummary(e){return console.log("Getting latest session summary for conversation:",e),null}}const gt=new $e,x=class x{static getInstance(){return x.instance||(x.instance=new x),x.instance}async getSubtabs(e){return this.getSubtabsFromTable(e)}async setSubtabs(e,t){{console.error(`ðŸ”„ [SubtabsService] Writing ${t.length} subtabs to BOTH table AND JSONB for conversation:`,e);const s=await this.setSubtabsInTable(e,t);console.error("  âœ… Table write:",s?"SUCCESS":"FAILED");const r=await this.setSubtabsInJsonb(e,t);return console.error("  âœ… JSONB write:",r?"SUCCESS":"FAILED"),s&&r}}async addSubtab(e,t){{const s=await this.addSubtabToTable(e,t);return await this.addSubtabToJsonb(e,t),s}}async updateSubtab(e,t,s){{const r=await this.updateSubtabInTable(t,s),a=await this.updateSubtabInJsonb(e,t,s);return r&&a}}async deleteSubtab(e,t){return this.deleteSubtabFromTable(t)}async getSubtabsFromTable(e){try{const{data:t,error:s}=await l.from("subtabs").select("*").eq("conversation_id",e).order("order_index",{ascending:!0});return s?(console.error("Error getting subtabs from table:",s),[]):(t||[]).map(r=>{const a=typeof r.metadata=="object"&&r.metadata!==null?r.metadata:{};return{id:r.id,title:r.title,content:r.content||"",type:r.tab_type,isNew:a.isNew||!1,status:a.status||"loaded",instruction:a.instruction}})}catch(t){return console.error("Error getting subtabs from table:",t),[]}}async setSubtabsInTable(e,t){try{const{error:s}=await l.from("subtabs").delete().eq("conversation_id",e);if(s)return console.error("Error deleting existing subtabs:",s),!1;if(t.length>0){const r=t.map((n,o)=>({id:n.id,conversation_id:e,game_id:null,title:n.title,content:n.content,tab_type:n.type,order_index:o,metadata:{isNew:n.isNew,status:n.status,instruction:n.instruction}})),{error:a}=await l.from("subtabs").insert(r);if(a)return console.error("Error inserting subtabs:",a),!1}return!0}catch(s){return console.error("Error setting subtabs in table:",s),!1}}async addSubtabToTable(e,t){var s;try{const{data:r}=await l.from("conversations").select("game_id").eq("id",e).single(),a=(r==null?void 0:r.game_id)||"",{data:n}=await l.from("subtabs").select("order_index").eq("conversation_id",e).order("order_index",{ascending:!1}).limit(1),o=((s=n==null?void 0:n[0])==null?void 0:s.order_index)??-1,{data:i,error:u}=await l.from("subtabs").insert({id:t.id,conversation_id:e,game_id:a,title:t.title,content:t.content,tab_type:t.type,order_index:o+1,metadata:{isNew:t.isNew,status:t.status,instruction:t.instruction}}).select().single();return u?(console.error("Error adding subtab to table:",u),null):{id:i.id,title:i.title,content:be(i.content),type:i.tab_type,isNew:typeof i.metadata=="object"&&i.metadata!==null&&!Array.isArray(i.metadata)&&i.metadata.isNew||!1,status:(typeof i.metadata=="object"&&i.metadata!==null&&!Array.isArray(i.metadata)?i.metadata.status:void 0)||"loaded",instruction:typeof i.metadata=="object"&&i.metadata!==null&&!Array.isArray(i.metadata)?i.metadata.instruction:void 0}}catch(r){return console.error("Error adding subtab to table:",r),null}}async updateSubtabInTable(e,t){try{const s={};if(t.title!==void 0&&(s.title=t.title),t.content!==void 0&&(s.content=t.content),t.type!==void 0&&(s.tab_type=t.type),t.isNew!==void 0||t.status!==void 0||t.instruction!==void 0){const{data:a}=await l.from("subtabs").select("metadata").eq("id",e).single(),n=typeof(a==null?void 0:a.metadata)=="object"&&(a==null?void 0:a.metadata)!==null?a.metadata:{};s.metadata={...n,...t.isNew!==void 0&&{isNew:t.isNew},...t.status!==void 0&&{status:t.status},...t.instruction!==void 0&&{instruction:t.instruction}}}const{error:r}=await l.from("subtabs").update(s).eq("id",e);return r?(console.error("Error updating subtab in table:",r),!1):!0}catch(s){return console.error("Error updating subtab in table:",s),!1}}async deleteSubtabFromTable(e){try{const{error:t}=await l.from("subtabs").delete().eq("id",e);return t?(console.error("Error deleting subtab from table:",t),!1):!0}catch(t){return console.error("Error deleting subtab from table:",t),!1}}async getSubtabsFromJsonb(e){try{const{data:t,error:s}=await l.from("conversations").select("subtabs").eq("id",e).single();return s?(console.error("Error getting subtabs from JSONB:",s),[]):(t==null?void 0:t.subtabs)||[]}catch(t){return console.error("Error getting subtabs from JSONB:",t),[]}}async setSubtabsInJsonb(e,t){try{const{error:s}=await l.from("conversations").update({subtabs:t,subtabs_order:t.map(r=>r.id)}).eq("id",e);return s?(console.error("Error setting subtabs in JSONB:",s),!1):!0}catch(s){return console.error("Error setting subtabs in JSONB:",s),!1}}async addSubtabToJsonb(e,t){try{const r=[...await this.getSubtabsFromJsonb(e),t];return await this.setSubtabsInJsonb(e,r)?t:null}catch(s){return console.error("Error adding subtab to JSONB:",s),null}}async updateSubtabInJsonb(e,t,s){try{const a=(await this.getSubtabsFromJsonb(e)).map(n=>n.id===t?{...n,...s}:n);return await this.setSubtabsInJsonb(e,a)}catch(r){return console.error("Error updating subtab in JSONB:",r),!1}}async deleteSubtabFromJsonb(e,t){try{const r=(await this.getSubtabsFromJsonb(e)).filter(a=>a.id!==t);return await this.setSubtabsInJsonb(e,r)}catch(s){return console.error("Error deleting subtab from JSONB:",s),!1}}async migrateConversationSubtabs(e){try{const t=await this.getSubtabsFromJsonb(e);return t.length===0?!0:await this.setSubtabsInTable(e,t)}catch(t){return console.error("Error migrating subtabs:",t),!1}}async rollbackConversationSubtabs(e){try{const t=await this.getSubtabsFromTable(e);return t.length===0?!0:await this.setSubtabsInJsonb(e,t)}catch(t){return console.error("Error rolling back subtabs:",t),!1}}async migrateAllSubtabs(){try{const{data:e,error:t}=await l.from("conversations").select("id, subtabs").not("subtabs","is",null);if(t)return console.error("Error fetching conversations:",t),{success:0,failed:0};let s=0,r=0;const a=(e||[]).filter(o=>o.subtabs&&Array.isArray(o.subtabs)&&o.subtabs.length>0).map(o=>this.migrateConversationSubtabs(o.id));return(await Promise.allSettled(a)).forEach(o=>{o.status==="fulfilled"&&o.value?s++:r++}),{success:s,failed:r}}catch(e){return console.error("Error in batch migration:",e),{success:0,failed:0}}}};g(x,"instance");let Z=x;const z=Z.getInstance();function q(){var c;return((c=globalThis.crypto)==null?void 0:c.randomUUID())||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}class Ue{async createGameTab(e){var a,n,o;console.log("ðŸŽ® [GameTabService] Creating game tab:",e);const t=await y.getConversation(e.conversationId);if(t){if(console.log("ðŸŽ® [GameTabService] Tab already exists:",t.title),e.aiResponse&&((a=t.subtabs)!=null&&a.some(i=>i.status==="loading"||i.content==="Loading..."))){console.log("ðŸŽ® [GameTabService] Updating loading subtabs with new AI insights");const i=this.extractInsightsFromAIResponse(e.aiResponse,t.subtabs);return await y.updateConversation(t.id,{subtabs:i,updatedAt:Date.now()}),{...t,subtabs:i}}return t}console.log("ðŸŽ® [GameTabService] Creating new tab for:",e.gameTitle);let s=[];if(e.isUnreleased)console.error("ðŸŽ® [GameTabService] Creating unreleased game tab (no subtabs, Discuss mode only)");else if(e.aiResponse)if(console.error("ðŸŽ® [GameTabService] Extracting subtabs from AI response"),(n=e.aiResponse.gamePillData)!=null&&n.wikiContent&&Object.keys(e.aiResponse.gamePillData.wikiContent).length>0)console.error("ðŸŽ® [GameTabService] Found gamePillData.wikiContent with",Object.keys(e.aiResponse.gamePillData.wikiContent).length,"tabs"),s=Object.entries(e.aiResponse.gamePillData.wikiContent).map(([i,u])=>({id:q(),title:this.formatTabTitle(i),type:this.determineTabType(i),content:u,isNew:!1,status:"loaded"})),console.error("ðŸŽ® [GameTabService] Created",s.length,"subtabs from gamePillData.wikiContent");else if(e.aiResponse.progressiveInsightUpdates&&e.aiResponse.progressiveInsightUpdates.length>0)console.error("ðŸŽ® [GameTabService] Found progressiveInsightUpdates with",e.aiResponse.progressiveInsightUpdates.length,"updates"),s=e.aiResponse.progressiveInsightUpdates.map(i=>({id:q(),title:i.title,type:this.determineTabType(i.tabId),content:i.content,isNew:!1,status:"loaded"})),console.error("ðŸŽ® [GameTabService] Created",s.length,"subtabs from progressiveInsightUpdates");else{const i=this.extractInsightsFromAIResponse(e.aiResponse,[]);i.length>0?(s=i,console.error("ðŸŽ® [GameTabService] Created",s.length,"subtabs from INSIGHT_UPDATE tags")):(s=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile),console.error("ðŸŽ® [GameTabService] Created",s.length,"template subtabs (will populate via background AI using conversation context)"))}else s=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile),console.error("ðŸŽ® [GameTabService] Created",s.length,"initial template subtabs (no AI response)");const r={id:e.conversationId,title:e.gameTitle,messages:[],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,gameId:e.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:e.gameTitle,genre:e.genre,subtabs:s,subtabsOrder:s.map(i=>i.id),isActiveSession:!1,activeObjective:"",gameProgress:0,isUnreleased:e.isUnreleased||!1};return await y.addConversation(r),s.length>0?(console.error("ðŸŽ® [GameTabService] Saving",s.length,"subtabs for conversation:",r.id),console.error("ðŸŽ® [GameTabService] Subtabs:",JSON.stringify(s,null,2)),await z.setSubtabs(r.id,s)):console.error("ðŸŽ® [GameTabService] No subtabs to save for conversation:",r.id),e.aiResponse?(o=r.subtabs)!=null&&o.some(u=>u.content==="Loading...")&&this.generateInitialInsights(r,e.playerProfile,e.aiResponse).catch(u=>console.error("Background insight generation failed:",u)):this.generateInitialInsights(r,e.playerProfile,e.aiResponse).catch(i=>console.error("Background insight generation failed:",i)),r}generateInitialSubTabs(e,t,s){let a=(se[e]||se.Default).map(n=>({...n,priority:"medium",isProfileSpecific:!1}));if(t){console.error("ðŸŽ® [GameTabService] Generating profile-specific tabs for:",t.playerFocus);const n=U.generateProfileSpecificTabs(t,s);a=[...a,...n],a=U.prioritizeTabsForProfile(a,t)}return a.map(n=>({id:q(),title:n.title,type:n.type,content:"Loading...",isNew:!0,status:"loading",instruction:n.instruction}))}extractInsightsFromAIResponse(e,t){console.error("ðŸ¤– [GameTabService] Extracting dynamic insights from AI response");const s=e.otakonTags.get("INSIGHT_UPDATE");if(s){if(console.error("ðŸ¤– [GameTabService] Found INSIGHT_UPDATE:",s),t.find(a=>a.id===s.id))return t.map(a=>a.id===s.id?{...a,content:s.content,isNew:!0,status:"loaded"}:a);{const a={id:q(),title:this.formatTabTitle(s.id),type:this.determineTabType(s.id),content:s.content,isNew:!0,status:"loaded"};return[...t,a]}}return t}formatTabTitle(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}determineTabType(e){return e.includes("story")?"story":e.includes("character")?"characters":e.includes("strategy")||e.includes("tips")?"tips":e.includes("boss")?"strategies":e.includes("quest")||e.includes("walkthrough")?"walkthrough":e.includes("item")?"items":"chat"}async generateInitialInsights(e,t,s){var n,o,i;const r=e.id,a=e.gameTitle;console.error(`ðŸ¤– [GameTabService] ðŸ”„ [${r}] Generating initial insights for: ${a}`);try{if(!(await y.getConversations(!0))[r]){console.error(`ðŸ¤– [GameTabService] [${r}] âš ï¸ Conversation no longer exists, aborting insight generation`);return}let d="";s!=null&&s.content?(d=`AI Analysis: ${s.content}`,console.error(`ðŸ¤– [GameTabService] [${r}] Using AI response as context (${s.content.length} chars)`)):e.messages.length>0?(d=e.messages.map(m=>`${m.role==="user"?"User":"AI"}: ${m.content}`).join(`

`),console.error(`ðŸ¤– [GameTabService] [${r}] Using messages as context (${e.messages.length} msgs)`)):console.error(`ðŸ¤– [GameTabService] [${r}] âš ï¸ No context available`),console.error(`ðŸ¤– [GameTabService] [${r}] ðŸš€ Calling AI generateInitialInsights...`);const f=await oe.generateInitialInsights(a||"Unknown Game",e.genre||"Action RPG",t,d);if(console.error(`ðŸ¤– [GameTabService] [${r}] ðŸ“¥ AI returned:`,Object.keys(f).length,"insights"),!(await y.getConversations(!0))[r]){console.error(`ðŸ¤– [GameTabService] [${r}] âš ï¸ Conversation deleted during AI call, discarding results`);return}const k=f&&Object.keys(f).length>0;k?console.error(`ðŸ¤– [GameTabService] [${r}] âœ… Got ${Object.keys(f).length} insights:`,Object.keys(f)):console.error(`ðŸ¤– [GameTabService] [${r}] âŒ Empty insights, using fallback`);const ee=(await y.getConversations(!0))[r];if(!ee){console.error(`ðŸ¤– [GameTabService] [${r}] âš ï¸ Conversation not found, may have been deleted`);return}const ge={story:"story_so_far",walkthrough:"quest_log",strategies:"build_optimization",tips:"hidden_paths"};console.error("ðŸ¤– [GameTabService] Building content mapping for subtabs...");const B=((n=ee.subtabs)==null?void 0:n.map(m=>{let S="";const L=ge[m.type];if(m.type==="strategies"&&m.title.includes("Boss")){const C="boss_strategy";k&&f[C]&&(S=f[C],console.error(`ðŸ¤– [GameTabService] Subtab "${m.title}" using AI content from key "${C}" (${S.length} chars)`))}if(!S&&k&&L&&f[L]&&(S=f[L],console.error(`ðŸ¤– [GameTabService] Subtab "${m.title}" using AI content from key "${L}" (${S.length} chars)`)),!S){let C=d;if(m.type==="story"&&d.includes("Lore:")){const _=d.match(/Lore:(.*?)(?=\n\n|\n[A-Z]|$)/s);C=_?_[1].trim():d}else if(m.type==="strategies"&&d.includes("Analysis:")){const _=d.match(/Analysis:(.*?)(?=\n\n|\n[A-Z]|$)/s);C=_?_[1].trim():d}else if(m.type==="tips"&&d.includes("Hint:")){const _=d.match(/Hint:(.*?)(?=\n\n|\n[A-Z]|$)/s);C=_?_[1].trim():d}S=`## ${m.title}

${C}`,console.error(`ðŸ¤– [GameTabService] Subtab "${m.title}" using fallback content from AI response (${S.length} chars)`),console.error("ðŸ¤– [GameTabService] Preview:",S.substring(0,150)+"...")}return{...m,content:S,isNew:!1,status:"loaded"}}))||[];console.error("ðŸ¤– [GameTabService] Updating subtabs with content...");const me=B.map(m=>{var S;return{id:m.id,title:m.title,status:m.status,contentLength:((S=m.content)==null?void 0:S.length)||0,isNew:m.isNew}});console.error("ðŸ¤– [GameTabService] Subtabs to save:",me),console.error("ðŸ¤– [GameTabService] ALL statuses:",B.map(m=>m.status)),console.error("ðŸ¤– [GameTabService] ðŸ—‘ï¸ Clearing cache BEFORE subtabs write..."),y.clearCache(),await z.setSubtabs(e.id,B),console.error("ðŸ¤– [GameTabService] âœ… Subtabs dual-write complete (table + JSONB)"),y.clearCache(),await new Promise(m=>setTimeout(m,500));const te=(await y.getConversations(!0))[e.id];te?console.error("ðŸ¤– [GameTabService] ðŸ” VERIFICATION: Read back subtabs after write:",((o=te.subtabs)==null?void 0:o.map(m=>({title:m.title,status:m.status})))||"NO SUBTABS"):console.error("ðŸ¤– [GameTabService] âš ï¸ VERIFICATION: Could not find conversation after write!"),await y.updateConversation(e.id,{updatedAt:Date.now()}),console.error("ðŸ¤– [GameTabService] âœ… Conversation metadata updated")}catch(u){console.error("ðŸ¤– [GameTabService] âŒ Failed to generate initial insights:",u),Y.warning("Failed to load game insights. You can still chat about the game!");try{const f=(await y.getConversations(!0))[e.id];if(!f){console.error("ðŸ¤– [GameTabService] Conversation not found for error update:",e.id);return}const b=((i=f.subtabs)==null?void 0:i.map(k=>({...k,content:`Failed to load ${k.title} content. Please try again later.`,isNew:!1,status:"error"})))||[];await z.setSubtabs(e.id,b),await y.updateConversation(e.id,{updatedAt:Date.now()})}catch(d){console.error("ðŸ¤– [GameTabService] Failed to update error state:",d)}}}async updateSubTabContent(e,t,s){console.error("ðŸ“ [GameTabService] Updating sub-tab content:",{conversationId:e,subTabId:t});try{const a=(await y.getConversations())[e];if(!a||!a.subtabs)throw new Error("Conversation or sub-tabs not found");const n=a.subtabs.map(o=>o.id===t?{...o,content:s,isNew:!1,status:"loaded"}:o);await z.setSubtabs(e,n),await y.updateConversation(e,{updatedAt:Date.now()})}catch(r){throw console.error("Failed to update sub-tab content:",r),r}}async getGameTab(e){try{const s=(await y.getConversations())[e];return!s||!s.gameTitle?null:{id:s.id,title:s.title,gameId:s.gameId||s.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:s.gameTitle,genre:s.genre||"Unknown",subtabs:s.subtabs||[],createdAt:s.createdAt,updatedAt:s.updatedAt,isActiveSession:s.isActiveSession||!1}}catch(t){return console.error("Failed to get game tab:",t),Y.error("Failed to load game tab."),null}}isGameTab(e){return!e.isGameHub&&!!e.gameTitle}generateGameConversationId(e){return`game-${e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-")}`}async updateSubTabsFromAIResponse(e,t){console.error(`ðŸ“ [GameTabService] [${e}] Updating subtabs from AI response:`,t.length);try{const r=(await y.getConversations(!0))[e];if(!r||!r.subtabs){console.error(`ðŸ“ [GameTabService] [${e}] âš ï¸ Conversation or subtabs not found, aborting update`);return}let a=0;const n=r.subtabs.map(o=>{const i=t.find(u=>u.tabId===o.id);if(i){a++,console.error(`ðŸ“ [GameTabService] [${e}] Updating subtab: ${o.id} - ${i.title}`);const d=`

---
**Updated: `+new Date().toLocaleString()+`**

`,b=o.content&&o.content.trim().length>0&&o.content!=="Loading..."&&o.status==="loaded"?o.content+d+i.content:i.content;return{...o,title:i.title||o.title,content:b,isNew:!0,status:"loaded"}}return o});if(a===0){console.error(`ðŸ“ [GameTabService] [${e}] âš ï¸ No subtabs matched for update`);return}await y.updateConversation(e,{subtabs:n,updatedAt:Date.now()}),console.error(`ðŸ“ [GameTabService] [${e}] âœ… Updated ${a} subtabs successfully`)}catch(s){throw console.error(`ðŸ“ [GameTabService] [${e}] âŒ Failed to update subtabs:`,s),s}}}const mt=new Ue;class ht{static getCurrentUser(){return N.get(O.USER,null)}static setCurrentUser(e){N.set(O.USER,e)}static createUser(e,t=ye.FREE){const s=Date.now(),r=re[t];return{id:`user_${s}`,authUserId:`user_${s}`,email:e,tier:t,hasProfileSetup:!1,hasSeenSplashScreens:!1,hasSeenHowToUse:!1,hasSeenFeaturesConnected:!1,hasSeenProFeatures:!1,pcConnected:!1,pcConnectionSkipped:!1,onboardingCompleted:!1,hasWelcomeMessage:!1,isNewUser:!0,hasUsedTrial:!1,lastActivity:s,preferences:{},textCount:0,imageCount:0,textLimit:r.text,imageLimit:r.image,totalRequests:0,lastReset:s,usage:{textCount:0,imageCount:0,textLimit:r.text,imageLimit:r.image,totalRequests:0,lastReset:s,tier:t},appState:{},profileData:{},onboardingData:{},behaviorData:{},feedbackData:{},usageData:{},createdAt:s,updatedAt:s}}static updateUser(e){const t=this.getCurrentUser();if(!t)return;const s={...t,...e,updatedAt:Date.now()};this.setCurrentUser(s)}static updateUsage(e){const t=this.getCurrentUser();t&&this.updateUser({usage:{...t.usage,...e}})}static resetUsage(){const e=this.getCurrentUser();if(!e)return;const t=re[e.tier];this.updateUsage({textCount:0,imageCount:0,totalRequests:0,lastReset:Date.now(),textLimit:t.text,imageLimit:t.image})}static canMakeRequest(e){const t=this.getCurrentUser();if(!t)return!1;const{usage:s}=t;return e==="text"?s.textCount<s.textLimit:s.imageCount<s.imageLimit}static incrementUsage(e){const t=this.getCurrentUser();if(!t)return;const s={totalRequests:t.usage.totalRequests+1};e==="text"?s.textCount=t.usage.textCount+1:s.imageCount=t.usage.imageCount+1,this.updateUsage(s)}static logout(){N.remove(O.USER)}static async getCurrentUserAsync(){try{const e=N.get(O.USER,null),{data:{user:t},error:s}=await l.auth.getUser();if(s||!t)return e;const{data:r,error:a}=await l.from("users").select("*").eq("auth_user_id",t.id).single();if(a||!r)return console.error("Failed to fetch user from Supabase:",a),e;const n={id:r.id,authUserId:r.auth_user_id,email:r.email,tier:r.tier,textCount:r.text_count||0,imageCount:r.image_count||0,textLimit:W(r.text_limit),imageLimit:W(r.image_limit),totalRequests:r.total_requests||0,lastReset:G(r.last_reset),hasProfileSetup:r.has_profile_setup||!1,hasSeenSplashScreens:r.has_seen_splash_screens||!1,hasSeenHowToUse:r.has_seen_how_to_use||!1,hasSeenFeaturesConnected:r.has_seen_features_connected||!1,hasSeenProFeatures:r.has_seen_pro_features||!1,pcConnected:r.pc_connected||!1,pcConnectionSkipped:r.pc_connection_skipped||!1,onboardingCompleted:r.onboarding_completed||!1,hasWelcomeMessage:r.has_welcome_message||!1,isNewUser:r.is_new_user||!1,hasUsedTrial:r.has_used_trial||!1,lastActivity:G(r.updated_at),preferences:I(r.preferences),usage:{textCount:r.text_count||0,imageCount:r.image_count||0,textLimit:W(r.text_limit),imageLimit:W(r.image_limit),totalRequests:r.total_requests||0,lastReset:G(r.last_reset),tier:r.tier},appState:I(r.app_state),profileData:I(r.profile_data),onboardingData:I(r.onboarding_data),behaviorData:I(r.behavior_data),feedbackData:I(r.feedback_data),usageData:I(r.usage_data),createdAt:G(r.created_at),updatedAt:G(r.updated_at)};return N.set(O.USER,n),n}catch(e){return console.error("Error in getCurrentUserAsync:",e),N.get(O.USER,null)}}static async setCurrentUserAsync(e){try{N.set(O.USER,e);const{error:t}=await l.from("users").update({tier:e.tier,text_count:e.textCount,image_count:e.imageCount,text_limit:e.textLimit,image_limit:e.imageLimit,total_requests:e.totalRequests,last_reset:new Date(e.lastReset).toISOString(),has_profile_setup:e.hasProfileSetup,has_seen_splash_screens:e.hasSeenSplashScreens,has_seen_how_to_use:e.hasSeenHowToUse,has_seen_features_connected:e.hasSeenFeaturesConnected,has_seen_pro_features:e.hasSeenProFeatures,pc_connected:e.pcConnected,pc_connection_skipped:e.pcConnectionSkipped,onboarding_completed:e.onboardingCompleted,has_welcome_message:e.hasWelcomeMessage,has_used_trial:e.hasUsedTrial,preferences:e.preferences,profile_data:e.profileData,app_state:e.appState,onboarding_data:e.onboardingData,behavior_data:e.behaviorData,feedback_data:e.feedbackData,usage_data:e.usageData,updated_at:new Date().toISOString()}).eq("auth_user_id",e.authUserId);t&&console.error("Failed to sync user to Supabase:",t)}catch(t){console.error("Error in setCurrentUserAsync:",t)}}static async updateUsageAsync(e){const t=await this.getCurrentUserAsync();if(!t)return;const s={...t,usage:{...t.usage,...e},textCount:e.textCount??t.textCount,imageCount:e.imageCount??t.imageCount,totalRequests:e.totalRequests??t.totalRequests,lastReset:e.lastReset??t.lastReset,updatedAt:Date.now()};await this.setCurrentUserAsync(s)}}class Ge{hasTabCommand(e){return/^@\w+/.test(e.trim())}parseTabCommand(e,t){const s=e.trim();if(!this.hasTabCommand(s))return null;const r=s.match(/^@(\w+)\s*(\\modify|\\delete)?\s*(.*)$/);if(!r)return null;const[,a,n,o]=r,i=this.findMatchingTab(a,t.subtabs||[]);if(!i)return console.warn(`Tab "${a}" not found in conversation`),null;let u;return n==="\\delete"?u="delete":n==="\\modify"?u="modify":u="update",{type:u,tabId:i.id,tabName:i.title,instruction:o.trim()}}findMatchingTab(e,t){const s=this.normalizeTabName(e);let r=t.find(a=>this.normalizeTabName(a.id)===s||this.normalizeTabName(a.title)===s);return r||(r=t.find(a=>this.normalizeTabName(a.id).includes(s)||this.normalizeTabName(a.title).includes(s)),r)?r:(r=t.find(a=>s.includes(this.normalizeTabName(a.id))||s.includes(this.normalizeTabName(a.title))),r||null)}normalizeTabName(e){return e.toLowerCase().replace(/[_\s-]+/g,"").replace(/[^a-z0-9]/g,"")}getAvailableTabNames(e){return!e.subtabs||e.subtabs.length===0?[]:e.subtabs.map(t=>({id:t.id,title:t.title,variations:[t.id,t.title,t.id.replace(/_/g," "),t.title.toLowerCase()]})).map(t=>t.id)}formatTabSuggestion(e,t){return`@${e}`}getCommandHelp(){return`
**Tab Commands:**
â€¢ @<tab> <text> - Update tab with new info
â€¢ @<tab> \\modify <text> - Modify/rename tab
â€¢ @<tab> \\delete - Delete tab

Example: @story_so_far The player defeated the first boss
    `.trim()}validateCommand(e){switch(e.type){case"update":if(!e.instruction)return{valid:!1,error:"Update command requires content. Example: @story_so_far The player..."};break;case"modify":if(!e.instruction)return{valid:!1,error:"Modify command requires instructions. Example: @tips \\modify Change to combat strategies"};break}return{valid:!0}}describeCommand(e){switch(e.type){case"update":return`Updating "${e.tabName}" with: ${e.instruction}`;case"modify":return`Modifying "${e.tabName}": ${e.instruction}`;case"delete":return`Deleting "${e.tabName}"`}}}const pt=new Ge;let p,$=[],ae=!1,M="",D=null,A=null,v=null;const De="otakonSpeechRate",Me=async()=>{try{"wakeLock"in navigator&&(D=await navigator.wakeLock.request("screen"),D.addEventListener("release",()=>{console.log("Wake Lock released")}))}catch(c){console.warn("Wake Lock not supported or failed:",c)}},ce=async()=>{try{D!==null&&(await D.release(),D=null)}catch(c){console.warn("Wake Lock release failed:",c)}},Fe=()=>{try{A||(A=new(window.AudioContext||window.webkitAudioContext)),v||(v=new Audio,v.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA",v.loop=!0,v.volume=.01,A&&A.createMediaElementSource(v).connect(A.destination))}catch(c){console.warn("Audio Context initialization failed:",c)}},Le=async()=>{try{v&&A&&(A.state==="suspended"&&await A.resume(),await v.play())}catch(c){console.warn("Silent audio playback failed:",c)}},le=()=>{try{v&&(v.pause(),v.currentTime=0)}catch(c){console.warn("Silent audio stop failed:",c)}},We=()=>new Promise((c,e)=>{if(!p)return e(new Error("Speech synthesis not initialized."));if($=p.getVoices(),$.length>0){c();return}p.onvoiceschanged=()=>{$=p.getVoices(),c()},setTimeout(()=>{$.length===0&&(console.warn("TTS voices did not load within a reasonable time."),$=p.getVoices()),c()},1e3)}),F=()=>{p&&p.speaking&&p.cancel(),M="","mediaSession"in navigator&&navigator.mediaSession.playbackState!=="none"&&(navigator.mediaSession.playbackState="paused"),ce(),le(),window.dispatchEvent(new CustomEvent("otakon:ttsStopped"))},He=()=>{p&&p.speaking&&!p.paused&&(p.pause(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="paused"),window.dispatchEvent(new CustomEvent("otakon:ttsPaused")))},ze=()=>{p&&p.paused&&(p.resume(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="playing"),window.dispatchEvent(new CustomEvent("otakon:ttsResumed")))},qe=async()=>{M&&(F(),await de(M))},Ke=()=>p?p.speaking:!1,ne=()=>{F(),window.dispatchEvent(new CustomEvent("otakon:disableHandsFree"))},je=()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{}),navigator.mediaSession.setActionHandler("pause",ne),navigator.mediaSession.setActionHandler("stop",ne))},Be=async()=>{if(typeof window<"u"&&"speechSynthesis"in window){if(ae)return;ae=!0,p=window.speechSynthesis,await We(),je(),Fe(),p.getVoices().length===0&&p.speak(new SpeechSynthesisUtterance(""))}else console.warn("Speech Synthesis not supported in this browser.")},ue=()=>$.filter(c=>c.lang.startsWith("en-")),de=async c=>new Promise((e,t)=>{try{if(!p)return console.error("Text-to-Speech is not available on this browser."),t(new Error("Text-to-Speech is not available on this browser."));if(!c.trim())return e();F(),M=c;const s=new SpeechSynthesisUtterance(c),r=localStorage.getItem(De);s.rate=r?parseFloat(r):.94;const a=localStorage.getItem("otakonPreferredVoiceURI"),n=ue();let o;if(a&&(o=n.find(i=>i.voiceURI===a)),!o&&n.length>0){const i=n.find(u=>u.name.toLowerCase().includes("female"));i?o=i:o=n[0]}o&&(s.voice=o),s.onstart=async()=>{await Me(),await Le(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="playing",navigator.mediaSession.metadata=new MediaMetadata({title:c.length>50?c.substring(0,50)+"...":c,artist:"Your AI Gaming Companion",album:"Otakon",artwork:[{src:"/Otagon/icon-192.png",sizes:"192x192",type:"image/png"},{src:"/Otagon/icon-512.png",sizes:"512x512",type:"image/png"}]})),window.dispatchEvent(new CustomEvent("otakon:ttsStarted"))},s.onend=()=>{M="","mediaSession"in navigator&&(navigator.mediaSession.playbackState="paused"),ce(),le(),window.dispatchEvent(new CustomEvent("otakon:ttsStopped")),e()},s.onerror=i=>{console.error("SpeechSynthesis Utterance Error",i),F(),t(i)},p.speak(s)}catch(s){console.error("TTS Error:",s),t(s)}}),ft={init:Be,getAvailableVoices:ue,speak:de,cancel:F,pause:He,resume:ze,restart:qe,isSpeaking:Ke};class yt{static async migrateMessagesAtomic(e,t,s){const r=await y.getConversations(!1),a=r[t],n=r[s];if(!a)throw console.error("ðŸ“¦ [MessageRouting] Source conversation not found:",t),console.error("ðŸ“¦ [MessageRouting] Available conversations:",Object.keys(r)),new Error(`Source conversation ${t} not found`);if(!n)throw console.error("ðŸ“¦ [MessageRouting] Destination conversation not found:",s),console.error("ðŸ“¦ [MessageRouting] Available conversations:",Object.keys(r)),new Error(`Destination conversation ${s} not found`);const o=a.messages.filter(d=>e.includes(d.id));if(o.length===0){console.warn("âš ï¸ [MessageRouting] No messages found to migrate");return}const i=o.filter(d=>!n.messages.some(f=>f.id===d.id)),u={...r,[s]:{...n,messages:[...n.messages,...i],updatedAt:Date.now()},[t]:{...a,messages:a.messages.filter(d=>!e.includes(d.id)),updatedAt:Date.now()}};await y.setConversations(u)}static shouldRouteMessage(e,t,s){return!t||e===t?!1:!!(s&&t)}static messageExists(e,t){return e.some(s=>s.id===t)}}class Ye{constructor(){g(this,"MAX_WORDS",300);g(this,"RECENT_MESSAGE_COUNT",8)}countWords(e){return e.trim().split(/\s+/).filter(t=>t.length>0).length}getTotalWordCount(e){return e.reduce((t,s)=>{const r=this.countWords(s.content);return t+r},0)}shouldSummarize(e){if(!e.messages||e.messages.length<=this.RECENT_MESSAGE_COUNT)return!1;const t=this.getTotalWordCount(e.messages);return console.log(`ðŸ“Š [ContextSummarization] Total words in conversation: ${t}`),t>this.MAX_WORDS*3}splitMessages(e){if(e.length<=this.RECENT_MESSAGE_COUNT)return{toSummarize:[],toKeep:e};const t=e.length-this.RECENT_MESSAGE_COUNT;return{toSummarize:e.slice(0,t),toKeep:e.slice(t)}}async summarizeMessages(e,t,s){console.log(`ðŸ“ [ContextSummarization] Summarizing ${e.length} messages`);const r=this.getTotalWordCount(e),a=e.map(i=>`${i.role==="user"?"User":"Assistant"}: ${i.content}`).join(`

`),o=`${t&&s?`This is a conversation about "${t}" (${s}).`:"This is a general conversation."}

Please provide a concise summary of the following conversation history. Focus on:
- Key topics discussed
- Important decisions or choices made
- Game progress or story developments (if applicable)
- User preferences or interests mentioned

Keep the summary under ${this.MAX_WORDS} words while preserving essential context.

Conversation to summarize:
${a}

Provide ONLY the summary, no additional commentary.`;try{const i={id:"temp-summary",title:"Summary Request",messages:[{id:"summary-msg-"+Date.now(),role:"user",content:o,timestamp:Date.now()}],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,isGameHub:!1},u={id:"system",email:"system@otakon.ai",profileData:null},f=(await oe.getChatResponse(i,u,o,!1,!1)).content.trim(),b=this.countWords(f);return console.log(`âœ… [ContextSummarization] Summary generated: ${b} words (reduced from ${r})`),{summary:f,wordCount:b,messagesIncluded:e.length,originalWordCount:r}}catch(i){console.error("âŒ [ContextSummarization] Failed to generate summary:",i);const u=e.slice(0,5).map(d=>d.content.substring(0,100)).join(" ... ").substring(0,this.MAX_WORDS*6);return{summary:`[Previous conversation context] ${u}`,wordCount:this.countWords(u),messagesIncluded:e.length,originalWordCount:r}}}async applyContextSummarization(e){if(!this.shouldSummarize(e))return console.log("ðŸ“Š [ContextSummarization] No summarization needed"),e;console.log("ðŸ”„ [ContextSummarization] Applying context summarization...");const{toSummarize:t,toKeep:s}=this.splitMessages(e.messages);if(t.length===0)return e;const r=await this.summarizeMessages(t,e.gameTitle,e.genre),n=[{id:"summary-"+Date.now(),role:"system",content:r.summary,timestamp:t[t.length-1].timestamp,metadata:{isSummary:!0,messagesIncluded:r.messagesIncluded,originalWordCount:r.originalWordCount,summaryWordCount:r.wordCount}},...s],o=r.summary.replace(/!\[.*?\]\(data:image\/.*?\)/g,""),i=o.split(/\s+/).filter(d=>d.length>0),u=i.length>500?i.slice(0,500).join(" ")+"...":o;return console.log(`âœ… [ContextSummarization] Context optimized: ${e.messages.length} messages â†’ ${n.length} (${r.originalWordCount} words â†’ ${r.wordCount} + recent)`),{...e,messages:n,contextSummary:u,lastSummarizedAt:Date.now(),updatedAt:Date.now()}}async getOptimizedContext(e){return this.shouldSummarize(e)?(await this.applyContextSummarization(e)).messages:e.messages}willTriggerSummarization(e){return this.getTotalWordCount(e.messages)>this.MAX_WORDS*3*.8}}const Je=new Ye,bt=Object.freeze(Object.defineProperty({__proto__:null,contextSummarizationService:Je},Symbol.toStringTag,{value:"Module"}));export{H as E,yt as M,N as S,ht as U,nt as W,w as a,ut as b,ot as c,U as d,lt as e,ft as f,ct as g,dt as h,mt as i,pt as j,ie as k,gt as l,Ee as m,st as n,rt as o,it as p,bt as q,_e as s,Y as t,at as w};
//# sourceMappingURL=services-BlHNaXI0.js.map
