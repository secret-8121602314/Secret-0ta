var O=Object.defineProperty;var T=(a,r,e)=>r in a?O(a,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[r]=e;var f=(a,r,e)=>T(a,typeof r!="symbol"?r+"":r,e);import{s as i}from"./auth-BUPQPWOO.js";import{a as _,t as l,E as R,s as U}from"./services-CDkr_fgq.js";import{T as b,U as L}from"./chat-services-C0AGRJWD.js";const I=()=>typeof window>"u"?!1:window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://"),z=()=>{typeof window<"u"&&localStorage.setItem("otakon_pwa_installed","true")};function p(a){if(a==null)return{};if(typeof a=="string")try{return JSON.parse(a)}catch{return{}}return typeof a=="object"?a:{}}function P(a,r){var g,u;const e=a.tier||"free",t=a.text_limit||((g=b[e])==null?void 0:g.text)||55,s=a.image_limit||((u=b[e])==null?void 0:u.image)||25,o=a.text_count||0,n=a.image_count||0,c=a.total_requests||0,d=a.last_reset?new Date(a.last_reset).getTime():Date.now();return{id:a.id,authUserId:a.auth_user_id||r||"",email:a.email,tier:e,hasProfileSetup:a.has_profile_setup||!1,hasSeenSplashScreens:a.has_seen_splash_screens||!1,hasSeenHowToUse:a.has_seen_how_to_use||!1,hasSeenFeaturesConnected:a.has_seen_features_connected||!1,hasSeenProFeatures:a.has_seen_pro_features||!1,pcConnected:a.pc_connected||!1,pcConnectionSkipped:a.pc_connection_skipped||!1,onboardingCompleted:a.onboarding_completed||!1,hasWelcomeMessage:a.has_welcome_message||!1,isNewUser:a.is_new_user??!0,hasUsedTrial:a.has_used_trial||!1,lastActivity:Date.now(),textCount:o,imageCount:n,textLimit:t,imageLimit:s,totalRequests:c,lastReset:d,connectionCode:a.connection_code,connectionCodeCreatedAt:a.connection_code_created_at?new Date(a.connection_code_created_at).getTime():void 0,connectionActive:a.connection_active,connectionDeviceInfo:p(a.connection_device_info),lastConnectionAt:a.last_connection_at?new Date(a.last_connection_at).getTime():void 0,trialStartedAt:a.trial_started_at?new Date(a.trial_started_at).getTime():void 0,trialExpiresAt:a.trial_expires_at?new Date(a.trial_expires_at).getTime():void 0,preferences:p(a.preferences),usage:{textCount:o,imageCount:n,textLimit:t,imageLimit:s,totalRequests:c,lastReset:d,tier:e},appState:p(a.app_state),profileData:p(a.profile_data),onboardingData:p(a.onboarding_data),behaviorData:p(a.behavior_data),feedbackData:p(a.feedback_data),usageData:p(a.usage_data),createdAt:a.created_at?new Date(a.created_at).getTime():Date.now(),updatedAt:a.updated_at?new Date(a.updated_at).getTime():Date.now()}}const S=class S{constructor(){f(this,"authState",{user:null,isLoading:!0,error:null});f(this,"listeners",[]);f(this,"pendingUserLoads",new Map);f(this,"cleanupFunctions",[]);f(this,"isDestroyed",!1);this.initializeAuth(),this.setupCleanup()}getCallbackUrl(){const r=window.location.origin,e=I(),t="/auth/callback";return e?(console.log("ğŸ” [AuthService] PWA mode detected, using full callback URL"),`${r}${t}`):`${r}${t}`}static getInstance(){return S.instance||(S.instance=new S),S.instance}setupCleanup(){const r=()=>{this.isDestroyed||this.cleanup()};window.addEventListener("beforeunload",r),this.cleanupFunctions.push(()=>{window.removeEventListener("beforeunload",r)})}async checkRateLimit(r){if(this.isDestroyed)return!1;const e=await _.getRateLimit(r),t=Date.now();return!e||t>e.resetTime?(await _.setRateLimit(r,{count:1,resetTime:t+900*1e3}),!0):e.count>=10?!1:(await _.setRateLimit(r,{count:e.count+1,resetTime:e.resetTime}),!0)}async getCachedUser(r){return this.isDestroyed?null:await _.getUser(r)}async setCachedUser(r,e){this.isDestroyed||await _.setUser(r,e)}async clearCache(){await _.clear()}async invalidateUserCache(r){const e=`user:${r}`;await _.delete(e)}async initializeAuth(){try{if(window.location.pathname==="/auth/callback"){console.log("ğŸ” [AuthService] OAuth callback detected, but AuthCallback component will handle it");return}try{const{data:{session:e}}=await i.auth.getSession();e!=null&&e.user?await this.loadUserFromSupabase(e.user.id):this.updateAuthState({user:null,isLoading:!1,error:null})}catch{const t=localStorage.getItem("otakon_user");if(t)try{const s=JSON.parse(t);this.updateAuthState({user:s,isLoading:!1,error:null})}catch{this.updateAuthState({user:null,isLoading:!1,error:null})}else this.updateAuthState({user:null,isLoading:!1,error:null})}}catch(r){console.error("Auth initialization error:",r),l.error("Failed to initialize authentication. Please refresh the page.",{action:{label:"Refresh",onClick:()=>window.location.reload()}}),this.updateAuthState({user:null,isLoading:!1,error:null})}}async createUserRecord(r){var e,t,s,o,n,c,d,g;try{console.log("ğŸ” [AuthService] Creating user record for:",r.email);let u="email";(e=r.app_metadata)!=null&&e.provider?u=r.app_metadata.provider:(t=r.app_metadata)!=null&&t.providers&&r.app_metadata.providers.length>0?u=r.app_metadata.providers[0]:r.identities&&r.identities.length>0?u=r.identities[0].provider:(s=r.user_metadata)!=null&&s.provider&&(u=r.user_metadata.provider),console.log("ğŸ” [AuthService] Auth user metadata:",{app_metadata:r.app_metadata,user_metadata:r.user_metadata,identities:r.identities,provider:u}),console.log("ğŸ” [AuthService] OAuth provider:",u);const h=r.email;console.log("ğŸ” [AuthService] User email:",h);const{error:m}=await i.rpc("create_user_record",{p_auth_user_id:r.id,p_email:h,p_full_name:((o=r.user_metadata)==null?void 0:o.full_name)||((n=r.user_metadata)==null?void 0:n.name)||"User",p_avatar_url:(c=r.user_metadata)==null?void 0:c.avatar_url,p_is_developer:!1,p_tier:"free"});if(m){if(m.code==="23505"||(d=m.message)!=null&&d.includes("duplicate key")){console.log("ğŸ” [AuthService] User record already exists (duplicate key), continuing...");return}throw console.error("ğŸ” [AuthService] Error creating user record:",m),l.error("Failed to create your account. Please try again."),m}console.log("ğŸ” [AuthService] User record created successfully")}catch(u){const h=u;if(h.code==="23505"||(g=h.message)!=null&&g.includes("duplicate key")){console.log("ğŸ” [AuthService] User record already exists (duplicate key in catch), continuing...");return}throw console.error("ğŸ” [AuthService] Error creating user record:",u),l.error("Failed to create your account. Please try again."),u}}async loadUserFromSupabase(r){const e=this.pendingUserLoads.get(r);if(e)return console.log("ğŸ” [AuthService] Deduplicating user load request for:",r),await e;const t=(async()=>{try{await this._loadUserFromSupabaseInternal(r)}finally{this.pendingUserLoads.delete(r)}})();return this.pendingUserLoads.set(r,t),await t}async _loadUserFromSupabaseInternal(r){try{const e=await this.getCachedUser(r);if(e){console.log("ğŸ” [AuthService] Using cached user data"),this.updateAuthState({user:e,isLoading:!1,error:null});return}console.log("ğŸ” [AuthService] Loading user data from database for authUserId:",r);const{data:t,error:s}=await i.rpc("get_complete_user_data",{p_auth_user_id:r});if(s){console.log("ğŸ” [AuthService] RPC function failed, trying direct table query...",s);const{data:o,error:n}=await i.from("users").select("*").eq("auth_user_id",r).single();if(n){console.error("ğŸ” [AuthService] Direct table query also failed:",n),this.updateAuthState({user:null,isLoading:!1,error:"Failed to load user data"});return}if(o){console.log("ğŸ” [AuthService] User found via direct table query");const c=P(o,r);await this.setCachedUser(r,c),this.updateAuthState({user:c,isLoading:!1,error:null});return}}if(t&&t.length>0){console.log("ğŸ” [AuthService] User found via RPC function"),console.log("ğŸ” [AuthService] RPC data:",t[0]);const o=P(t[0],r);console.log("ğŸ” [AuthService] User onboarding flags:",{hasProfileSetup:o.hasProfileSetup,hasSeenSplashScreens:o.hasSeenSplashScreens,hasSeenHowToUse:o.hasSeenHowToUse,hasSeenFeaturesConnected:o.hasSeenFeaturesConnected,hasSeenProFeatures:o.hasSeenProFeatures,pcConnected:o.pcConnected,pcConnectionSkipped:o.pcConnectionSkipped,onboardingCompleted:o.onboardingCompleted}),await this.setCachedUser(r,o),this.updateAuthState({user:o,isLoading:!1,error:null})}else{console.log("ğŸ” [AuthService] User not found, trying to create manually...");try{const{data:{user:o}}=await i.auth.getUser();o?(console.log("ğŸ” [AuthService] Creating user record for auth user:",o.email),await this.createUserRecord(o),await this._loadUserFromSupabaseInternal(r)):this.updateAuthState({user:null,isLoading:!1,error:"User not found and could not create user record"})}catch(o){console.error("ğŸ” [AuthService] Failed to create user record manually:",o),this.updateAuthState({user:null,isLoading:!1,error:"User not found and could not create user record"})}}}catch(e){console.error("Error loading user from Supabase:",e),this.updateAuthState({user:null,isLoading:!1,error:"Failed to load user data"})}}updateAuthState(r){const e={...this.authState};this.authState={...this.authState,...r},JSON.stringify(e)!==JSON.stringify(this.authState)&&this.listeners.forEach(s=>s(this.authState))}async signInWithGoogle(){try{if(!await this.checkRateLimit("google_signin"))return{success:!1,error:"Too many sign-in attempts. Please wait before trying again."};this.updateAuthState({isLoading:!0,error:null}),console.log("ğŸ” [AuthService] Starting Google OAuth...");const r=this.getCallbackUrl();console.log("ğŸ” [AuthService] Redirect URL:",r);const{error:e}=await i.auth.signInWithOAuth({provider:"google",options:{redirectTo:r,queryParams:{prompt:"select_account"}}});return e?(console.error("ğŸ” [AuthService] Google OAuth error:",e),l.error("Failed to sign in with Google. Please try again."),this.updateAuthState({isLoading:!1,error:e.message}),{success:!1,error:e.message}):(console.log("ğŸ” [AuthService] Google OAuth initiated successfully"),{success:!0})}catch(r){return R.handleAuthError(r,"signInWithGoogle"),l.error("Google sign-in failed. Please try again."),this.updateAuthState({user:null,isLoading:!1,error:"Google sign-in failed. Please try again."}),{success:!1,error:"Google sign-in failed. Please try again."}}}async signInWithDiscord(){if(!this.checkRateLimit("discord_signin"))return{success:!1,error:"Too many sign-in attempts. Please wait before trying again."};try{this.updateAuthState({isLoading:!0,error:null}),console.log("ğŸ” [AuthService] Starting Discord OAuth...");const r=this.getCallbackUrl();if(console.log("ğŸ” [AuthService] Redirect URL:",r),console.log("ğŸ” [AuthService] Current origin:",window.location.origin),console.log("ğŸ” [AuthService] Current pathname:",window.location.pathname),console.log("ğŸ” [AuthService] Current port:",window.location.port),console.log("ğŸ” [AuthService] Full URL:",window.location.href),window.location.pathname==="/auth/callback")return console.log("ğŸ” [AuthService] Already on callback page, skipping OAuth initiation"),this.updateAuthState({isLoading:!1,error:null}),{success:!1,error:"Already on callback page"};localStorage.setItem("otakon_discord_auth_attempt",Date.now().toString()),console.log("ğŸ” [AuthService] Initiating Discord OAuth with redirectTo:",r);const{data:t,error:s}=await i.auth.signInWithOAuth({provider:"discord",options:{redirectTo:r,queryParams:{access_type:"offline",prompt:"consent"}}});if(s){console.error("ğŸ” [AuthService] Discord OAuth error:",s),console.error("ğŸ” [AuthService] Error details:",{message:s.message,status:s.status});let o="Discord authentication failed. ";return s.message.includes("Invalid redirect URI")?o+="Please check Discord OAuth configuration in Supabase dashboard.":s.message.includes("Invalid client")?o+="Discord OAuth credentials are invalid. Please check Supabase configuration.":s.message.includes("access_denied")?o+="Discord authorization was cancelled.":o+=s.message,l.error(`Failed to sign in with Discord. ${o}`),this.updateAuthState({isLoading:!1,error:o}),{success:!1,error:o}}return console.log("ğŸ” [AuthService] Discord OAuth initiated successfully"),console.log("ğŸ” [AuthService] OAuth data:",t),{success:!0}}catch(r){const e=r instanceof Error?r.message:"Unknown error";return console.error("ğŸ” [AuthService] Discord OAuth exception:",r),console.error("ğŸ” [AuthService] Exception details:",{name:r instanceof Error?r.name:"Unknown",message:e,stack:r instanceof Error?r.stack:"No stack trace"}),this.updateAuthState({isLoading:!1,error:e}),{success:!1,error:e}}}async signInWithEmail(r,e){if(!this.checkRateLimit(`email_signin_${r}`))return{success:!1,error:"Too many sign-in attempts. Please wait before trying again."};try{this.updateAuthState({isLoading:!0,error:null}),console.log("ğŸ” [AuthService] Starting email sign-in...");const{data:t,error:s}=await i.auth.signInWithPassword({email:r,password:e});if(s){console.error("ğŸ” [AuthService] Email sign-in error:",s);let o=s.message;return s.message.includes("Invalid login credentials")?o="Invalid email or password. If you signed up with Google or Discord, please use those options instead.":s.message.includes("Email not confirmed")?o="Please check your email and click the confirmation link before signing in.":s.message.includes("Too many requests")&&(o="Too many sign-in attempts. Please wait a moment before trying again."),l.error(o),this.updateAuthState({isLoading:!1,error:o}),{success:!1,error:o}}return t.user?(console.log("ğŸ” [AuthService] Email sign-in successful:",t.user.email),l.success("Welcome back! Successfully signed in."),await this.loadUserFromSupabase(t.user.id),{success:!0,user:this.authState.user||void 0}):{success:!1,error:"No user data returned"}}catch(t){const s=t instanceof Error?t.message:"Unknown error";return console.error("ğŸ” [AuthService] Email sign-in exception:",t),l.error("Sign-in failed. Please try again."),this.updateAuthState({isLoading:!1,error:s}),{success:!1,error:s}}}async signUpWithEmail(r,e){try{this.updateAuthState({isLoading:!0,error:null}),console.log("ğŸ” [AuthService] Starting email sign-up...");const{data:t,error:s}=await i.auth.signUp({email:r,password:e,options:{emailRedirectTo:this.getCallbackUrl()}});let o=!1;if(s)if(console.error("ğŸ” [AuthService] Email sign-up error:",s),s.message.includes("Error sending confirmation email"))console.log("ğŸ” [AuthService] Email confirmation disabled, proceeding with sign-up..."),o=!0;else return l.error(`Sign-up failed: ${s.message}`),this.updateAuthState({isLoading:!1,error:s.message}),{success:!1,error:s.message};return t.user?(console.log("ğŸ” [AuthService] Email sign-up successful:",t.user.email),console.log("ğŸ” [AuthService] User confirmation required:",!t.user.email_confirmed_at),t.user.email_confirmed_at?(await this.loadUserFromSupabase(t.user.id),{success:!0,user:this.authState.user||void 0}):(console.log("ğŸ” [AuthService] Email confirmation required, user not yet signed in"),o?(console.log("ğŸ” [AuthService] Email confirmation disabled, creating user record anyway..."),l.success("Account created successfully! Welcome to Otakon!"),await this.loadUserFromSupabase(t.user.id),{success:!0,user:this.authState.user||void 0}):(this.updateAuthState({isLoading:!1,error:null}),{success:!0,user:void 0,requiresConfirmation:!0,message:"Please check your email and click the confirmation link to complete your account setup."}))):{success:!1,error:"No user data returned"}}catch(t){const s=t instanceof Error?t.message:"Unknown error";return console.error("ğŸ” [AuthService] Email sign-up exception:",t),this.updateAuthState({isLoading:!1,error:s}),{success:!1,error:s}}}async resetPassword(r){try{this.updateAuthState({isLoading:!0,error:null});const{error:e}=await i.auth.resetPasswordForEmail(r,{redirectTo:this.getCallbackUrl()});return e?(this.updateAuthState({isLoading:!1,error:e.message}),{success:!1,error:e.message}):(this.updateAuthState({isLoading:!1,error:null}),{success:!0})}catch(e){const t=e instanceof Error?e.message:"Unknown error";return this.updateAuthState({isLoading:!1,error:t}),{success:!1,error:t}}}async signOut(){try{console.log("ğŸ” [AuthService] Starting sign out process..."),await U.endSession(),await i.auth.signOut();const r=[];for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);t&&t.startsWith("sb-")&&r.push(t)}r.forEach(e=>localStorage.removeItem(e)),console.log("ğŸ” [AuthService] Cleared Supabase localStorage keys:",r),localStorage.removeItem("otakon_auth_method"),localStorage.removeItem("otakon_remember_me"),localStorage.removeItem("otakon_remembered_email"),localStorage.removeItem("otakon_discord_auth_attempt"),localStorage.removeItem("otakon_has_used_app"),localStorage.removeItem("otakon_user"),localStorage.removeItem("otakon_conversations"),localStorage.removeItem("otakon_app_state"),sessionStorage.clear(),this.clearCache(),this.updateAuthState({user:null,isLoading:!1,error:null}),console.log("ğŸ” [AuthService] Sign out completed successfully"),l.success("Successfully signed out. See you next time!")}catch(r){console.error("ğŸ” [AuthService] Sign out error:",r),l.error("Sign out failed. Please try again."),this.updateAuthState({user:null,isLoading:!1,error:null})}}getCurrentUser(){return this.authState.user}getAuthState(){return this.authState}async clearAllUserData(){try{console.log("ğŸ” [AuthService] Clearing all user data for testing..."),localStorage.removeItem("otakon_auth_method"),localStorage.removeItem("otakon_remember_me"),localStorage.removeItem("otakon_remembered_email"),await i.auth.signOut(),this.updateAuthState({user:null,isLoading:!1,error:null}),console.log("ğŸ” [AuthService] All user data cleared successfully")}catch(r){console.error("ğŸ” [AuthService] Error clearing user data:",r)}}async checkEmailProvider(r){try{return console.log("ğŸ” [AuthService] Checking provider for email:",r),console.log("ğŸ” [AuthService] Skipping provider check to avoid 401 errors during sign-in"),{provider:null,message:""}}catch(e){return console.error("ğŸ” [AuthService] Error checking email provider:",e),{provider:null,message:""}}}async resendConfirmationEmail(r){try{console.log("ğŸ” [AuthService] Resending confirmation email for:",r),this.updateAuthState({isLoading:!0,error:null});const{error:e}=await i.auth.resend({type:"signup",email:r,options:{emailRedirectTo:this.getCallbackUrl()}});return e?(console.error("ğŸ” [AuthService] Error resending confirmation email:",e),l.error("Failed to resend confirmation email. Please try again."),this.updateAuthState({isLoading:!1,error:e.message}),{success:!1,error:e.message}):(console.log("ğŸ” [AuthService] Confirmation email resent successfully"),l.success("Confirmation email sent! Please check your inbox."),this.updateAuthState({isLoading:!1,error:null}),{success:!0,message:"Confirmation email sent! Please check your inbox and click the confirmation link."})}catch(e){const t=e instanceof Error?e.message:"Unknown error";return console.error("ğŸ” [AuthService] Exception resending confirmation email:",e),l.error("Failed to resend confirmation email. Please try again."),this.updateAuthState({isLoading:!1,error:t}),{success:!1,error:t}}}async testDiscordConfiguration(){try{console.log("ğŸ” [AuthService] Testing Discord OAuth configuration...");const{error:r}=await i.auth.getSession();if(r)return{isValid:!1,message:"Cannot access Supabase auth service",details:{sessionError:r}};const e=`${window.location.origin}/auth/callback`;return console.log("ğŸ” [AuthService] Test redirect URL:",e),{isValid:!0,message:"Discord OAuth configuration appears to be valid",details:{redirectUrl:e,currentOrigin:window.location.origin,currentPathname:window.location.pathname}}}catch(r){return console.error("ğŸ” [AuthService] Error testing Discord configuration:",r),{isValid:!1,message:"Error testing Discord configuration",details:{error:r instanceof Error?r.message:"Unknown error"}}}}async refreshUser(){this.authState.user&&(console.log("ğŸ” [AuthService] Refreshing user data..."),await this.invalidateUserCache(this.authState.user.authUserId),await this.loadUserFromSupabase(this.authState.user.authUserId),this.authState.user&&!U.getCurrentSessionId()&&await U.startSession(this.authState.user.id,this.authState.user.authUserId,window.location.pathname))}async updateUserProfile(r,e){try{const{error:t}=await i.from("users").update({profile_data:e}).eq("auth_user_id",r);if(t)throw console.error("Error updating profile:",t),l.error("Failed to update profile. Please try again."),t;await this.invalidateUserCache(r),await this.loadUserFromSupabase(r),console.log("âœ… Profile preferences updated successfully"),l.success("Profile updated successfully!")}catch(t){throw console.error("Failed to update profile preferences:",t),l.error("Failed to update profile. Please try again."),t}}subscribe(r){return this.listeners.push(r),r(this.authState),()=>{const e=this.listeners.indexOf(r);e>-1&&this.listeners.splice(e,1)}}cleanup(){this.isDestroyed||(console.log("ğŸ§¹ [AuthService] Cleaning up..."),this.isDestroyed=!0,this.clearCache(),this.listeners.length=0,this.cleanupFunctions.forEach(r=>{try{r()}catch(e){console.error("Error during auth service cleanup:",e)}}),this.cleanupFunctions.length=0,console.log("ğŸ§¹ [AuthService] Cleanup completed"))}};f(S,"instance");let E=S;const D=E.getInstance(),H=Object.freeze(Object.defineProperty({__proto__:null,AuthService:E,authService:D},Symbol.toStringTag,{value:"Module"}));function x(a){return!a||typeof a!="object"||Array.isArray(a)?{}:a}function k(a){if(a==null)return null;if(typeof a=="string"||typeof a=="number"||typeof a=="boolean")return a;if(Array.isArray(a))return a.map(k);if(typeof a=="object"){const r={};for(const e in a)Object.prototype.hasOwnProperty.call(a,e)&&(r[e]=k(a[e]));return r}return null}function v(a,r=Date.now()){if(!a)return r;try{return new Date(a).getTime()}catch{return r}}function $(a,r=""){return a??r}function w(a,r=0){return a??r}function q(a,r=!1){return a??r}const y=class y{static getInstance(){return y.instance||(y.instance=new y),y.instance}async getUser(r){try{const{data:e,error:t}=await i.rpc("get_complete_user_data",{p_auth_user_id:r});return t?(console.error("Error getting user:",t),null):e&&e.length>0?P(e[0]):null}catch(e){return console.error("Error getting user:",e),l.error("Failed to load user data. Please try again."),null}}async updateUser(r,e){try{const{error:t}=await i.from("users").update({tier:e.tier,has_used_trial:e.hasUsedTrial,last_activity:e.lastActivity,preferences:e.preferences,app_state:e.appState,profile_data:e.profileData,onboarding_data:e.onboardingData,behavior_data:e.behaviorData,feedback_data:e.feedbackData,usage_data:e.usageData,updated_at:new Date().toISOString()}).eq("auth_user_id",r);return t?(console.error("Error updating user:",t,{userId:r,updates:e}),l.error("Failed to update user settings."),!1):!0}catch(t){return console.error("Error updating user:",t),!1}}async updateUsage(r,e){try{const{error:t}=await i.from("users").update({text_count:e.textCount,image_count:e.imageCount,text_limit:e.textLimit,image_limit:e.imageLimit,updated_at:new Date().toISOString()}).eq("auth_user_id",r);return t?(console.error("Error updating usage:",t),!1):!0}catch(t){return console.error("Error updating usage:",t,{userId:r}),l.error("Failed to update usage data."),!1}}async getConversations(r){var e,t;try{console.log("ğŸ” [Supabase] Querying conversations for auth_user_id:",r);const{data:s,error:o}=await i.from("conversations").select("id, title, auth_user_id").eq("id","game-hub").maybeSingle();s?console.log("âœ… [Supabase] Game Hub exists via .single():",s):o?console.log("âŒ [Supabase] Game Hub .single() error:",o.message):console.log("ğŸ” [Supabase] Game Hub does not exist yet");const{data:n,error:c}=await i.from("conversations").select("*").order("updated_at",{ascending:!1});if(console.log("ğŸ” [Supabase] Unfiltered query result:",{error:c==null?void 0:c.message,count:(n==null?void 0:n.length)||0,firstRow:n&&n.length>0?{id:n[0].id,title:n[0].title,auth_user_id:n[0].auth_user_id}:null}),!c&&n&&n.length>0)return console.log("âœ… [Supabase] RLS auto-filtering worked! Returned",n.length,"conversations"),this.mapConversations(n);console.log("ğŸ” [Supabase] Trying with explicit auth_user_id filter...");const{data:d,error:g}=await i.from("conversations").select("*").eq("auth_user_id",r).order("updated_at",{ascending:!1});if(g)return console.error("âŒ [Supabase] Error getting conversations:",g),console.error("âŒ [Supabase] Error details:",JSON.stringify(g)),[];if(console.log("âœ… [Supabase] Filtered query returned",d.length,"conversations"),d.length===0){const{data:{session:u}}=await i.auth.getSession();console.error("ğŸ” [Supabase] Zero results diagnostic:",{requestedUserId:r,sessionUserId:(e=u==null?void 0:u.user)==null?void 0:e.id,match:((t=u==null?void 0:u.user)==null?void 0:t.id)===r,message:"RLS SELECT policy may be blocking reads"})}return this.mapConversations(d)}catch(s){return console.error("Error getting conversations:",s),l.error("Failed to load conversations. Please try again."),[]}}mapConversations(r){return r.map(e=>{const t=e.messages,s=Array.isArray(t)?t:[];return{id:e.id,authUserId:e.auth_user_id??void 0,userId:e.user_id??void 0,title:e.title,messages:s,gameId:e.game_id??void 0,gameTitle:e.game_title??void 0,genre:e.genre??void 0,subtabs:Array.isArray(e.subtabs)?e.subtabs:[],subtabsOrder:e.subtabs_order||[],isActiveSession:e.is_active_session,activeObjective:e.active_objective??void 0,gameProgress:e.game_progress??void 0,createdAt:v(e.created_at),updatedAt:v(e.updated_at),isActive:e.is_active,isPinned:e.is_pinned??void 0,pinnedAt:e.pinned_at?new Date(e.pinned_at).getTime():void 0,isGameHub:e.is_game_hub??void 0,isUnreleased:e.is_unreleased??void 0,contextSummary:e.context_summary??void 0,lastSummarizedAt:e.last_summarized_at?new Date(e.last_summarized_at).getTime():void 0}})}async createConversation(r,e){var t,s,o,n;try{const{data:{session:c}}=await i.auth.getSession();console.log("ğŸ” [Supabase] Current session user:",(t=c==null?void 0:c.user)==null?void 0:t.id,"vs provided userId:",r),(!c||c.user.id!==r)&&console.error("âŒ [Supabase] Session mismatch! RLS will block reads. Session:",(s=c==null?void 0:c.user)==null?void 0:s.id,"vs userId:",r);const d={auth_user_id:r,title:e.title,game_id:e.gameId,game_title:e.gameTitle,genre:e.genre,is_active_session:e.isActiveSession,active_objective:e.activeObjective,game_progress:e.gameProgress,is_active:e.isActive,is_pinned:e.isPinned,pinned_at:e.pinnedAt?new Date(e.pinnedAt).toISOString():null,is_game_hub:e.isGameHub};e.id&&(d.id=e.id),console.log("ğŸ” [Supabase] Upserting conversation:",{id:d.id,title:d.title,auth_user_id:d.auth_user_id,is_game_hub:d.is_game_hub,is_active:d.is_active});const{data:g,error:u}=await i.from("conversations").upsert(d,{onConflict:"id",ignoreDuplicates:!1}).select("id").single();if(u)return console.error("âŒ [Supabase] Error creating/updating conversation:",u),console.error("âŒ [Supabase] Error details:",JSON.stringify(u)),null;console.log("âœ… [Supabase] Conversation upserted successfully:",g.id);const{data:h,error:m}=await i.from("conversations").select("*").eq("id",g.id).single();if(m)console.error("âš ï¸ [Supabase] Cannot read back conversation after upsert!",m.message),console.error("âš ï¸ [Supabase] This indicates RLS SELECT policy is blocking reads");else{console.log("âœ… [Supabase] Verified conversation data:",{id:h.id,title:h.title,auth_user_id:h.auth_user_id,auth_user_id_type:typeof h.auth_user_id,is_game_hub:h.is_game_hub});const{data:{session:A}}=await i.auth.getSession();((o=A==null?void 0:A.user)==null?void 0:o.id)!==h.auth_user_id?console.error("ğŸš¨ [Supabase] AUTH_USER_ID MISMATCH!",{sessionUserId:(n=A==null?void 0:A.user)==null?void 0:n.id,rowAuthUserId:h.auth_user_id,match:!1}):console.log("âœ… [Supabase] auth_user_id matches session perfectly")}return g.id}catch(c){return console.error("Error creating conversation:",c),null}}async updateConversation(r,e){try{const{error:t}=await i.from("conversations").update({title:e.title,game_id:e.gameId,game_title:e.gameTitle,genre:e.genre,is_active_session:e.isActiveSession,active_objective:e.activeObjective,game_progress:e.gameProgress,is_active:e.isActive,is_pinned:e.isPinned,pinned_at:e.pinnedAt?new Date(e.pinnedAt).toISOString():null,is_game_hub:e.isGameHub,is_unreleased:e.isUnreleased,context_summary:e.contextSummary,last_summarized_at:e.lastSummarizedAt?e.lastSummarizedAt:null,updated_at:new Date().toISOString()}).eq("id",r);return t?(console.error("Error updating conversation:",t),!1):!0}catch(t){return console.error("Error updating conversation:",t,{conversationId:r}),l.error("Failed to update conversation."),!1}}async deleteConversation(r){try{const{error:e}=await i.from("conversations").delete().eq("id",r);return e?(console.error("Error deleting conversation:",e),!1):!0}catch(e){return console.error("Error deleting conversation:",e,{conversationId:r}),l.error("Failed to delete conversation. Please try again."),!1}}async getGames(r){try{const{data:e,error:t}=await i.from("games").select("*").eq("auth_user_id",r).order("created_at",{ascending:!1});return t?(console.error("Error getting games:",t),[]):e.map(s=>({id:s.id,title:s.title,description:s.notes??void 0,genre:s.genre??void 0,platform:s.platform??void 0,releaseDate:"",rating:s.rating??void 0,imageUrl:s.cover_url??void 0,metadata:x(s.metadata),createdAt:v(s.created_at),updatedAt:v(s.updated_at)}))}catch(e){return console.error("Error getting games:",e),[]}}async createGame(r,e){try{const{data:t,error:s}=await i.rpc("get_user_id_from_auth_id",{p_auth_user_id:r});if(s||!t)return console.error("Error resolving user ID:",s),null;const{data:o,error:n}=await i.from("games").insert({user_id:t,auth_user_id:r,title:e.title,notes:e.description,genre:e.genre,platform:e.platform,rating:e.rating,cover_url:e.imageUrl,metadata:e.metadata}).select("id").single();return n?(console.error("Error creating game:",n),null):o.id}catch(t){return console.error("Error creating game:",t),null}}async getTrialStatus(r){try{const{data:e,error:t}=await i.from("users").select("has_used_trial, trial_started_at, trial_expires_at").eq("auth_user_id",r).single();if(t)return console.error("Error getting trial status:",t),null;const s=Date.now(),o=e.trial_expires_at?new Date(e.trial_expires_at).getTime():null,n=o?s<o:!1,c=o?Math.ceil((o-s)/(1e3*60*60*24)):0;return{isEligible:!e.has_used_trial,hasUsed:q(e.has_used_trial),isActive:n,expiresAt:o||void 0,daysRemaining:n?c:void 0}}catch(e){return console.error("Error getting trial status:",e),null}}async startTrial(r){try{const e=new Date;e.setDate(e.getDate()+14);const{error:t}=await i.from("users").update({has_used_trial:!0,trial_started_at:new Date().toISOString(),trial_expires_at:e.toISOString(),tier:L.PRO,text_limit:b[L.PRO].text,image_limit:b[L.PRO].image,updated_at:new Date().toISOString()}).eq("auth_user_id",r);return t?(console.error("Error starting trial:",t),!1):!0}catch(e){return console.error("Error starting trial:",e),!1}}async canMakeRequest(r,e){try{const{data:t,error:s}=await i.from("users").select("text_count, image_count, text_limit, image_limit, tier").eq("auth_user_id",r).single();return s?(console.error("Error checking usage:",s),!1):e==="text"?w(t.text_count)<w(t.text_limit):w(t.image_count)<w(t.image_limit)}catch(t){return console.error("Error checking usage:",t),!1}}async incrementUsage(r,e){try{const{data:t,error:s}=await i.from("users").select("usage_data").eq("auth_user_id",r).single();if(s)return console.error("Error fetching user data:",s),!1;const o=x(t==null?void 0:t.usage_data),n=e==="text"?(o.textCount||0)+1:o.textCount||0,c=e==="image"?(o.imageCount||0)+1:o.imageCount||0,d={textCount:n,imageCount:c,totalRequests:(o.totalRequests||0)+1},{error:g}=await i.from("users").update({usage_data:k(d),updated_at:new Date().toISOString()}).eq("auth_user_id",r);return g?(console.error("Error incrementing usage:",g),!1):!0}catch(t){return console.error("Error incrementing usage:",t),!1}}async resetUsage(r){try{const e={textCount:0,imageCount:0,totalRequests:0,lastReset:Date.now()},{error:t}=await i.from("users").update({usage_data:k(e),updated_at:new Date().toISOString()}).eq("auth_user_id",r);return t?(console.error("Error resetting usage:",t),!1):!0}catch(e){return console.error("Error resetting usage:",e),!1}}async recordQuery(r,e){try{const{data:t,error:s}=await i.rpc("increment_user_usage",{p_auth_user_id:r,p_query_type:e,p_increment:1});return s?(console.error("Error recording query:",s),!1):t===!0}catch(t){return console.error("Error recording query:",t),!1}}async getQueryUsage(r){try{const{data:e,error:t}=await i.from("users").select("text_count, image_count, text_limit, image_limit, last_reset").eq("auth_user_id",r).single();return t?(console.error("Error getting query usage:",t),null):{textCount:e.text_count||0,imageCount:e.image_count||0,textLimit:e.text_limit||55,imageLimit:e.image_limit||25,lastReset:new Date(e.last_reset||Date.now())}}catch(e){return console.error("Error getting query usage:",e),null}}};f(y,"instance");let C=y;const F=C.getInstance(),N=Object.freeze(Object.defineProperty({__proto__:null,SupabaseService:C,supabaseService:F},Symbol.toStringTag,{value:"Module"}));export{C as S,D as a,$ as b,v as c,w as d,H as e,N as f,I as i,x as j,z as m,F as s};
//# sourceMappingURL=core-services-DE_2wwEH.js.map
