{"version":3,"file":"core-services-Cuu6BLDA.js","sources":["../../src/utils/typeHelpers.ts","../../src/services/authService.ts","../../src/services/supabaseService.ts"],"sourcesContent":["import type { Json } from '../types/database';\r\n\r\n/**\r\n * Safely converts a Json type to a Record<string, unknown>\r\n * Returns an empty object if the value is not a valid object\r\n */\r\nexport function jsonToRecord(value: Json | null | undefined): Record<string, unknown> {\r\n  if (!value || typeof value !== 'object' || Array.isArray(value)) {\r\n    return {};\r\n  }\r\n  return value as Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Safely converts a Json type to a string\r\n * Returns an empty string if the value is not a string\r\n */\r\nexport function jsonToString(value: Json | null | undefined): string {\r\n  if (typeof value === 'string') {\r\n    return value;\r\n  }\r\n  return '';\r\n}\r\n\r\n/**\r\n * Safely converts a Json type to a number\r\n * Returns a default value if the value is not a number\r\n */\r\nexport function jsonToNumber(value: Json | null | undefined, defaultValue: number = 0): number {\r\n  if (typeof value === 'number') {\r\n    return value;\r\n  }\r\n  return defaultValue;\r\n}\r\n\r\n/**\r\n * Safely converts a Json type to a boolean\r\n * Returns a default value if the value is not a boolean\r\n */\r\nexport function jsonToBoolean(value: Json | null | undefined, defaultValue: boolean = false): boolean {\r\n  if (typeof value === 'boolean') {\r\n    return value;\r\n  }\r\n  return defaultValue;\r\n}\r\n\r\n/**\r\n * Safely converts a Json type to an array\r\n * Returns an empty array if the value is not an array\r\n */\r\nexport function jsonToArray<T>(value: Json | null | undefined): T[] {\r\n  if (Array.isArray(value)) {\r\n    return value as T[];\r\n  }\r\n  return [];\r\n}\r\n\r\n/**\r\n * Safely converts a value to Json type\r\n */\r\nexport function toJson(value: unknown): Json {\r\n  if (value === null || value === undefined) {\r\n    return null;\r\n  }\r\n  \r\n  if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\r\n    return value;\r\n  }\r\n  \r\n  if (Array.isArray(value)) {\r\n    return value.map(toJson) as Json[];\r\n  }\r\n  \r\n  if (typeof value === 'object') {\r\n    const obj: { [key: string]: Json | undefined } = {};\r\n    for (const key in value) {\r\n      if (Object.prototype.hasOwnProperty.call(value, key)) {\r\n        obj[key] = toJson((value as Record<string, unknown>)[key]);\r\n      }\r\n    }\r\n    return obj;\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n/**\r\n * Safely handles nullable date strings\r\n */\r\nexport function safeParseDate(value: string | null | undefined, defaultValue: number = Date.now()): number {\r\n  if (!value) {\r\n    return defaultValue;\r\n  }\r\n  try {\r\n    return new Date(value).getTime();\r\n  } catch {\r\n    return defaultValue;\r\n  }\r\n}\r\n\r\n/**\r\n * Safely handles nullable strings\r\n */\r\nexport function safeString(value: string | null | undefined, defaultValue: string = ''): string {\r\n  return value ?? defaultValue;\r\n}\r\n\r\n/**\r\n * Safely handles nullable numbers\r\n */\r\nexport function safeNumber(value: number | null | undefined, defaultValue: number = 0): number {\r\n  return value ?? defaultValue;\r\n}\r\n\r\n/**\r\n * Safely handles nullable booleans\r\n */\r\nexport function safeBoolean(value: boolean | null | undefined, defaultValue: boolean = false): boolean {\r\n  return value ?? defaultValue;\r\n}\r\n","import { supabase } from '../lib/supabase';\r\nimport { User, AuthResult, AuthState, UserTier } from '../types';\r\nimport { TIER_LIMITS } from '../constants';\r\nimport { cacheService } from './cacheService';\r\nimport { ErrorService } from './errorService';\r\nimport { toastService } from './toastService';\r\nimport { jsonToRecord } from '../utils/typeHelpers';\r\n\r\nexport class AuthService {\r\n  private static instance: AuthService;\r\n  private authState: AuthState = {\r\n    user: null,\r\n    isLoading: true,\r\n    error: null,\r\n  };\r\n\r\n  private listeners: ((state: AuthState) => void)[] = [];\r\n  \r\n  // ‚úÖ SCALABILITY: Using centralized cache and error services\r\n  \r\n  // ‚úÖ PERFORMANCE: Request deduplication for user loading\r\n  private pendingUserLoads = new Map<string, Promise<void>>();\r\n  \r\n  // ‚úÖ SCALABILITY: Memory leak prevention\r\n  private cleanupFunctions: (() => void)[] = [];\r\n  private isDestroyed = false;\r\n\r\n  static getInstance(): AuthService {\r\n    if (!AuthService.instance) {\r\n      AuthService.instance = new AuthService();\r\n    }\r\n    return AuthService.instance;\r\n  }\r\n\r\n  constructor() {\r\n    this.initializeAuth();\r\n    this.setupCleanup();\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Setup cleanup\r\n  private setupCleanup() {\r\n    const cleanup = () => {\r\n      if (!this.isDestroyed) {\r\n        this.cleanup();\r\n      }\r\n    };\r\n    \r\n    window.addEventListener('beforeunload', cleanup);\r\n    this.cleanupFunctions.push(() => {\r\n      window.removeEventListener('beforeunload', cleanup);\r\n    });\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Check rate limit using centralized service\r\n  private async checkRateLimit(identifier: string): Promise<boolean> {\r\n    if (this.isDestroyed) {\r\n      return false;\r\n    }\r\n    \r\n    const rateLimitData = await cacheService.getRateLimit(identifier);\r\n    const now = Date.now();\r\n    \r\n    if (!rateLimitData || now > rateLimitData.resetTime) {\r\n      await cacheService.setRateLimit(identifier, { count: 1, resetTime: now + 15 * 60 * 1000 });\r\n      return true;\r\n    }\r\n    \r\n    if (rateLimitData.count >= 10) {\r\n      return false;\r\n    }\r\n    \r\n    await cacheService.setRateLimit(identifier, { \r\n      count: rateLimitData.count + 1, \r\n      resetTime: rateLimitData.resetTime \r\n    });\r\n    return true;\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Get user from centralized cache\r\n  private async getCachedUser(authUserId: string): Promise<User | null> {\r\n    if (this.isDestroyed) {\r\n      return null;\r\n    }\r\n    \r\n    return await cacheService.getUser<User>(authUserId);\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Cache user data using centralized service\r\n  private async setCachedUser(authUserId: string, user: User): Promise<void> {\r\n    if (this.isDestroyed) {\r\n      return;\r\n    }\r\n    \r\n    await cacheService.setUser(authUserId, user);\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Clear cache using centralized service\r\n  private async clearCache(): Promise<void> {\r\n    await cacheService.clear();\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Invalidate user cache specifically\r\n  private async invalidateUserCache(authUserId: string): Promise<void> {\r\n    const cacheKey = `user:${authUserId}`;\r\n    await cacheService.delete(cacheKey);\r\n  }\r\n\r\n  private async initializeAuth() {\r\n    try {\r\n      // Always initialize auth\r\n\r\n\r\n      // Handle OAuth callback if we're on the callback URL\r\n      // Note: AuthCallback component handles OAuth callbacks, so we skip this\r\n      // to avoid conflicts\r\n      if (window.location.pathname === '/auth/callback') {\r\n        console.log('üîê [AuthService] OAuth callback detected, but AuthCallback component will handle it');\r\n        return;\r\n      }\r\n\r\n      // Try Supabase auth if available\r\n      try {\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n        \r\n        if (session?.user) {\r\n          await this.loadUserFromSupabase(session.user.id);\r\n        } else {\r\n          this.updateAuthState({ user: null, isLoading: false, error: null });\r\n        }\r\n      } catch (_supabaseError) {\r\n        // Fallback to local storage\r\n        const localUser = localStorage.getItem('otakon_user');\r\n        if (localUser) {\r\n          try {\r\n            const user = JSON.parse(localUser);\r\n            this.updateAuthState({ user, isLoading: false, error: null });\r\n          } catch (_parseError) {\r\n            this.updateAuthState({ user: null, isLoading: false, error: null });\r\n          }\r\n        } else {\r\n          this.updateAuthState({ user: null, isLoading: false, error: null });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Auth initialization error:', error);\r\n      toastService.error('Failed to initialize authentication. Please refresh the page.', {\r\n        action: {\r\n          label: 'Refresh',\r\n          onClick: () => window.location.reload()\r\n        }\r\n      });\r\n      this.updateAuthState({ user: null, isLoading: false, error: null });\r\n    }\r\n  }\r\n\r\n\r\n  private async createUserRecord(authUser: any): Promise<void> {\r\n    try {\r\n      console.log('üîê [AuthService] Creating user record for:', authUser.email);\r\n      \r\n      // Get the OAuth provider from the auth user metadata\r\n      // Check multiple possible locations for provider information\r\n      let provider = 'email';\r\n      \r\n      if (authUser.app_metadata?.provider) {\r\n        provider = authUser.app_metadata.provider;\r\n      } else if (authUser.app_metadata?.providers && authUser.app_metadata.providers.length > 0) {\r\n        provider = authUser.app_metadata.providers[0];\r\n      } else if (authUser.identities && authUser.identities.length > 0) {\r\n        provider = authUser.identities[0].provider;\r\n      } else if (authUser.user_metadata?.provider) {\r\n        provider = authUser.user_metadata.provider;\r\n      }\r\n      \r\n      console.log('üîê [AuthService] Auth user metadata:', {\r\n        app_metadata: authUser.app_metadata,\r\n        user_metadata: authUser.user_metadata,\r\n        identities: authUser.identities,\r\n        provider: provider\r\n      });\r\n      console.log('üîê [AuthService] OAuth provider:', provider);\r\n      \r\n      // Create a unique identifier that includes the provider\r\n      // For email authentication, use the original email\r\n      // For OAuth providers, use provider prefix\r\n      let uniqueEmail;\r\n      if (provider === 'email') {\r\n        uniqueEmail = authUser.email; // Use original email for email authentication\r\n      } else {\r\n        uniqueEmail = `${provider}_${authUser.email}`; // Use provider prefix for OAuth\r\n      }\r\n      \r\n      console.log('üîê [AuthService] Unique email identifier:', uniqueEmail);\r\n      \r\n      const { error } = await supabase.rpc('create_user_record', {\r\n        p_auth_user_id: authUser.id,\r\n        p_email: uniqueEmail,\r\n        p_full_name: authUser.user_metadata?.full_name || authUser.user_metadata?.name || 'User',\r\n        p_avatar_url: authUser.user_metadata?.avatar_url,\r\n        p_is_developer: false,\r\n        p_tier: 'free'\r\n      });\r\n\r\n      if (error) {\r\n        // Check if it's a duplicate key error (23505)\r\n        if (error.code === '23505' || error.message?.includes('duplicate key')) {\r\n          console.log('üîê [AuthService] User record already exists (duplicate key), continuing...');\r\n          // This is not actually an error - the user already exists\r\n          return;\r\n        }\r\n        console.error('üîê [AuthService] Error creating user record:', error);\r\n        toastService.error('Failed to create your account. Please try again.');\r\n        throw error;\r\n      }\r\n      \r\n      console.log('üîê [AuthService] User record created successfully');\r\n    } catch (error: any) {\r\n      // Check if it's a duplicate key error (23505)\r\n      if (error.code === '23505' || error.message?.includes('duplicate key')) {\r\n        console.log('üîê [AuthService] User record already exists (duplicate key in catch), continuing...');\r\n        // This is not actually an error - the user already exists\r\n        return;\r\n      }\r\n      console.error('üîê [AuthService] Error creating user record:', error);\r\n      toastService.error('Failed to create your account. Please try again.');\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Helper function to extract original email from unique identifier\r\n  private extractOriginalEmail(uniqueEmail: string): string {\r\n    // Check if this is an OAuth provider email (has provider prefix)\r\n    const oauthProviders = ['google', 'discord', 'github', 'facebook', 'twitter', 'apple'];\r\n    const parts = uniqueEmail.split('_');\r\n    \r\n    if (parts.length > 1 && oauthProviders.includes(parts[0])) {\r\n      // This is an OAuth provider email, remove the provider prefix\r\n      return parts.slice(1).join('_'); // Join in case email contains underscores\r\n    }\r\n    \r\n    // This is either an email authentication or doesn't have a recognized prefix\r\n    return uniqueEmail;\r\n  }\r\n\r\n  async loadUserFromSupabase(authUserId: string) {\r\n    // ‚úÖ PERFORMANCE: Check if there's already a pending load for this user\r\n    const existingLoad = this.pendingUserLoads.get(authUserId);\r\n    if (existingLoad) {\r\n      console.log('üîê [AuthService] Deduplicating user load request for:', authUserId);\r\n      return await existingLoad;\r\n    }\r\n\r\n    // Create a new load promise and store it\r\n    const loadPromise = (async () => {\r\n      try {\r\n        await this._loadUserFromSupabaseInternal(authUserId);\r\n      } finally {\r\n        // Clean up the pending request after completion\r\n        this.pendingUserLoads.delete(authUserId);\r\n      }\r\n    })();\r\n    \r\n    this.pendingUserLoads.set(authUserId, loadPromise);\r\n    return await loadPromise;\r\n  }\r\n\r\n  private async _loadUserFromSupabaseInternal(authUserId: string) {\r\n    try {\r\n      // ‚úÖ SCALABILITY: Check cache first\r\n      const cachedUser = await this.getCachedUser(authUserId);\r\n      if (cachedUser) {\r\n        console.log('üîê [AuthService] Using cached user data');\r\n        this.updateAuthState({ user: cachedUser, isLoading: false, error: null });\r\n        return;\r\n      }\r\n\r\n      console.log('üîê [AuthService] Loading user data from database for authUserId:', authUserId);\r\n      \r\n      // Try the RPC function first\r\n      const { data: rpcData, error: rpcError } = await supabase.rpc('get_complete_user_data', {\r\n        p_auth_user_id: authUserId\r\n      });\r\n\r\n      if (rpcError) {\r\n        console.log('üîê [AuthService] RPC function failed, trying direct table query...', rpcError);\r\n        \r\n        // Fallback: Query the table directly\r\n        const { data: tableData, error: tableError } = await supabase\r\n          .from('users')\r\n          .select('*')\r\n          .eq('auth_user_id', authUserId)\r\n          .single();\r\n\r\n        if (tableError) {\r\n          console.error('üîê [AuthService] Direct table query also failed:', tableError);\r\n          this.updateAuthState({ user: null, isLoading: false, error: 'Failed to load user data' });\r\n          return;\r\n        }\r\n\r\n        if (tableData) {\r\n          console.log('üîê [AuthService] User found via direct table query');\r\n          const user: User = {\r\n            id: tableData.id,\r\n            authUserId: tableData.auth_user_id || authUserId, // Fallback to the authUserId parameter\r\n            email: this.extractOriginalEmail(tableData.email), // Extract original email from unique identifier\r\n            tier: tableData.tier as UserTier,\r\n            hasProfileSetup: tableData.has_profile_setup || false,\r\n            hasSeenSplashScreens: tableData.has_seen_splash_screens || false,\r\n            hasSeenHowToUse: tableData.has_seen_how_to_use || false,\r\n            hasSeenFeaturesConnected: tableData.has_seen_features_connected || false,\r\n            hasSeenProFeatures: tableData.has_seen_pro_features || false,\r\n            pcConnected: tableData.pc_connected || false,\r\n            pcConnectionSkipped: tableData.pc_connection_skipped || false,\r\n            onboardingCompleted: tableData.onboarding_completed || false,\r\n            hasWelcomeMessage: tableData.has_welcome_message || false,\r\n            isNewUser: tableData.is_new_user || true,\r\n            hasUsedTrial: tableData.has_used_trial || false,\r\n            lastActivity: Date.now(),\r\n            // ‚úÖ Query-based usage limits (top-level for easy access)\r\n            textCount: tableData.text_count || 0,\r\n            imageCount: tableData.image_count || 0,\r\n            textLimit: tableData.text_limit || TIER_LIMITS[tableData.tier as UserTier]?.text || 0,\r\n            imageLimit: tableData.image_limit || TIER_LIMITS[tableData.tier as UserTier]?.image || 0,\r\n            totalRequests: tableData.total_requests || 0,\r\n            lastReset: tableData.last_reset ? new Date(tableData.last_reset).getTime() : Date.now(),\r\n            preferences: jsonToRecord(tableData.preferences),\r\n            // Legacy nested usage object (kept for backward compatibility)\r\n            usage: {\r\n              textCount: tableData.text_count || 0,\r\n              imageCount: tableData.image_count || 0,\r\n              textLimit: tableData.text_limit || TIER_LIMITS[tableData.tier as UserTier]?.text || 0,\r\n              imageLimit: tableData.image_limit || TIER_LIMITS[tableData.tier as UserTier]?.image || 0,\r\n              totalRequests: tableData.total_requests || 0,\r\n              lastReset: tableData.last_reset ? new Date(tableData.last_reset).getTime() : Date.now(),\r\n              tier: tableData.tier as UserTier,\r\n            },\r\n            appState: jsonToRecord(tableData.app_state),\r\n            profileData: jsonToRecord(tableData.profile_data),\r\n            onboardingData: jsonToRecord(tableData.onboarding_data),\r\n            behaviorData: jsonToRecord(tableData.behavior_data),\r\n            feedbackData: jsonToRecord(tableData.feedback_data),\r\n            usageData: jsonToRecord(tableData.usage_data),\r\n            createdAt: tableData.created_at ? new Date(tableData.created_at).getTime() : Date.now(),\r\n            updatedAt: tableData.updated_at ? new Date(tableData.updated_at).getTime() : Date.now(),\r\n          };\r\n\r\n          // ‚úÖ SCALABILITY: Cache user data\r\n          await this.setCachedUser(authUserId, user);\r\n          this.updateAuthState({ user, isLoading: false, error: null });\r\n          return;\r\n        }\r\n      }\r\n\r\n      // If RPC worked, use that data\r\n      if (rpcData && rpcData.length > 0) {\r\n        console.log('üîê [AuthService] User found via RPC function');\r\n        console.log('üîê [AuthService] RPC data:', rpcData[0]);\r\n        const userData = rpcData[0];\r\n        const user: User = {\r\n          id: userData.id,\r\n          authUserId: userData.auth_user_id || authUserId, // Fallback to the authUserId parameter\r\n          email: this.extractOriginalEmail(userData.email), // Extract original email from unique identifier\r\n          tier: userData.tier as UserTier,\r\n          hasProfileSetup: userData.has_profile_setup || false,\r\n          hasSeenSplashScreens: userData.has_seen_splash_screens || false,\r\n          hasSeenHowToUse: userData.has_seen_how_to_use || false,\r\n          hasSeenFeaturesConnected: userData.has_seen_features_connected || false,\r\n          hasSeenProFeatures: userData.has_seen_pro_features || false,\r\n          pcConnected: userData.pc_connected || false,\r\n          pcConnectionSkipped: userData.pc_connection_skipped || false,\r\n          onboardingCompleted: userData.onboarding_completed || false,\r\n          hasWelcomeMessage: userData.has_welcome_message || false,\r\n          isNewUser: userData.is_new_user || true,\r\n          hasUsedTrial: userData.has_used_trial || false,\r\n          lastActivity: Date.now(),\r\n          // ‚úÖ Query-based usage limits (top-level for easy access)\r\n          textCount: userData.text_count || 0,\r\n          imageCount: userData.image_count || 0,\r\n          textLimit: userData.text_limit || TIER_LIMITS[userData.tier as UserTier]?.text || 0,\r\n          imageLimit: userData.image_limit || TIER_LIMITS[userData.tier as UserTier]?.image || 0,\r\n          totalRequests: userData.total_requests || 0,\r\n          lastReset: userData.last_reset ? new Date(userData.last_reset).getTime() : Date.now(),\r\n          preferences: jsonToRecord(userData.preferences),\r\n          // Legacy nested usage object (kept for backward compatibility)\r\n          usage: {\r\n            textCount: userData.text_count || 0,\r\n            imageCount: userData.image_count || 0,\r\n            textLimit: userData.text_limit || TIER_LIMITS[userData.tier as UserTier]?.text || 0,\r\n            imageLimit: userData.image_limit || TIER_LIMITS[userData.tier as UserTier]?.image || 0,\r\n            totalRequests: userData.total_requests || 0,\r\n            lastReset: userData.last_reset ? new Date(userData.last_reset).getTime() : Date.now(),\r\n            tier: userData.tier as UserTier,\r\n          },\r\n          appState: jsonToRecord(userData.app_state),\r\n          profileData: jsonToRecord(userData.profile_data),\r\n          onboardingData: jsonToRecord(userData.onboarding_data),\r\n          behaviorData: jsonToRecord(userData.behavior_data),\r\n          feedbackData: jsonToRecord(userData.feedback_data),\r\n          usageData: jsonToRecord(userData.usage_data),\r\n          createdAt: userData.created_at ? new Date(userData.created_at).getTime() : Date.now(),\r\n          updatedAt: userData.updated_at ? new Date(userData.updated_at).getTime() : Date.now(),\r\n        };\r\n\r\n        console.log('üîê [AuthService] User onboarding flags:', {\r\n          hasProfileSetup: user.hasProfileSetup,\r\n          hasSeenSplashScreens: user.hasSeenSplashScreens,\r\n          hasSeenHowToUse: user.hasSeenHowToUse,\r\n          hasSeenFeaturesConnected: user.hasSeenFeaturesConnected,\r\n          hasSeenProFeatures: user.hasSeenProFeatures,\r\n          pcConnected: user.pcConnected,\r\n          pcConnectionSkipped: user.pcConnectionSkipped,\r\n          onboardingCompleted: user.onboardingCompleted\r\n        });\r\n\r\n        // ‚úÖ SCALABILITY: Cache user data\r\n        await this.setCachedUser(authUserId, user);\r\n        this.updateAuthState({ user, isLoading: false, error: null });\r\n      } else {\r\n        // User not found - try to create manually\r\n        console.log('üîê [AuthService] User not found, trying to create manually...');\r\n        try {\r\n          const { data: { user: authUser } } = await supabase.auth.getUser();\r\n          if (authUser) {\r\n            console.log('üîê [AuthService] Creating user record for auth user:', authUser.email);\r\n            await this.createUserRecord(authUser);\r\n            // ‚úÖ PERFORMANCE: Call internal function directly to avoid deadlock with deduplication Map\r\n            await this._loadUserFromSupabaseInternal(authUserId);\r\n          } else {\r\n            this.updateAuthState({ user: null, isLoading: false, error: 'User not found and could not create user record' });\r\n          }\r\n        } catch (createError) {\r\n          console.error('üîê [AuthService] Failed to create user record manually:', createError);\r\n          this.updateAuthState({ user: null, isLoading: false, error: 'User not found and could not create user record' });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading user from Supabase:', error);\r\n      this.updateAuthState({ user: null, isLoading: false, error: 'Failed to load user data' });\r\n    }\r\n  }\r\n\r\n\r\n  private updateAuthState(newState: Partial<AuthState>) {\r\n    const previousState = { ...this.authState };\r\n    this.authState = { ...this.authState, ...newState };\r\n    \r\n    // Only notify listeners if the state actually changed\r\n    const hasChanged = JSON.stringify(previousState) !== JSON.stringify(this.authState);\r\n    if (hasChanged) {\r\n      this.listeners.forEach(listener => listener(this.authState));\r\n    }\r\n  }\r\n\r\n  // Public methods\r\n  \r\n  // ‚ö†Ô∏è PROTECTED OAUTH FLOW - DO NOT MODIFY WITHOUT WARNING ‚ö†Ô∏è\r\n  // Google OAuth is working correctly - any changes here could break user authentication\r\n  // If you need to modify this, add a warning comment explaining the change\r\n  async signInWithGoogle(): Promise<AuthResult> {\r\n    try {\r\n      // ‚úÖ SCALABILITY: Rate limiting\r\n      if (!(await this.checkRateLimit('google_signin'))) {\r\n        return { success: false, error: 'Too many sign-in attempts. Please wait before trying again.' };\r\n      }\r\n\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      console.log('üîê [AuthService] Starting Google OAuth...');\r\n      console.log('üîê [AuthService] Redirect URL:', `${window.location.origin}/auth/callback`);\r\n      \r\n      const { error } = await supabase.auth.signInWithOAuth({\r\n        provider: 'google',\r\n        options: {\r\n          redirectTo: `${window.location.origin}/auth/callback`,\r\n          queryParams: {\r\n            prompt: 'select_account' // Force Google account selection\r\n          }\r\n        }\r\n      });\r\n\r\n      if (error) {\r\n        console.error('üîê [AuthService] Google OAuth error:', error);\r\n        toastService.error('Failed to sign in with Google. Please try again.');\r\n        this.updateAuthState({ isLoading: false, error: error.message });\r\n        return { success: false, error: error.message };\r\n      }\r\n\r\n      console.log('üîê [AuthService] Google OAuth initiated successfully');\r\n      return { success: true };\r\n    } catch (error) {\r\n      ErrorService.handleAuthError(error as Error, 'signInWithGoogle');\r\n      toastService.error('Google sign-in failed. Please try again.');\r\n      this.updateAuthState({ \r\n        user: null, \r\n        isLoading: false, \r\n        error: 'Google sign-in failed. Please try again.' \r\n      });\r\n      return { success: false, error: 'Google sign-in failed. Please try again.' };\r\n    }\r\n  }\r\n\r\n  // ‚ö†Ô∏è PROTECTED OAUTH FLOW - DO NOT MODIFY WITHOUT WARNING ‚ö†Ô∏è\r\n  // Discord OAuth is working correctly - any changes here could break user authentication\r\n  // If you need to modify this, add a warning comment explaining the change\r\n  async signInWithDiscord(): Promise<AuthResult> {\r\n    // ‚úÖ SCALABILITY: Rate limiting\r\n    if (!this.checkRateLimit('discord_signin')) {\r\n      return { success: false, error: 'Too many sign-in attempts. Please wait before trying again.' };\r\n    }\r\n\r\n    try {\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      console.log('üîê [AuthService] Starting Discord OAuth...');\r\n      \r\n      // Construct the redirect URL properly using current origin\r\n      const redirectUrl = `${window.location.origin}/auth/callback`;\r\n      console.log('üîê [AuthService] Redirect URL:', redirectUrl);\r\n      console.log('üîê [AuthService] Current origin:', window.location.origin);\r\n      console.log('üîê [AuthService] Current pathname:', window.location.pathname);\r\n      console.log('üîê [AuthService] Current port:', window.location.port);\r\n      console.log('üîê [AuthService] Full URL:', window.location.href);\r\n      \r\n      // Check if we're already on the callback page\r\n      if (window.location.pathname === '/auth/callback') {\r\n        console.log('üîê [AuthService] Already on callback page, skipping OAuth initiation');\r\n        this.updateAuthState({ isLoading: false, error: null });\r\n        return { success: false, error: 'Already on callback page' };\r\n      }\r\n      \r\n      // Store the current URL for potential error handling\r\n      localStorage.setItem('otakon_discord_auth_attempt', Date.now().toString());\r\n      \r\n      // Initiate Discord OAuth with proper error handling\r\n      console.log('üîê [AuthService] Initiating Discord OAuth with redirectTo:', redirectUrl);\r\n      \r\n      const { data, error } = await supabase.auth.signInWithOAuth({\r\n        provider: 'discord',\r\n        options: {\r\n          redirectTo: redirectUrl,\r\n          queryParams: {\r\n            access_type: 'offline',\r\n            prompt: 'consent',\r\n          }\r\n        }\r\n      });\r\n\r\n      if (error) {\r\n        console.error('üîê [AuthService] Discord OAuth error:', error);\r\n        console.error('üîê [AuthService] Error details:', {\r\n          message: error.message,\r\n          status: error.status\r\n        });\r\n        \r\n        // Provide more specific error messages\r\n        let errorMessage = 'Discord authentication failed. ';\r\n        if (error.message.includes('Invalid redirect URI')) {\r\n          errorMessage += 'Please check Discord OAuth configuration in Supabase dashboard.';\r\n        } else if (error.message.includes('Invalid client')) {\r\n          errorMessage += 'Discord OAuth credentials are invalid. Please check Supabase configuration.';\r\n        } else if (error.message.includes('access_denied')) {\r\n          errorMessage += 'Discord authorization was cancelled.';\r\n        } else {\r\n          errorMessage += error.message;\r\n        }\r\n        \r\n        toastService.error(`Failed to sign in with Discord. ${errorMessage}`);\r\n        this.updateAuthState({ isLoading: false, error: errorMessage });\r\n        return { success: false, error: errorMessage };\r\n      }\r\n\r\n      console.log('üîê [AuthService] Discord OAuth initiated successfully');\r\n      console.log('üîê [AuthService] OAuth data:', data);\r\n      \r\n      // OAuth will redirect, so we return success\r\n      return { success: true };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      console.error('üîê [AuthService] Discord OAuth exception:', error);\r\n      console.error('üîê [AuthService] Exception details:', {\r\n        name: error instanceof Error ? error.name : 'Unknown',\r\n        message: errorMessage,\r\n        stack: error instanceof Error ? error.stack : 'No stack trace'\r\n      });\r\n      \r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n  // ‚ö†Ô∏è PROTECTED EMAIL AUTH FLOW - DO NOT MODIFY WITHOUT WARNING ‚ö†Ô∏è\r\n  // Email authentication is working correctly - any changes here could break user authentication\r\n  // If you need to modify this, add a warning comment explaining the change\r\n  async signInWithEmail(email: string, password: string): Promise<AuthResult> {\r\n    // ‚úÖ SCALABILITY: Rate limiting\r\n    if (!this.checkRateLimit(`email_signin_${email}`)) {\r\n      return { success: false, error: 'Too many sign-in attempts. Please wait before trying again.' };\r\n    }\r\n\r\n    try {\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      console.log('üîê [AuthService] Starting email sign-in...');\r\n      \r\n      const { data, error } = await supabase.auth.signInWithPassword({\r\n        email,\r\n        password\r\n      });\r\n\r\n      if (error) {\r\n        console.error('üîê [AuthService] Email sign-in error:', error);\r\n        \r\n        // Provide more helpful error messages\r\n        let errorMessage = error.message;\r\n        \r\n        if (error.message.includes('Invalid login credentials')) {\r\n          // Check if this might be a provider mismatch issue\r\n          // We can't check the database without authentication, but we can provide a helpful message\r\n          errorMessage = 'Invalid email or password. If you signed up with Google or Discord, please use those options instead.';\r\n        } else if (error.message.includes('Email not confirmed')) {\r\n          errorMessage = 'Please check your email and click the confirmation link before signing in.';\r\n        } else if (error.message.includes('Too many requests')) {\r\n          errorMessage = 'Too many sign-in attempts. Please wait a moment before trying again.';\r\n        }\r\n        \r\n        toastService.error(errorMessage);\r\n        this.updateAuthState({ isLoading: false, error: errorMessage });\r\n        return { success: false, error: errorMessage };\r\n      }\r\n\r\n      if (data.user) {\r\n        console.log('üîê [AuthService] Email sign-in successful:', data.user.email);\r\n        toastService.success('Welcome back! Successfully signed in.');\r\n        // Load user data (this will handle user creation if needed)\r\n        await this.loadUserFromSupabase(data.user.id);\r\n        return { success: true, user: this.authState.user || undefined };\r\n      }\r\n\r\n      return { success: false, error: 'No user data returned' };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      console.error('üîê [AuthService] Email sign-in exception:', error);\r\n      toastService.error('Sign-in failed. Please try again.');\r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n\r\n  // ‚ö†Ô∏è PROTECTED EMAIL AUTH FLOW - DO NOT MODIFY WITHOUT WARNING ‚ö†Ô∏è\r\n  // Email signup is working correctly - any changes here could break user registration\r\n  // If you need to modify this, add a warning comment explaining the change\r\n  async signUpWithEmail(email: string, password: string): Promise<AuthResult> {\r\n    try {\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      console.log('üîê [AuthService] Starting email sign-up...');\r\n      \r\n      const { data, error } = await supabase.auth.signUp({\r\n        email,\r\n        password,\r\n        options: {\r\n          emailRedirectTo: `${window.location.origin}/auth/callback`\r\n        }\r\n      });\r\n\r\n      // Handle email confirmation errors gracefully\r\n      let isEmailConfirmationDisabled = false;\r\n      if (error) {\r\n        console.error('üîê [AuthService] Email sign-up error:', error);\r\n        \r\n        if (error.message.includes('Error sending confirmation email')) {\r\n          console.log('üîê [AuthService] Email confirmation disabled, proceeding with sign-up...');\r\n          isEmailConfirmationDisabled = true;\r\n          // Continue with the sign-up process even if email confirmation fails\r\n          // This is useful for development when email confirmation is disabled\r\n        } else {\r\n          toastService.error(`Sign-up failed: ${error.message}`);\r\n          this.updateAuthState({ isLoading: false, error: error.message });\r\n          return { success: false, error: error.message };\r\n        }\r\n      }\r\n\r\n      if (data.user) {\r\n        console.log('üîê [AuthService] Email sign-up successful:', data.user.email);\r\n        console.log('üîê [AuthService] User confirmation required:', !data.user.email_confirmed_at);\r\n        \r\n        // Check if email confirmation is required\r\n        if (!data.user.email_confirmed_at) {\r\n          console.log('üîê [AuthService] Email confirmation required, user not yet signed in');\r\n          \r\n          // For development, if email confirmation is disabled, proceed anyway\r\n          if (isEmailConfirmationDisabled) {\r\n            console.log('üîê [AuthService] Email confirmation disabled, creating user record anyway...');\r\n            toastService.success('Account created successfully! Welcome to Otakon!');\r\n            await this.loadUserFromSupabase(data.user.id);\r\n            return { success: true, user: this.authState.user || undefined };\r\n          }\r\n          \r\n          this.updateAuthState({ isLoading: false, error: null });\r\n          return { \r\n            success: true, \r\n            user: undefined, \r\n            requiresConfirmation: true,\r\n            message: 'Please check your email and click the confirmation link to complete your account setup.'\r\n          };\r\n        }\r\n        \r\n        // User is confirmed, load user data\r\n        await this.loadUserFromSupabase(data.user.id);\r\n        return { success: true, user: this.authState.user || undefined };\r\n      }\r\n\r\n      return { success: false, error: 'No user data returned' };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      console.error('üîê [AuthService] Email sign-up exception:', error);\r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n  async resetPassword(email: string): Promise<AuthResult> {\r\n    try {\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      const { error } = await supabase.auth.resetPasswordForEmail(email, {\r\n        redirectTo: `${window.location.origin}${window.location.pathname}`\r\n      });\r\n\r\n      if (error) {\r\n        this.updateAuthState({ isLoading: false, error: error.message });\r\n        return { success: false, error: error.message };\r\n      }\r\n\r\n      this.updateAuthState({ isLoading: false, error: null });\r\n      return { success: true };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n  async signOut(): Promise<void> {\r\n    try {\r\n      console.log('üîê [AuthService] Starting sign out process...');\r\n      \r\n      // Sign out from Supabase FIRST to clear session tokens\r\n      await supabase.auth.signOut();\r\n      \r\n      // Clear ALL Supabase-related localStorage keys (they start with 'sb-')\r\n      const keysToRemove: string[] = [];\r\n      for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i);\r\n        if (key && key.startsWith('sb-')) {\r\n          keysToRemove.push(key);\r\n        }\r\n      }\r\n      keysToRemove.forEach(key => localStorage.removeItem(key));\r\n      console.log('üîê [AuthService] Cleared Supabase localStorage keys:', keysToRemove);\r\n      \r\n      // Clear all app-specific local storage\r\n      localStorage.removeItem('otakon_auth_method');\r\n      localStorage.removeItem('otakon_remember_me');\r\n      localStorage.removeItem('otakon_remembered_email');\r\n      localStorage.removeItem('otakon_discord_auth_attempt');\r\n      localStorage.removeItem('otakon_has_used_app');\r\n      localStorage.removeItem('otakon_user');\r\n      localStorage.removeItem('otakon_conversations');\r\n      \r\n      // Clear any stored app state\r\n      localStorage.removeItem('otakon_app_state');\r\n      \r\n      // Clear sessionStorage\r\n      sessionStorage.clear();\r\n      \r\n      // ‚úÖ SCALABILITY: Clear cache\r\n      this.clearCache();\r\n      \r\n      // Clear auth state\r\n      this.updateAuthState({ user: null, isLoading: false, error: null });\r\n      \r\n      console.log('üîê [AuthService] Sign out completed successfully');\r\n      toastService.success('Successfully signed out. See you next time!');\r\n    } catch (error) {\r\n      console.error('üîê [AuthService] Sign out error:', error);\r\n      toastService.error('Sign out failed. Please try again.');\r\n      // Even if there's an error, clear the local state\r\n      this.updateAuthState({ user: null, isLoading: false, error: null });\r\n    }\r\n  }\r\n\r\n  getCurrentUser(): User | null {\r\n    return this.authState.user;\r\n  }\r\n\r\n  getAuthState(): AuthState {\r\n    return this.authState;\r\n  }\r\n\r\n\r\n  // Method to clear all user data for testing multiple OAuth providers\r\n  async clearAllUserData(): Promise<void> {\r\n    try {\r\n      console.log('üîê [AuthService] Clearing all user data for testing...');\r\n      \r\n      // Clear localStorage\r\n      localStorage.removeItem('otakon_auth_method');\r\n      localStorage.removeItem('otakon_remember_me');\r\n      localStorage.removeItem('otakon_remembered_email');\r\n      \r\n      // Sign out from Supabase\r\n      await supabase.auth.signOut();\r\n      \r\n      // Clear auth state\r\n      this.updateAuthState({ user: null, isLoading: false, error: null });\r\n      \r\n      console.log('üîê [AuthService] All user data cleared successfully');\r\n    } catch (error) {\r\n      console.error('üîê [AuthService] Error clearing user data:', error);\r\n    }\r\n  }\r\n\r\n  // Method to check which provider was used for a given email\r\n  async checkEmailProvider(email: string): Promise<{ provider: string | null; message: string }> {\r\n    try {\r\n      console.log('üîê [AuthService] Checking provider for email:', email);\r\n      \r\n      // For now, skip provider checking during sign-in to avoid 401 errors\r\n      // This will be handled by the actual sign-in attempt\r\n      console.log('üîê [AuthService] Skipping provider check to avoid 401 errors during sign-in');\r\n      return { provider: null, message: '' };\r\n    } catch (error) {\r\n      console.error('üîê [AuthService] Error checking email provider:', error);\r\n      return { provider: null, message: '' };\r\n    }\r\n  }\r\n\r\n  async resendConfirmationEmail(email: string): Promise<AuthResult> {\r\n    try {\r\n      console.log('üîê [AuthService] Resending confirmation email for:', email);\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n\r\n      const { error } = await supabase.auth.resend({\r\n        type: 'signup',\r\n        email: email,\r\n        options: {\r\n          emailRedirectTo: `${window.location.origin}/auth/callback`\r\n        }\r\n      });\r\n\r\n      if (error) {\r\n        console.error('üîê [AuthService] Error resending confirmation email:', error);\r\n        toastService.error('Failed to resend confirmation email. Please try again.');\r\n        this.updateAuthState({ isLoading: false, error: error.message });\r\n        return { success: false, error: error.message };\r\n      }\r\n\r\n      console.log('üîê [AuthService] Confirmation email resent successfully');\r\n      toastService.success('Confirmation email sent! Please check your inbox.');\r\n      this.updateAuthState({ isLoading: false, error: null });\r\n      return { \r\n        success: true, \r\n        message: 'Confirmation email sent! Please check your inbox and click the confirmation link.' \r\n      };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      console.error('üîê [AuthService] Exception resending confirmation email:', error);\r\n      toastService.error('Failed to resend confirmation email. Please try again.');\r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n  // Method to test Discord OAuth configuration\r\n  async testDiscordConfiguration(): Promise<{ isValid: boolean; message: string; details: any }> {\r\n    try {\r\n      console.log('üîê [AuthService] Testing Discord OAuth configuration...');\r\n      \r\n      // Check if we can access Supabase auth\r\n      const { error: sessionError } = await supabase.auth.getSession();\r\n      if (sessionError) {\r\n        return {\r\n          isValid: false,\r\n          message: 'Cannot access Supabase auth service',\r\n          details: { sessionError }\r\n        };\r\n      }\r\n      \r\n      // For now, assume Discord is available if we can access auth\r\n      // The actual provider check would require a different approach\r\n      // This will be determined by the actual OAuth attempt\r\n      \r\n      // Test redirect URL construction\r\n      const redirectUrl = `${window.location.origin}/auth/callback`;\r\n      console.log('üîê [AuthService] Test redirect URL:', redirectUrl);\r\n      \r\n      return {\r\n        isValid: true,\r\n        message: 'Discord OAuth configuration appears to be valid',\r\n        details: {\r\n          redirectUrl,\r\n          currentOrigin: window.location.origin,\r\n          currentPathname: window.location.pathname\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('üîê [AuthService] Error testing Discord configuration:', error);\r\n      return {\r\n        isValid: false,\r\n        message: 'Error testing Discord configuration',\r\n        details: { error: error instanceof Error ? error.message : 'Unknown error' }\r\n      };\r\n    }\r\n  }\r\n\r\n  async refreshUser(): Promise<void> {\r\n    if (this.authState.user) {\r\n      console.log('üîê [AuthService] Refreshing user data...');\r\n      // Invalidate cache before loading to ensure fresh data\r\n      await this.invalidateUserCache(this.authState.user.authUserId);\r\n      await this.loadUserFromSupabase(this.authState.user.authUserId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update user profile preferences\r\n   */\r\n  async updateUserProfile(authUserId: string, profileData: any): Promise<void> {\r\n    try {\r\n      // Update in Supabase\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({ profile_data: profileData })\r\n        .eq('auth_user_id', authUserId);\r\n\r\n      if (error) {\r\n        console.error('Error updating profile:', error);\r\n        toastService.error('Failed to update profile. Please try again.');\r\n        throw error;\r\n      }\r\n\r\n      // Invalidate cache and reload user\r\n      await this.invalidateUserCache(authUserId);\r\n      await this.loadUserFromSupabase(authUserId);\r\n      \r\n      console.log('‚úÖ Profile preferences updated successfully');\r\n      toastService.success('Profile updated successfully!');\r\n    } catch (error) {\r\n      console.error('Failed to update profile preferences:', error);\r\n      toastService.error('Failed to update profile. Please try again.');\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  subscribe(listener: (state: AuthState) => void): () => void {\r\n    this.listeners.push(listener);\r\n    \r\n    // Call listener immediately with current state\r\n    listener(this.authState);\r\n    \r\n    // Return unsubscribe function\r\n    return () => {\r\n      const index = this.listeners.indexOf(listener);\r\n      if (index > -1) {\r\n        this.listeners.splice(index, 1);\r\n      }\r\n    };\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Cleanup method to prevent memory leaks\r\n  cleanup(): void {\r\n    if (this.isDestroyed) {\r\n      return;\r\n    }\r\n    \r\n    console.log('üßπ [AuthService] Cleaning up...');\r\n    \r\n    this.isDestroyed = true;\r\n    \r\n    // Clear cache\r\n    this.clearCache();\r\n    \r\n    // Rate limiter is now handled by centralized cache service\r\n    \r\n    // Clear listeners\r\n    this.listeners.length = 0;\r\n    \r\n    // Run cleanup functions\r\n    this.cleanupFunctions.forEach(cleanup => {\r\n      try {\r\n        cleanup();\r\n      } catch (error) {\r\n        console.error('Error during auth service cleanup:', error);\r\n      }\r\n    });\r\n    this.cleanupFunctions.length = 0;\r\n    \r\n    console.log('üßπ [AuthService] Cleanup completed');\r\n  }\r\n\r\n}\r\n\r\nexport const authService = AuthService.getInstance();\r\n","import { supabase } from '../lib/supabase';\r\nimport { User, Conversation, Game, UserTier, TrialStatus } from '../types';\r\nimport { USER_TIERS, TIER_LIMITS } from '../constants';\r\nimport { jsonToRecord, safeParseDate, safeBoolean, safeNumber, toJson } from '../utils/typeHelpers';\r\n\r\nexport class SupabaseService {\r\n  private static instance: SupabaseService;\r\n\r\n  static getInstance(): SupabaseService {\r\n    if (!SupabaseService.instance) {\r\n      SupabaseService.instance = new SupabaseService();\r\n    }\r\n    return SupabaseService.instance;\r\n  }\r\n\r\n  // User operations\r\n  async getUser(authUserId: string): Promise<User | null> {\r\n    try {\r\n      const { data, error } = await supabase.rpc('get_complete_user_data', {\r\n        p_auth_user_id: authUserId\r\n      });\r\n\r\n      if (error) {\r\n        console.error('Error getting user:', error);\r\n        return null;\r\n      }\r\n\r\n      if (data && data.length > 0) {\r\n        const userData = data[0];\r\n        return {\r\n          id: userData.id,\r\n          authUserId: userData.auth_user_id,\r\n          email: userData.email,\r\n          tier: userData.tier as UserTier,\r\n          hasProfileSetup: false,\r\n          hasSeenSplashScreens: false,\r\n          hasSeenHowToUse: false,\r\n          hasSeenFeaturesConnected: false,\r\n          hasSeenProFeatures: false,\r\n          pcConnected: false,\r\n          pcConnectionSkipped: false,\r\n          onboardingCompleted: false,\r\n          hasWelcomeMessage: false,\r\n          isNewUser: true,\r\n          hasUsedTrial: userData.has_used_trial,\r\n          lastActivity: Date.now(),\r\n          // ‚úÖ Query-based usage limits (top-level)\r\n          textCount: userData.text_count || 0,\r\n          imageCount: userData.image_count || 0,\r\n          textLimit: userData.text_limit || 55,\r\n          imageLimit: userData.image_limit || 25,\r\n          totalRequests: userData.total_requests || 0,\r\n          lastReset: userData.last_reset ? new Date(userData.last_reset).getTime() : Date.now(),\r\n          preferences: jsonToRecord(userData.preferences),\r\n          // Legacy nested usage object\r\n          usage: {\r\n            textCount: userData.text_count,\r\n            imageCount: userData.image_count,\r\n            textLimit: userData.text_limit,\r\n            imageLimit: userData.image_limit,\r\n            totalRequests: 0,\r\n            lastReset: Date.now(),\r\n            tier: userData.tier as UserTier,\r\n          },\r\n          appState: jsonToRecord(userData.app_state),\r\n          profileData: jsonToRecord(userData.profile_data),\r\n          onboardingData: {},\r\n          behaviorData: {},\r\n          feedbackData: {},\r\n          usageData: {},\r\n          createdAt: Date.now(),\r\n          updatedAt: Date.now(),\r\n        };\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      console.error('Error getting user:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async updateUser(userId: string, updates: Partial<User>): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          tier: updates.tier,\r\n          has_used_trial: updates.hasUsedTrial,\r\n          last_activity: updates.lastActivity,\r\n          preferences: updates.preferences,\r\n          app_state: updates.appState,\r\n          profile_data: updates.profileData,\r\n          onboarding_data: updates.onboardingData,\r\n          behavior_data: updates.behaviorData,\r\n          feedback_data: updates.feedbackData,\r\n          usage_data: updates.usageData,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error updating user:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating user:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async updateUsage(userId: string, usage: any): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          text_count: usage.textCount,\r\n          image_count: usage.imageCount,\r\n          text_limit: usage.textLimit,\r\n          image_limit: usage.imageLimit,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error updating usage:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating usage:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Conversation operations\r\n  async getConversations(userId: string): Promise<Conversation[]> {\r\n    try {\r\n      // ‚úÖ FIX: Query by auth_user_id directly (matches RLS policies)\r\n      const { data, error } = await supabase\r\n        .from('conversations')\r\n        .select('*')\r\n        .eq('auth_user_id', userId)\r\n        .order('updated_at', { ascending: false });\r\n\r\n      if (error) {\r\n        console.error('Error getting conversations:', error);\r\n        return [];\r\n      }\r\n\r\n      // üîç DEBUG: Log what we're getting from Supabase\r\n      if (process.env.NODE_ENV === 'development' && data.length > 0) {\r\n        const sample = data[0];\r\n        const messages = sample.messages as any;\r\n        const subtabs = sample.subtabs as any;\r\n        console.error('üîç [Supabase] Sample conversation from DB:', {\r\n          id: sample.id,\r\n          title: sample.title,\r\n          messageCount: Array.isArray(messages) ? messages.length : 0,\r\n          hasMessagesField: 'messages' in sample,\r\n          messagesType: typeof messages,\r\n          subtabCount: Array.isArray(subtabs) ? subtabs.length : 0\r\n        });\r\n      }\r\n\r\n      return data.map(conv => ({\r\n        id: conv.id,\r\n        title: conv.title,\r\n        messages: Array.isArray(conv.messages) ? conv.messages as unknown[] : [],\r\n        gameId: conv.game_id ?? undefined,\r\n        gameTitle: conv.game_title ?? undefined,\r\n        genre: conv.genre ?? undefined,\r\n        subtabs: Array.isArray(conv.subtabs) ? conv.subtabs as unknown[] : [],\r\n        subtabsOrder: conv.subtabs_order || [],\r\n        isActiveSession: conv.is_active_session,\r\n        activeObjective: conv.active_objective ?? undefined,\r\n        gameProgress: conv.game_progress ?? undefined,\r\n        createdAt: safeParseDate(conv.created_at),\r\n        updatedAt: safeParseDate(conv.updated_at),\r\n        isActive: conv.is_active,\r\n        isPinned: conv.is_pinned ?? undefined,\r\n        pinnedAt: conv.pinned_at ? new Date(conv.pinned_at).getTime() : undefined,\r\n        isGameHub: conv.is_game_hub ?? undefined,\r\n        isUnreleased: conv.is_unreleased ?? undefined,\r\n        contextSummary: conv.context_summary ?? undefined,\r\n        lastSummarizedAt: conv.last_summarized_at ? new Date(conv.last_summarized_at).getTime() : undefined,\r\n      })) as Conversation[];\r\n    } catch (error) {\r\n      console.error('Error getting conversations:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async createConversation(userId: string, conversation: Omit<Conversation, 'id' | 'createdAt' | 'updatedAt'>): Promise<string | null> {\r\n    try {\r\n      // ‚úÖ FIX: Use auth_user_id directly instead of RPC function\r\n      // The RPC function get_user_id_from_auth_id was causing issues\r\n      // Now we use auth_user_id (which references auth.users.id) directly\r\n      // This matches the RLS policies which check auth_user_id = auth.uid()\r\n      \r\n      const { data, error } = await supabase\r\n        .from('conversations')\r\n        .insert({\r\n          auth_user_id: userId, // ‚úÖ Direct auth user ID\r\n          title: conversation.title,\r\n          messages: conversation.messages,\r\n          game_id: conversation.gameId,\r\n          game_title: conversation.gameTitle,\r\n          genre: conversation.genre,\r\n          subtabs: conversation.subtabs || [],\r\n          subtabs_order: conversation.subtabsOrder || [],\r\n          is_active_session: conversation.isActiveSession,\r\n          active_objective: conversation.activeObjective,\r\n          game_progress: conversation.gameProgress,\r\n          is_active: conversation.isActive,\r\n          is_pinned: conversation.isPinned,\r\n          pinned_at: conversation.pinnedAt ? new Date(conversation.pinnedAt).toISOString() : null,\r\n          is_game_hub: conversation.isGameHub,\r\n        } as any) // ‚ö†Ô∏è Temporary: auth_user_id not in types yet, regenerate after SQL fix\r\n        .select('id')\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error creating conversation:', error);\r\n        return null;\r\n      }\r\n\r\n      return data.id;\r\n    } catch (error) {\r\n      console.error('Error creating conversation:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async updateConversation(conversationId: string, updates: Partial<Conversation>): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('conversations')\r\n        .update({\r\n          title: updates.title,\r\n          messages: updates.messages ? toJson(updates.messages) : undefined,\r\n          game_id: updates.gameId,\r\n          game_title: updates.gameTitle,\r\n          genre: updates.genre,\r\n          subtabs: updates.subtabs ? toJson(updates.subtabs) : undefined,\r\n          subtabs_order: updates.subtabsOrder,\r\n          is_active_session: updates.isActiveSession,\r\n          active_objective: updates.activeObjective,\r\n          game_progress: updates.gameProgress,\r\n          is_active: updates.isActive,\r\n          is_pinned: updates.isPinned,\r\n          pinned_at: updates.pinnedAt ? new Date(updates.pinnedAt).toISOString() : null,\r\n          is_game_hub: updates.isGameHub,\r\n          is_unreleased: updates.isUnreleased,\r\n          context_summary: updates.contextSummary,\r\n          last_summarized_at: updates.lastSummarizedAt ? updates.lastSummarizedAt : null,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('id', conversationId);\r\n\r\n      if (error) {\r\n        console.error('Error updating conversation:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating conversation:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async deleteConversation(conversationId: string): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('conversations')\r\n        .delete()\r\n        .eq('id', conversationId);\r\n\r\n      if (error) {\r\n        console.error('Error deleting conversation:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error deleting conversation:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Game operations\r\n  async getGames(userId: string): Promise<Game[]> {\r\n    try {\r\n      // ‚úÖ OPTIMIZED: Direct auth_user_id comparison (no JOIN needed)\r\n      // RLS policy enforces ownership via games.auth_user_id = auth.uid()\r\n      const { data, error } = await supabase\r\n        .from('games')\r\n        .select('*')\r\n        .eq('auth_user_id', userId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) {\r\n        console.error('Error getting games:', error);\r\n        return [];\r\n      }\r\n\r\n      return data.map(game => ({\r\n        id: game.id,\r\n        title: game.title,\r\n        description: game.notes ?? undefined,\r\n        genre: game.genre ?? undefined,\r\n        platform: game.platform ?? undefined,\r\n        releaseDate: '',\r\n        rating: game.rating ?? undefined,\r\n        imageUrl: game.cover_url ?? undefined,\r\n        metadata: jsonToRecord(game.metadata),\r\n        createdAt: safeParseDate(game.created_at),\r\n        updatedAt: safeParseDate(game.updated_at),\r\n      }));\r\n    } catch (error) {\r\n      console.error('Error getting games:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async createGame(userId: string, game: Omit<Game, 'id' | 'createdAt' | 'updatedAt'>): Promise<string | null> {\r\n    try {\r\n      // ‚úÖ OPTIMIZED: Use database function to resolve user_id in single operation\r\n      const { data: userIdData, error: userIdError } = await supabase\r\n        .rpc('get_user_id_from_auth_id', { p_auth_user_id: userId });\r\n\r\n      if (userIdError || !userIdData) {\r\n        console.error('Error resolving user ID:', userIdError);\r\n        return null;\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('games')\r\n        .insert({\r\n          user_id: userIdData,\r\n          auth_user_id: userId, // ‚úÖ Store auth_user_id for direct RLS checks\r\n          title: game.title,\r\n          notes: game.description,\r\n          genre: game.genre,\r\n          platform: game.platform,\r\n          rating: game.rating,\r\n          cover_url: game.imageUrl,\r\n          metadata: game.metadata,\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error creating game:', error);\r\n        return null;\r\n      }\r\n\r\n      return data.id;\r\n    } catch (error) {\r\n      console.error('Error creating game:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Trial operations\r\n  async getTrialStatus(userId: string): Promise<TrialStatus | null> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('has_used_trial, trial_started_at, trial_expires_at')\r\n        .eq('auth_user_id', userId)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error getting trial status:', error);\r\n        return null;\r\n      }\r\n\r\n      const now = Date.now();\r\n      const trialExpiresAt = data.trial_expires_at ? new Date(data.trial_expires_at).getTime() : null;\r\n      const isActive = trialExpiresAt ? now < trialExpiresAt : false;\r\n      const daysRemaining = trialExpiresAt ? Math.ceil((trialExpiresAt - now) / (1000 * 60 * 60 * 24)) : 0;\r\n\r\n      return {\r\n        isEligible: !data.has_used_trial,\r\n        hasUsed: safeBoolean(data.has_used_trial),\r\n        isActive,\r\n        expiresAt: trialExpiresAt || undefined,\r\n        daysRemaining: isActive ? daysRemaining : undefined,\r\n      };\r\n    } catch (error) {\r\n      console.error('Error getting trial status:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async startTrial(userId: string): Promise<boolean> {\r\n    try {\r\n      const trialExpiresAt = new Date();\r\n      trialExpiresAt.setDate(trialExpiresAt.getDate() + 14);\r\n\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          has_used_trial: true,\r\n          trial_started_at: new Date().toISOString(),\r\n          trial_expires_at: trialExpiresAt.toISOString(),\r\n          tier: USER_TIERS.PRO,\r\n          text_limit: TIER_LIMITS[USER_TIERS.PRO].text,\r\n          image_limit: TIER_LIMITS[USER_TIERS.PRO].image,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error starting trial:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error starting trial:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Usage operations\r\n  async canMakeRequest(userId: string, requestType: 'text' | 'image'): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('text_count, image_count, text_limit, image_limit, tier')\r\n        .eq('auth_user_id', userId)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error checking usage:', error);\r\n        return false;\r\n      }\r\n\r\n      if (requestType === 'text') {\r\n        return safeNumber(data.text_count) < safeNumber(data.text_limit);\r\n      } else {\r\n        return safeNumber(data.image_count) < safeNumber(data.image_limit);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error checking usage:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async incrementUsage(userId: string, requestType: 'text' | 'image'): Promise<boolean> {\r\n    try {\r\n      // First, get the current usage data\r\n      const { data: userData, error: fetchError } = await supabase\r\n        .from('users')\r\n        .select('usage_data')\r\n        .eq('auth_user_id', userId)\r\n        .single();\r\n\r\n      if (fetchError) {\r\n        console.error('Error fetching user data:', fetchError);\r\n        return false;\r\n      }\r\n\r\n      // Get current usage counts\r\n      const currentUsage = jsonToRecord(userData?.usage_data) as { textCount?: number; imageCount?: number; totalRequests?: number };\r\n\r\n      // Increment the appropriate counter\r\n      const textCount = requestType === 'text' ? (currentUsage.textCount || 0) + 1 : (currentUsage.textCount || 0);\r\n      const imageCount = requestType === 'image' ? (currentUsage.imageCount || 0) + 1 : (currentUsage.imageCount || 0);\r\n      \r\n      const updatedUsage = {\r\n        textCount,\r\n        imageCount,\r\n        totalRequests: (currentUsage.totalRequests || 0) + 1,\r\n      };\r\n\r\n      // Update the usage_data JSONB field\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          usage_data: toJson(updatedUsage),\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error incrementing usage:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error incrementing usage:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async resetUsage(userId: string): Promise<boolean> {\r\n    try {\r\n      // Reset counters but preserve limits\r\n      const resetUsage = {\r\n        textCount: 0,\r\n        imageCount: 0,\r\n        totalRequests: 0,\r\n        lastReset: Date.now()\r\n      };\r\n\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          usage_data: toJson(resetUsage),\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error resetting usage:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error resetting usage:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // ‚úÖ Query-based usage tracking (replaces message-based limits)\r\n  async recordQuery(authUserId: string, queryType: 'text' | 'image'): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await supabase.rpc('increment_user_usage', {\r\n        p_auth_user_id: authUserId,\r\n        p_query_type: queryType,\r\n        p_increment: 1\r\n      });\r\n\r\n      if (error) {\r\n        console.error('Error recording query:', error);\r\n        return false;\r\n      }\r\n\r\n      return data === true;\r\n    } catch (error) {\r\n      console.error('Error recording query:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async getQueryUsage(authUserId: string): Promise<{ textCount: number; imageCount: number; textLimit: number; imageLimit: number; lastReset: Date } | null> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('text_count, image_count, text_limit, image_limit, last_reset')\r\n        .eq('auth_user_id', authUserId)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error getting query usage:', error);\r\n        return null;\r\n      }\r\n\r\n      return {\r\n        textCount: data.text_count || 0,\r\n        imageCount: data.image_count || 0,\r\n        textLimit: data.text_limit || 55,\r\n        imageLimit: data.image_limit || 25,\r\n        lastReset: new Date(data.last_reset || Date.now())\r\n      };\r\n    } catch (error) {\r\n      console.error('Error getting query usage:', error);\r\n      return null;\r\n    }\r\n  }\r\n}\r\n\r\nexport const supabaseService = SupabaseService.getInstance();\r\n"],"names":["jsonToRecord","value","toJson","obj","key","safeParseDate","defaultValue","safeString","safeNumber","safeBoolean","_AuthService","__publicField","cleanup","identifier","rateLimitData","cacheService","now","authUserId","user","cacheKey","session","supabase","localUser","error","toastService","authUser","provider","_a","_b","_c","uniqueEmail","_d","_e","_f","_g","_h","oauthProviders","parts","existingLoad","loadPromise","cachedUser","rpcData","rpcError","tableData","tableError","TIER_LIMITS","userData","createError","newState","previousState","listener","ErrorService","redirectUrl","data","errorMessage","email","password","isEmailConfirmationDisabled","keysToRemove","i","sessionError","profileData","index","AuthService","authService","_SupabaseService","userId","updates","usage","conv","conversation","conversationId","game","userIdData","userIdError","trialExpiresAt","isActive","daysRemaining","USER_TIERS","requestType","fetchError","currentUsage","textCount","imageCount","updatedUsage","resetUsage","queryType","SupabaseService","supabaseService"],"mappings":"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"}