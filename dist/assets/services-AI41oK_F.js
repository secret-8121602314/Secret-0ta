const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chat-services-C6NMpE6f.js","assets/ai-vendor-DDPwdD9r.js","assets/auth-Dr7R2Prf.js","assets/react-vendor-Caqaq3dM.js","assets/vendor-iWZt88IK.js","assets/markdown-vendor-PTyQapk7.js","assets/supabase-vendor-wc801gge.js","assets/core-services-DJXi_qrf.js"])))=>i.map(i=>d[i]);
var lt=Object.defineProperty;var ut=(o,e,t)=>e in o?lt(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var f=(o,e,t)=>ut(o,typeof e!="symbol"?e+"":e,t);import{s as d}from"./auth-Dr7R2Prf.js";import{n as dt,a as E,i as Fe,b as Ve,S as F,U as gt,T as Be,_ as We,F as ge}from"./chat-services-C6NMpE6f.js";import{b as Ee,c as Z,j as M,d as me,t as he,a as pe}from"./core-services-DJXi_qrf.js";class mt{constructor(){f(this,"memoryCache",new Map);f(this,"DEFAULT_TTL",300*1e3);f(this,"CACHE_TABLE","app_cache");f(this,"MAX_MEMORY_CACHE_SIZE",100);f(this,"pendingRequests",new Map)}async set(e,t,r=this.DEFAULT_TTL,s="general",a){const n=Date.now()+r;this.memoryCache.set(e,{value:t,expires:n});try{console.log(`[CacheService] Storing in Supabase: ${e} (type: ${s}, user: ${a||"none"})`);const{error:c}=await d.from(this.CACHE_TABLE).upsert({key:e,value:JSON.stringify(t),expires_at:new Date(n).toISOString(),updated_at:new Date().toISOString(),cache_type:s,user_id:a||null,size_bytes:JSON.stringify(t).length})}catch{}this.memoryCache.size>this.MAX_MEMORY_CACHE_SIZE&&this.cleanupMemoryCache()}async get(e,t=!1){if(this.pendingRequests.has(e))return await this.pendingRequests.get(e);const r=this.memoryCache.get(e);if(r&&Date.now()<=r.expires)return console.log(`[CacheService] Cache HIT (memory): ${e}`),r.value;if(r&&this.memoryCache.delete(e),t)return console.log(`[CacheService] Cache MISS (memory-only mode): ${e}`),null;const s=this.fetchFromSupabase(e);this.pendingRequests.set(e,s);try{return await s}finally{this.pendingRequests.delete(e)}}async fetchFromSupabase(e){try{console.log(`[CacheService] Cache MISS (memory), trying Supabase: ${e}`);const{data:t,error:r}=await d.from(this.CACHE_TABLE).select("value, expires_at").eq("key",e).maybeSingle();if(r)return null;if(!t)return console.log(`[CacheService] Cache MISS (Supabase): ${e}`),null;const s=new Date(t.expires_at).getTime();if(Date.now()>s)return console.log(`[CacheService] Cache EXPIRED (Supabase): ${e}`),await this.delete(e),null;console.log(`[CacheService] Cache HIT (Supabase): ${e}`);const a=JSON.parse(typeof t.value=="string"?t.value:"{}");return this.memoryCache.set(e,{value:a,expires:s}),a}catch{return null}}async has(e){return await this.get(e)!==null}async delete(e){const t=this.memoryCache.delete(e);try{const{error:r}=await d.from(this.CACHE_TABLE).delete().eq("key",e)}catch{}return t}async clear(){this.memoryCache.clear(),this.pendingRequests.clear();try{const{error:e}=await d.from(this.CACHE_TABLE).delete().neq("key","never_delete")}catch{}}async cleanup(){const e=Date.now();this.cleanupMemoryCache();try{const{error:t}=await d.from(this.CACHE_TABLE).delete().lt("expires_at",new Date(e).toISOString())}catch{}}cleanupMemoryCache(){const e=Date.now(),t=Array.from(this.memoryCache.entries());t.forEach(([r,s])=>{e>s.expires&&this.memoryCache.delete(r)}),this.memoryCache.size>this.MAX_MEMORY_CACHE_SIZE&&t.filter(([a])=>this.memoryCache.has(a)).sort((a,n)=>a[1].expires-n[1].expires).slice(0,this.memoryCache.size-this.MAX_MEMORY_CACHE_SIZE).forEach(([a])=>this.memoryCache.delete(a))}getStats(){return{memorySize:this.memoryCache.size,memoryKeys:Array.from(this.memoryCache.keys())}}async getSupabaseStats(){try{const{data:e,error:t}=await d.rpc("get_cache_stats");return t?null:e}catch{return null}}async getPerformanceMetrics(){try{const{data:e,error:t}=await d.rpc("get_cache_performance_metrics");return t?null:e}catch{return null}}async getUserCacheEntries(e){try{const{data:t,error:r}=await d.rpc("get_user_cache_entries",{p_user_id:e});return r?[]:t||[]}catch{return[]}}async clearUserCache(e){try{const{data:t,error:r}=await d.rpc("clear_user_cache",{p_user_id:e});return r?0:t||0}catch{return 0}}async setChatContext(e,t){await this.set(`chat_context:${e}`,t,2160*60*60*1e3,"context",e)}async getChatContext(e){return await this.get(`chat_context:${e}`)}async setUserMemory(e,t){await this.set(`user_memory:${e}`,t,365*24*60*60*1e3,"memory",e)}async getUserMemory(e){return await this.get(`user_memory:${e}`)}async setGameContext(e,t,r){await this.set(`game_context:${e}:${t}`,r,2160*60*60*1e3,"context",e)}async getGameContext(e,t){return await this.get(`game_context:${e}:${t}`)}async setUser(e,t){await this.set(`user:${e}`,t,365*24*60*60*1e3,"user",e)}async getUser(e){return await this.get(`user:${e}`)}async setRateLimit(e,t){await this.set(`rate_limit:${e}`,t,900*1e3,"rate_limit")}async getRateLimit(e){return await this.get(`rate_limit:${e}`)}async setConversation(e,t,r){await this.set(`conversation:${e}`,t,365*24*60*60*1e3,"conversation",r)}async getConversation(e){return await this.get(`conversation:${e}`)}async initializeCacheTable(){try{const{error:e}=await d.from(this.CACHE_TABLE).select("key").limit(1);e&&e.code}catch{}}}const C=new mt;C.initializeCacheTable().catch(()=>{});setInterval(()=>{C.cleanup()},300*1e3);class fe{static handle(e,t,r){this.errorCount++,!this.isErrorRateLimited()&&(console.error(`[${t}]`,{message:e.message,stack:e.stack,context:t,timestamp:new Date().toISOString(),errorCount:this.errorCount}),r&&this.showUserMessage(r),this.reportError(e,t))}static handleAuthError(e,t){const r=this.getAuthErrorMessage(t);this.handle(e,`AuthService:${t}`,r)}static handleWebSocketError(e,t){const r=this.getWebSocketErrorMessage(t);this.handle(e,`WebSocketService:${t}`,r)}static handleConversationError(e,t){const r=this.getConversationErrorMessage(t);this.handle(e,`ConversationService:${t}`,r)}static handleDatabaseError(e,t){const r=this.getDatabaseErrorMessage(t);this.handle(e,`DatabaseService:${t}`,r)}static isErrorRateLimited(){const e=Date.now();return this.recentErrors=this.recentErrors.filter(t=>e-t<this.errorWindow),this.recentErrors.push(e),this.recentErrors.length>this.maxErrorsPerMinute}static showUserMessage(e){}static reportError(e,t){console.warn("[Error Reporting] Would report error to monitoring service:",{error:e.message,context:t,timestamp:new Date().toISOString()})}static getAuthErrorMessage(e){return{signIn:"Failed to sign in. Please check your credentials and try again.",signOut:"Failed to sign out. Please try again.",loadUser:"Failed to load user data. Please refresh the page.",createUser:"Failed to create user account. Please try again.",refreshUser:"Failed to refresh user data. Please try again."}[e]||"An authentication error occurred. Please try again."}static getWebSocketErrorMessage(e){return{connect:"Failed to connect to server. Please check your internet connection.",send:"Failed to send message. Please try again.",disconnect:"Failed to disconnect. Please try again."}[e]||"A connection error occurred. Please try again."}static getConversationErrorMessage(e){return{create:"Failed to create conversation. Please try again.",load:"Failed to load conversations. Please refresh the page.",save:"Failed to save conversation. Please try again.",delete:"Failed to delete conversation. Please try again."}[e]||"A conversation error occurred. Please try again."}static getDatabaseErrorMessage(e){return{save:"Failed to save data. Please try again.",load:"Failed to load data. Please refresh the page.",update:"Failed to update data. Please try again.",delete:"Failed to delete data. Please try again."}[e]||"A database error occurred. Please try again."}static getStats(){return{totalErrors:this.errorCount,recentErrors:this.recentErrors.length,isRateLimited:this.isErrorRateLimited()}}static reset(){this.errorCount=0,this.recentErrors=[]}}f(fe,"errorCount",0),f(fe,"maxErrorsPerMinute",10),f(fe,"errorWindow",60*1e3),f(fe,"recentErrors",[]);class ht{constructor(){f(this,"toasts",[]);f(this,"listeners",new Set);f(this,"maxToasts",5)}subscribe(e){return this.listeners.add(e),e(this.toasts),()=>{this.listeners.delete(e)}}notify(){this.listeners.forEach(e=>e([...this.toasts]))}show(e,t="info",r={}){const s=`toast-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,a={id:s,message:e,type:t,duration:r.duration??this.getDefaultDuration(t),action:r.action,dismissible:r.dismissible??!0};return this.toasts.unshift(a),this.toasts.length>this.maxToasts&&(this.toasts=this.toasts.slice(0,this.maxToasts)),this.notify(),a.duration&&a.duration>0&&setTimeout(()=>this.dismiss(s),a.duration),s}success(e,t){return this.show(e,"success",{duration:3e3,...t})}error(e,t){return this.show(e,"error",{duration:7e3,dismissible:!0,...t})}warning(e,t){return this.show(e,"warning",{duration:5e3,...t})}info(e,t){return this.show(e,"info",{duration:4e3,...t})}dismiss(e){const t=this.toasts.findIndex(r=>r.id===e);t!==-1&&(this.toasts.splice(t,1),this.notify())}dismissAll(){this.toasts=[],this.notify()}getDefaultDuration(e){switch(e){case"success":return 3e3;case"error":return 7e3;case"warning":return 5e3;case"info":return 4e3;default:return 4e3}}loading(e){const t=this.show(e,"info",{duration:0,dismissible:!1});return()=>this.dismiss(t)}async promise(e,t){const r=this.loading(t.loading);try{const s=await e;r();const a=typeof t.success=="function"?t.success(s):t.success;return this.success(a),s}catch(s){r();const a=typeof t.error=="function"?t.error(s):t.error;throw this.error(a),s}}}const ee=new ht;let ae=!1;typeof window<"u"&&typeof document<"u"&&(document.addEventListener("visibilitychange",()=>{ae=document.hidden}),window.addEventListener("blur",()=>{ae=!0}),window.addEventListener("focus",()=>{document.hidden||(ae=!1)}));const pt=async(o,e="Otagon AI")=>{if(!(!ae&&!document.hidden)&&!(!("Notification"in window)||Notification.permission!=="granted"))try{const t=o.length>100?o.substring(0,97)+"...":o,r=new Notification(e,{body:t,icon:"/icon-192.png",badge:"/icon-192.png",tag:"otagon-ai-response",requireInteraction:!1,silent:!1});setTimeout(()=>r.close(),1e4),r.onclick=()=>{window.focus(),r.close()}}catch(t){console.error("Failed to show notification:",t)}},ft=()=>ae||document.hidden,Fr=Object.freeze(Object.defineProperty({__proto__:null,isScreenLockedOrHidden:ft,showAINotification:pt,toastService:ee},Symbol.toStringTag,{value:"Module"})),K=class K{constructor(){f(this,"currentSessionId",null);f(this,"sessionStartTime",null);f(this,"activityCount",0);f(this,"heartbeatInterval",null)}static getInstance(){return K.instance||(K.instance=new K),K.instance}async startSession(e,t){try{this.currentSessionId&&await this.endSession();const r={initialRoute:t,activityCount:0,deviceInfo:this.getDeviceInfo()},{data:s,error:a}=await d.from("user_sessions").insert({user_id:e,started_at:new Date().toISOString(),session_data:r}).select("id").single();return a?(console.error("Failed to start session:",a),null):(this.currentSessionId=s.id,this.sessionStartTime=Date.now(),this.activityCount=0,this.startHeartbeat(),this.currentSessionId)}catch(r){return console.error("Error starting session:",r),null}}async endSession(){if(!(!this.currentSessionId||!this.sessionStartTime))try{const e=Math.floor((Date.now()-this.sessionStartTime)/1e3),{error:t}=await d.from("user_sessions").update({ended_at:new Date().toISOString(),duration_seconds:e,session_data:{activityCount:this.activityCount,lastActivity:new Date().toISOString()}}).eq("id",this.currentSessionId);t?console.error("Failed to end session:",t):console.log(`‚úÖ Session ended: ${this.currentSessionId} (${e}s)`),this.stopHeartbeat(),this.currentSessionId=null,this.sessionStartTime=null,this.activityCount=0}catch(e){console.error("Error ending session:",e)}}trackActivity(e){this.currentSessionId&&(this.activityCount++,d.from("user_sessions").update({session_data:{activityCount:this.activityCount,lastActivity:new Date().toISOString(),lastActivityType:e}}).eq("id",this.currentSessionId).then(({error:t})=>{t&&console.error("Failed to track activity:",t)}))}async updateSessionData(e){if(this.currentSessionId)try{const{error:t}=await d.from("user_sessions").update({session_data:e}).eq("id",this.currentSessionId);t&&console.error("Failed to update session data:",t)}catch(t){console.error("Error updating session data:",t)}}getCurrentSessionId(){return this.currentSessionId}getSessionDuration(){return this.sessionStartTime?Math.floor((Date.now()-this.sessionStartTime)/1e3):0}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{this.trackActivity("heartbeat")},300*1e3)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}getDeviceInfo(){const{userAgent:e}=navigator,t=/Mobile|Android|iPhone|iPad/.test(e),r=/Tablet|iPad/.test(e);let s="desktop";return t&&!r&&(s="mobile"),r&&(s="tablet"),s}cleanup(){this.stopHeartbeat(),this.currentSessionId&&this.endSession().catch(console.error)}};f(K,"instance");let Ae=K;const St=Ae.getInstance();typeof window<"u"&&window.addEventListener("beforeunload",()=>{St.cleanup()});const Se=o=>o,j=class j{constructor(){}static getInstance(){return j.instance||(j.instance=new j),j.instance}async getOnboardingStatus(e){try{const{data:t,error:r}=await d.rpc("get_user_onboarding_status",{p_user_id:e});if(r)return console.error("üéØ [OnboardingService] Error getting onboarding status:",r),null;if(!t||t.length===0)return null;const s=t[0];return console.log("üéØ [OnboardingService] Onboarding status (first element):",s),s}catch(t){return console.error("üéØ [OnboardingService] Error getting onboarding status:",t),null}}async updateOnboardingStatus(e,t,r={}){try{const{error:s}=await d.rpc("update_user_onboarding_status",{p_user_id:e,p_step:t,p_data:Se(r)});return s?(console.error("Error updating onboarding status:",s),!1):!0}catch(s){return console.error("Error updating onboarding status:",s),!1}}async getOnboardingProgress(e){try{const{data:t,error:r}=await d.from("onboarding_progress").select("*").eq("user_id",e).order("completed_at",{ascending:!0});return r?(console.error("Error getting onboarding progress:",r),[]):(t||[]).map(s=>({step:s.step,completed_at:s.created_at||"",data:typeof s.data=="object"&&s.data!==null&&!Array.isArray(s.data)?s.data:{}}))}catch(t){return console.error("Error getting onboarding progress:",t),[]}}async markSplashScreensSeen(e){return this.updateOnboardingStatus(e,"initial",{splash_screens_seen:!0,timestamp:new Date().toISOString()})}async markProfileSetupComplete(e,t){try{const{error:r}=await d.from("users").update({has_profile_setup:!0,profile_data:Se(t),updated_at:new Date().toISOString()}).eq("auth_user_id",e);return r?(console.error("Error marking profile setup complete:",r),!1):!0}catch(r){return console.error("Error marking profile setup complete:",r),!1}}async markWelcomeMessageShown(e){return this.updateOnboardingStatus(e,"complete",{welcome_message_shown:!0,timestamp:new Date().toISOString()})}async markOnboardingComplete(e){return this.updateOnboardingStatus(e,"complete",{onboarding_complete:!0,timestamp:new Date().toISOString()})}getBooleanValue(e,t=!1){return e==null?t:!!e}getNextOnboardingStepFromUser(e){const t=this.getBooleanValue(e.hasSeenSplashScreens),r=this.getBooleanValue(e.hasSeenHowToUse),s=this.getBooleanValue(e.hasSeenFeaturesConnected),a=this.getBooleanValue(e.hasSeenProFeatures),n=this.getBooleanValue(e.pcConnected),c=this.getBooleanValue(e.pcConnectionSkipped);return t?t&&!r?"how-to-use":r&&n&&!s?"features-connected":r&&!n&&c&&!a?"pro-features":r&&!n&&!c?"how-to-use":s&&!a?"pro-features":a?"complete":(console.error("üéØ [OnboardingService] ERROR: Unexpected onboarding flow state",{hasSeenSplashScreens:t,hasSeenHowToUse:r,hasSeenFeaturesConnected:s,hasSeenProFeatures:a,pcConnected:n,pcConnectionSkipped:c}),"how-to-use"):"initial"}async getNextOnboardingStep(e){try{const t=await this.getOnboardingStatus(e);if(!t)return"login";const r=this.getBooleanValue(t.has_seen_splash_screens),s=this.getBooleanValue(t.has_seen_how_to_use),a=this.getBooleanValue(t.has_seen_features_connected),n=this.getBooleanValue(t.has_seen_pro_features),c=this.getBooleanValue(t.pc_connected),i=this.getBooleanValue(t.pc_connection_skipped);return r?r&&!s?"how-to-use":s&&c&&!a?"features-connected":s&&!c&&i&&!n?"pro-features":s&&!c&&!i?"how-to-use":a&&!n?"pro-features":n?"complete":(console.error("üéØ [OnboardingService] ERROR: Unexpected onboarding flow state",{hasSeenSplashScreens:r,hasSeenHowToUse:s,hasSeenFeaturesConnected:a,hasSeenProFeatures:n,pcConnected:c,pcConnectionSkipped:i}),"how-to-use"):"initial"}catch(t){return console.error("üéØ [OnboardingService] Error getting next onboarding step:",t),"login"}}async shouldShowOnboarding(e){try{const t=await this.getOnboardingStatus(e);return t?!t.onboarding_completed:!0}catch(t){return console.error("Error checking if should show onboarding:",t),!0}}async trackOnboardingStep(e,t,r,s={}){try{await d.from("user_analytics").insert({user_id:e,auth_user_id:e,event_type:"onboarding_step",event_data:Se({step:t,action:r,data:s,timestamp:new Date().toISOString()})})}catch(a){console.error("Error tracking onboarding step:",a)}}async trackOnboardingDropOff(e,t,r,s={}){try{await d.from("user_analytics").insert({user_id:e,auth_user_id:e,event_type:"onboarding_dropoff",event_data:Se({step:t,reason:r,data:s,timestamp:new Date().toISOString()})})}catch(a){console.error("Error tracking onboarding dropoff:",a)}}async resetOnboarding(e){try{const{error:t}=await d.from("onboarding_progress").delete().eq("user_id",e);if(t)return console.error("Error clearing onboarding progress:",t),!1;const{error:r}=await d.from("users").update({is_new_user:!0,has_seen_splash_screens:!1,has_profile_setup:!1,has_welcome_message:!1,onboarding_completed:!1,onboarding_data:{}}).eq("id",e);return r?(console.error("Error resetting user onboarding flags:",r),!1):!0}catch(t){return console.error("Error resetting onboarding:",t),!1}}async getOnboardingStats(){try{const{count:e}=await d.from("users").select("*",{count:"exact",head:!0}),{count:t}=await d.from("users").select("*",{count:"exact",head:!0}).eq("onboarding_completed",!0),{data:r}=await d.from("user_analytics").select("event_data").eq("event_type","onboarding_dropoff"),s={};return r&&r.forEach(a=>{const n=a.event_data;if(typeof n=="object"&&n!==null&&!Array.isArray(n)){const c=n.step;typeof c=="string"&&(s[c]=(s[c]||0)+1)}}),{total_users:e||0,completed_onboarding:t||0,dropoff_by_step:s}}catch(e){return console.error("Error getting onboarding stats:",e),{total_users:0,completed_onboarding:0,dropoff_by_step:{}}}}};f(j,"instance");let Ce=j;const yt=Ce.getInstance(),Br=Object.freeze(Object.defineProperty({__proto__:null,onboardingService:yt},Symbol.toStringTag,{value:"Module"}));let w=null;const bt="wss://otakon-relay.onrender.com";let re=0;const _t=5e3,Oe=[];let _e=null,_=null,P=null,ve=!0;const vt=3e4,wt=(o,e,t,r,s)=>{if(w&&(w.readyState===WebSocket.OPEN||w.readyState===WebSocket.CONNECTING))return;if(!/^\d{6}$/.test(o)){const n="Invalid code format. Please enter a 6-digit code.";r(n),ee.error(n);return}_e=o,_={onOpen:e,onMessage:t,onError:r,onClose:s},ve=!0;const a=`${bt}/${o}`;try{w=new WebSocket(a)}catch(n){const i=`Connection failed: ${n instanceof Error?n.message:"An unknown error occurred."}. Please check the URL and your network connection.`;r(i),ee.error("PC connection failed. Please check your network and try again.");return}w.onopen=()=>{console.log("üîó [WebSocket] Connection opened successfully to",a),re=0,_&&typeof _.onOpen=="function"&&_.onOpen();try{w==null||w.send(JSON.stringify({type:"connection_request",code:o,ts:Date.now()})),console.log("üîó [WebSocket] Sent connection_request with code:",o)}catch(n){console.error("üîó [WebSocket] Failed to send connection_request:",n)}for(;Oe.length&&w&&w.readyState===WebSocket.OPEN;){const n=Oe.shift();try{w.send(JSON.stringify(n)),console.log("üîó [WebSocket] Sent queued message:",n==null?void 0:n.type)}catch(c){console.error("üîó [WebSocket] Failed to send queued message:",c)}}P&&(clearInterval(P),P=null),P=window.setInterval(()=>{if(w&&w.readyState===WebSocket.OPEN)try{w.send(JSON.stringify({type:"ping",ts:Date.now()}))}catch{}},vt)},w.onmessage=n=>{var c;try{const i=JSON.parse(n.data);if(console.log("üîó [WebSocket] Message received:",{type:i.type||"unknown",hasDataUrl:!!i.dataUrl,dataUrlLength:(c=i.dataUrl)==null?void 0:c.length,keys:Object.keys(i)}),i.type==="error"||i.error){const l=i.message||i.error||"Connection failed";console.error("üîó [WebSocket] Server error:",l),localStorage.removeItem("otakon_connection_code"),localStorage.removeItem("otakon_last_connection"),_&&typeof _.onError=="function"&&_.onError(l);return}if(i.type==="no_partner"||i.type==="partner_not_found"||i.type==="invalid_code"){const l="No PC client found with this code. Please check the code and ensure the PC client is running.";console.error("üîó [WebSocket] No partner found:",i),localStorage.removeItem("otakon_connection_code"),localStorage.removeItem("otakon_last_connection"),_&&typeof _.onError=="function"&&_.onError(l);return}if((i.type==="partner_disconnected"||i.type==="partner_left"||i.type==="peer_disconnected")&&console.log("üîó [WebSocket] Partner disconnected - PC app closed or lost connection"),(i.type==="screenshot_success"||i.type==="screenshot_batch"||i.type==="screenshot")&&console.log("üîó [WebSocket] Full screenshot message:",JSON.stringify(i).substring(0,500)),_&&typeof _.onMessage=="function"){console.log("üîó [WebSocket] Invoking onMessage handler with data:",i.type);try{_.onMessage(i),console.log("üîó [WebSocket] Handler completed successfully")}catch(l){console.error("üîó [WebSocket] Handler threw error:",l)}}else console.error("üîó [WebSocket] No valid onMessage handler!",_)}catch(i){console.error("üîó [WebSocket] Failed to parse message:",n.data,i)}},w.onerror=()=>{},w.onclose=n=>{if(console.log("üîó [WebSocket] Connection closed:",{wasClean:n.wasClean,code:n.code,reason:n.reason}),!n.wasClean){let c="Connection closed unexpectedly.";n.code===1006?(c="Connection to the server failed. Please check your network, verify the code, and ensure the PC client is running.",re===0&&ee.warning("PC connection lost. Attempting to reconnect...")):n.reason&&(c=`Connection closed: ${n.reason}`),_&&typeof _.onError=="function"&&_.onError(c)}if(w=null,_&&typeof _.onClose=="function"&&_.onClose(),P&&(clearInterval(P),P=null),ve&&_e&&_){re+=1;const c=Math.min(_t,500*Math.pow(2,re-1)),i=Math.random()*300,l=c+i;setTimeout(()=>{!w&&_&&ve&&wt(_e,_.onOpen,_.onMessage,_.onError,_.onClose)},l)}}},Wr=o=>{w&&w.readyState===WebSocket.OPEN?w.send(JSON.stringify(o)):Oe.push(o)},qr=()=>{ve=!1,w&&(w.close(1e3,"User disconnected"),w=null),re=0,P&&(clearInterval(P),P=null),_e=null,_=null},Hr=(o,e,t,r)=>{_={onOpen:o,onMessage:e,onError:t,onClose:r},console.log("üîó [WebSocket] Handlers updated")};class Kr{static async addToWaitlist(e,t="landing_page"){try{const{data:r,error:s}=await d.from("waitlist").insert({email:e,source:t,status:"pending"}).select();if(s){if(console.error("Error adding to waitlist:",s),console.error("Insert error details:",{message:s.message,code:s.code,details:s.details,hint:s.hint}),s.code==="23505")return{success:!0,alreadyExists:!0,error:"You're already on our waitlist! We'll email you when access is ready."};const{data:a,error:n}=await d.from("waitlist").select("email, status, created_at").eq("email",e).maybeSingle();return n?(console.error("Error checking existing email:",n),{success:!1,error:`Failed to add to waitlist: ${s.message}`}):a?{success:!0,alreadyExists:!0,error:"You're already on our waitlist! We'll email you when access is ready."}:{success:!1,error:`Failed to add to waitlist: ${s.message}`}}return{success:!0,alreadyExists:!1,error:void 0}}catch(r){return console.error("Waitlist service error:",r),{success:!1,error:"An unexpected error occurred"}}}static async getWaitlistCount(){try{const{count:e,error:t}=await d.from("waitlist").select("*",{count:"exact",head:!0});return t?(console.error("Error getting waitlist count:",t),{error:"Failed to get count"}):{count:e||0}}catch(e){return console.error("Error getting waitlist count:",e),{error:"Failed to get count"}}}static async getWaitlistStats(){try{const{data:e,error:t}=await d.from("waitlist").select("status");if(t)return console.error("Error fetching waitlist stats:",t),{total:137,pending:137,invited:0,converted:0};const r={total:e.length,pending:0,invited:0,converted:0};return e.forEach(s=>{const a=s.status||"pending";a==="pending"?r.pending++:a==="approved"?r.invited++:a==="rejected"&&r.converted++}),r}catch(e){return console.error("Error fetching waitlist stats:",e),{total:137,pending:137,invited:0,converted:0}}}}class B{static get(e,t){try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch(r){return console.error(`Error getting ${e} from localStorage:`,r),t}}static set(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error(`Error setting ${e} in localStorage:`,r)}}static remove(e){try{localStorage.removeItem(e)}catch(t){console.error(`Error removing ${e} from localStorage:`,t)}}static clear(){try{localStorage.clear()}catch(e){console.error("Error clearing localStorage:",e)}}}class Tt{constructor(){f(this,"CONVERSATION_TTL",720*60*60*1e3);f(this,"CONTEXT_TTL",1440*60*1e3)}async saveConversation(e,t){const r=`conversation:${e.id}`;await C.set(r,e,this.CONVERSATION_TTL,"conversation",t)}async loadConversation(e){const t=`conversation:${e}`;return await C.get(t)}async saveChatContext(e,t){await C.setChatContext(e,t)}async loadChatContext(e){return await C.getChatContext(e)}async saveUserMemory(e,t){await C.setUserMemory(e,t)}async loadUserMemory(e){return await C.getUserMemory(e)}async saveConversationSummary(e,t){const r=`conversation_summary:${e}`;await C.set(r,t,this.CONTEXT_TTL)}async loadConversationSummary(e){const t=`conversation_summary:${e}`;return await C.get(t)}async saveGameContext(e,t,r){await C.setGameContext(e,t,r)}async loadGameContext(e,t){return await C.getGameContext(e,t)}async getUserConversations(e){return[]}async clearUserChatData(e){await C.clearUserCache(e)}}const Et=new Tt,ye=new Map,ie=new Map,At=1800*1e3,Je="otagon_igdb_cache",Ie=1440*60*1e3,Xe="otagon_cover_urls";function Ct(){try{const o=localStorage.getItem(Je);if(o){const e=JSON.parse(o);if(e.version===1&&Date.now()-e.timestamp<Ie){for(const[t,r]of Object.entries(e.games))Date.now()-r.timestamp<Ie&&ie.set(t,r);console.log("[IGDBService] Loaded",ie.size,"games from localStorage cache")}}}catch(o){console.warn("[IGDBService] Error loading localStorage cache:",o)}}function Ot(){try{const o={};ie.forEach((t,r)=>{o[r]=t});const e={version:1,timestamp:Date.now(),games:o};localStorage.setItem(Je,JSON.stringify(e))}catch(o){console.warn("[IGDBService] Error saving localStorage cache:",o)}}function It(){try{const o=localStorage.getItem(Xe);if(o){const e=JSON.parse(o);if(e.version===1&&Date.now()-e.timestamp<Ie)return console.log("[IGDBService] Loaded",Object.keys(e.urls).length,"cover URLs from localStorage"),new Map(Object.entries(e.urls))}}catch(o){console.warn("[IGDBService] Error loading cover URL cache:",o)}return new Map}function Ze(o){try{const e={version:1,timestamp:Date.now(),urls:Object.fromEntries(o)};localStorage.setItem(Xe,JSON.stringify(e))}catch(e){console.warn("[IGDBService] Error saving cover URL cache:",e)}}Ct();const oe=It();function Ge(o,e="cover_small"){if(!o)return;let t=o;return t=t.replace(/t_(thumb|cover_small|cover_big|720p|1080p|screenshot_huge)/g,`t_${e}`),t.startsWith("//")?t="https:"+t:t.startsWith("http")||(t="https://"+t),t}function jr(o){var e;if((e=o==null?void 0:o.cover)!=null&&e.url)return Ge(o.cover.url,"cover_small")}async function Rt(o){if(!o||o.trim().length===0)return console.warn("[IGDBService] Empty game name provided"),null;const e=o.toLowerCase().trim(),t=ie.get(e);if(t&&Date.now()-t.timestamp<At)return console.log("[IGDBService] Session cache hit:",o),t.data;if(ye.has(e))return console.log("[IGDBService] Waiting for pending request:",o),ye.get(e);const r=(async()=>{var s,a,n;try{console.log("[IGDBService] Fetching game data:",o);const{data:{session:c}}=await d.auth.getSession(),i={"Content-Type":"application/json"};c!=null&&c.access_token&&(i.Authorization=`Bearer ${c.access_token}`),console.log("[IGDBService] Invoking igdb-proxy with gameName:",o);const l=await d.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:o}),headers:i});if(l.error){console.error("[IGDBService] Edge function error:",l.error);const h=l.error;return((s=h==null?void 0:h.message)!=null&&s.includes("IGDB_NOT_CONFIGURED")||(a=h==null?void 0:h.message)!=null&&a.includes("503"))&&console.warn("[IGDBService] IGDB service not configured - game data will not be available"),null}const u=l.data;if((u==null?void 0:u.code)==="IGDB_NOT_CONFIGURED")return console.warn("[IGDBService] IGDB service not configured on server"),null;if(!u.success||!u.data)return console.log("[IGDBService] No data found for:",o),null;const m=u.data;if(ie.set(e,{data:m,timestamp:Date.now()}),Ot(),(n=m.cover)!=null&&n.url){const h=Ge(m.cover.url,"cover_small");h&&(oe.set(e,h),Ze(oe),console.log("[IGDBService] Saved cover URL to cache:",e))}return console.log("[IGDBService] Successfully fetched:",m.name,u.cached?"(cached)":"(fresh)"),m}catch(c){return console.error("[IGDBService] Error fetching game data:",c),null}finally{ye.delete(e)}})();return ye.set(e,r),r}async function zr(o){return Rt(`id:${o}`)}function Yr(o,e="high"){return`https://img.youtube.com/vi/${o}/${{default:"default",medium:"mqdefault",high:"hqdefault",maxres:"maxresdefault"}[e]}.jpg`}function Vr(o){return{1:"Official",2:"Wikia",3:"Wikipedia",4:"Facebook",5:"Twitter",6:"Twitch",8:"Instagram",9:"YouTube",10:"iPhone",11:"iPad",12:"Android",13:"Steam",14:"Reddit",15:"Itch.io",16:"Epic Games",17:"GOG",18:"Discord"}[o]||"Website"}function Jr(o,e){return o===1?{6:"RP (Rating Pending)",7:"EC (Early Childhood)",8:"E (Everyone)",9:"E10+ (Everyone 10+)",10:"T (Teen)",11:"M (Mature 17+)",12:"AO (Adults Only)"}[e]||"Not Rated":o===2&&{1:"PEGI 3",2:"PEGI 7",3:"PEGI 12",4:"PEGI 16",5:"PEGI 18"}[e]||"Not Rated"}function Xr(o){return o?new Date(o*1e3).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"TBA"}function Zr(o){return o?o.filter(e=>e.developer).map(e=>e.company.name):[]}function Qr(o){return o?o.filter(e=>e.publisher).map(e=>e.company.name):[]}function es(o){return o.total_rating??o.aggregated_rating??o.rating??null}async function ts(o){var s;const e=new Map;if(o.length===0)return e;const t=o.map(a=>a.toLowerCase().trim()),r=[];for(const a of t){const n=oe.get(a);n?e.set(a,n):r.push(a)}if(r.length===0)return console.log("[IGDBService] All cover URLs from localStorage cache:",e.size),e;try{const{data:a,error:n}=await d.from("igdb_game_cache").select("game_name_key, game_data").in("game_name_key",r).gt("expires_at",new Date().toISOString());if(n)return console.warn("[IGDBService] Error fetching cover URLs from cache:",n.message),e;if(a){for(const c of a){const i=c.game_data;if((s=i==null?void 0:i.cover)!=null&&s.url){const l=Ge(i.cover.url,"cover_small");l&&(e.set(c.game_name_key,l),oe.set(c.game_name_key,l))}}Ze(oe)}console.log("[IGDBService] Fetched cover URLs:",e.size,"of",o.length,"(",e.size-r.length+((a==null?void 0:a.length)??0),"from localStorage,",(a==null?void 0:a.length)||0,"from Supabase)")}catch(a){console.warn("[IGDBService] Error in fetchCoverUrlsFromCache:",a)}return e}const rs=o=>{const e=new Map;let t=o.replace(/\\\*/g,"*");t=t.replace(/\*\*\s*Hint\s*:\*\*\s*/gi,`

Hint:
`),t=t.replace(/\*\*\s*Lore\s*:\*\*\s*/gi,`

Lore:
`),t=t.replace(/\*\*\s*Places\s+of\s+Interest\s*:\*\*\s*/gi,`

Places of Interest:
`),t=t.replace(/\*\*\s*Strategy\s*:\*\*\s*/gi,`

Strategy:
`),t=t.replace(/\*\*\s*What\s+to\s+focus\s+on\s*:\*\*\s*/gi,`

What to focus on:
`),t=t.replace(/\n\*\*\s*Hint\s*:\s*\n/gi,`

Hint:
`),t=t.replace(/\n\*\*\s*Lore\s*:\s*\n/gi,`

Lore:
`),t=t.replace(/\n\*\*\s*Places\s+of\s+Interest\s*:\s*\n/gi,`

Places of Interest:
`),t=t.replace(/\n\*\*\s*Strategy\s*:\s*\n/gi,`

Strategy:
`),t=t.replace(/\n\*\*\s*What\s+to\s+focus\s+on\s*:\s*\n/gi,`

What to focus on:
`),t=t.replace(/^\*\*\s*Hint\s*:\s*\**\s*$/gim,"Hint:"),t=t.replace(/^\*\*\s*Lore\s*:\s*\**\s*$/gim,"Lore:"),t=t.replace(/^\*\*\s*Places\s+of\s+Interest\s*:\s*\**\s*$/gim,"Places of Interest:"),t=t.replace(/^\*\*\s*Strategy\s*:\s*\**\s*$/gim,"Strategy:"),t=t.replace(/^\*\*\s*What\s+to\s+focus\s+on\s*:\s*\**\s*$/gim,"What to focus on:"),t=t.replace(/\*\*\s+([^*]+?)\*\*/g,"**$1**"),t=t.replace(/\*\*([^*]+?)\s+\*\*/g,"**$1**"),t=t.replace(/\*\*\s*([A-Za-z ]+?)\s*:\s*\*\*/g,"**$1:**"),t=t.replace(/\*\*([^*\n]+)\n\*\*/g,`**$1**
`),t=t.replace(/###\s*\*\*\s*/g,"### "),t=t.replace(/##\s*\*\*\s*/g,"## "),t=t.replace(/^\*\*\s*$/gm,""),t=t.replace(/\n\*\*\s*\n/g,`

`),t=t.replace(/\*\*\s+Release\s+Date\s*:\s*\*\*/gi,"**Release Date:**"),t=t.replace(/\*\*\s+The\s+Verdict\s*:\s*\*\*/gi,"**The Verdict:**"),t=t.replace(/\*\*\s+Key\s+Features\s*:\s*\*\*/gi,"**Key Features:**"),(t.match(/\*\*/g)||[]).length%2!==0&&(t=t.replace(/\*\*\s*$/g,""),t=t.replace(/^\s*\*\*/g,"")),console.log(`üè∑Ô∏è [otakonTags] Parsing response (${o.length} chars)...`),["Hint","Lore","Places of Interest"].forEach(p=>{if(o.includes(p)){const g=o.substring(Math.max(0,o.indexOf(p)-10),o.indexOf(p)+p.length+20);console.log(`üîç [otakonTags] Found "${p}" pattern: "${g}"`)}});const a=/\[OTAKON_SUGGESTIONS:\s*(\[[\s\S]*?\])\s*\]/g;let n;for(;(n=a.exec(o))!==null;)try{const p=n[1].replace(/'/g,'"'),g=JSON.parse(p);e.set("SUGGESTIONS",g),t=t.replace(n[0],""),console.log("üè∑Ô∏è [otakonTags] Extracted SUGGESTIONS:",g)}catch{console.warn("[OtakonTags] Failed to parse SUGGESTIONS JSON:",n[1])}const c=/\[OTAKON_SUBTAB_UPDATE:\s*(\{[\s\S]*?\})\s*\]/g;let i;const l=[];for(;(i=c.exec(o))!==null;)try{const p=JSON.parse(i[1]);l.push(p),t=t.replace(i[0],"")}catch{console.warn("[OtakonTags] Failed to parse SUBTAB_UPDATE JSON:",i[1])}l.length>0&&e.set("SUBTAB_UPDATE",l);const u=/\[OTAKON_([A-Z_]+):\s*([^\[\]]+?)\]/g;let m,h=null;const T=o.match(/\[OTAKON_PROGRESS[:\s]+(\d+)/i);if(T&&(h=parseInt(T[1],10),console.log(`üìä [otakonTags] Found OTAKON_PROGRESS format: ${T[0]} ‚Üí ${h}%`)),!h){const p=o.match(/\[?PROGRESS[:\s]+(\d+)/i);p&&(h=parseInt(p[1],10),console.log(`üìä [otakonTags] Found PROGRESS format: ${p[0]} ‚Üí ${h}%`))}if(!h){const p=o.match(/(?:progress|completion|game progress)[:\s]+(?:approximately\s+)?(\d+)\s*%/i);p&&(h=parseInt(p[1],10),console.log(`üìä [otakonTags] Found inline progress format: ${p[0]} ‚Üí ${h}%`))}if(!h){const p=o.match(/"stateUpdateTags"[^}]*"PROGRESS[:\s]+(\d+)/i);p&&(h=parseInt(p[1],10),console.log(`üìä [otakonTags] Found stateUpdateTags PROGRESS: ${p[0]} ‚Üí ${h}%`))}for(h!==null&&h>=0&&h<=100?(e.set("PROGRESS",h),console.log(`üìä [otakonTags] ‚úÖ Set PROGRESS tag to: ${h}%`)):console.log("üìä [otakonTags] ‚ö†Ô∏è No valid progress found in response");(m=u.exec(o))!==null;){const p=m[1];let g=m[2].trim();if(console.log(`üè∑Ô∏è [otakonTags] Found tag: ${p} = ${m[2].substring(0,50)}`),!(p==="SUGGESTIONS"||p==="SUBTAB_UPDATE")){try{const v=g;v.startsWith("{")&&v.endsWith("}")&&(g=JSON.parse(v)),v.startsWith("[")&&v.endsWith("]")&&(g=JSON.parse(v.replace(/'/g,'"')))}catch{}if(p==="PROGRESS"){const v=String(g).trim(),O=v.match(/(\d+)/);if(O){const N=parseInt(O[1],10);g=Math.min(100,Math.max(0,N)),console.log(`üìä [otakonTags] Parsed PROGRESS: "${v}" ‚Üí ${g}`)}else console.warn(`üìä [otakonTags] Could not parse PROGRESS value: "${v}"`)}e.set(p,g),t=t.replace(m[0],"")}}t=t.replace(/\[OTAKON_[A-Z_]+:[^\]]*\]/g,"").replace(/^["'][^"']*\?["']\s*,?\s*/gm,"").replace(/^["'](?:and\s+)?\[\d+\][^"']*\?["']\s*,?\s*/gim,"").replace(/^["'][^"']*\?["']\s*\]\s*/gm,"").replace(/^[^"']*\?["']\s*\]\s*/gm,"").replace(/^(?:["'][^"']*["']\s*,?\s*)+\]/g,"");const L=["Hint","Lore","Places of Interest","Strategy","What to focus on"];for(const p of L){const g=p.replace(/ /g,"\\s+"),v=new RegExp(`\\*+\\s*${g}(?:\\s*[:\\*]+\\s*:?|\\s*:)\\s*\\**|\\*\\*\\s*${g}\\s*\\*\\*|\\*\\*\\s+${g}(?![:\\w*])`,"gi");t=t.replace(v,`

${p}:
`),t=t.replace(new RegExp(`(?:^|\\n)\\s*${g}:\\s*`,"gi"),`

${p}:
`)}t=t.replace(/:{2,}/g,":"),t=t.replace(/\*\*\s+([^*\n]+?)\*\*/g,"**$1**").replace(/\*\*([^*\n]+?)\s+\*\*/g,"**$1**");for(const p of L){const g=p.replace(/ /g,"\\s+");t=t.replace(new RegExp(`([.!?\\w])([\\s\\n]*)${g}:\\s*`,"gi"),`$1$2

**${p}:**

`),t=t.replace(new RegExp(`^\\s*${g}:\\s*`,"i"),`**${p}:**

`),t=t.replace(new RegExp(`\\n\\s*${g}:\\s*`,"gi"),`

**${p}:**

`)}return console.log(`üîç [otakonTags] After Phase 3 - Hint bold: ${t.includes("**Hint:**")}, Lore bold: ${t.includes("**Lore:**")}, Places bold: ${t.includes("**Places of Interest:**")}`),t=t.replace(/^\s*\*\*\s*$/gm,"").replace(/^\*\*\s*\n/gm,`
`).replace(/([a-z])\*\*\s+([A-Z])/g,"$1 $2").replace(/([^:])\*\*\s*$/gm,"$1").replace(/^Hint:\s*\n\s*Hint:\s*/gm,`**Hint:**

`).replace(/\]\s*$/gm,"").replace(/^\s*\]/gm,"").replace(/\[\s*$/gm,"").replace(/^\s*\[/gm,"").replace(/\s+\]\s+/g," ").replace(/\s+\[\s+/g," ").replace(/\.\s*(\d+\.\s*\*\*)/g,`.

$1`).replace(/\.\s*(\d+\.\s+[A-Z])/g,`.

$1`).replace(/^(\d+)\.([A-Z])/gm,"$1. $2").replace(/([^htfps*]):([A-Z])/g,"$1: $2"),t=t.replace(/\*\*([^*]+)\*\*([A-Za-z])/g,"**$1** $2").replace(/([a-z])\*\*([A-Z])/g,"$1 **$2").replace(/([a-z])([A-Z][a-z]{2,})/g,(p,g,v)=>["PlayStation","GamePass","GameStop","YouTube","OpenWorld"].some(N=>(g+v).includes(N))?p:g+" "+v).replace(/\b(like|or|and|the|a|an|for|with|from|to|in|on|at|by|as)([A-Z])/g,"$1 $2"),t=t.replace(/\*\*\s*\*\*/g,"").replace(/\n{3,}/g,`

`).replace(/^\s+|\s+$/g,"").trim(),t=t.replace(/\*\*\s+(Hint|Lore|Strategy):\*\*/gi,"**$1:**").replace(/\*\*\s+Places\s+of\s+Interest:\*\*/gi,"**Places of Interest:**").replace(/\*\*\s+What\s+to\s+focus\s+on:\*\*/gi,"**What to focus on:**"),e.size>0&&console.log(`üè∑Ô∏è [otakonTags] Extracted ${e.size} tags:`,Array.from(e.keys()).join(", ")),{cleanContent:t,tags:e}},z=class z{static getInstance(){return z.instance||(z.instance=new z),z.instance}generateCacheKey(e,t){var n;const r={prompt:e.trim().toLowerCase(),gameTitle:(n=t.gameTitle)==null?void 0:n.toLowerCase(),mode:t.mode},s=JSON.stringify(r);let a=0;for(let c=0;c<s.length;c++){const i=s.charCodeAt(c);a=(a<<5)-a+i,a=a&a}return Math.abs(a).toString(36)}async getCachedResponse(e){try{const{data:t,error:r}=await d.from("ai_responses").select("response_data, created_at, model_used, tokens_used, cache_type").eq("cache_key",e).gt("expires_at",new Date().toISOString()).single();if(r)return r.code==="PGRST116"?(console.log("‚ùå [aiCacheService] Cache MISS:",e.substring(0,8)),null):(console.error("‚ùå [aiCacheService] Error checking cache:",r),null);if(t){const s=t.created_at?Math.floor((Date.now()-new Date(t.created_at).getTime())/1e3/60):0;return console.log("‚úÖ [aiCacheService] Cache HIT:",e.substring(0,8),{age:`${s}m`,model:t.model_used,tokens:t.tokens_used,type:t.cache_type}),t.response_data}return null}catch(t){return console.error("Error in getCachedResponse:",t),null}}async cacheResponse(e,t,r){try{const s=new Date;s.setHours(s.getHours()+r.ttlHours);const{data:{user:a}}=await d.auth.getUser(),{error:n}=await d.from("ai_responses").upsert({cache_key:e,response_data:JSON.parse(JSON.stringify(t)),game_title:r.gameTitle,cache_type:r.cacheType,conversation_id:r.conversationId,model_used:r.modelUsed,tokens_used:r.tokensUsed,user_id:a==null?void 0:a.id,expires_at:s.toISOString(),created_at:new Date().toISOString()},{onConflict:"cache_key"});return n?(console.error("Error caching response:",n),!1):(console.log("üíæ Cached response:",e.substring(0,8),{type:r.cacheType,ttl:r.ttlHours+"h",tokens:r.tokensUsed,game:r.gameTitle}),!0)}catch(s){return console.error("Error in cacheResponse:",s),!1}}determineCacheType(e){return e.gameTitle?"game_specific":e.hasUserContext||e.conversationId?"user":"global"}determineTTL(e,t){switch(e){case"global":return 168;case"game_specific":return 24;case"user":return 12;default:return 24}}shouldCache(e,t){if(console.log(`üîç [aiCacheService] shouldCache called with prompt: "${e.substring(0,50)}..."`,t),t.noCache===!0)return!1;if(e.trim().length<10)return console.log(`‚ùå [aiCacheService] Not caching: prompt too short (${e.trim().length} chars)`),!1;const r=["today","now","current","latest","recent","just released"],s=e.toLowerCase();return!r.find(n=>s.includes(n))}async cleanupExpiredCache(){try{const{data:e,error:t}=await d.from("ai_responses").delete().lt("expires_at",new Date().toISOString()).select("id");return t?(console.error("Error cleaning up cache:",t),{deleted:0}):{deleted:(e==null?void 0:e.length)||0}}catch(e){return console.error("Error in cleanupExpiredCache:",e),{deleted:0}}}async getCacheStats(){try{const{data:e,error:t}=await d.from("ai_responses").select("cache_type, tokens_used").gt("expires_at",new Date().toISOString());if(t)return console.error("Error getting cache stats:",t),{totalEntries:0,byType:{},totalTokensSaved:0};const r={totalEntries:e.length,byType:{},totalTokensSaved:e.reduce((s,a)=>s+(a.tokens_used||0),0)};return e.forEach(s=>{const a=s.cache_type||"unknown";r.byType[a]=(r.byType[a]||0)+1}),r}catch(e){return console.error("Error in getCacheStats:",e),{totalEntries:0,byType:{},totalTokensSaved:0}}}async invalidateGameCache(e){try{const{error:t}=await d.from("ai_responses").delete().eq("game_title",e).eq("cache_type","game_specific");return t?(console.error("Error invalidating game cache:",t),!1):!0}catch(t){return console.error("Error in invalidateGameCache:",t),!1}}};f(z,"instance");let Re=z;const ss=Re.getInstance(),Y=class Y{constructor(){}static getInstance(){return Y.instance||(Y.instance=new Y),Y.instance}generateProfileSpecificTabs(e,t){const r=[];return e.playerFocus==="Story-Driven"&&r.push({id:"narrative_themes",title:"Narrative Themes",type:"story",priority:"high",isProfileSpecific:!0,instruction:this.getNarrativeThemesInstruction(e.hintStyle)}),e.playerFocus==="Completionist"&&r.push({id:"secret_hunting",title:"Secret Hunting",type:"tips",priority:"high",isProfileSpecific:!0,instruction:this.getSecretHuntingInstruction(e.hintStyle)}),e.playerFocus==="Strategist"&&r.push({id:"optimization_guide",title:"Optimization Guide",type:"strategies",priority:"high",isProfileSpecific:!0,instruction:this.getOptimizationInstruction(e.hintStyle)}),t!=null&&t.playthroughCount&&t.playthroughCount>1&&r.push({id:"playthrough_comparison",title:"Playthrough Comparison",type:"tips",priority:"medium",isProfileSpecific:!0,instruction:this.getPlaythroughComparisonInstruction(e)}),r}getNarrativeThemesInstruction(e){const t={Cryptic:"Provide subtle hints about story themes without revealing major plot points. Use metaphorical language and thematic connections.",Balanced:"Discuss narrative elements with moderate detail, balancing spoiler avoidance with meaningful insight into themes and character arcs.",Direct:"Explain story themes clearly while maintaining appropriate spoiler warnings. Provide direct analysis of narrative elements encountered so far."};return t[e]||t.Balanced}getSecretHuntingInstruction(e){const t={Cryptic:"Give mysterious clues about hidden content locations. Use environmental riddles and subtle hints that require exploration.",Balanced:"Provide clear directions to secrets with some exploration challenge. Balance helpfulness with maintaining the joy of discovery.",Direct:"Give precise locations and requirements for finding secrets. Include step-by-step instructions and exact coordinates when helpful."};return t[e]||t.Balanced}getOptimizationInstruction(e){const t={Cryptic:"Suggest optimization strategies through hints and examples. Let the player discover the optimal path with guidance.",Balanced:"Provide balanced optimization advice with clear explanations. Suggest effective approaches while leaving room for experimentation.",Direct:"Give specific optimization recommendations with detailed steps. Provide exact stat allocations, builds, and strategies for maximum efficiency."};return t[e]||t.Direct}getPlaythroughComparisonInstruction(e){return`Compare different playthrough approaches based on ${e.playerFocus} style and ${e.hintStyle} preferences. Highlight what's different this time and suggest new strategies to explore.`}prioritizeTabsForProfile(e,t){return e.sort((r,s)=>{if(r.isProfileSpecific&&!s.isProfileSpecific)return-1;if(!r.isProfileSpecific&&s.isProfileSpecific)return 1;const a={high:3,medium:2,low:1};return a[s.priority]-a[r.priority]})}getHintStyleModifier(e){const t={Cryptic:"Use subtle, metaphorical hints. Avoid direct answers. Make the player think and discover.",Balanced:"Provide clear guidance while leaving room for exploration. Balance helpfulness with discovery.",Direct:"Give explicit, step-by-step instructions. Be precise and comprehensive in explanations."};return t[e]||t.Balanced}getPlayerFocusModifier(e){const t={"Story-Driven":"Emphasize narrative elements, character development, and story context. Prioritize lore and thematic content.",Completionist:"Focus on collectibles, hidden items, side quests, and 100% completion strategies. Highlight missable content.",Strategist:"Prioritize optimal strategies, build optimization, and efficient progression. Focus on mechanics and systems."};return t[e]||t.Strategist}getSpoilerToleranceModifier(e){const t={Strict:"NEVER mention future events, characters, or plot points. Only discuss content up to current progress.",Moderate:"You may hint at upcoming content in vague terms, but avoid specific spoilers.",Relaxed:"You can discuss future content more freely, but still mark major spoilers clearly."};return t[e]||t.Strict}getToneModifier(e){const t={Encouraging:"Use an enthusiastic, supportive tone. Celebrate achievements and provide positive reinforcement.",Professional:"Maintain a knowledgeable, respectful tone. Provide expertise without excessive casualness.",Casual:"Use a friendly, conversational tone. Feel free to use gaming terminology and be relaxed."};return t[e]||t.Professional}buildProfileContext(e){return[`Hint Style: ${this.getHintStyleModifier(e.hintStyle)}`,`Player Focus: ${this.getPlayerFocusModifier(e.playerFocus)}`,`Spoiler Tolerance: ${this.getSpoilerToleranceModifier(e.spoilerTolerance)}`,`Tone: ${this.getToneModifier(e.preferredTone)}`].join(`
`)}getDefaultProfile(){return{hintStyle:"Balanced",playerFocus:"Strategist",preferredTone:"Professional",spoilerTolerance:"Strict"}}};f(Y,"instance");let ke=Y;const te=ke.getInstance(),Te=new Map;async function Qe(o){const e=Te.get(o);if(e)return await e,Qe(o);let t=()=>{};const r=new Promise(s=>{t=s});return Te.set(o,r),()=>{Te.delete(o),t()}}const et={responseHistoryScope:"game",applyCorrections:!0,correctionDefaultScope:"game"},qe={aiCorrections:[],aiPreferences:et,responseTopicsCache:{}},kt=20,He=5,Ke=10;async function R(o){try{const{data:e,error:t}=await d.from("users").select("behavior_data").eq("auth_user_id",o).single();if(t)return console.error("[BehaviorService] Error fetching behavior_data:",t),qe;const r=(e==null?void 0:e.behavior_data)||{};return{aiCorrections:r.aiCorrections||[],aiPreferences:{...et,...r.aiPreferences},responseTopicsCache:r.responseTopicsCache||{}}}catch(e){return console.error("[BehaviorService] Exception fetching behavior_data:",e),qe}}async function D(o,e){const t=await Qe(o);try{const r=await R(o),s={...r,...e,aiPreferences:e.aiPreferences?{...r.aiPreferences,...e.aiPreferences}:r.aiPreferences},{error:a}=await d.from("users").update({behavior_data:s}).eq("auth_user_id",o);return a?(console.error("[BehaviorService] Error updating behavior_data:",a),!1):!0}catch(r){return console.error("[BehaviorService] Exception updating behavior_data:",r),!1}finally{t()}}async function Pt(o,e,t="game"){if(t==="off")return[];const r=await R(o);if(t==="global")return Object.values(r.responseTopicsCache).flat().slice(0,50);const s=e||"game-hub";return r.responseTopicsCache[s]||[]}async function Nt(o,e,t){if(!t.length)return;const r=await R(o),s=e||"game-hub",a=r.responseTopicsCache[s]||[],n=[...t,...a],c=[...new Set(n)].slice(0,kt);r.responseTopicsCache[s]=c,await D(o,{responseTopicsCache:r.responseTopicsCache})}async function Mt(o,e){const t=await R(o);if(e===void 0)await D(o,{responseTopicsCache:{}});else{const r=e||"game-hub";delete t.responseTopicsCache[r],await D(o,{responseTopicsCache:t.responseTopicsCache})}}async function Gt(o){return(await R(o)).aiPreferences}async function Dt(o,e){const t=await R(o);return D(o,{aiPreferences:{...t.aiPreferences,...e}})}async function xt(o,e=null,t=!0){return(await R(o)).aiCorrections.filter(s=>s.isActive?s.scope==="game"?s.gameTitle===e:t&&s.scope==="global":!1)}async function Ut(o,e){const t=await R(o),r=t.aiCorrections.filter(c=>c.isActive&&c.scope==="game"&&c.gameTitle===e.gameTitle),s=t.aiCorrections.filter(c=>c.isActive&&c.scope==="global");if(e.scope==="game"&&r.length>=He)return{success:!1,error:`Maximum ${He} corrections per game reached`};if(e.scope==="global"&&s.length>=Ke)return{success:!1,error:`Maximum ${Ke} global corrections reached`};const a={...e,id:crypto.randomUUID(),isActive:!0,appliedCount:0,createdAt:new Date().toISOString()};return t.aiCorrections.push(a),{success:await D(o,{aiCorrections:t.aiCorrections})}}async function $t(o,e,t){const r=await R(o),s=r.aiCorrections.find(a=>a.id===e);return s?(s.isActive=t,D(o,{aiCorrections:r.aiCorrections})):!1}async function Lt(o,e){const t=await R(o);return t.aiCorrections=t.aiCorrections.filter(r=>r.id!==e),D(o,{aiCorrections:t.aiCorrections})}async function Ft(o,e){const t=await R(o),r=t.aiCorrections.find(s=>s.id===e);r&&(r.appliedCount++,await D(o,{aiCorrections:t.aiCorrections}))}const G={getBehaviorData:R,updateBehaviorData:D,getResponseTopics:Pt,addResponseTopics:Nt,clearResponseTopics:Mt,getAIPreferences:Gt,updateAIPreferences:Dt,getActiveCorrections:xt,addCorrection:Ut,toggleCorrection:$t,removeCorrection:Lt,incrementCorrectionApplied:Ft};function Bt(o){if(!o||o.scope==="off")return"";const e=[];if(o.previousTopics.length>0&&e.push(`
**üìö PREVIOUSLY DISCUSSED TOPICS (Avoid Repetition):**
The user has already received information about these topics in recent conversations. 
DO NOT repeat the same information - provide NEW angles, deeper insights, or different aspects.
Topics covered: ${o.previousTopics.slice(0,15).join(", ")}
`),o.corrections.length>0){const t=o.corrections.map(r=>`- ${r.scope==="global"?"(Global)":`(${r.gameTitle||"This Game"})`} Instead of "${r.originalSnippet.slice(0,50)}...", prefer: "${r.correctionText}"`);e.push(`
**‚úèÔ∏è USER CORRECTIONS (Apply these preferences):**
The user has provided the following corrections to improve your responses:
${t.join(`
`)}
`)}return e.join(`
`)}async function as(o,e){try{const t=await G.getAIPreferences(o);if(t.responseHistoryScope==="off")return{previousTopics:[],corrections:[],scope:"off"};const[r,s]=await Promise.all([G.getResponseTopics(o,e,t.responseHistoryScope),G.getActiveCorrections(o,e,!0)]);return{previousTopics:r,corrections:s,scope:t.responseHistoryScope}}catch(t){return console.error("[PromptSystem] Error fetching behavior context:",t),null}}const De=`
**‚ö†Ô∏è IMPORTANT: Gaming-Only Focus**
You are Otagon, a gaming-focused AI assistant. Your expertise is EXCLUSIVELY in:
- Video games (all platforms, genres, eras)
- Gaming strategies, tips, walkthroughs, and guides
- Game lore, storylines, and character information
- Gaming news, releases, and industry updates
- Gaming hardware and peripherals
- Esports and competitive gaming
- Game development topics (as they relate to players)

**How to handle non-gaming queries:**
If a user asks about something unrelated to gaming:
1. Politely acknowledge their question
2. Explain that you're Otagon, a specialized gaming assistant
3. Gently redirect them back to gaming topics
4. Offer gaming-related alternatives if possible

**Example redirections:**
- "What's the weather like?" ‚Üí "I'm Otagon, your gaming companion! I don't track weather, but I can tell you about weather systems in games like Death Stranding or Red Dead Redemption 2. What game would you like to explore?"
- "Help me with math homework" ‚Üí "I'm actually specialized in gaming! I can't help with homework, but if you're looking for puzzle games that sharpen math skills, I'd recommend games like Portal or The Talos Principle!"
- "Write me a poem" ‚Üí "While poetry isn't my specialty, many games have beautiful in-game poems and lore! Games like Disco Elysium, Hades, and Baldur's Gate 3 have amazing writing. Want to explore the writing in any game?"
- "What's the news today?" ‚Üí "I focus on gaming news! Want me to tell you about the latest game releases, updates, or industry announcements?"

**Topics that ARE gaming-related (answer fully):**
‚úÖ Game recommendations
‚úÖ Strategy and tips for any game
‚úÖ Story/lore questions about games
‚úÖ Gaming setup and hardware questions
‚úÖ Esports and competitive gaming
‚úÖ Retro and classic games
‚úÖ Gaming culture and community
‚úÖ Game development (Unity, Unreal, etc.)
‚úÖ Streaming and content creation related to gaming
‚úÖ Gaming news and reviews

**BE HELPFUL, NOT ANNOYING:**
- Don't over-explain or be preachy about the limitation
- Keep redirections brief and friendly (1-2 sentences)
- Always offer a gaming alternative or suggestion
- If the non-gaming topic can be connected to gaming, make that connection!
`,xe=`
You MUST use the following tags to structure your response. Do not put them in a code block.
- [OTAKON_GAME_ID: Game Name]: The full, official name of the game you've identified.
- [OTAKON_CONFIDENCE: high|low]: Your confidence in the game identification.
- [OTAKON_GENRE: Genre]: The primary genre of the identified game. Must be one of:
  ‚Ä¢ Action RPG - Action-focused RPGs with real-time combat (Dark Souls, God of War, etc.)
  ‚Ä¢ RPG - Traditional role-playing games with deep stories and character progression
  ‚Ä¢ Souls-like - Challenging action games inspired by Dark Souls (Elden Ring, Sekiro, Hollow Knight, etc.)
  ‚Ä¢ Metroidvania - Non-linear exploration platformers with ability-gated progression
  ‚Ä¢ Open-World - Large open-world games with exploration focus (GTA, Zelda: BOTW, etc.)
  ‚Ä¢ Survival-Crafting - Survival games with resource gathering and crafting mechanics
  ‚Ä¢ First-Person Shooter - FPS games
  ‚Ä¢ Strategy - Strategy and tactical games (RTS, turn-based, 4X)
  ‚Ä¢ Adventure - Story-driven adventure and narrative games
  ‚Ä¢ Simulation - Simulation and management games
  ‚Ä¢ Sports - Sports games and sports management sims
  ‚Ä¢ Multiplayer Shooter - Competitive multiplayer FPS games
  ‚Ä¢ Multiplayer Sports - Competitive multiplayer sports games
  ‚Ä¢ Racing - Racing games and driving sims
  ‚Ä¢ Fighting - Fighting games
  ‚Ä¢ Battle Royale - Battle royale games
  ‚Ä¢ MMORPG - Massively multiplayer online RPGs
  ‚Ä¢ Puzzle - Puzzle games
  ‚Ä¢ Horror - Horror and survival horror games
  ‚Ä¢ Default - Use this only if none of the above genres fit
  **Important**: Use the EXACT genre names listed above. Choose the MOST SPECIFIC genre that fits the game.
- [OTAKON_GAME_STATUS: unreleased]: ONLY include this tag if the game is NOT YET RELEASED. Verify the release date before including this tag.
- [OTAKON_IS_FULLSCREEN: true|false]: Whether the screenshot shows fullscreen gameplay (not menus, launchers, or non-game screens).
- [OTAKON_PROGRESS: 0-100]: **MANDATORY** - You MUST include this tag in EVERY response. Estimate the player's game completion percentage (0-100) based on:
  * Screenshot clues: area/zone names, quest markers, boss names, UI indicators, map position
  * Story position: prologue (5-15%), early game (15-35%), mid-game (35-60%), late game (60-85%), endgame (85-100%)
  * Equipment/level: starter gear = early, upgraded = mid, legendary = late
  * Character unlocks, ability trees, quest log state
  * If uncertain, make your best estimate - any progress is better than 0
- [OTAKON_OBJECTIVE: "Current objective description"]: The player's current main objective or goal based on the screenshot or conversation.
- [OTAKON_TRIUMPH: {"type": "boss_defeated", "name": "Boss Name"}]: When analyzing a victory screen.
- [OTAKON_OBJECTIVE_SET: {"description": "New objective"}]: When a new player objective is identified.
- [OTAKON_INSIGHT_UPDATE: {"id": "sub_tab_id", "content": "content"}]: To update a specific sub-tab with NEW information discovered in this conversation.
- [OTAKON_SUBTAB_UPDATE: {"tab": "story_so_far|characters|tips|boss_strategy|quest_log", "content": "New content to append"}]: ALWAYS include this when you provide information that should be saved to a subtab. This ensures subtabs stay updated with the latest information.
- [OTAKON_INSIGHT_MODIFY_PENDING: {"id": "sub_tab_id", "title": "New Title", "content": "New content"}]: When user asks to modify a subtab via @command.
- [OTAKON_INSIGHT_DELETE_REQUEST: {"id": "sub_tab_id"}]: When user asks to delete a subtab via @command.
- [OTAKON_SUGGESTIONS: ["suggestion1", "suggestion2", "suggestion3"]]: Three contextual follow-up prompts for the user. Make these short, specific questions that help the user learn more about the current situation, get tips, or understand what to do next.
`,Wt=`
**Command Centre - Subtab Management:**
Users can manage subtabs using @ commands:
1. **@<tab_name> <instruction>**: Update a subtab with new information
   - Example: "@story_so_far The player just defeated the first boss"
   - Response: Include [OTAKON_INSIGHT_UPDATE: {"id": "story_so_far", "content": "The player has...[updated content based on instruction]"}]
   
2. **@<tab_name> \\modify**: Modify or rename a subtab
   - Example: "@tips \\modify change this to combat strategies"
   - Response: Include [OTAKON_INSIGHT_MODIFY_PENDING: {"id": "tips", "title": "Combat Strategies", "content": "[updated content]"}]
   
3. **@<tab_name> \\delete**: Delete a subtab
   - Example: "@unused_tab \\delete"
   - Response: Include [OTAKON_INSIGHT_DELETE_REQUEST: {"id": "unused_tab"}] and acknowledge the deletion

When you see an @ command:
- Acknowledge the command in your response ("I've updated the [tab name] tab...")
- Include the appropriate OTAKON tag to execute the action
- Provide confirmation of what was changed
`,qt=o=>`
**Persona: General Gaming Assistant**
You are Otagon, a helpful and knowledgeable AI gaming assistant for the "Game Hub" tab.

${De}

**CRITICAL: Use Real Information**
- Today's date is ${new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}
- You have access to Google Search grounding for current information
- ALWAYS cite specific game titles, release dates, and accurate details from web search results
- NEVER use placeholders like "[Hypothetical Game A]" or "[Insert Today's Date]"
- For questions about recent releases, new updates, or announcements, use the grounded web search data
- Your knowledge cutoff is January 2025 - use web search for anything after that date
- Always provide specific, real game titles and accurate information

**Task:**
1. Thoroughly answer the user's query: "${o}".
2. If the query is about a SPECIFIC RELEASED GAME that the user mentions by name, you MUST include these tags:
   - [OTAKON_GAME_ID: Full Game Name] - The complete, official name of the game
   - [OTAKON_CONFIDENCE: high|low] - Your confidence in the identification
   - [OTAKON_GENRE: Genre] - The primary genre (e.g., Action RPG, FPS, Strategy)
   - [OTAKON_GAME_STATUS: unreleased] - ONLY if the game is NOT YET RELEASED
3. Generate three SPECIFIC follow-up prompts using [OTAKON_SUGGESTIONS: ["prompt1", "prompt2", "prompt3"]]
   - These MUST relate to the specific content of YOUR response
   - Reference specific games, features, or topics you mentioned
   - ‚ùå BAD: "What games are coming out?" (generic)
   - ‚úÖ GOOD: "Tell me more about [specific game you mentioned]'s multiplayer features"

**SPECIAL INSTRUCTIONS FOR GAMING NEWS:**
When answering questions about gaming news, releases, reviews, or trailers:
- Provide AT LEAST 10 news items with substantial detail for each
- Each news item should be 1-2 paragraphs with specific details (release dates, features, prices, platform info)
- Use proper markdown formatting: ## for main headlines, ### for subheadings
- Include sections like: "Major Releases", "Upcoming Games", "Industry News", "DLC & Updates", "Hardware News"
- DO NOT use underscores (___) or horizontal rules for formatting - use markdown headings instead
- Make responses comprehensive and informative
- Cite specific sources when possible
- Focus on recent news (within last 2 weeks)
- **SUGGESTIONS for news responses MUST reference specific games/events you just covered**

**TRAILER REQUESTS - INCLUDE VIDEO LINKS:**
When the user asks about game trailers, gameplay videos, or announcements:
- ALWAYS include direct YouTube links to official trailers when available
- Format links as: [Watch Trailer](https://youtube.com/watch?v=VIDEO_ID)
- Use official channels: PlayStation, Xbox, Nintendo, IGN, GameSpot, or publisher channels
- Include multiple trailer types when relevant: Announcement, Gameplay, Story, Launch trailers
- Example format:
  ### Game Title
  **Release Date:** Month Day, Year
  Description of the trailer and what it reveals...
  
  üé¨ [Watch Official Trailer](https://youtube.com/watch?v=XXXXX) | [Gameplay Reveal](https://youtube.com/watch?v=XXXXX)

**CRITICAL MARKDOWN FORMATTING RULES - FOLLOW EXACTLY:**
1. Bold text must be on the SAME LINE: "**Game Title**" NOT "**Game Title
**"
2. NO spaces after opening bold markers: "**Release Date:**" NOT "** Release Date:**"
3. NO spaces before closing bold markers: "**Title**" NOT "**Title **"
4. Don't mix ### with **: use "### Game Title" OR "**Game Title**" but NOT "###** Game Title"
5. Each game entry should follow this EXACT format:

### Game Title
**Release Date:** Month Day, Year (Platforms)
Description paragraph here...

6. Keep bold markers and their content on a single line
7. Use line breaks BETWEEN sections, not INSIDE bold markers

**IMPORTANT - When to use game tags:**
‚úÖ User asks: "How do I beat the first boss in Elden Ring?" ‚Üí Include [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG]
‚úÖ User asks: "What's the best build for Cyberpunk 2077?" ‚Üí Include [OTAKON_GAME_ID: Cyberpunk 2077] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG]
‚ùå User asks: "What's a good RPG to play?" ‚Üí NO game tags (general question)
‚ùå User asks: "Tell me about open world games" ‚Üí NO game tags (general question)

**Tag Definitions:**
${xe}

**Response Style:**
- Be helpful and knowledgeable about gaming
- Keep responses concise but informative
- Use gaming terminology appropriately
- For game-specific queries, start with "Hint:" and provide actionable advice
- Focus on useful information, not obvious descriptions
- Make responses engaging and immersive
- NEVER include underscore lines (___), horizontal rules, or timestamps at the end of responses
- End responses naturally without decorative separators
- Use clean markdown: proper spacing around bold/italic, headings on their own lines
- For lists of games/reviews, use consistent formatting throughout
`,Ht=(o,e,t,r,s)=>{var u,m;const a=((u=o.subtabs)==null?void 0:u.filter(h=>h.status==="loaded"&&h.content).map(h=>`### ${h.title} (ID: ${h.id})
${h.content}`).join(`

`))||"No subtabs available yet.",n=o.messages.slice(-10).map(h=>`${h.role==="user"?"User":"Otagon"}: ${h.content}`).join(`
`),c=o.contextSummary?`**Historical Context (Previous Sessions):**
${o.contextSummary}

`:"",i=s||te.getDefaultProfile(),l=te.buildProfileContext(i);return`
**Persona: Game Companion**
You are Otagon, an immersive AI companion for the game "${o.gameTitle}".
The user's spoiler preference is: "${((m=t.preferences)==null?void 0:m.spoilerPreference)||"none"}".
The user's current session mode is: ${r?"ACTIVE (currently playing)":"PLANNING (not playing)"}.

${De}

**Web Search Grounding Available:**
- You have access to Google Search for current information about this game
- Use web search for: patch notes, updates, DLC announcements, strategy guides, wiki information
- Your knowledge cutoff is January 2025 - use grounding for recent game updates or patches
- Always cite specific sources when using grounded information

**Game Context:**
- Game: ${o.gameTitle} (${o.genre})
- Current Objective: ${o.activeObjective||"Not set"}
- Game Progress: ${o.gameProgress||0}%

**Player Profile:**
${l}

**Current Subtabs (Your Knowledge Base):**
${a}

${c}**Recent Conversation History:**
${n}

**User Query:** "${e}"

**Task:**
1. Respond to the user's query in an immersive, in-character way that matches the tone of the game.
2. Use the subtab context above to provide informed, consistent answers.
3. **IMPORTANT: Adapt your response style based on the Player Profile above.**
4. If the query provides new information, update relevant subtabs using [OTAKON_SUBTAB_UPDATE: {"tab": "appropriate_tab", "content": "new info"}].
5. If the query implies progress, identify new objectives using [OTAKON_OBJECTIVE_SET].
6. **‚ö†Ô∏è MANDATORY PROGRESS TRACKING - You MUST include [OTAKON_PROGRESS: X] at the END of every response:**
   * Current stored progress: ${o.gameProgress||0}%
   * ALWAYS update based on what the player tells you or what you see in screenshots
   * Use these estimates:
     - Tutorial/beginning area ‚Üí [OTAKON_PROGRESS: 5]
     - First dungeon/boss ‚Üí [OTAKON_PROGRESS: 15]
     - Exploring early regions ‚Üí [OTAKON_PROGRESS: 25]
     - Mid-game content ‚Üí [OTAKON_PROGRESS: 40]
     - Late-game areas ‚Üí [OTAKON_PROGRESS: 65]
     - Final areas/boss ‚Üí [OTAKON_PROGRESS: 85]
     - Post-game ‚Üí [OTAKON_PROGRESS: 95]
   * For Elden Ring specifically:
     - Limgrave ‚Üí [OTAKON_PROGRESS: 10]
     - Liurnia of the Lakes ‚Üí [OTAKON_PROGRESS: 25]
     - Raya Lucaria Academy ‚Üí [OTAKON_PROGRESS: 30]
     - Altus Plateau ‚Üí [OTAKON_PROGRESS: 45]
     - Leyndell ‚Üí [OTAKON_PROGRESS: 55]
     - Mountaintops of the Giants ‚Üí [OTAKON_PROGRESS: 70]
     - Crumbling Farum Azula ‚Üí [OTAKON_PROGRESS: 80]
     - Elden Throne ‚Üí [OTAKON_PROGRESS: 90]
7. **ALWAYS include [OTAKON_OBJECTIVE: "description"]** with the current main objective the player is working on.
8. ${r?"Provide concise, actionable advice for immediate use.":"Provide more detailed, strategic advice for planning."}
9. Generate three SPECIFIC follow-up prompts using [OTAKON_SUGGESTIONS] - these MUST relate to what you just discussed, not generic questions.

**CRITICAL - Context-Aware Follow-ups:**
- Your suggestions MUST reference specific content from YOUR response (bosses, items, locations, characters you mentioned)
- ‚ùå BAD: "What should I do next?" (too generic)
- ‚úÖ GOOD: "How do I counter [specific enemy you mentioned]'s attack pattern?"
- ‚úÖ GOOD: "Where can I find the [specific item you referenced]?"
- The user is ${r?"actively playing - suggest immediate tactical questions":"planning - suggest strategic/preparation questions"}

${Wt}

**Suggestions Guidelines:**
Generate 3 short, specific follow-up questions that help the user:
- Get immediate help with their current situation
- Learn more about game mechanics or story elements
- Get strategic advice for their next steps
- Understand character motivations or plot points
- Explore related game content or areas

Examples of good suggestions:
- "What's the best strategy for this boss?"
- "Tell me more about this character's backstory"
- "What should I do next in this area?"
- "How do I unlock this feature?"
- "What items should I prioritize here?"

**Tag Definitions:**
${xe}

**CRITICAL MARKDOWN FORMATTING RULES - FOLLOW EXACTLY:**
1. Bold text must be on the SAME LINE: "**Game Title**" NOT "**Game Title
**"
2. NO spaces after opening bold markers: "**Release Date:**" NOT "** Release Date:**"
3. NO spaces before closing bold markers: "**Title**" NOT "**Title **"
4. Don't mix ### with **: use "### Heading" OR "**Bold Text**" but NOT "###** Mixed"
5. Keep bold markers and their content on a single line
6. Use line breaks BETWEEN sections, not INSIDE bold markers
7. For game info, use this format:
   ### Section Title
   **Label:** Value
   Description paragraph...

**Response Style:**
- Match the tone and atmosphere of ${o.gameTitle}
- Be spoiler-free beyond current progress
- Provide practical, actionable advice
- Use game-specific terminology and references
- Start with "Hint:" for game-specific queries
- Include lore and story context appropriate to player's progress
- When updating subtabs, seamlessly integrate the update into your response
- Use clean, consistent markdown formatting throughout
`},Kt=(o,e,t,r)=>{const s=r||te.getDefaultProfile(),a=te.buildProfileContext(s);return`
**Persona: Game Lore Expert & Screenshot Analyst**
You are Otagon, an expert at analyzing game visuals and providing immersive, lore-rich assistance.

${De}

**Player Profile:**
${a}

**Task:**
1. Analyze the screenshot to identify the game
2. **CRITICAL TAG REQUIREMENTS - Include ALL of these tags AT THE END OF YOUR RESPONSE:**
   - [OTAKON_GAME_ID: Full Game Name] - The complete, official name of the game
   - [OTAKON_CONFIDENCE: high|low] - Your confidence in the identification
   - [OTAKON_GENRE: Genre] - The primary genre (e.g., Action RPG, FPS, Strategy)
   - [OTAKON_IS_FULLSCREEN: true|false] - Is this fullscreen gameplay? (For informational purposes)
   - [OTAKON_GAME_STATUS: unreleased] - ONLY include this if the game is NOT YET RELEASED (verify release date!)
   - **[OTAKON_PROGRESS: XX]** - ‚ö†Ô∏è MANDATORY: Estimate player's game completion percentage (0-100)
   - [OTAKON_OBJECTIVE: "current goal"] - What the player appears to be doing
3. Answer: "${e}" with focus on game lore, significance, and useful context
4. Provide 3 contextual suggestions using [OTAKON_SUGGESTIONS: ["suggestion1", "suggestion2", "suggestion3"]]

**‚ö†Ô∏è PROGRESS TAG IS MANDATORY - NEVER SKIP THIS:**
Every response MUST include [OTAKON_PROGRESS: XX] where XX is 0-100.
Example: [OTAKON_PROGRESS: 35] for a player in early-mid game

**Tag Usage Examples:**
‚úÖ Gameplay screenshot (CREATES TAB): [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG] [OTAKON_IS_FULLSCREEN: true] [OTAKON_PROGRESS: 25]
‚úÖ In-game inventory menu (CREATES TAB): [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG] [OTAKON_IS_FULLSCREEN: true] [OTAKON_PROGRESS: 40]
‚úÖ Main menu before starting (STAYS IN GAME HUB): [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG] [OTAKON_IS_FULLSCREEN: false] [OTAKON_PROGRESS: 0]
‚úÖ Unreleased game: [OTAKON_GAME_ID: GTA VI] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action Adventure] [OTAKON_IS_FULLSCREEN: true] [OTAKON_GAME_STATUS: unreleased] [OTAKON_PROGRESS: 0]

**IMPORTANT - Game Tab Creation:**
- Screenshots showing ACTIVE GAMEPLAY or IN-GAME MENUS will create a dedicated game tab
- Set [OTAKON_IS_FULLSCREEN: true] for gameplay, in-game menus, or any screen accessed DURING a play session
- Main menus, character selection, launchers should use [OTAKON_IS_FULLSCREEN: false]
- These pre-game screens will be handled in the "Game Hub" for quick questions

**What counts as fullscreen gameplay (for IS_FULLSCREEN tag = true, CREATES TAB):**
- In-game world exploration with HUD visible
- Combat encounters with player character visible
- Active gameplay with health/stamina/ammo displays
- **In-game menus: inventory, map, skill tree, quest log, crafting, loadout**
- **Character stats, equipment, loot screens accessed during gameplay**
- Pause menus DURING gameplay (game world visible or obscured)
- Cutscenes during gameplay with game UI

**What is NOT fullscreen gameplay (IS_FULLSCREEN = false, STAYS IN GAME HUB):**
- Main menus BEFORE starting game (Press Start, New Game, Continue, Load Game)
- Settings/Options menus accessed before gameplay begins
- Character creation/selection screens at game start
- Loading screens or splash screens
- Launchers (Steam, Epic, etc.) or desktop with game icon
- Store pages or promotional images
- Tutorial screens before gameplay starts

**Response Style for Text Queries:**
- Be conversational and contextual - respond naturally to the user's question
- Build on previous conversation context progressively
- NO structured headers (Hint/Lore/Places) for text conversations
- Use natural paragraphs and flowing prose
- Reference previous messages when relevant
- Adapt tone to match user's question (casual question = casual response, serious question = detailed response)

**Response Style for Image Uploads ONLY:**
- Use structured format with section headers
- Focus on GAME LORE, SIGNIFICANCE, and USEFUL CONTEXT rather than describing obvious UI elements
- Make the response immersive and engaging

**CRITICAL MARKDOWN FORMATTING RULES - FOLLOW EXACTLY:**
1. Bold text must be on the SAME LINE: "**Hint:**" NOT "**Hint:
**"
2. NO spaces after opening bold markers: "**Lore:**" NOT "** Lore:**"
3. NO spaces before closing bold markers: "**Text**" NOT "**Text **"
4. Keep bold markers and their content on a single line
5. Use line breaks BETWEEN sections, not INSIDE bold markers

**MANDATORY FORMAT FOR IMAGES - Use this exact structure with bold section headers:**
**Hint:** [Game Name] - [Brief, actionable hint about what the player should do or focus on]

**Lore:** [Rich lore explanation about the current situation, characters, story significance, or world-building context]

**Places of Interest:** [Nearby locations, shops, NPCs, or areas where the player can find useful items, quests, or important interactions]

**What to focus on:**
- Story significance and lore implications
- Character relationships and motivations
- Location importance and world-building
- Gameplay mechanics and strategic advice
- Narrative context and plot relevance
- Cultural or thematic elements

**What to avoid:**
- Describing obvious UI elements (health bars, buttons, etc.)
- Stating the obvious ("you can see buildings", "there's text on screen")
- Generic descriptions that don't add value
- Deviating from the mandatory format above

**Genre Classification Confirmation:**
After providing your response, if there's ANY ambiguity about the genre classification, add a brief confirmation question:
- Example: "I've classified this as a Souls-like game. Does that match your understanding, or would you prefer a different categorization?"
- Example: "This appears to be an Open-World adventure game. If you think it fits better in another category (like RPG or Action RPG), let me know!"
- Only include this if the genre could reasonably fit multiple categories
- Keep it brief and natural - don't add it for obvious genre matches like "Call of Duty = First-Person Shooter"

**ABSOLUTELY MANDATORY - Progress Tracking (EVERY response MUST include this):**
YOU MUST include [OTAKON_PROGRESS: X] in your response. This is NON-NEGOTIABLE.

**How to estimate progress from screenshots:**
1. **Area/Location Analysis:**
   - Recognize starting areas, tutorial zones ‚Üí 5-15%
   - Early game zones, first dungeons ‚Üí 15-30%
   - Mid-game regions, story progression ‚Üí 30-60%
   - Late-game areas, advanced zones ‚Üí 60-85%
   - Final dungeon, endgame content ‚Üí 85-100%

2. **Visual Cues to Look For:**
   - HUD elements: quest trackers, chapter indicators, completion percentages
   - Map position: how much of the world is unlocked/explored
   - Equipment quality: starter/common gear (early) vs rare/legendary (late)
   - Character level if visible
   - Boss health bars, enemy types
   - UI unlocks: more abilities = more progress

3. **Game-Specific Estimation Examples:**
   - Souls-like: Area name recognition (Limgrave=10%, Altus=40%, Mountaintops=70%, Elden Throne=90%)
   - RPG: Chapter/Act numbers, party size, spell/skill count
   - Open-world: Map fog percentage, waypoints unlocked
   - Linear games: Level/mission number

**OUTPUT FORMAT (include at END of response):**
[OTAKON_PROGRESS: XX]
[OTAKON_OBJECTIVE: "What player is currently doing"]

**If you cannot determine exact progress, estimate based on visual complexity - NEVER leave progress at 0 if you can see gameplay.**

**CRITICAL - Subtab Updates (Include when providing valuable info):**
- Use **[OTAKON_SUBTAB_UPDATE: {"tab": "tab_name", "content": "content"}]** to save important info to subtabs
- Valid tabs: story_so_far, characters, tips, boss_strategy, quest_log, points_of_interest, hidden_secrets
- Example: Explaining boss mechanics ‚Üí [OTAKON_SUBTAB_UPDATE: {"tab": "boss_strategy", "content": "**Boss Name**: Attack patterns include..."}]
- Example: Explaining character ‚Üí [OTAKON_SUBTAB_UPDATE: {"tab": "characters", "content": "**Character Name**: Role in story..."}]

**Suggestions Guidelines:**
Generate 3 short, SPECIFIC follow-up questions based on YOUR response:
- Reference specific elements you identified in the screenshot (boss names, locations, items)
- ‚ùå BAD: "What should I do next?" (generic)
- ‚úÖ GOOD: "How do I counter [specific boss]'s phase 2 attacks?"
- ‚úÖ GOOD: "What's in the building to the [direction you mentioned]?"

Examples of good suggestions:
- "What's the significance of this location?"
- "How do I handle this type of enemy?"
- "What should I do next here?"
- "Tell me about this character's backstory"
- "What items should I look for in this area?"

**Tag Definitions:**
${xe}
`},os=(o,e,t,r,s,a,n)=>{const c=n?Bt(n):"";let i;return s?i=Kt(o,e,t,a):!o.isGameHub&&o.gameTitle?i=Ht(o,e,t,r,a):i=qt(e),c?c+`

`+i:i};class jt{constructor(){f(this,"retryAttempts",new Map);f(this,"MAX_RETRIES",3);f(this,"RETRY_DELAYS",[1e3,2e3,4e3])}async handleAIError(e,t){if(console.error(`ü§ñ [ErrorRecovery] AI Error in ${t.operation}:`,e),this.shouldRetry(t)){const r=this.getRetryDelay(t.retryCount);return await this.delay(r),{type:"retry",action:async()=>{}}}return e.message.includes("API key")||e.message.includes("authentication")?{type:"user_notification",message:"AI service authentication failed. Please check your API key in settings."}:e.message.includes("rate limit")||e.message.includes("quota")?{type:"user_notification",message:"AI service is temporarily busy. Please try again in a few moments."}:e.message.includes("network")||e.message.includes("timeout")?{type:"user_notification",message:"Network connection issue. Please check your internet connection and try again."}:{type:"user_notification",message:"AI service is temporarily unavailable. Please try again later."}}async handleConversationError(e,t){return console.error(`üí¨ [ErrorRecovery] Conversation Error in ${t.operation}:`,e),e.message.includes("not found")?{type:"fallback",message:"Conversation not found. Creating a new one.",action:async()=>{}}:e.message.includes("permission")||e.message.includes("unauthorized")?{type:"user_notification",message:"Permission denied. Please log in again."}:{type:"user_notification",message:"Failed to save conversation. Your data may not be persisted."}}async handleCacheError(e,t){return console.error(`üíæ [ErrorRecovery] Cache Error in ${t.operation}:`,e),{type:"skip",message:"Cache unavailable. Continuing without caching."}}async handleWebSocketError(e,t){if(console.error(`üîå [ErrorRecovery] WebSocket Error in ${t.operation}:`,e),this.shouldRetry(t)){const r=this.getRetryDelay(t.retryCount);return{type:"retry",action:async()=>{await this.delay(r)}}}return{type:"user_notification",message:"PC connection lost. Screenshot upload may not be available."}}shouldRetry(e){const t=`${e.operation}_${e.conversationId||"global"}`;return(this.retryAttempts.get(t)||0)<this.MAX_RETRIES}getRetryDelay(e){return this.RETRY_DELAYS[Math.min(e,this.RETRY_DELAYS.length-1)]}incrementRetryCount(e){const t=`${e.operation}_${e.conversationId||"global"}`,r=this.retryAttempts.get(t)||0;this.retryAttempts.set(t,r+1)}resetRetryCount(e){const t=`${e.operation}_${e.conversationId||"global"}`;this.retryAttempts.delete(t)}delay(e){return new Promise(t=>setTimeout(t,e))}displayError(e,t="error"){console.log(`[${t.toUpperCase()}] ${e}`),t==="error"&&console.error("User Error:",e)}logError(e,t,r){console.error("Error Details:",{error:e.message,stack:e.stack,context:t,additionalInfo:r,timestamp:new Date().toISOString()})}}const ns=new jt;class zt{constructor(){f(this,"gameTones",{"Action RPG":{adjectives:["epic","heroic","legendary","mystical","ancient"],personality:"wise and experienced adventurer",speechPattern:"speaks with the wisdom of ages and the thrill of adventure",loreStyle:"rich with mythology and ancient secrets"},FPS:{adjectives:["intense","tactical","precise","combat-ready","strategic"],personality:"battle-hardened soldier",speechPattern:"communicates with military precision and combat experience",loreStyle:"focused on warfare, technology, and military history"},Horror:{adjectives:["ominous","chilling","mysterious","haunting","eerie"],personality:"knowledgeable survivor",speechPattern:"speaks with caution and awareness of lurking dangers",loreStyle:"dark and atmospheric, filled with supernatural elements"},Puzzle:{adjectives:["logical","methodical","analytical","clever","systematic"],personality:"brilliant problem-solver",speechPattern:"explains with clear logic and step-by-step reasoning",loreStyle:"intellectual and mysterious, focused on patterns and solutions"},RPG:{adjectives:["immersive","narrative-driven","character-focused","epic","emotional"],personality:"storyteller and guide",speechPattern:"speaks like a narrator, weaving tales and character development",loreStyle:"deep character development and rich storytelling"},Strategy:{adjectives:["tactical","strategic","calculated","methodical","commanding"],personality:"master tactician",speechPattern:"speaks with authority and strategic insight",loreStyle:"focused on warfare, politics, and grand strategy"},Adventure:{adjectives:["exploratory","curious","adventurous","discoverer","wanderer"],personality:"intrepid explorer",speechPattern:"speaks with wonder and excitement about discovery",loreStyle:"filled with exploration, discovery, and world-building"},Default:{adjectives:["helpful","knowledgeable","friendly","supportive","engaging"],personality:"helpful gaming companion",speechPattern:"speaks clearly and helpfully",loreStyle:"focused on gameplay and helpful information"}})}getGameTone(e){return this.gameTones[e]||this.gameTones.Default}generateImmersionContext(e){const t=this.getGameTone(e.genre);let r=`**Immersion Context for ${e.gameTitle}:**
`;return r+=`You are speaking as a ${t.personality} who ${t.speechPattern}.
`,r+=`The game's lore is ${t.loreStyle}.
`,e.currentLocation&&(r+=`The player is currently in: ${e.currentLocation}
`),e.recentEvents&&e.recentEvents.length>0&&(r+=`Recent events: ${e.recentEvents.join(", ")}
`),e.playerProgress!==void 0&&(r+=`Player progress: ${e.playerProgress}%
`),r+=`
**Response Guidelines:**
`,r+=`- Use ${t.adjectives.join(", ")} language
`,r+=`- Maintain the ${t.personality} personality
`,r+=`- Focus on ${t.loreStyle} elements
`,r+=`- Keep responses immersive and in-character
`,r}enhanceResponse(e,t){let r=e;return t.genre==="Horror"?r=`*The shadows seem to whisper as you approach...*

${e}`:t.genre==="Action RPG"?r=`*The ancient knowledge flows through your mind...*

${e}`:t.genre==="FPS"?r=`*Mission briefing updated...*

${e}`:t.genre==="Puzzle"&&(r=`*The solution becomes clearer...*

${e}`),r}getGenreSuggestions(e,t){const r=["Tell me more about this area","What should I do next?","Any tips for this situation?"];return{"Action RPG":["What's the lore behind this location?","How do I improve my character?","What quests are available here?","Tell me about the local NPCs"],FPS:["What's the best tactical approach?","What weapons work best here?","How do I flank the enemy?","What's the mission objective?"],Horror:["What's the history of this place?","How do I survive this area?","What should I be careful of?","Tell me about the local legends"],Puzzle:["What's the pattern here?","How do I solve this step by step?","What clues am I missing?","What's the logical approach?"],RPG:["Tell me about the story so far","What choices should I make?","How do I develop my character?","What's the significance of this moment?"],Strategy:["What's the best strategy here?","How do I manage my resources?","What's the optimal build order?","How do I counter this threat?"]}[e]||r}createImmersiveSubTabContent(e,t,r){var a,n;const s={walkthrough:{"Action RPG":`# ${t} - Walkthrough

*The path of the hero unfolds before you...*

## Current Objective
*Your quest awaits...*

## Next Steps
*The adventure continues...*`,FPS:`# ${t} - Mission Briefing

*Mission parameters updated...*

## Objective
*Target acquired...*

## Tactical Approach
*Weapons ready...*`,Horror:`# ${t} - Survival Guide

*The darkness holds many secrets...*

## Current Situation
*Something stirs in the shadows...*

## Survival Tips
*Stay alert...*`,Default:`# ${t} - Walkthrough

## Current Objective
*Continue your journey...*

## Next Steps
*Progress forward...*`},tips:{"Action RPG":`# ${t} - Wisdom of the Ages

*Ancient knowledge flows through these tips...*

## Combat Mastery
*Master the blade and magic...*

## Exploration Secrets
*Hidden treasures await...*`,FPS:`# ${t} - Tactical Intelligence

*Mission-critical information...*

## Weapon Mastery
*Know your arsenal...*

## Tactical Positioning
*Control the battlefield...*`,Horror:`# ${t} - Survival Knowledge

*The darkness teaches harsh lessons...*

## Survival Tactics
*Stay alive...*

## Environmental Awareness
*Trust your instincts...*`,Default:`# ${t} - Tips & Tricks

## General Tips
*Improve your gameplay...*

## Advanced Techniques
*Master the game...*`}};return((a=s[e])==null?void 0:a[r])||((n=s[e])==null?void 0:n.Default)||`# ${t} - ${e}

*Content loading...*`}}const is=new zt,Yt=`You are a correction validator for OTAKON, an AI gaming companion.
Your job is to validate user-submitted corrections to ensure they:

1. DON'T BREAK CHARACTER: OTAKON is enthusiastic, knowledgeable, and uses gamer lingo. Corrections should maintain this personality.
2. ARE FACTUALLY REASONABLE: For gaming facts, the correction should be plausible (you don't need to verify, just check it's not obviously wrong).
3. ARE NOT HARMFUL: No offensive, discriminatory, or inappropriate content.
4. ARE CONTEXTUALLY RELEVANT: The correction should make sense in a gaming context.
5. ARE CONSTRUCTIVE: The correction should improve future responses.

Respond in JSON format:
{
  "isValid": boolean,
  "reason": "Brief explanation of your decision",
  "suggestedType": "factual" | "style" | "terminology" | "behavior" | null
}`,Vt=(o,e,t)=>`
Validate this correction:

ORIGINAL AI RESPONSE (snippet):
"${o.slice(0,500)}"

USER'S CORRECTION:
"${e}"

GAME CONTEXT: ${t||"General gaming / Game Hub"}

Is this correction valid? Respond with JSON only.`,Pe="otakon_correction_submissions",se=3;function tt(){try{const o=localStorage.getItem(Pe),e=Date.now();if(!o)return{allowed:!0,remaining:se};const t=JSON.parse(o);if(e>t.resetAt)return{allowed:!0,remaining:se};const r=se-t.count;return{allowed:r>0,remaining:Math.max(0,r)}}catch{return{allowed:!0,remaining:se}}}function Jt(){try{const o=localStorage.getItem(Pe),e=Date.now(),t=1440*60*1e3;let r={count:0,resetAt:e+t};o&&(r=JSON.parse(o),e>r.resetAt&&(r={count:0,resetAt:e+t})),r.count++,localStorage.setItem(Pe,JSON.stringify(r))}catch{}}async function rt(o,e,t){if(!e.trim())return{isValid:!1,reason:"Correction text is empty"};if(e.length<5)return{isValid:!1,reason:"Correction is too short"};if(e.length>1e3)return{isValid:!1,reason:"Correction is too long (max 1000 characters)"};const r=[/\b(hate|kill|die|attack)\s+(all|every|those)\b/i,/\b(racial|ethnic)\s+slur/i,/\bviolence\s+against\b/i];for(const s of r)if(s.test(e))return{isValid:!1,reason:"Correction contains inappropriate content"};try{const{data:s,error:a}=await d.functions.invoke("gemini-chat",{body:{messages:[{role:"system",content:Yt},{role:"user",content:Vt(o,e,t)}],model:"gemini-2.0-flash",temperature:.1,maxTokens:200}});if(a)return console.error("[CorrectionService] Validation API error:",a),{isValid:!1,reason:"Validation service temporarily unavailable. Please try again later."};const n=(s==null?void 0:s.content)||(s==null?void 0:s.response)||"",c=n.match(/\{[\s\S]*\}/);if(c){const i=JSON.parse(c[0]);return{isValid:i.isValid===!0,reason:i.reason||"Validation complete",suggestedType:i.suggestedType||void 0}}return console.warn("[CorrectionService] Could not parse validation response:",n),{isValid:!1,reason:"Validation response was unclear. Please try again."}}catch(s){return console.error("[CorrectionService] Validation exception:",s),{isValid:!1,reason:"Validation failed. Please try again later."}}}async function Xt(o,e){if(!tt().allowed)return{success:!1,error:`Daily correction limit reached (${se}/day). Try again tomorrow.`};const r=await rt(e.originalResponse,e.correctionText,e.gameTitle),{error:s}=await d.from("ai_feedback").insert({user_id:o,conversation_id:e.conversationId,message_id:e.messageId,feedback_type:"down",content_type:"message",category:"correction",comment:e.originalResponse.slice(0,500),correction_text:e.correctionText,correction_type:e.type,correction_scope:e.scope,is_validated:r.isValid,validation_reason:r.reason,game_title:e.gameTitle});if(s)return console.error("[CorrectionService] Failed to store feedback:",s),{success:!1,error:"Failed to save correction"};if(!r.isValid)return{success:!1,error:r.reason};const a=await G.addCorrection(o,{gameTitle:e.gameTitle,originalSnippet:e.originalResponse.slice(0,200),correctionText:e.correctionText,type:r.suggestedType||e.type,scope:e.scope});return a.success?(Jt(),{success:!0,correction:(await G.getActiveCorrections(o,e.gameTitle)).find(i=>i.correctionText===e.correctionText)}):{success:!1,error:a.error}}const Zt=[/\b(boss(?:es)?|mini-boss|final boss)\b/gi,/\b(enemy types?|elite enemies|common enemies)\b/gi,/\b(legendary weapon|rare item|unique gear)\b/gi,/\b(skill tree|ability points?|talent build)\b/gi,/\b(main quest|side quest|daily quest)\b/gi,/\b(damage build|tank build|support build|dps build)\b/gi,/\b(speedrun(?:ning)?|world record|personal best)\b/gi,/\b(secret area|hidden path|easter egg)\b/gi,/\b(tier list|meta build|optimal strategy)\b/gi,/\b(patch notes?|balance changes?|nerf(?:ed)?|buff(?:ed)?)\b/gi,/\b(dlc|expansion pack|season pass)\b/gi,/\b(game mechanics?|combat system|progression system)\b/gi,/\b(character build|loadout guide|equipment guide)\b/gi],Qt=/\b([A-Z][a-z]{2,}(?:\s+(?:of|the|and)\s+)?[A-Z][a-z]{2,}(?:\s+[A-Z][a-z]+)?)\b/g;function er(o){if(!o||o.length<100)return[];const e=new Set;for(const n of Zt){const c=o.match(n);if(c)for(const i of c){const l=i.toLowerCase().trim();l.length>=6&&l.length<=50&&l.includes(" ")&&e.add(l)}}let t=0;const r=o.match(Qt);if(r)for(const n of r){if(t>=5)break;const c=n.toLowerCase().trim();c.length>=6&&c.length<=40&&(e.add(c),t++)}const s=/\b(chapter|level|stage|floor|wave|round|phase|part|episode|act)\s+(\d+)\b/gi;let a;for(;(a=s.exec(o))!==null;)e.add(`${a[1].toLowerCase()} ${a[2]}`);return Array.from(e).slice(0,10)}async function tr(o){return(await G.getBehaviorData(o)).aiCorrections}async function rr(o,e){return G.getActiveCorrections(o,e,!0)}function sr(){return tt()}const W={validateCorrection:rt,submitCorrection:Xt,getAllCorrections:tr,getContextualCorrections:rr,getRateLimitStatus:sr,extractTopicsFromResponse:er,toggleCorrection:G.toggleCorrection,removeCorrection:G.removeCorrection};class ar{constructor(){f(this,"STORAGE_KEY","otakon_used_suggested_prompts");f(this,"LAST_RESET_KEY","otakon_suggested_prompts_last_reset");f(this,"RESET_INTERVAL_MS",1440*60*1e3);f(this,"usedPrompts",new Set);this.loadUsedPrompts(),this.checkAndResetIfNeeded()}loadUsedPrompts(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.usedPrompts=new Set(t)}}catch{this.usedPrompts=new Set}}saveUsedPrompts(){try{const e=Array.from(this.usedPrompts);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch{}}checkAndResetIfNeeded(){try{const e=localStorage.getItem(this.LAST_RESET_KEY),t=Date.now();(!e||t-parseInt(e)>=this.RESET_INTERVAL_MS)&&(this.resetUsedPrompts(),localStorage.setItem(this.LAST_RESET_KEY,t.toString()))}catch{}}markPromptAsUsed(e){this.usedPrompts.add(e),this.saveUsedPrompts()}isPromptUsed(e){return this.usedPrompts.has(e)}getUnusedPrompts(e){return e.filter(t=>!this.isPromptUsed(t))}areAllPromptsUsed(e){return e.every(t=>this.isPromptUsed(t))}resetUsedPrompts(){this.usedPrompts.clear(),localStorage.removeItem(this.STORAGE_KEY)}getUsedCount(){return this.usedPrompts.size}getTimeUntilNextReset(){try{const e=localStorage.getItem(this.LAST_RESET_KEY);if(!e)return 0;const t=parseInt(e)+this.RESET_INTERVAL_MS;return Math.max(0,t-Date.now())}catch{return 0}}getStaticNewsPrompts(){return dt}processAISuggestions(e){if(!e)return[];let t=[];if(Array.isArray(e))t=e;else if(typeof e=="string"){let s=e.trim();s.startsWith('["')&&!s.endsWith('"]')&&(s.endsWith('"')||(s+='"'),s.endsWith("]")||(s+="]"));try{const a=JSON.parse(s);Array.isArray(a)?t=a:t=[e]}catch{s.includes('", "')||s.includes(`",
"`)?t=s.split(/",\s*"/).map(n=>n.replace(/^["\s]+|["\s]+$/g,"")).filter(n=>n.length>0):s.includes(`
`)?t=s.split(`
`).map(n=>n.replace(/^["\s]+|["\s]+$/g,"")).filter(n=>n.length>0):t=[e]}}return t.filter(s=>s&&typeof s=="string"&&s.trim().length>0).map(s=>s.trim()).slice(0,3)}getFallbackSuggestions(e,t){return t===!0||e==="game-hub"||e==="everything-else"?this.getStaticNewsPrompts():["What should I do next in this area?","Tell me about the story so far","Give me some tips for this game","What are the key mechanics I should know?"]}}const cs=new ar,ce=new Map,or=300*1e3;function nr(o,e,t){return`${o}:${e}:${t||"global"}`}function ir(o){const e=ce.get(o);return e?Date.now()-e.timestamp>or?(ce.delete(o),null):e.prompts:null}function cr(o,e){ce.set(o,{prompts:e,timestamp:Date.now()})}function st(o){for(const e of ce.keys())e.startsWith(o)&&ce.delete(e)}async function Ue(o,e,t=null,r=20){const s=nr(o,e,t),a=ir(s);if(a)return a;try{const n=new Date;n.setDate(n.getDate()-7);let c=d.from("ai_shown_prompts").select("prompt_text").eq("auth_user_id",o).eq("prompt_type",e).gte("shown_at",n.toISOString()).order("shown_at",{ascending:!1}).limit(r);t&&(c=c.or(`game_title.eq.${t},game_title.is.null`));const{data:i,error:l}=await c;if(l)return console.error("[ShownPromptsService] Error fetching prompts:",l),[];const u=(i||[]).map(m=>m.prompt_text);return cr(s,u),u}catch(n){return console.error("[ShownPromptsService] Exception fetching prompts:",n),[]}}async function lr(o,e){try{const{error:t}=await d.from("ai_shown_prompts").insert({auth_user_id:o,prompt_text:e.promptText,prompt_type:e.promptType,game_title:e.gameTitle||null,conversation_id:e.conversationId||null});return t?(console.error("[ShownPromptsService] Error recording prompt:",t),!1):(st(o),!0)}catch(t){return console.error("[ShownPromptsService] Exception recording prompt:",t),!1}}async function ur(o,e){if(!e.length)return!0;try{const t=e.map(s=>({auth_user_id:o,prompt_text:s.promptText,prompt_type:s.promptType,game_title:s.gameTitle||null,conversation_id:s.conversationId||null})),{error:r}=await d.from("ai_shown_prompts").insert(t);return r?(console.error("[ShownPromptsService] Error batch recording prompts:",r),!1):(st(o),!0)}catch(t){return console.error("[ShownPromptsService] Exception batch recording prompts:",t),!1}}async function dr(o,e){try{const{error:t}=await d.from("ai_shown_prompts").update({clicked:!0,clicked_at:new Date().toISOString()}).eq("auth_user_id",o).eq("prompt_text",e).is("clicked",!1);return t?(console.error("[ShownPromptsService] Error marking prompt clicked:",t),!1):!0}catch(t){return console.error("[ShownPromptsService] Exception marking prompt clicked:",t),!1}}async function gr(o,e,t,r=null){if(!e.length)return[];const s=await Ue(o,t,r),a=new Set(s.map(n=>n.toLowerCase().trim()));return e.filter(n=>!a.has(n.toLowerCase().trim()))}async function mr(o,e,t,r=null){const s=await Ue(o,t,r),a=e.toLowerCase().trim();return s.some(n=>n.toLowerCase().trim()===a)}const ls={getRecentShownPrompts:Ue,recordShownPrompt:lr,recordShownPrompts:ur,markPromptClicked:dr,filterNewPrompts:gr,hasPromptBeenShown:mr};class hr{async generatePlayingSessionSummary(e){const t=e.messages.slice(-10),r=this.extractKeyPointsIntelligent(t,"playing"),s=this.extractObjectivesIntelligent(t,e),a=this.generateProgressContext(e),n=`**Playing Session Summary for ${e.gameTitle}**

${a}

**Key Achievements This Session:**
${r.length>0?r.map(c=>`‚Ä¢ ${c}`).join(`
`):"‚Ä¢ Session progress recorded"}

**Current Objectives:**
${s.length>0?s.map(c=>`‚Ä¢ ${c}`).join(`
`):"‚Ä¢ Continue game progression"}

**Recent Activity:**
${this.extractRecentActivity(t,3)}

*Switching to Planning Mode - Your progress has been saved.*`;return{mode:"playing",gameTitle:e.gameTitle||"Unknown Game",conversationId:e.id,summary:n,keyPoints:r,objectives:s,timestamp:Date.now(),aiGenerated:!0}}async generatePlanningSessionSummary(e){const t=e.messages.slice(-10),r=this.extractKeyPointsIntelligent(t,"planning"),s=this.extractObjectivesIntelligent(t,e),a=this.extractStrategicNotes(t),n=`**Planning Session Summary for ${e.gameTitle}**

**Strategies Discussed:**
${r.length>0?r.map(c=>`‚Ä¢ ${c}`).join(`
`):"‚Ä¢ No specific strategies noted"}

**Goals for Next Session:**
${s.length>0?s.map(c=>`‚Ä¢ ${c}`).join(`
`):"‚Ä¢ Continue exploration and progression"}

${a?`**Strategic Notes:**
${a}
`:""}
*Switching to Playing Mode - Good luck with your session!*`;return{mode:"planning",gameTitle:e.gameTitle||"Unknown Game",conversationId:e.id,summary:n,keyPoints:r,objectives:s,timestamp:Date.now(),aiGenerated:!0}}generateProgressContext(e){const t=[];return e.gameProgress&&e.gameProgress>0&&t.push(`**Progress:** ${e.gameProgress}%`),e.activeObjective&&t.push(`**Current Focus:** ${e.activeObjective}`),t.length>0?t.join(`
`):"**Progress:** Session in progress"}extractKeyPointsIntelligent(e,t){const r=[],s=new Set,c=t==="playing"?[{pattern:/defeated|killed|beat|vanquished/i,template:i=>this.extractContext(i,"boss/enemy")},{pattern:/found|discovered|obtained|acquired|picked up/i,template:i=>this.extractContext(i,"item/discovery")},{pattern:/unlocked|gained|learned|mastered/i,template:i=>this.extractContext(i,"ability/unlock")},{pattern:/completed|finished|cleared/i,template:i=>this.extractContext(i,"completion")},{pattern:/reached|arrived|entered/i,template:i=>this.extractContext(i,"location")}]:[{pattern:/build|spec|loadout|equipment/i,template:i=>this.extractContext(i,"build")},{pattern:/strategy|approach|tactic/i,template:i=>this.extractContext(i,"strategy")},{pattern:/should|recommend|best|optimal/i,template:i=>this.extractContext(i,"recommendation")},{pattern:/prepare|before|need to/i,template:i=>this.extractContext(i,"preparation")}];for(const i of e)if(i.role==="assistant"){for(const{pattern:l,template:u}of c)if(l.test(i.content)){const m=u(i.content),h=m.toLowerCase().substring(0,30);if(m&&!s.has(h)&&(s.add(h),r.push(m),r.length>=5))break}if(r.length>=5)break}return r}extractContext(e,t){const r=e.split(/[.!?]+/).filter(s=>s.trim().length>10);for(const s of r){const a=s.trim();if(!(a.length>150)&&(t==="boss/enemy"&&/defeat|kill|beat|boss|enemy/i.test(a)||t==="item/discovery"&&/found|discover|obtain|item|weapon|armor/i.test(a)||t==="ability/unlock"&&/unlock|gain|learn|ability|skill/i.test(a)||t==="completion"&&/complete|finish|clear/i.test(a)||t==="location"&&/reach|arrive|enter|area|region|zone/i.test(a)||t==="build"&&/build|spec|loadout|equipment/i.test(a)||t==="strategy"&&/strategy|approach|tactic/i.test(a)||t==="recommendation"&&/should|recommend|best|optimal/i.test(a)||t==="preparation"&&/prepare|before|need/i.test(a)))return a.substring(0,100)+(a.length>100?"...":"")}return""}extractObjectivesIntelligent(e,t){const r=[];t.activeObjective&&r.push(t.activeObjective);for(const s of e){if(s.role!=="assistant")continue;const a=[/next.*(?:step|objective|goal).*[:is]\s*([^.!?\n]+)/i,/you (?:should|need to|must)\s+([^.!?\n]+)/i,/(?:focus on|head to|go to)\s+([^.!?\n]+)/i];for(const n of a){const c=s.content.match(n);if(c&&c[1]){const i=c[1].trim().substring(0,80);if(i&&!r.includes(i)&&(r.push(i),r.length>=3))break}}if(r.length>=3)break}return r}extractStrategicNotes(e){const t=[];for(const r of e){if(r.role!=="assistant")continue;const s=r.content.match(/[‚Ä¢\-\*]\s+[^\n]+/g);if(s)for(const a of s.slice(0,3))t.push(a.trim());if(t.length>=3)break}return t.join(`
`)}extractRecentActivity(e,t){const r=e.filter(s=>s.role==="assistant").slice(-t);return r.length===0?"‚Ä¢ No recent activity recorded":r.map(s=>{var c;const n=(((c=s.content.split(/[.!?]+/)[0])==null?void 0:c.trim())||"").replace(/\*\*/g,"").replace(/Hint:\s*/i,"").substring(0,80);return n?`‚Ä¢ ${n}...`:null}).filter(Boolean).join(`
`)}async storeSessionSummary(e,t){}async getLatestSessionSummary(e){return null}}const us=new hr,V=class V{static getInstance(){return V.instance||(V.instance=new V),V.instance}async getSubtabs(e){return this.getSubtabsFromTable(e)}async setSubtabs(e,t){console.error(`üîÑ [SubtabsService] Writing ${t.length} subtabs to normalized table for conversation:`,e);const r=await this.setSubtabsInTable(e,t);return console.error("  ‚úÖ Table write:",r?"SUCCESS":"FAILED"),r}async addSubtab(e,t){const{data:r,error:s}=await d.from("conversations").select("is_unreleased, title").eq("id",e).single();if(s)return console.error("Error checking conversation for unreleased status:",s),null;if(r!=null&&r.is_unreleased)throw new Error("Subtabs cannot be created for unreleased games. This feature will be available once the game is released.");return await this.addSubtabToTable(e,t)}async updateSubtab(e,t,r){return await this.updateSubtabInTable(t,r)}async deleteSubtab(e,t){return this.deleteSubtabFromTable(t)}async getSubtabsFromTable(e){try{const{data:t,error:r}=await d.from("subtabs").select("*").eq("conversation_id",e).order("order_index",{ascending:!0});return r?(console.error("Error getting subtabs from table:",r),[]):(t||[]).map(s=>{const a=typeof s.metadata=="object"&&s.metadata!==null?s.metadata:{};return{id:s.id,conversationId:s.conversation_id??void 0,title:s.title,content:s.content||"",type:s.tab_type,isNew:a.isNew||!1,status:a.status||"loaded",instruction:a.instruction}})}catch(t){return console.error("Error getting subtabs from table:",t),[]}}async setSubtabsInTable(e,t){try{const{data:r,error:s}=await d.from("conversations").select("*").eq("id",e).single(),a=r==null?void 0:r.auth_user_id;if(s||!a)return console.error("‚ùå [SubtabsService] Error getting conversation auth_user_id:",s),console.error("‚ùå [SubtabsService] Conversation may not exist yet. ConversationId:",e),!1;console.error(`üîÑ [SubtabsService] Using auth_user_id: ${a} for ${t.length} subtabs`);const{error:n}=await d.from("subtabs").delete().eq("conversation_id",e);if(n)return console.error("Error deleting existing subtabs:",n),!1;if(t.length>0){const c=t.map((l,u)=>(l.type||console.error(`‚ö†Ô∏è [SubtabsService] Subtab "${l.title}" has NULL type! Using fallback.`),{id:l.id,conversation_id:e,game_id:null,title:l.title||"Untitled",content:l.content||"",tab_type:l.type||"chat",order_index:u,auth_user_id:a,metadata:{isNew:l.isNew,status:l.status,instruction:l.instruction}}));console.error("üîÑ [SubtabsService] Inserting subtabs:",c.map(l=>({title:l.title,tab_type:l.tab_type,has_auth_user_id:!!l.auth_user_id})));const{error:i}=await d.from("subtabs").insert(c);if(i)return console.error("‚ùå [SubtabsService] Error inserting subtabs:",i),console.error("‚ùå [SubtabsService] Failed subtabs data:",JSON.stringify(c,null,2)),!1;console.error("‚úÖ [SubtabsService] Successfully inserted",t.length,"subtabs")}return!0}catch(r){return console.error("‚ùå [SubtabsService] Error setting subtabs in table:",r),!1}}async addSubtabToTable(e,t){var r;try{const{data:s}=await d.from("conversations").select("game_id").eq("id",e).single(),a=(s==null?void 0:s.game_id)||"",{data:n}=await d.from("subtabs").select("order_index").eq("conversation_id",e).order("order_index",{ascending:!1}).limit(1),c=((r=n==null?void 0:n[0])==null?void 0:r.order_index)??-1,{data:i,error:l}=await d.from("subtabs").insert({id:t.id,conversation_id:e,game_id:a,title:t.title,content:t.content,tab_type:t.type,order_index:c+1,metadata:{isNew:t.isNew,status:t.status,instruction:t.instruction}}).select().single();return l?(console.error("Error adding subtab to table:",l),null):{id:i.id,conversationId:i.conversation_id??void 0,title:i.title,content:Ee(i.content),type:i.tab_type,isNew:typeof i.metadata=="object"&&i.metadata!==null&&!Array.isArray(i.metadata)&&i.metadata.isNew||!1,status:(typeof i.metadata=="object"&&i.metadata!==null&&!Array.isArray(i.metadata)?i.metadata.status:void 0)||"loaded",instruction:typeof i.metadata=="object"&&i.metadata!==null&&!Array.isArray(i.metadata)?i.metadata.instruction:void 0}}catch(s){return console.error("Error adding subtab to table:",s),null}}async updateSubtabInTable(e,t){try{const r={};if(t.title!==void 0&&(r.title=t.title),t.content!==void 0&&(r.content=t.content),t.type!==void 0&&(r.tab_type=t.type),t.isNew!==void 0||t.status!==void 0||t.instruction!==void 0){const{data:a}=await d.from("subtabs").select("metadata").eq("id",e).single(),n=typeof(a==null?void 0:a.metadata)=="object"&&(a==null?void 0:a.metadata)!==null?a.metadata:{};r.metadata={...n,...t.isNew!==void 0&&{isNew:t.isNew},...t.status!==void 0&&{status:t.status},...t.instruction!==void 0&&{instruction:t.instruction}}}const{error:s}=await d.from("subtabs").update(r).eq("id",e);return s?(console.error("Error updating subtab in table:",s),!1):!0}catch(r){return console.error("Error updating subtab in table:",r),!1}}async deleteSubtabFromTable(e){try{const{error:t}=await d.from("subtabs").delete().eq("id",e);return t?(console.error("Error deleting subtab from table:",t),!1):!0}catch(t){return console.error("Error deleting subtab from table:",t),!1}}async getSubtabsFromJsonb(e){try{const{data:t,error:r}=await d.from("conversations").select("subtabs").eq("id",e).single();return r?(console.error("Error getting subtabs from JSONB:",r),[]):(t==null?void 0:t.subtabs)||[]}catch(t){return console.error("Error getting subtabs from JSONB:",t),[]}}async setSubtabsInJsonb(e,t){try{const{error:r}=await d.from("conversations").update({subtabs:t,subtabs_order:t.map(s=>s.id)}).eq("id",e);return r?(console.error("Error setting subtabs in JSONB:",r),!1):!0}catch(r){return console.error("Error setting subtabs in JSONB:",r),!1}}async migrateConversationSubtabs(e){try{const t=await this.getSubtabsFromJsonb(e);return t.length===0?!0:await this.setSubtabsInTable(e,t)}catch(t){return console.error("Error migrating subtabs:",t),!1}}async rollbackConversationSubtabs(e){try{const t=await this.getSubtabsFromTable(e);return t.length===0?!0:await this.setSubtabsInJsonb(e,t)}catch(t){return console.error("Error rolling back subtabs:",t),!1}}async migrateAllSubtabs(){try{const{data:e,error:t}=await d.from("conversations").select("id, subtabs").not("subtabs","is",null);if(t)return console.error("Error fetching conversations:",t),{success:0,failed:0};let r=0,s=0;const a=(e||[]).filter(c=>c.subtabs&&Array.isArray(c.subtabs)&&c.subtabs.length>0).map(c=>this.migrateConversationSubtabs(c.id));return(await Promise.allSettled(a)).forEach(c=>{c.status==="fulfilled"&&c.value?r++:s++}),{success:r,failed:s}}catch(e){return console.error("Error in batch migration:",e),{success:0,failed:0}}}};f(V,"instance");let Ne=V;const q=Ne.getInstance();function be(){var o;return((o=globalThis.crypto)==null?void 0:o.randomUUID())||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}class pr{async createGameTab(e){var c,i,l;const t=await E.getConversation(e.conversationId);if(t){if(e.aiResponse&&((c=t.subtabs)!=null&&c.some(u=>u.status==="loading"||u.content==="Loading..."))){const u=this.extractInsightsFromAIResponse(e.aiResponse,t.subtabs);return await E.updateConversation(t.id,{subtabs:u,updatedAt:Date.now()}),{...t,subtabs:u}}return t}const r=e.userTier||"free",s=r==="pro"||r==="vanguard_pro";console.log("üéÆ [GameTabService] Creating new game tab:",{gameTitle:e.gameTitle,userTier:r,isPro:s,isUnreleased:e.isUnreleased,hasAiResponse:!!e.aiResponse});let a=[];if(!e.isUnreleased&&s)if(e.aiResponse)if(console.error("üéÆ [GameTabService] Extracting subtabs from AI response"),(i=e.aiResponse.gamePillData)!=null&&i.wikiContent&&Object.keys(e.aiResponse.gamePillData.wikiContent).length>0)console.error("üéÆ [GameTabService] Found gamePillData.wikiContent with",Object.keys(e.aiResponse.gamePillData.wikiContent).length,"tabs"),a=Object.entries(e.aiResponse.gamePillData.wikiContent).map(([u,m])=>({id:be(),title:this.formatTabTitle(u),type:this.determineTabType(u),content:m,isNew:!1,status:"loaded"})),console.error("üéÆ [GameTabService] Created",a.length,"subtabs from gamePillData.wikiContent");else if(e.aiResponse.progressiveInsightUpdates&&e.aiResponse.progressiveInsightUpdates.length>0)console.error("üéÆ [GameTabService] Found progressiveInsightUpdates with",e.aiResponse.progressiveInsightUpdates.length,"updates"),a=e.aiResponse.progressiveInsightUpdates.map(u=>({id:be(),title:u.title,type:this.determineTabType(u.tabId),content:u.content,isNew:!1,status:"loaded"})),console.error("üéÆ [GameTabService] Created",a.length,"subtabs from progressiveInsightUpdates");else{const u=this.extractInsightsFromAIResponse(e.aiResponse,[]);u.length>0?(a=u,console.error("üéÆ [GameTabService] Created",a.length,"subtabs from INSIGHT_UPDATE tags")):(a=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile),console.error("üéÆ [GameTabService] Created",a.length,"template subtabs (will populate via background AI using conversation context)"))}else a=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile),console.error("üéÆ [GameTabService] Created",a.length,"initial template subtabs (no AI response)");else e.isUnreleased?console.error("üéÆ [GameTabService] Creating unreleased game tab (no subtabs, Discuss mode only)"):console.error("üîí [GameTabService] Subtabs disabled for free tier users");const n={id:e.conversationId,title:e.gameTitle,messages:[],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,gameId:e.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:e.gameTitle,genre:e.genre,subtabs:a,subtabsOrder:a.map(u=>u.id),isActiveSession:!0,activeObjective:"",gameProgress:0,isUnreleased:e.isUnreleased||!1};return await E.addConversation(n),a.length>0&&s?(console.error("üéÆ [GameTabService] Saving",a.length,"subtabs for conversation:",n.id),console.error("üéÆ [GameTabService] Subtabs:",JSON.stringify(a.map(m=>({id:m.id,title:m.title,type:m.type,hasType:!!m.type})),null,2)),await new Promise(m=>setTimeout(m,200)),await q.setSubtabs(n.id,a)||console.error("‚ùå [GameTabService] Failed to save subtabs - conversation may not exist yet")):s?console.error("üéÆ [GameTabService] No subtabs to save for conversation:",n.id):console.error("üîí [GameTabService] Skipping subtabs save for free tier user"),s?e.aiResponse?(l=n.subtabs)!=null&&l.some(m=>m.content==="Loading...")&&this.generateInitialInsights(n,e.playerProfile,e.aiResponse).catch(m=>console.error("Background insight generation failed:",m)):this.generateInitialInsights(n,e.playerProfile,e.aiResponse).catch(u=>console.error("Background insight generation failed:",u)):console.error("üîí [GameTabService] Skipping AI insight generation for free tier user"),n}generateInitialSubTabs(e,t,r){let a=(Fe[e]||Fe.Default).map(n=>({...n,priority:"medium",isProfileSpecific:!1}));if(t){console.error("üéÆ [GameTabService] Generating profile-specific tabs for:",t.playerFocus);const n=te.generateProfileSpecificTabs(t,r);a=[...a,...n],a=te.prioritizeTabsForProfile(a,t)}return a.map(n=>({id:be(),title:n.title,type:n.type,content:"Loading...",isNew:!0,status:"loading",instruction:n.instruction}))}extractInsightsFromAIResponse(e,t){console.error("ü§ñ [GameTabService] Extracting dynamic insights from AI response");const r=e.otakonTags.get("INSIGHT_UPDATE");if(r){console.error("ü§ñ [GameTabService] Found INSIGHT_UPDATE:",r);const s=r;if(!s.id)return console.error("ü§ñ [GameTabService] INSIGHT_UPDATE missing id, skipping"),t;if(t.find(n=>n.id===s.id))return t.map(n=>n.id===s.id?{...n,content:s.content||n.content,isNew:!0,status:"loaded"}:n);{const n={id:be(),title:this.formatTabTitle(s.id),type:this.determineTabType(s.id),content:s.content||"",isNew:!0,status:"loaded"};return[...t,n]}}return t}formatTabTitle(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}determineTabType(e){return e.includes("story")?"story":e.includes("character")?"characters":e.includes("strategy")||e.includes("tips")?"tips":e.includes("boss")?"strategies":e.includes("quest")||e.includes("walkthrough")?"walkthrough":e.includes("item")?"items":"chat"}async generateInitialInsights(e,t,r){var n,c,i;const s=e.id,a=e.gameTitle;console.error(`ü§ñ [GameTabService] üîÑ [${s}] Generating initial insights for: ${a}`);try{const l=await E.getConversations(!0);if(!l[s]){console.error(`ü§ñ [GameTabService] [${s}] ‚ö†Ô∏è Conversation no longer exists, aborting insight generation`);return}let u="";const m=l[s],h=((n=m.messages)==null?void 0:n.length)||0;if(h>10)try{const y=await Et.loadConversationSummary(s),A=m.messages.slice(-5).map(k=>`${k.role==="user"?"User":"AI"}: ${k.content}`).join(`

`);y?(u=`Previous Context Summary:
${JSON.stringify(y)}

Recent Messages (guaranteed fresh):
${A}`,console.error(`ü§ñ [GameTabService] [${s}] ‚úÖ Using summary + 5 recent messages (${h} total msgs)`)):(u=m.messages.slice(-10).map(k=>`${k.role==="user"?"User":"AI"}: ${k.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${s}] Using last 10 messages (no summary available)`))}catch{u=m.messages.slice(-10).map(A=>`${A.role==="user"?"User":"AI"}: ${A.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${s}] Using last 10 messages (summary load failed)`)}else h>0?(u=m.messages.map(y=>`${y.role==="user"?"User":"AI"}: ${y.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${s}] ‚úÖ Using all ${h} messages`)):r!=null&&r.content?(u=`AI Analysis: ${r.content}`,console.error(`ü§ñ [GameTabService] [${s}] Using AI response as context (${r.content.length} chars)`)):console.error(`ü§ñ [GameTabService] [${s}] ‚ö†Ô∏è No context available`);console.error(`ü§ñ [GameTabService] [${s}] üöÄ Calling AI generateInitialInsights...`);const T=await Ve.generateInitialInsights(a||"Unknown Game",e.genre||"Action RPG",t,u);console.error(`ü§ñ [GameTabService] [${s}] üì• AI returned:`,Object.keys(T).length,"insights");const L=T&&Object.keys(T).length>0;L?console.error(`ü§ñ [GameTabService] [${s}] ‚úÖ Got ${Object.keys(T).length} insights:`,Object.keys(T)):console.error(`ü§ñ [GameTabService] [${s}] ‚ùå Empty insights, using fallback`);const p=l[s];if(!p){console.error(`ü§ñ [GameTabService] [${s}] ‚ö†Ô∏è Conversation not found, may have been deleted`);return}const g=await q.getSubtabs(s);console.error(`ü§ñ [GameTabService] [${s}] üìñ Read ${g.length} subtabs from database`),p.subtabs=g;const v={"Story So Far":"story_so_far","Relevant Lore":"game_lore","Lore Exploration":"lore_exploration","Environmental Storytelling":"environmental_storytelling","Active Quests":"quest_log","Story Progression":"story_progression","Quest Guide":"quest_guide","Build Optimization":"build_optimization","Build Guide":"build_guide","Character Building":"character_building","Combat Strategies":"combat_strategies","Boss Strategy":"boss_strategy","Upcoming Boss Strategy":"boss_strategy","Consumable Strategy":"consumable_strategy","Hidden Paths & Secrets":"hidden_paths","Pro Tips":"pro_tips","Exploration Tips":"exploration_tips","Hidden Secrets":"hidden_secrets","Items You May Have Missed":"missed_items","Collectible Hunting":"collectible_hunting","Points of Interest":"points_of_interest","Region Guide":"points_of_interest","Plan Your Next Session":"next_session_plan","Activity Checklist":"next_session_plan","Dynamic World Events":"points_of_interest","Exploration Route":"exploration_route","Fast Travel Optimization":"pro_tips","Progression Balance":"next_session_plan","Death Recovery Strategy":"death_recovery","NPC Questlines":"npc_questlines","Level Layout Insights":"level_layout","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","NPC Interactions":"npc_interactions","New Ability Unlocked":"ability_unlocks","Backtracking Guide":"backtracking_guide","Map Completion":"map_completion","Sequence Breaking Options":"sequence_breaking","Upgrade Priority":"upgrade_priority","Resource Locations":"resource_locations","Base Building Guide":"base_building","Crafting Priority":"crafting_priority","Survival Tips":"survival_tips","Exploration Targets":"exploration_targets","Progression Roadmap":"progression_roadmap","Danger Warnings":"danger_warnings","Multiplayer Synergy":"multiplayer_synergy","Seasonal Preparation":"seasonal_preparation","Resource Management":"resource_management","Safe Zone Mapping":"safe_zone_mapping","Sanity Management":"sanity_management","Progressive Fear Adaptation":"fear_adaptation","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Puzzle Solving":"puzzle_solving","Inventory Optimization":"inventory_optimization"};console.error("ü§ñ [GameTabService] Building content mapping for subtabs...");const O=((c=p.subtabs)==null?void 0:c.map(y=>{let A="";const k=v[y.title];if(L&&k&&T[k]&&(A=T[k],console.error(`ü§ñ [GameTabService] Subtab "${y.title}" using AI content from key "${k}" (${A.length} chars)`)),!A){let de=u;if(y.type==="story"&&u.includes("Lore:")){const x=u.match(/Lore:(.*?)(?=\n\n|\n[A-Z]|$)/s);de=x?x[1].trim():u}else if(y.type==="strategies"&&u.includes("Analysis:")){const x=u.match(/Analysis:(.*?)(?=\n\n|\n[A-Z]|$)/s);de=x?x[1].trim():u}else if(y.type==="tips"&&u.includes("Hint:")){const x=u.match(/Hint:(.*?)(?=\n\n|\n[A-Z]|$)/s);de=x?x[1].trim():u}A=`## ${y.title}

${de}`,console.error(`ü§ñ [GameTabService] Subtab "${y.title}" using fallback content from AI response (${A.length} chars)`),console.error("ü§ñ [GameTabService] Preview:",A.substring(0,150)+"...")}return{...y,content:A,isNew:!1,status:"loaded",type:y.type}}))||[];console.error("ü§ñ [GameTabService] Updating subtabs with content...");const N=O.map(y=>{var A;return{id:y.id,title:y.title,type:y.type,status:y.status,contentLength:((A=y.content)==null?void 0:A.length)||0,isNew:y.isNew,hasType:!!y.type}});if(console.error("ü§ñ [GameTabService] Subtabs to save:",N),console.error("ü§ñ [GameTabService] ALL statuses:",O.map(y=>y.status)),console.error("ü§ñ [GameTabService] ALL types:",O.map(y=>y.type||"MISSING_TYPE")),console.error("ü§ñ [GameTabService] üóëÔ∏è Clearing cache BEFORE subtabs write..."),E.clearCache(),!await q.setSubtabs(e.id,O))throw new Error("Failed to update subtabs in database");console.error("ü§ñ [GameTabService] ‚úÖ Subtabs dual-write complete (table + JSONB)"),E.clearCache(),console.error("ü§ñ [GameTabService] üîç Subtabs saved successfully, skipping verification read"),await E.updateConversation(e.id,{updatedAt:Date.now()}),console.error("ü§ñ [GameTabService] ‚úÖ Conversation metadata updated")}catch(l){console.error("ü§ñ [GameTabService] ‚ùå Failed to generate initial insights:",l),ee.warning("Failed to load game insights. You can still chat about the game!");try{const m=(await E.getConversations(!0))[e.id];if(!m){console.error("ü§ñ [GameTabService] Conversation not found for error update:",e.id);return}const h=((i=m.subtabs)==null?void 0:i.map(T=>({...T,content:`Failed to load ${T.title} content. Please try again later.`,isNew:!1,status:"error"})))||[];await q.setSubtabs(e.id,h),await E.updateConversation(e.id,{updatedAt:Date.now()})}catch(u){console.error("ü§ñ [GameTabService] Failed to update error state:",u)}}}async updateSubTabContent(e,t,r){console.error("üìù [GameTabService] Updating sub-tab content:",{conversationId:e,subTabId:t});try{const a=(await E.getConversations())[e];if(!a||!a.subtabs)throw new Error("Conversation or sub-tabs not found");const n=a.subtabs.map(c=>c.id===t?{...c,content:r,isNew:!1,status:"loaded"}:c);await q.setSubtabs(e,n),await E.updateConversation(e,{updatedAt:Date.now()})}catch(s){throw console.error("Failed to update sub-tab content:",s),s}}async getGameTab(e){try{const r=(await E.getConversations())[e];return!r||!r.gameTitle?null:{id:r.id,title:r.title,gameId:r.gameId||r.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:r.gameTitle,genre:r.genre||"Unknown",subtabs:r.subtabs||[],createdAt:r.createdAt,updatedAt:r.updatedAt,isActiveSession:r.isActiveSession||!1}}catch(t){return console.error("Failed to get game tab:",t),ee.error("Failed to load game tab."),null}}isGameTab(e){return!e.isGameHub&&!!e.gameTitle}generateGameConversationId(e){return`game-${e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-")}`}async updateSubtabsAfterMigration(e,t){console.error(`üîÑ [GameTabService] [${e}] Updating subtabs after migration...`);try{const s=(await E.getConversations(!0))[e];if(!s){console.error(`üîÑ [GameTabService] [${e}] ‚ö†Ô∏è Conversation not found, aborting`);return}if(!s.subtabs||s.subtabs.length===0){console.error(`üîÑ [GameTabService] [${e}] No subtabs to update`);return}t!=null&&t.progressiveInsightUpdates&&t.progressiveInsightUpdates.length>0?(console.error(`üîÑ [GameTabService] [${e}] Applying ${t.progressiveInsightUpdates.length} progressive updates`),await this.updateSubTabsFromAIResponse(e,t.progressiveInsightUpdates)):console.error(`üîÑ [GameTabService] [${e}] No progressive updates in AI response`),console.error(`üîÑ [GameTabService] [${e}] ‚úÖ Subtab update complete`)}catch(r){console.error(`üîÑ [GameTabService] [${e}] ‚ùå Failed to update subtabs:`,r)}}async updateSubTabsFromAIResponse(e,t){console.error(`üìù [GameTabService] [${e}] Updating subtabs from AI response:`,t.length);try{const s=(await E.getConversations(!0))[e];if(!s||!s.subtabs){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Conversation or subtabs not found, aborting update`);return}let a=0;const n=s.subtabs.map(i=>{const l=t.find(u=>u.tabId===i.id);if(l){a++,console.error(`üìù [GameTabService] [${e}] Updating subtab: ${i.id} - ${l.title}`);const m=`

---
**Updated: `+new Date().toLocaleString()+`**

`,T=i.content&&i.content.trim().length>0&&i.content!=="Loading..."&&i.status==="loaded"?i.content+m+l.content:l.content;return{...i,title:l.title||i.title,content:T,isNew:!0,status:"loaded"}}return i});if(a===0){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è No subtabs matched for update`);return}if(console.error(`üìù [GameTabService] [${e}] Writing ${a} updated subtabs to normalized table...`),!await q.setSubtabs(e,n))throw console.error(`üìù [GameTabService] [${e}] ‚ùå Failed to write subtabs to table`),new Error("Failed to update subtabs in database");E.clearCache(),await E.updateConversation(e,{updatedAt:Date.now()}),console.error(`üìù [GameTabService] [${e}] ‚úÖ Updated ${a} subtabs successfully (table + cache cleared)`)}catch(r){throw console.error(`üìù [GameTabService] [${e}] ‚ùå Failed to update subtabs:`,r),r}}async generateSubtabsForExistingGameTabs(e,t,r){const s=Object.values(e).filter(a=>!a.isGameHub&&!a.isUnreleased&&a.gameTitle&&(!a.subtabs||a.subtabs.length===0));if(s.length===0){console.log("üîÑ [GameTabService] No game tabs need subtabs generation");return}console.log(`üîÑ [GameTabService] Found ${s.length} game tabs that need subtabs`);for(let a=0;a<s.length;a++){const n=s[a];try{console.log(`üîÑ [GameTabService] Generating subtabs for "${n.gameTitle}" (${a+1}/${s.length})`),r==null||r(a,s.length,n.gameTitle||n.title);const c=this.generateInitialSubTabs(n.genre||"Default",t);await E.updateConversation(n.id,{subtabs:c,subtabsOrder:c.map(i=>i.id),updatedAt:Date.now()}),await q.setSubtabs(n.id,c),await this.generateInitialInsights({...n,subtabs:c},t),console.log(`‚úÖ [GameTabService] Successfully generated subtabs for "${n.gameTitle}"`),a<s.length-1&&await new Promise(i=>setTimeout(i,1e3))}catch(c){console.error(`‚ùå [GameTabService] Failed to generate subtabs for "${n.gameTitle}":`,c)}}r==null||r(s.length,s.length,"Complete"),console.log(`üîÑ [GameTabService] Finished generating subtabs for ${s.length} game tabs`)}}const ds=new pr,H=o=>o;class gs{static getCurrentUser(){return B.get(F.USER,null)}static setCurrentUser(e){B.set(F.USER,e)}static createUser(e,t=gt.FREE){const r=Date.now(),s=Be[t];return{id:`user_${r}`,authUserId:`user_${r}`,email:e,tier:t,hasProfileSetup:!1,hasSeenSplashScreens:!1,hasSeenHowToUse:!1,hasSeenFeaturesConnected:!1,hasSeenProFeatures:!1,pcConnected:!1,pcConnectionSkipped:!1,onboardingCompleted:!1,hasWelcomeMessage:!1,isNewUser:!0,hasUsedTrial:!1,lastActivity:r,preferences:{},textCount:0,imageCount:0,textLimit:s.text,imageLimit:s.image,totalRequests:0,lastReset:r,usage:{textCount:0,imageCount:0,textLimit:s.text,imageLimit:s.image,totalRequests:0,lastReset:r,tier:t},appState:{},profileData:{},onboardingData:{},behaviorData:{},feedbackData:{},usageData:{},createdAt:r,updatedAt:r}}static updateUser(e){const t=this.getCurrentUser();if(!t)return;const r={...t,...e,updatedAt:Date.now()};this.setCurrentUser(r)}static updateUsage(e){const t=this.getCurrentUser();t&&this.updateUser({usage:{...t.usage,...e}})}static resetUsage(){const e=this.getCurrentUser();if(!e)return;const t=Be[e.tier];this.updateUsage({textCount:0,imageCount:0,totalRequests:0,lastReset:Date.now(),textLimit:t.text,imageLimit:t.image})}static canMakeRequest(e){const t=this.getCurrentUser();if(!t)return!1;const{usage:r}=t;return e==="text"?r.textCount<r.textLimit:r.imageCount<r.imageLimit}static incrementUsage(e){const t=this.getCurrentUser();if(!t)return;const r={totalRequests:t.usage.totalRequests+1};e==="text"?r.textCount=t.usage.textCount+1:r.imageCount=t.usage.imageCount+1,this.updateUsage(r)}static logout(){B.remove(F.USER)}static async getCurrentUserAsync(){try{const e=B.get(F.USER,null),{data:{user:t},error:r}=await d.auth.getUser();if(r||!t)return e;const{data:s,error:a}=await d.from("users").select("*").eq("auth_user_id",t.id).single();if(a||!s)return console.error("Failed to fetch user from Supabase:",a),e;const n={id:s.id,authUserId:s.auth_user_id,email:s.email,tier:s.tier,textCount:s.text_count||0,imageCount:s.image_count||0,textLimit:me(s.text_limit),imageLimit:me(s.image_limit),totalRequests:s.total_requests||0,lastReset:Z(s.last_reset),hasProfileSetup:s.has_profile_setup||!1,hasSeenSplashScreens:s.has_seen_splash_screens||!1,hasSeenHowToUse:s.has_seen_how_to_use||!1,hasSeenFeaturesConnected:s.has_seen_features_connected||!1,hasSeenProFeatures:s.has_seen_pro_features||!1,pcConnected:s.pc_connected||!1,pcConnectionSkipped:s.pc_connection_skipped||!1,onboardingCompleted:s.onboarding_completed||!1,hasWelcomeMessage:s.has_welcome_message||!1,isNewUser:s.is_new_user||!1,hasUsedTrial:s.has_used_trial||!1,lastActivity:Z(s.updated_at),preferences:M(s.preferences),usage:{textCount:s.text_count||0,imageCount:s.image_count||0,textLimit:me(s.text_limit),imageLimit:me(s.image_limit),totalRequests:s.total_requests||0,lastReset:Z(s.last_reset),tier:s.tier},appState:M(s.app_state),profileData:M(s.profile_data),onboardingData:M(s.onboarding_data),behaviorData:M(s.behavior_data),feedbackData:M(s.feedback_data),usageData:M(s.usage_data),createdAt:Z(s.created_at),updatedAt:Z(s.updated_at)};return B.set(F.USER,n),n}catch(e){return console.error("Error in getCurrentUserAsync:",e),B.get(F.USER,null)}}static async setCurrentUserAsync(e){try{B.set(F.USER,e);const{error:t}=await d.from("users").update({tier:e.tier,text_count:e.textCount,image_count:e.imageCount,text_limit:e.textLimit,image_limit:e.imageLimit,total_requests:e.totalRequests,last_reset:new Date(e.lastReset).toISOString(),has_profile_setup:e.hasProfileSetup,has_seen_splash_screens:e.hasSeenSplashScreens,has_seen_how_to_use:e.hasSeenHowToUse,has_seen_features_connected:e.hasSeenFeaturesConnected,has_seen_pro_features:e.hasSeenProFeatures,pc_connected:e.pcConnected,pc_connection_skipped:e.pcConnectionSkipped,onboarding_completed:e.onboardingCompleted,has_welcome_message:e.hasWelcomeMessage,has_used_trial:e.hasUsedTrial,preferences:H(e.preferences),profile_data:H(e.profileData),app_state:H(e.appState),onboarding_data:H(e.onboardingData),behavior_data:H(e.behaviorData),feedback_data:H(e.feedbackData),usage_data:H(e.usageData),updated_at:new Date().toISOString()}).eq("auth_user_id",e.authUserId);t&&console.error("Failed to sync user to Supabase:",t)}catch(t){console.error("Error in setCurrentUserAsync:",t)}}static async updateUsageAsync(e){const t=await this.getCurrentUserAsync();if(!t)return;const r={...t,usage:{...t.usage,...e},textCount:e.textCount??t.textCount,imageCount:e.imageCount??t.imageCount,totalRequests:e.totalRequests??t.totalRequests,lastReset:e.lastReset??t.lastReset,updatedAt:Date.now()};await this.setCurrentUserAsync(r)}}class fr{hasTabCommand(e){return/^@\w+/.test(e.trim())}parseTabCommand(e,t){const r=e.trim();if(!this.hasTabCommand(r))return null;const s=r.match(/^@(\w+)\s*(\\modify|\\delete)?\s*(.*)$/);if(!s)return null;const[,a,n,c]=s,i=this.findMatchingTab(a,t.subtabs||[]);if(!i)return null;let l;return n==="\\delete"?l="delete":n==="\\modify"?l="modify":l="update",{type:l,tabId:i.id,tabName:i.title,instruction:c.trim()}}findMatchingTab(e,t){const r=this.normalizeTabName(e);let s=t.find(a=>this.normalizeTabName(a.id)===r||this.normalizeTabName(a.title)===r);return s||(s=t.find(a=>this.normalizeTabName(a.id).includes(r)||this.normalizeTabName(a.title).includes(r)),s)?s:(s=t.find(a=>r.includes(this.normalizeTabName(a.id))||r.includes(this.normalizeTabName(a.title))),s||null)}normalizeTabName(e){return e.toLowerCase().replace(/[_\s-]+/g,"").replace(/[^a-z0-9]/g,"")}getAvailableTabNames(e){return!e.subtabs||e.subtabs.length===0?[]:e.subtabs.map(t=>({id:t.id,title:t.title}))}formatTabSuggestion(e,t){return`@${e}`}getCommandHelp(){return`
**Tab Commands:**
‚Ä¢ @<tab> <text> - Update tab with new info
‚Ä¢ @<tab> \\modify <text> - Modify/rename tab
‚Ä¢ @<tab> \\delete - Delete tab

Example: @story_so_far The player defeated the first boss
    `.trim()}validateCommand(e){switch(e.type){case"update":if(!e.instruction)return{valid:!1,error:"Update command requires content. Example: @story_so_far The player..."};break;case"modify":if(!e.instruction)return{valid:!1,error:"Modify command requires instructions. Example: @tips \\modify Change to combat strategies"};break}return{valid:!0}}describeCommand(e){switch(e.type){case"update":return`Updating "${e.tabName}" with: ${e.instruction}`;case"modify":return`Modifying "${e.tabName}": ${e.instruction}`;case"delete":return`Deleting "${e.tabName}"`}}}const ms=new fr;let S,Q=[],je=!1,le="",ne=null,U=null,I=null,Me=!1,$=null;const Sr="otakonSpeechRate",$e=async()=>{try{const o=navigator;o.wakeLock&&(ne=await o.wakeLock.request("screen"),console.log("üîí [TTS] Wake lock acquired - screen will stay on"),ne.addEventListener("release",()=>{console.log("üîì [TTS] Wake lock released"),S&&S.speaking&&!Me&&$e()}))}catch(o){console.warn("‚ö†Ô∏è [TTS] Wake lock not available:",o)}},at=async()=>{try{ne!==null&&(await ne.release(),ne=null)}catch{}},yr=()=>{try{if(!U){const o=window,e=o.AudioContext||o.webkitAudioContext;e&&(U=new e,console.log("üîä [TTS] Audio context initialized"))}I||(I=new Audio,I.src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleShtr9teleShtr9teleShtr9teleShtr9t",I.loop=!0,I.volume=.01,I.load(),console.log("üîá [TTS] Silent audio initialized for background playback"))}catch(o){console.warn("‚ö†Ô∏è [TTS] Audio context init failed:",o)}},ot=async()=>{try{U&&U.state==="suspended"&&(await U.resume(),console.log("üîä [TTS] Audio context resumed")),I&&(I.currentTime=0,await I.play(),console.log("üîá [TTS] Silent audio playing for background session")),$||($=setInterval(()=>{S&&S.speaking?U&&U.state==="suspended"&&U.resume().catch(()=>{}):$&&(clearInterval($),$=null)},5e3))}catch(o){console.warn("‚ö†Ô∏è [TTS] Silent audio start failed:",o)}},nt=()=>{try{I&&(I.pause(),I.currentTime=0,console.log("üîá [TTS] Silent audio stopped")),$&&(clearInterval($),$=null)}catch(o){console.warn("‚ö†Ô∏è [TTS] Silent audio stop failed:",o)}},br=()=>new Promise((o,e)=>{if(!S)return e(new Error("Speech synthesis not initialized."));if(Q=S.getVoices(),Q.length>0){o();return}S.onvoiceschanged=()=>{Q=S.getVoices(),o()},setTimeout(()=>{Q.length===0&&(Q=S.getVoices()),o()},1e3)}),ue=()=>{S&&S.speaking&&S.cancel(),le="","mediaSession"in navigator&&navigator.mediaSession.playbackState!=="none"&&(navigator.mediaSession.playbackState="paused"),at(),nt(),window.dispatchEvent(new CustomEvent("otakon:ttsStopped"))},_r=()=>{S&&S.speaking&&!S.paused&&(S.pause(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="paused"),window.dispatchEvent(new CustomEvent("otakon:ttsPaused")))},vr=()=>{S&&S.paused&&(S.resume(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="playing"),window.dispatchEvent(new CustomEvent("otakon:ttsResumed")))},wr=async()=>{le&&(ue(),await ct(le))},Tr=()=>S?S.speaking:!1,ze=()=>{ue(),window.dispatchEvent(new CustomEvent("otakon:disableHandsFree"))},Er=()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{}),navigator.mediaSession.setActionHandler("pause",ze),navigator.mediaSession.setActionHandler("stop",ze))},Ar=async()=>{document.hidden?(Me=!0,console.log("üì± [TTS] App went to background, isSpeaking:",S==null?void 0:S.speaking),S&&S.speaking&&(await ot(),S.paused||setTimeout(()=>{S&&S.speaking&&!S.paused&&console.log("üì± [TTS] Nudging speech synthesis to stay alive")},100))):(Me=!1,console.log("üì± [TTS] App came to foreground, isSpeaking:",S==null?void 0:S.speaking),S&&S.speaking&&await $e())},Cr=async()=>{if(typeof window<"u"&&"speechSynthesis"in window){if(je)return;je=!0,S=window.speechSynthesis,await br(),Er(),yr(),document.addEventListener("visibilitychange",Ar),S.getVoices().length===0&&S.speak(new SpeechSynthesisUtterance(""))}},it=()=>Q.filter(o=>o.lang.startsWith("en-")),ct=async o=>new Promise((e,t)=>{try{if(!S)return console.error("Text-to-Speech is not available on this browser."),t(new Error("Text-to-Speech is not available on this browser."));if(!o.trim())return e();ue(),le=o;const r=new SpeechSynthesisUtterance(o),s=localStorage.getItem(Sr);r.rate=s?parseFloat(s):.94;const a=localStorage.getItem("otakonPreferredVoiceURI"),n=it();let c;if(a&&(c=n.find(i=>i.voiceURI===a)),!c&&n.length>0){const i=n.find(l=>l.name.toLowerCase().includes("female"));i?c=i:c=n[0]}c&&(r.voice=c),r.onstart=async()=>{await $e(),await ot(),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"TTS_STARTED"}),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="playing",navigator.mediaSession.metadata=new MediaMetadata({title:o.length>50?o.substring(0,50)+"...":o,artist:"Your AI Gaming Companion",album:"Otakon",artwork:[{src:"/icon-192.png",sizes:"192x192",type:"image/png"},{src:"/icon-512.png",sizes:"512x512",type:"image/png"}]})),window.dispatchEvent(new CustomEvent("otakon:ttsStarted"))},r.onend=()=>{le="","mediaSession"in navigator&&(navigator.mediaSession.playbackState="paused"),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"TTS_STOPPED"}),at(),nt(),window.dispatchEvent(new CustomEvent("otakon:ttsStopped")),e()},r.onerror=i=>{console.error("SpeechSynthesis Utterance Error",i),ue(),t(i)},S.speak(r)}catch(r){console.error("TTS Error:",r),t(r)}}),hs={init:Cr,getAvailableVoices:it,speak:ct,cancel:ue,pause:_r,resume:vr,restart:wr,isSpeaking:Tr};class Ye{static async acquireMigrationLock(e,t){const r=[e,t].sort().join("|");return this.activeMigrations.has(r)?(console.warn("üîí [MessageRouting] Migration already in progress:",r),!1):(this.activeMigrations.add(r),setTimeout(()=>{this.activeMigrations.delete(r)},this.LOCK_TIMEOUT),!0)}static releaseMigrationLock(e,t){const r=[e,t].sort().join("|");this.activeMigrations.delete(r)}static async migrateMessagesAtomic(e,t,r){var a,n,c,i;if(console.error("üì¶ [MessageRouting] Migration requested:",{messageIds:e,from:t,to:r}),!await this.acquireMigrationLock(t,r)){console.warn("‚ö†Ô∏è [MessageRouting] Skipping migration - another migration in progress");return}try{console.error("üì¶ [MessageRouting] Lock acquired, starting migration");const l=await E.getConversations(!1);console.error("üì¶ [MessageRouting] Loaded conversations:",Object.keys(l));const u=l[t],m=l[r];if(!u)throw console.error("üì¶ [MessageRouting] Source conversation not found:",t),console.error("üì¶ [MessageRouting] Available conversations:",Object.keys(l)),new Error(`Source conversation ${t} not found`);if(!m)throw console.error("üì¶ [MessageRouting] Destination conversation not found:",r),console.error("üì¶ [MessageRouting] Available conversations:",Object.keys(l)),new Error(`Destination conversation ${r} not found`);console.error("üì¶ [MessageRouting] Source messages:",(a=u.messages)==null?void 0:a.map(g=>({id:g.id,role:g.role}))),console.error("üì¶ [MessageRouting] Destination messages before:",(n=m.messages)==null?void 0:n.map(g=>({id:g.id,role:g.role})));const h=u.messages.filter(g=>e.includes(g.id));if(console.error("üì¶ [MessageRouting] Messages to move:",h.map(g=>({id:g.id,role:g.role}))),h.length===0){console.error("üì¶ [MessageRouting] No messages found to migrate");return}const T=h.filter(g=>!m.messages.some(v=>v.id===g.id));console.error("üì¶ [MessageRouting] Messages to add (after duplicate check):",T.map(g=>({id:g.id,role:g.role})));const{FEATURE_FLAGS:L}=await We(async()=>{const{FEATURE_FLAGS:g}=await import("./chat-services-C6NMpE6f.js").then(v=>v.c);return{FEATURE_FLAGS:g}},__vite__mapDeps([0,1,2,3,4,5,6,7]));if(L.USE_NORMALIZED_MESSAGES&&T.length>0)try{console.error("üîÑ [MessageRouting] Updating conversation_id in database for",T.length,"messages");const{supabase:g}=await We(async()=>{const{supabase:N}=await import("./auth-Dr7R2Prf.js").then(Le=>Le.a);return{supabase:N}},__vite__mapDeps([2,3,4,5,6,7,0,1])),v=T.map(N=>N.id),{error:O}=await g.from("messages").update({conversation_id:r}).in("id",v);if(O)throw console.error("‚ùå [MessageRouting] Failed to update conversation_id in database:",O),O;console.error("‚úÖ [MessageRouting] Database conversation_id updated for",v.length,"messages")}catch(g){throw console.error("‚ùå [MessageRouting] Database migration failed:",g),g}const p={...l,[r]:{...m,messages:[...m.messages,...T],updatedAt:Date.now()},[t]:{...u,messages:u.messages.filter(g=>!e.includes(g.id)),updatedAt:Date.now()}};console.error("üì¶ [MessageRouting] Updated source messages:",(c=p[t].messages)==null?void 0:c.map(g=>({id:g.id,role:g.role}))),console.error("üì¶ [MessageRouting] Updated destination messages:",(i=p[r].messages)==null?void 0:i.map(g=>({id:g.id,role:g.role}))),await E.setConversations(p),console.error("‚úÖ [MessageRouting] Migration complete, conversations saved")}finally{this.releaseMigrationLock(t,r)}}static shouldRouteMessage(e,t,r){return!t||e===t?!1:!!(r&&t)}static messageExists(e,t){return e.some(r=>r.id===t)}}f(Ye,"activeMigrations",new Set),f(Ye,"LOCK_TIMEOUT",1e4);const Or="otagon-offline-db",Ir=1,b={MESSAGES:"pending-messages",VOICE:"pending-voice",IMAGES:"pending-images",SYNC_META:"sync-metadata"};class Rr{constructor(){f(this,"db",null);f(this,"isSupported",!0);f(this,"initPromise",null);f(this,"MAX_QUEUE_SIZE",10);typeof indexedDB>"u"&&(console.warn("[IndexedDB] Not supported, falling back to localStorage"),this.isSupported=!1)}async init(){if(this.isSupported&&!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((e,t)=>{try{const r=indexedDB.open(Or,Ir);r.onerror=()=>{console.error("[IndexedDB] Failed to open database:",r.error),this.isSupported=!1,e()},r.onsuccess=()=>{this.db=r.result,console.log("[IndexedDB] Database opened successfully"),e()},r.onupgradeneeded=s=>{const a=s.target.result;if(!a.objectStoreNames.contains(b.MESSAGES)){const n=a.createObjectStore(b.MESSAGES,{keyPath:"id"});n.createIndex("conversationId","conversationId",{unique:!1}),n.createIndex("timestamp","timestamp",{unique:!1})}a.objectStoreNames.contains(b.VOICE)||a.createObjectStore(b.VOICE,{keyPath:"id"}),a.objectStoreNames.contains(b.IMAGES)||a.createObjectStore(b.IMAGES,{keyPath:"id"}).createIndex("conversationId","conversationId",{unique:!1}),a.objectStoreNames.contains(b.SYNC_META)||a.createObjectStore(b.SYNC_META,{keyPath:"id"}),console.log("[IndexedDB] Database schema created/upgraded")}}catch(r){console.error("[IndexedDB] Initialization error:",r),this.isSupported=!1,e()}}),this.initPromise)}async canQueueMessage(){return await this.getPendingMessageCount()>=this.MAX_QUEUE_SIZE?{allowed:!1,reason:`Offline queue is full (${this.MAX_QUEUE_SIZE} messages). Please wait for connection to restore.`}:{allowed:!0}}async queueMessage(e){await this.init();const t={...e,id:`msg_${Date.now()}_${Math.random().toString(36).substring(7)}`,timestamp:Date.now(),retryCount:0};return!this.isSupported||!this.db?this.queueMessageToLocalStorage(t):new Promise((r,s)=>{try{if(!this.db){r(this.queueMessageToLocalStorage(t));return}const c=this.db.transaction([b.MESSAGES],"readwrite").objectStore(b.MESSAGES).add(t);c.onsuccess=()=>{console.log("[IndexedDB] Message queued:",t.id),r(t.id)},c.onerror=()=>{console.error("[IndexedDB] Failed to queue message:",c.error),r(this.queueMessageToLocalStorage(t))}}catch(a){console.error("[IndexedDB] Error queuing message:",a),r(this.queueMessageToLocalStorage(t))}})}async getPendingMessages(){return await this.init(),!this.isSupported||!this.db?this.getPendingMessagesFromLocalStorage():new Promise(e=>{try{if(!this.db){e(this.getPendingMessagesFromLocalStorage());return}const s=this.db.transaction([b.MESSAGES],"readonly").objectStore(b.MESSAGES).getAll();s.onsuccess=()=>{e(s.result||[])},s.onerror=()=>{console.error("[IndexedDB] Failed to get messages:",s.error),e(this.getPendingMessagesFromLocalStorage())}}catch(t){console.error("[IndexedDB] Error getting messages:",t),e(this.getPendingMessagesFromLocalStorage())}})}async getPendingMessageCount(){return await this.init(),!this.isSupported||!this.db?this.getPendingMessagesFromLocalStorage().length:new Promise(e=>{try{if(!this.db){e(this.getPendingMessagesFromLocalStorage().length);return}const s=this.db.transaction([b.MESSAGES],"readonly").objectStore(b.MESSAGES).count();s.onsuccess=()=>{e(s.result)},s.onerror=()=>{e(this.getPendingMessagesFromLocalStorage().length)}}catch{e(this.getPendingMessagesFromLocalStorage().length)}})}async removeMessage(e){return await this.init(),!this.isSupported||!this.db?this.removeMessageFromLocalStorage(e):new Promise(t=>{try{if(!this.db){t(this.removeMessageFromLocalStorage(e));return}const a=this.db.transaction([b.MESSAGES],"readwrite").objectStore(b.MESSAGES).delete(e);a.onsuccess=()=>{console.log("[IndexedDB] Message removed:",e),t(!0)},a.onerror=()=>{console.error("[IndexedDB] Failed to remove message:",a.error),t(this.removeMessageFromLocalStorage(e))}}catch(r){console.error("[IndexedDB] Error removing message:",r),t(this.removeMessageFromLocalStorage(e))}})}async clearAllMessages(){if(await this.init(),!this.isSupported||!this.db){localStorage.removeItem("otakon_pending_messages");return}return new Promise(e=>{try{if(!this.db){localStorage.removeItem("otakon_pending_messages"),e();return}const s=this.db.transaction([b.MESSAGES],"readwrite").objectStore(b.MESSAGES).clear();s.onsuccess=()=>{console.log("[IndexedDB] All messages cleared"),e()},s.onerror=()=>{console.error("[IndexedDB] Failed to clear messages:",s.error),localStorage.removeItem("otakon_pending_messages"),e()}}catch{localStorage.removeItem("otakon_pending_messages"),e()}})}async queueImage(e){await this.init();const t={...e,id:`img_${Date.now()}_${Math.random().toString(36).substring(7)}`,timestamp:Date.now()};return!this.isSupported||!this.db?(console.warn("[IndexedDB] Cannot queue large image data to localStorage"),null):new Promise(r=>{try{if(!this.db){r(null);return}const n=this.db.transaction([b.IMAGES],"readwrite").objectStore(b.IMAGES).add(t);n.onsuccess=()=>{console.log("[IndexedDB] Image queued:",t.id),r(t.id)},n.onerror=()=>{console.error("[IndexedDB] Failed to queue image:",n.error),r(null)}}catch(s){console.error("[IndexedDB] Error queuing image:",s),r(null)}})}async getPendingImages(){return await this.init(),!this.isSupported||!this.db?[]:new Promise(e=>{try{if(!this.db){e([]);return}const s=this.db.transaction([b.IMAGES],"readonly").objectStore(b.IMAGES).getAll();s.onsuccess=()=>{e(s.result||[])},s.onerror=()=>{e([])}}catch{e([])}})}async clearAllImages(){if(await this.init(),!(!this.isSupported||!this.db))return new Promise(e=>{try{if(!this.db){e();return}this.db.transaction([b.IMAGES],"readwrite").objectStore(b.IMAGES).clear(),e()}catch{e()}})}queueMessageToLocalStorage(e){try{const t=this.getPendingMessagesFromLocalStorage();return t.push(e),localStorage.setItem("otakon_pending_messages",JSON.stringify(t)),console.log("[IndexedDB] Message queued to localStorage fallback:",e.id),e.id}catch(t){return console.error("[IndexedDB] localStorage fallback failed:",t),e.id}}getPendingMessagesFromLocalStorage(){try{const e=localStorage.getItem("otakon_pending_messages");return e?JSON.parse(e):[]}catch{return[]}}removeMessageFromLocalStorage(e){try{const r=this.getPendingMessagesFromLocalStorage().filter(s=>s.id!==e);return localStorage.setItem("otakon_pending_messages",JSON.stringify(r)),!0}catch{return!1}}async updateSyncMetadata(e){await this.init();const t={lastSyncAttempt:e.lastSyncAttempt||Date.now(),pendingCount:e.pendingCount||0,lastSuccessfulSync:e.lastSuccessfulSync||0};if(!this.isSupported||!this.db){localStorage.setItem("otakon_sync_metadata",JSON.stringify(t));return}return new Promise(r=>{try{if(!this.db){localStorage.setItem("otakon_sync_metadata",JSON.stringify(t)),r();return}this.db.transaction([b.SYNC_META],"readwrite").objectStore(b.SYNC_META).put({id:"sync-status",...t}),r()}catch{localStorage.setItem("otakon_sync_metadata",JSON.stringify(t)),r()}})}async getSyncMetadata(){if(await this.init(),!this.isSupported||!this.db)try{const e=localStorage.getItem("otakon_sync_metadata");return e?JSON.parse(e):null}catch{return null}return new Promise(e=>{try{if(!this.db){e(null);return}const s=this.db.transaction([b.SYNC_META],"readonly").objectStore(b.SYNC_META).get("sync-status");s.onsuccess=()=>{e(s.result||null)},s.onerror=()=>{e(null)}}catch{e(null)}})}isAvailable(){return this.isSupported&&this.db!==null}}const X=new Rr,ps={queueMessage:o=>X.queueMessage(o),getPendingMessages:()=>X.getPendingMessages(),removePendingMessage:o=>X.removeMessage(o),clearAllMessages:()=>X.clearAllMessages(),canQueueMessage:()=>X.canQueueMessage(),getPendingMessageCount:()=>X.getPendingMessageCount()},J=class J{static getInstance(){return J.instance||(J.instance=new J),J.instance}async getMessages(e){return ge.USE_NORMALIZED_MESSAGES?this.getMessagesFromTable(e):this.getMessagesFromJsonb(e)}async addMessage(e,t){return ge.USE_NORMALIZED_MESSAGES?this.addMessageToTable(e,t):this.addMessageToJsonb(e,t)}async updateMessage(e,t,r){return ge.USE_NORMALIZED_MESSAGES?this.updateMessageInTable(t,r):this.updateMessageInJsonb(e,t,r)}async deleteMessage(e,t){return ge.USE_NORMALIZED_MESSAGES?this.deleteMessageFromTable(t):this.deleteMessageFromJsonb(e,t)}async getMessagesFromTable(e){try{const{data:t,error:r}=await d.rpc("get_conversation_messages",{p_conversation_id:e});return r?(console.error("Error getting messages from table:",r),[]):(t||[]).map(s=>({id:s.id,role:s.role,content:s.content,timestamp:new Date(s.created_at).getTime(),imageUrl:s.image_url||void 0,metadata:M(s.metadata)}))}catch(t){return console.error("Error getting messages from table:",t),[]}}async addMessageToTable(e,t){var a,n;const s=[0,1e3,2e3];for(let c=0;c<3;c++)try{c>0&&(await new Promise(h=>setTimeout(h,s[c])),console.warn(`üîÑ [MessageService] Retry attempt ${c+1}/3`));const{data:i,error:l}=await d.rpc("add_message",{p_conversation_id:e,p_role:t.role,p_content:t.content,p_image_url:Ee(t.imageUrl,void 0),p_metadata:he(t.metadata||{})});if(l){if(c<2&&(l.code==="PGRST301"||(a=l.message)!=null&&a.includes("timeout")||(n=l.message)!=null&&n.includes("network"))){console.warn("‚ö†Ô∏è [MessageService] Transient error, will retry:",l);continue}throw new Error(`Failed to add message: ${l.message} (code: ${l.code})`)}const{data:u,error:m}=await d.from("messages").select("*").eq("id",i).single();if(m)throw new Error(`Failed to fetch new message: ${m.message}`);if(!u)throw new Error("Message not found after insert - database inconsistency");return{id:u.id,role:u.role,content:u.content,timestamp:Z(u.created_at),imageUrl:Ee(u.image_url,void 0),metadata:M(u.metadata)}}catch(i){if(c===2)throw console.error("‚ùå [MessageService] All retry attempts exhausted:",i),i}throw new Error("Unexpected: retry loop completed without result")}async updateMessageInTable(e,t){try{const r={};t.content!==void 0&&(r.content=t.content),t.imageUrl!==void 0&&(r.image_url=t.imageUrl),t.metadata!==void 0&&(r.metadata=t.metadata);const{error:s}=await d.from("messages").update(r).eq("id",e);return s?(console.error("Error updating message in table:",s),!1):!0}catch(r){return console.error("Error updating message in table:",r),!1}}async deleteMessageFromTable(e){try{const{error:t}=await d.from("messages").delete().eq("id",e);return t?(console.error("Error deleting message from table:",t),!1):!0}catch(t){return console.error("Error deleting message from table:",t),!1}}async getMessagesFromJsonb(e){try{const{data:t,error:r}=await d.from("conversations").select("messages").eq("id",e).single();return r?(console.error("Error getting messages from JSONB:",r),[]):Array.isArray(t==null?void 0:t.messages)?t.messages:[]}catch(t){return console.error("Error getting messages from JSONB:",t),[]}}async addMessageToJsonb(e,t){try{const r=await this.getMessagesFromJsonb(e),s={...t,id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now()},{error:a}=await d.from("conversations").update({messages:he([...r,s]),updated_at:new Date().toISOString()}).eq("id",e);return a?(console.error("Error adding message to JSONB:",a),null):s}catch(r){return console.error("Error adding message to JSONB:",r),null}}async updateMessageInJsonb(e,t,r){try{const a=(await this.getMessagesFromJsonb(e)).map(c=>c.id===t?{...c,...r}:c),{error:n}=await d.from("conversations").update({messages:he(a),updated_at:new Date().toISOString()}).eq("id",e);return n?(console.error("Error updating message in JSONB:",n),!1):!0}catch(s){return console.error("Error updating message in JSONB:",s),!1}}async deleteMessageFromJsonb(e,t){try{const s=(await this.getMessagesFromJsonb(e)).filter(n=>n.id!==t),{error:a}=await d.from("conversations").update({messages:he(s),updated_at:new Date().toISOString()}).eq("id",e);return a?(console.error("Error deleting message from JSONB:",a),!1):!0}catch(r){return console.error("Error deleting message from JSONB:",r),!1}}async migrateMessagesToTable(){try{const{data:e,error:t}=await d.rpc("migrate_messages_to_table");return t?(console.error("Error migrating messages:",t),{conversationsProcessed:0,messagesCreated:0,errors:1}):{conversationsProcessed:e[0].conversations_processed,messagesCreated:e[0].messages_created,errors:e[0].errors}}catch(e){return console.error("Error migrating messages:",e),{conversationsProcessed:0,messagesCreated:0,errors:1}}}async rollbackMessagesToJsonb(){try{const{data:e,error:t}=await d.rpc("rollback_messages_to_jsonb");return t?(console.error("Error rolling back messages:",t),{conversationsUpdated:0,errors:1}):{conversationsUpdated:e[0].conversations_updated,errors:e[0].errors}}catch(e){return console.error("Error rolling back messages:",e),{conversationsUpdated:0,errors:1}}}};f(J,"instance");let we=J;we.getInstance();const fs=Object.freeze(Object.defineProperty({__proto__:null,MessageService:we},Symbol.toStringTag,{value:"Module"}));class kr{constructor(){f(this,"submittedFeedback",new Set)}hasSubmittedFeedback(e){return this.submittedFeedback.has(e)}async submitFeedback(e){try{const t=pe.getCurrentUser();if(!(t!=null&&t.authUserId))return console.warn("[FeedbackService] User not authenticated"),{success:!1,error:"User not authenticated"};if(this.submittedFeedback.has(e.messageId))return console.log("[FeedbackService] Feedback already submitted for message:",e.messageId),{success:!0};const{error:r}=await d.from("ai_feedback").insert({user_id:t.authUserId,conversation_id:e.conversationId,message_id:e.messageId,feedback_type:e.feedbackType,content_type:e.contentType,category:e.category||null,comment:e.comment||null});return r?r.code==="23505"?(console.log("[FeedbackService] Feedback already exists in database"),this.submittedFeedback.add(e.messageId),{success:!0}):(console.error("[FeedbackService] Failed to submit feedback:",r),{success:!1,error:r.message}):(this.submittedFeedback.add(e.messageId),console.log("[FeedbackService] Feedback submitted:",{messageId:e.messageId,type:e.feedbackType,contentType:e.contentType}),{success:!0})}catch(t){return console.error("[FeedbackService] Error submitting feedback:",t),{success:!1,error:"Failed to submit feedback"}}}async submitPositiveFeedback(e,t,r="message"){return this.submitFeedback({messageId:e,conversationId:t,feedbackType:"up",contentType:r})}async submitNegativeFeedback(e,t,r,s,a="message"){return this.submitFeedback({messageId:e,conversationId:t,feedbackType:"down",contentType:a,category:r,comment:s})}async submitCorrection(e){try{const t=pe.getCurrentUser();if(!(t!=null&&t.authUserId))return console.warn("[FeedbackService] User not authenticated for correction"),{success:!1,error:"User not authenticated"};if(!W.getRateLimitStatus().allowed)return{success:!1,error:"Daily correction limit reached. Try again tomorrow.",rateLimitRemaining:0};const s={originalResponse:e.originalResponse,correctionText:e.correctionText,type:e.correctionType,scope:e.correctionScope,gameTitle:e.gameTitle,messageId:e.messageId,conversationId:e.conversationId},a=await W.submitCorrection(t.authUserId,s);return a.success?(console.log("[FeedbackService] Correction submitted successfully:",{messageId:e.messageId,type:e.correctionType,scope:e.correctionScope}),{success:!0,correction:a.correction,rateLimitRemaining:W.getRateLimitStatus().remaining}):{success:!1,error:a.error,rateLimitRemaining:W.getRateLimitStatus().remaining}}catch(t){return console.error("[FeedbackService] Error submitting correction:",t),{success:!1,error:"Failed to submit correction"}}}getCorrectionRateLimit(){return W.getRateLimitStatus()}async getUserCorrections(){const e=pe.getCurrentUser();return e!=null&&e.authUserId?W.getAllCorrections(e.authUserId):[]}async toggleCorrection(e,t){const r=pe.getCurrentUser();return r!=null&&r.authUserId?W.toggleCorrection(r.authUserId,e,t):!1}async getFeedbackStats(){try{const{data:e,error:t}=await d.from("ai_feedback").select("feedback_type, category");if(t)return console.error("[FeedbackService] Failed to get feedback stats:",t),null;const r={totalFeedback:e.length,positiveCount:e.filter(s=>s.feedback_type==="up").length,negativeCount:e.filter(s=>s.feedback_type==="down").length,categoryBreakdown:{}};return e.forEach(s=>{s.category&&(r.categoryBreakdown[s.category]=(r.categoryBreakdown[s.category]||0)+1)}),r}catch(e){return console.error("[FeedbackService] Error getting feedback stats:",e),null}}clearLocalTracking(){this.submittedFeedback.clear()}}const Pr=new kr,Ss=Object.freeze(Object.defineProperty({__proto__:null,feedbackService:Pr},Symbol.toStringTag,{value:"Module"}));function Nr(o){var n;const e=o.split(","),t=((n=e[0].match(/:(.*?);/))==null?void 0:n[1])||"image/png",r=atob(e[1]),s=r.length,a=new Uint8Array(s);for(let c=0;c<s;c++)a[c]=r.charCodeAt(c);return new Blob([a],{type:t})}async function Mr(o,e){try{const t=Nr(o),r=t.size,s=50*1024*1024;if(r>s)return{success:!1,error:"Screenshot exceeds 50MB size limit"};const a=Date.now(),n=Math.random().toString(36).substring(2,15),c=`${a}_${n}.png`,i=`${e}/${c}`,{error:l}=await d.storage.from("screenshots").upload(i,t,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(l)return console.error("Screenshot upload error:",l),{success:!1,error:l.message};const{data:u}=d.storage.from("screenshots").getPublicUrl(i);return u!=null&&u.publicUrl?{success:!0,publicUrl:u.publicUrl,fileSize:r}:{success:!1,error:"Failed to generate public URL"}}catch(t){return console.error("Screenshot upload exception:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}const ys=Object.freeze(Object.defineProperty({__proto__:null,uploadScreenshot:Mr},Symbol.toStringTag,{value:"Module"}));class Gr{constructor(){f(this,"MAX_WORDS",300);f(this,"RECENT_MESSAGE_COUNT",8)}countWords(e){return e.trim().split(/\s+/).filter(t=>t.length>0).length}getTotalWordCount(e){return e.reduce((t,r)=>{const s=this.countWords(r.content);return t+s},0)}shouldSummarize(e){return!e.messages||e.messages.length<=this.RECENT_MESSAGE_COUNT?!1:this.getTotalWordCount(e.messages)>this.MAX_WORDS*3}splitMessages(e){if(e.length<=this.RECENT_MESSAGE_COUNT)return{toSummarize:[],toKeep:e};const t=e.length-this.RECENT_MESSAGE_COUNT;return{toSummarize:e.slice(0,t),toKeep:e.slice(t)}}async summarizeMessages(e,t,r){const s=this.getTotalWordCount(e),a=e.map(i=>`${i.role==="user"?"User":"Assistant"}: ${i.content}`).join(`

`),c=`${t&&r?`This is a conversation about "${t}" (${r}).`:"This is a general conversation."}

Please provide a concise summary of the following conversation history. Focus on:
- Key topics discussed
- Important decisions or choices made
- Game progress or story developments (if applicable)
- User preferences or interests mentioned

Keep the summary under ${this.MAX_WORDS} words while preserving essential context.

Conversation to summarize:
${a}

Provide ONLY the summary, no additional commentary.`;try{const i={id:"temp-summary",title:"Summary Request",messages:[{id:"summary-msg-"+Date.now(),role:"user",content:c,timestamp:Date.now()}],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,isGameHub:!1},l={id:"system",email:"system@otakon.ai",profileData:null},m=(await Ve.getChatResponse(i,l,c,!1,!1)).content.trim(),h=this.countWords(m);return console.log(`‚úÖ [ContextSummarization] Summary generated: ${h} words (reduced from ${s})`),{summary:m,wordCount:h,messagesIncluded:e.length,originalWordCount:s}}catch(i){console.error("‚ùå [ContextSummarization] Failed to generate summary:",i);const l=e.slice(0,5).map(u=>u.content.substring(0,100)).join(" ... ").substring(0,this.MAX_WORDS*6);return{summary:`[Previous conversation context] ${l}`,wordCount:this.countWords(l),messagesIncluded:e.length,originalWordCount:s}}}async applyContextSummarization(e){if(!this.shouldSummarize(e))return e;const{toSummarize:t,toKeep:r}=this.splitMessages(e.messages);if(t.length===0)return e;const s=await this.summarizeMessages(t,e.gameTitle,e.genre),n=[{id:"summary-"+Date.now(),role:"system",content:s.summary,timestamp:t[t.length-1].timestamp,metadata:{isSummary:!0,messagesIncluded:s.messagesIncluded,originalWordCount:s.originalWordCount,summaryWordCount:s.wordCount}},...r],c=s.summary.replace(/!\[.*?\]\(data:image\/.*?\)/g,""),i=c.split(/\s+/).filter(u=>u.length>0),l=i.length>500?i.slice(0,500).join(" ")+"...":c;return console.log(`‚úÖ [ContextSummarization] Context optimized: ${e.messages.length} messages ‚Üí ${n.length} (${s.originalWordCount} words ‚Üí ${s.wordCount} + recent)`),{...e,messages:n,contextSummary:l,lastSummarizedAt:Date.now(),updatedAt:Date.now()}}async getOptimizedContext(e){return this.shouldSummarize(e)?(await this.applyContextSummarization(e)).messages:e.messages}willTriggerSummarization(e){return this.getTotalWordCount(e.messages)>this.MAX_WORDS*3*.8}}const Dr=new Gr,bs=Object.freeze(Object.defineProperty({__proto__:null,contextSummarizationService:Dr},Symbol.toStringTag,{value:"Module"}));export{Yr as A,Hr as B,wt as C,ps as D,fe as E,q as F,Rt as G,jr as H,ls as I,us as J,qr as K,Fr as L,Ye as M,Br as N,fs as O,Ss as P,ys as Q,bs as R,B as S,gs as U,Kr as W,C as a,ss as b,Et as c,is as d,W as e,ts as f,os as g,G as h,ns as i,as as j,te as k,Wr as l,hs as m,cs as n,ds as o,rs as p,ms as q,zr as r,St as s,ee as t,Zr as u,Qr as v,es as w,Xr as x,Jr as y,Vr as z};
