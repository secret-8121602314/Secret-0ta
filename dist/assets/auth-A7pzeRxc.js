import{r as p,j as a}from"./react-vendor-D37MhRM4.js";import{c as D}from"./supabase-vendor-B_G7PGx1.js";import{a as v}from"./core-services-Ukn7y0O0.js";const R="https://qajcxgkqloumogioomiz.supabase.co",O="sb_publishable_GoW6G_umt1lFF-KPbbm-Ow_D2PYxPLw",u=D(R,O,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0}});if(typeof window<"u"){u.auth.onAuthStateChange((t,s)=>{t==="SIGNED_IN"?s!=null&&s.access_token&&(localStorage.setItem("otakon_session_refreshed",Date.now().toString()),localStorage.setItem("otakon_last_session_check",Date.now().toString()),window.dispatchEvent(new CustomEvent("otakon:session-refreshed",{detail:{event:t,session:s}}))):t==="TOKEN_REFRESHED"?s!=null&&s.access_token?(localStorage.setItem("otakon_session_refreshed",Date.now().toString()),localStorage.setItem("otakon_last_session_check",Date.now().toString()),window.dispatchEvent(new CustomEvent("otakon:session-refreshed",{detail:{event:t,session:s}}))):(console.error("ðŸ” [Supabase] Token refresh failed - session expired"),localStorage.removeItem("otakon_session_refreshed"),localStorage.removeItem("otakon_last_session_check"),window.dispatchEvent(new CustomEvent("otakon:session-expired",{detail:{reason:"token_refresh_failed",timestamp:Date.now()}}))):t==="SIGNED_OUT"?(localStorage.removeItem("otakon_session_refreshed"),localStorage.removeItem("otakon_last_session_check"),window.dispatchEvent(new CustomEvent("otakon:signed-out"))):t==="USER_UPDATED"&&window.dispatchEvent(new CustomEvent("otakon:user-updated",{detail:{session:s}}))});const c=300*1e3;setInterval(async()=>{try{const{data:{session:t},error:s}=await u.auth.getSession();if(s||!t){const o=localStorage.getItem("otakon_last_session_check");o&&Date.now()-parseInt(o)<c*2&&(console.warn("ðŸ” [Supabase] Session expired during health check"),window.dispatchEvent(new CustomEvent("otakon:session-expired",{detail:{reason:"health_check_failed",timestamp:Date.now()}})))}else localStorage.setItem("otakon_last_session_check",Date.now().toString())}catch(t){console.error("ðŸ” [Supabase] Session health check error:",t)}},c)}const L=Object.freeze(Object.defineProperty({__proto__:null,supabase:u},Symbol.toStringTag,{value:"Module"})),G=({onAuthSuccess:c,onAuthError:t})=>{const[s,o]=p.useState("loading"),[w,h]=p.useState(null),C=p.useRef(!1),_=p.useRef(null);return p.useEffect(()=>C.current?void 0:(C.current=!0,(async()=>{var A,E;try{if(!(window.location.search.includes("code")||window.location.hash.includes("access_token"))&&(await u.auth.getSession()).data.session){const n=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,n),o("success"),c();return}const l=new URLSearchParams(window.location.search),b=new URLSearchParams(window.location.hash.substring(1)),r=l.get("error")||b.get("error"),i=l.get("error_description")||b.get("error_description"),S=l.get("error_code")||b.get("error_code");if(console.log("ðŸ” [AuthCallback] OAuth parameters:",{oauthError:r,errorDescription:i,errorCode:S,urlParams:Object.fromEntries(l.entries()),hashParams:Object.fromEntries(b.entries())}),r){console.error("ðŸ” [AuthCallback] OAuth error detected:",{oauthError:r,errorDescription:i,errorCode:S});let e="Authentication failed";r==="access_denied"&&S==="otp_expired"?e="Email confirmation link has expired. Please request a new confirmation email.":r==="access_denied"&&(i!=null&&i.includes("Email link is invalid"))?e="Email confirmation link is invalid. Please request a new confirmation email.":r==="access_denied"&&(i!=null&&i.includes("expired"))?e="Email confirmation link has expired. Please request a new confirmation email.":r==="server_error"?e="Authentication server error. This may be due to Supabase configuration. Please try again.":r==="access_denied"?e="Authentication was cancelled. Please try again.":r==="invalid_request"?e="Invalid authentication request. Please check configuration.":r==="unauthorized_client"?e="Authentication client is not authorized. Please check Supabase configuration.":r==="unsupported_response_type"?e="Authentication response type not supported. Please check Supabase configuration.":r==="invalid_scope"?e="Authentication scope is invalid. Please check Supabase configuration.":i&&(e=decodeURIComponent(i)),h(e),o("error"),t(e);return}const{data:{subscription:d}}=u.auth.onAuthStateChange(async(e,n)=>{var f,m,F,N,y;if(e==="SIGNED_IN"&&(n!=null&&n.user)){const I=((f=n.user.app_metadata)==null?void 0:f.provider)||((F=(m=n.user.app_metadata)==null?void 0:m.providers)==null?void 0:F[0])||((y=(N=n.user.identities)==null?void 0:N[0])==null?void 0:y.provider)||"unknown";await new Promise(k=>setTimeout(k,1500));try{await v.loadUserFromSupabase(n.user.id),o("success"),c()}catch(k){console.error("ðŸ” [AuthCallback] Error loading user data:",k),h("Failed to load user data. Please try again."),o("error"),t("Failed to load user data")}d.unsubscribe()}else e==="SIGNED_OUT"&&(h("Authentication failed"),o("error"),t("Authentication failed"),d.unsubscribe())});_.current=d;const{data:j,error:g}=await u.auth.getSession();if(g){console.error("ðŸ” [AuthCallback] Auth callback error:",g),h(g.message),o("error"),t(g.message),d.unsubscribe();return}if((A=j.session)!=null&&A.user)await new Promise(e=>setTimeout(e,1e3)),await v.loadUserFromSupabase(j.session.user.id),o("success"),c(),d.unsubscribe();else{const e=new URLSearchParams(window.location.search),n=new URLSearchParams(window.location.hash.substring(1));if(e.has("code")||e.has("error")||n.has("access_token")){await new Promise(m=>setTimeout(m,1e3));const f=await u.auth.getSession();if((E=f.data.session)!=null&&E.user){await new Promise(m=>setTimeout(m,500)),await v.loadUserFromSupabase(f.data.session.user.id),o("success"),c(),d.unsubscribe();return}}setTimeout(()=>{s==="loading"&&(h("Authentication timeout"),o("error"),t("Authentication timeout"),d.unsubscribe())},1e4)}}catch(P){console.error("ðŸ” [AuthCallback] Auth callback error:",P);const l="An unexpected error occurred";h(l),o("error"),t(l)}})(),()=>{_.current&&_.current.unsubscribe()}),[]),s==="loading"?a.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-[#FF4D4D] mx-auto mb-4"}),a.jsx("p",{className:"text-[#CFCFCF] text-lg",children:"Completing authentication..."})]})}):s==="error"?a.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-red-500 text-6xl mb-4",children:"âš ï¸"}),a.jsx("h2",{className:"text-2xl font-bold text-[#F5F5F5] mb-2",children:"Authentication Error"}),a.jsx("p",{className:"text-[#CFCFCF] mb-6",children:w}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("button",{onClick:()=>{const x=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,x),t("User cancelled authentication")},className:"bg-gradient-to-r from-[#E53A3A] to-[#D98C1F] md:hover:from-[#D42A2A] md:hover:to-[#C87A1A] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 md:hover:scale-105 active:scale-95",children:"Return to Login"}),w&&w.includes("Email confirmation link")&&a.jsx("button",{onClick:()=>{window.history.replaceState({},document.title,"/"),t("Email confirmation expired - show resend option")},className:"bg-gradient-to-r from-[#4F46E5] to-[#7C3AED] md:hover:from-[#4338CA] md:hover:to-[#6D28D9] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 md:hover:scale-105 active:scale-95",children:"Request New Confirmation Email"})]})]})}):a.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-green-500 text-6xl mb-4",children:"âœ…"}),a.jsx("h2",{className:"text-2xl font-bold text-[#F5F5F5] mb-2",children:"Authentication Successful"}),a.jsx("p",{className:"text-[#CFCFCF]",children:"Redirecting to the app..."})]})})};export{G as A,L as a,u as s};
