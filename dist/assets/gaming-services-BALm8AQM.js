const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/services-B130oVdD.js","assets/auth-Bqsm5OVC.js","assets/react-vendor-JBKW6UM3.js","assets/carousel-vendor-DbqMuwPS.js","assets/vendor-CJ8PTbpw.js","assets/supabase-vendor-ClpCPKgU.js","assets/supabase-realtime-8-W1bgUD.js","assets/core-services-B5iiBVH_.js","assets/chat-services-DbgOgouv.js","assets/ai-vendor-DDPwdD9r.js","assets/storage-services-iagWOljp.js","assets/framer-vendor-DZk8000h.js"])))=>i.map(i=>d[i]);
import{s as G}from"./auth-Bqsm5OVC.js";import{_ as le,C as b,i as W,d as ce,e as ge}from"./chat-services-DbgOgouv.js";import{m as L,n as O,o as J,q as ue,u as Q,r as I,i as V,t as Z}from"./services-B130oVdD.js";import{a as P}from"./core-services-B5iiBVH_.js";const B=new Map,x=new Map,de=1800*1e3,oe="otagon_igdb_cache",j=1440*60*1e3,ie="otagon_cover_urls";function me(){try{const r=localStorage.getItem(oe);if(r){const e=JSON.parse(r);if(e.version===1&&Date.now()-e.timestamp<j){for(const[t,a]of Object.entries(e.games))Date.now()-a.timestamp<j&&x.set(t,a);console.log("[IGDBService] Loaded",x.size,"games from localStorage cache")}}}catch(r){console.warn("[IGDBService] Error loading localStorage cache:",r)}}function pe(){try{const r={};x.forEach((t,a)=>{r[a]=t});const e={version:1,timestamp:Date.now(),games:r};localStorage.setItem(oe,JSON.stringify(e))}catch(r){console.warn("[IGDBService] Error saving localStorage cache:",r)}}function he(){try{const r=localStorage.getItem(ie);if(r){const e=JSON.parse(r);if(e.version===1&&Date.now()-e.timestamp<j)return console.log("[IGDBService] Loaded",Object.keys(e.urls).length,"cover URLs from localStorage"),new Map(Object.entries(e.urls))}}catch(r){console.warn("[IGDBService] Error loading cover URL cache:",r)}return new Map}function se(r){try{const e={version:1,timestamp:Date.now(),urls:Object.fromEntries(r)};localStorage.setItem(ie,JSON.stringify(e))}catch(e){console.warn("[IGDBService] Error saving cover URL cache:",e)}}me();const $=he();function q(r,e="cover_small"){if(!r)return;let t=r;return t=t.replace(/t_(thumb|cover_small|cover_big|720p|1080p|screenshot_huge)/g,`t_${e}`),t.startsWith("//")?t="https:"+t:t.startsWith("http")||(t="https://"+t),t}function Re(r){var e;if((e=r==null?void 0:r.cover)!=null&&e.url)return q(r.cover.url,"cover_small")}async function fe(r){if(!r||r.trim().length===0)return console.warn("[IGDBService] Empty game name provided"),null;const e=r.toLowerCase().trim(),t=x.get(e);if(t&&Date.now()-t.timestamp<de)return console.log("[IGDBService] Session cache hit:",r),t.data;if(B.has(e)){console.log("[IGDBService] Waiting for pending request:",r);const o=B.get(e);if(o)return o}const a=(async()=>{var o,i,n;try{console.log("[IGDBService] Fetching game data:",r);const{data:{session:l}}=await G.auth.getSession(),u={"Content-Type":"application/json"};l!=null&&l.access_token&&(u.Authorization=`Bearer ${l.access_token}`),console.log("[IGDBService] Invoking igdb-proxy with gameName:",r);const m=await G.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:r}),headers:u});if(m.error){console.error("[IGDBService] Edge function error:",m.error);const g=m.error;return((o=g==null?void 0:g.message)!=null&&o.includes("IGDB_NOT_CONFIGURED")||(i=g==null?void 0:g.message)!=null&&i.includes("503"))&&console.warn("[IGDBService] IGDB service not configured - game data will not be available"),null}const c=m.data;if((c==null?void 0:c.code)==="IGDB_NOT_CONFIGURED")return console.warn("[IGDBService] IGDB service not configured on server"),null;if(!c.success||!c.data)return console.log("[IGDBService] No data found for:",r),null;const s=c.data;if(x.set(e,{data:s,timestamp:Date.now()}),pe(),(n=s.cover)!=null&&n.url){const g=q(s.cover.url,"cover_small");g&&($.set(e,g),se($),console.log("[IGDBService] Saved cover URL to cache:",e))}return console.log("[IGDBService] Successfully fetched:",s.name,c.cached?"(cached)":"(fresh)"),s}catch(l){return console.error("[IGDBService] Error fetching game data:",l),null}finally{B.delete(e)}})();return B.set(e,a),a}async function De(r){return fe(`id:${r}`)}async function Pe(r){if(!r||r.trim().length<2)return[];try{console.log("[IGDBService] Searching games:",r);const{data:{session:e}}=await G.auth.getSession(),t={"Content-Type":"application/json"};e!=null&&e.access_token&&(t.Authorization=`Bearer ${e.access_token}`);const a=await G.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:r,searchMode:"multi"}),headers:t});if(a.error)return console.error("[IGDBService] Search error:",a.error),[];const o=a.data;if(!o.success||!o.data)return[];const i=o.data;console.log("[IGDBService] Search found",i.length,"games");for(const n of i){const l=n.name.toLowerCase().trim();x.set(l,{data:n,timestamp:Date.now()})}return i}catch(e){return console.error("[IGDBService] Search error:",e),[]}}function xe(r,e="high"){return`https://img.youtube.com/vi/${r}/${{default:"default",medium:"mqdefault",high:"hqdefault",maxres:"maxresdefault"}[e]}.jpg`}function Le(r){return{1:"Official",2:"Wikia",3:"Wikipedia",4:"Facebook",5:"Twitter",6:"Twitch",8:"Instagram",9:"YouTube",10:"iPhone",11:"iPad",12:"Android",13:"Steam",14:"Reddit",15:"Itch.io",16:"Epic Games",17:"GOG",18:"Discord"}[r]||"Website"}function $e(r,e){return r===1?{6:"RP (Rating Pending)",7:"EC (Early Childhood)",8:"E (Everyone)",9:"E10+ (Everyone 10+)",10:"T (Teen)",11:"M (Mature 17+)",12:"AO (Adults Only)"}[e]||"Not Rated":r===2&&{1:"PEGI 3",2:"PEGI 7",3:"PEGI 12",4:"PEGI 16",5:"PEGI 18"}[e]||"Not Rated"}function Ue(r){return r?new Date(r*1e3).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"TBA"}function Me(r){return r?r.filter(e=>e.developer).map(e=>e.company.name):[]}function Oe(r){return r.total_rating??r.aggregated_rating??r.rating??null}async function Be(r){var o;const e=new Map;if(r.length===0)return e;const t=r.map(i=>i.toLowerCase().trim()),a=[];for(const i of t){const n=$.get(i);n?e.set(i,n):a.push(i)}if(a.length===0)return console.log("[IGDBService] All cover URLs from localStorage cache:",e.size),e;try{const{data:i,error:n}=await G.from("igdb_game_cache").select("game_name_key, game_data").in("game_name_key",a).gt("expires_at",new Date().toISOString());if(n)return console.warn("[IGDBService] Error fetching cover URLs from cache:",n.message),e;if(i){for(const l of i){const u=l.game_data;if((o=u==null?void 0:u.cover)!=null&&o.url){const m=q(u.cover.url,"cover_small");m&&(e.set(l.game_name_key,m),$.set(l.game_name_key,m))}}se($)}console.log("[IGDBService] Fetched cover URLs:",e.size,"of",r.length,"(",e.size-a.length+((i==null?void 0:i.length)??0),"from localStorage,",(i==null?void 0:i.length)||0,"from Supabase)")}catch(i){console.warn("[IGDBService] Error in fetchCoverUrlsFromCache:",i)}return e}const D=new Map,X=1800*1e3,N=new Map;class ye{async get(e){const t=N.get(e);if(t)return console.log(`üéÆ [GameKnowledgeCache] Waiting for in-flight request: ${e}`),t;const a=this._fetchFromCache(e);N.set(e,a);try{return await a}finally{N.delete(e)}}async _fetchFromCache(e){const t=D.get(e);if(t&&Date.now()-t.timestamp<X)return console.log(`üéÆ [GameKnowledgeCache] Memory hit for igdbId: ${e}`),{knowledge:t.knowledge,cached:!0,version:t.version,source:"memory"};try{const{data:a,error:o}=await G.from("game_knowledge_cache").select("comprehensive_knowledge, version").eq("igdb_id",e).single();if(o)return o.code!=="PGRST116"&&console.warn("üéÆ [GameKnowledgeCache] Supabase error:",o),{knowledge:"",cached:!1,version:0,source:"none"};if(a)return console.log(`üéÆ [GameKnowledgeCache] Supabase hit for igdbId: ${e}`),D.set(e,{knowledge:a.comprehensive_knowledge,version:a.version,timestamp:Date.now()}),this._updateAccessStats(e).catch(()=>{}),{knowledge:a.comprehensive_knowledge,cached:!0,version:a.version,source:"supabase"}}catch(a){console.warn("üéÆ [GameKnowledgeCache] Failed to fetch from Supabase:",a)}return{knowledge:"",cached:!1,version:0,source:"none"}}async store(e,t,a,o={}){var i;try{const n={igdb_id:e,game_name:t,game_slug:o.gameSlug||null,comprehensive_knowledge:a,knowledge_summary:o.knowledgeSummary||null,tokens_used:o.tokensUsed||0,fetched_with_grounding:o.fetchedWithGrounding??!0,is_post_cutoff:o.isPostCutoff??!1,is_unreleased:o.isUnreleased??!1,release_date:((i=o.releaseDate)==null?void 0:i.toISOString().split("T")[0])||null,version:1,updated_at:new Date().toISOString(),access_count:0},{error:l}=await G.from("game_knowledge_cache").upsert(n,{onConflict:"igdb_id",ignoreDuplicates:!1});return l?(console.error("üéÆ [GameKnowledgeCache] Failed to store:",l),!1):(D.set(e,{knowledge:a,version:1,timestamp:Date.now()}),console.log(`üéÆ [GameKnowledgeCache] ‚úÖ Stored knowledge for: ${t}`),!0)}catch(n){return console.error("üéÆ [GameKnowledgeCache] Store error:",n),!1}}async exists(e){const t=D.get(e);if(t&&Date.now()-t.timestamp<X)return!0;try{const{count:a,error:o}=await G.from("game_knowledge_cache").select("*",{count:"exact",head:!0}).eq("igdb_id",e);return o?(console.warn("üéÆ [GameKnowledgeCache] Exists check error:",o),!1):(a??0)>0}catch{return!1}}shouldPrioritizeFetch(e){return e?e>new Date("2025-01-01"):!1}async getForContext(e){const t=await this.get(e);return!t.cached||!t.knowledge?null:t.knowledge}async _updateAccessStats(e){try{await G.from("game_knowledge_cache").update({last_accessed_at:new Date().toISOString()}).eq("igdb_id",e)}catch{}}clearMemoryCache(){D.clear(),console.log("üéÆ [GameKnowledgeCache] Memory cache cleared")}getStats(){return{memoryCacheSize:D.size,pendingRequests:N.size}}}const z=new ye,F=new Set;let ee=!1;const k=new Map,be=()=>"https://qajcxgkqloumogioomiz.supabase.co/functions/v1/ai-background",Se=r=>`
You are a comprehensive gaming knowledge expert. Provide extremely detailed, encyclopedic information about "${r}".

Your response will be used as a knowledge base for an AI gaming assistant. Be thorough and cover EVERYTHING a player might ask about.

## CORE GAME MECHANICS
- Complete gameplay systems breakdown
- All progression mechanics (leveling, skills, upgrades)
- Combat system (if applicable) - every attack type, combo, counter
- Movement and traversal mechanics
- Resource management and economy
- Crafting/building systems (if applicable)

## COMPLETE WALKTHROUGH FRAMEWORK
- Main story progression points
- All major areas/chapters in order
- Key objectives and how to complete them
- Recommended level/gear for each section
- Points of no return warnings

## DETAILED BOSS/CHALLENGE GUIDE
- Every major boss with full strategies
- Attack patterns and telegraphs
- Recommended builds/loadouts for each
- Cheese strategies and easy methods
- No-hit or challenge run tips

## COMPREHENSIVE TIPS AND TRICKS
- Essential beginner knowledge
- Intermediate optimization strategies
- Advanced/expert techniques
- Hidden mechanics most players miss
- Efficiency and speedrun tips

## COLLECTIBLES AND SECRETS
- All collectible types and locations
- Hidden areas and secret content
- Easter eggs and references
- Achievement/trophy guide
- 100% completion requirements

## CHARACTER BUILDS AND LOADOUTS
- All viable build archetypes
- Meta/optimal builds with explanations
- Fun/unique build ideas
- Stat allocation priorities
- Equipment recommendations per build

## STORY AND LORE
- Complete world lore (spoiler-tagged context)
- Character backgrounds and motivations
- Timeline of events
- Faction information
- Ending explanations (MAJOR SPOILERS clearly marked)

## MULTIPLAYER/ONLINE (if applicable)
- PvP strategies and meta
- Co-op tips and etiquette
- Server/region information
- Community resources

## TECHNICAL INFORMATION
- Known bugs and workarounds
- Performance optimization tips
- PC-specific settings recommendations
- Save management

Be comprehensive. This knowledge base will help players with ANY question about the game.
Use clear headers, bullet points, and organize information for easy searching.
`;async function _e(){if(!ee){ee=!0;try{const e=localStorage.getItem("otagon_game_knowledge");if(!e)return;const t=JSON.parse(e);if(!Array.isArray(t)||t.length===0)return;console.log(`üéÆ [GameKnowledge] Found ${t.length} items in LocalStorage to migrate`);for(const a of t){if(await z.exists(a.igdbGameId)){console.log(`üéÆ [GameKnowledge] ${a.gameName} already in Supabase, skipping`);continue}const i=[];if(a.gameMechanics&&i.push(`## Game Mechanics
${a.gameMechanics}`),a.tipsAndTricks&&i.push(`## Tips and Tricks
${a.tipsAndTricks}`),a.bossStrategies){const l=typeof a.bossStrategies=="object"?JSON.stringify(a.bossStrategies,null,2):String(a.bossStrategies);i.push(`## Boss Strategies
${l}`)}if(a.collectibles){const l=typeof a.collectibles=="object"?JSON.stringify(a.collectibles,null,2):String(a.collectibles);i.push(`## Collectibles
${l}`)}if(a.characterBuilds){const l=typeof a.characterBuilds=="object"?JSON.stringify(a.characterBuilds,null,2):String(a.characterBuilds);i.push(`## Character Builds
${l}`)}if(i.length===0)continue;const n=i.join(`

`);await z.store(a.igdbGameId,a.gameName,n,{fetchedWithGrounding:!1,isPostCutoff:!1}),console.log(`üéÆ [GameKnowledge] Migrated ${a.gameName} to Supabase`)}console.log("üéÆ [GameKnowledge] ‚úÖ Migration complete")}catch(r){console.warn("üéÆ [GameKnowledge] Migration failed (non-critical):",r)}}}async function ne(r,e){var a,o;if(_e().catch(()=>{}),F.has(r)){console.log(`üéÆ [GameKnowledge] Already fetching knowledge for ${e}`);return}if(await z.exists(r)){console.log(`üéÆ [GameKnowledge] Knowledge already exists in global cache for ${e}`);return}if(te.exists(r)){console.log(`üéÆ [GameKnowledge] Knowledge exists in LocalStorage for ${e}, will migrate`);return}F.add(r),console.log(`üéÆ [GameKnowledge] Starting background fetch WITH GROUNDING for ${e}...`);try{console.log("üéÆ [GameKnowledge] üîë Checking for auth session...");const{data:{session:i}}=await G.auth.getSession();if(!i){console.warn("üéÆ [GameKnowledge] ‚ùå No auth session found - user not logged in!"),console.warn("üéÆ [GameKnowledge] üí° Knowledge fetch requires authenticated user");return}console.log("üéÆ [GameKnowledge] ‚úÖ Auth session found, proceeding with fetch..."),console.log(`üì° [GEMINI CALL #1] üéÆ Game Knowledge Fetch | Game: ${e} | Type: BACKGROUND | Grounding: YES | Max Tokens: 32000`);const n=await fetch(be(),{method:"POST",headers:{Authorization:`Bearer ${i.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({prompt:Se(e),requestType:"text",model:"gemini-2.5-flash",temperature:.7,maxTokens:32e3,systemPrompt:"You are a comprehensive gaming knowledge expert. Provide extremely detailed, accurate, and practical gaming information. Use Google Search grounding to ensure all information is up-to-date and accurate.",useGrounding:!0,groundingConfig:{dynamicRetrievalConfig:{mode:"MODE_DYNAMIC",dynamicThreshold:.3}}})});if(!n.ok){const u=await n.json();throw console.error("üéÆ [GameKnowledge] ‚ùå Edge function error:",u),new Error(u.error||"Failed to fetch game knowledge")}const l=await n.json();if(console.log("üéÆ [GameKnowledge] üì¶ Received response:",{success:l.success,responseLength:((a=l.response)==null?void 0:a.length)||0,tokensUsed:l.tokensUsed||0}),console.log(`‚úÖ [GEMINI CALL] Game Knowledge Fetch SUCCESS | Game: ${e} | Response Length: ${((o=l.response)==null?void 0:o.length)||0} chars`),l.success&&l.response)if(await z.store(r,e,l.response,{tokensUsed:l.tokensUsed||0,fetchedWithGrounding:!0,isPostCutoff:!1,knowledgeSummary:l.response.slice(0,500)}))console.log(`üéÆ [GameKnowledge] ‚úÖ Stored ${l.response.length} chars in global cache for ${e}`),le(async()=>{const{toastService:m}=await import("./services-B130oVdD.js").then(c=>c.A);return{toastService:m}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11])).then(({toastService:m})=>{m.success(`Game knowledge created for ${e}`)}),k.delete(r);else{const m=ve(e,r,l.response);te.save(m),console.log(`üéÆ [GameKnowledge] ‚ö†Ô∏è Stored in LocalStorage fallback for ${e}`),k.delete(r)}else console.warn(`üéÆ [GameKnowledge] Empty response for ${e}`)}catch(i){console.error(`üéÆ [GameKnowledge] Failed to fetch for ${e}:`,i);const n=k.get(r)||0,l=3;n<l?(k.set(r,n+1),console.log(`üîÑ [GameKnowledge] Retry ${n+1}/${l} for ${e} in 1 second...`),setTimeout(()=>{F.delete(r),ne(r,e).catch(()=>{k.delete(r)})},1e3)):(console.error(`‚ùå [GameKnowledge] Max retries reached for ${e}`),k.delete(r))}finally{(k.get(r)||0)===0&&F.delete(r)}}function ve(r,e,t){return{igdbGameId:e,gameName:r,gameMechanics:t.slice(0,2e3),tipsAndTricks:void 0,extractedAt:Date.now(),lastUpdated:Date.now()}}function Y(r,e){console.log(`üéÆ [GameKnowledge] üöÄ TRIGGER called for: ${e} (IGDB ID: ${r})`),ne(r,e).catch(t=>{console.error(`üéÆ [GameKnowledge] ‚ùå Background fetch FAILED for ${e}:`,t),console.error("üéÆ [GameKnowledge] ‚ùå Error details:",{message:t.message,stack:t.stack,igdbGameId:r,gameName:e})}),console.log(`üéÆ [GameKnowledge] ‚úÖ Background fetch initiated for ${e}`)}const Ne=Object.freeze(Object.defineProperty({__proto__:null,triggerGameKnowledgeFetch:Y},Symbol.toStringTag,{value:"Module"})),h={LIBRARY:"otagon_gaming_library",TIMELINE:"otagon_gaming_timeline",TIMELINE_ALBUMS:"otagon_timeline_albums",TIMELINE_PHOTOS:"otagon_timeline_photos",NEWS_CACHE:"otagon_gaming_news_cache",NEWS_GENERATION_LOG:"otagon_news_generation_log",GAME_KNOWLEDGE:"otagon_game_knowledge",USER_PROFILE:"otagon_user_gaming_profile",GAMEPLAY_SESSIONS:"otagon_gameplay_sessions",IGDB_HOME_CACHE:"otagon_igdb_home_cache",SEARCH_HISTORY:"otagon_game_search_history"};function H(){var r;return((r=crypto.randomUUID)==null?void 0:r.call(crypto))||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function C(r,e){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch(t){return console.warn(`[GamingExplorerStorage] Error reading ${r}:`,t),e}}function S(r,e){try{return localStorage.setItem(r,JSON.stringify(e)),!0}catch(t){return console.error(`[GamingExplorerStorage] Error writing ${r}:`,t),!1}}const we={async loadFromSupabase(r){try{console.log("[LibraryStorage] Loading from Supabase...");const e=await L.getAll(r),t=this.getAll();e.length===0&&t.length>0?(console.log("[LibraryStorage] First sync: Uploading localStorage to Supabase"),await L.syncFromLocalStorage(r,t)):e.length>0&&(console.log(`[LibraryStorage] Loaded ${e.length} items from Supabase`),S(h.LIBRARY,e),this.updateStats())}catch(e){console.error("[LibraryStorage] Failed to load from Supabase:",e)}},getAll(){return C(h.LIBRARY,[])},getByCategory(r){return this.getAll().filter(t=>t.category===r)},getByIgdbId(r){return this.getAll().find(t=>t.igdbGameId===r)},getByGameTitle(r){const e=this.getAll(),t=r.toLowerCase().trim();return e.find(a=>a.gameName.toLowerCase().trim()===t)},getGameCategories(r){return this.getAll().filter(t=>t.igdbGameId===r).map(t=>t.category)},addGame(r,e,t,a,o){const i=this.getAll(),n=i.find(m=>m.igdbGameId===r&&m.category===t);if(n)return n.updatedAt=Date.now(),o!=null&&o.platform&&(n.platform=o.platform),o!=null&&o.personalRating&&(n.personalRating=o.personalRating),o!=null&&o.completionStatus&&(n.completionStatus=o.completionStatus),a&&(n.igdbData=a),S(h.LIBRARY,i),this.updateStats(),n;const l={id:H(),igdbGameId:r,gameName:e,category:t,platform:o==null?void 0:o.platform,personalRating:o==null?void 0:o.personalRating,completionStatus:(o==null?void 0:o.completionStatus)||(t==="own"?"not_started":void 0),igdbData:a,dateAdded:Date.now(),updatedAt:Date.now()};i.push(l),S(h.LIBRARY,i),this.updateStats(),t==="own"&&(console.log(`üéÆ [LibraryStorage] Game added as OWNED: "${e}" (IGDB ID: ${r})`),console.log("üéÆ [LibraryStorage] Triggering background knowledge fetch..."),Y(r,e));const u=P.getCurrentUser();return u!=null&&u.authUserId&&L.add(u.authUserId,l).catch(m=>{console.error("[LibraryStorage] Failed to sync to Supabase:",m)}),l},updateGame(r,e){const t=this.getAll(),a=t.findIndex(i=>i.id===r);if(a===-1)return null;t[a]={...t[a],...e,updatedAt:Date.now()},S(h.LIBRARY,t),this.updateStats();const o=P.getCurrentUser();return o!=null&&o.authUserId&&L.update(o.authUserId,t[a]).catch(i=>{console.error("[LibraryStorage] Failed to update in Supabase:",i)}),t[a]},removeGame(r,e){const t=this.getAll(),a=t.filter(i=>!(i.igdbGameId===r&&i.category===e));if(a.length===t.length)return!1;S(h.LIBRARY,a),this.updateStats();const o=P.getCurrentUser();return o!=null&&o.authUserId&&L.remove(o.authUserId,r,e).catch(i=>{console.error("[LibraryStorage] Failed to remove from Supabase:",i)}),!0},moveGame(r,e,t){const a=this.getAll(),o=a.find(i=>i.igdbGameId===r&&i.category===e);return o?(o.category=t,o.updatedAt=Date.now(),S(h.LIBRARY,a),this.updateStats(),!0):!1},toggleCategory(r,e,t,a){return this.getAll().find(n=>n.igdbGameId===r&&n.category===t)?(this.removeGame(r,t),{added:!1}):{added:!0,item:this.addGame(r,e,t,a)}},updateStats(){const r=this.getAll(),e=re.get();e.libraryStats={ownedCount:r.filter(t=>t.category==="own").length,completedCount:r.filter(t=>t.category==="own"&&t.completionStatus==="completed").length,wishlistCount:r.filter(t=>t.category==="wishlist").length,favoritesCount:r.filter(t=>t.category==="favorite").length,dislikedCount:r.filter(t=>t.category==="disliked").length,totalHoursPlayed:r.reduce((t,a)=>t+(a.hoursPlayed||0),0)},e.lastUpdated=Date.now(),re.save(e)}},Te={async loadFromSupabase(r){try{console.log("[TimelineStorage] Loading from Supabase...");const e=await O.getAll(r),t=this.getAll();e.length===0&&t.length>0?(console.log("[TimelineStorage] First sync: Uploading localStorage to Supabase"),await O.syncFromLocalStorage(r,t)):e.length>0&&(console.log(`[TimelineStorage] Loaded ${e.length} events from Supabase`),S(h.TIMELINE,e))}catch(e){console.error("[TimelineStorage] Failed to load from Supabase:",e)}},getAll(){return C(h.TIMELINE,[]).sort((e,t)=>new Date(t.eventDate).getTime()-new Date(e.eventDate).getTime())},getByYear(r){return this.getAll().filter(t=>t.year===r)},getYears(){const r=this.getAll();return[...new Set(r.map(t=>t.year))].sort((t,a)=>a-t)},addEvent(r){const e=this.getAll(),t={...r,id:H(),createdAt:Date.now(),updatedAt:Date.now()};e.push(t),S(h.TIMELINE,e);const a=P.getCurrentUser();return a!=null&&a.authUserId&&O.add(a.authUserId,t).catch(o=>{console.error("[TimelineStorage] Failed to sync to Supabase:",o)}),t},updateEvent(r,e){const t=C(h.TIMELINE,[]),a=t.findIndex(o=>o.id===r);return a===-1?null:(t[a]={...t[a],...e,updatedAt:Date.now()},S(h.TIMELINE,t),t[a])},deleteEvent(r){const e=C(h.TIMELINE,[]),t=e.filter(o=>o.id!==r);if(t.length===e.length)return!1;S(h.TIMELINE,t);const a=P.getCurrentUser();return a!=null&&a.authUserId&&O.remove(a.authUserId,r).catch(o=>{console.error("[TimelineStorage] Failed to remove from Supabase:",o)}),!0},addConsole(r,e,t,a){return this.addEvent({type:"console",eventDate:`${e}-01-01`,year:e,title:r,description:t,photos:a?[a]:void 0})},addPCBuild(r,e,t,a){return this.addEvent({type:"pc_build",eventDate:`${e}-01-01`,year:e,title:r,specs:t,photos:a})},addGameMilestone(r,e,t,a,o){return this.addEvent({type:"game",eventDate:`${t}-01-01`,year:t,title:r,description:a,igdbGameId:e,igdbData:o})}},Fe={getAll(){return C(h.GAMEPLAY_SESSIONS,[])},getByGame(r){return this.getAll().filter(t=>t.igdbGameId===r)},getByDateAndGame(r,e){return this.getAll().find(a=>a.sessionDate===r&&a.igdbGameId===e)},addScreenshot(r,e,t){const a=this.getAll(),o=new Date().toISOString().split("T")[0];let i=a.find(u=>u.sessionDate===o&&u.igdbGameId===r);i||(i={id:H(),igdbGameId:r,gameName:e,sessionDate:o,screenshots:[],createdAt:Date.now()},a.push(i));const n={...t,id:H(),sessionId:i.id};i.screenshots.push(n),S(h.GAMEPLAY_SESSIONS,a);const l=P.getCurrentUser();return l!=null&&l.authUserId&&ue.add(l.authUserId,n,e).catch(u=>{console.error("[GameplaySessionsStorage] Failed to sync screenshot to Supabase:",u)}),i},getScreenshotCount(r){return this.getByGame(r).reduce((t,a)=>t+a.screenshots.length,0)}},Ke={get(r){const t=C(h.NEWS_CACHE,[]).find(a=>a.promptType===r);return t&&t.expiresAt>Date.now()?t:null},async getAsync(r){const e=await J.getCache(r);if(e){const t=Date.now();return{promptType:r,items:e.map(a=>({...a,cachedAt:t})),cachedAt:t,expiresAt:t+1440*60*1e3}}return this.get(r)},save(r){const e=C(h.NEWS_CACHE,[]),t=e.findIndex(a=>a.promptType===r.promptType);t>=0?e[t]=r:e.push(r),S(h.NEWS_CACHE,e),J.setCache(r.promptType,r.items).catch(a=>{console.error("[NewsCache] Failed to save to Supabase:",a)})},canGenerate(r,e){const t=C(h.NEWS_GENERATION_LOG,[]),a=Date.now()-1440*60*1e3,o=t.find(i=>i.userId===r&&i.promptType===e&&i.generatedAt>a);return o?{allowed:!1,nextAvailableAt:o.generatedAt+1440*60*1e3}:{allowed:!0}},logGeneration(r,e){const a=C(h.NEWS_GENERATION_LOG,[]).filter(o=>!(o.userId===r&&o.promptType===e));a.push({userId:r,promptType:e,generatedAt:Date.now()}),S(h.NEWS_GENERATION_LOG,a)},getCacheAge(r){const e=this.get(r);return e?Math.floor((Date.now()-e.cachedAt)/(3600*1e3)):null}},te={get(r){return C(h.GAME_KNOWLEDGE,[]).find(t=>t.igdbGameId===r)||null},exists(r){return this.get(r)!==null},save(r){const e=C(h.GAME_KNOWLEDGE,[]),t=e.findIndex(a=>a.igdbGameId===r.igdbGameId);t>=0?e[t]={...r,lastUpdated:Date.now()}:e.push(r),S(h.GAME_KNOWLEDGE,e)},getAllExtracted(){return C(h.GAME_KNOWLEDGE,[]).map(e=>e.igdbGameId)}},re={get(){return C(h.USER_PROFILE,{libraryStats:{ownedCount:0,completedCount:0,wishlistCount:0,favoritesCount:0,dislikedCount:0,totalHoursPlayed:0},lastUpdated:Date.now()})},save(r){S(h.USER_PROFILE,r)},setGamingStartYear(r){const e=this.get();e.gamingStartYear=r,e.lastUpdated=Date.now(),this.save(e)},getGamingStartYear(){return this.get().gamingStartYear},needsOnboarding(){return this.get().gamingStartYear===void 0}},Ge=12,ze={getAll(){return C(h.SEARCH_HISTORY,[])},getGames(){return this.getAll().map(r=>r.gameData)},add(r){const t=this.getAll().filter(o=>o.gameData.id!==r.id),a=[{gameData:r,searchedAt:Date.now()},...t].slice(0,Ge);S(h.SEARCH_HISTORY,a)},remove(r){const t=this.getAll().filter(a=>a.gameData.id!==r);S(h.SEARCH_HISTORY,t)},clear(){localStorage.removeItem(h.SEARCH_HISTORY)},hasHistory(){return this.getAll().length>0}},ae=3e3;function K(){var r;return((r=globalThis.crypto)==null?void 0:r.randomUUID())||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}class Ce{async createGameTab(e){var u,m,c;const t=await b.getConversation(e.conversationId);if(t){if(e.aiResponse&&((u=t.subtabs)!=null&&u.some(s=>s.status==="loading"||s.content==="Loading..."))){const s=this.extractInsightsFromAIResponse(e.aiResponse,t.subtabs);return await b.updateConversation(t.id,{subtabs:s,updatedAt:Date.now()}),{...t,subtabs:s}}return t}const a=e.userTier||"free",o=a==="pro"||a==="vanguard_pro";if(e.isUnreleased){const s=await Q.canCreateUnreleasedTab(e.userId,a);if(!s.canCreate)throw new Error(`You've reached your limit of ${s.limit} unreleased game tabs. ${o?"Delete an existing unreleased tab to add a new one.":"Upgrade to Pro for up to 10 unreleased game tabs."}`)}console.log("üéÆ [GameTabService] Creating new game tab:",{gameTitle:e.gameTitle,userTier:a,isPro:o,isUnreleased:e.isUnreleased,hasAiResponse:!!e.aiResponse});let i=[];if(!e.isUnreleased&&o)if(e.aiResponse)if(console.error("üéÆ [GameTabService] Extracting subtabs from AI response"),(m=e.aiResponse.gamePillData)!=null&&m.wikiContent&&Object.keys(e.aiResponse.gamePillData.wikiContent).length>0)console.error("üéÆ [GameTabService] Found gamePillData.wikiContent with",Object.keys(e.aiResponse.gamePillData.wikiContent).length,"tabs"),i=Object.entries(e.aiResponse.gamePillData.wikiContent).map(([s,g])=>({id:K(),title:this.formatTabTitle(s),type:this.determineTabType(s),content:g,isNew:!1,status:"loaded"})),console.error("üéÆ [GameTabService] Created",i.length,"subtabs from gamePillData.wikiContent");else if(e.aiResponse.progressiveInsightUpdates&&e.aiResponse.progressiveInsightUpdates.length>0)console.error("üéÆ [GameTabService] Found progressiveInsightUpdates with",e.aiResponse.progressiveInsightUpdates.length,"updates"),i=e.aiResponse.progressiveInsightUpdates.map(s=>({id:K(),title:s.title,type:this.determineTabType(s.tabId),content:s.content,isNew:!1,status:"loaded"})),console.error("üéÆ [GameTabService] Created",i.length,"subtabs from progressiveInsightUpdates");else{const s=this.extractInsightsFromAIResponse(e.aiResponse,[]);s.length>0?(i=s,console.error("üéÆ [GameTabService] Created",i.length,"subtabs from INSIGHT_UPDATE tags")):(i=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile,{gameTitle:e.gameTitle}),console.error("üéÆ [GameTabService] Created",i.length,"template subtabs (will populate via background AI using conversation context)"))}else i=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile,{gameTitle:e.gameTitle}),console.error("üéÆ [GameTabService] Created",i.length,"initial template subtabs (no AI response)");else e.isUnreleased?console.error("üéÆ [GameTabService] Creating unreleased game tab (no subtabs, Discuss mode only)"):console.error("üîí [GameTabService] Subtabs disabled for free tier users");const n={id:e.conversationId,title:e.gameTitle,messages:[],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,gameId:e.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:e.gameTitle,genre:e.genre,subtabs:i,subtabsOrder:i.map(s=>s.id),isActiveSession:!0,activeObjective:"",gameProgress:0,isUnreleased:e.isUnreleased||!1};if(await b.addConversation(n),b.clearCache(),console.log("üéÆ [GameTabService] Cache invalidated after creating new tab:",n.id),!e.isUnreleased&&o){const s=we.getByGameTitle(e.gameTitle);s!=null&&s.igdbGameId?(console.log(`üéÆ [GameTabService] Triggering background game knowledge fetch for ${e.gameTitle} (IGDB: ${s.igdbGameId})`),Y(s.igdbGameId,e.gameTitle)):console.log(`üéÆ [GameTabService] No IGDB ID for ${e.gameTitle}, skipping knowledge fetch`)}if(e.isUnreleased&&await Q.trackUnreleasedTab(e.userId,n.id,0,e.gameTitle),i.length>0&&o){console.error("üéÆ [GameTabService] Saving",i.length,"subtabs for conversation:",n.id),console.error("üéÆ [GameTabService] Subtabs:",JSON.stringify(i.map(g=>({id:g.id,title:g.title,type:g.type,hasType:!!g.type})),null,2)),await new Promise(g=>setTimeout(g,200));let s=await I.setSubtabs(n.id,i);s||(console.error("‚ö†Ô∏è [GameTabService] First setSubtabs attempt failed, waiting and retrying..."),await new Promise(g=>setTimeout(g,500)),s=await I.setSubtabs(n.id,i),console.error(s?"‚úÖ [GameTabService] Retry succeeded":"‚ùå [GameTabService] Retry also failed - subtabs will be created by generateInitialInsights"))}else o?console.error("üéÆ [GameTabService] No subtabs to save for conversation:",n.id):console.error("üîí [GameTabService] Skipping subtabs save for free tier user");const l=n.messages.length<=2;return o&&l?(console.log(`üéØ [GameTabService] First message detected - will generate initial insights for: ${n.gameTitle}`),e.aiResponse?(c=n.subtabs)!=null&&c.some(g=>g.content==="Loading...")&&this.generateInitialInsights(n,e.playerProfile,e.aiResponse).catch(g=>console.error("Background insight generation failed:",g)):this.generateInitialInsights(n,e.playerProfile,e.aiResponse).catch(s=>console.error("Background insight generation failed:",s))):o&&!l?console.log(`üìù [GameTabService] Subsequent message (${n.messages.length} msgs) - skipping insight generation to save Gemini calls`):console.error("üîí [GameTabService] Skipping AI insight generation for free tier user"),n}getGameSpecificTabCustomizations(e){const t=e.toLowerCase();return t.includes("elden ring")?[{title:"Story So Far",type:"story",instruction:"Track the Tarnished's journey through the Lands Between, major demigod encounters, and story progression.",priority:"high",isProfileSpecific:!1},{title:"Sites of Grace Nearby",type:"tips",instruction:"List nearby Sites of Grace, their locations, and what areas they unlock.",priority:"high",isProfileSpecific:!1},{title:"Boss Strategy",type:"strategies",instruction:"Detailed strategies for Great Rune bearers, remembrance bosses, and field bosses.",priority:"high",isProfileSpecific:!1},{title:"Character Questlines",type:"characters",instruction:"Track NPC questlines like Ranni, Fia, Millicent, and their current progress.",priority:"high",isProfileSpecific:!1},{title:"Remembrances & Items",type:"items",instruction:"Track collected remembrances, Great Runes, and legendary armaments/ashes of war.",priority:"high",isProfileSpecific:!1}]:t.includes("cyberpunk")?[{title:"Story Progress",type:"story",instruction:"Track main story missions, relationship with Johnny Silverhand, and key choices made.",priority:"high",isProfileSpecific:!1},{title:"Fixers & Gigs",type:"walkthrough",instruction:"List available fixers in current district, active gigs, and completed contracts.",priority:"high",isProfileSpecific:!1},{title:"Cyberware Build",type:"strategies",instruction:"Current cyberware loadout, recommended upgrades, and build synergies.",priority:"high",isProfileSpecific:!1},{title:"Characters & Relationships",type:"characters",instruction:"Track relationships with Panam, Judy, River, Kerry, and romance options.",priority:"high",isProfileSpecific:!1},{title:"Night City Secrets",type:"tips",instruction:"Hidden legendary weapons, iconic gear locations, and easter eggs in current area.",priority:"high",isProfileSpecific:!1}]:t.includes("dark souls")?[{title:"Story So Far",type:"story",instruction:"Track the Chosen Undead's journey, Lords of Cinder defeated, and covenant allegiances.",priority:"high",isProfileSpecific:!1},{title:"Nearby Bonfires",type:"tips",instruction:"List nearby bonfires, their locations, and connectivity to other areas.",priority:"high",isProfileSpecific:!1},{title:"Boss Strategy",type:"strategies",instruction:"Strategies for Lord Souls, required bosses, and optional powerful enemies.",priority:"high",isProfileSpecific:!1},{title:"Covenant Progress",type:"walkthrough",instruction:"Track covenant memberships, offering progress, and covenant-specific rewards.",priority:"high",isProfileSpecific:!1},{title:"Upgrade Paths",type:"items",instruction:"Weapon upgrade materials, blacksmith locations, and recommended upgrade paths for current build.",priority:"high",isProfileSpecific:!1}]:t.includes("baldur")||t.includes("bg3")?[{title:"Story & Choices",type:"story",instruction:"Track main story progress, major decisions made, and their consequences. Note which companions were recruited and key story branches taken.",priority:"high",isProfileSpecific:!1},{title:"Companion Approval",type:"characters",instruction:"Track companion relationships, approval ratings, personal quests, and romance progress.",priority:"high",isProfileSpecific:!1},{title:"Build & Multiclass",type:"strategies",instruction:"Current character build, multiclass options, and synergistic spell/ability combinations.",priority:"high",isProfileSpecific:!1},{title:"Active Quests",type:"walkthrough",instruction:"List active main quests and important side quests in current act, with quest objectives.",priority:"high",isProfileSpecific:!1},{title:"Secrets & Items",type:"items",instruction:"Hidden legendary items, secret areas, and missable content in current region.",priority:"high",isProfileSpecific:!1}]:t.includes("witcher")?[{title:"Story Progress",type:"story",instruction:"Track main story, key decisions, Ciri's journey, and major political developments.",priority:"high",isProfileSpecific:!1},{title:"Contracts & Quests",type:"walkthrough",instruction:"Active witcher contracts, treasure hunts, and important side quests in current region.",priority:"high",isProfileSpecific:!1},{title:"Combat & Alchemy",type:"strategies",instruction:"Best potions, oils, and decoctions for current enemies. Sign usage tips and combat strategies.",priority:"high",isProfileSpecific:!1},{title:"Characters & Romance",type:"characters",instruction:"Track relationships with Yennefer, Triss, and other key characters. Romance quest progress.",priority:"high",isProfileSpecific:!1},{title:"Gear & Diagrams",type:"items",instruction:"Witcher gear sets available, diagram locations, and upgrade materials needed.",priority:"high",isProfileSpecific:!1}]:t.includes("hollow knight")?[{title:"Exploration Progress",type:"story",instruction:"Track areas explored, lore discovered, and connections between regions.",priority:"high",isProfileSpecific:!1},{title:"Boss Strategies",type:"strategies",instruction:"Detailed strategies for current and nearby bosses, including dream versions and optional challenges.",priority:"high",isProfileSpecific:!1},{title:"Charm Builds",type:"items",instruction:"Recommended charm combinations for current playstyle, and where to find new charms.",priority:"high",isProfileSpecific:!1},{title:"Hidden Secrets",type:"tips",instruction:"Secret paths, hidden rooms, and breakable walls in current and nearby areas.",priority:"high",isProfileSpecific:!1},{title:"NPC Questlines",type:"characters",instruction:"Track NPC locations, quest progress for characters like Hornet, Quirrel, and Bretta.",priority:"high",isProfileSpecific:!1}]:t.includes("god of war")?[{title:"Story & Mythology",type:"story",instruction:"Track main story progress, realm visits, and Norse mythology lore discovered.",priority:"high",isProfileSpecific:!1},{title:"Boss & Enemy Tactics",type:"strategies",instruction:"Strategies for bosses and tough enemies, including optimal runic attacks and Spartan Rage usage.",priority:"high",isProfileSpecific:!1},{title:"Gear & Upgrades",type:"items",instruction:"Best armor sets for current level, weapon upgrades, and where to find crafting materials.",priority:"high",isProfileSpecific:!1},{title:"Realm Exploration",type:"tips",instruction:"Areas to explore in current realm, hidden chests, and optional content.",priority:"high",isProfileSpecific:!1},{title:"Collectibles",type:"walkthrough",instruction:"Track Odin's Ravens, Nornir Chests, artifacts, and other collectibles in current regions.",priority:"high",isProfileSpecific:!1}]:null}generateInitialSubTabs(e,t,a){const o=(a==null?void 0:a.gameTitle)||"",i=this.getGameSpecificTabCustomizations(o);let n;if(i?(n=i,console.error("üéÆ [GameTabService] Using game-specific subtabs for:",o)):(n=(W[e]||W.Default).map(u=>({...u,priority:"medium",isProfileSpecific:!1})),console.error("üéÆ [GameTabService] Using genre-based subtabs for genre:",e)),t){console.error("üéÆ [GameTabService] Generating profile-specific tabs for:",t.playerFocus);const l=V.generateProfileSpecificTabs(t,a);n=[...n,...l],n=V.prioritizeTabsForProfile(n,t)}return n.map(l=>({id:K(),title:l.title,type:l.type,content:"Loading...",isNew:!0,status:"loading",instruction:l.instruction}))}extractInsightsFromAIResponse(e,t){console.error("ü§ñ [GameTabService] Extracting dynamic insights from AI response");const a=e.otakonTags.get("INSIGHT_UPDATE");if(a){console.error("ü§ñ [GameTabService] Found INSIGHT_UPDATE:",a);const o=a;if(!o.id)return console.error("ü§ñ [GameTabService] INSIGHT_UPDATE missing id, skipping"),t;if(t.find(n=>n.id===o.id))return t.map(n=>n.id===o.id?{...n,content:o.content||n.content,isNew:!0,status:"loaded"}:n);{const n={id:K(),title:this.formatTabTitle(o.id),type:this.determineTabType(o.id),content:o.content||"",isNew:!0,status:"loaded"};return[...t,n]}}return t}formatTabTitle(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}determineTabType(e){return e.includes("story")?"story":e.includes("character")?"characters":e.includes("strategy")||e.includes("tips")?"tips":e.includes("boss")?"strategies":e.includes("quest")||e.includes("walkthrough")?"walkthrough":e.includes("item")?"items":"chat"}async generateInitialInsights(e,t,a){var n,l,u;const o=e.id,i=e.gameTitle;console.error(`ü§ñ [GameTabService] üîÑ [${o}] Generating initial insights for: ${i}`);try{const m=await b.getConversations(!0);if(!m[o]){console.error(`ü§ñ [GameTabService] [${o}] ‚ö†Ô∏è Conversation no longer exists, aborting insight generation`);return}let c="";const s=m[o],g=((n=s.messages)==null?void 0:n.length)||0;if(g>10)try{const d=await ce.loadConversationSummary(o),f=s.messages.slice(-5).map(T=>`${T.role==="user"?"User":"AI"}: ${T.content}`).join(`

`);d?(c=`Previous Context Summary:
${JSON.stringify(d)}

Recent Messages (guaranteed fresh):
${f}`,console.error(`ü§ñ [GameTabService] [${o}] ‚úÖ Using summary + 5 recent messages (${g} total msgs)`)):(c=s.messages.slice(-10).map(T=>`${T.role==="user"?"User":"AI"}: ${T.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${o}] Using last 10 messages (no summary available)`))}catch{c=s.messages.slice(-10).map(f=>`${f.role==="user"?"User":"AI"}: ${f.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${o}] Using last 10 messages (summary load failed)`)}else g>0?(c=s.messages.map(d=>`${d.role==="user"?"User":"AI"}: ${d.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${o}] ‚úÖ Using all ${g} messages`)):a!=null&&a.content?(c=`AI Analysis: ${a.content}`,console.error(`ü§ñ [GameTabService] [${o}] Using AI response as context (${a.content.length} chars)`)):console.error(`ü§ñ [GameTabService] [${o}] ‚ö†Ô∏è No context available`);console.error(`ü§ñ [GameTabService] [${o}] üöÄ Calling AI generateInitialInsights...`);const p=await ge.generateInitialInsights(i||"Unknown Game",e.genre||"Action RPG",t,c,s.gameProgress||0);console.error(`ü§ñ [GameTabService] [${o}] üì• AI returned:`,Object.keys(p).length,"insights");const _=p&&Object.keys(p).length>0;_?console.error(`ü§ñ [GameTabService] [${o}] ‚úÖ Got ${Object.keys(p).length} insights:`,Object.keys(p)):console.error(`ü§ñ [GameTabService] [${o}] ‚ùå Empty insights, using fallback`);const y=m[o];if(!y){console.error(`ü§ñ [GameTabService] [${o}] ‚ö†Ô∏è Conversation not found, may have been deleted`);return}let v=await I.getSubtabs(o);console.error(`ü§ñ [GameTabService] [${o}] üìñ Read ${v.length} subtabs from database`),v.length===0&&e.subtabs&&e.subtabs.length>0&&(console.error(`ü§ñ [GameTabService] [${o}] ‚ö†Ô∏è No subtabs in DB but ${e.subtabs.length} in memory - retrying write`),await new Promise(f=>setTimeout(f,500)),await I.setSubtabs(o,e.subtabs)?(console.error(`ü§ñ [GameTabService] [${o}] ‚úÖ Retry write succeeded`),v=await I.getSubtabs(o),console.error(`ü§ñ [GameTabService] [${o}] üìñ Re-read ${v.length} subtabs from database`)):(console.error(`ü§ñ [GameTabService] [${o}] ‚ùå Retry write failed - using memory subtabs as fallback`),v=e.subtabs)),y.subtabs=v;const A={"Story So Far":"story_so_far","Items You May Have Missed":"missed_items","Relevant Lore":"game_lore","Build Guide":"build_guide","Plan Your Next Session":"next_session_plan","Active Quests":"quest_log","Build Optimization":"build_optimization","Upcoming Boss Strategy":"boss_strategy","Boss Strategy":"boss_strategy","Hidden Paths & Secrets":"hidden_paths","Points of Interest":"points_of_interest","NPC Interactions":"npc_interactions","Consumable Strategy":"consumable_strategy","Character Building":"character_building","Combat Strategies":"combat_strategies","Quest Guide":"quest_guide","Lore Exploration":"lore_exploration","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Pro Tips":"pro_tips","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Exploration Tips":"exploration_tips","Puzzle Solving":"puzzle_solving","Story Progression":"story_progression","Hidden Secrets":"hidden_secrets","Inventory Optimization":"inventory_optimization","Environmental Storytelling":"environmental_storytelling","Goal Suggestions":"goal_suggestions","Efficiency & Optimization":"efficiency_tips","Hidden Mechanics":"hidden_mechanics","Disaster Prep":"disaster_prep","Milestone Roadmap":"milestone_roadmap","System Bottleneck Analysis":"bottleneck_analysis","Expansion Strategy":"expansion_strategy","Team Management":"team_management","Training Focus":"training_focus","Tactical Analysis":"tactical_analysis","Season Progression":"season_progression","Transfer Market Insights":"transfer_market_insights","Injury & Fatigue Management":"injury_fatigue_management","Opposition Scouting":"opposition_scouting","Meta Analysis":"meta_analysis","Team Coordination":"team_coordination","Map Control":"map_control","Skill Development":"skill_development","Ranked Climbing Guide":"ranked_climbing_guide","Warm-up Routine":"warmup_routine","Counter-Meta Strategies":"counter_meta_strategies","Competitive Strategy":"competitive_strategy","Team Synergy":"team_synergy","Performance Optimization":"performance_optimization","Ranked Progression":"ranked_progression","Seasonal Meta Shifts":"seasonal_meta_shifts","Communication Protocols":"communication_protocols","VOD Review Focus Points":"vod_review_focus","Vehicle Tuning":"vehicle_tuning","Track Strategy":"track_strategy","Race Craft":"race_craft","Championship Focus":"championship_focus","Weather Adaptation":"weather_adaptation","Qualifying Strategy":"qualifying_strategy","Rival Analysis":"rival_analysis","Character Analysis":"character_analysis","Matchup Strategy":"matchup_strategy","Execution Training":"execution_training","Tournament Prep":"tournament_prep","Frame Data Insights":"frame_data_insights","Mid-Match Adaptation":"adaptation_tactics","Character Lab Work":"character_lab_work","Drop Strategy":"drop_strategy","Positioning Tactics":"positioning_tactics","Loadout Optimization":"loadout_optimization","Endgame Strategy":"endgame_strategy","Rotation Management":"rotation_management","Audio Warfare":"audio_warfare","Inventory Economy":"inventory_economy","Class Optimization":"class_optimization","Content Progression":"content_progression","Social Strategies":"social_strategies","Alt Character Strategy":"alt_character_strategy","Reputation & Faction Guide":"reputation_faction_guide","Raid Preparation":"raid_preparation","Puzzle Patterns":"puzzle_patterns","Logical Reasoning":"logical_reasoning","Time Optimization":"time_optimization","Difficulty Progression":"difficulty_progression","Mental Breaks Strategy":"mental_breaks_strategy","Pattern Library":"pattern_library","Achievement & Challenge Guide":"achievement_guide","Survival Strategies":"survival_strategies","Enemy Behavior":"enemy_behavior","Atmosphere Navigation":"atmosphere_navigation","Resource Management":"resource_management","Safe Zone Mapping":"safe_zone_mapping","Sanity Management":"sanity_management","Progressive Fear Adaptation":"fear_adaptation","Death Recovery Strategy":"death_recovery","Level Layout Insights":"level_layout","NPC Questlines":"npc_questlines","New Ability Unlocked":"ability_unlocks","Backtracking Guide":"backtracking_guide","Map Completion":"map_completion","Sequence Breaking Options":"sequence_breaking","Upgrade Priority":"upgrade_priority","Region Guide":"region_guide","Activity Checklist":"activity_checklist","Collectible Hunting":"collectible_hunting","Dynamic World Events":"world_events","Exploration Route":"exploration_route","Fast Travel Optimization":"fast_travel_optimization","Progression Balance":"progression_balance","Resource Locations":"resource_locations","Base Building Guide":"base_building","Crafting Priority":"crafting_priority","Survival Tips":"survival_tips","Exploration Targets":"exploration_targets","Progression Roadmap":"progression_roadmap","Danger Warnings":"danger_warnings","Multiplayer Synergy":"multiplayer_synergy","Seasonal Preparation":"seasonal_preparation"};console.error("ü§ñ [GameTabService] Building content mapping for subtabs..."),console.error("ü§ñ [GameTabService] AI returned insight keys:",Object.keys(p));const w=((l=y.subtabs)==null?void 0:l.map(d=>{let f="";const T=A[d.title];if(T||console.error(`‚ö†Ô∏è [GameTabService] MISSING MAPPING: No titleToKeyMap entry for "${d.title}" - will use fallback`),_&&T&&p[T]?(f=p[T],console.error(`‚úÖ [GameTabService] Subtab "${d.title}" ‚Üí key "${T}" ‚Üí AI content (${f.length} chars)`)):_&&T&&console.error(`‚ö†Ô∏è [GameTabService] Subtab "${d.title}" ‚Üí key "${T}" ‚Üí NOT FOUND in AI response`),!f){let M=c;if(d.type==="story"&&c.includes("Lore:")){const E=c.match(/Lore:(.*?)(?=\n\n|\n[A-Z]|$)/s);M=E?E[1].trim():c}else if(d.type==="strategies"&&c.includes("Analysis:")){const E=c.match(/Analysis:(.*?)(?=\n\n|\n[A-Z]|$)/s);M=E?E[1].trim():c}else if(d.type==="tips"&&c.includes("Hint:")){const E=c.match(/Hint:(.*?)(?=\n\n|\n[A-Z]|$)/s);M=E?E[1].trim():c}f=`## ${d.title}

${M}`,console.error(`ü§ñ [GameTabService] Subtab "${d.title}" using fallback content from AI response (${f.length} chars)`),console.error("ü§ñ [GameTabService] Preview:",f.substring(0,150)+"...")}return{...d,content:f,isNew:!1,status:"loaded",type:d.type}}))||[];if(w.length===0){console.error(`ü§ñ [GameTabService] [${o}] ‚ö†Ô∏è No subtabs to update - aborting`);return}console.error("ü§ñ [GameTabService] Updating subtabs with content...");const R=w.map(d=>{var f;return{id:d.id,title:d.title,type:d.type,status:d.status,contentLength:((f=d.content)==null?void 0:f.length)||0,isNew:d.isNew,hasType:!!d.type}});if(console.error("ü§ñ [GameTabService] Subtabs to save:",R),console.error("ü§ñ [GameTabService] ALL statuses:",w.map(d=>d.status)),console.error("ü§ñ [GameTabService] ALL types:",w.map(d=>d.type||"MISSING_TYPE")),console.error("ü§ñ [GameTabService] üóëÔ∏è Clearing cache BEFORE subtabs write..."),b.clearCache(),!await I.setSubtabs(e.id,w))throw new Error("Failed to update subtabs in database");console.error("ü§ñ [GameTabService] ‚úÖ Subtabs dual-write complete (table + JSONB)"),b.clearCache(),console.error("ü§ñ [GameTabService] üîç Subtabs saved successfully, skipping verification read"),await b.updateConversation(e.id,{updatedAt:Date.now()}),console.error("ü§ñ [GameTabService] ‚úÖ Conversation metadata updated")}catch(m){console.error("ü§ñ [GameTabService] ‚ùå Failed to generate initial insights:",m),Z.warning("Failed to load game insights. You can still chat about the game!");try{const s=(await b.getConversations(!0))[e.id];if(!s){console.error("ü§ñ [GameTabService] Conversation not found for error update:",e.id);return}const g=((u=s.subtabs)==null?void 0:u.map(p=>({...p,content:`Failed to load ${p.title} content. Please try again later.`,isNew:!1,status:"error"})))||[];await I.setSubtabs(e.id,g),await b.updateConversation(e.id,{updatedAt:Date.now()})}catch(c){console.error("ü§ñ [GameTabService] Failed to update error state:",c)}}}async updateSubTabContent(e,t,a){console.error("üìù [GameTabService] Updating sub-tab content:",{conversationId:e,subTabId:t});try{const i=(await b.getConversations())[e];if(!i||!i.subtabs)throw new Error("Conversation or sub-tabs not found");const n=i.subtabs.map(l=>l.id===t?{...l,content:a,isNew:!1,status:"loaded"}:l);await I.setSubtabs(e,n),await b.updateConversation(e,{updatedAt:Date.now()})}catch(o){throw console.error("Failed to update sub-tab content:",o),o}}async getGameTab(e){try{const a=(await b.getConversations())[e];return!a||!a.gameTitle?null:{id:a.id,title:a.title,gameId:a.gameId||a.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:a.gameTitle,genre:a.genre||"Unknown",subtabs:a.subtabs||[],createdAt:a.createdAt,updatedAt:a.updatedAt,isActiveSession:a.isActiveSession||!1}}catch(t){return console.error("Failed to get game tab:",t),Z.error("Failed to load game tab."),null}}isGameTab(e){return!e.isGameHub&&!!e.gameTitle}generateGameConversationId(e){return`game-${e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-")}`}async updateSubtabsAfterMigration(e,t){console.error(`üîÑ [GameTabService] [${e}] Updating subtabs after migration...`);try{const o=(await b.getConversations(!0))[e];if(!o){console.error(`üîÑ [GameTabService] [${e}] ‚ö†Ô∏è Conversation not found, aborting`);return}if(!o.subtabs||o.subtabs.length===0){console.error(`üîÑ [GameTabService] [${e}] No subtabs to update`);return}t!=null&&t.progressiveInsightUpdates&&t.progressiveInsightUpdates.length>0?(console.error(`üîÑ [GameTabService] [${e}] Applying ${t.progressiveInsightUpdates.length} progressive updates`),await this.updateSubTabsFromAIResponse(e,t.progressiveInsightUpdates)):console.error(`üîÑ [GameTabService] [${e}] No progressive updates in AI response`),console.error(`üîÑ [GameTabService] [${e}] ‚úÖ Subtab update complete`)}catch(a){console.error(`üîÑ [GameTabService] [${e}] ‚ùå Failed to update subtabs:`,a)}}async updateSubTabsFromAIResponse(e,t){console.error(`üìù [GameTabService] [${e}] Updating subtabs from AI response:`,t.length),console.error(`üìù [GameTabService] [${e}] Updates to apply:`,t.map(a=>{var o;return{tabId:a.tabId,title:a.title,contentLength:((o=a.content)==null?void 0:o.length)||0}}));try{const o=(await b.getConversations(!0))[e];if(!o||!o.subtabs){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Conversation or subtabs not found, aborting update`);return}console.error(`üìù [GameTabService] [${e}] Found ${o.subtabs.length} subtabs:`,o.subtabs.map(s=>({id:s.id,title:s.title})));const i={"Story So Far":"story_so_far","Items You May Have Missed":"missed_items","Relevant Lore":"game_lore","Build Guide":"build_guide","Plan Your Next Session":"next_session_plan","Active Quests":"quest_log","Build Optimization":"build_optimization","Upcoming Boss Strategy":"boss_strategy","Boss Strategy":"boss_strategy","Hidden Paths & Secrets":"hidden_paths","Points of Interest":"points_of_interest","NPC Interactions":"npc_interactions","Consumable Strategy":"consumable_strategy","Character Building":"character_building","Combat Strategies":"combat_strategies","Quest Guide":"quest_guide","Lore Exploration":"lore_exploration","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Pro Tips":"pro_tips","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Exploration Tips":"exploration_tips","Puzzle Solving":"puzzle_solving","Story Progression":"story_progression","Hidden Secrets":"hidden_secrets","Inventory Optimization":"inventory_optimization","Environmental Storytelling":"environmental_storytelling","Goal Suggestions":"goal_suggestions","Efficiency & Optimization":"efficiency_tips","Hidden Mechanics":"hidden_mechanics","Disaster Prep":"disaster_prep","Milestone Roadmap":"milestone_roadmap","System Bottleneck Analysis":"bottleneck_analysis","Expansion Strategy":"expansion_strategy","Team Management":"team_management","Training Focus":"training_focus","Tactical Analysis":"tactical_analysis","Season Progression":"season_progression","Transfer Market Insights":"transfer_market_insights","Injury & Fatigue Management":"injury_fatigue_management","Opposition Scouting":"opposition_scouting","Meta Analysis":"meta_analysis","Team Coordination":"team_coordination","Map Control":"map_control","Skill Development":"skill_development","Ranked Climbing Guide":"ranked_climbing_guide","Warm-up Routine":"warmup_routine","Counter-Meta Strategies":"counter_meta_strategies","Competitive Strategy":"competitive_strategy","Team Synergy":"team_synergy","Performance Optimization":"performance_optimization","Ranked Progression":"ranked_progression","Seasonal Meta Shifts":"seasonal_meta_shifts","Communication Protocols":"communication_protocols","VOD Review Focus Points":"vod_review_focus","Vehicle Tuning":"vehicle_tuning","Track Strategy":"track_strategy","Race Craft":"race_craft","Championship Focus":"championship_focus","Weather Adaptation":"weather_adaptation","Qualifying Strategy":"qualifying_strategy","Rival Analysis":"rival_analysis","Character Analysis":"character_analysis","Matchup Strategy":"matchup_strategy","Execution Training":"execution_training","Tournament Prep":"tournament_prep","Frame Data Insights":"frame_data_insights","Mid-Match Adaptation":"adaptation_tactics","Character Lab Work":"character_lab_work","Drop Strategy":"drop_strategy","Positioning Tactics":"positioning_tactics","Loadout Optimization":"loadout_optimization","Endgame Strategy":"endgame_strategy","Rotation Management":"rotation_management","Audio Warfare":"audio_warfare","Inventory Economy":"inventory_economy","Class Optimization":"class_optimization","Content Progression":"content_progression","Social Strategies":"social_strategies","Alt Character Strategy":"alt_character_strategy","Reputation & Faction Guide":"reputation_faction_guide","Raid Preparation":"raid_preparation","Puzzle Patterns":"puzzle_patterns","Logical Reasoning":"logical_reasoning","Time Optimization":"time_optimization","Difficulty Progression":"difficulty_progression","Mental Breaks Strategy":"mental_breaks_strategy","Pattern Library":"pattern_library","Achievement & Challenge Guide":"achievement_guide","Survival Strategies":"survival_strategies","Enemy Behavior":"enemy_behavior","Atmosphere Navigation":"atmosphere_navigation","Resource Management":"resource_management","Safe Zone Mapping":"safe_zone_mapping","Sanity Management":"sanity_management","Progressive Fear Adaptation":"fear_adaptation","Death Recovery Strategy":"death_recovery","Level Layout Insights":"level_layout","NPC Questlines":"npc_questlines","New Ability Unlocked":"ability_unlocks","Backtracking Guide":"backtracking_guide","Map Completion":"map_completion","Sequence Breaking Options":"sequence_breaking","Upgrade Priority":"upgrade_priority","Region Guide":"region_guide","Activity Checklist":"activity_checklist","Collectible Hunting":"collectible_hunting","Dynamic World Events":"world_events","Exploration Route":"exploration_route","Fast Travel Optimization":"fast_travel_optimization","Progression Balance":"progression_balance","Resource Locations":"resource_locations","Base Building Guide":"base_building","Crafting Priority":"crafting_priority","Survival Tips":"survival_tips","Exploration Targets":"exploration_targets","Progression Roadmap":"progression_roadmap","Danger Warnings":"danger_warnings","Multiplayer Synergy":"multiplayer_synergy","Seasonal Preparation":"seasonal_preparation"},n={};for(const[s,g]of Object.entries(i))n[g]=s;let l=0;const u=o.subtabs.map(s=>{const g=t.find(p=>{if(p.tabId===s.id||p.tabId.toLowerCase()===s.title.toLowerCase()||p.title&&p.title.toLowerCase()===s.title.toLowerCase())return!0;const _=n[p.tabId];if(_&&_===s.title)return!0;const y=i[s.title];return!!(y&&y===p.tabId)});if(g){l++,console.error(`üìù [GameTabService] [${e}] ‚úÖ Matched subtab "${s.title}" (${s.id}) with update.tabId="${g.tabId}"`);const p=new Date().toLocaleString(),_=s.content&&s.content.trim().length>0&&s.content!=="Loading..."&&s.status==="loaded";let y;if(_){const v=s.content,A="<!-- LATEST_UPDATE -->";if(v.includes(A)){const R=v.indexOf(A),U=v.substring(0,R).trim(),d=v.substring(R+A.length).trim(),f=`<details>
<summary>üìã Update from ${p}</summary>

${d}

</details>
`;y=(U?U+`

`+f:f)+`

`+A+`

`+g.content}else y=`<details>
<summary>üìã Initial Content</summary>

${v}

</details>
`+`

`+A+`

`+g.content}else y=`<!-- LATEST_UPDATE -->

`+g.content;if(y.length>ae){console.error(`üìù [GameTabService] [${e}] Subtab ${s.id} exceeds ${ae} chars, trimming old collapsed sections`);const v=/<details>\s*<summary>.*?<\/summary>[\s\S]*?<\/details>/g,A=y.match(v)||[];if(A.length>2){let w=y;A.slice(0,A.length-2).forEach(d=>{w=w.replace(d,"")}),!w.includes("Earlier history removed")&&w.includes("<!-- LATEST_UPDATE -->")&&(w=`<details>
<summary>‚ÑπÔ∏è Earlier history removed to save space</summary>

Older updates have been automatically removed. Recent updates are preserved.

</details>

`+w),y=w}console.error(`üìù [GameTabService] [${e}] Subtab ${s.id} content trimmed to ${y.length} chars`)}return{...s,title:g.title||s.title,content:y,isNew:!0,status:"loaded"}}return s});if(l===0){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è No subtabs matched for update`),t.forEach(s=>{console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Unmatched update: tabId="${s.tabId}", title="${s.title}"`)});return}const m=new Set;if(o.subtabs.forEach(s=>{const g=t.find(p=>{if(p.tabId===s.id||p.tabId.toLowerCase()===s.title.toLowerCase()||p.title&&p.title.toLowerCase()===s.title.toLowerCase())return!0;const _=n[p.tabId];if(_&&_===s.title)return!0;const y=i[s.title];return!!(y&&y===p.tabId)});g&&m.add(g.tabId)}),t.forEach(s=>{m.has(s.tabId)||console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Update not matched to any subtab: tabId="${s.tabId}", title="${s.title}"`)}),console.error(`üìù [GameTabService] [${e}] Writing ${l} updated subtabs to normalized table...`),!await I.setSubtabs(e,u))throw console.error(`üìù [GameTabService] [${e}] ‚ùå Failed to write subtabs to table`),new Error("Failed to update subtabs in database");b.clearCache(),await b.updateConversation(e,{updatedAt:Date.now()}),console.error(`üìù [GameTabService] [${e}] ‚úÖ Updated ${l} subtabs successfully (table + cache cleared)`)}catch(a){throw console.error(`üìù [GameTabService] [${e}] ‚ùå Failed to update subtabs:`,a),a}}async generateSubtabsForExistingGameTabs(e,t,a){const o=Object.values(e).filter(i=>!i.isGameHub&&!i.isUnreleased&&i.gameTitle&&(!i.subtabs||i.subtabs.length===0));if(o.length===0){console.log("üîÑ [GameTabService] No game tabs need subtabs generation");return}console.log(`üîÑ [GameTabService] Found ${o.length} game tabs that need subtabs`);for(let i=0;i<o.length;i++){const n=o[i];try{console.log(`üîÑ [GameTabService] Generating subtabs for "${n.gameTitle}" (${i+1}/${o.length})`);const l=this.generateInitialSubTabs(n.genre||"Default",t,{gameTitle:n.gameTitle||""});await b.updateConversation(n.id,{subtabs:l,subtabsOrder:l.map(u=>u.id),updatedAt:Date.now()}),await I.setSubtabs(n.id,l),await this.generateInitialInsights({...n,subtabs:l},t),console.log(`‚úÖ [GameTabService] Successfully generated subtabs for "${n.gameTitle}"`),a==null||a(i,o.length,n.gameTitle||n.title),i<o.length-1&&await new Promise(u=>setTimeout(u,1e3))}catch(l){console.error(`‚ùå [GameTabService] Failed to generate subtabs for "${n.gameTitle}":`,l)}}a==null||a(o.length,o.length,"Complete"),console.log(`üîÑ [GameTabService] Finished generating subtabs for ${o.length} game tabs`)}}const He=new Ce,je={async fetchGalleryData(r){try{console.log("üñºÔ∏è [GalleryService] Fetching gallery data for user:",r);const{data:e,error:t}=await G.from("conversations").select("id, title, game_title").eq("auth_user_id",r);if(t)return console.error("[GalleryService] Error fetching conversations:",t),{albums:[],totalImages:0,loading:!1,error:t.message};if(!e||e.length===0)return console.log("üñºÔ∏è [GalleryService] No conversations found"),{albums:[],totalImages:0,loading:!1};console.log("üñºÔ∏è [GalleryService] Found",e.length,"conversations");const a=e.map(c=>c.id),{data:o,error:i}=await G.from("messages").select("id, image_url, conversation_id, content, role, created_at").in("conversation_id",a).not("image_url","is",null).order("created_at",{ascending:!1});if(i)return console.error("[GalleryService] Error fetching messages:",i),{albums:[],totalImages:0,loading:!1,error:i.message};console.log("üñºÔ∏è [GalleryService] Found",(o==null?void 0:o.length)||0,"messages with images"),console.log("üñºÔ∏è [GalleryService] Sample image URLs:",o==null?void 0:o.slice(0,3).map(c=>c.image_url));const n=new Map(e.map(c=>[c.id,{title:c.title,gameTitle:c.game_title}])),l=new Map;(o||[]).forEach(c=>{var _;if(!c.image_url)return;const s=n.get(c.conversation_id);if(!s)return;const g={id:c.id,imageUrl:c.image_url,conversationId:c.conversation_id,conversationTitle:s.title||"Untitled",gameTitle:s.gameTitle||void 0,messageContent:((_=c.content)==null?void 0:_.substring(0,100))||void 0,capturedAt:new Date(c.created_at||Date.now()).getTime(),role:c.role},p=l.get(c.conversation_id);p?(p.images.push(g),p.imageCount++,p.latestImageAt=Math.max(p.latestImageAt,g.capturedAt)):l.set(c.conversation_id,{conversationId:c.conversation_id,conversationTitle:s.title||"Untitled",gameTitle:s.gameTitle||void 0,coverUrl:void 0,images:[g],imageCount:1,latestImageAt:g.capturedAt})});const u=Array.from(l.values()).sort((c,s)=>s.latestImageAt-c.latestImageAt),m=u.reduce((c,s)=>c+s.imageCount,0);return{albums:u,totalImages:m,loading:!1}}catch(e){return console.error("[GalleryService] Exception:",e),{albums:[],totalImages:0,loading:!1,error:e instanceof Error?e.message:"Unknown error"}}},async downloadImage(r,e){try{const a=await(await fetch(r)).blob(),o=URL.createObjectURL(a),i=document.createElement("a");return i.href=o,i.download=e||`screenshot_${Date.now()}.png`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o),!0}catch(t){return console.error("[GalleryService] Download failed:",t),!1}},addToTimeline(r,e,t,a){Te.addEvent({type:"album",eventDate:new Date(r.capturedAt).toISOString().split("T")[0],year:t,title:e,description:a||`Screenshot from ${r.gameTitle||r.conversationTitle}`,photos:[r.imageUrl]})},async getImageCount(r){try{const{data:e}=await G.from("conversations").select("id").eq("auth_user_id",r);if(!e||e.length===0)return 0;const t=e.map(i=>i.id),{count:a,error:o}=await G.from("messages").select("id",{count:"exact",head:!0}).in("conversation_id",t).not("image_url","is",null);return o?(console.error("[GalleryService] Count error:",o),0):a||0}catch(e){return console.error("[GalleryService] Count exception:",e),0}},filterByGame(r,e){return r.filter(t=>{var a;return(a=t.gameTitle)==null?void 0:a.toLowerCase().includes(e.toLowerCase())})},getGameTitles(r){const e=new Set;return r.forEach(t=>{t.gameTitle&&e.add(t.gameTitle)}),Array.from(e).sort()}};export{He as a,Pe as b,fe as c,q as d,Fe as e,Be as f,z as g,je as h,Y as i,De as j,Me as k,we as l,Oe as m,Ke as n,Ue as o,$e as p,Le as q,xe as r,ze as s,Te as t,re as u,Re as v,Ne as w};
