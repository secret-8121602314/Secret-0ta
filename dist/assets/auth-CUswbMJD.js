import{j as s,z as O,r as w}from"./react-vendor-B_MlDKAw.js";import{c as R}from"./supabase-vendor-JplHk2xA.js";import{a as v}from"./core-services-CKnrghW2.js";import{t as U,c as z}from"./vendor-DwubNMd3.js";const G="https://qajcxgkqloumogioomiz.supabase.co",q="sb_publishable_GoW6G_umt1lFF-KPbbm-Ow_D2PYxPLw",f=R(G,q,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0}});if(typeof window<"u"){f.auth.onAuthStateChange((e,a)=>{if(e==="SIGNED_IN"){if(a!=null&&a.access_token){document.body.style.cssText="",document.documentElement.style.cssText="";const t=document.getElementById("root");t&&(t.style.cssText=""),document.body.offsetHeight,console.log("ðŸ” [Supabase] DOM styles cleaned on SIGNED_IN"),localStorage.setItem("otakon_session_refreshed",Date.now().toString()),localStorage.setItem("otakon_last_session_check",Date.now().toString()),window.dispatchEvent(new CustomEvent("otakon:session-refreshed",{detail:{event:e,session:a}}))}}else if(e==="TOKEN_REFRESHED")a!=null&&a.access_token?(localStorage.setItem("otakon_session_refreshed",Date.now().toString()),localStorage.setItem("otakon_last_session_check",Date.now().toString()),window.dispatchEvent(new CustomEvent("otakon:session-refreshed",{detail:{event:e,session:a}}))):(console.error("ðŸ” [Supabase] Token refresh failed - session expired"),localStorage.removeItem("otakon_session_refreshed"),localStorage.removeItem("otakon_last_session_check"),window.dispatchEvent(new CustomEvent("otakon:session-expired",{detail:{reason:"token_refresh_failed",timestamp:Date.now()}})));else if(e==="SIGNED_OUT"){document.body.style.cssText="",document.documentElement.style.cssText="";const t=document.getElementById("root");t&&(t.style.cssText=""),document.body.offsetHeight,console.log("ðŸ” [Supabase] DOM styles cleaned on SIGNED_OUT");const l=localStorage.getItem("otakon_just_logged_out"),d=localStorage.getItem("otakon_logout_instance"),g=window.matchMedia("(display-mode: standalone)").matches;if(console.log("ðŸ” [Supabase] SIGNED_OUT event - isPWA:",g,"logoutInstance:",d,"logoutFlag:",l),d==="pwa"&&!g){console.log("ðŸ” [Supabase] Cross-tab logout from PWA detected in browser, clearing local state only"),localStorage.removeItem("otakon_session_refreshed"),localStorage.removeItem("otakon_last_session_check");return}localStorage.removeItem("otakon_session_refreshed"),localStorage.removeItem("otakon_last_session_check"),window.dispatchEvent(new CustomEvent("otakon:signed-out"))}else e==="USER_UPDATED"&&window.dispatchEvent(new CustomEvent("otakon:user-updated",{detail:{session:a}}))});const n=300*1e3;setInterval(async()=>{try{const{data:{session:e},error:a}=await f.auth.getSession();if(a||!e){const t=localStorage.getItem("otakon_last_session_check");t&&Date.now()-parseInt(t)<n*2&&(console.warn("ðŸ” [Supabase] Session expired during health check"),window.dispatchEvent(new CustomEvent("otakon:session-expired",{detail:{reason:"health_check_failed",timestamp:Date.now()}})))}else localStorage.setItem("otakon_last_session_check",Date.now().toString())}catch(e){console.error("ðŸ” [Supabase] Session health check error:",e)}},n)}function j(...n){return U(z(n))}const T=({size:n="md",className:e="",fullScreen:a=!0})=>{const t={sm:"small",md:"medium",lg:"large"},l=s.jsx(O,{color:"#ff4d00",size:t[n],text:"",textColor:""});return a?s.jsx("div",{className:j("h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",e),children:l}):s.jsx("div",{className:j("h-full bg-background flex items-center justify-center",e),children:l})},W=({onAuthSuccess:n,onAuthError:e})=>{const[a,t]=w.useState("loading"),[l,d]=w.useState(null),g=w.useRef(!1),S=w.useRef(null);return w.useEffect(()=>g.current?void 0:(g.current=!0,(async()=>{var y,A;try{if(!(window.location.search.includes("code")||window.location.hash.includes("access_token"))&&(await f.auth.getSession()).data.session){const i=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,i),t("success"),n();return}const u=new URLSearchParams(window.location.search),b=new URLSearchParams(window.location.hash.substring(1)),r=u.get("error")||b.get("error"),c=u.get("error_description")||b.get("error_description"),x=u.get("error_code")||b.get("error_code");if(console.log("ðŸ” [AuthCallback] OAuth parameters:",{oauthError:r,errorDescription:c,errorCode:x,urlParams:Object.fromEntries(u.entries()),hashParams:Object.fromEntries(b.entries())}),r){console.error("ðŸ” [AuthCallback] OAuth error detected:",{oauthError:r,errorDescription:c,errorCode:x});let o="Authentication failed";r==="access_denied"&&x==="otp_expired"?o="Email confirmation link has expired. Please request a new confirmation email.":r==="access_denied"&&(c!=null&&c.includes("Email link is invalid"))?o="Email confirmation link is invalid. Please request a new confirmation email.":r==="access_denied"&&(c!=null&&c.includes("expired"))?o="Email confirmation link has expired. Please request a new confirmation email.":r==="server_error"?o="Authentication server error. This may be due to Supabase configuration. Please try again.":r==="access_denied"?o="Authentication was cancelled. Please try again.":r==="invalid_request"?o="Invalid authentication request. Please check configuration.":r==="unauthorized_client"?o="Authentication client is not authorized. Please check Supabase configuration.":r==="unsupported_response_type"?o="Authentication response type not supported. Please check Supabase configuration.":r==="invalid_scope"?o="Authentication scope is invalid. Please check Supabase configuration.":c&&(o=decodeURIComponent(c)),d(o),t("error"),e(o);return}const{data:{subscription:m}}=f.auth.onAuthStateChange(async(o,i)=>{var p,h,I,D,N;if(o==="SIGNED_IN"&&(i!=null&&i.user)){const F=((p=i.user.app_metadata)==null?void 0:p.provider)||((I=(h=i.user.app_metadata)==null?void 0:h.providers)==null?void 0:I[0])||((N=(D=i.user.identities)==null?void 0:D[0])==null?void 0:N.provider)||"unknown";await new Promise(E=>setTimeout(E,1500));try{await v.loadUserFromSupabase(i.user.id),t("success"),n()}catch(E){console.error("ðŸ” [AuthCallback] Error loading user data:",E),d("Failed to load user data. Please try again."),t("error"),e("Failed to load user data")}m.unsubscribe()}else o==="SIGNED_OUT"&&(d("Authentication failed"),t("error"),e("Authentication failed"),m.unsubscribe())});S.current=m;const{data:P,error:_}=await f.auth.getSession();if(_){console.error("ðŸ” [AuthCallback] Auth callback error:",_),d(_.message),t("error"),e(_.message),m.unsubscribe();return}if((y=P.session)!=null&&y.user)await new Promise(o=>setTimeout(o,1e3)),await v.loadUserFromSupabase(P.session.user.id),t("success"),n(),m.unsubscribe();else{const o=new URLSearchParams(window.location.search),i=new URLSearchParams(window.location.hash.substring(1));if(o.has("code")||o.has("error")||i.has("access_token")){await new Promise(h=>setTimeout(h,1e3));const p=await f.auth.getSession();if((A=p.data.session)!=null&&A.user){await new Promise(h=>setTimeout(h,500)),await v.loadUserFromSupabase(p.data.session.user.id),t("success"),n(),m.unsubscribe();return}}setTimeout(()=>{a==="loading"&&(d("Authentication timeout"),t("error"),e("Authentication timeout"),m.unsubscribe())},1e4)}}catch(C){console.error("ðŸ” [AuthCallback] Auth callback error:",C);const u="An unexpected error occurred";d(u),t("error"),e(u)}})(),()=>{S.current&&S.current.unsubscribe()}),[]),a==="loading"?s.jsx(T,{size:"md"}):a==="error"?s.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-red-500 text-6xl mb-4",children:"âš ï¸"}),s.jsx("h2",{className:"text-2xl font-bold text-[#F5F5F5] mb-2",children:"Authentication Error"}),s.jsx("p",{className:"text-[#CFCFCF] mb-6",children:l}),s.jsxs("div",{className:"space-y-3",children:[s.jsx("button",{onClick:()=>{const k=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,k),e("User cancelled authentication")},className:"bg-gradient-to-r from-[#E53A3A] to-[#D98C1F] md:hover:from-[#D42A2A] md:hover:to-[#C87A1A] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 md:hover:scale-105 active:scale-95",children:"Return to Login"}),l&&l.includes("Email confirmation link")&&s.jsx("button",{onClick:()=>{window.history.replaceState({},document.title,"/"),e("Email confirmation expired - show resend option")},className:"bg-gradient-to-r from-[#4F46E5] to-[#7C3AED] md:hover:from-[#4338CA] md:hover:to-[#6D28D9] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 md:hover:scale-105 active:scale-95",children:"Request New Confirmation Email"})]})]})}):s.jsx(T,{size:"md"})};export{T as A,W as a,j as c,f as s};
