import{r as b,j as a}from"./react-vendor-GN48U5Y-.js";import{c as E}from"./supabase-vendor-Q7d2eXAy.js";import{a as w}from"./core-services-B7PVfjDl.js";const O="https://qajcxgkqloumogioomiz.supabase.co",L="sb_publishable_GoW6G_umt1lFF-KPbbm-Ow_D2PYxPLw",x=E(O,L,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0}}),G=({onAuthSuccess:d,onAuthError:n})=>{const[C,r]=b.useState("loading"),[k,c]=b.useState(null),U=b.useRef(!1),v=b.useRef(null);return b.useEffect(()=>{if(U.current){console.log("ðŸ” [AuthCallback] Already processed, skipping...");return}return U.current=!0,(async()=>{var _,F;try{console.log("ðŸ” [AuthCallback] Handling OAuth callback..."),console.log("ðŸ” [AuthCallback] Current URL:",window.location.href),console.log("ðŸ” [AuthCallback] URL search params:",window.location.search),console.log("ðŸ” [AuthCallback] URL hash:",window.location.hash);const h=await x.auth.getSession(),m=window.location.search.includes("code")||window.location.hash.includes("access_token");if(h.data.session&&!m){console.log("ðŸ” [AuthCallback] Already logged in, skipping OAuth processing:",h.data.session.user.email),r("success"),d();return}if(h.data.session&&m&&(console.warn("âš ï¸ [AuthCallback] Session conflict detected: already logged in but new OAuth detected"),w.getCurrentUser())){console.log("ðŸ” [AuthCallback] Preserving existing session, clearing OAuth URL");const t=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,t),r("success"),d();return}const f=new URLSearchParams(window.location.search),p=new URLSearchParams(window.location.hash.substring(1)),s=f.get("error")||p.get("error"),o=f.get("error_description")||p.get("error_description"),P=f.get("error_code")||p.get("error_code");if(console.log("ðŸ” [AuthCallback] OAuth parameters:",{oauthError:s,errorDescription:o,errorCode:P,urlParams:Object.fromEntries(f.entries()),hashParams:Object.fromEntries(p.entries())}),s){console.error("ðŸ” [AuthCallback] OAuth error detected:",{oauthError:s,errorDescription:o,errorCode:P});let e="Authentication failed";s==="access_denied"&&P==="otp_expired"?e="Email confirmation link has expired. Please request a new confirmation email.":s==="access_denied"&&(o!=null&&o.includes("Email link is invalid"))?e="Email confirmation link is invalid. Please request a new confirmation email.":s==="access_denied"&&(o!=null&&o.includes("expired"))?e="Email confirmation link has expired. Please request a new confirmation email.":s==="server_error"?e="Authentication server error. This may be due to Supabase configuration. Please try again.":s==="access_denied"?e="Authentication was cancelled. Please try again.":s==="invalid_request"?e="Invalid authentication request. Please check configuration.":s==="unauthorized_client"?e="Authentication client is not authorized. Please check Supabase configuration.":s==="unsupported_response_type"?e="Authentication response type not supported. Please check Supabase configuration.":s==="invalid_scope"?e="Authentication scope is invalid. Please check Supabase configuration.":o&&(e=decodeURIComponent(o)),c(e),r("error"),n(e);return}const{data:{subscription:i}}=x.auth.onAuthStateChange(async(e,t)=>{var l,u,S,j,N;if(console.log("ðŸ” [AuthCallback] Auth state change:",{event:e,session:t}),e==="SIGNED_IN"&&(t!=null&&t.user)){console.log("ðŸ” [AuthCallback] User signed in:",t.user.email),console.log("ðŸ” [AuthCallback] User metadata:",t.user.user_metadata),console.log("ðŸ” [AuthCallback] App metadata:",t.user.app_metadata),console.log("ðŸ” [AuthCallback] User identities:",t.user.identities);const R=((l=t.user.app_metadata)==null?void 0:l.provider)||((S=(u=t.user.app_metadata)==null?void 0:u.providers)==null?void 0:S[0])||((N=(j=t.user.identities)==null?void 0:j[0])==null?void 0:N.provider)||"unknown";console.log("ðŸ” [AuthCallback] Detected provider:",R),console.log("ðŸ” [AuthCallback] Waiting for database trigger to create user record..."),await new Promise(y=>setTimeout(y,1500));try{await w.loadUserFromSupabase(t.user.id),console.log("ðŸ” [AuthCallback] User data loaded successfully"),r("success"),d()}catch(y){console.error("ðŸ” [AuthCallback] Error loading user data:",y),c("Failed to load user data. Please try again."),r("error"),n("Failed to load user data")}i.unsubscribe()}else e==="SIGNED_OUT"&&(console.log("ðŸ” [AuthCallback] User signed out"),c("Authentication failed"),r("error"),n("Authentication failed"),i.unsubscribe())});v.current=i;const{data:A,error:g}=await x.auth.getSession();if(console.log("ðŸ” [AuthCallback] Current session:",{data:A,error:g}),g){console.error("ðŸ” [AuthCallback] Auth callback error:",g),c(g.message),r("error"),n(g.message),i.unsubscribe();return}if((_=A.session)!=null&&_.user)console.log("ðŸ” [AuthCallback] User already authenticated:",A.session.user.email),console.log("ðŸ” [AuthCallback] Waiting for database trigger to create user record..."),await new Promise(e=>setTimeout(e,1e3)),await w.loadUserFromSupabase(A.session.user.id),r("success"),d(),i.unsubscribe();else{console.log("ðŸ” [AuthCallback] No session found, waiting for auth state change..."),console.log("ðŸ” [AuthCallback] URL search params:",window.location.search);const e=new URLSearchParams(window.location.search),t=new URLSearchParams(window.location.hash.substring(1));if(e.has("code")||e.has("error")||t.has("access_token")){console.log("ðŸ” [AuthCallback] OAuth parameters found, trying manual handling..."),await new Promise(u=>setTimeout(u,1e3));const l=await x.auth.getSession();if(console.log("ðŸ” [AuthCallback] Retry session after manual handling:",l),(F=l.data.session)!=null&&F.user){console.log("ðŸ” [AuthCallback] User authenticated after retry:",l.data.session.user.email),console.log("ðŸ” [AuthCallback] Waiting for database trigger to create user record..."),await new Promise(u=>setTimeout(u,500)),await w.loadUserFromSupabase(l.data.session.user.id),r("success"),d(),i.unsubscribe();return}}setTimeout(()=>{C==="loading"&&(console.log("ðŸ” [AuthCallback] Timeout waiting for auth state change"),c("Authentication timeout"),r("error"),n("Authentication timeout"),i.unsubscribe())},1e4)}}catch(h){console.error("ðŸ” [AuthCallback] Auth callback error:",h);const m="An unexpected error occurred";c(m),r("error"),n(m)}})(),()=>{v.current&&v.current.unsubscribe()}},[]),C==="loading"?a.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-[#FF4D4D] mx-auto mb-4"}),a.jsx("p",{className:"text-[#CFCFCF] text-lg",children:"Completing authentication..."})]})}):C==="error"?a.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-red-500 text-6xl mb-4",children:"âš ï¸"}),a.jsx("h2",{className:"text-2xl font-bold text-[#F5F5F5] mb-2",children:"Authentication Error"}),a.jsx("p",{className:"text-[#CFCFCF] mb-6",children:k}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("button",{onClick:()=>{window.history.replaceState({},document.title,window.location.pathname),n("User cancelled authentication")},className:"bg-gradient-to-r from-[#E53A3A] to-[#D98C1F] hover:from-[#D42A2A] hover:to-[#C87A1A] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95",children:"Return to Login"}),k&&k.includes("Email confirmation link")&&a.jsx("button",{onClick:()=>{window.history.replaceState({},document.title,window.location.pathname),n("Email confirmation expired - show resend option")},className:"bg-gradient-to-r from-[#4F46E5] to-[#7C3AED] hover:from-[#4338CA] hover:to-[#6D28D9] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95",children:"Request New Confirmation Email"})]})]})}):a.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-green-500 text-6xl mb-4",children:"âœ…"}),a.jsx("h2",{className:"text-2xl font-bold text-[#F5F5F5] mb-2",children:"Authentication Successful"}),a.jsx("p",{className:"text-[#CFCFCF]",children:"Redirecting to the app..."})]})})};export{G as A,x as s};
//# sourceMappingURL=auth-DGFsSETM.js.map
