import{s as I}from"./auth-BtygLHFy.js";import{C as b,i as j,d as V,e as Z}from"./chat-services-Cu3qEsr4.js";import{m as A,i as K,t as Y}from"./services-QKwEJy8m.js";const M=new Map,P=new Map,ee=1800*1e3,J="otagon_igdb_cache",F=1440*60*1e3,Q="otagon_cover_urls";function te(){try{const r=localStorage.getItem(J);if(r){const e=JSON.parse(r);if(e.version===1&&Date.now()-e.timestamp<F){for(const[t,a]of Object.entries(e.games))Date.now()-a.timestamp<F&&P.set(t,a);console.log("[IGDBService] Loaded",P.size,"games from localStorage cache")}}}catch(r){console.warn("[IGDBService] Error loading localStorage cache:",r)}}function re(){try{const r={};P.forEach((t,a)=>{r[a]=t});const e={version:1,timestamp:Date.now(),games:r};localStorage.setItem(J,JSON.stringify(e))}catch(r){console.warn("[IGDBService] Error saving localStorage cache:",r)}}function ae(){try{const r=localStorage.getItem(Q);if(r){const e=JSON.parse(r);if(e.version===1&&Date.now()-e.timestamp<F)return console.log("[IGDBService] Loaded",Object.keys(e.urls).length,"cover URLs from localStorage"),new Map(Object.entries(e.urls))}}catch(r){console.warn("[IGDBService] Error loading cover URL cache:",r)}return new Map}function X(r){try{const e={version:1,timestamp:Date.now(),urls:Object.fromEntries(r)};localStorage.setItem(Q,JSON.stringify(e))}catch(e){console.warn("[IGDBService] Error saving cover URL cache:",e)}}te();const R=ae();function z(r,e="cover_small"){if(!r)return;let t=r;return t=t.replace(/t_(thumb|cover_small|cover_big|720p|1080p|screenshot_huge)/g,`t_${e}`),t.startsWith("//")?t="https:"+t:t.startsWith("http")||(t="https://"+t),t}function ye(r){var e;if((e=r==null?void 0:r.cover)!=null&&e.url)return z(r.cover.url,"cover_small")}async function ie(r){if(!r||r.trim().length===0)return console.warn("[IGDBService] Empty game name provided"),null;const e=r.toLowerCase().trim(),t=P.get(e);if(t&&Date.now()-t.timestamp<ee)return console.log("[IGDBService] Session cache hit:",r),t.data;if(M.has(e)){console.log("[IGDBService] Waiting for pending request:",r);const i=M.get(e);if(i)return i}const a=(async()=>{var i,s,n;try{console.log("[IGDBService] Fetching game data:",r);const{data:{session:l}}=await I.auth.getSession(),p={"Content-Type":"application/json"};l!=null&&l.access_token&&(p.Authorization=`Bearer ${l.access_token}`),console.log("[IGDBService] Invoking igdb-proxy with gameName:",r);const h=await I.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:r}),headers:p});if(h.error){console.error("[IGDBService] Edge function error:",h.error);const u=h.error;return((i=u==null?void 0:u.message)!=null&&i.includes("IGDB_NOT_CONFIGURED")||(s=u==null?void 0:u.message)!=null&&s.includes("503"))&&console.warn("[IGDBService] IGDB service not configured - game data will not be available"),null}const c=h.data;if((c==null?void 0:c.code)==="IGDB_NOT_CONFIGURED")return console.warn("[IGDBService] IGDB service not configured on server"),null;if(!c.success||!c.data)return console.log("[IGDBService] No data found for:",r),null;const o=c.data;if(P.set(e,{data:o,timestamp:Date.now()}),re(),(n=o.cover)!=null&&n.url){const u=z(o.cover.url,"cover_small");u&&(R.set(e,u),X(R),console.log("[IGDBService] Saved cover URL to cache:",e))}return console.log("[IGDBService] Successfully fetched:",o.name,c.cached?"(cached)":"(fresh)"),o}catch(l){return console.error("[IGDBService] Error fetching game data:",l),null}finally{M.delete(e)}})();return M.set(e,a),a}async function be(r){return ie(`id:${r}`)}async function Se(r){if(!r||r.trim().length<2)return[];try{console.log("[IGDBService] Searching games:",r);const{data:{session:e}}=await I.auth.getSession(),t={"Content-Type":"application/json"};e!=null&&e.access_token&&(t.Authorization=`Bearer ${e.access_token}`);const a=await I.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:r,searchMode:"multi"}),headers:t});if(a.error)return console.error("[IGDBService] Search error:",a.error),[];const i=a.data;if(!i.success||!i.data)return[];const s=i.data;console.log("[IGDBService] Search found",s.length,"games");for(const n of s){const l=n.name.toLowerCase().trim();P.set(l,{data:n,timestamp:Date.now()})}return s}catch(e){return console.error("[IGDBService] Search error:",e),[]}}function _e(r,e="high"){return`https://img.youtube.com/vi/${r}/${{default:"default",medium:"mqdefault",high:"hqdefault",maxres:"maxresdefault"}[e]}.jpg`}function ve(r){return{1:"Official",2:"Wikia",3:"Wikipedia",4:"Facebook",5:"Twitter",6:"Twitch",8:"Instagram",9:"YouTube",10:"iPhone",11:"iPad",12:"Android",13:"Steam",14:"Reddit",15:"Itch.io",16:"Epic Games",17:"GOG",18:"Discord"}[r]||"Website"}function Te(r,e){return r===1?{6:"RP (Rating Pending)",7:"EC (Early Childhood)",8:"E (Everyone)",9:"E10+ (Everyone 10+)",10:"T (Teen)",11:"M (Mature 17+)",12:"AO (Adults Only)"}[e]||"Not Rated":r===2&&{1:"PEGI 3",2:"PEGI 7",3:"PEGI 12",4:"PEGI 16",5:"PEGI 18"}[e]||"Not Rated"}function we(r){return r?new Date(r*1e3).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"TBA"}function Ce(r){return r?r.filter(e=>e.developer).map(e=>e.company.name):[]}function Ge(r){return r.total_rating??r.aggregated_rating??r.rating??null}async function Ae(r){var i;const e=new Map;if(r.length===0)return e;const t=r.map(s=>s.toLowerCase().trim()),a=[];for(const s of t){const n=R.get(s);n?e.set(s,n):a.push(s)}if(a.length===0)return console.log("[IGDBService] All cover URLs from localStorage cache:",e.size),e;try{const{data:s,error:n}=await I.from("igdb_game_cache").select("game_name_key, game_data").in("game_name_key",a).gt("expires_at",new Date().toISOString());if(n)return console.warn("[IGDBService] Error fetching cover URLs from cache:",n.message),e;if(s){for(const l of s){const p=l.game_data;if((i=p==null?void 0:p.cover)!=null&&i.url){const h=z(p.cover.url,"cover_small");h&&(e.set(l.game_name_key,h),R.set(l.game_name_key,h))}}X(R)}console.log("[IGDBService] Fetched cover URLs:",e.size,"of",r.length,"(",e.size-a.length+((s==null?void 0:s.length)??0),"from localStorage,",(s==null?void 0:s.length)||0,"from Supabase)")}catch(s){console.warn("[IGDBService] Error in fetchCoverUrlsFromCache:",s)}return e}const m={LIBRARY:"otagon_gaming_library",TIMELINE:"otagon_gaming_timeline",NEWS_CACHE:"otagon_gaming_news_cache",NEWS_GENERATION_LOG:"otagon_news_generation_log",GAME_KNOWLEDGE:"otagon_game_knowledge",USER_PROFILE:"otagon_user_gaming_profile",GAMEPLAY_SESSIONS:"otagon_gameplay_sessions",IGDB_HOME_CACHE:"otagon_igdb_home_cache",SEARCH_HISTORY:"otagon_game_search_history"};function O(){var r;return((r=crypto.randomUUID)==null?void 0:r.call(crypto))||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function _(r,e){try{const t=localStorage.getItem(r);return t?JSON.parse(t):e}catch(t){return console.warn(`[GamingExplorerStorage] Error reading ${r}:`,t),e}}function S(r,e){try{return localStorage.setItem(r,JSON.stringify(e)),!0}catch(t){return console.error(`[GamingExplorerStorage] Error writing ${r}:`,t),!1}}const Ie={getAll(){return _(m.LIBRARY,[])},getByCategory(r){return this.getAll().filter(t=>t.category===r)},getByIgdbId(r){return this.getAll().find(t=>t.igdbGameId===r)},getByGameTitle(r){const e=this.getAll(),t=r.toLowerCase().trim();return e.find(a=>a.gameName.toLowerCase().trim()===t)},getGameCategories(r){return this.getAll().filter(t=>t.igdbGameId===r).map(t=>t.category)},addGame(r,e,t,a,i){const s=this.getAll(),n=s.find(p=>p.igdbGameId===r&&p.category===t);if(n)return n.updatedAt=Date.now(),i!=null&&i.platform&&(n.platform=i.platform),i!=null&&i.personalRating&&(n.personalRating=i.personalRating),i!=null&&i.completionStatus&&(n.completionStatus=i.completionStatus),a&&(n.igdbData=a),S(m.LIBRARY,s),this.updateStats(),n;const l={id:O(),igdbGameId:r,gameName:e,category:t,platform:i==null?void 0:i.platform,personalRating:i==null?void 0:i.personalRating,completionStatus:(i==null?void 0:i.completionStatus)||(t==="own"?"not_started":void 0),igdbData:a,dateAdded:Date.now(),updatedAt:Date.now()};return s.push(l),S(m.LIBRARY,s),this.updateStats(),t==="own"&&de(r,e),l},updateGame(r,e){const t=this.getAll(),a=t.findIndex(i=>i.id===r);return a===-1?null:(t[a]={...t[a],...e,updatedAt:Date.now()},S(m.LIBRARY,t),this.updateStats(),t[a])},removeGame(r,e){const t=this.getAll(),a=t.filter(i=>!(i.igdbGameId===r&&i.category===e));return a.length===t.length?!1:(S(m.LIBRARY,a),this.updateStats(),!0)},moveGame(r,e,t){const a=this.getAll(),i=a.find(s=>s.igdbGameId===r&&s.category===e);return i?(i.category=t,i.updatedAt=Date.now(),S(m.LIBRARY,a),this.updateStats(),!0):!1},toggleCategory(r,e,t,a){return this.getAll().find(n=>n.igdbGameId===r&&n.category===t)?(this.removeGame(r,t),{added:!1}):{added:!0,item:this.addGame(r,e,t,a)}},updateStats(){const r=this.getAll(),e=W.get();e.libraryStats={ownedCount:r.filter(t=>t.category==="own").length,completedCount:r.filter(t=>t.category==="own"&&t.completionStatus==="completed").length,wishlistCount:r.filter(t=>t.category==="wishlist").length,favoritesCount:r.filter(t=>t.category==="favorite").length,dislikedCount:r.filter(t=>t.category==="disliked").length,totalHoursPlayed:r.reduce((t,a)=>t+(a.hoursPlayed||0),0)},e.lastUpdated=Date.now(),W.save(e)}},se={getAll(){return _(m.TIMELINE,[]).sort((e,t)=>new Date(t.eventDate).getTime()-new Date(e.eventDate).getTime())},getByYear(r){return this.getAll().filter(t=>t.year===r)},getYears(){const r=this.getAll();return[...new Set(r.map(t=>t.year))].sort((t,a)=>a-t)},addEvent(r){const e=this.getAll(),t={...r,id:O(),createdAt:Date.now(),updatedAt:Date.now()};return e.push(t),S(m.TIMELINE,e),t},updateEvent(r,e){const t=_(m.TIMELINE,[]),a=t.findIndex(i=>i.id===r);return a===-1?null:(t[a]={...t[a],...e,updatedAt:Date.now()},S(m.TIMELINE,t),t[a])},deleteEvent(r){const e=_(m.TIMELINE,[]),t=e.filter(a=>a.id!==r);return t.length===e.length?!1:(S(m.TIMELINE,t),!0)},addConsole(r,e,t,a){return this.addEvent({type:"console",eventDate:`${e}-01-01`,year:e,title:r,description:t,photos:a?[a]:void 0})},addPCBuild(r,e,t,a){return this.addEvent({type:"pc_build",eventDate:`${e}-01-01`,year:e,title:r,specs:t,photos:a})},addGameMilestone(r,e,t,a,i){return this.addEvent({type:"game",eventDate:`${t}-01-01`,year:t,title:r,description:a,igdbGameId:e,igdbData:i})}},Ee={getAll(){return _(m.GAMEPLAY_SESSIONS,[])},getByGame(r){return this.getAll().filter(t=>t.igdbGameId===r)},getByDateAndGame(r,e){return this.getAll().find(a=>a.sessionDate===r&&a.igdbGameId===e)},addScreenshot(r,e,t){const a=this.getAll(),i=new Date().toISOString().split("T")[0];let s=a.find(l=>l.sessionDate===i&&l.igdbGameId===r);s||(s={id:O(),igdbGameId:r,gameName:e,sessionDate:i,screenshots:[],createdAt:Date.now()},a.push(s));const n={...t,id:O(),sessionId:s.id};return s.screenshots.push(n),S(m.GAMEPLAY_SESSIONS,a),s},getScreenshotCount(r){return this.getByGame(r).reduce((t,a)=>t+a.screenshots.length,0)}},ke={get(r){const t=_(m.NEWS_CACHE,[]).find(a=>a.promptType===r);return t&&t.expiresAt>Date.now()?t:null},save(r){const e=_(m.NEWS_CACHE,[]),t=e.findIndex(a=>a.promptType===r.promptType);t>=0?e[t]=r:e.push(r),S(m.NEWS_CACHE,e)},canGenerate(r,e){const t=_(m.NEWS_GENERATION_LOG,[]),a=Date.now()-1440*60*1e3,i=t.find(s=>s.userId===r&&s.promptType===e&&s.generatedAt>a);return i?{allowed:!1,nextAvailableAt:i.generatedAt+1440*60*1e3}:{allowed:!0}},logGeneration(r,e){const a=_(m.NEWS_GENERATION_LOG,[]).filter(i=>!(i.userId===r&&i.promptType===e));a.push({userId:r,promptType:e,generatedAt:Date.now()}),S(m.NEWS_GENERATION_LOG,a)},getCacheAge(r){const e=this.get(r);return e?Math.floor((Date.now()-e.cachedAt)/(3600*1e3)):null}},H={get(r){return _(m.GAME_KNOWLEDGE,[]).find(t=>t.igdbGameId===r)||null},exists(r){return this.get(r)!==null},save(r){const e=_(m.GAME_KNOWLEDGE,[]),t=e.findIndex(a=>a.igdbGameId===r.igdbGameId);t>=0?e[t]={...r,lastUpdated:Date.now()}:e.push(r),S(m.GAME_KNOWLEDGE,e)},getAllExtracted(){return _(m.GAME_KNOWLEDGE,[]).map(e=>e.igdbGameId)}},W={get(){return _(m.USER_PROFILE,{libraryStats:{ownedCount:0,completedCount:0,wishlistCount:0,favoritesCount:0,dislikedCount:0,totalHoursPlayed:0},lastUpdated:Date.now()})},save(r){S(m.USER_PROFILE,r)},setGamingStartYear(r){const e=this.get();e.gamingStartYear=r,e.lastUpdated=Date.now(),this.save(e)},getGamingStartYear(){return this.get().gamingStartYear},needsOnboarding(){return this.get().gamingStartYear===void 0}},ne=1440*60*1e3,Pe={get(){const r=_(m.IGDB_HOME_CACHE,null);return r?Date.now()-r.cachedAt>ne?(this.clear(),null):r:null},set(r){const e={...r,cachedAt:Date.now()};S(m.IGDB_HOME_CACHE,e)},clear(){localStorage.removeItem(m.IGDB_HOME_CACHE)},isValid(){return this.get()!==null}},oe=12,Re={getAll(){return _(m.SEARCH_HISTORY,[])},getGames(){return this.getAll().map(r=>r.gameData)},add(r){const t=this.getAll().filter(i=>i.gameData.id!==r.id),a=[{gameData:r,searchedAt:Date.now()},...t].slice(0,oe);S(m.SEARCH_HISTORY,a)},remove(r){const t=this.getAll().filter(a=>a.gameData.id!==r);S(m.SEARCH_HISTORY,t)},clear(){localStorage.removeItem(m.SEARCH_HISTORY)},hasHistory(){return this.getAll().length>0}},$=new Set,ce=()=>"https://qajcxgkqloumogioomiz.supabase.co/functions/v1/ai-proxy",le=r=>`
You are a comprehensive gaming knowledge base. Provide detailed, structured information about "${r}".

Please provide the following in a clear, organized format:

**GAME MECHANICS:**
- Core gameplay loop
- Key systems and how they interact
- Combat/movement mechanics (if applicable)
- Progression systems

**TIPS AND TRICKS:**
- Essential beginner tips (5-7 tips)
- Advanced strategies
- Common mistakes to avoid
- Efficiency tips

**BOSS/CHALLENGE STRATEGIES:**
- Key boss fights or challenging encounters
- Recommended approaches for each
- Equipment/loadout suggestions

**COLLECTIBLES & SECRETS:**
- Types of collectibles in the game
- Notable secrets or hidden content
- Achievement/trophy guidance

**CHARACTER BUILDS (if applicable):**
- Popular/meta builds
- Build archetypes
- Stat priorities

**STORY CONTEXT (spoiler-free):**
- Main themes
- Setting overview
- Key factions/characters (no plot spoilers)

Keep information practical and actionable. Focus on helping players succeed and enjoy the game.
Format with clear headers and bullet points for easy reference.
`;function ge(r,e,t){const a={gameMechanics:"",tipsAndTricks:"",bossStrategies:{},collectibles:{},characterBuilds:{},storyProgression:{}},i=t.match(/\*\*GAME MECHANICS:\*\*[\s\S]*?(?=\*\*TIPS AND TRICKS:|$)/i);i&&(a.gameMechanics=i[0].replace(/\*\*GAME MECHANICS:\*\*/i,"").trim());const s=t.match(/\*\*TIPS AND TRICKS:\*\*[\s\S]*?(?=\*\*BOSS|$)/i);s&&(a.tipsAndTricks=s[0].replace(/\*\*TIPS AND TRICKS:\*\*/i,"").trim());const n=t.match(/\*\*BOSS[\s\S]*?(?=\*\*COLLECTIBLES|$)/i);n&&(a.bossStrategies={content:n[0].trim()});const l=t.match(/\*\*COLLECTIBLES[\s\S]*?(?=\*\*CHARACTER|$)/i);l&&(a.collectibles={content:l[0].trim()});const p=t.match(/\*\*CHARACTER BUILDS[\s\S]*?(?=\*\*STORY|$)/i);p&&(a.characterBuilds={content:p[0].trim()});const h=t.match(/\*\*STORY CONTEXT[\s\S]*$/i);return h&&(a.storyProgression={context:h[0].trim()}),{igdbGameId:e,gameName:r,gameMechanics:a.gameMechanics||void 0,tipsAndTricks:a.tipsAndTricks||void 0,bossStrategies:Object.keys(a.bossStrategies).length>0?a.bossStrategies:void 0,collectibles:Object.keys(a.collectibles).length>0?a.collectibles:void 0,characterBuilds:Object.keys(a.characterBuilds).length>0?a.characterBuilds:void 0,storyProgression:Object.keys(a.storyProgression).length>0?a.storyProgression:void 0,extractedAt:Date.now(),lastUpdated:Date.now()}}async function ue(r,e){if($.has(r)){console.log(`ðŸŽ® [GameKnowledge] Already fetching knowledge for ${e}`);return}if(H.exists(r)){console.log(`ðŸŽ® [GameKnowledge] Knowledge already exists for ${e}`);return}$.add(r),console.log(`ðŸŽ® [GameKnowledge] Starting background fetch for ${e}...`);try{const{data:{session:t}}=await I.auth.getSession();if(!t){console.warn("ðŸŽ® [GameKnowledge] No auth session, skipping knowledge fetch");return}const a=await fetch(ce(),{method:"POST",headers:{Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({prompt:le(e),requestType:"text",model:"gemini-2.5-flash",temperature:.7,maxTokens:4096,systemPrompt:"You are a helpful gaming knowledge assistant. Provide accurate, practical gaming information."})});if(!a.ok){const s=await a.json();throw new Error(s.error||"Failed to fetch game knowledge")}const i=await a.json();if(i.success&&i.response){const s=ge(e,r,i.response);H.save(s),console.log(`ðŸŽ® [GameKnowledge] âœ… Stored knowledge for ${e}`)}else console.warn(`ðŸŽ® [GameKnowledge] Empty response for ${e}`)}catch(t){console.error(`ðŸŽ® [GameKnowledge] Failed to fetch for ${e}:`,t)}finally{$.delete(r)}}function de(r,e){ue(r,e).catch(t=>{console.error("ðŸŽ® [GameKnowledge] Background fetch failed:",t)})}const B=800,U=2500;function N(r,e){return r.length<=e?r:r.slice(0,e-3)+"..."}function De(r){const e=H.get(r);if(!e)return null;const t=[];let a=0;if(e.gameMechanics&&a<U){const s=N(e.gameMechanics,B);t.push(`**Game Mechanics:**
${s}`),a+=s.length+20}if(e.tipsAndTricks&&a<U){const s=N(e.tipsAndTricks,B);t.push(`**Tips & Tricks:**
${s}`),a+=s.length+20}if(e.bossStrategies&&typeof e.bossStrategies=="object"&&a<U){const s=e.bossStrategies.content;if(s){const n=N(s,B);t.push(`**Boss Strategies:**
${n}`),a+=n.length+20}}if(t.length===0)return null;const i=`

=== GAME KNOWLEDGE (${e.gameName}) ===
${t.join(`

`)}
===`;return console.log(`ðŸŽ® [GameKnowledge] Injecting ${i.length} chars of context for ${e.gameName}`),i}const q=3e3;function L(){var r;return((r=globalThis.crypto)==null?void 0:r.randomUUID())||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}class me{async createGameTab(e){var l,p,h;const t=await b.getConversation(e.conversationId);if(t){if(e.aiResponse&&((l=t.subtabs)!=null&&l.some(c=>c.status==="loading"||c.content==="Loading..."))){const c=this.extractInsightsFromAIResponse(e.aiResponse,t.subtabs);return await b.updateConversation(t.id,{subtabs:c,updatedAt:Date.now()}),{...t,subtabs:c}}return t}const a=e.userTier||"free",i=a==="pro"||a==="vanguard_pro";console.log("ðŸŽ® [GameTabService] Creating new game tab:",{gameTitle:e.gameTitle,userTier:a,isPro:i,isUnreleased:e.isUnreleased,hasAiResponse:!!e.aiResponse});let s=[];if(!e.isUnreleased&&i)if(e.aiResponse)if(console.error("ðŸŽ® [GameTabService] Extracting subtabs from AI response"),(p=e.aiResponse.gamePillData)!=null&&p.wikiContent&&Object.keys(e.aiResponse.gamePillData.wikiContent).length>0)console.error("ðŸŽ® [GameTabService] Found gamePillData.wikiContent with",Object.keys(e.aiResponse.gamePillData.wikiContent).length,"tabs"),s=Object.entries(e.aiResponse.gamePillData.wikiContent).map(([c,o])=>({id:L(),title:this.formatTabTitle(c),type:this.determineTabType(c),content:o,isNew:!1,status:"loaded"})),console.error("ðŸŽ® [GameTabService] Created",s.length,"subtabs from gamePillData.wikiContent");else if(e.aiResponse.progressiveInsightUpdates&&e.aiResponse.progressiveInsightUpdates.length>0)console.error("ðŸŽ® [GameTabService] Found progressiveInsightUpdates with",e.aiResponse.progressiveInsightUpdates.length,"updates"),s=e.aiResponse.progressiveInsightUpdates.map(c=>({id:L(),title:c.title,type:this.determineTabType(c.tabId),content:c.content,isNew:!1,status:"loaded"})),console.error("ðŸŽ® [GameTabService] Created",s.length,"subtabs from progressiveInsightUpdates");else{const c=this.extractInsightsFromAIResponse(e.aiResponse,[]);c.length>0?(s=c,console.error("ðŸŽ® [GameTabService] Created",s.length,"subtabs from INSIGHT_UPDATE tags")):(s=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile,{gameTitle:e.gameTitle}),console.error("ðŸŽ® [GameTabService] Created",s.length,"template subtabs (will populate via background AI using conversation context)"))}else s=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile,{gameTitle:e.gameTitle}),console.error("ðŸŽ® [GameTabService] Created",s.length,"initial template subtabs (no AI response)");else e.isUnreleased?console.error("ðŸŽ® [GameTabService] Creating unreleased game tab (no subtabs, Discuss mode only)"):console.error("ðŸ”’ [GameTabService] Subtabs disabled for free tier users");const n={id:e.conversationId,title:e.gameTitle,messages:[],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,gameId:e.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:e.gameTitle,genre:e.genre,subtabs:s,subtabsOrder:s.map(c=>c.id),isActiveSession:!0,activeObjective:"",gameProgress:0,isUnreleased:e.isUnreleased||!1};if(await b.addConversation(n),s.length>0&&i){console.error("ðŸŽ® [GameTabService] Saving",s.length,"subtabs for conversation:",n.id),console.error("ðŸŽ® [GameTabService] Subtabs:",JSON.stringify(s.map(o=>({id:o.id,title:o.title,type:o.type,hasType:!!o.type})),null,2)),await new Promise(o=>setTimeout(o,200));let c=await A.setSubtabs(n.id,s);c||(console.error("âš ï¸ [GameTabService] First setSubtabs attempt failed, waiting and retrying..."),await new Promise(o=>setTimeout(o,500)),c=await A.setSubtabs(n.id,s),console.error(c?"âœ… [GameTabService] Retry succeeded":"âŒ [GameTabService] Retry also failed - subtabs will be created by generateInitialInsights"))}else i?console.error("ðŸŽ® [GameTabService] No subtabs to save for conversation:",n.id):console.error("ðŸ”’ [GameTabService] Skipping subtabs save for free tier user");return i?e.aiResponse?(h=n.subtabs)!=null&&h.some(o=>o.content==="Loading...")&&this.generateInitialInsights(n,e.playerProfile,e.aiResponse).catch(o=>console.error("Background insight generation failed:",o)):this.generateInitialInsights(n,e.playerProfile,e.aiResponse).catch(c=>console.error("Background insight generation failed:",c)):console.error("ðŸ”’ [GameTabService] Skipping AI insight generation for free tier user"),n}getGameSpecificTabCustomizations(e){const t=e.toLowerCase();return t.includes("elden ring")?[{title:"Story So Far",type:"story",instruction:"Track the Tarnished's journey through the Lands Between, major demigod encounters, and story progression.",priority:"high",isProfileSpecific:!1},{title:"Sites of Grace Nearby",type:"tips",instruction:"List nearby Sites of Grace, their locations, and what areas they unlock.",priority:"high",isProfileSpecific:!1},{title:"Boss Strategy",type:"strategies",instruction:"Detailed strategies for Great Rune bearers, remembrance bosses, and field bosses.",priority:"high",isProfileSpecific:!1},{title:"Character Questlines",type:"characters",instruction:"Track NPC questlines like Ranni, Fia, Millicent, and their current progress.",priority:"high",isProfileSpecific:!1},{title:"Remembrances & Items",type:"items",instruction:"Track collected remembrances, Great Runes, and legendary armaments/ashes of war.",priority:"high",isProfileSpecific:!1}]:t.includes("cyberpunk")?[{title:"Story Progress",type:"story",instruction:"Track main story missions, relationship with Johnny Silverhand, and key choices made.",priority:"high",isProfileSpecific:!1},{title:"Fixers & Gigs",type:"walkthrough",instruction:"List available fixers in current district, active gigs, and completed contracts.",priority:"high",isProfileSpecific:!1},{title:"Cyberware Build",type:"strategies",instruction:"Current cyberware loadout, recommended upgrades, and build synergies.",priority:"high",isProfileSpecific:!1},{title:"Characters & Relationships",type:"characters",instruction:"Track relationships with Panam, Judy, River, Kerry, and romance options.",priority:"high",isProfileSpecific:!1},{title:"Night City Secrets",type:"tips",instruction:"Hidden legendary weapons, iconic gear locations, and easter eggs in current area.",priority:"high",isProfileSpecific:!1}]:t.includes("dark souls")?[{title:"Story So Far",type:"story",instruction:"Track the Chosen Undead's journey, Lords of Cinder defeated, and covenant allegiances.",priority:"high",isProfileSpecific:!1},{title:"Nearby Bonfires",type:"tips",instruction:"List nearby bonfires, their locations, and connectivity to other areas.",priority:"high",isProfileSpecific:!1},{title:"Boss Strategy",type:"strategies",instruction:"Strategies for Lord Souls, required bosses, and optional powerful enemies.",priority:"high",isProfileSpecific:!1},{title:"Covenant Progress",type:"walkthrough",instruction:"Track covenant memberships, offering progress, and covenant-specific rewards.",priority:"high",isProfileSpecific:!1},{title:"Upgrade Paths",type:"items",instruction:"Weapon upgrade materials, blacksmith locations, and recommended upgrade paths for current build.",priority:"high",isProfileSpecific:!1}]:t.includes("baldur")||t.includes("bg3")?[{title:"Story & Choices",type:"story",instruction:"Track main story progress, major decisions made, and their consequences. Note which companions were recruited and key story branches taken.",priority:"high",isProfileSpecific:!1},{title:"Companion Approval",type:"characters",instruction:"Track companion relationships, approval ratings, personal quests, and romance progress.",priority:"high",isProfileSpecific:!1},{title:"Build & Multiclass",type:"strategies",instruction:"Current character build, multiclass options, and synergistic spell/ability combinations.",priority:"high",isProfileSpecific:!1},{title:"Active Quests",type:"walkthrough",instruction:"List active main quests and important side quests in current act, with quest objectives.",priority:"high",isProfileSpecific:!1},{title:"Secrets & Items",type:"items",instruction:"Hidden legendary items, secret areas, and missable content in current region.",priority:"high",isProfileSpecific:!1}]:t.includes("witcher")?[{title:"Story Progress",type:"story",instruction:"Track main story, key decisions, Ciri's journey, and major political developments.",priority:"high",isProfileSpecific:!1},{title:"Contracts & Quests",type:"walkthrough",instruction:"Active witcher contracts, treasure hunts, and important side quests in current region.",priority:"high",isProfileSpecific:!1},{title:"Combat & Alchemy",type:"strategies",instruction:"Best potions, oils, and decoctions for current enemies. Sign usage tips and combat strategies.",priority:"high",isProfileSpecific:!1},{title:"Characters & Romance",type:"characters",instruction:"Track relationships with Yennefer, Triss, and other key characters. Romance quest progress.",priority:"high",isProfileSpecific:!1},{title:"Gear & Diagrams",type:"items",instruction:"Witcher gear sets available, diagram locations, and upgrade materials needed.",priority:"high",isProfileSpecific:!1}]:t.includes("hollow knight")?[{title:"Exploration Progress",type:"story",instruction:"Track areas explored, lore discovered, and connections between regions.",priority:"high",isProfileSpecific:!1},{title:"Boss Strategies",type:"strategies",instruction:"Detailed strategies for current and nearby bosses, including dream versions and optional challenges.",priority:"high",isProfileSpecific:!1},{title:"Charm Builds",type:"items",instruction:"Recommended charm combinations for current playstyle, and where to find new charms.",priority:"high",isProfileSpecific:!1},{title:"Hidden Secrets",type:"tips",instruction:"Secret paths, hidden rooms, and breakable walls in current and nearby areas.",priority:"high",isProfileSpecific:!1},{title:"NPC Questlines",type:"characters",instruction:"Track NPC locations, quest progress for characters like Hornet, Quirrel, and Bretta.",priority:"high",isProfileSpecific:!1}]:t.includes("god of war")?[{title:"Story & Mythology",type:"story",instruction:"Track main story progress, realm visits, and Norse mythology lore discovered.",priority:"high",isProfileSpecific:!1},{title:"Boss & Enemy Tactics",type:"strategies",instruction:"Strategies for bosses and tough enemies, including optimal runic attacks and Spartan Rage usage.",priority:"high",isProfileSpecific:!1},{title:"Gear & Upgrades",type:"items",instruction:"Best armor sets for current level, weapon upgrades, and where to find crafting materials.",priority:"high",isProfileSpecific:!1},{title:"Realm Exploration",type:"tips",instruction:"Areas to explore in current realm, hidden chests, and optional content.",priority:"high",isProfileSpecific:!1},{title:"Collectibles",type:"walkthrough",instruction:"Track Odin's Ravens, Nornir Chests, artifacts, and other collectibles in current regions.",priority:"high",isProfileSpecific:!1}]:null}generateInitialSubTabs(e,t,a){const i=(a==null?void 0:a.gameTitle)||"",s=this.getGameSpecificTabCustomizations(i);let n;if(s?(n=s,console.error("ðŸŽ® [GameTabService] Using game-specific subtabs for:",i)):(n=(j[e]||j.Default).map(p=>({...p,priority:"medium",isProfileSpecific:!1})),console.error("ðŸŽ® [GameTabService] Using genre-based subtabs for genre:",e)),t){console.error("ðŸŽ® [GameTabService] Generating profile-specific tabs for:",t.playerFocus);const l=K.generateProfileSpecificTabs(t,a);n=[...n,...l],n=K.prioritizeTabsForProfile(n,t)}return n.map(l=>({id:L(),title:l.title,type:l.type,content:"Loading...",isNew:!0,status:"loading",instruction:l.instruction}))}extractInsightsFromAIResponse(e,t){console.error("ðŸ¤– [GameTabService] Extracting dynamic insights from AI response");const a=e.otakonTags.get("INSIGHT_UPDATE");if(a){console.error("ðŸ¤– [GameTabService] Found INSIGHT_UPDATE:",a);const i=a;if(!i.id)return console.error("ðŸ¤– [GameTabService] INSIGHT_UPDATE missing id, skipping"),t;if(t.find(n=>n.id===i.id))return t.map(n=>n.id===i.id?{...n,content:i.content||n.content,isNew:!0,status:"loaded"}:n);{const n={id:L(),title:this.formatTabTitle(i.id),type:this.determineTabType(i.id),content:i.content||"",isNew:!0,status:"loaded"};return[...t,n]}}return t}formatTabTitle(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}determineTabType(e){return e.includes("story")?"story":e.includes("character")?"characters":e.includes("strategy")||e.includes("tips")?"tips":e.includes("boss")?"strategies":e.includes("quest")||e.includes("walkthrough")?"walkthrough":e.includes("item")?"items":"chat"}async generateInitialInsights(e,t,a){var n,l,p;const i=e.id,s=e.gameTitle;console.error(`ðŸ¤– [GameTabService] ðŸ”„ [${i}] Generating initial insights for: ${s}`);try{const h=await b.getConversations(!0);if(!h[i]){console.error(`ðŸ¤– [GameTabService] [${i}] âš ï¸ Conversation no longer exists, aborting insight generation`);return}let c="";const o=h[i],u=((n=o.messages)==null?void 0:n.length)||0;if(u>10)try{const g=await V.loadConversationSummary(i),f=o.messages.slice(-5).map(C=>`${C.role==="user"?"User":"AI"}: ${C.content}`).join(`

`);g?(c=`Previous Context Summary:
${JSON.stringify(g)}

Recent Messages (guaranteed fresh):
${f}`,console.error(`ðŸ¤– [GameTabService] [${i}] âœ… Using summary + 5 recent messages (${u} total msgs)`)):(c=o.messages.slice(-10).map(C=>`${C.role==="user"?"User":"AI"}: ${C.content}`).join(`

`),console.error(`ðŸ¤– [GameTabService] [${i}] Using last 10 messages (no summary available)`))}catch{c=o.messages.slice(-10).map(f=>`${f.role==="user"?"User":"AI"}: ${f.content}`).join(`

`),console.error(`ðŸ¤– [GameTabService] [${i}] Using last 10 messages (summary load failed)`)}else u>0?(c=o.messages.map(g=>`${g.role==="user"?"User":"AI"}: ${g.content}`).join(`

`),console.error(`ðŸ¤– [GameTabService] [${i}] âœ… Using all ${u} messages`)):a!=null&&a.content?(c=`AI Analysis: ${a.content}`,console.error(`ðŸ¤– [GameTabService] [${i}] Using AI response as context (${a.content.length} chars)`)):console.error(`ðŸ¤– [GameTabService] [${i}] âš ï¸ No context available`);console.error(`ðŸ¤– [GameTabService] [${i}] ðŸš€ Calling AI generateInitialInsights...`);const d=await Z.generateInitialInsights(s||"Unknown Game",e.genre||"Action RPG",t,c,o.gameProgress||0);console.error(`ðŸ¤– [GameTabService] [${i}] ðŸ“¥ AI returned:`,Object.keys(d).length,"insights");const v=d&&Object.keys(d).length>0;v?console.error(`ðŸ¤– [GameTabService] [${i}] âœ… Got ${Object.keys(d).length} insights:`,Object.keys(d)):console.error(`ðŸ¤– [GameTabService] [${i}] âŒ Empty insights, using fallback`);const y=h[i];if(!y){console.error(`ðŸ¤– [GameTabService] [${i}] âš ï¸ Conversation not found, may have been deleted`);return}let T=await A.getSubtabs(i);console.error(`ðŸ¤– [GameTabService] [${i}] ðŸ“– Read ${T.length} subtabs from database`),T.length===0&&e.subtabs&&e.subtabs.length>0&&(console.error(`ðŸ¤– [GameTabService] [${i}] âš ï¸ No subtabs in DB but ${e.subtabs.length} in memory - retrying write`),await new Promise(f=>setTimeout(f,500)),await A.setSubtabs(i,e.subtabs)?(console.error(`ðŸ¤– [GameTabService] [${i}] âœ… Retry write succeeded`),T=await A.getSubtabs(i),console.error(`ðŸ¤– [GameTabService] [${i}] ðŸ“– Re-read ${T.length} subtabs from database`)):(console.error(`ðŸ¤– [GameTabService] [${i}] âŒ Retry write failed - using memory subtabs as fallback`),T=e.subtabs)),y.subtabs=T;const G={"Story So Far":"story_so_far","Items You May Have Missed":"missed_items","Relevant Lore":"game_lore","Build Guide":"build_guide","Plan Your Next Session":"next_session_plan","Active Quests":"quest_log","Build Optimization":"build_optimization","Upcoming Boss Strategy":"boss_strategy","Boss Strategy":"boss_strategy","Hidden Paths & Secrets":"hidden_paths","Points of Interest":"points_of_interest","NPC Interactions":"npc_interactions","Consumable Strategy":"consumable_strategy","Character Building":"character_building","Combat Strategies":"combat_strategies","Quest Guide":"quest_guide","Lore Exploration":"lore_exploration","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Pro Tips":"pro_tips","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Exploration Tips":"exploration_tips","Puzzle Solving":"puzzle_solving","Story Progression":"story_progression","Hidden Secrets":"hidden_secrets","Inventory Optimization":"inventory_optimization","Environmental Storytelling":"environmental_storytelling","Goal Suggestions":"goal_suggestions","Efficiency & Optimization":"efficiency_tips","Hidden Mechanics":"hidden_mechanics","Disaster Prep":"disaster_prep","Milestone Roadmap":"milestone_roadmap","System Bottleneck Analysis":"bottleneck_analysis","Expansion Strategy":"expansion_strategy","Team Management":"team_management","Training Focus":"training_focus","Tactical Analysis":"tactical_analysis","Season Progression":"season_progression","Transfer Market Insights":"transfer_market_insights","Injury & Fatigue Management":"injury_fatigue_management","Opposition Scouting":"opposition_scouting","Meta Analysis":"meta_analysis","Team Coordination":"team_coordination","Map Control":"map_control","Skill Development":"skill_development","Ranked Climbing Guide":"ranked_climbing_guide","Warm-up Routine":"warmup_routine","Counter-Meta Strategies":"counter_meta_strategies","Competitive Strategy":"competitive_strategy","Team Synergy":"team_synergy","Performance Optimization":"performance_optimization","Ranked Progression":"ranked_progression","Seasonal Meta Shifts":"seasonal_meta_shifts","Communication Protocols":"communication_protocols","VOD Review Focus Points":"vod_review_focus","Vehicle Tuning":"vehicle_tuning","Track Strategy":"track_strategy","Race Craft":"race_craft","Championship Focus":"championship_focus","Weather Adaptation":"weather_adaptation","Qualifying Strategy":"qualifying_strategy","Rival Analysis":"rival_analysis","Character Analysis":"character_analysis","Matchup Strategy":"matchup_strategy","Execution Training":"execution_training","Tournament Prep":"tournament_prep","Frame Data Insights":"frame_data_insights","Mid-Match Adaptation":"adaptation_tactics","Character Lab Work":"character_lab_work","Drop Strategy":"drop_strategy","Positioning Tactics":"positioning_tactics","Loadout Optimization":"loadout_optimization","Endgame Strategy":"endgame_strategy","Rotation Management":"rotation_management","Audio Warfare":"audio_warfare","Inventory Economy":"inventory_economy","Class Optimization":"class_optimization","Content Progression":"content_progression","Social Strategies":"social_strategies","Alt Character Strategy":"alt_character_strategy","Reputation & Faction Guide":"reputation_faction_guide","Raid Preparation":"raid_preparation","Puzzle Patterns":"puzzle_patterns","Logical Reasoning":"logical_reasoning","Time Optimization":"time_optimization","Difficulty Progression":"difficulty_progression","Mental Breaks Strategy":"mental_breaks_strategy","Pattern Library":"pattern_library","Achievement & Challenge Guide":"achievement_guide","Survival Strategies":"survival_strategies","Enemy Behavior":"enemy_behavior","Atmosphere Navigation":"atmosphere_navigation","Resource Management":"resource_management","Safe Zone Mapping":"safe_zone_mapping","Sanity Management":"sanity_management","Progressive Fear Adaptation":"fear_adaptation","Death Recovery Strategy":"death_recovery","Level Layout Insights":"level_layout","NPC Questlines":"npc_questlines","New Ability Unlocked":"ability_unlocks","Backtracking Guide":"backtracking_guide","Map Completion":"map_completion","Sequence Breaking Options":"sequence_breaking","Upgrade Priority":"upgrade_priority","Region Guide":"region_guide","Activity Checklist":"activity_checklist","Collectible Hunting":"collectible_hunting","Dynamic World Events":"world_events","Exploration Route":"exploration_route","Fast Travel Optimization":"fast_travel_optimization","Progression Balance":"progression_balance","Resource Locations":"resource_locations","Base Building Guide":"base_building","Crafting Priority":"crafting_priority","Survival Tips":"survival_tips","Exploration Targets":"exploration_targets","Progression Roadmap":"progression_roadmap","Danger Warnings":"danger_warnings","Multiplayer Synergy":"multiplayer_synergy","Seasonal Preparation":"seasonal_preparation"};console.error("ðŸ¤– [GameTabService] Building content mapping for subtabs..."),console.error("ðŸ¤– [GameTabService] AI returned insight keys:",Object.keys(d));const w=((l=y.subtabs)==null?void 0:l.map(g=>{let f="";const C=G[g.title];if(C||console.error(`âš ï¸ [GameTabService] MISSING MAPPING: No titleToKeyMap entry for "${g.title}" - will use fallback`),v&&C&&d[C]?(f=d[C],console.error(`âœ… [GameTabService] Subtab "${g.title}" â†’ key "${C}" â†’ AI content (${f.length} chars)`)):v&&C&&console.error(`âš ï¸ [GameTabService] Subtab "${g.title}" â†’ key "${C}" â†’ NOT FOUND in AI response`),!f){let x=c;if(g.type==="story"&&c.includes("Lore:")){const E=c.match(/Lore:(.*?)(?=\n\n|\n[A-Z]|$)/s);x=E?E[1].trim():c}else if(g.type==="strategies"&&c.includes("Analysis:")){const E=c.match(/Analysis:(.*?)(?=\n\n|\n[A-Z]|$)/s);x=E?E[1].trim():c}else if(g.type==="tips"&&c.includes("Hint:")){const E=c.match(/Hint:(.*?)(?=\n\n|\n[A-Z]|$)/s);x=E?E[1].trim():c}f=`## ${g.title}

${x}`,console.error(`ðŸ¤– [GameTabService] Subtab "${g.title}" using fallback content from AI response (${f.length} chars)`),console.error("ðŸ¤– [GameTabService] Preview:",f.substring(0,150)+"...")}return{...g,content:f,isNew:!1,status:"loaded",type:g.type}}))||[];if(w.length===0){console.error(`ðŸ¤– [GameTabService] [${i}] âš ï¸ No subtabs to update - aborting`);return}console.error("ðŸ¤– [GameTabService] Updating subtabs with content...");const k=w.map(g=>{var f;return{id:g.id,title:g.title,type:g.type,status:g.status,contentLength:((f=g.content)==null?void 0:f.length)||0,isNew:g.isNew,hasType:!!g.type}});if(console.error("ðŸ¤– [GameTabService] Subtabs to save:",k),console.error("ðŸ¤– [GameTabService] ALL statuses:",w.map(g=>g.status)),console.error("ðŸ¤– [GameTabService] ALL types:",w.map(g=>g.type||"MISSING_TYPE")),console.error("ðŸ¤– [GameTabService] ðŸ—‘ï¸ Clearing cache BEFORE subtabs write..."),b.clearCache(),!await A.setSubtabs(e.id,w))throw new Error("Failed to update subtabs in database");console.error("ðŸ¤– [GameTabService] âœ… Subtabs dual-write complete (table + JSONB)"),b.clearCache(),console.error("ðŸ¤– [GameTabService] ðŸ” Subtabs saved successfully, skipping verification read"),await b.updateConversation(e.id,{updatedAt:Date.now()}),console.error("ðŸ¤– [GameTabService] âœ… Conversation metadata updated")}catch(h){console.error("ðŸ¤– [GameTabService] âŒ Failed to generate initial insights:",h),Y.warning("Failed to load game insights. You can still chat about the game!");try{const o=(await b.getConversations(!0))[e.id];if(!o){console.error("ðŸ¤– [GameTabService] Conversation not found for error update:",e.id);return}const u=((p=o.subtabs)==null?void 0:p.map(d=>({...d,content:`Failed to load ${d.title} content. Please try again later.`,isNew:!1,status:"error"})))||[];await A.setSubtabs(e.id,u),await b.updateConversation(e.id,{updatedAt:Date.now()})}catch(c){console.error("ðŸ¤– [GameTabService] Failed to update error state:",c)}}}async updateSubTabContent(e,t,a){console.error("ðŸ“ [GameTabService] Updating sub-tab content:",{conversationId:e,subTabId:t});try{const s=(await b.getConversations())[e];if(!s||!s.subtabs)throw new Error("Conversation or sub-tabs not found");const n=s.subtabs.map(l=>l.id===t?{...l,content:a,isNew:!1,status:"loaded"}:l);await A.setSubtabs(e,n),await b.updateConversation(e,{updatedAt:Date.now()})}catch(i){throw console.error("Failed to update sub-tab content:",i),i}}async getGameTab(e){try{const a=(await b.getConversations())[e];return!a||!a.gameTitle?null:{id:a.id,title:a.title,gameId:a.gameId||a.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:a.gameTitle,genre:a.genre||"Unknown",subtabs:a.subtabs||[],createdAt:a.createdAt,updatedAt:a.updatedAt,isActiveSession:a.isActiveSession||!1}}catch(t){return console.error("Failed to get game tab:",t),Y.error("Failed to load game tab."),null}}isGameTab(e){return!e.isGameHub&&!!e.gameTitle}generateGameConversationId(e){return`game-${e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-")}`}async updateSubtabsAfterMigration(e,t){console.error(`ðŸ”„ [GameTabService] [${e}] Updating subtabs after migration...`);try{const i=(await b.getConversations(!0))[e];if(!i){console.error(`ðŸ”„ [GameTabService] [${e}] âš ï¸ Conversation not found, aborting`);return}if(!i.subtabs||i.subtabs.length===0){console.error(`ðŸ”„ [GameTabService] [${e}] No subtabs to update`);return}t!=null&&t.progressiveInsightUpdates&&t.progressiveInsightUpdates.length>0?(console.error(`ðŸ”„ [GameTabService] [${e}] Applying ${t.progressiveInsightUpdates.length} progressive updates`),await this.updateSubTabsFromAIResponse(e,t.progressiveInsightUpdates)):console.error(`ðŸ”„ [GameTabService] [${e}] No progressive updates in AI response`),console.error(`ðŸ”„ [GameTabService] [${e}] âœ… Subtab update complete`)}catch(a){console.error(`ðŸ”„ [GameTabService] [${e}] âŒ Failed to update subtabs:`,a)}}async updateSubTabsFromAIResponse(e,t){console.error(`ðŸ“ [GameTabService] [${e}] Updating subtabs from AI response:`,t.length),console.error(`ðŸ“ [GameTabService] [${e}] Updates to apply:`,t.map(a=>{var i;return{tabId:a.tabId,title:a.title,contentLength:((i=a.content)==null?void 0:i.length)||0}}));try{const i=(await b.getConversations(!0))[e];if(!i||!i.subtabs){console.error(`ðŸ“ [GameTabService] [${e}] âš ï¸ Conversation or subtabs not found, aborting update`);return}console.error(`ðŸ“ [GameTabService] [${e}] Found ${i.subtabs.length} subtabs:`,i.subtabs.map(o=>({id:o.id,title:o.title})));const s={"Story So Far":"story_so_far","Items You May Have Missed":"missed_items","Relevant Lore":"game_lore","Build Guide":"build_guide","Plan Your Next Session":"next_session_plan","Active Quests":"quest_log","Build Optimization":"build_optimization","Upcoming Boss Strategy":"boss_strategy","Boss Strategy":"boss_strategy","Hidden Paths & Secrets":"hidden_paths","Points of Interest":"points_of_interest","NPC Interactions":"npc_interactions","Consumable Strategy":"consumable_strategy","Character Building":"character_building","Combat Strategies":"combat_strategies","Quest Guide":"quest_guide","Lore Exploration":"lore_exploration","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Pro Tips":"pro_tips","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Exploration Tips":"exploration_tips","Puzzle Solving":"puzzle_solving","Story Progression":"story_progression","Hidden Secrets":"hidden_secrets","Inventory Optimization":"inventory_optimization","Environmental Storytelling":"environmental_storytelling","Goal Suggestions":"goal_suggestions","Efficiency & Optimization":"efficiency_tips","Hidden Mechanics":"hidden_mechanics","Disaster Prep":"disaster_prep","Milestone Roadmap":"milestone_roadmap","System Bottleneck Analysis":"bottleneck_analysis","Expansion Strategy":"expansion_strategy","Team Management":"team_management","Training Focus":"training_focus","Tactical Analysis":"tactical_analysis","Season Progression":"season_progression","Transfer Market Insights":"transfer_market_insights","Injury & Fatigue Management":"injury_fatigue_management","Opposition Scouting":"opposition_scouting","Meta Analysis":"meta_analysis","Team Coordination":"team_coordination","Map Control":"map_control","Skill Development":"skill_development","Ranked Climbing Guide":"ranked_climbing_guide","Warm-up Routine":"warmup_routine","Counter-Meta Strategies":"counter_meta_strategies","Competitive Strategy":"competitive_strategy","Team Synergy":"team_synergy","Performance Optimization":"performance_optimization","Ranked Progression":"ranked_progression","Seasonal Meta Shifts":"seasonal_meta_shifts","Communication Protocols":"communication_protocols","VOD Review Focus Points":"vod_review_focus","Vehicle Tuning":"vehicle_tuning","Track Strategy":"track_strategy","Race Craft":"race_craft","Championship Focus":"championship_focus","Weather Adaptation":"weather_adaptation","Qualifying Strategy":"qualifying_strategy","Rival Analysis":"rival_analysis","Character Analysis":"character_analysis","Matchup Strategy":"matchup_strategy","Execution Training":"execution_training","Tournament Prep":"tournament_prep","Frame Data Insights":"frame_data_insights","Mid-Match Adaptation":"adaptation_tactics","Character Lab Work":"character_lab_work","Drop Strategy":"drop_strategy","Positioning Tactics":"positioning_tactics","Loadout Optimization":"loadout_optimization","Endgame Strategy":"endgame_strategy","Rotation Management":"rotation_management","Audio Warfare":"audio_warfare","Inventory Economy":"inventory_economy","Class Optimization":"class_optimization","Content Progression":"content_progression","Social Strategies":"social_strategies","Alt Character Strategy":"alt_character_strategy","Reputation & Faction Guide":"reputation_faction_guide","Raid Preparation":"raid_preparation","Puzzle Patterns":"puzzle_patterns","Logical Reasoning":"logical_reasoning","Time Optimization":"time_optimization","Difficulty Progression":"difficulty_progression","Mental Breaks Strategy":"mental_breaks_strategy","Pattern Library":"pattern_library","Achievement & Challenge Guide":"achievement_guide","Survival Strategies":"survival_strategies","Enemy Behavior":"enemy_behavior","Atmosphere Navigation":"atmosphere_navigation","Resource Management":"resource_management","Safe Zone Mapping":"safe_zone_mapping","Sanity Management":"sanity_management","Progressive Fear Adaptation":"fear_adaptation","Death Recovery Strategy":"death_recovery","Level Layout Insights":"level_layout","NPC Questlines":"npc_questlines","New Ability Unlocked":"ability_unlocks","Backtracking Guide":"backtracking_guide","Map Completion":"map_completion","Sequence Breaking Options":"sequence_breaking","Upgrade Priority":"upgrade_priority","Region Guide":"region_guide","Activity Checklist":"activity_checklist","Collectible Hunting":"collectible_hunting","Dynamic World Events":"world_events","Exploration Route":"exploration_route","Fast Travel Optimization":"fast_travel_optimization","Progression Balance":"progression_balance","Resource Locations":"resource_locations","Base Building Guide":"base_building","Crafting Priority":"crafting_priority","Survival Tips":"survival_tips","Exploration Targets":"exploration_targets","Progression Roadmap":"progression_roadmap","Danger Warnings":"danger_warnings","Multiplayer Synergy":"multiplayer_synergy","Seasonal Preparation":"seasonal_preparation"},n={};for(const[o,u]of Object.entries(s))n[u]=o;let l=0;const p=i.subtabs.map(o=>{const u=t.find(d=>{if(d.tabId===o.id||d.tabId.toLowerCase()===o.title.toLowerCase()||d.title&&d.title.toLowerCase()===o.title.toLowerCase())return!0;const v=n[d.tabId];if(v&&v===o.title)return!0;const y=s[o.title];return!!(y&&y===d.tabId)});if(u){l++,console.error(`ðŸ“ [GameTabService] [${e}] âœ… Matched subtab "${o.title}" (${o.id}) with update.tabId="${u.tabId}"`);const d=new Date().toLocaleString(),v=o.content&&o.content.trim().length>0&&o.content!=="Loading..."&&o.status==="loaded";let y;if(v){const T=o.content,G="<!-- LATEST_UPDATE -->";if(T.includes(G)){const k=T.indexOf(G),D=T.substring(0,k).trim(),g=T.substring(k+G.length).trim(),f=`<details>
<summary>ðŸ“‹ Update from ${d}</summary>

${g}

</details>
`;y=(D?D+`

`+f:f)+`

`+G+`

`+u.content}else y=`<details>
<summary>ðŸ“‹ Initial Content</summary>

${T}

</details>
`+`

`+G+`

`+u.content}else y=`<!-- LATEST_UPDATE -->

`+u.content;if(y.length>q){console.error(`ðŸ“ [GameTabService] [${e}] Subtab ${o.id} exceeds ${q} chars, trimming old collapsed sections`);const T=/<details>\s*<summary>.*?<\/summary>[\s\S]*?<\/details>/g,G=y.match(T)||[];if(G.length>2){let w=y;G.slice(0,G.length-2).forEach(g=>{w=w.replace(g,"")}),!w.includes("Earlier history removed")&&w.includes("<!-- LATEST_UPDATE -->")&&(w=`<details>
<summary>â„¹ï¸ Earlier history removed to save space</summary>

Older updates have been automatically removed. Recent updates are preserved.

</details>

`+w),y=w}console.error(`ðŸ“ [GameTabService] [${e}] Subtab ${o.id} content trimmed to ${y.length} chars`)}return{...o,title:u.title||o.title,content:y,isNew:!0,status:"loaded"}}return o});if(l===0){console.error(`ðŸ“ [GameTabService] [${e}] âš ï¸ No subtabs matched for update`),t.forEach(o=>{console.error(`ðŸ“ [GameTabService] [${e}] âš ï¸ Unmatched update: tabId="${o.tabId}", title="${o.title}"`)});return}const h=new Set;if(i.subtabs.forEach(o=>{const u=t.find(d=>{if(d.tabId===o.id||d.tabId.toLowerCase()===o.title.toLowerCase()||d.title&&d.title.toLowerCase()===o.title.toLowerCase())return!0;const v=n[d.tabId];if(v&&v===o.title)return!0;const y=s[o.title];return!!(y&&y===d.tabId)});u&&h.add(u.tabId)}),t.forEach(o=>{h.has(o.tabId)||console.error(`ðŸ“ [GameTabService] [${e}] âš ï¸ Update not matched to any subtab: tabId="${o.tabId}", title="${o.title}"`)}),console.error(`ðŸ“ [GameTabService] [${e}] Writing ${l} updated subtabs to normalized table...`),!await A.setSubtabs(e,p))throw console.error(`ðŸ“ [GameTabService] [${e}] âŒ Failed to write subtabs to table`),new Error("Failed to update subtabs in database");b.clearCache(),await b.updateConversation(e,{updatedAt:Date.now()}),console.error(`ðŸ“ [GameTabService] [${e}] âœ… Updated ${l} subtabs successfully (table + cache cleared)`)}catch(a){throw console.error(`ðŸ“ [GameTabService] [${e}] âŒ Failed to update subtabs:`,a),a}}async generateSubtabsForExistingGameTabs(e,t,a){const i=Object.values(e).filter(s=>!s.isGameHub&&!s.isUnreleased&&s.gameTitle&&(!s.subtabs||s.subtabs.length===0));if(i.length===0){console.log("ðŸ”„ [GameTabService] No game tabs need subtabs generation");return}console.log(`ðŸ”„ [GameTabService] Found ${i.length} game tabs that need subtabs`);for(let s=0;s<i.length;s++){const n=i[s];try{console.log(`ðŸ”„ [GameTabService] Generating subtabs for "${n.gameTitle}" (${s+1}/${i.length})`);const l=this.generateInitialSubTabs(n.genre||"Default",t,{gameTitle:n.gameTitle||""});await b.updateConversation(n.id,{subtabs:l,subtabsOrder:l.map(p=>p.id),updatedAt:Date.now()}),await A.setSubtabs(n.id,l),await this.generateInitialInsights({...n,subtabs:l},t),console.log(`âœ… [GameTabService] Successfully generated subtabs for "${n.gameTitle}"`),a==null||a(s,i.length,n.gameTitle||n.title),s<i.length-1&&await new Promise(p=>setTimeout(p,1e3))}catch(l){console.error(`âŒ [GameTabService] Failed to generate subtabs for "${n.gameTitle}":`,l)}}a==null||a(i.length,i.length,"Complete"),console.log(`ðŸ”„ [GameTabService] Finished generating subtabs for ${i.length} game tabs`)}}const xe=new me,Me={async fetchGalleryData(r){try{const{data:e,error:t}=await I.from("conversations").select("id, title, game_title").eq("user_id",r);if(t)return console.error("[GalleryService] Error fetching conversations:",t),{albums:[],totalImages:0,loading:!1,error:t.message};if(!e||e.length===0)return{albums:[],totalImages:0,loading:!1};const a=e.map(c=>c.id),{data:i,error:s}=await I.from("messages").select("id, image_url, conversation_id, content, role, created_at").in("conversation_id",a).not("image_url","is",null).order("created_at",{ascending:!1});if(s)return console.error("[GalleryService] Error fetching messages:",s),{albums:[],totalImages:0,loading:!1,error:s.message};const n=new Map(e.map(c=>[c.id,{title:c.title,gameTitle:c.game_title}])),l=new Map;(i||[]).forEach(c=>{var v;if(!c.image_url)return;const o=n.get(c.conversation_id);if(!o)return;const u={id:c.id,imageUrl:c.image_url,conversationId:c.conversation_id,conversationTitle:o.title||"Untitled",gameTitle:o.gameTitle||void 0,messageContent:((v=c.content)==null?void 0:v.substring(0,100))||void 0,capturedAt:new Date(c.created_at||Date.now()).getTime(),role:c.role},d=l.get(c.conversation_id);d?(d.images.push(u),d.imageCount++,d.latestImageAt=Math.max(d.latestImageAt,u.capturedAt)):l.set(c.conversation_id,{conversationId:c.conversation_id,conversationTitle:o.title||"Untitled",gameTitle:o.gameTitle||void 0,coverUrl:void 0,images:[u],imageCount:1,latestImageAt:u.capturedAt})});const p=Array.from(l.values()).sort((c,o)=>o.latestImageAt-c.latestImageAt),h=p.reduce((c,o)=>c+o.imageCount,0);return{albums:p,totalImages:h,loading:!1}}catch(e){return console.error("[GalleryService] Exception:",e),{albums:[],totalImages:0,loading:!1,error:e instanceof Error?e.message:"Unknown error"}}},async downloadImage(r,e){try{const a=await(await fetch(r)).blob(),i=URL.createObjectURL(a),s=document.createElement("a");return s.href=i,s.download=e||`screenshot_${Date.now()}.png`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),!0}catch(t){return console.error("[GalleryService] Download failed:",t),!1}},addToTimeline(r,e,t,a){se.addEvent({type:"album",eventDate:new Date(r.capturedAt).toISOString().split("T")[0],year:t,title:e,description:a||`Screenshot from ${r.gameTitle||r.conversationTitle}`,photos:[r.imageUrl]})},async getImageCount(r){try{const{data:e}=await I.from("conversations").select("id").eq("user_id",r);if(!e||e.length===0)return 0;const t=e.map(s=>s.id),{count:a,error:i}=await I.from("messages").select("id",{count:"exact",head:!0}).in("conversation_id",t).not("image_url","is",null);return i?(console.error("[GalleryService] Count error:",i),0):a||0}catch(e){return console.error("[GalleryService] Count exception:",e),0}},filterByGame(r,e){return r.filter(t=>{var a;return(a=t.gameTitle)==null?void 0:a.toLowerCase().includes(e.toLowerCase())})},getGameTitles(r){const e=new Set;return r.forEach(t=>{t.gameTitle&&e.add(t.gameTitle)}),Array.from(e).sort()}};export{ie as a,z as b,Ee as c,Se as d,Me as e,Ae as f,xe as g,be as h,Pe as i,Ce as j,Ge as k,Ie as l,we as m,ke as n,Te as o,ve as p,_e as q,De as r,Re as s,se as t,W as u,ye as v};
