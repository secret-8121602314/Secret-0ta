const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chat-services-CFUx6KF_.js","assets/ai-vendor-DDPwdD9r.js","assets/services-iLAQln0z.js","assets/auth-Dblf_9Mg.js","assets/react-vendor-B_MlDKAw.js","assets/vendor-DwubNMd3.js","assets/carousel-vendor-DbqMuwPS.js","assets/supabase-vendor-JplHk2xA.js","assets/supabase-realtime-8-W1bgUD.js","assets/gaming-services-EvPXMx7T.js","assets/storage-services-CNz7Dq7v.js"])))=>i.map(i=>d[i]);
var O=Object.defineProperty;var D=(o,t,e)=>t in o?O(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var h=(o,t,e)=>D(o,typeof t!="symbol"?t+"":t,e);import{T as b,s as F,a as S,j as x,b as R,U as k,c as A,t as T,_ as P}from"./chat-services-CFUx6KF_.js";import{s as n}from"./auth-Dblf_9Mg.js";import{c as y,s as C}from"./storage-services-CNz7Dq7v.js";import{t as u,E as q}from"./services-iLAQln0z.js";function _(o){if(o==null)return{};if(typeof o=="string")try{return JSON.parse(o)}catch{return{}}return typeof o=="object"?o:{}}function U(o,t){var g,d;const e=o.tier||"free",r=o.text_limit||((g=b[e])==null?void 0:g.text)||20,a=o.image_limit||((d=b[e])==null?void 0:d.image)||15,s=o.text_count||0,c=o.image_count||0,i=o.total_requests||0,l=o.last_reset?new Date(o.last_reset).getTime():Date.now();return{id:o.id,authUserId:o.auth_user_id||t||"",email:o.email,tier:e,hasProfileSetup:o.has_profile_setup||!1,hasSeenSplashScreens:o.has_seen_splash_screens||!1,hasSeenHowToUse:o.has_seen_how_to_use||!1,hasSeenFeaturesConnected:o.has_seen_features_connected||!1,hasSeenProFeatures:o.has_seen_pro_features||!1,hasSeenWelcomeGuide:o.has_seen_welcome_guide||!1,pcConnected:o.pc_connected||!1,pcConnectionSkipped:o.pc_connection_skipped||!1,onboardingCompleted:o.onboarding_completed||!1,hasWelcomeMessage:o.has_welcome_message||!1,isNewUser:o.is_new_user??!0,hasUsedTrial:o.has_used_trial||!1,lastActivity:Date.now(),textCount:s,imageCount:c,textLimit:r,imageLimit:a,totalRequests:i,lastReset:l,usesCustomGeminiKey:o.uses_custom_gemini_key||!1,geminiApiKeyEncrypted:o.gemini_api_key_encrypted,customKeyVerifiedAt:o.custom_key_verified_at?new Date(o.custom_key_verified_at).getTime():null,hadCustomKeyBefore:o.had_custom_key_before||!1,connectionCode:o.connection_code,connectionCodeCreatedAt:o.connection_code_created_at?new Date(o.connection_code_created_at).getTime():void 0,connectionActive:o.connection_active,connectionDeviceInfo:_(o.connection_device_info),lastConnectionAt:o.last_connection_at?new Date(o.last_connection_at).getTime():void 0,trialStartedAt:o.trial_started_at?new Date(o.trial_started_at).getTime():void 0,trialExpiresAt:o.trial_expires_at?new Date(o.trial_expires_at).getTime():void 0,preferences:_(o.preferences),usage:{textCount:s,imageCount:c,textLimit:r,imageLimit:a,totalRequests:i,lastReset:l,tier:e},appState:_(o.app_state),profileData:_(o.profile_data),onboardingData:_(o.onboarding_data),behaviorData:_(o.behavior_data),feedbackData:_(o.feedback_data),usageData:_(o.usage_data),createdAt:o.created_at?new Date(o.created_at).getTime():Date.now(),updatedAt:o.updated_at?new Date(o.updated_at).getTime():Date.now()}}const p=o=>o,v=class v{constructor(){h(this,"updateQueue",new Map);h(this,"updateTimer",null);h(this,"UPDATE_DEBOUNCE_MS",300);h(this,"lastUpdateCache",new Map)}static getInstance(){return v.instance||(v.instance=new v),v.instance}async getUser(t){try{const{data:e,error:r}=await n.rpc("get_complete_user_data",{p_auth_user_id:t});return r?(console.error("Error getting user:",r),null):e&&e.length>0?U(e[0]):null}catch(e){return console.error("Error getting user:",e),u.error("Failed to load user data. Please try again."),null}}async updateUser(t,e){try{const{error:r}=await n.from("users").update({tier:e.tier,has_used_trial:e.hasUsedTrial,last_activity:e.lastActivity,preferences:p(e.preferences),app_state:p(e.appState),profile_data:p(e.profileData),onboarding_data:p(e.onboardingData),behavior_data:p(e.behaviorData),feedback_data:p(e.feedbackData),usage_data:p(e.usageData),updated_at:new Date().toISOString()}).eq("auth_user_id",t);return r?(console.error("Error updating user:",r,{userId:t,updates:e}),u.error("Failed to update user settings."),!1):!0}catch(r){return console.error("Error updating user:",r),!1}}async updateUsage(t,e){try{const{error:r}=await n.from("users").update({text_count:e.textCount,image_count:e.imageCount,text_limit:e.textLimit,image_limit:e.imageLimit,updated_at:new Date().toISOString()}).eq("auth_user_id",t);return r?(console.error("Error updating usage:",r),!1):!0}catch(r){return console.error("Error updating usage:",r,{userId:t}),u.error("Failed to update usage data."),!1}}async getConversations(t){var e,r;try{const{data:a,error:s}=await n.from("conversations").select(`
          *,
          messages (
            id,
            conversation_id,
            role,
            content,
            image_url,
            metadata,
            created_at
          ),
          subtabs (
            id,
            conversation_id,
            game_id,
            title,
            content,
            tab_type,
            order_index,
            metadata,
            created_at,
            updated_at
          )
        `).order("updated_at",{ascending:!1}).order("created_at",{foreignTable:"messages",ascending:!0});if(!s&&a&&a.length>0)return this.mapConversations(a);const{data:c,error:i}=await n.from("conversations").select(`
          *,
          messages (
            id,
            conversation_id,
            role,
            content,
            image_url,
            metadata,
            created_at
          ),
          subtabs (
            id,
            conversation_id,
            game_id,
            title,
            content,
            tab_type,
            order_index,
            metadata,
            created_at,
            updated_at
          )
        `).eq("auth_user_id",t).order("updated_at",{ascending:!1}).order("created_at",{foreignTable:"messages",ascending:!0});if(i)return console.error("‚ùå [Supabase] Error getting conversations:",i),console.error("‚ùå [Supabase] Error details:",JSON.stringify(i)),[];if(c.length===0){const{data:{session:l}}=await n.auth.getSession();console.error("üîç [Supabase] Zero results diagnostic:",{requestedUserId:t,sessionUserId:(e=l==null?void 0:l.user)==null?void 0:e.id,match:((r=l==null?void 0:l.user)==null?void 0:r.id)===t,message:"RLS SELECT policy may be blocking reads"})}return this.mapConversations(c)}catch(a){return console.error("Error getting conversations:",a),u.error("Failed to load conversations. Please try again."),[]}}mapConversations(t){return t.map(e=>{const r=e.messages,a=Array.isArray(r)?r.map(i=>({id:i.id,role:i.role,content:i.content,timestamp:S(i.created_at),imageUrl:F(i.image_url,void 0),metadata:typeof i.metadata=="object"&&i.metadata!==null?i.metadata:void 0})):[],s=e.subtabs,c=Array.isArray(s)?s.map(i=>{const l=typeof i.metadata=="object"&&i.metadata!==null?i.metadata:{};return{id:i.id,conversationId:i.conversation_id,gameId:i.game_id,title:i.title,content:i.content||"",type:i.tab_type,orderIndex:i.order_index,metadata:l,createdAt:S(i.created_at),updatedAt:S(i.updated_at),isNew:l.isNew||!1,status:l.status||"loaded",instruction:l.instruction}}):[];if(c.length>0&&e.id!=="game-hub"){const i=c[0];console.error("üîç [Supabase] Subtab mapping verification:",{conversationId:e.id,sampleSubtab:{hasType:"type"in i,hasStatus:"status"in i,type:i.type,status:i.status,title:i.title}})}return{id:e.id,authUserId:e.auth_user_id??void 0,userId:e.user_id??void 0,title:e.title,messages:a,gameId:e.game_id??void 0,gameTitle:e.game_title??void 0,genre:e.genre??void 0,subtabs:c,subtabsOrder:e.subtabs_order||[],isActiveSession:e.is_active_session,activeObjective:e.active_objective??void 0,gameProgress:(()=>{const i=e.game_progress,l=i??void 0;return e.id!=="game-hub"&&console.log("üìä [SupabaseService] Loading gameProgress for",e.title,"- DB value:",i,"‚Üí Mapped:",l),l})(),createdAt:S(e.created_at),updatedAt:S(e.updated_at),isActive:e.is_active,isPinned:e.is_pinned??void 0,pinnedAt:e.pinned_at?new Date(e.pinned_at).getTime():void 0,isGameHub:e.is_game_hub??void 0,isUnreleased:e.is_unreleased??void 0,contextSummary:e.context_summary??void 0,lastSummarizedAt:e.last_summarized_at?new Date(e.last_summarized_at).getTime():void 0}})}async createConversation(t,e){var r,a,s;try{const{data:{session:c}}=await n.auth.getSession();if(!c||c.user.id!==t)return console.error("‚ùå [Supabase] Session mismatch! RLS will block reads. Session:",(r=c==null?void 0:c.user)==null?void 0:r.id,"vs userId:",t),console.error("‚ùå [Supabase] Cannot create conversation without valid session - aborting to prevent RLS violation"),null;const i={auth_user_id:t,title:e.title,game_id:e.gameId,game_title:e.gameTitle,genre:e.genre,is_active_session:e.isActiveSession,active_objective:e.activeObjective,game_progress:e.gameProgress,is_active:e.isActive,is_pinned:e.isPinned,pinned_at:e.pinnedAt?new Date(e.pinnedAt).toISOString():null,is_game_hub:e.isGameHub};e.id&&(i.id=e.id);const{data:l,error:g}=await n.from("conversations").upsert(i,{onConflict:"id",ignoreDuplicates:!1}).select("id").single();if(g)return console.error("‚ùå [Supabase] Error creating/updating conversation:",g),console.error("‚ùå [Supabase] Error details:",JSON.stringify(g)),null;const{data:d,error:f}=await n.from("conversations").select("*").eq("id",l.id).single();if(f)console.error("‚ö†Ô∏è [Supabase] Cannot read back conversation after upsert!",f.message),console.error("‚ö†Ô∏è [Supabase] This indicates RLS SELECT policy is blocking reads");else{const{data:{session:m}}=await n.auth.getSession(),L=d.auth_user_id;((a=m==null?void 0:m.user)==null?void 0:a.id)!==L&&console.error("üö® [Supabase] AUTH_USER_ID MISMATCH!",{sessionUserId:(s=m==null?void 0:m.user)==null?void 0:s.id,rowAuthUserId:L,match:!1})}return l.id}catch(c){return console.error("Error creating conversation:",c),null}}async updateConversation(t,e){try{const r=JSON.stringify(e),a=this.lastUpdateCache.get(t);if(a&&Date.now()-a.timestamp<1e3&&a.updates===r)return!0;const s=this.updateQueue.get(t);return this.updateQueue.set(t,{updates:{...s==null?void 0:s.updates,...e},timestamp:Date.now()}),this.updateTimer&&clearTimeout(this.updateTimer),this.updateTimer=setTimeout(()=>this.flushUpdateQueue(),this.UPDATE_DEBOUNCE_MS),!0}catch(r){return console.error("Error queueing conversation update:",r,{conversationId:t}),!1}}async flushUpdateQueue(){const t=Array.from(this.updateQueue.entries());if(this.updateQueue.clear(),t.length===0)return;(await Promise.allSettled(t.map(async([a,{updates:s}])=>{try{const{error:c}=await n.from("conversations").update({title:s.title,game_id:s.gameId,game_title:s.gameTitle,genre:s.genre,is_active_session:s.isActiveSession,active_objective:s.activeObjective,game_progress:s.gameProgress,is_active:s.isActive,is_pinned:s.isPinned,pinned_at:s.pinnedAt?new Date(s.pinnedAt).toISOString():null,is_game_hub:s.isGameHub,is_unreleased:s.isUnreleased,context_summary:s.contextSummary,last_summarized_at:s.lastSummarizedAt?s.lastSummarizedAt:null,updated_at:new Date().toISOString()}).eq("id",a);return c?(console.error("Error updating conversation:",c),!1):(this.lastUpdateCache.set(a,{updates:JSON.stringify(s),timestamp:Date.now()}),!0)}catch(c){return console.error("Error updating conversation:",c,{conversationId:a}),!1}}))).filter(a=>a.status==="rejected"||a.status==="fulfilled"&&!a.value).length>0&&u.error("Some updates failed to save.")}async deleteConversation(t){try{const{error:e}=await n.from("conversations").delete().eq("id",t);return e?(console.error("Error deleting conversation:",e),!1):!0}catch(e){return console.error("Error deleting conversation:",e,{conversationId:t}),u.error("Failed to delete conversation. Please try again."),!1}}async getGames(t){try{const{data:e,error:r}=await n.from("games").select("*").eq("auth_user_id",t).order("created_at",{ascending:!1});return r?(console.error("Error getting games:",r),[]):e.map(a=>({id:a.id,title:a.title,description:a.notes??void 0,genre:a.genre??void 0,platform:a.platform??void 0,releaseDate:"",rating:a.rating??void 0,imageUrl:a.cover_url??void 0,metadata:x(a.metadata),createdAt:S(a.created_at),updatedAt:S(a.updated_at)}))}catch(e){return console.error("Error getting games:",e),[]}}async createGame(t,e){try{const{data:r,error:a}=await n.rpc("get_user_id_from_auth_id",{p_auth_user_id:t});if(a||!r)return console.error("Error resolving user ID:",a),null;const{data:s,error:c}=await n.from("games").insert({user_id:r,auth_user_id:t,title:e.title,notes:e.description,genre:e.genre,platform:e.platform,rating:e.rating,cover_url:e.imageUrl,metadata:p(e.metadata)}).select("id").single();return c?(console.error("Error creating game:",c),null):s.id}catch(r){return console.error("Error creating game:",r),null}}async getTrialStatus(t){try{const{data:e,error:r}=await n.from("users").select("has_used_trial, trial_started_at, trial_expires_at").eq("auth_user_id",t).single();if(r)return console.error("Error getting trial status:",r),null;const a=Date.now(),s=e.trial_expires_at?new Date(e.trial_expires_at).getTime():null,c=s?a<s:!1,i=s?Math.ceil((s-a)/(1e3*60*60*24)):0;return{isEligible:!e.has_used_trial,hasUsed:R(e.has_used_trial),isActive:c,expiresAt:s||void 0,daysRemaining:c?i:void 0}}catch(e){return console.error("Error getting trial status:",e),null}}async startTrial(t){try{const e=new Date;e.setDate(e.getDate()+7);const{error:r}=await n.from("users").update({has_used_trial:!0,trial_started_at:new Date().toISOString(),trial_expires_at:e.toISOString(),tier:k.PRO,text_limit:b[k.PRO].text,image_limit:b[k.PRO].image,updated_at:new Date().toISOString()}).eq("auth_user_id",t);return r?(console.error("Error starting trial:",r),!1):!0}catch(e){return console.error("Error starting trial:",e),!1}}async canMakeRequest(t,e){try{const{data:r,error:a}=await n.from("users").select("text_count, image_count, text_limit, image_limit, tier").eq("auth_user_id",t).single();return a?(console.error("Error checking usage:",a),!1):e==="text"?A(r.text_count)<A(r.text_limit):A(r.image_count)<A(r.image_limit)}catch(r){return console.error("Error checking usage:",r),!1}}async incrementUsage(t,e){try{const{data:r,error:a}=await n.from("users").select("usage_data").eq("auth_user_id",t).single();if(a)return console.error("Error fetching user data:",a),!1;const s=x(r==null?void 0:r.usage_data),c=e==="text"?(s.textCount||0)+1:s.textCount||0,i=e==="image"?(s.imageCount||0)+1:s.imageCount||0,l={textCount:c,imageCount:i,totalRequests:(s.totalRequests||0)+1},{error:g}=await n.from("users").update({usage_data:T(l),updated_at:new Date().toISOString()}).eq("auth_user_id",t);return g?(console.error("Error incrementing usage:",g),!1):!0}catch(r){return console.error("Error incrementing usage:",r),!1}}async resetUsage(t){try{const e={textCount:0,imageCount:0,totalRequests:0,lastReset:Date.now()},{error:r}=await n.from("users").update({usage_data:T(e),updated_at:new Date().toISOString()}).eq("auth_user_id",t);return r?(console.error("Error resetting usage:",r),!1):!0}catch(e){return console.error("Error resetting usage:",e),!1}}async recordQuery(t,e){try{const{data:r,error:a}=await n.rpc("increment_user_usage",{p_auth_user_id:t,p_query_type:e,p_increment:1});return a?(console.error("Error recording query:",a),!1):r===!0}catch(r){return console.error("Error recording query:",r),!1}}async getQueryUsage(t){try{const{data:e,error:r}=await n.from("users").select("text_count, image_count, text_limit, image_limit, last_reset").eq("auth_user_id",t).single();return r?(console.error("Error getting query usage:",r),null):{textCount:e.text_count||0,imageCount:e.image_count||0,textLimit:e.text_limit||20,imageLimit:e.image_limit||15,lastReset:new Date(e.last_reset||Date.now())}}catch(e){return console.error("Error getting query usage:",e),null}}async submitUserFeedback(t,e,r){try{const{error:a}=await n.from("user_feedback").insert({auth_user_id:t,feedback_type:e,message:r,created_at:new Date().toISOString()});return a?(console.error("Error submitting user feedback:",a),!1):!0}catch(a){return console.error("Error submitting user feedback:",a),!1}}};h(v,"instance");let I=v;const M=I.getInstance(),N=()=>typeof window>"u"?!1:window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0||document.referrer.includes("android-app://"),H=()=>{typeof window<"u"&&localStorage.setItem("otakon_pwa_installed","true")},W=o=>o,w=class w{constructor(){h(this,"authState",{user:null,isLoading:!0,error:null});h(this,"listeners",[]);h(this,"pendingUserLoads",new Map);h(this,"cleanupFunctions",[]);h(this,"isDestroyed",!1);this.initializeAuth(),this.setupCleanup()}getCallbackUrl(){const t=window.location.origin,e=N(),r="/auth/callback";return e?`${t}${r}`:`${t}${r}`}static getInstance(){return w.instance||(w.instance=new w),w.instance}setupCleanup(){const t=()=>{this.isDestroyed||this.cleanup()};window.addEventListener("beforeunload",t),this.cleanupFunctions.push(()=>{window.removeEventListener("beforeunload",t)})}async checkRateLimit(t){if(this.isDestroyed)return!1;const e=await y.getRateLimit(t),r=Date.now();return!e||r>e.resetTime?(await y.setRateLimit(t,{count:1,resetTime:r+900*1e3}),!0):e.count>=10?!1:(await y.setRateLimit(t,{count:e.count+1,resetTime:e.resetTime}),!0)}async getCachedUser(t){return this.isDestroyed?null:await y.getUser(t)}async setCachedUser(t,e){this.isDestroyed||await y.setUser(t,e)}async clearCache(){await y.clear()}async invalidateUserCache(t){const e=`user:${t}`;await y.delete(e)}async initializeAuth(){try{if(window.location.pathname==="/auth/callback")return;try{const{data:{session:e}}=await n.auth.getSession();e!=null&&e.user?await this.loadUserFromSupabase(e.user.id):this.updateAuthState({user:null,isLoading:!1,error:null})}catch{const r=localStorage.getItem("otakon_user");if(r)try{const a=JSON.parse(r);this.updateAuthState({user:a,isLoading:!1,error:null})}catch{this.updateAuthState({user:null,isLoading:!1,error:null})}else this.updateAuthState({user:null,isLoading:!1,error:null})}}catch(t){console.error("Auth initialization error:",t),u.error("Failed to initialize authentication. Please refresh the page.",{action:{label:"Refresh",onClick:()=>window.location.reload()}}),this.updateAuthState({user:null,isLoading:!1,error:null})}}async createUserRecord(t){var e,r,a,s,c,i,l,g;try{let d="email";(e=t.app_metadata)!=null&&e.provider?d=t.app_metadata.provider:(r=t.app_metadata)!=null&&r.providers&&t.app_metadata.providers.length>0?d=t.app_metadata.providers[0]:t.identities&&t.identities.length>0?d=t.identities[0].provider:(a=t.user_metadata)!=null&&a.provider&&(d=t.user_metadata.provider);const f=t.email||"",{error:m}=await n.rpc("create_user_record",{p_auth_user_id:t.id,p_email:f,p_full_name:String(((s=t.user_metadata)==null?void 0:s.full_name)||((c=t.user_metadata)==null?void 0:c.name)||"User"),p_avatar_url:(i=t.user_metadata)==null?void 0:i.avatar_url,p_is_developer:!1,p_tier:"free"});if(m){if(m.code==="23505"||(l=m.message)!=null&&l.includes("duplicate key")){console.log("üîê [AuthService] User record already exists (duplicate key), continuing...");return}throw console.error("üîê [AuthService] Error creating user record:",m),u.error("Failed to create your account. Please try again."),m}}catch(d){const f=d;if(f.code==="23505"||(g=f.message)!=null&&g.includes("duplicate key")){console.log("üîê [AuthService] User record already exists (duplicate key in catch), continuing...");return}throw console.error("üîê [AuthService] Error creating user record:",d),u.error("Failed to create your account. Please try again."),d}}async loadUserFromSupabase(t){const e=this.pendingUserLoads.get(t);if(e)return await e;const r=(async()=>{try{await this._loadUserFromSupabaseInternal(t)}finally{this.pendingUserLoads.delete(t)}})();return this.pendingUserLoads.set(t,r),await r}async _loadUserFromSupabaseInternal(t){try{const e=await this.getCachedUser(t);if(e){console.log("üîç [AuthService] Loaded user from cache:",{email:e.email,hasSeenWelcomeGuide:e.hasSeenWelcomeGuide,authUserId:e.authUserId}),this.updateAuthState({user:e,isLoading:!1,error:null});return}console.log("üîç [AuthService] No cached user found, loading from database...");const{data:r,error:a}=await n.rpc("get_complete_user_data",{p_auth_user_id:t});if(a){const{data:s,error:c}=await n.from("users").select("*").eq("auth_user_id",t).single();if(c){console.error("üîê [AuthService] Direct table query also failed:",c),this.updateAuthState({user:null,isLoading:!1,error:"Failed to load user data"});return}if(s){const i=U(s,t);await this.setCachedUser(t,i),this.updateAuthState({user:i,isLoading:!1,error:null});return}}if(r&&r.length>0){const s=U(r[0],t);await this.setCachedUser(t,s),this.updateAuthState({user:s,isLoading:!1,error:null})}else try{const{data:{user:s}}=await n.auth.getUser();s?(await this.createUserRecord(s),await this._loadUserFromSupabaseInternal(t)):this.updateAuthState({user:null,isLoading:!1,error:"User not found and could not create user record"})}catch(s){console.error("üîê [AuthService] Failed to create user record manually:",s),this.updateAuthState({user:null,isLoading:!1,error:"User not found and could not create user record"})}}catch(e){console.error("Error loading user from Supabase:",e),this.updateAuthState({user:null,isLoading:!1,error:"Failed to load user data"})}}updateAuthState(t){const e={...this.authState};this.authState={...this.authState,...t},JSON.stringify(e)!==JSON.stringify(this.authState)&&this.listeners.forEach(a=>a(this.authState))}async signInWithGoogle(){try{if(!await this.checkRateLimit("google_signin"))return{success:!1,error:"Too many sign-in attempts. Please wait before trying again."};this.updateAuthState({isLoading:!0,error:null});const t=this.getCallbackUrl(),{error:e}=await n.auth.signInWithOAuth({provider:"google",options:{redirectTo:t,queryParams:{prompt:"select_account"}}});return e?(console.error("üîê [AuthService] Google OAuth error:",e),u.error("Failed to sign in with Google. Please try again."),this.updateAuthState({isLoading:!1,error:e.message}),{success:!1,error:e.message}):{success:!0}}catch(t){return q.handleAuthError(t,"signInWithGoogle"),u.error("Google sign-in failed. Please try again."),this.updateAuthState({user:null,isLoading:!1,error:"Google sign-in failed. Please try again."}),{success:!1,error:"Google sign-in failed. Please try again."}}}async signInWithDiscord(){if(!this.checkRateLimit("discord_signin"))return{success:!1,error:"Too many sign-in attempts. Please wait before trying again."};try{this.updateAuthState({isLoading:!0,error:null});const t=this.getCallbackUrl();if(window.location.pathname==="/auth/callback")return this.updateAuthState({isLoading:!1,error:null}),{success:!1,error:"Already on callback page"};localStorage.setItem("otakon_discord_auth_attempt",Date.now().toString());const{error:r}=await n.auth.signInWithOAuth({provider:"discord",options:{redirectTo:t,queryParams:{access_type:"offline",prompt:"consent"}}});if(r){console.error("üîê [AuthService] Discord OAuth error:",r),console.error("üîê [AuthService] Error details:",{message:r.message,status:r.status});let a="Discord authentication failed. ";return r.message.includes("Invalid redirect URI")?a+="Please check Discord OAuth configuration in Supabase dashboard.":r.message.includes("Invalid client")?a+="Discord OAuth credentials are invalid. Please check Supabase configuration.":r.message.includes("access_denied")?a+="Discord authorization was cancelled.":a+=r.message,u.error(`Failed to sign in with Discord. ${a}`),this.updateAuthState({isLoading:!1,error:a}),{success:!1,error:a}}return{success:!0}}catch(t){const e=t instanceof Error?t.message:"Unknown error";return console.error("üîê [AuthService] Discord OAuth exception:",t),console.error("üîê [AuthService] Exception details:",{name:t instanceof Error?t.name:"Unknown",message:e,stack:t instanceof Error?t.stack:"No stack trace"}),this.updateAuthState({isLoading:!1,error:e}),{success:!1,error:e}}}async signInWithEmail(t,e){if(!this.checkRateLimit(`email_signin_${t}`))return{success:!1,error:"Too many sign-in attempts. Please wait before trying again."};try{this.updateAuthState({isLoading:!0,error:null});const{data:r,error:a}=await n.auth.signInWithPassword({email:t,password:e});if(a){console.error("üîê [AuthService] Email sign-in error:",a);let s=a.message;return a.message.includes("Invalid login credentials")?s="Invalid email or password. If you signed up with Google or Discord, please use those options instead.":a.message.includes("Email not confirmed")?s="Please check your email and click the confirmation link before signing in.":a.message.includes("Too many requests")&&(s="Too many sign-in attempts. Please wait a moment before trying again."),u.error(s),this.updateAuthState({isLoading:!1,error:s}),{success:!1,error:s}}return r.user?(u.success("Welcome back! Successfully signed in."),await this.loadUserFromSupabase(r.user.id),{success:!0,user:this.authState.user||void 0}):{success:!1,error:"No user data returned"}}catch(r){const a=r instanceof Error?r.message:"Unknown error";return console.error("üîê [AuthService] Email sign-in exception:",r),u.error("Sign-in failed. Please try again."),this.updateAuthState({isLoading:!1,error:a}),{success:!1,error:a}}}async signUpWithEmail(t,e){try{this.updateAuthState({isLoading:!0,error:null});const{data:r,error:a}=await n.auth.signUp({email:t,password:e,options:{emailRedirectTo:this.getCallbackUrl()}});let s=!1;if(a)if(console.error("üîê [AuthService] Email sign-up error:",a),a.message.includes("Error sending confirmation email"))s=!0;else return u.error(`Sign-up failed: ${a.message}`),this.updateAuthState({isLoading:!1,error:a.message}),{success:!1,error:a.message};return r.user?r.user.email_confirmed_at?(await this.loadUserFromSupabase(r.user.id),{success:!0,user:this.authState.user||void 0}):s?(u.success("Account created successfully! Welcome to Otakon!"),await this.loadUserFromSupabase(r.user.id),{success:!0,user:this.authState.user||void 0}):(this.updateAuthState({isLoading:!1,error:null}),{success:!0,user:void 0,requiresConfirmation:!0,message:"Please check your email and click the confirmation link to complete your account setup."}):{success:!1,error:"No user data returned"}}catch(r){const a=r instanceof Error?r.message:"Unknown error";return console.error("üîê [AuthService] Email sign-up exception:",r),this.updateAuthState({isLoading:!1,error:a}),{success:!1,error:a}}}async resetPassword(t){try{this.updateAuthState({isLoading:!0,error:null});const{error:e}=await n.auth.resetPasswordForEmail(t,{redirectTo:this.getCallbackUrl()});return e?(this.updateAuthState({isLoading:!1,error:e.message}),{success:!1,error:e.message}):(this.updateAuthState({isLoading:!1,error:null}),{success:!0})}catch(e){const r=e instanceof Error?e.message:"Unknown error";return this.updateAuthState({isLoading:!1,error:r}),{success:!1,error:r}}}async signOut(){try{this.updateAuthState({user:null,isLoading:!1,error:null}),console.log("üîê [AuthService] Auth state cleared immediately"),await C.endSession(),await n.auth.signOut();const t=[];for(let r=0;r<localStorage.length;r++){const a=localStorage.key(r);a&&a.startsWith("sb-")&&t.push(a)}if(t.forEach(r=>localStorage.removeItem(r)),localStorage.removeItem("otakon_auth_method"),localStorage.removeItem("otakon_remember_me"),localStorage.removeItem("otakon_remembered_email"),localStorage.removeItem("otakon_discord_auth_attempt"),localStorage.removeItem("otakon_has_used_app"),localStorage.removeItem("otakon_user"),localStorage.removeItem("otakon_conversations"),localStorage.removeItem("otakon_app_state"),localStorage.removeItem("otakon_connection_code"),localStorage.removeItem("otakon_last_connection"),localStorage.removeItem("otakonHasConnectedBefore"),localStorage.removeItem("otakon_session_refreshed"),localStorage.removeItem("otakon_last_session_check"),localStorage.removeItem("otagon_gaming_library"),localStorage.removeItem("otagon_gaming_timeline"),localStorage.removeItem("otagon_timeline_albums"),localStorage.removeItem("otagon_timeline_photos"),localStorage.removeItem("otagon_gaming_news_cache"),localStorage.removeItem("otagon_news_generation_log"),localStorage.removeItem("otagon_game_knowledge"),localStorage.removeItem("otagon_user_gaming_profile"),localStorage.removeItem("otagon_gameplay_sessions"),localStorage.removeItem("otagon_igdb_home_cache"),localStorage.removeItem("otagon_game_search_history"),localStorage.removeItem("otakon_manual_upload_mode"),localStorage.removeItem("otakon_screenshot_mode"),localStorage.removeItem("otakon_screenshot_hint_seen"),localStorage.removeItem("otakon_pending_messages"),localStorage.removeItem("otakon_sync_metadata"),localStorage.removeItem("otakon_has_seen_splash_screens"),console.log("üîê [AuthService] All user-specific localStorage cleared"),sessionStorage.clear(),this.clearCache(),this.pendingUserLoads.clear(),"serviceWorker"in navigator&&navigator.serviceWorker.controller)try{navigator.serviceWorker.controller.postMessage({type:"CLEAR_AUTH_CACHE"}),console.log("üîê [AuthService] Notified service worker to clear auth cache")}catch(r){console.error("üîê [AuthService] Failed to notify service worker:",r)}else console.warn("üîê [AuthService] Service worker not available for cache clear");try{const{ConversationService:r}=await P(async()=>{const{ConversationService:a}=await import("./chat-services-CFUx6KF_.js").then(s=>s.g);return{ConversationService:a}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10]));r.clearAllCaches(),console.log("üîí [AuthService] Conversation caches cleared - no data leakage")}catch(r){console.error("‚ö†Ô∏è [AuthService] Failed to clear conversation caches:",r)}try{const{indexedDBService:r}=await P(async()=>{const{indexedDBService:a}=await import("./storage-services-CNz7Dq7v.js").then(s=>s.i);return{indexedDBService:a}},__vite__mapDeps([10,3,4,5,6,7,8]));await r.clearAllMessages(),await r.clearAllImages(),console.log("üîí [AuthService] IndexedDB cleared - no offline data leakage")}catch(r){console.error("‚ö†Ô∏è [AuthService] Failed to clear IndexedDB:",r)}try{console.log("üîí [AuthService] SupabaseService ready for new user")}catch(r){console.error("‚ö†Ô∏è [AuthService] Failed to reset SupabaseService:",r)}document.querySelectorAll('ins.adsbygoogle[data-ad-status="unfilled"]').forEach(r=>{r.parentElement&&!r.closest(".app-container")&&(console.log("üßπ [AuthService] Removing orphaned ad element"),r.remove())}),console.log("üßπ [AuthService] AdSense cleanup complete, DOM styles delegated to App.tsx"),u.success("Successfully signed out. See you next time!")}catch(t){console.error("üîê [AuthService] Sign out error:",t),u.error("Sign out failed. Please try again."),this.updateAuthState({user:null,isLoading:!1,error:null})}}getCurrentUser(){return this.authState.user}getAuthState(){return this.authState}async clearAllUserData(){try{localStorage.removeItem("otakon_auth_method"),localStorage.removeItem("otakon_remember_me"),localStorage.removeItem("otakon_remembered_email"),await n.auth.signOut(),this.updateAuthState({user:null,isLoading:!1,error:null})}catch(t){console.error("üîê [AuthService] Error clearing user data:",t)}}async checkEmailProvider(t){return{provider:null,message:""}}async resendConfirmationEmail(t){try{this.updateAuthState({isLoading:!0,error:null});const{error:e}=await n.auth.resend({type:"signup",email:t,options:{emailRedirectTo:this.getCallbackUrl()}});return e?(console.error("üîê [AuthService] Error resending confirmation email:",e),u.error("Failed to resend confirmation email. Please try again."),this.updateAuthState({isLoading:!1,error:e.message}),{success:!1,error:e.message}):(u.success("Confirmation email sent! Please check your inbox."),this.updateAuthState({isLoading:!1,error:null}),{success:!0,message:"Confirmation email sent! Please check your inbox and click the confirmation link."})}catch(e){const r=e instanceof Error?e.message:"Unknown error";return console.error("üîê [AuthService] Exception resending confirmation email:",e),u.error("Failed to resend confirmation email. Please try again."),this.updateAuthState({isLoading:!1,error:r}),{success:!1,error:r}}}async testDiscordConfiguration(){try{const{error:t}=await n.auth.getSession();return t?{isValid:!1,message:"Cannot access Supabase auth service",details:{sessionError:t}}:{isValid:!0,message:"Discord OAuth configuration appears to be valid",details:{redirectUrl:`${window.location.origin}/auth/callback`,currentOrigin:window.location.origin,currentPathname:window.location.pathname}}}catch(t){return console.error("üîê [AuthService] Error testing Discord configuration:",t),{isValid:!1,message:"Error testing Discord configuration",details:{error:t instanceof Error?t.message:"Unknown error"}}}}async refreshUser(){this.authState.user&&(await this.invalidateUserCache(this.authState.user.authUserId),await this.loadUserFromSupabase(this.authState.user.authUserId),this.authState.user&&!C.getCurrentSessionId()&&await C.startSession(this.authState.user.id,window.location.pathname))}async updateUserProfile(t,e){try{const{error:r}=await n.from("users").update({profile_data:W(e)}).eq("auth_user_id",t);if(r)throw console.error("Error updating profile:",r),u.error("Failed to update profile. Please try again."),r;await this.invalidateUserCache(t),await this.loadUserFromSupabase(t),u.success("Profile updated successfully!")}catch(r){throw console.error("Failed to update profile preferences:",r),u.error("Failed to update profile. Please try again."),r}}subscribe(t){return this.listeners.push(t),t(this.authState),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}cleanup(){this.isDestroyed||(this.isDestroyed=!0,this.clearCache(),this.listeners.length=0,this.cleanupFunctions.forEach(t=>{try{t()}catch(e){console.error("Error during auth service cleanup:",e)}}),this.cleanupFunctions.length=0)}};h(w,"instance");let E=w;const G=E.getInstance(),Q=Object.freeze(Object.defineProperty({__proto__:null,AuthService:E,authService:G},Symbol.toStringTag,{value:"Module"}));export{I as S,G as a,Q as b,N as i,H as m,M as s};
