const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chat-services-BAnxrAbj.js","assets/ai-vendor-DDPwdD9r.js","assets/auth-HSZKT8HQ.js","assets/react-vendor-D37MhRM4.js","assets/vendor-DGJZz16v.js","assets/markdown-vendor-BDhdEczt.js","assets/supabase-vendor-B_G7PGx1.js","assets/core-services-CkHT_-CZ.js"])))=>i.map(i=>d[i]);
var We=Object.defineProperty;var Be=(o,e,t)=>e in o?We(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var h=(o,e,t)=>Be(o,typeof e!="symbol"?e+"":e,t);import{s as d}from"./auth-HSZKT8HQ.js";import{n as qe,a as _,i as se,b as Ge,S as k,U as Ke,T as Oe,_ as Ie,F as ae}from"./chat-services-BAnxrAbj.js";import{b as he,c as q,j as I,d as ne,t as oe}from"./core-services-CkHT_-CZ.js";class He{constructor(){h(this,"memoryCache",new Map);h(this,"DEFAULT_TTL",300*1e3);h(this,"CACHE_TABLE","app_cache");h(this,"MAX_MEMORY_CACHE_SIZE",100);h(this,"pendingRequests",new Map)}async set(e,t,r=this.DEFAULT_TTL,s="general",a){const n=Date.now()+r;this.memoryCache.set(e,{value:t,expires:n});try{console.log(`[CacheService] Storing in Supabase: ${e} (type: ${s}, user: ${a||"none"})`);const{error:c}=await d.from(this.CACHE_TABLE).upsert({key:e,value:JSON.stringify(t),expires_at:new Date(n).toISOString(),updated_at:new Date().toISOString(),cache_type:s,user_id:a||null,size_bytes:JSON.stringify(t).length})}catch{}this.memoryCache.size>this.MAX_MEMORY_CACHE_SIZE&&this.cleanupMemoryCache()}async get(e,t=!1){if(this.pendingRequests.has(e))return await this.pendingRequests.get(e);const r=this.memoryCache.get(e);if(r&&Date.now()<=r.expires)return console.log(`[CacheService] Cache HIT (memory): ${e}`),r.value;if(r&&this.memoryCache.delete(e),t)return console.log(`[CacheService] Cache MISS (memory-only mode): ${e}`),null;const s=this.fetchFromSupabase(e);this.pendingRequests.set(e,s);try{return await s}finally{this.pendingRequests.delete(e)}}async fetchFromSupabase(e){try{console.log(`[CacheService] Cache MISS (memory), trying Supabase: ${e}`);const{data:t,error:r}=await d.from(this.CACHE_TABLE).select("value, expires_at").eq("key",e).maybeSingle();if(r)return null;if(!t)return console.log(`[CacheService] Cache MISS (Supabase): ${e}`),null;const s=new Date(t.expires_at).getTime();if(Date.now()>s)return console.log(`[CacheService] Cache EXPIRED (Supabase): ${e}`),await this.delete(e),null;console.log(`[CacheService] Cache HIT (Supabase): ${e}`);const a=JSON.parse(typeof t.value=="string"?t.value:"{}");return this.memoryCache.set(e,{value:a,expires:s}),a}catch{return null}}async has(e){return await this.get(e)!==null}async delete(e){const t=this.memoryCache.delete(e);try{const{error:r}=await d.from(this.CACHE_TABLE).delete().eq("key",e)}catch{}return t}async clear(){this.memoryCache.clear(),this.pendingRequests.clear();try{const{error:e}=await d.from(this.CACHE_TABLE).delete().neq("key","never_delete")}catch{}}async cleanup(){const e=Date.now();this.cleanupMemoryCache();try{const{error:t}=await d.from(this.CACHE_TABLE).delete().lt("expires_at",new Date(e).toISOString())}catch{}}cleanupMemoryCache(){const e=Date.now(),t=Array.from(this.memoryCache.entries());t.forEach(([r,s])=>{e>s.expires&&this.memoryCache.delete(r)}),this.memoryCache.size>this.MAX_MEMORY_CACHE_SIZE&&t.filter(([a])=>this.memoryCache.has(a)).sort((a,n)=>a[1].expires-n[1].expires).slice(0,this.memoryCache.size-this.MAX_MEMORY_CACHE_SIZE).forEach(([a])=>this.memoryCache.delete(a))}getStats(){return{memorySize:this.memoryCache.size,memoryKeys:Array.from(this.memoryCache.keys())}}async getSupabaseStats(){try{const{data:e,error:t}=await d.rpc("get_cache_stats");return t?null:e}catch{return null}}async getPerformanceMetrics(){try{const{data:e,error:t}=await d.rpc("get_cache_performance_metrics");return t?null:e}catch{return null}}async getUserCacheEntries(e){try{const{data:t,error:r}=await d.rpc("get_user_cache_entries",{p_user_id:e});return r?[]:t||[]}catch{return[]}}async clearUserCache(e){try{const{data:t,error:r}=await d.rpc("clear_user_cache",{p_user_id:e});return r?0:t||0}catch{return 0}}async setChatContext(e,t){await this.set(`chat_context:${e}`,t,2160*60*60*1e3,"context",e)}async getChatContext(e){return await this.get(`chat_context:${e}`)}async setUserMemory(e,t){await this.set(`user_memory:${e}`,t,365*24*60*60*1e3,"memory",e)}async getUserMemory(e){return await this.get(`user_memory:${e}`)}async setGameContext(e,t,r){await this.set(`game_context:${e}:${t}`,r,2160*60*60*1e3,"context",e)}async getGameContext(e,t){return await this.get(`game_context:${e}:${t}`)}async setUser(e,t){await this.set(`user:${e}`,t,365*24*60*60*1e3,"user",e)}async getUser(e){return await this.get(`user:${e}`)}async setRateLimit(e,t){await this.set(`rate_limit:${e}`,t,900*1e3,"rate_limit")}async getRateLimit(e){return await this.get(`rate_limit:${e}`)}async setConversation(e,t,r){await this.set(`conversation:${e}`,t,365*24*60*60*1e3,"conversation",r)}async getConversation(e){return await this.get(`conversation:${e}`)}async initializeCacheTable(){try{const{error:e}=await d.from(this.CACHE_TABLE).select("key").limit(1);e&&e.code}catch{}}}const T=new He;T.initializeCacheTable().catch(()=>{});setInterval(()=>{T.cleanup()},300*1e3);class ie{static handle(e,t,r){this.errorCount++,!this.isErrorRateLimited()&&(console.error(`[${t}]`,{message:e.message,stack:e.stack,context:t,timestamp:new Date().toISOString(),errorCount:this.errorCount}),r&&this.showUserMessage(r),this.reportError(e,t))}static handleAuthError(e,t){const r=this.getAuthErrorMessage(t);this.handle(e,`AuthService:${t}`,r)}static handleWebSocketError(e,t){const r=this.getWebSocketErrorMessage(t);this.handle(e,`WebSocketService:${t}`,r)}static handleConversationError(e,t){const r=this.getConversationErrorMessage(t);this.handle(e,`ConversationService:${t}`,r)}static handleDatabaseError(e,t){const r=this.getDatabaseErrorMessage(t);this.handle(e,`DatabaseService:${t}`,r)}static isErrorRateLimited(){const e=Date.now();return this.recentErrors=this.recentErrors.filter(t=>e-t<this.errorWindow),this.recentErrors.push(e),this.recentErrors.length>this.maxErrorsPerMinute}static showUserMessage(e){}static reportError(e,t){console.warn("[Error Reporting] Would report error to monitoring service:",{error:e.message,context:t,timestamp:new Date().toISOString()})}static getAuthErrorMessage(e){return{signIn:"Failed to sign in. Please check your credentials and try again.",signOut:"Failed to sign out. Please try again.",loadUser:"Failed to load user data. Please refresh the page.",createUser:"Failed to create user account. Please try again.",refreshUser:"Failed to refresh user data. Please try again."}[e]||"An authentication error occurred. Please try again."}static getWebSocketErrorMessage(e){return{connect:"Failed to connect to server. Please check your internet connection.",send:"Failed to send message. Please try again.",disconnect:"Failed to disconnect. Please try again."}[e]||"A connection error occurred. Please try again."}static getConversationErrorMessage(e){return{create:"Failed to create conversation. Please try again.",load:"Failed to load conversations. Please refresh the page.",save:"Failed to save conversation. Please try again.",delete:"Failed to delete conversation. Please try again."}[e]||"A conversation error occurred. Please try again."}static getDatabaseErrorMessage(e){return{save:"Failed to save data. Please try again.",load:"Failed to load data. Please refresh the page.",update:"Failed to update data. Please try again.",delete:"Failed to delete data. Please try again."}[e]||"A database error occurred. Please try again."}static getStats(){return{totalErrors:this.errorCount,recentErrors:this.recentErrors.length,isRateLimited:this.isErrorRateLimited()}}static reset(){this.errorCount=0,this.recentErrors=[]}}h(ie,"errorCount",0),h(ie,"maxErrorsPerMinute",10),h(ie,"errorWindow",60*1e3),h(ie,"recentErrors",[]);class ze{constructor(){h(this,"toasts",[]);h(this,"listeners",new Set);h(this,"maxToasts",5)}subscribe(e){return this.listeners.add(e),e(this.toasts),()=>{this.listeners.delete(e)}}notify(){this.listeners.forEach(e=>e([...this.toasts]))}show(e,t="info",r={}){const s=`toast-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,a={id:s,message:e,type:t,duration:r.duration??this.getDefaultDuration(t),action:r.action,dismissible:r.dismissible??!0};return this.toasts.unshift(a),this.toasts.length>this.maxToasts&&(this.toasts=this.toasts.slice(0,this.maxToasts)),this.notify(),a.duration&&a.duration>0&&setTimeout(()=>this.dismiss(s),a.duration),s}success(e,t){return this.show(e,"success",{duration:3e3,...t})}error(e,t){return this.show(e,"error",{duration:7e3,dismissible:!0,...t})}warning(e,t){return this.show(e,"warning",{duration:5e3,...t})}info(e,t){return this.show(e,"info",{duration:4e3,...t})}dismiss(e){const t=this.toasts.findIndex(r=>r.id===e);t!==-1&&(this.toasts.splice(t,1),this.notify())}dismissAll(){this.toasts=[],this.notify()}getDefaultDuration(e){switch(e){case"success":return 3e3;case"error":return 7e3;case"warning":return 5e3;case"info":return 4e3;default:return 4e3}}loading(e){const t=this.show(e,"info",{duration:0,dismissible:!1});return()=>this.dismiss(t)}async promise(e,t){const r=this.loading(t.loading);try{const s=await e;r();const a=typeof t.success=="function"?t.success(s):t.success;return this.success(a),s}catch(s){r();const a=typeof t.error=="function"?t.error(s):t.error;throw this.error(a),s}}}const H=new ze;let V=!1;typeof window<"u"&&typeof document<"u"&&(document.addEventListener("visibilitychange",()=>{V=document.hidden}),window.addEventListener("blur",()=>{V=!0}),window.addEventListener("focus",()=>{document.hidden||(V=!1)}));const je=async(o,e="Otagon AI")=>{if(!(!V&&!document.hidden)&&!(!("Notification"in window)||Notification.permission!=="granted"))try{const t=o.length>100?o.substring(0,97)+"...":o,r=new Notification(e,{body:t,icon:"/icon-192.png",badge:"/icon-192.png",tag:"otagon-ai-response",requireInteraction:!1,silent:!1});setTimeout(()=>r.close(),1e4),r.onclick=()=>{window.focus(),r.close()}}catch(t){console.error("Failed to show notification:",t)}},Ye=()=>V||document.hidden,Dt=Object.freeze(Object.defineProperty({__proto__:null,isScreenLockedOrHidden:Ye,showAINotification:je,toastService:H},Symbol.toStringTag,{value:"Module"})),x=class x{constructor(){h(this,"currentSessionId",null);h(this,"sessionStartTime",null);h(this,"activityCount",0);h(this,"heartbeatInterval",null)}static getInstance(){return x.instance||(x.instance=new x),x.instance}async startSession(e,t){try{this.currentSessionId&&await this.endSession();const r={initialRoute:t,activityCount:0,deviceInfo:this.getDeviceInfo()},{data:s,error:a}=await d.from("user_sessions").insert({user_id:e,started_at:new Date().toISOString(),session_data:r}).select("id").single();return a?(console.error("Failed to start session:",a),null):(this.currentSessionId=s.id,this.sessionStartTime=Date.now(),this.activityCount=0,this.startHeartbeat(),this.currentSessionId)}catch(r){return console.error("Error starting session:",r),null}}async endSession(){if(!(!this.currentSessionId||!this.sessionStartTime))try{const e=Math.floor((Date.now()-this.sessionStartTime)/1e3),{error:t}=await d.from("user_sessions").update({ended_at:new Date().toISOString(),duration_seconds:e,session_data:{activityCount:this.activityCount,lastActivity:new Date().toISOString()}}).eq("id",this.currentSessionId);t?console.error("Failed to end session:",t):console.log(`‚úÖ Session ended: ${this.currentSessionId} (${e}s)`),this.stopHeartbeat(),this.currentSessionId=null,this.sessionStartTime=null,this.activityCount=0}catch(e){console.error("Error ending session:",e)}}trackActivity(e){this.currentSessionId&&(this.activityCount++,d.from("user_sessions").update({session_data:{activityCount:this.activityCount,lastActivity:new Date().toISOString(),lastActivityType:e}}).eq("id",this.currentSessionId).then(({error:t})=>{t&&console.error("Failed to track activity:",t)}))}async updateSessionData(e){if(this.currentSessionId)try{const{error:t}=await d.from("user_sessions").update({session_data:e}).eq("id",this.currentSessionId);t&&console.error("Failed to update session data:",t)}catch(t){console.error("Error updating session data:",t)}}getCurrentSessionId(){return this.currentSessionId}getSessionDuration(){return this.sessionStartTime?Math.floor((Date.now()-this.sessionStartTime)/1e3):0}startHeartbeat(){this.heartbeatInterval=setInterval(()=>{this.trackActivity("heartbeat")},300*1e3)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}getDeviceInfo(){const{userAgent:e}=navigator,t=/Mobile|Android|iPhone|iPad/.test(e),r=/Tablet|iPad/.test(e);let s="desktop";return t&&!r&&(s="mobile"),r&&(s="tablet"),s}cleanup(){this.stopHeartbeat(),this.currentSessionId&&this.endSession().catch(console.error)}};h(x,"instance");let pe=x;const Je=pe.getInstance();typeof window<"u"&&window.addEventListener("beforeunload",()=>{Je.cleanup()});const ce=o=>o,D=class D{constructor(){}static getInstance(){return D.instance||(D.instance=new D),D.instance}async getOnboardingStatus(e){try{const{data:t,error:r}=await d.rpc("get_user_onboarding_status",{p_user_id:e});if(r)return console.error("üéØ [OnboardingService] Error getting onboarding status:",r),null;if(!t||t.length===0)return null;const s=t[0];return console.log("üéØ [OnboardingService] Onboarding status (first element):",s),s}catch(t){return console.error("üéØ [OnboardingService] Error getting onboarding status:",t),null}}async updateOnboardingStatus(e,t,r={}){try{const{error:s}=await d.rpc("update_user_onboarding_status",{p_user_id:e,p_step:t,p_data:ce(r)});return s?(console.error("Error updating onboarding status:",s),!1):!0}catch(s){return console.error("Error updating onboarding status:",s),!1}}async getOnboardingProgress(e){try{const{data:t,error:r}=await d.from("onboarding_progress").select("*").eq("user_id",e).order("completed_at",{ascending:!0});return r?(console.error("Error getting onboarding progress:",r),[]):(t||[]).map(s=>({step:s.step,completed_at:s.created_at||"",data:typeof s.data=="object"&&s.data!==null&&!Array.isArray(s.data)?s.data:{}}))}catch(t){return console.error("Error getting onboarding progress:",t),[]}}async markSplashScreensSeen(e){return this.updateOnboardingStatus(e,"initial",{splash_screens_seen:!0,timestamp:new Date().toISOString()})}async markProfileSetupComplete(e,t){try{const{error:r}=await d.from("users").update({has_profile_setup:!0,profile_data:ce(t),updated_at:new Date().toISOString()}).eq("auth_user_id",e);return r?(console.error("Error marking profile setup complete:",r),!1):!0}catch(r){return console.error("Error marking profile setup complete:",r),!1}}async markWelcomeMessageShown(e){return this.updateOnboardingStatus(e,"complete",{welcome_message_shown:!0,timestamp:new Date().toISOString()})}async markOnboardingComplete(e){return this.updateOnboardingStatus(e,"complete",{onboarding_complete:!0,timestamp:new Date().toISOString()})}getBooleanValue(e,t=!1){return e==null?t:!!e}async getNextOnboardingStep(e){try{const t=await this.getOnboardingStatus(e);if(!t)return"login";const r=this.getBooleanValue(t.has_seen_splash_screens),s=this.getBooleanValue(t.has_seen_how_to_use),a=this.getBooleanValue(t.has_seen_features_connected),n=this.getBooleanValue(t.has_seen_pro_features),c=this.getBooleanValue(t.pc_connected),i=this.getBooleanValue(t.pc_connection_skipped);return r?r&&!s?"how-to-use":s&&c&&!a?"features-connected":s&&!c&&i&&!n?"pro-features":s&&!c&&!i?"how-to-use":a&&!n?"pro-features":n?"complete":(console.error("üéØ [OnboardingService] ERROR: Unexpected onboarding flow state",{hasSeenSplashScreens:r,hasSeenHowToUse:s,hasSeenFeaturesConnected:a,hasSeenProFeatures:n,pcConnected:c,pcConnectionSkipped:i}),"how-to-use"):"initial"}catch(t){return console.error("üéØ [OnboardingService] Error getting next onboarding step:",t),"login"}}async shouldShowOnboarding(e){try{const t=await this.getOnboardingStatus(e);return t?!t.onboarding_completed:!0}catch(t){return console.error("Error checking if should show onboarding:",t),!0}}async trackOnboardingStep(e,t,r,s={}){try{await d.from("user_analytics").insert({user_id:e,auth_user_id:e,event_type:"onboarding_step",event_data:ce({step:t,action:r,data:s,timestamp:new Date().toISOString()})})}catch(a){console.error("Error tracking onboarding step:",a)}}async trackOnboardingDropOff(e,t,r,s={}){try{await d.from("user_analytics").insert({user_id:e,auth_user_id:e,event_type:"onboarding_dropoff",event_data:ce({step:t,reason:r,data:s,timestamp:new Date().toISOString()})})}catch(a){console.error("Error tracking onboarding dropoff:",a)}}async resetOnboarding(e){try{const{error:t}=await d.from("onboarding_progress").delete().eq("user_id",e);if(t)return console.error("Error clearing onboarding progress:",t),!1;const{error:r}=await d.from("users").update({is_new_user:!0,has_seen_splash_screens:!1,has_profile_setup:!1,has_welcome_message:!1,onboarding_completed:!1,onboarding_data:{}}).eq("id",e);return r?(console.error("Error resetting user onboarding flags:",r),!1):!0}catch(t){return console.error("Error resetting onboarding:",t),!1}}async getOnboardingStats(){try{const{count:e}=await d.from("users").select("*",{count:"exact",head:!0}),{count:t}=await d.from("users").select("*",{count:"exact",head:!0}).eq("onboarding_completed",!0),{data:r}=await d.from("user_analytics").select("event_data").eq("event_type","onboarding_dropoff"),s={};return r&&r.forEach(a=>{const n=a.event_data;if(typeof n=="object"&&n!==null&&!Array.isArray(n)){const c=n.step;typeof c=="string"&&(s[c]=(s[c]||0)+1)}}),{total_users:e||0,completed_onboarding:t||0,dropoff_by_step:s}}catch(e){return console.error("Error getting onboarding stats:",e),{total_users:0,completed_onboarding:0,dropoff_by_step:{}}}}};h(D,"instance");let fe=D;const Ve=fe.getInstance(),$t=Object.freeze(Object.defineProperty({__proto__:null,onboardingService:Ve},Symbol.toStringTag,{value:"Module"}));let b=null;const Xe="wss://otakon-relay.onrender.com";let J=0;const Ze=5e3,ye=[];let ue=null,v=null,O=null,de=!0;const Qe=3e4,et=(o,e,t,r,s)=>{if(b&&(b.readyState===WebSocket.OPEN||b.readyState===WebSocket.CONNECTING))return;if(!/^\d{6}$/.test(o)){const n="Invalid code format. Please enter a 6-digit code.";r(n),H.error(n);return}ue=o,v={onOpen:e,onMessage:t,onError:r,onClose:s},de=!0;const a=`${Xe}/${o}`;try{b=new WebSocket(a)}catch(n){const i=`Connection failed: ${n instanceof Error?n.message:"An unknown error occurred."}. Please check the URL and your network connection.`;r(i),H.error("PC connection failed. Please check your network and try again.");return}b.onopen=()=>{console.log("üîó [WebSocket] Connection opened successfully to",a),J=0,e();try{b==null||b.send(JSON.stringify({type:"connection_request",code:o,ts:Date.now()})),console.log("üîó [WebSocket] Sent connection_request with code:",o)}catch(n){console.error("üîó [WebSocket] Failed to send connection_request:",n)}for(;ye.length&&b&&b.readyState===WebSocket.OPEN;){const n=ye.shift();try{b.send(JSON.stringify(n)),console.log("üîó [WebSocket] Sent queued message:",n==null?void 0:n.type)}catch(c){console.error("üîó [WebSocket] Failed to send queued message:",c)}}O&&(clearInterval(O),O=null),O=window.setInterval(()=>{if(b&&b.readyState===WebSocket.OPEN)try{b.send(JSON.stringify({type:"ping",ts:Date.now()}))}catch{}},Qe)},b.onmessage=n=>{var c;try{const i=JSON.parse(n.data);if(console.log("üîó [WebSocket] Message received:",{type:i.type||"unknown",hasDataUrl:!!i.dataUrl,dataUrlLength:(c=i.dataUrl)==null?void 0:c.length,keys:Object.keys(i)}),i.type==="error"||i.error){const l=i.message||i.error||"Connection failed";console.error("üîó [WebSocket] Server error:",l),localStorage.removeItem("otakon_connection_code"),localStorage.removeItem("otakon_last_connection"),v&&typeof v.onError=="function"&&v.onError(l);return}if(i.type==="no_partner"||i.type==="partner_not_found"||i.type==="invalid_code"){const l="No PC client found with this code. Please check the code and ensure the PC client is running.";console.error("üîó [WebSocket] No partner found:",i),localStorage.removeItem("otakon_connection_code"),localStorage.removeItem("otakon_last_connection"),v&&typeof v.onError=="function"&&v.onError(l);return}if((i.type==="screenshot_success"||i.type==="screenshot_batch"||i.type==="screenshot")&&console.log("üîó [WebSocket] Full screenshot message:",JSON.stringify(i).substring(0,500)),v&&typeof v.onMessage=="function"){console.log("üîó [WebSocket] Invoking onMessage handler with data:",i.type);try{v.onMessage(i),console.log("üîó [WebSocket] Handler completed successfully")}catch(l){console.error("üîó [WebSocket] Handler threw error:",l)}}else console.error("üîó [WebSocket] No valid onMessage handler!",v)}catch(i){console.error("üîó [WebSocket] Failed to parse message:",n.data,i)}},b.onerror=()=>{},b.onclose=n=>{if(console.log("üîó [WebSocket] Connection closed:",{wasClean:n.wasClean,code:n.code,reason:n.reason}),!n.wasClean){let c="Connection closed unexpectedly.";n.code===1006?(c="Connection to the server failed. Please check your network, verify the code, and ensure the PC client is running.",J===0&&H.warning("PC connection lost. Attempting to reconnect...")):n.reason&&(c=`Connection closed: ${n.reason}`),r(c)}if(b=null,s(),O&&(clearInterval(O),O=null),de&&ue&&v){J+=1;const c=Math.min(Ze,500*Math.pow(2,J-1)),i=Math.random()*300,l=c+i;setTimeout(()=>{!b&&v&&de&&et(ue,v.onOpen,v.onMessage,v.onError,v.onClose)},l)}}},Lt=o=>{b&&b.readyState===WebSocket.OPEN?b.send(JSON.stringify(o)):ye.push(o)},Ft=()=>{de=!1,b&&(b.close(1e3,"User disconnected"),b=null),J=0,O&&(clearInterval(O),O=null),ue=null,v=null},Wt=(o,e,t,r)=>{v={onOpen:o,onMessage:e,onError:t,onClose:r},console.log("üîó [WebSocket] Handlers updated")};class Bt{static async addToWaitlist(e,t="landing_page"){try{const{data:r,error:s}=await d.from("waitlist").insert({email:e,source:t,status:"pending"}).select();if(s){if(console.error("Error adding to waitlist:",s),console.error("Insert error details:",{message:s.message,code:s.code,details:s.details,hint:s.hint}),s.code==="23505")return{success:!0,alreadyExists:!0,error:"You're already on our waitlist! We'll email you when access is ready."};const{data:a,error:n}=await d.from("waitlist").select("email, status, created_at").eq("email",e).maybeSingle();return n?(console.error("Error checking existing email:",n),{success:!1,error:`Failed to add to waitlist: ${s.message}`}):a?{success:!0,alreadyExists:!0,error:"You're already on our waitlist! We'll email you when access is ready."}:{success:!1,error:`Failed to add to waitlist: ${s.message}`}}return{success:!0,alreadyExists:!1,error:void 0}}catch(r){return console.error("Waitlist service error:",r),{success:!1,error:"An unexpected error occurred"}}}static async getWaitlistCount(){try{const{count:e,error:t}=await d.from("waitlist").select("*",{count:"exact",head:!0});return t?(console.error("Error getting waitlist count:",t),{error:"Failed to get count"}):{count:e||0}}catch(e){return console.error("Error getting waitlist count:",e),{error:"Failed to get count"}}}static async getWaitlistStats(){try{const{data:e,error:t}=await d.from("waitlist").select("status");if(t)return console.error("Error fetching waitlist stats:",t),{total:137,pending:137,invited:0,converted:0};const r={total:e.length,pending:0,invited:0,converted:0};return e.forEach(s=>{const a=s.status||"pending";a==="pending"?r.pending++:a==="approved"?r.invited++:a==="rejected"&&r.converted++}),r}catch(e){return console.error("Error fetching waitlist stats:",e),{total:137,pending:137,invited:0,converted:0}}}}class M{static get(e,t){try{const r=localStorage.getItem(e);return r?JSON.parse(r):t}catch(r){return console.error(`Error getting ${e} from localStorage:`,r),t}}static set(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error(`Error setting ${e} in localStorage:`,r)}}static remove(e){try{localStorage.removeItem(e)}catch(t){console.error(`Error removing ${e} from localStorage:`,t)}}static clear(){try{localStorage.clear()}catch(e){console.error("Error clearing localStorage:",e)}}}class tt{constructor(){h(this,"CONVERSATION_TTL",720*60*60*1e3);h(this,"CONTEXT_TTL",1440*60*1e3)}async saveConversation(e,t){const r=`conversation:${e.id}`;await T.set(r,e,this.CONVERSATION_TTL,"conversation",t)}async loadConversation(e){const t=`conversation:${e}`;return await T.get(t)}async saveChatContext(e,t){await T.setChatContext(e,t)}async loadChatContext(e){return await T.getChatContext(e)}async saveUserMemory(e,t){await T.setUserMemory(e,t)}async loadUserMemory(e){return await T.getUserMemory(e)}async saveConversationSummary(e,t){const r=`conversation_summary:${e}`;await T.set(r,t,this.CONTEXT_TTL)}async loadConversationSummary(e){const t=`conversation_summary:${e}`;return await T.get(t)}async saveGameContext(e,t,r){await T.setGameContext(e,t,r)}async loadGameContext(e,t){return await T.getGameContext(e,t)}async getUserConversations(e){return[]}async clearUserChatData(e){await T.clearUserCache(e)}}const qt=new tt,le=new Map,Z=new Map,rt=1800*1e3,ke="otagon_igdb_cache",Se=1440*60*1e3,Me="otagon_cover_urls";function st(){try{const o=localStorage.getItem(ke);if(o){const e=JSON.parse(o);if(e.version===1&&Date.now()-e.timestamp<Se){for(const[t,r]of Object.entries(e.games))Date.now()-r.timestamp<Se&&Z.set(t,r);console.log("[IGDBService] Loaded",Z.size,"games from localStorage cache")}}}catch(o){console.warn("[IGDBService] Error loading localStorage cache:",o)}}function at(){try{const o={};Z.forEach((t,r)=>{o[r]=t});const e={version:1,timestamp:Date.now(),games:o};localStorage.setItem(ke,JSON.stringify(e))}catch(o){console.warn("[IGDBService] Error saving localStorage cache:",o)}}function nt(){try{const o=localStorage.getItem(Me);if(o){const e=JSON.parse(o);if(e.version===1&&Date.now()-e.timestamp<Se)return console.log("[IGDBService] Loaded",Object.keys(e.urls).length,"cover URLs from localStorage"),new Map(Object.entries(e.urls))}}catch(o){console.warn("[IGDBService] Error loading cover URL cache:",o)}return new Map}function ot(o){try{const e={version:1,timestamp:Date.now(),urls:Object.fromEntries(o)};localStorage.setItem(Me,JSON.stringify(e))}catch(e){console.warn("[IGDBService] Error saving cover URL cache:",e)}}st();const me=nt();function Ue(o,e="cover_small"){if(!o)return;let t=o;return t=t.replace(/t_(thumb|cover_small|cover_big|720p|1080p|screenshot_huge)/g,`t_${e}`),t.startsWith("//")?t="https:"+t:t.startsWith("http")||(t="https://"+t),t}function Kt(o){var e;if((e=o==null?void 0:o.cover)!=null&&e.url)return Ue(o.cover.url,"cover_small")}async function it(o){if(!o||o.trim().length===0)return console.warn("[IGDBService] Empty game name provided"),null;const e=o.toLowerCase().trim(),t=Z.get(e);if(t&&Date.now()-t.timestamp<rt)return console.log("[IGDBService] Session cache hit:",o),t.data;if(le.has(e))return console.log("[IGDBService] Waiting for pending request:",o),le.get(e);const r=(async()=>{var s,a;try{console.log("[IGDBService] Fetching game data:",o);const{data:{session:n}}=await d.auth.getSession(),c={"Content-Type":"application/json"};n!=null&&n.access_token&&(c.Authorization=`Bearer ${n.access_token}`),console.log("[IGDBService] Invoking igdb-proxy with gameName:",o);const i=await d.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:o}),headers:c});if(i.error){console.error("[IGDBService] Edge function error:",i.error);const g=i.error;return((s=g==null?void 0:g.message)!=null&&s.includes("IGDB_NOT_CONFIGURED")||(a=g==null?void 0:g.message)!=null&&a.includes("503"))&&console.warn("[IGDBService] IGDB service not configured - game data will not be available"),null}const l=i.data;if((l==null?void 0:l.code)==="IGDB_NOT_CONFIGURED")return console.warn("[IGDBService] IGDB service not configured on server"),null;if(!l.success||!l.data)return console.log("[IGDBService] No data found for:",o),null;const u=l.data;return Z.set(e,{data:u,timestamp:Date.now()}),at(),console.log("[IGDBService] Successfully fetched:",u.name,l.cached?"(cached)":"(fresh)"),u}catch(n){return console.error("[IGDBService] Error fetching game data:",n),null}finally{le.delete(e)}})();return le.set(e,r),r}async function Ht(o){return it(`id:${o}`)}function zt(o,e="high"){return`https://img.youtube.com/vi/${o}/${{default:"default",medium:"mqdefault",high:"hqdefault",maxres:"maxresdefault"}[e]}.jpg`}function jt(o){return{1:"Official",2:"Wikia",3:"Wikipedia",4:"Facebook",5:"Twitter",6:"Twitch",8:"Instagram",9:"YouTube",10:"iPhone",11:"iPad",12:"Android",13:"Steam",14:"Reddit",15:"Itch.io",16:"Epic Games",17:"GOG",18:"Discord"}[o]||"Website"}function Yt(o,e){return o===1?{6:"RP (Rating Pending)",7:"EC (Early Childhood)",8:"E (Everyone)",9:"E10+ (Everyone 10+)",10:"T (Teen)",11:"M (Mature 17+)",12:"AO (Adults Only)"}[e]||"Not Rated":o===2&&{1:"PEGI 3",2:"PEGI 7",3:"PEGI 12",4:"PEGI 16",5:"PEGI 18"}[e]||"Not Rated"}function Jt(o){return o?new Date(o*1e3).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"TBA"}function Vt(o){return o?o.filter(e=>e.developer).map(e=>e.company.name):[]}function Xt(o){return o?o.filter(e=>e.publisher).map(e=>e.company.name):[]}function Zt(o){return o.total_rating??o.aggregated_rating??o.rating??null}async function Qt(o){var s;const e=new Map;if(o.length===0)return e;const t=o.map(a=>a.toLowerCase().trim()),r=[];for(const a of t){const n=me.get(a);n?e.set(a,n):r.push(a)}if(r.length===0)return console.log("[IGDBService] All cover URLs from localStorage cache:",e.size),e;try{const{data:a,error:n}=await d.from("igdb_game_cache").select("game_name_key, game_data").in("game_name_key",r).gt("expires_at",new Date().toISOString());if(n)return console.warn("[IGDBService] Error fetching cover URLs from cache:",n.message),e;if(a){for(const c of a){const i=c.game_data;if((s=i==null?void 0:i.cover)!=null&&s.url){const l=Ue(i.cover.url,"cover_small");l&&(e.set(c.game_name_key,l),me.set(c.game_name_key,l))}}ot(me)}console.log("[IGDBService] Fetched cover URLs:",e.size,"of",o.length,"(",e.size-r.length+(a==null?void 0:a.length),"from localStorage,",(a==null?void 0:a.length)||0,"from Supabase)")}catch(a){console.warn("[IGDBService] Error in fetchCoverUrlsFromCache:",a)}return e}const er=o=>{const e=new Map;let t=o;console.log(`üè∑Ô∏è [otakonTags] Parsing response (${o.length} chars)...`);const r=/\[OTAKON_SUGGESTIONS:\s*(\[[\s\S]*?\])\s*\]/g;let s;for(;(s=r.exec(o))!==null;)try{const m=s[1].replace(/'/g,'"'),f=JSON.parse(m);e.set("SUGGESTIONS",f),t=t.replace(s[0],""),console.log("üè∑Ô∏è [otakonTags] Extracted SUGGESTIONS:",f)}catch{console.warn("[OtakonTags] Failed to parse SUGGESTIONS JSON:",s[1])}const a=/\[OTAKON_SUBTAB_UPDATE:\s*(\{[\s\S]*?\})\s*\]/g;let n;const c=[];for(;(n=a.exec(o))!==null;)try{const m=JSON.parse(n[1]);c.push(m),t=t.replace(n[0],"")}catch{console.warn("[OtakonTags] Failed to parse SUBTAB_UPDATE JSON:",n[1])}c.length>0&&e.set("SUBTAB_UPDATE",c);const i=/\[OTAKON_([A-Z_]+):\s*([^\[\]]+?)\]/g;let l,u=null;const g=o.match(/\[OTAKON_PROGRESS[:\s]+(\d+)/i);if(g&&(u=parseInt(g[1],10),console.log(`üìä [otakonTags] Found OTAKON_PROGRESS format: ${g[0]} ‚Üí ${u}%`)),!u){const m=o.match(/\[?PROGRESS[:\s]+(\d+)/i);m&&(u=parseInt(m[1],10),console.log(`üìä [otakonTags] Found PROGRESS format: ${m[0]} ‚Üí ${u}%`))}if(!u){const m=o.match(/(?:progress|completion|game progress)[:\s]+(?:approximately\s+)?(\d+)\s*%/i);m&&(u=parseInt(m[1],10),console.log(`üìä [otakonTags] Found inline progress format: ${m[0]} ‚Üí ${u}%`))}if(!u){const m=o.match(/"stateUpdateTags"[^}]*"PROGRESS[:\s]+(\d+)/i);m&&(u=parseInt(m[1],10),console.log(`üìä [otakonTags] Found stateUpdateTags PROGRESS: ${m[0]} ‚Üí ${u}%`))}for(u!==null&&u>=0&&u<=100?(e.set("PROGRESS",u),console.log(`üìä [otakonTags] ‚úÖ Set PROGRESS tag to: ${u}%`)):console.log("üìä [otakonTags] ‚ö†Ô∏è No valid progress found in response");(l=i.exec(o))!==null;){const m=l[1];let f=l[2].trim();if(console.log(`üè∑Ô∏è [otakonTags] Found tag: ${m} = ${l[2].substring(0,50)}`),!(m==="SUGGESTIONS"||m==="SUBTAB_UPDATE")){try{const w=f;w.startsWith("{")&&w.endsWith("}")&&(f=JSON.parse(w)),w.startsWith("[")&&w.endsWith("]")&&(f=JSON.parse(w.replace(/'/g,'"')))}catch{}if(m==="PROGRESS"){const w=String(f).trim(),A=w.match(/(\d+)/);if(A){const p=parseInt(A[1],10);f=Math.min(100,Math.max(0,p)),console.log(`üìä [otakonTags] Parsed PROGRESS: "${w}" ‚Üí ${f}`)}else console.warn(`üìä [otakonTags] Could not parse PROGRESS value: "${w}"`)}e.set(m,f),t=t.replace(l[0],"")}}return t=t.replace(/\[OTAKON_[A-Z_]+:[^\]]*\]/g,"").replace(/^["'][^"']*\?["']\s*,?\s*/gm,"").replace(/^["'](?:and\s+)?\[\d+\][^"']*\?["']\s*,?\s*/gim,"").replace(/^["'][^"']*\?["']\s*\]\s*/gm,"").replace(/^[^"']*\?["']\s*\]\s*/gm,"").replace(/^(?:["'][^"']*["']\s*,?\s*)+\]/g,""),t=t.replace(/^Hint:\s*\n\s*Hint:\s*/gm,"Hint: ").replace(/^Hint:\s*\n\s*Hint:\s*/gm,"Hint: ").replace(/\]\s*$/gm,"").replace(/^\s*\]/gm,"").replace(/\[\s*$/gm,"").replace(/^\s*\[/gm,"").replace(/\s+\]\s+/g," ").replace(/\s+\[\s+/g," ").replace(/\*\*\s+([^*]+?)\s+\*\*/g,"**$1**").replace(/\*\*\s+([^*]+?):/g,"**$1:**").replace(/\.\s*(\d+\.\*\*)/g,`.

$1`).replace(/\.\s*(\d+\.\s+)/g,`.

$1`).replace(/\*\*([^*\n]+)(?!\*\*)/g,(m,f)=>f.endsWith(":")?`**${f}**`:m).replace(/([.!?])(\s*)Hint:/gi,`$1

**Hint:**`).replace(/([.!?])(\s*)Lore:/gi,`$1

**Lore:**`).replace(/([.!?])(\s*)Places of Interest:/gi,`$1

**Places of Interest:**`).replace(/([.!?])(\s*)Strategy:/gi,`$1

**Strategy:**`).replace(/([.!?])(\s*)What to focus on:/gi,`$1

**What to focus on:**`).replace(/\*\*Hint:\*\*\s*/gi,`**Hint:**
`).replace(/\*\*Lore:\*\*\s*/gi,`

**Lore:**
`).replace(/\*\*Places of Interest:\*\*\s*/gi,`

**Places of Interest:**
`).replace(/\*\*Strategy:\*\*\s*/gi,`

**Strategy:**
`).replace(/\*\*What to focus on:\*\*\s*/gi,`

**What to focus on:**
`).replace(/^Hint:\s*/i,`**Hint:**
`).replace(/\nHint:\s*/gi,`

**Hint:**
`).replace(/\nLore:\s*/gi,`

**Lore:**
`).replace(/\nPlaces of Interest:\s*/gi,`

**Places of Interest:**
`).replace(/\nStrategy:\s*/gi,`

**Strategy:**
`).replace(/\nWhat to focus on:\s*/gi,`

**What to focus on:**
`).replace(/\n{3,}/g,`

`).replace(/^\s+|\s+$/g,"").trim(),e.size>0&&console.log(`üè∑Ô∏è [otakonTags] Extracted ${e.size} tags:`,Array.from(e.keys()).join(", ")),{cleanContent:t,tags:e}},$=class ${static getInstance(){return $.instance||($.instance=new $),$.instance}generateCacheKey(e,t){var n;const r={prompt:e.trim().toLowerCase(),gameTitle:(n=t.gameTitle)==null?void 0:n.toLowerCase(),mode:t.mode},s=JSON.stringify(r);let a=0;for(let c=0;c<s.length;c++){const i=s.charCodeAt(c);a=(a<<5)-a+i,a=a&a}return Math.abs(a).toString(36)}async getCachedResponse(e){try{const{data:t,error:r}=await d.from("ai_responses").select("response_data, created_at, model_used, tokens_used, cache_type").eq("cache_key",e).gt("expires_at",new Date().toISOString()).single();if(r)return r.code==="PGRST116"?(console.log("‚ùå [aiCacheService] Cache MISS:",e.substring(0,8)),null):(console.error("‚ùå [aiCacheService] Error checking cache:",r),null);if(t){const s=t.created_at?Math.floor((Date.now()-new Date(t.created_at).getTime())/1e3/60):0;return console.log("‚úÖ [aiCacheService] Cache HIT:",e.substring(0,8),{age:`${s}m`,model:t.model_used,tokens:t.tokens_used,type:t.cache_type}),t.response_data}return null}catch(t){return console.error("Error in getCachedResponse:",t),null}}async cacheResponse(e,t,r){try{const s=new Date;s.setHours(s.getHours()+r.ttlHours);const{data:{user:a}}=await d.auth.getUser(),{error:n}=await d.from("ai_responses").upsert({cache_key:e,response_data:JSON.parse(JSON.stringify(t)),game_title:r.gameTitle,cache_type:r.cacheType,conversation_id:r.conversationId,model_used:r.modelUsed,tokens_used:r.tokensUsed,user_id:a==null?void 0:a.id,expires_at:s.toISOString(),created_at:new Date().toISOString()},{onConflict:"cache_key"});return n?(console.error("Error caching response:",n),!1):(console.log("üíæ Cached response:",e.substring(0,8),{type:r.cacheType,ttl:r.ttlHours+"h",tokens:r.tokensUsed,game:r.gameTitle}),!0)}catch(s){return console.error("Error in cacheResponse:",s),!1}}determineCacheType(e){return e.gameTitle?"game_specific":e.hasUserContext||e.conversationId?"user":"global"}determineTTL(e,t){switch(e){case"global":return 168;case"game_specific":return 24;case"user":return 12;default:return 24}}shouldCache(e,t){if(console.log(`üîç [aiCacheService] shouldCache called with prompt: "${e.substring(0,50)}..."`,t),t.noCache===!0)return!1;if(e.trim().length<10)return console.log(`‚ùå [aiCacheService] Not caching: prompt too short (${e.trim().length} chars)`),!1;const r=["today","now","current","latest","recent","just released"],s=e.toLowerCase();return!r.find(n=>s.includes(n))}async cleanupExpiredCache(){try{const{data:e,error:t}=await d.from("ai_responses").delete().lt("expires_at",new Date().toISOString()).select("id");return t?(console.error("Error cleaning up cache:",t),{deleted:0}):{deleted:(e==null?void 0:e.length)||0}}catch(e){return console.error("Error in cleanupExpiredCache:",e),{deleted:0}}}async getCacheStats(){try{const{data:e,error:t}=await d.from("ai_responses").select("cache_type, tokens_used").gt("expires_at",new Date().toISOString());if(t)return console.error("Error getting cache stats:",t),{totalEntries:0,byType:{},totalTokensSaved:0};const r={totalEntries:e.length,byType:{},totalTokensSaved:e.reduce((s,a)=>s+(a.tokens_used||0),0)};return e.forEach(s=>{const a=s.cache_type||"unknown";r.byType[a]=(r.byType[a]||0)+1}),r}catch(e){return console.error("Error in getCacheStats:",e),{totalEntries:0,byType:{},totalTokensSaved:0}}}async invalidateGameCache(e){try{const{error:t}=await d.from("ai_responses").delete().eq("game_title",e).eq("cache_type","game_specific");return t?(console.error("Error invalidating game cache:",t),!1):!0}catch(t){return console.error("Error in invalidateGameCache:",t),!1}}};h($,"instance");let be=$;const tr=be.getInstance(),L=class L{constructor(){}static getInstance(){return L.instance||(L.instance=new L),L.instance}generateProfileSpecificTabs(e,t){const r=[];return e.playerFocus==="Story-Driven"&&r.push({id:"narrative_themes",title:"Narrative Themes",type:"story",priority:"high",isProfileSpecific:!0,instruction:this.getNarrativeThemesInstruction(e.hintStyle)}),e.playerFocus==="Completionist"&&r.push({id:"secret_hunting",title:"Secret Hunting",type:"tips",priority:"high",isProfileSpecific:!0,instruction:this.getSecretHuntingInstruction(e.hintStyle)}),e.playerFocus==="Strategist"&&r.push({id:"optimization_guide",title:"Optimization Guide",type:"strategies",priority:"high",isProfileSpecific:!0,instruction:this.getOptimizationInstruction(e.hintStyle)}),t!=null&&t.playthroughCount&&t.playthroughCount>1&&r.push({id:"playthrough_comparison",title:"Playthrough Comparison",type:"tips",priority:"medium",isProfileSpecific:!0,instruction:this.getPlaythroughComparisonInstruction(e)}),r}getNarrativeThemesInstruction(e){const t={Cryptic:"Provide subtle hints about story themes without revealing major plot points. Use metaphorical language and thematic connections.",Balanced:"Discuss narrative elements with moderate detail, balancing spoiler avoidance with meaningful insight into themes and character arcs.",Direct:"Explain story themes clearly while maintaining appropriate spoiler warnings. Provide direct analysis of narrative elements encountered so far."};return t[e]||t.Balanced}getSecretHuntingInstruction(e){const t={Cryptic:"Give mysterious clues about hidden content locations. Use environmental riddles and subtle hints that require exploration.",Balanced:"Provide clear directions to secrets with some exploration challenge. Balance helpfulness with maintaining the joy of discovery.",Direct:"Give precise locations and requirements for finding secrets. Include step-by-step instructions and exact coordinates when helpful."};return t[e]||t.Balanced}getOptimizationInstruction(e){const t={Cryptic:"Suggest optimization strategies through hints and examples. Let the player discover the optimal path with guidance.",Balanced:"Provide balanced optimization advice with clear explanations. Suggest effective approaches while leaving room for experimentation.",Direct:"Give specific optimization recommendations with detailed steps. Provide exact stat allocations, builds, and strategies for maximum efficiency."};return t[e]||t.Direct}getPlaythroughComparisonInstruction(e){return`Compare different playthrough approaches based on ${e.playerFocus} style and ${e.hintStyle} preferences. Highlight what's different this time and suggest new strategies to explore.`}prioritizeTabsForProfile(e,t){return e.sort((r,s)=>{if(r.isProfileSpecific&&!s.isProfileSpecific)return-1;if(!r.isProfileSpecific&&s.isProfileSpecific)return 1;const a={high:3,medium:2,low:1};return a[s.priority]-a[r.priority]})}getHintStyleModifier(e){const t={Cryptic:"Use subtle, metaphorical hints. Avoid direct answers. Make the player think and discover.",Balanced:"Provide clear guidance while leaving room for exploration. Balance helpfulness with discovery.",Direct:"Give explicit, step-by-step instructions. Be precise and comprehensive in explanations."};return t[e]||t.Balanced}getPlayerFocusModifier(e){const t={"Story-Driven":"Emphasize narrative elements, character development, and story context. Prioritize lore and thematic content.",Completionist:"Focus on collectibles, hidden items, side quests, and 100% completion strategies. Highlight missable content.",Strategist:"Prioritize optimal strategies, build optimization, and efficient progression. Focus on mechanics and systems."};return t[e]||t.Strategist}getSpoilerToleranceModifier(e){const t={Strict:"NEVER mention future events, characters, or plot points. Only discuss content up to current progress.",Moderate:"You may hint at upcoming content in vague terms, but avoid specific spoilers.",Relaxed:"You can discuss future content more freely, but still mark major spoilers clearly."};return t[e]||t.Strict}getToneModifier(e){const t={Encouraging:"Use an enthusiastic, supportive tone. Celebrate achievements and provide positive reinforcement.",Professional:"Maintain a knowledgeable, respectful tone. Provide expertise without excessive casualness.",Casual:"Use a friendly, conversational tone. Feel free to use gaming terminology and be relaxed."};return t[e]||t.Professional}buildProfileContext(e){return[`Hint Style: ${this.getHintStyleModifier(e.hintStyle)}`,`Player Focus: ${this.getPlayerFocusModifier(e.playerFocus)}`,`Spoiler Tolerance: ${this.getSpoilerToleranceModifier(e.spoilerTolerance)}`,`Tone: ${this.getToneModifier(e.preferredTone)}`].join(`
`)}getDefaultProfile(){return{hintStyle:"Balanced",playerFocus:"Strategist",preferredTone:"Professional",spoilerTolerance:"Strict"}}};h(L,"instance");let _e=L;const z=_e.getInstance(),Te=`
You MUST use the following tags to structure your response. Do not put them in a code block.
- [OTAKON_GAME_ID: Game Name]: The full, official name of the game you've identified.
- [OTAKON_CONFIDENCE: high|low]: Your confidence in the game identification.
- [OTAKON_GENRE: Genre]: The primary genre of the identified game. Must be one of:
  ‚Ä¢ Action RPG - Action-focused RPGs with real-time combat (Dark Souls, God of War, etc.)
  ‚Ä¢ RPG - Traditional role-playing games with deep stories and character progression
  ‚Ä¢ Souls-like - Challenging action games inspired by Dark Souls (Elden Ring, Sekiro, Hollow Knight, etc.)
  ‚Ä¢ Metroidvania - Non-linear exploration platformers with ability-gated progression
  ‚Ä¢ Open-World - Large open-world games with exploration focus (GTA, Zelda: BOTW, etc.)
  ‚Ä¢ Survival-Crafting - Survival games with resource gathering and crafting mechanics
  ‚Ä¢ First-Person Shooter - FPS games
  ‚Ä¢ Strategy - Strategy and tactical games (RTS, turn-based, 4X)
  ‚Ä¢ Adventure - Story-driven adventure and narrative games
  ‚Ä¢ Simulation - Simulation and management games
  ‚Ä¢ Sports - Sports games and sports management sims
  ‚Ä¢ Multiplayer Shooter - Competitive multiplayer FPS games
  ‚Ä¢ Multiplayer Sports - Competitive multiplayer sports games
  ‚Ä¢ Racing - Racing games and driving sims
  ‚Ä¢ Fighting - Fighting games
  ‚Ä¢ Battle Royale - Battle royale games
  ‚Ä¢ MMORPG - Massively multiplayer online RPGs
  ‚Ä¢ Puzzle - Puzzle games
  ‚Ä¢ Horror - Horror and survival horror games
  ‚Ä¢ Default - Use this only if none of the above genres fit
  **Important**: Use the EXACT genre names listed above. Choose the MOST SPECIFIC genre that fits the game.
- [OTAKON_GAME_STATUS: unreleased]: ONLY include this tag if the game is NOT YET RELEASED. Verify the release date before including this tag.
- [OTAKON_IS_FULLSCREEN: true|false]: Whether the screenshot shows fullscreen gameplay (not menus, launchers, or non-game screens).
- [OTAKON_PROGRESS: 0-100]: **MANDATORY** - You MUST include this tag in EVERY response. Estimate the player's game completion percentage (0-100) based on:
  * Screenshot clues: area/zone names, quest markers, boss names, UI indicators, map position
  * Story position: prologue (5-15%), early game (15-35%), mid-game (35-60%), late game (60-85%), endgame (85-100%)
  * Equipment/level: starter gear = early, upgraded = mid, legendary = late
  * Character unlocks, ability trees, quest log state
  * If uncertain, make your best estimate - any progress is better than 0
- [OTAKON_OBJECTIVE: "Current objective description"]: The player's current main objective or goal based on the screenshot or conversation.
- [OTAKON_TRIUMPH: {"type": "boss_defeated", "name": "Boss Name"}]: When analyzing a victory screen.
- [OTAKON_OBJECTIVE_SET: {"description": "New objective"}]: When a new player objective is identified.
- [OTAKON_INSIGHT_UPDATE: {"id": "sub_tab_id", "content": "content"}]: To update a specific sub-tab with NEW information discovered in this conversation.
- [OTAKON_SUBTAB_UPDATE: {"tab": "story_so_far|characters|tips|boss_strategy|quest_log", "content": "New content to append"}]: ALWAYS include this when you provide information that should be saved to a subtab. This ensures subtabs stay updated with the latest information.
- [OTAKON_INSIGHT_MODIFY_PENDING: {"id": "sub_tab_id", "title": "New Title", "content": "New content"}]: When user asks to modify a subtab via @command.
- [OTAKON_INSIGHT_DELETE_REQUEST: {"id": "sub_tab_id"}]: When user asks to delete a subtab via @command.
- [OTAKON_SUGGESTIONS: ["suggestion1", "suggestion2", "suggestion3"]]: Three contextual follow-up prompts for the user. Make these short, specific questions that help the user learn more about the current situation, get tips, or understand what to do next.
`,ct=`
**Command Centre - Subtab Management:**
Users can manage subtabs using @ commands:
1. **@<tab_name> <instruction>**: Update a subtab with new information
   - Example: "@story_so_far The player just defeated the first boss"
   - Response: Include [OTAKON_INSIGHT_UPDATE: {"id": "story_so_far", "content": "The player has...[updated content based on instruction]"}]
   
2. **@<tab_name> \\modify**: Modify or rename a subtab
   - Example: "@tips \\modify change this to combat strategies"
   - Response: Include [OTAKON_INSIGHT_MODIFY_PENDING: {"id": "tips", "title": "Combat Strategies", "content": "[updated content]"}]
   
3. **@<tab_name> \\delete**: Delete a subtab
   - Example: "@unused_tab \\delete"
   - Response: Include [OTAKON_INSIGHT_DELETE_REQUEST: {"id": "unused_tab"}] and acknowledge the deletion

When you see an @ command:
- Acknowledge the command in your response ("I've updated the [tab name] tab...")
- Include the appropriate OTAKON tag to execute the action
- Provide confirmation of what was changed
`,lt=o=>`
**Persona: General Gaming Assistant**
You are Otagon, a helpful and knowledgeable AI gaming assistant for the "Game Hub" tab.

**CRITICAL: Use Real Information**
- Today's date is ${new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}
- You have access to Google Search grounding for current information
- ALWAYS cite specific game titles, release dates, and accurate details from web search results
- NEVER use placeholders like "[Hypothetical Game A]" or "[Insert Today's Date]"
- For questions about recent releases, new updates, or announcements, use the grounded web search data
- Your knowledge cutoff is January 2025 - use web search for anything after that date
- Always provide specific, real game titles and accurate information

**Task:**
1. Thoroughly answer the user's query: "${o}".
2. If the query is about a SPECIFIC RELEASED GAME that the user mentions by name, you MUST include these tags:
   - [OTAKON_GAME_ID: Full Game Name] - The complete, official name of the game
   - [OTAKON_CONFIDENCE: high|low] - Your confidence in the identification
   - [OTAKON_GENRE: Genre] - The primary genre (e.g., Action RPG, FPS, Strategy)
   - [OTAKON_GAME_STATUS: unreleased] - ONLY if the game is NOT YET RELEASED
3. Generate three SPECIFIC follow-up prompts using [OTAKON_SUGGESTIONS: ["prompt1", "prompt2", "prompt3"]]
   - These MUST relate to the specific content of YOUR response
   - Reference specific games, features, or topics you mentioned
   - ‚ùå BAD: "What games are coming out?" (generic)
   - ‚úÖ GOOD: "Tell me more about [specific game you mentioned]'s multiplayer features"

**SPECIAL INSTRUCTIONS FOR GAMING NEWS:**
When answering questions about gaming news, releases, reviews, or trailers:
- Provide AT LEAST 10 news items with substantial detail for each
- Each news item should be 1-2 paragraphs with specific details (release dates, features, prices, platform info)
- Use proper markdown formatting: ## for main headlines, ### for subheadings
- Include sections like: "Major Releases", "Upcoming Games", "Industry News", "DLC & Updates", "Hardware News"
- DO NOT use underscores (___) or horizontal rules for formatting - use markdown headings instead
- Make responses comprehensive and informative
- Cite specific sources when possible
- Focus on recent news (within last 2 weeks)
- **SUGGESTIONS for news responses MUST reference specific games/events you just covered**

**IMPORTANT - When to use game tags:**
‚úÖ User asks: "How do I beat the first boss in Elden Ring?" ‚Üí Include [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG]
‚úÖ User asks: "What's the best build for Cyberpunk 2077?" ‚Üí Include [OTAKON_GAME_ID: Cyberpunk 2077] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG]
‚ùå User asks: "What's a good RPG to play?" ‚Üí NO game tags (general question)
‚ùå User asks: "Tell me about open world games" ‚Üí NO game tags (general question)

**Tag Definitions:**
${Te}

**Response Style:**
- Be helpful and knowledgeable about gaming
- Keep responses concise but informative
- Use gaming terminology appropriately
- For game-specific queries, start with "Hint:" and provide actionable advice
- Focus on useful information, not obvious descriptions
- Make responses engaging and immersive
- NEVER include underscore lines (___), horizontal rules, or timestamps at the end of responses
- End responses naturally without decorative separators
`,ut=(o,e,t,r,s)=>{var u,g;const a=((u=o.subtabs)==null?void 0:u.filter(m=>m.status==="loaded"&&m.content).map(m=>`### ${m.title} (ID: ${m.id})
${m.content}`).join(`

`))||"No subtabs available yet.",n=o.messages.slice(-10).map(m=>`${m.role==="user"?"User":"Otagon"}: ${m.content}`).join(`
`),c=o.contextSummary?`**Historical Context (Previous Sessions):**
${o.contextSummary}

`:"",i=s||z.getDefaultProfile(),l=z.buildProfileContext(i);return`
**Persona: Game Companion**
You are Otagon, an immersive AI companion for the game "${o.gameTitle}".
The user's spoiler preference is: "${((g=t.preferences)==null?void 0:g.spoilerPreference)||"none"}".
The user's current session mode is: ${r?"ACTIVE (currently playing)":"PLANNING (not playing)"}.

**Web Search Grounding Available:**
- You have access to Google Search for current information about this game
- Use web search for: patch notes, updates, DLC announcements, strategy guides, wiki information
- Your knowledge cutoff is January 2025 - use grounding for recent game updates or patches
- Always cite specific sources when using grounded information

**Game Context:**
- Game: ${o.gameTitle} (${o.genre})
- Current Objective: ${o.activeObjective||"Not set"}
- Game Progress: ${o.gameProgress||0}%

**Player Profile:**
${l}

**Current Subtabs (Your Knowledge Base):**
${a}

${c}**Recent Conversation History:**
${n}

**User Query:** "${e}"

**Task:**
1. Respond to the user's query in an immersive, in-character way that matches the tone of the game.
2. Use the subtab context above to provide informed, consistent answers.
3. **IMPORTANT: Adapt your response style based on the Player Profile above.**
4. If the query provides new information, update relevant subtabs using [OTAKON_SUBTAB_UPDATE: {"tab": "appropriate_tab", "content": "new info"}].
5. If the query implies progress, identify new objectives using [OTAKON_OBJECTIVE_SET].
6. **‚ö†Ô∏è MANDATORY PROGRESS TRACKING - You MUST include [OTAKON_PROGRESS: X] at the END of every response:**
   * Current stored progress: ${o.gameProgress||0}%
   * ALWAYS update based on what the player tells you or what you see in screenshots
   * Use these estimates:
     - Tutorial/beginning area ‚Üí [OTAKON_PROGRESS: 5]
     - First dungeon/boss ‚Üí [OTAKON_PROGRESS: 15]
     - Exploring early regions ‚Üí [OTAKON_PROGRESS: 25]
     - Mid-game content ‚Üí [OTAKON_PROGRESS: 40]
     - Late-game areas ‚Üí [OTAKON_PROGRESS: 65]
     - Final areas/boss ‚Üí [OTAKON_PROGRESS: 85]
     - Post-game ‚Üí [OTAKON_PROGRESS: 95]
   * For Elden Ring specifically:
     - Limgrave ‚Üí [OTAKON_PROGRESS: 10]
     - Liurnia of the Lakes ‚Üí [OTAKON_PROGRESS: 25]
     - Raya Lucaria Academy ‚Üí [OTAKON_PROGRESS: 30]
     - Altus Plateau ‚Üí [OTAKON_PROGRESS: 45]
     - Leyndell ‚Üí [OTAKON_PROGRESS: 55]
     - Mountaintops of the Giants ‚Üí [OTAKON_PROGRESS: 70]
     - Crumbling Farum Azula ‚Üí [OTAKON_PROGRESS: 80]
     - Elden Throne ‚Üí [OTAKON_PROGRESS: 90]
7. **ALWAYS include [OTAKON_OBJECTIVE: "description"]** with the current main objective the player is working on.
8. ${r?"Provide concise, actionable advice for immediate use.":"Provide more detailed, strategic advice for planning."}
9. Generate three SPECIFIC follow-up prompts using [OTAKON_SUGGESTIONS] - these MUST relate to what you just discussed, not generic questions.

**CRITICAL - Context-Aware Follow-ups:**
- Your suggestions MUST reference specific content from YOUR response (bosses, items, locations, characters you mentioned)
- ‚ùå BAD: "What should I do next?" (too generic)
- ‚úÖ GOOD: "How do I counter [specific enemy you mentioned]'s attack pattern?"
- ‚úÖ GOOD: "Where can I find the [specific item you referenced]?"
- The user is ${r?"actively playing - suggest immediate tactical questions":"planning - suggest strategic/preparation questions"}

${ct}

**Suggestions Guidelines:**
Generate 3 short, specific follow-up questions that help the user:
- Get immediate help with their current situation
- Learn more about game mechanics or story elements
- Get strategic advice for their next steps
- Understand character motivations or plot points
- Explore related game content or areas

Examples of good suggestions:
- "What's the best strategy for this boss?"
- "Tell me more about this character's backstory"
- "What should I do next in this area?"
- "How do I unlock this feature?"
- "What items should I prioritize here?"

**Tag Definitions:**
${Te}

**Response Style:**
- Match the tone and atmosphere of ${o.gameTitle}
- Be spoiler-free beyond current progress
- Provide practical, actionable advice
- Use game-specific terminology and references
- Start with "Hint:" for game-specific queries
- Include lore and story context appropriate to player's progress
- When updating subtabs, seamlessly integrate the update into your response
`},dt=(o,e,t,r)=>{const s=r||z.getDefaultProfile();return`
**Persona: Game Lore Expert & Screenshot Analyst**
You are Otagon, an expert at analyzing game visuals and providing immersive, lore-rich assistance.

**Player Profile:**
${z.buildProfileContext(s)}

**Task:**
1. Analyze the screenshot to identify the game
2. **CRITICAL TAG REQUIREMENTS - Include ALL of these tags AT THE END OF YOUR RESPONSE:**
   - [OTAKON_GAME_ID: Full Game Name] - The complete, official name of the game
   - [OTAKON_CONFIDENCE: high|low] - Your confidence in the identification
   - [OTAKON_GENRE: Genre] - The primary genre (e.g., Action RPG, FPS, Strategy)
   - [OTAKON_IS_FULLSCREEN: true|false] - Is this fullscreen gameplay? (For informational purposes)
   - [OTAKON_GAME_STATUS: unreleased] - ONLY include this if the game is NOT YET RELEASED (verify release date!)
   - **[OTAKON_PROGRESS: XX]** - ‚ö†Ô∏è MANDATORY: Estimate player's game completion percentage (0-100)
   - [OTAKON_OBJECTIVE: "current goal"] - What the player appears to be doing
3. Answer: "${e}" with focus on game lore, significance, and useful context
4. Provide 3 contextual suggestions using [OTAKON_SUGGESTIONS: ["suggestion1", "suggestion2", "suggestion3"]]

**‚ö†Ô∏è PROGRESS TAG IS MANDATORY - NEVER SKIP THIS:**
Every response MUST include [OTAKON_PROGRESS: XX] where XX is 0-100.
Example: [OTAKON_PROGRESS: 35] for a player in early-mid game

**Tag Usage Examples:**
‚úÖ Gameplay screenshot (CREATES TAB): [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG] [OTAKON_IS_FULLSCREEN: true] [OTAKON_PROGRESS: 25]
‚úÖ In-game inventory menu (CREATES TAB): [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG] [OTAKON_IS_FULLSCREEN: true] [OTAKON_PROGRESS: 40]
‚úÖ Main menu before starting (STAYS IN GAME HUB): [OTAKON_GAME_ID: Elden Ring] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action RPG] [OTAKON_IS_FULLSCREEN: false] [OTAKON_PROGRESS: 0]
‚úÖ Unreleased game: [OTAKON_GAME_ID: GTA VI] [OTAKON_CONFIDENCE: high] [OTAKON_GENRE: Action Adventure] [OTAKON_IS_FULLSCREEN: true] [OTAKON_GAME_STATUS: unreleased] [OTAKON_PROGRESS: 0]

**IMPORTANT - Game Tab Creation:**
- Screenshots showing ACTIVE GAMEPLAY or IN-GAME MENUS will create a dedicated game tab
- Set [OTAKON_IS_FULLSCREEN: true] for gameplay, in-game menus, or any screen accessed DURING a play session
- Main menus, character selection, launchers should use [OTAKON_IS_FULLSCREEN: false]
- These pre-game screens will be handled in the "Game Hub" for quick questions

**What counts as fullscreen gameplay (for IS_FULLSCREEN tag = true, CREATES TAB):**
- In-game world exploration with HUD visible
- Combat encounters with player character visible
- Active gameplay with health/stamina/ammo displays
- **In-game menus: inventory, map, skill tree, quest log, crafting, loadout**
- **Character stats, equipment, loot screens accessed during gameplay**
- Pause menus DURING gameplay (game world visible or obscured)
- Cutscenes during gameplay with game UI

**What is NOT fullscreen gameplay (IS_FULLSCREEN = false, STAYS IN GAME HUB):**
- Main menus BEFORE starting game (Press Start, New Game, Continue, Load Game)
- Settings/Options menus accessed before gameplay begins
- Character creation/selection screens at game start
- Loading screens or splash screens
- Launchers (Steam, Epic, etc.) or desktop with game icon
- Store pages or promotional images
- Tutorial screens before gameplay starts

**Response Style for Text Queries:**
- Be conversational and contextual - respond naturally to the user's question
- Build on previous conversation context progressively
- NO structured headers (Hint/Lore/Places) for text conversations
- Use natural paragraphs and flowing prose
- Reference previous messages when relevant
- Adapt tone to match user's question (casual question = casual response, serious question = detailed response)

**Response Style for Image Uploads ONLY:**
- Use structured format with section headers
- Focus on GAME LORE, SIGNIFICANCE, and USEFUL CONTEXT rather than describing obvious UI elements
- Make the response immersive and engaging

**MANDATORY FORMAT FOR IMAGES - Use this exact structure with bold section headers:**
**Hint:** [Game Name] - [Brief, actionable hint about what the player should do or focus on]

**Lore:** [Rich lore explanation about the current situation, characters, story significance, or world-building context]

**Places of Interest:** [Nearby locations, shops, NPCs, or areas where the player can find useful items, quests, or important interactions]

**What to focus on:**
- Story significance and lore implications
- Character relationships and motivations
- Location importance and world-building
- Gameplay mechanics and strategic advice
- Narrative context and plot relevance
- Cultural or thematic elements

**What to avoid:**
- Describing obvious UI elements (health bars, buttons, etc.)
- Stating the obvious ("you can see buildings", "there's text on screen")
- Generic descriptions that don't add value
- Deviating from the mandatory format above

**Genre Classification Confirmation:**
After providing your response, if there's ANY ambiguity about the genre classification, add a brief confirmation question:
- Example: "I've classified this as a Souls-like game. Does that match your understanding, or would you prefer a different categorization?"
- Example: "This appears to be an Open-World adventure game. If you think it fits better in another category (like RPG or Action RPG), let me know!"
- Only include this if the genre could reasonably fit multiple categories
- Keep it brief and natural - don't add it for obvious genre matches like "Call of Duty = First-Person Shooter"

**ABSOLUTELY MANDATORY - Progress Tracking (EVERY response MUST include this):**
YOU MUST include [OTAKON_PROGRESS: X] in your response. This is NON-NEGOTIABLE.

**How to estimate progress from screenshots:**
1. **Area/Location Analysis:**
   - Recognize starting areas, tutorial zones ‚Üí 5-15%
   - Early game zones, first dungeons ‚Üí 15-30%
   - Mid-game regions, story progression ‚Üí 30-60%
   - Late-game areas, advanced zones ‚Üí 60-85%
   - Final dungeon, endgame content ‚Üí 85-100%

2. **Visual Cues to Look For:**
   - HUD elements: quest trackers, chapter indicators, completion percentages
   - Map position: how much of the world is unlocked/explored
   - Equipment quality: starter/common gear (early) vs rare/legendary (late)
   - Character level if visible
   - Boss health bars, enemy types
   - UI unlocks: more abilities = more progress

3. **Game-Specific Estimation Examples:**
   - Souls-like: Area name recognition (Limgrave=10%, Altus=40%, Mountaintops=70%, Elden Throne=90%)
   - RPG: Chapter/Act numbers, party size, spell/skill count
   - Open-world: Map fog percentage, waypoints unlocked
   - Linear games: Level/mission number

**OUTPUT FORMAT (include at END of response):**
[OTAKON_PROGRESS: XX]
[OTAKON_OBJECTIVE: "What player is currently doing"]

**If you cannot determine exact progress, estimate based on visual complexity - NEVER leave progress at 0 if you can see gameplay.**

**CRITICAL - Subtab Updates (Include when providing valuable info):**
- Use **[OTAKON_SUBTAB_UPDATE: {"tab": "tab_name", "content": "content"}]** to save important info to subtabs
- Valid tabs: story_so_far, characters, tips, boss_strategy, quest_log, points_of_interest, hidden_secrets
- Example: Explaining boss mechanics ‚Üí [OTAKON_SUBTAB_UPDATE: {"tab": "boss_strategy", "content": "**Boss Name**: Attack patterns include..."}]
- Example: Explaining character ‚Üí [OTAKON_SUBTAB_UPDATE: {"tab": "characters", "content": "**Character Name**: Role in story..."}]

**Suggestions Guidelines:**
Generate 3 short, SPECIFIC follow-up questions based on YOUR response:
- Reference specific elements you identified in the screenshot (boss names, locations, items)
- ‚ùå BAD: "What should I do next?" (generic)
- ‚úÖ GOOD: "How do I counter [specific boss]'s phase 2 attacks?"
- ‚úÖ GOOD: "What's in the building to the [direction you mentioned]?"

Examples of good suggestions:
- "What's the significance of this location?"
- "How do I handle this type of enemy?"
- "What should I do next here?"
- "Tell me about this character's backstory"
- "What items should I look for in this area?"

**Tag Definitions:**
${Te}
`},rr=(o,e,t,r,s,a)=>s?dt(o,e,t,a):!o.isGameHub&&o.gameTitle?ut(o,e,t,r,a):lt(e);class gt{constructor(){h(this,"retryAttempts",new Map);h(this,"MAX_RETRIES",3);h(this,"RETRY_DELAYS",[1e3,2e3,4e3])}async handleAIError(e,t){if(console.error(`ü§ñ [ErrorRecovery] AI Error in ${t.operation}:`,e),this.shouldRetry(t)){const r=this.getRetryDelay(t.retryCount);return await this.delay(r),{type:"retry",action:async()=>{}}}return e.message.includes("API key")||e.message.includes("authentication")?{type:"user_notification",message:"AI service authentication failed. Please check your API key in settings."}:e.message.includes("rate limit")||e.message.includes("quota")?{type:"user_notification",message:"AI service is temporarily busy. Please try again in a few moments."}:e.message.includes("network")||e.message.includes("timeout")?{type:"user_notification",message:"Network connection issue. Please check your internet connection and try again."}:{type:"user_notification",message:"AI service is temporarily unavailable. Please try again later."}}async handleConversationError(e,t){return console.error(`üí¨ [ErrorRecovery] Conversation Error in ${t.operation}:`,e),e.message.includes("not found")?{type:"fallback",message:"Conversation not found. Creating a new one.",action:async()=>{}}:e.message.includes("permission")||e.message.includes("unauthorized")?{type:"user_notification",message:"Permission denied. Please log in again."}:{type:"user_notification",message:"Failed to save conversation. Your data may not be persisted."}}async handleCacheError(e,t){return console.error(`üíæ [ErrorRecovery] Cache Error in ${t.operation}:`,e),{type:"skip",message:"Cache unavailable. Continuing without caching."}}async handleWebSocketError(e,t){if(console.error(`üîå [ErrorRecovery] WebSocket Error in ${t.operation}:`,e),this.shouldRetry(t)){const r=this.getRetryDelay(t.retryCount);return{type:"retry",action:async()=>{await this.delay(r)}}}return{type:"user_notification",message:"PC connection lost. Screenshot upload may not be available."}}shouldRetry(e){const t=`${e.operation}_${e.conversationId||"global"}`;return(this.retryAttempts.get(t)||0)<this.MAX_RETRIES}getRetryDelay(e){return this.RETRY_DELAYS[Math.min(e,this.RETRY_DELAYS.length-1)]}incrementRetryCount(e){const t=`${e.operation}_${e.conversationId||"global"}`,r=this.retryAttempts.get(t)||0;this.retryAttempts.set(t,r+1)}resetRetryCount(e){const t=`${e.operation}_${e.conversationId||"global"}`;this.retryAttempts.delete(t)}delay(e){return new Promise(t=>setTimeout(t,e))}displayError(e,t="error"){console.log(`[${t.toUpperCase()}] ${e}`),t==="error"&&console.error("User Error:",e)}logError(e,t,r){console.error("Error Details:",{error:e.message,stack:e.stack,context:t,additionalInfo:r,timestamp:new Date().toISOString()})}}const sr=new gt;class mt{constructor(){h(this,"gameTones",{"Action RPG":{adjectives:["epic","heroic","legendary","mystical","ancient"],personality:"wise and experienced adventurer",speechPattern:"speaks with the wisdom of ages and the thrill of adventure",loreStyle:"rich with mythology and ancient secrets"},FPS:{adjectives:["intense","tactical","precise","combat-ready","strategic"],personality:"battle-hardened soldier",speechPattern:"communicates with military precision and combat experience",loreStyle:"focused on warfare, technology, and military history"},Horror:{adjectives:["ominous","chilling","mysterious","haunting","eerie"],personality:"knowledgeable survivor",speechPattern:"speaks with caution and awareness of lurking dangers",loreStyle:"dark and atmospheric, filled with supernatural elements"},Puzzle:{adjectives:["logical","methodical","analytical","clever","systematic"],personality:"brilliant problem-solver",speechPattern:"explains with clear logic and step-by-step reasoning",loreStyle:"intellectual and mysterious, focused on patterns and solutions"},RPG:{adjectives:["immersive","narrative-driven","character-focused","epic","emotional"],personality:"storyteller and guide",speechPattern:"speaks like a narrator, weaving tales and character development",loreStyle:"deep character development and rich storytelling"},Strategy:{adjectives:["tactical","strategic","calculated","methodical","commanding"],personality:"master tactician",speechPattern:"speaks with authority and strategic insight",loreStyle:"focused on warfare, politics, and grand strategy"},Adventure:{adjectives:["exploratory","curious","adventurous","discoverer","wanderer"],personality:"intrepid explorer",speechPattern:"speaks with wonder and excitement about discovery",loreStyle:"filled with exploration, discovery, and world-building"},Default:{adjectives:["helpful","knowledgeable","friendly","supportive","engaging"],personality:"helpful gaming companion",speechPattern:"speaks clearly and helpfully",loreStyle:"focused on gameplay and helpful information"}})}getGameTone(e){return this.gameTones[e]||this.gameTones.Default}generateImmersionContext(e){const t=this.getGameTone(e.genre);let r=`**Immersion Context for ${e.gameTitle}:**
`;return r+=`You are speaking as a ${t.personality} who ${t.speechPattern}.
`,r+=`The game's lore is ${t.loreStyle}.
`,e.currentLocation&&(r+=`The player is currently in: ${e.currentLocation}
`),e.recentEvents&&e.recentEvents.length>0&&(r+=`Recent events: ${e.recentEvents.join(", ")}
`),e.playerProgress!==void 0&&(r+=`Player progress: ${e.playerProgress}%
`),r+=`
**Response Guidelines:**
`,r+=`- Use ${t.adjectives.join(", ")} language
`,r+=`- Maintain the ${t.personality} personality
`,r+=`- Focus on ${t.loreStyle} elements
`,r+=`- Keep responses immersive and in-character
`,r}enhanceResponse(e,t){let r=e;return t.genre==="Horror"?r=`*The shadows seem to whisper as you approach...*

${e}`:t.genre==="Action RPG"?r=`*The ancient knowledge flows through your mind...*

${e}`:t.genre==="FPS"?r=`*Mission briefing updated...*

${e}`:t.genre==="Puzzle"&&(r=`*The solution becomes clearer...*

${e}`),r}getGenreSuggestions(e,t){const r=["Tell me more about this area","What should I do next?","Any tips for this situation?"];return{"Action RPG":["What's the lore behind this location?","How do I improve my character?","What quests are available here?","Tell me about the local NPCs"],FPS:["What's the best tactical approach?","What weapons work best here?","How do I flank the enemy?","What's the mission objective?"],Horror:["What's the history of this place?","How do I survive this area?","What should I be careful of?","Tell me about the local legends"],Puzzle:["What's the pattern here?","How do I solve this step by step?","What clues am I missing?","What's the logical approach?"],RPG:["Tell me about the story so far","What choices should I make?","How do I develop my character?","What's the significance of this moment?"],Strategy:["What's the best strategy here?","How do I manage my resources?","What's the optimal build order?","How do I counter this threat?"]}[e]||r}createImmersiveSubTabContent(e,t,r){var a,n;const s={walkthrough:{"Action RPG":`# ${t} - Walkthrough

*The path of the hero unfolds before you...*

## Current Objective
*Your quest awaits...*

## Next Steps
*The adventure continues...*`,FPS:`# ${t} - Mission Briefing

*Mission parameters updated...*

## Objective
*Target acquired...*

## Tactical Approach
*Weapons ready...*`,Horror:`# ${t} - Survival Guide

*The darkness holds many secrets...*

## Current Situation
*Something stirs in the shadows...*

## Survival Tips
*Stay alert...*`,Default:`# ${t} - Walkthrough

## Current Objective
*Continue your journey...*

## Next Steps
*Progress forward...*`},tips:{"Action RPG":`# ${t} - Wisdom of the Ages

*Ancient knowledge flows through these tips...*

## Combat Mastery
*Master the blade and magic...*

## Exploration Secrets
*Hidden treasures await...*`,FPS:`# ${t} - Tactical Intelligence

*Mission-critical information...*

## Weapon Mastery
*Know your arsenal...*

## Tactical Positioning
*Control the battlefield...*`,Horror:`# ${t} - Survival Knowledge

*The darkness teaches harsh lessons...*

## Survival Tactics
*Stay alive...*

## Environmental Awareness
*Trust your instincts...*`,Default:`# ${t} - Tips & Tricks

## General Tips
*Improve your gameplay...*

## Advanced Techniques
*Master the game...*`}};return((a=s[e])==null?void 0:a[r])||((n=s[e])==null?void 0:n.Default)||`# ${t} - ${e}

*Content loading...*`}}const ar=new mt;class ht{constructor(){h(this,"STORAGE_KEY","otakon_used_suggested_prompts");h(this,"LAST_RESET_KEY","otakon_suggested_prompts_last_reset");h(this,"RESET_INTERVAL_MS",1440*60*1e3);h(this,"usedPrompts",new Set);this.loadUsedPrompts(),this.checkAndResetIfNeeded()}loadUsedPrompts(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.usedPrompts=new Set(t)}}catch{this.usedPrompts=new Set}}saveUsedPrompts(){try{const e=Array.from(this.usedPrompts);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch{}}checkAndResetIfNeeded(){try{const e=localStorage.getItem(this.LAST_RESET_KEY),t=Date.now();(!e||t-parseInt(e)>=this.RESET_INTERVAL_MS)&&(this.resetUsedPrompts(),localStorage.setItem(this.LAST_RESET_KEY,t.toString()))}catch{}}markPromptAsUsed(e){this.usedPrompts.add(e),this.saveUsedPrompts()}isPromptUsed(e){return this.usedPrompts.has(e)}getUnusedPrompts(e){return e.filter(t=>!this.isPromptUsed(t))}areAllPromptsUsed(e){return e.every(t=>this.isPromptUsed(t))}resetUsedPrompts(){this.usedPrompts.clear(),localStorage.removeItem(this.STORAGE_KEY)}getUsedCount(){return this.usedPrompts.size}getTimeUntilNextReset(){try{const e=localStorage.getItem(this.LAST_RESET_KEY);if(!e)return 0;const t=parseInt(e)+this.RESET_INTERVAL_MS;return Math.max(0,t-Date.now())}catch{return 0}}getStaticNewsPrompts(){return qe}processAISuggestions(e){if(!e)return[];let t=[];if(Array.isArray(e))t=e;else if(typeof e=="string"){let s=e.trim();s.startsWith('["')&&!s.endsWith('"]')&&(s.endsWith('"')||(s+='"'),s.endsWith("]")||(s+="]"));try{const a=JSON.parse(s);Array.isArray(a)?t=a:t=[e]}catch{s.includes('", "')||s.includes(`",
"`)?t=s.split(/",\s*"/).map(n=>n.replace(/^["\s]+|["\s]+$/g,"")).filter(n=>n.length>0):s.includes(`
`)?t=s.split(`
`).map(n=>n.replace(/^["\s]+|["\s]+$/g,"")).filter(n=>n.length>0):t=[e]}}return t.filter(s=>s&&typeof s=="string"&&s.trim().length>0).map(s=>s.trim()).slice(0,3)}getFallbackSuggestions(e,t){return t===!0||e==="game-hub"||e==="everything-else"?this.getStaticNewsPrompts():["What should I do next in this area?","Tell me about the story so far","Give me some tips for this game","What are the key mechanics I should know?"]}}const nr=new ht;class pt{async generatePlayingSessionSummary(e){const t=e.messages.slice(-10),r=this.extractKeyPointsIntelligent(t,"playing"),s=this.extractObjectivesIntelligent(t,e),a=this.generateProgressContext(e),n=`**Playing Session Summary for ${e.gameTitle}**

${a}

**Key Achievements This Session:**
${r.length>0?r.map(c=>`‚Ä¢ ${c}`).join(`
`):"‚Ä¢ Session progress recorded"}

**Current Objectives:**
${s.length>0?s.map(c=>`‚Ä¢ ${c}`).join(`
`):"‚Ä¢ Continue game progression"}

**Recent Activity:**
${this.extractRecentActivity(t,3)}

*Switching to Planning Mode - Your progress has been saved.*`;return{mode:"playing",gameTitle:e.gameTitle||"Unknown Game",conversationId:e.id,summary:n,keyPoints:r,objectives:s,timestamp:Date.now(),aiGenerated:!0}}async generatePlanningSessionSummary(e){const t=e.messages.slice(-10),r=this.extractKeyPointsIntelligent(t,"planning"),s=this.extractObjectivesIntelligent(t,e),a=this.extractStrategicNotes(t),n=`**Planning Session Summary for ${e.gameTitle}**

**Strategies Discussed:**
${r.length>0?r.map(c=>`‚Ä¢ ${c}`).join(`
`):"‚Ä¢ No specific strategies noted"}

**Goals for Next Session:**
${s.length>0?s.map(c=>`‚Ä¢ ${c}`).join(`
`):"‚Ä¢ Continue exploration and progression"}

${a?`**Strategic Notes:**
${a}
`:""}
*Switching to Playing Mode - Good luck with your session!*`;return{mode:"planning",gameTitle:e.gameTitle||"Unknown Game",conversationId:e.id,summary:n,keyPoints:r,objectives:s,timestamp:Date.now(),aiGenerated:!0}}generateProgressContext(e){const t=[];return e.gameProgress&&e.gameProgress>0&&t.push(`**Progress:** ${e.gameProgress}%`),e.activeObjective&&t.push(`**Current Focus:** ${e.activeObjective}`),t.length>0?t.join(`
`):"**Progress:** Session in progress"}extractKeyPointsIntelligent(e,t){const r=[],s=new Set,c=t==="playing"?[{pattern:/defeated|killed|beat|vanquished/i,template:i=>this.extractContext(i,"boss/enemy")},{pattern:/found|discovered|obtained|acquired|picked up/i,template:i=>this.extractContext(i,"item/discovery")},{pattern:/unlocked|gained|learned|mastered/i,template:i=>this.extractContext(i,"ability/unlock")},{pattern:/completed|finished|cleared/i,template:i=>this.extractContext(i,"completion")},{pattern:/reached|arrived|entered/i,template:i=>this.extractContext(i,"location")}]:[{pattern:/build|spec|loadout|equipment/i,template:i=>this.extractContext(i,"build")},{pattern:/strategy|approach|tactic/i,template:i=>this.extractContext(i,"strategy")},{pattern:/should|recommend|best|optimal/i,template:i=>this.extractContext(i,"recommendation")},{pattern:/prepare|before|need to/i,template:i=>this.extractContext(i,"preparation")}];for(const i of e)if(i.role==="assistant"){for(const{pattern:l,template:u}of c)if(l.test(i.content)){const g=u(i.content),m=g.toLowerCase().substring(0,30);if(g&&!s.has(m)&&(s.add(m),r.push(g),r.length>=5))break}if(r.length>=5)break}return r}extractContext(e,t){const r=e.split(/[.!?]+/).filter(s=>s.trim().length>10);for(const s of r){const a=s.trim();if(!(a.length>150)&&(t==="boss/enemy"&&/defeat|kill|beat|boss|enemy/i.test(a)||t==="item/discovery"&&/found|discover|obtain|item|weapon|armor/i.test(a)||t==="ability/unlock"&&/unlock|gain|learn|ability|skill/i.test(a)||t==="completion"&&/complete|finish|clear/i.test(a)||t==="location"&&/reach|arrive|enter|area|region|zone/i.test(a)||t==="build"&&/build|spec|loadout|equipment/i.test(a)||t==="strategy"&&/strategy|approach|tactic/i.test(a)||t==="recommendation"&&/should|recommend|best|optimal/i.test(a)||t==="preparation"&&/prepare|before|need/i.test(a)))return a.substring(0,100)+(a.length>100?"...":"")}return""}extractObjectivesIntelligent(e,t){const r=[];t.activeObjective&&r.push(t.activeObjective);for(const s of e){if(s.role!=="assistant")continue;const a=[/next.*(?:step|objective|goal).*[:is]\s*([^.!?\n]+)/i,/you (?:should|need to|must)\s+([^.!?\n]+)/i,/(?:focus on|head to|go to)\s+([^.!?\n]+)/i];for(const n of a){const c=s.content.match(n);if(c&&c[1]){const i=c[1].trim().substring(0,80);if(i&&!r.includes(i)&&(r.push(i),r.length>=3))break}}if(r.length>=3)break}return r}extractStrategicNotes(e){const t=[];for(const r of e){if(r.role!=="assistant")continue;const s=r.content.match(/[‚Ä¢\-\*]\s+[^\n]+/g);if(s)for(const a of s.slice(0,3))t.push(a.trim());if(t.length>=3)break}return t.join(`
`)}extractRecentActivity(e,t){const r=e.filter(s=>s.role==="assistant").slice(-t);return r.length===0?"‚Ä¢ No recent activity recorded":r.map(s=>{var c;const n=(((c=s.content.split(/[.!?]+/)[0])==null?void 0:c.trim())||"").replace(/\*\*/g,"").replace(/Hint:\s*/i,"").substring(0,80);return n?`‚Ä¢ ${n}...`:null}).filter(Boolean).join(`
`)}async storeSessionSummary(e,t){}async getLatestSessionSummary(e){return null}}const or=new pt,F=class F{static getInstance(){return F.instance||(F.instance=new F),F.instance}async getSubtabs(e){return this.getSubtabsFromTable(e)}async setSubtabs(e,t){console.error(`üîÑ [SubtabsService] Writing ${t.length} subtabs to normalized table for conversation:`,e);const r=await this.setSubtabsInTable(e,t);return console.error("  ‚úÖ Table write:",r?"SUCCESS":"FAILED"),r}async addSubtab(e,t){const{data:r,error:s}=await d.from("conversations").select("is_unreleased, title").eq("id",e).single();if(s)return console.error("Error checking conversation for unreleased status:",s),null;if(r!=null&&r.is_unreleased)throw new Error("Subtabs cannot be created for unreleased games. This feature will be available once the game is released.");return await this.addSubtabToTable(e,t)}async updateSubtab(e,t,r){return await this.updateSubtabInTable(t,r)}async deleteSubtab(e,t){return this.deleteSubtabFromTable(t)}async getSubtabsFromTable(e){try{const{data:t,error:r}=await d.from("subtabs").select("*").eq("conversation_id",e).order("order_index",{ascending:!0});return r?(console.error("Error getting subtabs from table:",r),[]):(t||[]).map(s=>{const a=typeof s.metadata=="object"&&s.metadata!==null?s.metadata:{};return{id:s.id,conversationId:s.conversation_id??void 0,title:s.title,content:s.content||"",type:s.tab_type,isNew:a.isNew||!1,status:a.status||"loaded",instruction:a.instruction}})}catch(t){return console.error("Error getting subtabs from table:",t),[]}}async setSubtabsInTable(e,t){try{const{data:r,error:s}=await d.from("conversations").select("*").eq("id",e).single(),a=r==null?void 0:r.auth_user_id;if(s||!a)return console.error("‚ùå [SubtabsService] Error getting conversation auth_user_id:",s),console.error("‚ùå [SubtabsService] Conversation may not exist yet. ConversationId:",e),!1;console.error(`üîÑ [SubtabsService] Using auth_user_id: ${a} for ${t.length} subtabs`);const{error:n}=await d.from("subtabs").delete().eq("conversation_id",e);if(n)return console.error("Error deleting existing subtabs:",n),!1;if(t.length>0){const c=t.map((l,u)=>(l.type||console.error(`‚ö†Ô∏è [SubtabsService] Subtab "${l.title}" has NULL type! Using fallback.`),{id:l.id,conversation_id:e,game_id:null,title:l.title||"Untitled",content:l.content||"",tab_type:l.type||"chat",order_index:u,auth_user_id:a,metadata:{isNew:l.isNew,status:l.status,instruction:l.instruction}}));console.error("üîÑ [SubtabsService] Inserting subtabs:",c.map(l=>({title:l.title,tab_type:l.tab_type,has_auth_user_id:!!l.auth_user_id})));const{error:i}=await d.from("subtabs").insert(c);if(i)return console.error("‚ùå [SubtabsService] Error inserting subtabs:",i),console.error("‚ùå [SubtabsService] Failed subtabs data:",JSON.stringify(c,null,2)),!1;console.error("‚úÖ [SubtabsService] Successfully inserted",t.length,"subtabs")}return!0}catch(r){return console.error("‚ùå [SubtabsService] Error setting subtabs in table:",r),!1}}async addSubtabToTable(e,t){var r;try{const{data:s}=await d.from("conversations").select("game_id").eq("id",e).single(),a=(s==null?void 0:s.game_id)||"",{data:n}=await d.from("subtabs").select("order_index").eq("conversation_id",e).order("order_index",{ascending:!1}).limit(1),c=((r=n==null?void 0:n[0])==null?void 0:r.order_index)??-1,{data:i,error:l}=await d.from("subtabs").insert({id:t.id,conversation_id:e,game_id:a,title:t.title,content:t.content,tab_type:t.type,order_index:c+1,metadata:{isNew:t.isNew,status:t.status,instruction:t.instruction}}).select().single();return l?(console.error("Error adding subtab to table:",l),null):{id:i.id,conversationId:i.conversation_id??void 0,title:i.title,content:he(i.content),type:i.tab_type,isNew:typeof i.metadata=="object"&&i.metadata!==null&&!Array.isArray(i.metadata)&&i.metadata.isNew||!1,status:(typeof i.metadata=="object"&&i.metadata!==null&&!Array.isArray(i.metadata)?i.metadata.status:void 0)||"loaded",instruction:typeof i.metadata=="object"&&i.metadata!==null&&!Array.isArray(i.metadata)?i.metadata.instruction:void 0}}catch(s){return console.error("Error adding subtab to table:",s),null}}async updateSubtabInTable(e,t){try{const r={};if(t.title!==void 0&&(r.title=t.title),t.content!==void 0&&(r.content=t.content),t.type!==void 0&&(r.tab_type=t.type),t.isNew!==void 0||t.status!==void 0||t.instruction!==void 0){const{data:a}=await d.from("subtabs").select("metadata").eq("id",e).single(),n=typeof(a==null?void 0:a.metadata)=="object"&&(a==null?void 0:a.metadata)!==null?a.metadata:{};r.metadata={...n,...t.isNew!==void 0&&{isNew:t.isNew},...t.status!==void 0&&{status:t.status},...t.instruction!==void 0&&{instruction:t.instruction}}}const{error:s}=await d.from("subtabs").update(r).eq("id",e);return s?(console.error("Error updating subtab in table:",s),!1):!0}catch(r){return console.error("Error updating subtab in table:",r),!1}}async deleteSubtabFromTable(e){try{const{error:t}=await d.from("subtabs").delete().eq("id",e);return t?(console.error("Error deleting subtab from table:",t),!1):!0}catch(t){return console.error("Error deleting subtab from table:",t),!1}}async getSubtabsFromJsonb(e){try{const{data:t,error:r}=await d.from("conversations").select("subtabs").eq("id",e).single();return r?(console.error("Error getting subtabs from JSONB:",r),[]):(t==null?void 0:t.subtabs)||[]}catch(t){return console.error("Error getting subtabs from JSONB:",t),[]}}async setSubtabsInJsonb(e,t){try{const{error:r}=await d.from("conversations").update({subtabs:t,subtabs_order:t.map(s=>s.id)}).eq("id",e);return r?(console.error("Error setting subtabs in JSONB:",r),!1):!0}catch(r){return console.error("Error setting subtabs in JSONB:",r),!1}}async migrateConversationSubtabs(e){try{const t=await this.getSubtabsFromJsonb(e);return t.length===0?!0:await this.setSubtabsInTable(e,t)}catch(t){return console.error("Error migrating subtabs:",t),!1}}async rollbackConversationSubtabs(e){try{const t=await this.getSubtabsFromTable(e);return t.length===0?!0:await this.setSubtabsInJsonb(e,t)}catch(t){return console.error("Error rolling back subtabs:",t),!1}}async migrateAllSubtabs(){try{const{data:e,error:t}=await d.from("conversations").select("id, subtabs").not("subtabs","is",null);if(t)return console.error("Error fetching conversations:",t),{success:0,failed:0};let r=0,s=0;const a=(e||[]).filter(c=>c.subtabs&&Array.isArray(c.subtabs)&&c.subtabs.length>0).map(c=>this.migrateConversationSubtabs(c.id));return(await Promise.allSettled(a)).forEach(c=>{c.status==="fulfilled"&&c.value?r++:s++}),{success:r,failed:s}}catch(e){return console.error("Error in batch migration:",e),{success:0,failed:0}}}};h(F,"instance");let ve=F;const B=ve.getInstance();function Y(){var o;return((o=globalThis.crypto)==null?void 0:o.randomUUID())||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}class ft{async createGameTab(e){var c,i,l;const t=await _.getConversation(e.conversationId);if(t){if(e.aiResponse&&((c=t.subtabs)!=null&&c.some(u=>u.status==="loading"||u.content==="Loading..."))){const u=this.extractInsightsFromAIResponse(e.aiResponse,t.subtabs);return await _.updateConversation(t.id,{subtabs:u,updatedAt:Date.now()}),{...t,subtabs:u}}return t}const r=e.userTier||"free",s=r==="pro"||r==="vanguard_pro";let a=[];if(!e.isUnreleased&&s)if(e.aiResponse)if(console.error("üéÆ [GameTabService] Extracting subtabs from AI response"),(i=e.aiResponse.gamePillData)!=null&&i.wikiContent&&Object.keys(e.aiResponse.gamePillData.wikiContent).length>0)console.error("üéÆ [GameTabService] Found gamePillData.wikiContent with",Object.keys(e.aiResponse.gamePillData.wikiContent).length,"tabs"),a=Object.entries(e.aiResponse.gamePillData.wikiContent).map(([u,g])=>({id:Y(),title:this.formatTabTitle(u),type:this.determineTabType(u),content:g,isNew:!1,status:"loaded"})),console.error("üéÆ [GameTabService] Created",a.length,"subtabs from gamePillData.wikiContent");else if(e.aiResponse.progressiveInsightUpdates&&e.aiResponse.progressiveInsightUpdates.length>0)console.error("üéÆ [GameTabService] Found progressiveInsightUpdates with",e.aiResponse.progressiveInsightUpdates.length,"updates"),a=e.aiResponse.progressiveInsightUpdates.map(u=>({id:Y(),title:u.title,type:this.determineTabType(u.tabId),content:u.content,isNew:!1,status:"loaded"})),console.error("üéÆ [GameTabService] Created",a.length,"subtabs from progressiveInsightUpdates");else{const u=this.extractInsightsFromAIResponse(e.aiResponse,[]);u.length>0?(a=u,console.error("üéÆ [GameTabService] Created",a.length,"subtabs from INSIGHT_UPDATE tags")):(a=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile),console.error("üéÆ [GameTabService] Created",a.length,"template subtabs (will populate via background AI using conversation context)"))}else a=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile),console.error("üéÆ [GameTabService] Created",a.length,"initial template subtabs (no AI response)");else e.isUnreleased?console.error("üéÆ [GameTabService] Creating unreleased game tab (no subtabs, Discuss mode only)"):console.error("üîí [GameTabService] Subtabs disabled for free tier users");const n={id:e.conversationId,title:e.gameTitle,messages:[],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,gameId:e.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:e.gameTitle,genre:e.genre,subtabs:a,subtabsOrder:a.map(u=>u.id),isActiveSession:!1,activeObjective:"",gameProgress:0,isUnreleased:e.isUnreleased||!1};return await _.addConversation(n),a.length>0&&s?(console.error("üéÆ [GameTabService] Saving",a.length,"subtabs for conversation:",n.id),console.error("üéÆ [GameTabService] Subtabs:",JSON.stringify(a.map(g=>({id:g.id,title:g.title,type:g.type,hasType:!!g.type})),null,2)),await new Promise(g=>setTimeout(g,1e3)),await B.setSubtabs(n.id,a)||console.error("‚ùå [GameTabService] Failed to save subtabs - conversation may not exist yet")):s?console.error("üéÆ [GameTabService] No subtabs to save for conversation:",n.id):console.error("üîí [GameTabService] Skipping subtabs save for free tier user"),s?e.aiResponse?(l=n.subtabs)!=null&&l.some(g=>g.content==="Loading...")&&this.generateInitialInsights(n,e.playerProfile,e.aiResponse).catch(g=>console.error("Background insight generation failed:",g)):this.generateInitialInsights(n,e.playerProfile,e.aiResponse).catch(u=>console.error("Background insight generation failed:",u)):console.error("üîí [GameTabService] Skipping AI insight generation for free tier user"),n}generateInitialSubTabs(e,t,r){let a=(se[e]||se.Default).map(n=>({...n,priority:"medium",isProfileSpecific:!1}));if(t){console.error("üéÆ [GameTabService] Generating profile-specific tabs for:",t.playerFocus);const n=z.generateProfileSpecificTabs(t,r);a=[...a,...n],a=z.prioritizeTabsForProfile(a,t)}return a.map(n=>({id:Y(),title:n.title,type:n.type,content:"Loading...",isNew:!0,status:"loading",instruction:n.instruction}))}extractInsightsFromAIResponse(e,t){console.error("ü§ñ [GameTabService] Extracting dynamic insights from AI response");const r=e.otakonTags.get("INSIGHT_UPDATE");if(r){console.error("ü§ñ [GameTabService] Found INSIGHT_UPDATE:",r);const s=r;if(!s.id)return console.error("ü§ñ [GameTabService] INSIGHT_UPDATE missing id, skipping"),t;if(t.find(n=>n.id===s.id))return t.map(n=>n.id===s.id?{...n,content:s.content||n.content,isNew:!0,status:"loaded"}:n);{const n={id:Y(),title:this.formatTabTitle(s.id),type:this.determineTabType(s.id),content:s.content||"",isNew:!0,status:"loaded"};return[...t,n]}}return t}formatTabTitle(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}determineTabType(e){return e.includes("story")?"story":e.includes("character")?"characters":e.includes("strategy")||e.includes("tips")?"tips":e.includes("boss")?"strategies":e.includes("quest")||e.includes("walkthrough")?"walkthrough":e.includes("item")?"items":"chat"}async generateInitialInsights(e,t,r){var n,c,i;const s=e.id,a=e.gameTitle;console.error(`ü§ñ [GameTabService] üîÑ [${s}] Generating initial insights for: ${a}`);try{if(!(await _.getConversations(!0))[s]){console.error(`ü§ñ [GameTabService] [${s}] ‚ö†Ô∏è Conversation no longer exists, aborting insight generation`);return}let u="";r!=null&&r.content?(u=`AI Analysis: ${r.content}`,console.error(`ü§ñ [GameTabService] [${s}] Using AI response as context (${r.content.length} chars)`)):e.messages.length>0?(u=e.messages.map(y=>`${y.role==="user"?"User":"AI"}: ${y.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${s}] Using messages as context (${e.messages.length} msgs)`)):console.error(`ü§ñ [GameTabService] [${s}] ‚ö†Ô∏è No context available`),console.error(`ü§ñ [GameTabService] [${s}] üöÄ Calling AI generateInitialInsights...`);const g=await Ge.generateInitialInsights(a||"Unknown Game",e.genre||"Action RPG",t,u);if(console.error(`ü§ñ [GameTabService] [${s}] üì• AI returned:`,Object.keys(g).length,"insights"),!(await _.getConversations(!0))[s]){console.error(`ü§ñ [GameTabService] [${s}] ‚ö†Ô∏è Conversation deleted during AI call, discarding results`);return}const f=g&&Object.keys(g).length>0;f?console.error(`ü§ñ [GameTabService] [${s}] ‚úÖ Got ${Object.keys(g).length} insights:`,Object.keys(g)):console.error(`ü§ñ [GameTabService] [${s}] ‚ùå Empty insights, using fallback`);const A=(await _.getConversations(!0))[s];if(!A){console.error(`ü§ñ [GameTabService] [${s}] ‚ö†Ô∏è Conversation not found, may have been deleted`);return}const p=await B.getSubtabs(s);console.error(`ü§ñ [GameTabService] [${s}] üìñ Read ${p.length} subtabs from database`),A.subtabs=p;const R={"Story So Far":"story_so_far","Relevant Lore":"game_lore","Lore Exploration":"lore_exploration","Environmental Storytelling":"environmental_storytelling","Active Quests":"quest_log","Story Progression":"story_progression","Quest Guide":"quest_guide","Build Optimization":"build_optimization","Build Guide":"build_guide","Character Building":"character_building","Combat Strategies":"combat_strategies","Boss Strategy":"boss_strategy","Upcoming Boss Strategy":"boss_strategy","Consumable Strategy":"consumable_strategy","Hidden Paths & Secrets":"hidden_paths","Pro Tips":"pro_tips","Exploration Tips":"exploration_tips","Hidden Secrets":"hidden_secrets","Items You May Have Missed":"missed_items","Collectible Hunting":"missed_items","Points of Interest":"points_of_interest","Region Guide":"points_of_interest","Plan Your Next Session":"next_session_plan","Activity Checklist":"next_session_plan","Dynamic World Events":"points_of_interest","Exploration Route":"exploration_tips","Fast Travel Optimization":"pro_tips","Progression Balance":"next_session_plan","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","NPC Interactions":"npc_interactions","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Puzzle Solving":"puzzle_solving","Inventory Optimization":"inventory_optimization"};console.error("ü§ñ [GameTabService] Building content mapping for subtabs...");const N=((n=A.subtabs)==null?void 0:n.map(y=>{let C="";const te=R[y.title];if(f&&te&&g[te]&&(C=g[te],console.error(`ü§ñ [GameTabService] Subtab "${y.title}" using AI content from key "${te}" (${C.length} chars)`)),!C){let re=u;if(y.type==="story"&&u.includes("Lore:")){const P=u.match(/Lore:(.*?)(?=\n\n|\n[A-Z]|$)/s);re=P?P[1].trim():u}else if(y.type==="strategies"&&u.includes("Analysis:")){const P=u.match(/Analysis:(.*?)(?=\n\n|\n[A-Z]|$)/s);re=P?P[1].trim():u}else if(y.type==="tips"&&u.includes("Hint:")){const P=u.match(/Hint:(.*?)(?=\n\n|\n[A-Z]|$)/s);re=P?P[1].trim():u}C=`## ${y.title}

${re}`,console.error(`ü§ñ [GameTabService] Subtab "${y.title}" using fallback content from AI response (${C.length} chars)`),console.error("ü§ñ [GameTabService] Preview:",C.substring(0,150)+"...")}return{...y,content:C,isNew:!1,status:"loaded",type:y.type}}))||[];console.error("ü§ñ [GameTabService] Updating subtabs with content...");const j=N.map(y=>{var C;return{id:y.id,title:y.title,type:y.type,status:y.status,contentLength:((C=y.content)==null?void 0:C.length)||0,isNew:y.isNew,hasType:!!y.type}});if(console.error("ü§ñ [GameTabService] Subtabs to save:",j),console.error("ü§ñ [GameTabService] ALL statuses:",N.map(y=>y.status)),console.error("ü§ñ [GameTabService] ALL types:",N.map(y=>y.type||"MISSING_TYPE")),console.error("ü§ñ [GameTabService] üóëÔ∏è Clearing cache BEFORE subtabs write..."),_.clearCache(),!await B.setSubtabs(e.id,N))throw new Error("Failed to update subtabs in database");console.error("ü§ñ [GameTabService] ‚úÖ Subtabs dual-write complete (table + JSONB)"),_.clearCache(),await new Promise(y=>setTimeout(y,500));const Ce=(await _.getConversations(!0))[e.id];Ce?console.error("ü§ñ [GameTabService] üîç VERIFICATION: Read back subtabs after write:",((c=Ce.subtabs)==null?void 0:c.map(y=>({title:y.title,status:y.status})))||"NO SUBTABS"):console.error("ü§ñ [GameTabService] ‚ö†Ô∏è VERIFICATION: Could not find conversation after write!"),await _.updateConversation(e.id,{updatedAt:Date.now()}),console.error("ü§ñ [GameTabService] ‚úÖ Conversation metadata updated")}catch(l){console.error("ü§ñ [GameTabService] ‚ùå Failed to generate initial insights:",l),H.warning("Failed to load game insights. You can still chat about the game!");try{const g=(await _.getConversations(!0))[e.id];if(!g){console.error("ü§ñ [GameTabService] Conversation not found for error update:",e.id);return}const m=((i=g.subtabs)==null?void 0:i.map(f=>({...f,content:`Failed to load ${f.title} content. Please try again later.`,isNew:!1,status:"error"})))||[];await B.setSubtabs(e.id,m),await _.updateConversation(e.id,{updatedAt:Date.now()})}catch(u){console.error("ü§ñ [GameTabService] Failed to update error state:",u)}}}async updateSubTabContent(e,t,r,s){if(s==="free"){console.log("üìù [GameTabService] Skipping subtab update - free tier (subtabs are preserved but not updated)");return}console.error("üìù [GameTabService] Updating sub-tab content:",{conversationId:e,subTabId:t});try{const n=(await _.getConversations())[e];if(!n||!n.subtabs)throw new Error("Conversation or sub-tabs not found");const c=n.subtabs.map(i=>i.id===t?{...i,content:r,isNew:!1,status:"loaded"}:i);await B.setSubtabs(e,c),await _.updateConversation(e,{updatedAt:Date.now()})}catch(a){throw console.error("Failed to update sub-tab content:",a),a}}async getGameTab(e){try{const r=(await _.getConversations())[e];return!r||!r.gameTitle?null:{id:r.id,title:r.title,gameId:r.gameId||r.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:r.gameTitle,genre:r.genre||"Unknown",subtabs:r.subtabs||[],createdAt:r.createdAt,updatedAt:r.updatedAt,isActiveSession:r.isActiveSession||!1}}catch(t){return console.error("Failed to get game tab:",t),H.error("Failed to load game tab."),null}}isGameTab(e){return!e.isGameHub&&!!e.gameTitle}generateGameConversationId(e){return`game-${e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-")}`}async updateSubTabsFromAIResponse(e,t,r){if(r==="free"){console.log(`üìù [GameTabService] [${e}] Skipping subtab update - free tier (subtabs are preserved but not updated)`);return}console.error(`üìù [GameTabService] [${e}] Updating subtabs from AI response:`,t.length);try{const a=(await _.getConversations(!0))[e];if(!a||!a.subtabs){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Conversation or subtabs not found, aborting update`);return}let n=0;const c=a.subtabs.map(i=>{const l=t.find(u=>u.tabId===i.id);if(l){n++,console.error(`üìù [GameTabService] [${e}] Updating subtab: ${i.id} - ${l.title}`);const g=`

---
**Updated: `+new Date().toLocaleString()+`**

`,f=i.content&&i.content.trim().length>0&&i.content!=="Loading..."&&i.status==="loaded"?i.content+g+l.content:l.content;return{...i,title:l.title||i.title,content:f,isNew:!0,status:"loaded"}}return i});if(n===0){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è No subtabs matched for update`);return}await _.updateConversation(e,{subtabs:c,updatedAt:Date.now()}),console.error(`üìù [GameTabService] [${e}] ‚úÖ Updated ${n} subtabs successfully`)}catch(s){throw console.error(`üìù [GameTabService] [${e}] ‚ùå Failed to update subtabs:`,s),s}}async generateSubtabsForExistingTabs(e,t){console.log("üîÑ [GameTabService] Generating subtabs for existing game tabs after tier upgrade");let r=0,s=0;try{const a=await _.getConversations(!0),n=Object.values(a).filter(c=>{const i=c.gameTitle&&!c.isGameHub&&!c.isUnreleased,l=!c.subtabs||c.subtabs.length===0;return i&&l});if(n.length===0)return console.log("üîÑ [GameTabService] No game tabs need subtab generation"),{success:0,failed:0};console.log(`üîÑ [GameTabService] Found ${n.length} game tabs that need subtabs`);for(let c=0;c<n.length;c++){const i=n[c],l=i.gameTitle||i.title;t==null||t(c+1,n.length,l);try{console.log(`üîÑ [GameTabService] [${c+1}/${n.length}] Generating subtabs for: ${l}`);const u=i.genre||"Action RPG",m=(se[u]||se["Action RPG"]).map((f,w)=>({id:Y(),conversationId:i.id,title:f.title,type:f.type,content:"Loading...",isNew:!1,status:"loading",orderIndex:w}));await B.setSubtabs(i.id,m),await _.updateConversation(i.id,{subtabs:m,updatedAt:Date.now()}),this.generateInitialInsights({...i,subtabs:m}).catch(f=>{console.error(`‚ùå [GameTabService] Failed to generate insights for ${l}:`,f)}),r++,c<n.length-1&&await new Promise(f=>setTimeout(f,500))}catch(u){console.error(`‚ùå [GameTabService] Failed to create subtabs for ${l}:`,u),s++}}return console.log(`üîÑ [GameTabService] Subtab generation complete: ${r} success, ${s} failed`),{success:r,failed:s}}catch(a){return console.error("‚ùå [GameTabService] Error in generateSubtabsForExistingTabs:",a),{success:r,failed:s}}}}const ir=new ft,U=o=>o;class cr{static getCurrentUser(){return M.get(k.USER,null)}static setCurrentUser(e){M.set(k.USER,e)}static createUser(e,t=Ke.FREE){const r=Date.now(),s=Oe[t];return{id:`user_${r}`,authUserId:`user_${r}`,email:e,tier:t,hasProfileSetup:!1,hasSeenSplashScreens:!1,hasSeenHowToUse:!1,hasSeenFeaturesConnected:!1,hasSeenProFeatures:!1,pcConnected:!1,pcConnectionSkipped:!1,onboardingCompleted:!1,hasWelcomeMessage:!1,isNewUser:!0,hasUsedTrial:!1,lastActivity:r,preferences:{},textCount:0,imageCount:0,textLimit:s.text,imageLimit:s.image,totalRequests:0,lastReset:r,usage:{textCount:0,imageCount:0,textLimit:s.text,imageLimit:s.image,totalRequests:0,lastReset:r,tier:t},appState:{},profileData:{},onboardingData:{},behaviorData:{},feedbackData:{},usageData:{},createdAt:r,updatedAt:r}}static updateUser(e){const t=this.getCurrentUser();if(!t)return;const r={...t,...e,updatedAt:Date.now()};this.setCurrentUser(r)}static updateUsage(e){const t=this.getCurrentUser();t&&this.updateUser({usage:{...t.usage,...e}})}static resetUsage(){const e=this.getCurrentUser();if(!e)return;const t=Oe[e.tier];this.updateUsage({textCount:0,imageCount:0,totalRequests:0,lastReset:Date.now(),textLimit:t.text,imageLimit:t.image})}static canMakeRequest(e){const t=this.getCurrentUser();if(!t)return!1;const{usage:r}=t;return e==="text"?r.textCount<r.textLimit:r.imageCount<r.imageLimit}static incrementUsage(e){const t=this.getCurrentUser();if(!t)return;const r={totalRequests:t.usage.totalRequests+1};e==="text"?r.textCount=t.usage.textCount+1:r.imageCount=t.usage.imageCount+1,this.updateUsage(r)}static logout(){M.remove(k.USER)}static async getCurrentUserAsync(){try{const e=M.get(k.USER,null),{data:{user:t},error:r}=await d.auth.getUser();if(r||!t)return e;const{data:s,error:a}=await d.from("users").select("*").eq("auth_user_id",t.id).single();if(a||!s)return console.error("Failed to fetch user from Supabase:",a),e;const n={id:s.id,authUserId:s.auth_user_id,email:s.email,tier:s.tier,textCount:s.text_count||0,imageCount:s.image_count||0,textLimit:ne(s.text_limit),imageLimit:ne(s.image_limit),totalRequests:s.total_requests||0,lastReset:q(s.last_reset),hasProfileSetup:s.has_profile_setup||!1,hasSeenSplashScreens:s.has_seen_splash_screens||!1,hasSeenHowToUse:s.has_seen_how_to_use||!1,hasSeenFeaturesConnected:s.has_seen_features_connected||!1,hasSeenProFeatures:s.has_seen_pro_features||!1,pcConnected:s.pc_connected||!1,pcConnectionSkipped:s.pc_connection_skipped||!1,onboardingCompleted:s.onboarding_completed||!1,hasWelcomeMessage:s.has_welcome_message||!1,isNewUser:s.is_new_user||!1,hasUsedTrial:s.has_used_trial||!1,lastActivity:q(s.updated_at),preferences:I(s.preferences),usage:{textCount:s.text_count||0,imageCount:s.image_count||0,textLimit:ne(s.text_limit),imageLimit:ne(s.image_limit),totalRequests:s.total_requests||0,lastReset:q(s.last_reset),tier:s.tier},appState:I(s.app_state),profileData:I(s.profile_data),onboardingData:I(s.onboarding_data),behaviorData:I(s.behavior_data),feedbackData:I(s.feedback_data),usageData:I(s.usage_data),createdAt:q(s.created_at),updatedAt:q(s.updated_at)};return M.set(k.USER,n),n}catch(e){return console.error("Error in getCurrentUserAsync:",e),M.get(k.USER,null)}}static async setCurrentUserAsync(e){try{M.set(k.USER,e);const{error:t}=await d.from("users").update({tier:e.tier,text_count:e.textCount,image_count:e.imageCount,text_limit:e.textLimit,image_limit:e.imageLimit,total_requests:e.totalRequests,last_reset:new Date(e.lastReset).toISOString(),has_profile_setup:e.hasProfileSetup,has_seen_splash_screens:e.hasSeenSplashScreens,has_seen_how_to_use:e.hasSeenHowToUse,has_seen_features_connected:e.hasSeenFeaturesConnected,has_seen_pro_features:e.hasSeenProFeatures,pc_connected:e.pcConnected,pc_connection_skipped:e.pcConnectionSkipped,onboarding_completed:e.onboardingCompleted,has_welcome_message:e.hasWelcomeMessage,has_used_trial:e.hasUsedTrial,preferences:U(e.preferences),profile_data:U(e.profileData),app_state:U(e.appState),onboarding_data:U(e.onboardingData),behavior_data:U(e.behaviorData),feedback_data:U(e.feedbackData),usage_data:U(e.usageData),updated_at:new Date().toISOString()}).eq("auth_user_id",e.authUserId);t&&console.error("Failed to sync user to Supabase:",t)}catch(t){console.error("Error in setCurrentUserAsync:",t)}}static async updateUsageAsync(e){const t=await this.getCurrentUserAsync();if(!t)return;const r={...t,usage:{...t.usage,...e},textCount:e.textCount??t.textCount,imageCount:e.imageCount??t.imageCount,totalRequests:e.totalRequests??t.totalRequests,lastReset:e.lastReset??t.lastReset,updatedAt:Date.now()};await this.setCurrentUserAsync(r)}}class yt{hasTabCommand(e){return/^@\w+/.test(e.trim())}parseTabCommand(e,t){const r=e.trim();if(!this.hasTabCommand(r))return null;const s=r.match(/^@(\w+)\s*(\\modify|\\delete)?\s*(.*)$/);if(!s)return null;const[,a,n,c]=s,i=this.findMatchingTab(a,t.subtabs||[]);if(!i)return null;let l;return n==="\\delete"?l="delete":n==="\\modify"?l="modify":l="update",{type:l,tabId:i.id,tabName:i.title,instruction:c.trim()}}findMatchingTab(e,t){const r=this.normalizeTabName(e);let s=t.find(a=>this.normalizeTabName(a.id)===r||this.normalizeTabName(a.title)===r);return s||(s=t.find(a=>this.normalizeTabName(a.id).includes(r)||this.normalizeTabName(a.title).includes(r)),s)?s:(s=t.find(a=>r.includes(this.normalizeTabName(a.id))||r.includes(this.normalizeTabName(a.title))),s||null)}normalizeTabName(e){return e.toLowerCase().replace(/[_\s-]+/g,"").replace(/[^a-z0-9]/g,"")}getAvailableTabNames(e){return!e.subtabs||e.subtabs.length===0?[]:e.subtabs.map(t=>({id:t.id,title:t.title,variations:[t.id,t.title,t.id.replace(/_/g," "),t.title.toLowerCase()]})).map(t=>t.id)}formatTabSuggestion(e,t){return`@${e}`}getCommandHelp(){return`
**Tab Commands:**
‚Ä¢ @<tab> <text> - Update tab with new info
‚Ä¢ @<tab> \\modify <text> - Modify/rename tab
‚Ä¢ @<tab> \\delete - Delete tab

Example: @story_so_far The player defeated the first boss
    `.trim()}validateCommand(e){switch(e.type){case"update":if(!e.instruction)return{valid:!1,error:"Update command requires content. Example: @story_so_far The player..."};break;case"modify":if(!e.instruction)return{valid:!1,error:"Modify command requires instructions. Example: @tips \\modify Change to combat strategies"};break}return{valid:!0}}describeCommand(e){switch(e.type){case"update":return`Updating "${e.tabName}" with: ${e.instruction}`;case"modify":return`Modifying "${e.tabName}": ${e.instruction}`;case"delete":return`Deleting "${e.tabName}"`}}}const lr=new yt;let S,K=[],Re=!1,Q="",X=null,G=null,E=null,we=!1;const St="otakonSpeechRate",Ee=async()=>{try{const o=navigator;o.wakeLock&&(X=await o.wakeLock.request("screen"),X.addEventListener("release",()=>{S&&S.speaking&&!we&&Ee()}))}catch{}},xe=async()=>{try{X!==null&&(await X.release(),X=null)}catch{}},bt=()=>{try{if(!G){const o=window,e=o.AudioContext||o.webkitAudioContext;e&&(G=new e)}E||(E=new Audio,E.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA",E.loop=!0,E.volume=.01,G&&E&&G.createMediaElementSource(E).connect(G.destination))}catch{}},De=async()=>{try{E&&G&&(G.state==="suspended"&&await G.resume(),await E.play())}catch{}},$e=()=>{try{E&&(E.pause(),E.currentTime=0)}catch{}},_t=()=>new Promise((o,e)=>{if(!S)return e(new Error("Speech synthesis not initialized."));if(K=S.getVoices(),K.length>0){o();return}S.onvoiceschanged=()=>{K=S.getVoices(),o()},setTimeout(()=>{K.length===0&&(K=S.getVoices()),o()},1e3)}),ee=()=>{S&&S.speaking&&S.cancel(),Q="","mediaSession"in navigator&&navigator.mediaSession.playbackState!=="none"&&(navigator.mediaSession.playbackState="paused"),xe(),$e(),window.dispatchEvent(new CustomEvent("otakon:ttsStopped"))},vt=()=>{S&&S.speaking&&!S.paused&&(S.pause(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="paused"),window.dispatchEvent(new CustomEvent("otakon:ttsPaused")))},wt=()=>{S&&S.paused&&(S.resume(),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="playing"),window.dispatchEvent(new CustomEvent("otakon:ttsResumed")))},Tt=async()=>{Q&&(ee(),await Fe(Q))},Et=()=>S?S.speaking:!1,Ne=()=>{ee(),window.dispatchEvent(new CustomEvent("otakon:disableHandsFree"))},At=()=>{"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{}),navigator.mediaSession.setActionHandler("pause",Ne),navigator.mediaSession.setActionHandler("stop",Ne))},Ct=async()=>{document.hidden?(we=!0,S&&S.speaking&&await De()):(we=!1,S&&S.speaking&&await Ee())},Ot=async()=>{if(typeof window<"u"&&"speechSynthesis"in window){if(Re)return;Re=!0,S=window.speechSynthesis,await _t(),At(),bt(),document.addEventListener("visibilitychange",Ct),S.getVoices().length===0&&S.speak(new SpeechSynthesisUtterance(""))}},Le=()=>K.filter(o=>o.lang.startsWith("en-")),Fe=async o=>new Promise((e,t)=>{try{if(!S)return console.error("Text-to-Speech is not available on this browser."),t(new Error("Text-to-Speech is not available on this browser."));if(!o.trim())return e();ee(),Q=o;const r=new SpeechSynthesisUtterance(o),s=localStorage.getItem(St);r.rate=s?parseFloat(s):.94;const a=localStorage.getItem("otakonPreferredVoiceURI"),n=Le();let c;if(a&&(c=n.find(i=>i.voiceURI===a)),!c&&n.length>0){const i=n.find(l=>l.name.toLowerCase().includes("female"));i?c=i:c=n[0]}c&&(r.voice=c),r.onstart=async()=>{await Ee(),await De(),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"TTS_STARTED"}),"mediaSession"in navigator&&(navigator.mediaSession.playbackState="playing",navigator.mediaSession.metadata=new MediaMetadata({title:o.length>50?o.substring(0,50)+"...":o,artist:"Your AI Gaming Companion",album:"Otakon",artwork:[{src:"/icon-192.png",sizes:"192x192",type:"image/png"},{src:"/icon-512.png",sizes:"512x512",type:"image/png"}]})),window.dispatchEvent(new CustomEvent("otakon:ttsStarted"))},r.onend=()=>{Q="","mediaSession"in navigator&&(navigator.mediaSession.playbackState="paused"),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"TTS_STOPPED"}),xe(),$e(),window.dispatchEvent(new CustomEvent("otakon:ttsStopped")),e()},r.onerror=i=>{console.error("SpeechSynthesis Utterance Error",i),ee(),t(i)},S.speak(r)}catch(r){console.error("TTS Error:",r),t(r)}}),ur={init:Ot,getAvailableVoices:Le,speak:Fe,cancel:ee,pause:vt,resume:wt,restart:Tt,isSpeaking:Et};class Pe{static async acquireMigrationLock(e,t){const r=[e,t].sort().join("|");return this.activeMigrations.has(r)?(console.warn("üîí [MessageRouting] Migration already in progress:",r),!1):(this.activeMigrations.add(r),setTimeout(()=>{this.activeMigrations.delete(r)},this.LOCK_TIMEOUT),!0)}static releaseMigrationLock(e,t){const r=[e,t].sort().join("|");this.activeMigrations.delete(r)}static async migrateMessagesAtomic(e,t,r){var a,n,c,i;if(console.error("üì¶ [MessageRouting] Migration requested:",{messageIds:e,from:t,to:r}),!await this.acquireMigrationLock(t,r)){console.warn("‚ö†Ô∏è [MessageRouting] Skipping migration - another migration in progress");return}try{console.error("üì¶ [MessageRouting] Lock acquired, starting migration");const l=await _.getConversations(!1);console.error("üì¶ [MessageRouting] Loaded conversations:",Object.keys(l));const u=l[t],g=l[r];if(!u)throw console.error("üì¶ [MessageRouting] Source conversation not found:",t),console.error("üì¶ [MessageRouting] Available conversations:",Object.keys(l)),new Error(`Source conversation ${t} not found`);if(!g)throw console.error("üì¶ [MessageRouting] Destination conversation not found:",r),console.error("üì¶ [MessageRouting] Available conversations:",Object.keys(l)),new Error(`Destination conversation ${r} not found`);console.error("üì¶ [MessageRouting] Source messages:",(a=u.messages)==null?void 0:a.map(p=>({id:p.id,role:p.role}))),console.error("üì¶ [MessageRouting] Destination messages before:",(n=g.messages)==null?void 0:n.map(p=>({id:p.id,role:p.role})));const m=u.messages.filter(p=>e.includes(p.id));if(console.error("üì¶ [MessageRouting] Messages to move:",m.map(p=>({id:p.id,role:p.role}))),m.length===0){console.error("üì¶ [MessageRouting] No messages found to migrate");return}const f=m.filter(p=>!g.messages.some(R=>R.id===p.id));console.error("üì¶ [MessageRouting] Messages to add (after duplicate check):",f.map(p=>({id:p.id,role:p.role})));const{FEATURE_FLAGS:w}=await Ie(async()=>{const{FEATURE_FLAGS:p}=await import("./chat-services-BAnxrAbj.js").then(R=>R.c);return{FEATURE_FLAGS:p}},__vite__mapDeps([0,1,2,3,4,5,6,7]));if(w.USE_NORMALIZED_MESSAGES&&f.length>0)try{console.error("üîÑ [MessageRouting] Updating conversation_id in database for",f.length,"messages");const{supabase:p}=await Ie(async()=>{const{supabase:j}=await import("./auth-HSZKT8HQ.js").then(Ae=>Ae.a);return{supabase:j}},__vite__mapDeps([2,3,4,5,6,7,0,1])),R=f.map(j=>j.id),{error:N}=await p.from("messages").update({conversation_id:r}).in("id",R);if(N)throw console.error("‚ùå [MessageRouting] Failed to update conversation_id in database:",N),N;console.error("‚úÖ [MessageRouting] Database conversation_id updated for",R.length,"messages")}catch(p){throw console.error("‚ùå [MessageRouting] Database migration failed:",p),p}const A={...l,[r]:{...g,messages:[...g.messages,...f],updatedAt:Date.now()},[t]:{...u,messages:u.messages.filter(p=>!e.includes(p.id)),updatedAt:Date.now()}};console.error("üì¶ [MessageRouting] Updated source messages:",(c=A[t].messages)==null?void 0:c.map(p=>({id:p.id,role:p.role}))),console.error("üì¶ [MessageRouting] Updated destination messages:",(i=A[r].messages)==null?void 0:i.map(p=>({id:p.id,role:p.role}))),await _.setConversations(A),console.error("‚úÖ [MessageRouting] Migration complete, conversations saved")}finally{this.releaseMigrationLock(t,r)}}static shouldRouteMessage(e,t,r){return!t||e===t?!1:!!(r&&t)}static messageExists(e,t){return e.some(r=>r.id===t)}}h(Pe,"activeMigrations",new Set),h(Pe,"LOCK_TIMEOUT",1e4);const W=class W{static getInstance(){return W.instance||(W.instance=new W),W.instance}async getMessages(e){return ae.USE_NORMALIZED_MESSAGES?this.getMessagesFromTable(e):this.getMessagesFromJsonb(e)}async addMessage(e,t){return ae.USE_NORMALIZED_MESSAGES?this.addMessageToTable(e,t):this.addMessageToJsonb(e,t)}async updateMessage(e,t,r){return ae.USE_NORMALIZED_MESSAGES?this.updateMessageInTable(t,r):this.updateMessageInJsonb(e,t,r)}async deleteMessage(e,t){return ae.USE_NORMALIZED_MESSAGES?this.deleteMessageFromTable(t):this.deleteMessageFromJsonb(e,t)}async getMessagesFromTable(e){try{const{data:t,error:r}=await d.rpc("get_conversation_messages",{p_conversation_id:e});return r?(console.error("Error getting messages from table:",r),[]):(t||[]).map(s=>({id:s.id,role:s.role,content:s.content,timestamp:new Date(s.created_at).getTime(),imageUrl:s.image_url||void 0,metadata:I(s.metadata)}))}catch(t){return console.error("Error getting messages from table:",t),[]}}async addMessageToTable(e,t){var a,n;const s=[0,1e3,2e3];for(let c=0;c<3;c++)try{c>0&&(await new Promise(m=>setTimeout(m,s[c])),console.warn(`üîÑ [MessageService] Retry attempt ${c+1}/3`));const{data:i,error:l}=await d.rpc("add_message",{p_conversation_id:e,p_role:t.role,p_content:t.content,p_image_url:he(t.imageUrl,void 0),p_metadata:oe(t.metadata||{})});if(l){if(c<2&&(l.code==="PGRST301"||(a=l.message)!=null&&a.includes("timeout")||(n=l.message)!=null&&n.includes("network"))){console.warn("‚ö†Ô∏è [MessageService] Transient error, will retry:",l);continue}throw new Error(`Failed to add message: ${l.message} (code: ${l.code})`)}const{data:u,error:g}=await d.from("messages").select("*").eq("id",i).single();if(g)throw new Error(`Failed to fetch new message: ${g.message}`);if(!u)throw new Error("Message not found after insert - database inconsistency");return{id:u.id,role:u.role,content:u.content,timestamp:q(u.created_at),imageUrl:he(u.image_url,void 0),metadata:I(u.metadata)}}catch(i){if(c===2)throw console.error("‚ùå [MessageService] All retry attempts exhausted:",i),i}throw new Error("Unexpected: retry loop completed without result")}async updateMessageInTable(e,t){try{const r={};t.content!==void 0&&(r.content=t.content),t.imageUrl!==void 0&&(r.image_url=t.imageUrl),t.metadata!==void 0&&(r.metadata=t.metadata);const{error:s}=await d.from("messages").update(r).eq("id",e);return s?(console.error("Error updating message in table:",s),!1):!0}catch(r){return console.error("Error updating message in table:",r),!1}}async deleteMessageFromTable(e){try{const{error:t}=await d.from("messages").delete().eq("id",e);return t?(console.error("Error deleting message from table:",t),!1):!0}catch(t){return console.error("Error deleting message from table:",t),!1}}async getMessagesFromJsonb(e){try{const{data:t,error:r}=await d.from("conversations").select("messages").eq("id",e).single();return r?(console.error("Error getting messages from JSONB:",r),[]):Array.isArray(t==null?void 0:t.messages)?t.messages:[]}catch(t){return console.error("Error getting messages from JSONB:",t),[]}}async addMessageToJsonb(e,t){try{const r=await this.getMessagesFromJsonb(e),s={...t,id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now()},{error:a}=await d.from("conversations").update({messages:oe([...r,s]),updated_at:new Date().toISOString()}).eq("id",e);return a?(console.error("Error adding message to JSONB:",a),null):s}catch(r){return console.error("Error adding message to JSONB:",r),null}}async updateMessageInJsonb(e,t,r){try{const a=(await this.getMessagesFromJsonb(e)).map(c=>c.id===t?{...c,...r}:c),{error:n}=await d.from("conversations").update({messages:oe(a),updated_at:new Date().toISOString()}).eq("id",e);return n?(console.error("Error updating message in JSONB:",n),!1):!0}catch(s){return console.error("Error updating message in JSONB:",s),!1}}async deleteMessageFromJsonb(e,t){try{const s=(await this.getMessagesFromJsonb(e)).filter(n=>n.id!==t),{error:a}=await d.from("conversations").update({messages:oe(s),updated_at:new Date().toISOString()}).eq("id",e);return a?(console.error("Error deleting message from JSONB:",a),!1):!0}catch(r){return console.error("Error deleting message from JSONB:",r),!1}}async migrateMessagesToTable(){try{const{data:e,error:t}=await d.rpc("migrate_messages_to_table");return t?(console.error("Error migrating messages:",t),{conversationsProcessed:0,messagesCreated:0,errors:1}):{conversationsProcessed:e[0].conversations_processed,messagesCreated:e[0].messages_created,errors:e[0].errors}}catch(e){return console.error("Error migrating messages:",e),{conversationsProcessed:0,messagesCreated:0,errors:1}}}async rollbackMessagesToJsonb(){try{const{data:e,error:t}=await d.rpc("rollback_messages_to_jsonb");return t?(console.error("Error rolling back messages:",t),{conversationsUpdated:0,errors:1}):{conversationsUpdated:e[0].conversations_updated,errors:e[0].errors}}catch(e){return console.error("Error rolling back messages:",e),{conversationsUpdated:0,errors:1}}}};h(W,"instance");let ge=W;ge.getInstance();const dr=Object.freeze(Object.defineProperty({__proto__:null,MessageService:ge},Symbol.toStringTag,{value:"Module"}));function It(o){var n;const e=o.split(","),t=((n=e[0].match(/:(.*?);/))==null?void 0:n[1])||"image/png",r=atob(e[1]),s=r.length,a=new Uint8Array(s);for(let c=0;c<s;c++)a[c]=r.charCodeAt(c);return new Blob([a],{type:t})}async function Rt(o,e){try{const t=It(o),r=t.size,s=50*1024*1024;if(r>s)return{success:!1,error:"Screenshot exceeds 50MB size limit"};const a=Date.now(),n=Math.random().toString(36).substring(2,15),c=`${a}_${n}.png`,i=`${e}/${c}`,{error:l}=await d.storage.from("screenshots").upload(i,t,{contentType:"image/png",cacheControl:"3600",upsert:!1});if(l)return console.error("Screenshot upload error:",l),{success:!1,error:l.message};const{data:u}=d.storage.from("screenshots").getPublicUrl(i);return u!=null&&u.publicUrl?{success:!0,publicUrl:u.publicUrl,fileSize:r}:{success:!1,error:"Failed to generate public URL"}}catch(t){return console.error("Screenshot upload exception:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error"}}}const gr=Object.freeze(Object.defineProperty({__proto__:null,uploadScreenshot:Rt},Symbol.toStringTag,{value:"Module"}));class Nt{constructor(){h(this,"MAX_WORDS",300);h(this,"RECENT_MESSAGE_COUNT",8)}countWords(e){return e.trim().split(/\s+/).filter(t=>t.length>0).length}getTotalWordCount(e){return e.reduce((t,r)=>{const s=this.countWords(r.content);return t+s},0)}shouldSummarize(e){return!e.messages||e.messages.length<=this.RECENT_MESSAGE_COUNT?!1:this.getTotalWordCount(e.messages)>this.MAX_WORDS*3}splitMessages(e){if(e.length<=this.RECENT_MESSAGE_COUNT)return{toSummarize:[],toKeep:e};const t=e.length-this.RECENT_MESSAGE_COUNT;return{toSummarize:e.slice(0,t),toKeep:e.slice(t)}}async summarizeMessages(e,t,r){const s=this.getTotalWordCount(e),a=e.map(i=>`${i.role==="user"?"User":"Assistant"}: ${i.content}`).join(`

`),c=`${t&&r?`This is a conversation about "${t}" (${r}).`:"This is a general conversation."}

Please provide a concise summary of the following conversation history. Focus on:
- Key topics discussed
- Important decisions or choices made
- Game progress or story developments (if applicable)
- User preferences or interests mentioned

Keep the summary under ${this.MAX_WORDS} words while preserving essential context.

Conversation to summarize:
${a}

Provide ONLY the summary, no additional commentary.`;try{const i={id:"temp-summary",title:"Summary Request",messages:[{id:"summary-msg-"+Date.now(),role:"user",content:c,timestamp:Date.now()}],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,isGameHub:!1},l={id:"system",email:"system@otakon.ai",profileData:null},g=(await Ge.getChatResponse(i,l,c,!1,!1)).content.trim(),m=this.countWords(g);return console.log(`‚úÖ [ContextSummarization] Summary generated: ${m} words (reduced from ${s})`),{summary:g,wordCount:m,messagesIncluded:e.length,originalWordCount:s}}catch(i){console.error("‚ùå [ContextSummarization] Failed to generate summary:",i);const l=e.slice(0,5).map(u=>u.content.substring(0,100)).join(" ... ").substring(0,this.MAX_WORDS*6);return{summary:`[Previous conversation context] ${l}`,wordCount:this.countWords(l),messagesIncluded:e.length,originalWordCount:s}}}async applyContextSummarization(e){if(!this.shouldSummarize(e))return e;const{toSummarize:t,toKeep:r}=this.splitMessages(e.messages);if(t.length===0)return e;const s=await this.summarizeMessages(t,e.gameTitle,e.genre),n=[{id:"summary-"+Date.now(),role:"system",content:s.summary,timestamp:t[t.length-1].timestamp,metadata:{isSummary:!0,messagesIncluded:s.messagesIncluded,originalWordCount:s.originalWordCount,summaryWordCount:s.wordCount}},...r],c=s.summary.replace(/!\[.*?\]\(data:image\/.*?\)/g,""),i=c.split(/\s+/).filter(u=>u.length>0),l=i.length>500?i.slice(0,500).join(" ")+"...":c;return console.log(`‚úÖ [ContextSummarization] Context optimized: ${e.messages.length} messages ‚Üí ${n.length} (${s.originalWordCount} words ‚Üí ${s.wordCount} + recent)`),{...e,messages:n,contextSummary:l,lastSummarizedAt:Date.now(),updatedAt:Date.now()}}async getOptimizedContext(e){return this.shouldSummarize(e)?(await this.applyContextSummarization(e)).messages:e.messages}willTriggerSummarization(e){return this.getTotalWordCount(e.messages)>this.MAX_WORDS*3*.8}}const Pt=new Nt,mr=Object.freeze(Object.defineProperty({__proto__:null,contextSummarizationService:Pt},Symbol.toStringTag,{value:"Module"}));export{it as A,Kt as B,or as C,Ft as D,ie as E,Dt as F,$t as G,dr as H,gr as I,mr as J,Pe as M,M as S,cr as U,Bt as W,T as a,tr as b,qt as c,ar as d,sr as e,Qt as f,rr as g,z as h,Lt as i,ur as j,nr as k,ir as l,lr as m,Ht as n,Vt as o,er as p,Xt as q,Zt as r,Je as s,H as t,Jt as u,Yt as v,jt as w,zt as x,Wt as y,et as z};
