{"version":3,"file":"core-services-CtalMAh7.js","sources":["../../src/utils/pwaDetection.ts","../../src/utils/userMapping.ts","../../src/services/authService.ts","../../src/utils/typeHelpers.ts","../../src/services/supabaseService.ts"],"sourcesContent":["/**\r\n * PWA Detection Utilities\r\n * Provides consistent PWA mode detection across the application\r\n */\r\n\r\nimport type { ExtendedNavigator } from '../types/enhanced';\r\n\r\n/**\r\n * Check if app is running in PWA (standalone) mode\r\n */\r\nexport const isPWAMode = (): boolean => {\r\n  if (typeof window === 'undefined') return false;\r\n  \r\n  return (\r\n    window.matchMedia('(display-mode: standalone)').matches ||\r\n    (window.navigator as ExtendedNavigator).standalone === true ||\r\n    document.referrer.includes('android-app://')\r\n  );\r\n};\r\n\r\n/**\r\n * Check if running as iOS PWA\r\n */\r\nexport const isIOSPWA = (): boolean => {\r\n  if (typeof window === 'undefined') return false;\r\n  return (window.navigator as ExtendedNavigator).standalone === true;\r\n};\r\n\r\n/**\r\n * Check if running as Android PWA\r\n */\r\nexport const isAndroidPWA = (): boolean => {\r\n  if (typeof window === 'undefined') return false;\r\n  \r\n  return (\r\n    window.matchMedia('(display-mode: standalone)').matches ||\r\n    document.referrer.includes('android-app://')\r\n  );\r\n};\r\n\r\n/**\r\n * Get current PWA display mode\r\n */\r\nexport const getPWADisplayMode = (): 'standalone' | 'browser' | 'fullscreen' | 'minimal-ui' => {\r\n  if (typeof window === 'undefined') return 'browser';\r\n  \r\n  if (window.matchMedia('(display-mode: fullscreen)').matches) return 'fullscreen';\r\n  if (window.matchMedia('(display-mode: standalone)').matches) return 'standalone';\r\n  if (window.matchMedia('(display-mode: minimal-ui)').matches) return 'minimal-ui';\r\n  return 'browser';\r\n};\r\n\r\n/**\r\n * Check if app is installed (different from currently running in PWA mode)\r\n */\r\nexport const isAppInstalled = (): boolean => {\r\n  if (typeof window === 'undefined') return false;\r\n  \r\n  // Check if previously marked as installed\r\n  if (localStorage.getItem('otakon_pwa_installed') === 'true') {\r\n    return true;\r\n  }\r\n  \r\n  // Check if currently running in PWA mode\r\n  return isPWAMode();\r\n};\r\n\r\n/**\r\n * Mark app as installed\r\n */\r\nexport const markAppAsInstalled = (): void => {\r\n  if (typeof window !== 'undefined') {\r\n    localStorage.setItem('otakon_pwa_installed', 'true');\r\n  }\r\n};\r\n\r\n/**\r\n * Get platform type\r\n */\r\nexport const getPlatform = (): 'ios' | 'android' | 'desktop' | 'unknown' => {\r\n  if (typeof window === 'undefined') return 'unknown';\r\n  \r\n  const ua = navigator.userAgent.toLowerCase();\r\n  \r\n  if (/iphone|ipad|ipod/.test(ua)) return 'ios';\r\n  if (/android/.test(ua)) return 'android';\r\n  if (/windows|mac|linux/.test(ua)) return 'desktop';\r\n  \r\n  return 'unknown';\r\n};\r\n\r\n/**\r\n * Check if beforeinstallprompt is supported (for install banner)\r\n */\r\nexport const supportsInstallPrompt = (): boolean => {\r\n  return 'BeforeInstallPromptEvent' in window;\r\n};\r\n","import { User, UserTier } from '../types';\r\nimport { TIER_LIMITS } from '../constants';\r\n\r\n/**\r\n * Helper to safely parse JSON fields from database\r\n */\r\nfunction jsonToRecord(value: unknown): Record<string, unknown> {\r\n  if (value === null || value === undefined) {\r\n    return {};\r\n  }\r\n  if (typeof value === 'string') {\r\n    try {\r\n      return JSON.parse(value) as Record<string, unknown>;\r\n    } catch {\r\n      return {};\r\n    }\r\n  }\r\n  if (typeof value === 'object') {\r\n    return value as Record<string, unknown>;\r\n  }\r\n  return {};\r\n}\r\n\r\n/**\r\n * Map database user data to User type\r\n * Consolidates duplicate mapping logic from authService and supabaseService\r\n */\r\nexport function mapUserData(userData: Record<string, unknown>, authUserId?: string): User {\r\n  const tier = (userData.tier as UserTier) || 'free';\r\n  const textLimit = (userData.text_limit as number) || TIER_LIMITS[tier]?.text || 55;\r\n  const imageLimit = (userData.image_limit as number) || TIER_LIMITS[tier]?.image || 25;\r\n  const textCount = (userData.text_count as number) || 0;\r\n  const imageCount = (userData.image_count as number) || 0;\r\n  const totalRequests = (userData.total_requests as number) || 0;\r\n  const lastReset = userData.last_reset \r\n    ? new Date(userData.last_reset as string).getTime() \r\n    : Date.now();\r\n\r\n  return {\r\n    id: userData.id as string,\r\n    authUserId: (userData.auth_user_id as string) || authUserId || '',\r\n    email: userData.email as string,\r\n    tier,\r\n    hasProfileSetup: (userData.has_profile_setup as boolean) || false,\r\n    hasSeenSplashScreens: (userData.has_seen_splash_screens as boolean) || false,\r\n    hasSeenHowToUse: (userData.has_seen_how_to_use as boolean) || false,\r\n    hasSeenFeaturesConnected: (userData.has_seen_features_connected as boolean) || false,\r\n    hasSeenProFeatures: (userData.has_seen_pro_features as boolean) || false,\r\n    pcConnected: (userData.pc_connected as boolean) || false,\r\n    pcConnectionSkipped: (userData.pc_connection_skipped as boolean) || false,\r\n    onboardingCompleted: (userData.onboarding_completed as boolean) || false,\r\n    hasWelcomeMessage: (userData.has_welcome_message as boolean) || false,\r\n    isNewUser: (userData.is_new_user as boolean) ?? true,\r\n    hasUsedTrial: (userData.has_used_trial as boolean) || false,\r\n    lastActivity: Date.now(),\r\n    \r\n    // Query-based usage limits (top-level for easy access)\r\n    textCount,\r\n    imageCount,\r\n    textLimit,\r\n    imageLimit,\r\n    totalRequests,\r\n    lastReset,\r\n    \r\n    // PC Connection fields\r\n    connectionCode: userData.connection_code as string | undefined,\r\n    connectionCodeCreatedAt: userData.connection_code_created_at \r\n      ? new Date(userData.connection_code_created_at as string).getTime() \r\n      : undefined,\r\n    connectionActive: userData.connection_active as boolean | undefined,\r\n    connectionDeviceInfo: jsonToRecord(userData.connection_device_info),\r\n    lastConnectionAt: userData.last_connection_at \r\n      ? new Date(userData.last_connection_at as string).getTime() \r\n      : undefined,\r\n    \r\n    // Trial fields\r\n    trialStartedAt: userData.trial_started_at \r\n      ? new Date(userData.trial_started_at as string).getTime() \r\n      : undefined,\r\n    trialExpiresAt: userData.trial_expires_at \r\n      ? new Date(userData.trial_expires_at as string).getTime() \r\n      : undefined,\r\n    \r\n    preferences: jsonToRecord(userData.preferences),\r\n    \r\n    // Legacy nested usage object (kept for backward compatibility)\r\n    usage: {\r\n      textCount,\r\n      imageCount,\r\n      textLimit,\r\n      imageLimit,\r\n      totalRequests,\r\n      lastReset,\r\n      tier,\r\n    },\r\n    \r\n    appState: jsonToRecord(userData.app_state),\r\n    profileData: jsonToRecord(userData.profile_data),\r\n    onboardingData: jsonToRecord(userData.onboarding_data),\r\n    behaviorData: jsonToRecord(userData.behavior_data),\r\n    feedbackData: jsonToRecord(userData.feedback_data),\r\n    usageData: jsonToRecord(userData.usage_data),\r\n    \r\n    createdAt: userData.created_at \r\n      ? new Date(userData.created_at as string).getTime() \r\n      : Date.now(),\r\n    updatedAt: userData.updated_at \r\n      ? new Date(userData.updated_at as string).getTime() \r\n      : Date.now(),\r\n  };\r\n}\r\n","import { supabase } from '../lib/supabase';\r\nimport { User, AuthResult, AuthState, UserTier } from '../types';\r\nimport { TIER_LIMITS } from '../constants';\r\nimport { cacheService } from './cacheService';\r\nimport { ErrorService } from './errorService';\r\nimport { toastService } from './toastService';\r\nimport { jsonToRecord } from '../utils/typeHelpers';\r\nimport { isPWAMode } from '../utils/pwaDetection';\r\nimport { mapUserData } from '../utils/userMapping';\r\nimport { sessionService } from './sessionService';\r\n\r\nexport class AuthService {\r\n  private static instance: AuthService;\r\n  private authState: AuthState = {\r\n    user: null,\r\n    isLoading: true,\r\n    error: null,\r\n  };\r\n\r\n  private listeners: ((state: AuthState) => void)[] = [];\r\n  \r\n  // ‚úÖ SCALABILITY: Using centralized cache and error services\r\n  \r\n  // ‚úÖ PERFORMANCE: Request deduplication for user loading\r\n  private pendingUserLoads = new Map<string, Promise<void>>();\r\n  \r\n  // ‚úÖ SCALABILITY: Memory leak prevention\r\n  private cleanupFunctions: (() => void)[] = [];\r\n  private isDestroyed = false;\r\n\r\n  // Helper to get the correct callback URL for both dev and production\r\n  private getCallbackUrl(): string {\r\n    const origin = window.location.origin;\r\n    const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';\r\n    \r\n    // Check if running in PWA mode\r\n    const isPWA = isPWAMode();\r\n    \r\n    const callback = '/auth/callback';\r\n    \r\n    // For PWA, ensure we use the full URL with proper scheme\r\n    // This helps with OAuth redirects in standalone mode\r\n    if (isPWA) {\r\n      console.log('üîê [AuthService] PWA mode detected, using full callback URL');\r\n      return `${origin}${callback}`;\r\n    }\r\n    \r\n    return `${origin}${callback}`;\r\n  }\r\n\r\n  static getInstance(): AuthService {\r\n    if (!AuthService.instance) {\r\n      AuthService.instance = new AuthService();\r\n    }\r\n    return AuthService.instance;\r\n  }\r\n\r\n  constructor() {\r\n    this.initializeAuth();\r\n    this.setupCleanup();\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Setup cleanup\r\n  private setupCleanup() {\r\n    const cleanup = () => {\r\n      if (!this.isDestroyed) {\r\n        this.cleanup();\r\n      }\r\n    };\r\n    \r\n    window.addEventListener('beforeunload', cleanup);\r\n    this.cleanupFunctions.push(() => {\r\n      window.removeEventListener('beforeunload', cleanup);\r\n    });\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Check rate limit using centralized service\r\n  private async checkRateLimit(identifier: string): Promise<boolean> {\r\n    if (this.isDestroyed) {\r\n      return false;\r\n    }\r\n    \r\n    const rateLimitData = await cacheService.getRateLimit(identifier);\r\n    const now = Date.now();\r\n    \r\n    if (!rateLimitData || now > rateLimitData.resetTime) {\r\n      await cacheService.setRateLimit(identifier, { count: 1, resetTime: now + 15 * 60 * 1000 });\r\n      return true;\r\n    }\r\n    \r\n    if (rateLimitData.count >= 10) {\r\n      return false;\r\n    }\r\n    \r\n    await cacheService.setRateLimit(identifier, { \r\n      count: rateLimitData.count + 1, \r\n      resetTime: rateLimitData.resetTime \r\n    });\r\n    return true;\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Get user from centralized cache\r\n  private async getCachedUser(authUserId: string): Promise<User | null> {\r\n    if (this.isDestroyed) {\r\n      return null;\r\n    }\r\n    \r\n    return await cacheService.getUser<User>(authUserId);\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Cache user data using centralized service\r\n  private async setCachedUser(authUserId: string, user: User): Promise<void> {\r\n    if (this.isDestroyed) {\r\n      return;\r\n    }\r\n    \r\n    await cacheService.setUser(authUserId, user);\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Clear cache using centralized service\r\n  private async clearCache(): Promise<void> {\r\n    await cacheService.clear();\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Invalidate user cache specifically\r\n  private async invalidateUserCache(authUserId: string): Promise<void> {\r\n    const cacheKey = `user:${authUserId}`;\r\n    await cacheService.delete(cacheKey);\r\n  }\r\n\r\n  private async initializeAuth() {\r\n    try {\r\n      // Always initialize auth\r\n\r\n\r\n      // Handle OAuth callback if we're on the callback URL\r\n      // Note: AuthCallback component handles OAuth callbacks, so we skip this\r\n      // to avoid conflicts\r\n      const isAuthCallback = window.location.pathname === '/auth/callback';\r\n      if (isAuthCallback) {\r\n        console.log('üîê [AuthService] OAuth callback detected, but AuthCallback component will handle it');\r\n        return;\r\n      }\r\n\r\n      // Try Supabase auth if available\r\n      try {\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n        \r\n        if (session?.user) {\r\n          await this.loadUserFromSupabase(session.user.id);\r\n        } else {\r\n          this.updateAuthState({ user: null, isLoading: false, error: null });\r\n        }\r\n      } catch (_supabaseError) {\r\n        // Fallback to local storage\r\n        const localUser = localStorage.getItem('otakon_user');\r\n        if (localUser) {\r\n          try {\r\n            const user = JSON.parse(localUser);\r\n            this.updateAuthState({ user, isLoading: false, error: null });\r\n          } catch (_parseError) {\r\n            this.updateAuthState({ user: null, isLoading: false, error: null });\r\n          }\r\n        } else {\r\n          this.updateAuthState({ user: null, isLoading: false, error: null });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Auth initialization error:', error);\r\n      toastService.error('Failed to initialize authentication. Please refresh the page.', {\r\n        action: {\r\n          label: 'Refresh',\r\n          onClick: () => window.location.reload()\r\n        }\r\n      });\r\n      this.updateAuthState({ user: null, isLoading: false, error: null });\r\n    }\r\n  }\r\n\r\n\r\n  private async createUserRecord(authUser: { id: string; email?: string; user_metadata?: Record<string, unknown> }): Promise<void> {\r\n    try {\r\n      console.log('üîê [AuthService] Creating user record for:', authUser.email);\r\n      \r\n      // Get the OAuth provider from the auth user metadata\r\n      // Check multiple possible locations for provider information\r\n      let provider = 'email';\r\n      \r\n      if (authUser.app_metadata?.provider) {\r\n        provider = authUser.app_metadata.provider;\r\n      } else if (authUser.app_metadata?.providers && authUser.app_metadata.providers.length > 0) {\r\n        provider = authUser.app_metadata.providers[0];\r\n      } else if (authUser.identities && authUser.identities.length > 0) {\r\n        provider = authUser.identities[0].provider;\r\n      } else if (authUser.user_metadata?.provider) {\r\n        provider = authUser.user_metadata.provider;\r\n      }\r\n      \r\n      console.log('üîê [AuthService] Auth user metadata:', {\r\n        app_metadata: authUser.app_metadata,\r\n        user_metadata: authUser.user_metadata,\r\n        identities: authUser.identities,\r\n        provider: provider\r\n      });\r\n      console.log('üîê [AuthService] OAuth provider:', provider);\r\n      \r\n      // Use the real email from OAuth provider\r\n      // Supabase auth.users handles uniqueness via auth_user_id\r\n      const userEmail = authUser.email;\r\n      \r\n      console.log('üîê [AuthService] User email:', userEmail);\r\n      \r\n      const { error } = await supabase.rpc('create_user_record', {\r\n        p_auth_user_id: authUser.id,\r\n        p_email: userEmail,\r\n        p_full_name: authUser.user_metadata?.full_name || authUser.user_metadata?.name || 'User',\r\n        p_avatar_url: authUser.user_metadata?.avatar_url,\r\n        p_is_developer: false,\r\n        p_tier: 'free'\r\n      });\r\n\r\n      if (error) {\r\n        // Check if it's a duplicate key error (23505)\r\n        if (error.code === '23505' || error.message?.includes('duplicate key')) {\r\n          console.log('üîê [AuthService] User record already exists (duplicate key), continuing...');\r\n          // This is not actually an error - the user already exists\r\n          return;\r\n        }\r\n        console.error('üîê [AuthService] Error creating user record:', error);\r\n        toastService.error('Failed to create your account. Please try again.');\r\n        throw error;\r\n      }\r\n      \r\n      console.log('üîê [AuthService] User record created successfully');\r\n    } catch (error: unknown) {\r\n      // Check if it's a duplicate key error (23505)\r\n      const err = error as { code?: string; message?: string };\r\n      if (err.code === '23505' || err.message?.includes('duplicate key')) {\r\n        console.log('üîê [AuthService] User record already exists (duplicate key in catch), continuing...');\r\n        // This is not actually an error - the user already exists\r\n        return;\r\n      }\r\n      console.error('üîê [AuthService] Error creating user record:', error);\r\n      toastService.error('Failed to create your account. Please try again.');\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Helper function to extract original email from unique identifier\r\n\r\n\r\n  async loadUserFromSupabase(authUserId: string) {\r\n    // ‚úÖ PERFORMANCE: Check if there's already a pending load for this user\r\n    const existingLoad = this.pendingUserLoads.get(authUserId);\r\n    if (existingLoad) {\r\n      console.log('üîê [AuthService] Deduplicating user load request for:', authUserId);\r\n      return await existingLoad;\r\n    }\r\n\r\n    // Create a new load promise and store it\r\n    const loadPromise = (async () => {\r\n      try {\r\n        await this._loadUserFromSupabaseInternal(authUserId);\r\n      } finally {\r\n        // Clean up the pending request after completion\r\n        this.pendingUserLoads.delete(authUserId);\r\n      }\r\n    })();\r\n    \r\n    this.pendingUserLoads.set(authUserId, loadPromise);\r\n    return await loadPromise;\r\n  }\r\n\r\n  private async _loadUserFromSupabaseInternal(authUserId: string) {\r\n    try {\r\n      // ‚úÖ SCALABILITY: Check cache first\r\n      const cachedUser = await this.getCachedUser(authUserId);\r\n      if (cachedUser) {\r\n        console.log('üîê [AuthService] Using cached user data');\r\n        this.updateAuthState({ user: cachedUser, isLoading: false, error: null });\r\n        return;\r\n      }\r\n\r\n      console.log('üîê [AuthService] Loading user data from database for authUserId:', authUserId);\r\n      \r\n      // Try the RPC function first\r\n      const { data: rpcData, error: rpcError } = await supabase.rpc('get_complete_user_data', {\r\n        p_auth_user_id: authUserId\r\n      });\r\n\r\n      if (rpcError) {\r\n        console.log('üîê [AuthService] RPC function failed, trying direct table query...', rpcError);\r\n        \r\n        // Fallback: Query the table directly\r\n        const { data: tableData, error: tableError } = await supabase\r\n          .from('users')\r\n          .select('*')\r\n          .eq('auth_user_id', authUserId)\r\n          .single();\r\n\r\n        if (tableError) {\r\n          console.error('üîê [AuthService] Direct table query also failed:', tableError);\r\n          this.updateAuthState({ user: null, isLoading: false, error: 'Failed to load user data' });\r\n          return;\r\n        }\r\n\r\n        if (tableData) {\r\n          console.log('üîê [AuthService] User found via direct table query');\r\n          const user = mapUserData(tableData as Record<string, unknown>, authUserId);\r\n\r\n          // ‚úÖ SCALABILITY: Cache user data\r\n          await this.setCachedUser(authUserId, user);\r\n          this.updateAuthState({ user, isLoading: false, error: null });\r\n          return;\r\n        }\r\n      }\r\n\r\n      // If RPC worked, use that data\r\n      if (rpcData && rpcData.length > 0) {\r\n        console.log('üîê [AuthService] User found via RPC function');\r\n        console.log('üîê [AuthService] RPC data:', rpcData[0]);\r\n        const user = mapUserData(rpcData[0] as Record<string, unknown>, authUserId);\r\n\r\n        console.log('üîê [AuthService] User onboarding flags:', {\r\n          hasProfileSetup: user.hasProfileSetup,\r\n          hasSeenSplashScreens: user.hasSeenSplashScreens,\r\n          hasSeenHowToUse: user.hasSeenHowToUse,\r\n          hasSeenFeaturesConnected: user.hasSeenFeaturesConnected,\r\n          hasSeenProFeatures: user.hasSeenProFeatures,\r\n          pcConnected: user.pcConnected,\r\n          pcConnectionSkipped: user.pcConnectionSkipped,\r\n          onboardingCompleted: user.onboardingCompleted\r\n        });\r\n\r\n        // ‚úÖ SCALABILITY: Cache user data\r\n        await this.setCachedUser(authUserId, user);\r\n        this.updateAuthState({ user, isLoading: false, error: null });\r\n      } else {\r\n        // User not found - try to create manually\r\n        console.log('üîê [AuthService] User not found, trying to create manually...');\r\n        try {\r\n          const { data: { user: authUser } } = await supabase.auth.getUser();\r\n          if (authUser) {\r\n            console.log('üîê [AuthService] Creating user record for auth user:', authUser.email);\r\n            await this.createUserRecord(authUser);\r\n            // ‚úÖ PERFORMANCE: Call internal function directly to avoid deadlock with deduplication Map\r\n            await this._loadUserFromSupabaseInternal(authUserId);\r\n          } else {\r\n            this.updateAuthState({ user: null, isLoading: false, error: 'User not found and could not create user record' });\r\n          }\r\n        } catch (createError) {\r\n          console.error('üîê [AuthService] Failed to create user record manually:', createError);\r\n          this.updateAuthState({ user: null, isLoading: false, error: 'User not found and could not create user record' });\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading user from Supabase:', error);\r\n      this.updateAuthState({ user: null, isLoading: false, error: 'Failed to load user data' });\r\n    }\r\n  }\r\n\r\n\r\n  private updateAuthState(newState: Partial<AuthState>) {\r\n    const previousState = { ...this.authState };\r\n    this.authState = { ...this.authState, ...newState };\r\n    \r\n    // Only notify listeners if the state actually changed\r\n    const hasChanged = JSON.stringify(previousState) !== JSON.stringify(this.authState);\r\n    if (hasChanged) {\r\n      this.listeners.forEach(listener => listener(this.authState));\r\n    }\r\n  }\r\n\r\n  // Public methods\r\n  \r\n  // ‚ö†Ô∏è PROTECTED OAUTH FLOW - DO NOT MODIFY WITHOUT WARNING ‚ö†Ô∏è\r\n  // Google OAuth is working correctly - any changes here could break user authentication\r\n  // If you need to modify this, add a warning comment explaining the change\r\n  async signInWithGoogle(): Promise<AuthResult> {\r\n    try {\r\n      // ‚úÖ SCALABILITY: Rate limiting\r\n      if (!(await this.checkRateLimit('google_signin'))) {\r\n        return { success: false, error: 'Too many sign-in attempts. Please wait before trying again.' };\r\n      }\r\n\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      console.log('üîê [AuthService] Starting Google OAuth...');\r\n      const redirectUrl = this.getCallbackUrl();\r\n      console.log('üîê [AuthService] Redirect URL:', redirectUrl);\r\n      \r\n      const { error } = await supabase.auth.signInWithOAuth({\r\n        provider: 'google',\r\n        options: {\r\n          redirectTo: redirectUrl,\r\n          queryParams: {\r\n            prompt: 'select_account' // Force Google account selection\r\n          }\r\n        }\r\n      });\r\n\r\n      if (error) {\r\n        console.error('üîê [AuthService] Google OAuth error:', error);\r\n        toastService.error('Failed to sign in with Google. Please try again.');\r\n        this.updateAuthState({ isLoading: false, error: error.message });\r\n        return { success: false, error: error.message };\r\n      }\r\n\r\n      console.log('üîê [AuthService] Google OAuth initiated successfully');\r\n      return { success: true };\r\n    } catch (error) {\r\n      ErrorService.handleAuthError(error as Error, 'signInWithGoogle');\r\n      toastService.error('Google sign-in failed. Please try again.');\r\n      this.updateAuthState({ \r\n        user: null, \r\n        isLoading: false, \r\n        error: 'Google sign-in failed. Please try again.' \r\n      });\r\n      return { success: false, error: 'Google sign-in failed. Please try again.' };\r\n    }\r\n  }\r\n\r\n  // ‚ö†Ô∏è PROTECTED OAUTH FLOW - DO NOT MODIFY WITHOUT WARNING ‚ö†Ô∏è\r\n  // Discord OAuth is working correctly - any changes here could break user authentication\r\n  // If you need to modify this, add a warning comment explaining the change\r\n  async signInWithDiscord(): Promise<AuthResult> {\r\n    // ‚úÖ SCALABILITY: Rate limiting\r\n    if (!this.checkRateLimit('discord_signin')) {\r\n      return { success: false, error: 'Too many sign-in attempts. Please wait before trying again.' };\r\n    }\r\n\r\n    try {\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      console.log('üîê [AuthService] Starting Discord OAuth...');\r\n      \r\n      // Construct the redirect URL properly using current origin\r\n      const redirectUrl = this.getCallbackUrl();\r\n      console.log('üîê [AuthService] Redirect URL:', redirectUrl);\r\n      console.log('üîê [AuthService] Current origin:', window.location.origin);\r\n      console.log('üîê [AuthService] Current pathname:', window.location.pathname);\r\n      console.log('üîê [AuthService] Current port:', window.location.port);\r\n      console.log('üîê [AuthService] Full URL:', window.location.href);\r\n      \r\n      // Check if we're already on the callback page\r\n      const isAuthCallback = window.location.pathname === '/auth/callback';\r\n      if (isAuthCallback) {\r\n        console.log('üîê [AuthService] Already on callback page, skipping OAuth initiation');\r\n        this.updateAuthState({ isLoading: false, error: null });\r\n        return { success: false, error: 'Already on callback page' };\r\n      }\r\n      \r\n      // Store the current URL for potential error handling\r\n      localStorage.setItem('otakon_discord_auth_attempt', Date.now().toString());\r\n      \r\n      // Initiate Discord OAuth with proper error handling\r\n      console.log('üîê [AuthService] Initiating Discord OAuth with redirectTo:', redirectUrl);\r\n      \r\n      const { data, error } = await supabase.auth.signInWithOAuth({\r\n        provider: 'discord',\r\n        options: {\r\n          redirectTo: redirectUrl,\r\n          queryParams: {\r\n            access_type: 'offline',\r\n            prompt: 'consent',\r\n          }\r\n        }\r\n      });\r\n\r\n      if (error) {\r\n        console.error('üîê [AuthService] Discord OAuth error:', error);\r\n        console.error('üîê [AuthService] Error details:', {\r\n          message: error.message,\r\n          status: error.status\r\n        });\r\n        \r\n        // Provide more specific error messages\r\n        let errorMessage = 'Discord authentication failed. ';\r\n        if (error.message.includes('Invalid redirect URI')) {\r\n          errorMessage += 'Please check Discord OAuth configuration in Supabase dashboard.';\r\n        } else if (error.message.includes('Invalid client')) {\r\n          errorMessage += 'Discord OAuth credentials are invalid. Please check Supabase configuration.';\r\n        } else if (error.message.includes('access_denied')) {\r\n          errorMessage += 'Discord authorization was cancelled.';\r\n        } else {\r\n          errorMessage += error.message;\r\n        }\r\n        \r\n        toastService.error(`Failed to sign in with Discord. ${errorMessage}`);\r\n        this.updateAuthState({ isLoading: false, error: errorMessage });\r\n        return { success: false, error: errorMessage };\r\n      }\r\n\r\n      console.log('üîê [AuthService] Discord OAuth initiated successfully');\r\n      console.log('üîê [AuthService] OAuth data:', data);\r\n      \r\n      // OAuth will redirect, so we return success\r\n      return { success: true };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      console.error('üîê [AuthService] Discord OAuth exception:', error);\r\n      console.error('üîê [AuthService] Exception details:', {\r\n        name: error instanceof Error ? error.name : 'Unknown',\r\n        message: errorMessage,\r\n        stack: error instanceof Error ? error.stack : 'No stack trace'\r\n      });\r\n      \r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n  // ‚ö†Ô∏è PROTECTED EMAIL AUTH FLOW - DO NOT MODIFY WITHOUT WARNING ‚ö†Ô∏è\r\n  // Email authentication is working correctly - any changes here could break user authentication\r\n  // If you need to modify this, add a warning comment explaining the change\r\n  async signInWithEmail(email: string, password: string): Promise<AuthResult> {\r\n    // ‚úÖ SCALABILITY: Rate limiting\r\n    if (!this.checkRateLimit(`email_signin_${email}`)) {\r\n      return { success: false, error: 'Too many sign-in attempts. Please wait before trying again.' };\r\n    }\r\n\r\n    try {\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      console.log('üîê [AuthService] Starting email sign-in...');\r\n      \r\n      const { data, error } = await supabase.auth.signInWithPassword({\r\n        email,\r\n        password\r\n      });\r\n\r\n      if (error) {\r\n        console.error('üîê [AuthService] Email sign-in error:', error);\r\n        \r\n        // Provide more helpful error messages\r\n        let errorMessage = error.message;\r\n        \r\n        if (error.message.includes('Invalid login credentials')) {\r\n          // Check if this might be a provider mismatch issue\r\n          // We can't check the database without authentication, but we can provide a helpful message\r\n          errorMessage = 'Invalid email or password. If you signed up with Google or Discord, please use those options instead.';\r\n        } else if (error.message.includes('Email not confirmed')) {\r\n          errorMessage = 'Please check your email and click the confirmation link before signing in.';\r\n        } else if (error.message.includes('Too many requests')) {\r\n          errorMessage = 'Too many sign-in attempts. Please wait a moment before trying again.';\r\n        }\r\n        \r\n        toastService.error(errorMessage);\r\n        this.updateAuthState({ isLoading: false, error: errorMessage });\r\n        return { success: false, error: errorMessage };\r\n      }\r\n\r\n      if (data.user) {\r\n        console.log('üîê [AuthService] Email sign-in successful:', data.user.email);\r\n        toastService.success('Welcome back! Successfully signed in.');\r\n        // Load user data (this will handle user creation if needed)\r\n        await this.loadUserFromSupabase(data.user.id);\r\n        return { success: true, user: this.authState.user || undefined };\r\n      }\r\n\r\n      return { success: false, error: 'No user data returned' };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      console.error('üîê [AuthService] Email sign-in exception:', error);\r\n      toastService.error('Sign-in failed. Please try again.');\r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n\r\n  // ‚ö†Ô∏è PROTECTED EMAIL AUTH FLOW - DO NOT MODIFY WITHOUT WARNING ‚ö†Ô∏è\r\n  // Email signup is working correctly - any changes here could break user registration\r\n  // If you need to modify this, add a warning comment explaining the change\r\n  async signUpWithEmail(email: string, password: string): Promise<AuthResult> {\r\n    try {\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      console.log('üîê [AuthService] Starting email sign-up...');\r\n      \r\n      const { data, error } = await supabase.auth.signUp({\r\n        email,\r\n        password,\r\n        options: {\r\n          emailRedirectTo: this.getCallbackUrl()\r\n        }\r\n      });\r\n\r\n      // Handle email confirmation errors gracefully\r\n      let isEmailConfirmationDisabled = false;\r\n      if (error) {\r\n        console.error('üîê [AuthService] Email sign-up error:', error);\r\n        \r\n        if (error.message.includes('Error sending confirmation email')) {\r\n          console.log('üîê [AuthService] Email confirmation disabled, proceeding with sign-up...');\r\n          isEmailConfirmationDisabled = true;\r\n          // Continue with the sign-up process even if email confirmation fails\r\n          // This is useful for development when email confirmation is disabled\r\n        } else {\r\n          toastService.error(`Sign-up failed: ${error.message}`);\r\n          this.updateAuthState({ isLoading: false, error: error.message });\r\n          return { success: false, error: error.message };\r\n        }\r\n      }\r\n\r\n      if (data.user) {\r\n        console.log('üîê [AuthService] Email sign-up successful:', data.user.email);\r\n        console.log('üîê [AuthService] User confirmation required:', !data.user.email_confirmed_at);\r\n        \r\n        // Check if email confirmation is required\r\n        if (!data.user.email_confirmed_at) {\r\n          console.log('üîê [AuthService] Email confirmation required, user not yet signed in');\r\n          \r\n          // For development, if email confirmation is disabled, proceed anyway\r\n          if (isEmailConfirmationDisabled) {\r\n            console.log('üîê [AuthService] Email confirmation disabled, creating user record anyway...');\r\n            toastService.success('Account created successfully! Welcome to Otakon!');\r\n            await this.loadUserFromSupabase(data.user.id);\r\n            return { success: true, user: this.authState.user || undefined };\r\n          }\r\n          \r\n          this.updateAuthState({ isLoading: false, error: null });\r\n          return { \r\n            success: true, \r\n            user: undefined, \r\n            requiresConfirmation: true,\r\n            message: 'Please check your email and click the confirmation link to complete your account setup.'\r\n          };\r\n        }\r\n        \r\n        // User is confirmed, load user data\r\n        await this.loadUserFromSupabase(data.user.id);\r\n        return { success: true, user: this.authState.user || undefined };\r\n      }\r\n\r\n      return { success: false, error: 'No user data returned' };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      console.error('üîê [AuthService] Email sign-up exception:', error);\r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n  async resetPassword(email: string): Promise<AuthResult> {\r\n    try {\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n      \r\n      const { error } = await supabase.auth.resetPasswordForEmail(email, {\r\n        redirectTo: this.getCallbackUrl()\r\n      });\r\n\r\n      if (error) {\r\n        this.updateAuthState({ isLoading: false, error: error.message });\r\n        return { success: false, error: error.message };\r\n      }\r\n\r\n      this.updateAuthState({ isLoading: false, error: null });\r\n      return { success: true };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n  async signOut(): Promise<void> {\r\n    try {\r\n      console.log('üîê [AuthService] Starting sign out process...');\r\n      \r\n      // End session tracking before signing out\r\n      await sessionService.endSession();\r\n      \r\n      // Sign out from Supabase FIRST to clear session tokens\r\n      await supabase.auth.signOut();\r\n      \r\n      // Clear ALL Supabase-related localStorage keys (they start with 'sb-')\r\n      const keysToRemove: string[] = [];\r\n      for (let i = 0; i < localStorage.length; i++) {\r\n        const key = localStorage.key(i);\r\n        if (key && key.startsWith('sb-')) {\r\n          keysToRemove.push(key);\r\n        }\r\n      }\r\n      keysToRemove.forEach(key => localStorage.removeItem(key));\r\n      console.log('üîê [AuthService] Cleared Supabase localStorage keys:', keysToRemove);\r\n      \r\n      // Clear all app-specific local storage\r\n      localStorage.removeItem('otakon_auth_method');\r\n      localStorage.removeItem('otakon_remember_me');\r\n      localStorage.removeItem('otakon_remembered_email');\r\n      localStorage.removeItem('otakon_discord_auth_attempt');\r\n      localStorage.removeItem('otakon_has_used_app');\r\n      localStorage.removeItem('otakon_user');\r\n      localStorage.removeItem('otakon_conversations');\r\n      \r\n      // Clear any stored app state\r\n      localStorage.removeItem('otakon_app_state');\r\n      \r\n      // Clear sessionStorage\r\n      sessionStorage.clear();\r\n      \r\n      // ‚úÖ SCALABILITY: Clear cache\r\n      this.clearCache();\r\n      \r\n      // Clear auth state\r\n      this.updateAuthState({ user: null, isLoading: false, error: null });\r\n      \r\n      console.log('üîê [AuthService] Sign out completed successfully');\r\n      toastService.success('Successfully signed out. See you next time!');\r\n    } catch (error) {\r\n      console.error('üîê [AuthService] Sign out error:', error);\r\n      toastService.error('Sign out failed. Please try again.');\r\n      // Even if there's an error, clear the local state\r\n      this.updateAuthState({ user: null, isLoading: false, error: null });\r\n    }\r\n  }\r\n\r\n  getCurrentUser(): User | null {\r\n    return this.authState.user;\r\n  }\r\n\r\n  getAuthState(): AuthState {\r\n    return this.authState;\r\n  }\r\n\r\n\r\n  // Method to clear all user data for testing multiple OAuth providers\r\n  async clearAllUserData(): Promise<void> {\r\n    try {\r\n      console.log('üîê [AuthService] Clearing all user data for testing...');\r\n      \r\n      // Clear localStorage\r\n      localStorage.removeItem('otakon_auth_method');\r\n      localStorage.removeItem('otakon_remember_me');\r\n      localStorage.removeItem('otakon_remembered_email');\r\n      \r\n      // Sign out from Supabase\r\n      await supabase.auth.signOut();\r\n      \r\n      // Clear auth state\r\n      this.updateAuthState({ user: null, isLoading: false, error: null });\r\n      \r\n      console.log('üîê [AuthService] All user data cleared successfully');\r\n    } catch (error) {\r\n      console.error('üîê [AuthService] Error clearing user data:', error);\r\n    }\r\n  }\r\n\r\n  // Method to check which provider was used for a given email\r\n  async checkEmailProvider(email: string): Promise<{ provider: string | null; message: string }> {\r\n    try {\r\n      console.log('üîê [AuthService] Checking provider for email:', email);\r\n      \r\n      // For now, skip provider checking during sign-in to avoid 401 errors\r\n      // This will be handled by the actual sign-in attempt\r\n      console.log('üîê [AuthService] Skipping provider check to avoid 401 errors during sign-in');\r\n      return { provider: null, message: '' };\r\n    } catch (error) {\r\n      console.error('üîê [AuthService] Error checking email provider:', error);\r\n      return { provider: null, message: '' };\r\n    }\r\n  }\r\n\r\n  async resendConfirmationEmail(email: string): Promise<AuthResult> {\r\n    try {\r\n      console.log('üîê [AuthService] Resending confirmation email for:', email);\r\n      this.updateAuthState({ isLoading: true, error: null });\r\n\r\n      const { error } = await supabase.auth.resend({\r\n        type: 'signup',\r\n        email: email,\r\n        options: {\r\n          emailRedirectTo: this.getCallbackUrl()\r\n        }\r\n      });\r\n\r\n      if (error) {\r\n        console.error('üîê [AuthService] Error resending confirmation email:', error);\r\n        toastService.error('Failed to resend confirmation email. Please try again.');\r\n        this.updateAuthState({ isLoading: false, error: error.message });\r\n        return { success: false, error: error.message };\r\n      }\r\n\r\n      console.log('üîê [AuthService] Confirmation email resent successfully');\r\n      toastService.success('Confirmation email sent! Please check your inbox.');\r\n      this.updateAuthState({ isLoading: false, error: null });\r\n      return { \r\n        success: true, \r\n        message: 'Confirmation email sent! Please check your inbox and click the confirmation link.' \r\n      };\r\n    } catch (error) {\r\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n      console.error('üîê [AuthService] Exception resending confirmation email:', error);\r\n      toastService.error('Failed to resend confirmation email. Please try again.');\r\n      this.updateAuthState({ isLoading: false, error: errorMessage });\r\n      return { success: false, error: errorMessage };\r\n    }\r\n  }\r\n\r\n  // Method to test Discord OAuth configuration\r\n  async testDiscordConfiguration(): Promise<{ isValid: boolean; message: string; details: Record<string, unknown> }> {\r\n    try {\r\n      console.log('üîê [AuthService] Testing Discord OAuth configuration...');\r\n      \r\n      // Check if we can access Supabase auth\r\n      const { error: sessionError } = await supabase.auth.getSession();\r\n      if (sessionError) {\r\n        return {\r\n          isValid: false,\r\n          message: 'Cannot access Supabase auth service',\r\n          details: { sessionError }\r\n        };\r\n      }\r\n      \r\n      // For now, assume Discord is available if we can access auth\r\n      // The actual provider check would require a different approach\r\n      // This will be determined by the actual OAuth attempt\r\n      \r\n      // Test redirect URL construction\r\n      const redirectUrl = `${window.location.origin}/auth/callback`;\r\n      console.log('üîê [AuthService] Test redirect URL:', redirectUrl);\r\n      \r\n      return {\r\n        isValid: true,\r\n        message: 'Discord OAuth configuration appears to be valid',\r\n        details: {\r\n          redirectUrl,\r\n          currentOrigin: window.location.origin,\r\n          currentPathname: window.location.pathname\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('üîê [AuthService] Error testing Discord configuration:', error);\r\n      return {\r\n        isValid: false,\r\n        message: 'Error testing Discord configuration',\r\n        details: { error: error instanceof Error ? error.message : 'Unknown error' }\r\n      };\r\n    }\r\n  }\r\n\r\n  async refreshUser(): Promise<void> {\r\n    if (this.authState.user) {\r\n      console.log('üîê [AuthService] Refreshing user data...');\r\n      // Invalidate cache before loading to ensure fresh data\r\n      await this.invalidateUserCache(this.authState.user.authUserId);\r\n      await this.loadUserFromSupabase(this.authState.user.authUserId);\r\n      \r\n      // Start session tracking if not already started\r\n      if (this.authState.user && !sessionService.getCurrentSessionId()) {\r\n        await sessionService.startSession(\r\n          this.authState.user.id,\r\n          this.authState.user.authUserId,\r\n          window.location.pathname\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update user profile preferences\r\n   */\r\n  async updateUserProfile(authUserId: string, profileData: Record<string, unknown>): Promise<void> {\r\n    try {\r\n      // Update in Supabase\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({ profile_data: profileData })\r\n        .eq('auth_user_id', authUserId);\r\n\r\n      if (error) {\r\n        console.error('Error updating profile:', error);\r\n        toastService.error('Failed to update profile. Please try again.');\r\n        throw error;\r\n      }\r\n\r\n      // Invalidate cache and reload user\r\n      await this.invalidateUserCache(authUserId);\r\n      await this.loadUserFromSupabase(authUserId);\r\n      \r\n      console.log('‚úÖ Profile preferences updated successfully');\r\n      toastService.success('Profile updated successfully!');\r\n    } catch (error) {\r\n      console.error('Failed to update profile preferences:', error);\r\n      toastService.error('Failed to update profile. Please try again.');\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  subscribe(listener: (state: AuthState) => void): () => void {\r\n    this.listeners.push(listener);\r\n    \r\n    // Call listener immediately with current state\r\n    listener(this.authState);\r\n    \r\n    // Return unsubscribe function\r\n    return () => {\r\n      const index = this.listeners.indexOf(listener);\r\n      if (index > -1) {\r\n        this.listeners.splice(index, 1);\r\n      }\r\n    };\r\n  }\r\n\r\n  // ‚úÖ SCALABILITY: Cleanup method to prevent memory leaks\r\n  cleanup(): void {\r\n    if (this.isDestroyed) {\r\n      return;\r\n    }\r\n    \r\n    console.log('üßπ [AuthService] Cleaning up...');\r\n    \r\n    this.isDestroyed = true;\r\n    \r\n    // Clear cache\r\n    this.clearCache();\r\n    \r\n    // Rate limiter is now handled by centralized cache service\r\n    \r\n    // Clear listeners\r\n    this.listeners.length = 0;\r\n    \r\n    // Run cleanup functions\r\n    this.cleanupFunctions.forEach(cleanup => {\r\n      try {\r\n        cleanup();\r\n      } catch (error) {\r\n        console.error('Error during auth service cleanup:', error);\r\n      }\r\n    });\r\n    this.cleanupFunctions.length = 0;\r\n    \r\n    console.log('üßπ [AuthService] Cleanup completed');\r\n  }\r\n\r\n}\r\n\r\nexport const authService = AuthService.getInstance();\r\n","import type { Json } from '../types/database';\r\n\r\n/**\r\n * Safely converts a Json type to a Record<string, unknown>\r\n * Returns an empty object if the value is not a valid object\r\n */\r\nexport function jsonToRecord(value: Json | null | undefined): Record<string, unknown> {\r\n  if (!value || typeof value !== 'object' || Array.isArray(value)) {\r\n    return {};\r\n  }\r\n  return value as Record<string, unknown>;\r\n}\r\n\r\n/**\r\n * Safely converts a Json type to a string\r\n * Returns an empty string if the value is not a string\r\n */\r\nexport function jsonToString(value: Json | null | undefined): string {\r\n  if (typeof value === 'string') {\r\n    return value;\r\n  }\r\n  return '';\r\n}\r\n\r\n/**\r\n * Safely converts a Json type to a number\r\n * Returns a default value if the value is not a number\r\n */\r\nexport function jsonToNumber(value: Json | null | undefined, defaultValue: number = 0): number {\r\n  if (typeof value === 'number') {\r\n    return value;\r\n  }\r\n  return defaultValue;\r\n}\r\n\r\n/**\r\n * Safely converts a Json type to a boolean\r\n * Returns a default value if the value is not a boolean\r\n */\r\nexport function jsonToBoolean(value: Json | null | undefined, defaultValue: boolean = false): boolean {\r\n  if (typeof value === 'boolean') {\r\n    return value;\r\n  }\r\n  return defaultValue;\r\n}\r\n\r\n/**\r\n * Safely converts a Json type to an array\r\n * Returns an empty array if the value is not an array\r\n */\r\nexport function jsonToArray<T>(value: Json | null | undefined): T[] {\r\n  if (Array.isArray(value)) {\r\n    return value as T[];\r\n  }\r\n  return [];\r\n}\r\n\r\n/**\r\n * Safely converts a value to Json type\r\n */\r\nexport function toJson(value: unknown): Json {\r\n  if (value === null || value === undefined) {\r\n    return null;\r\n  }\r\n  \r\n  if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\r\n    return value;\r\n  }\r\n  \r\n  if (Array.isArray(value)) {\r\n    return value.map(toJson) as Json[];\r\n  }\r\n  \r\n  if (typeof value === 'object') {\r\n    const obj: { [key: string]: Json | undefined } = {};\r\n    for (const key in value) {\r\n      if (Object.prototype.hasOwnProperty.call(value, key)) {\r\n        obj[key] = toJson((value as Record<string, unknown>)[key]);\r\n      }\r\n    }\r\n    return obj;\r\n  }\r\n  \r\n  return null;\r\n}\r\n\r\n/**\r\n * Safely handles nullable date strings\r\n */\r\nexport function safeParseDate(value: string | null | undefined, defaultValue: number = Date.now()): number {\r\n  if (!value) {\r\n    return defaultValue;\r\n  }\r\n  try {\r\n    return new Date(value).getTime();\r\n  } catch {\r\n    return defaultValue;\r\n  }\r\n}\r\n\r\n/**\r\n * Safely handles nullable strings\r\n */\r\nexport function safeString(value: string | null | undefined, defaultValue: string = ''): string {\r\n  return value ?? defaultValue;\r\n}\r\n\r\n/**\r\n * Safely handles nullable numbers\r\n */\r\nexport function safeNumber(value: number | null | undefined, defaultValue: number = 0): number {\r\n  return value ?? defaultValue;\r\n}\r\n\r\n/**\r\n * Safely handles nullable booleans\r\n */\r\nexport function safeBoolean(value: boolean | null | undefined, defaultValue: boolean = false): boolean {\r\n  return value ?? defaultValue;\r\n}\r\n","import { supabase } from '../lib/supabase';\r\nimport { User, Conversation, Game, UserTier, TrialStatus } from '../types';\r\nimport { USER_TIERS, TIER_LIMITS } from '../constants';\r\nimport { jsonToRecord, safeParseDate, safeBoolean, safeNumber, toJson } from '../utils/typeHelpers';\r\nimport { toastService } from './toastService';\r\nimport { mapUserData } from '../utils/userMapping';\r\n\r\nexport class SupabaseService {\r\n  private static instance: SupabaseService;\r\n\r\n  static getInstance(): SupabaseService {\r\n    if (!SupabaseService.instance) {\r\n      SupabaseService.instance = new SupabaseService();\r\n    }\r\n    return SupabaseService.instance;\r\n  }\r\n\r\n  // User operations\r\n  async getUser(authUserId: string): Promise<User | null> {\r\n    try {\r\n      const { data, error } = await supabase.rpc('get_complete_user_data', {\r\n        p_auth_user_id: authUserId\r\n      });\r\n\r\n      if (error) {\r\n        console.error('Error getting user:', error);\r\n        return null;\r\n      }\r\n\r\n      if (data && data.length > 0) {\r\n        return mapUserData(data[0] as Record<string, unknown>);\r\n      }\r\n\r\n      return null;\r\n    } catch (error) {\r\n      console.error('Error getting user:', error);\r\n      toastService.error('Failed to load user data. Please try again.');\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async updateUser(userId: string, updates: Partial<User>): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          tier: updates.tier,\r\n          has_used_trial: updates.hasUsedTrial,\r\n          last_activity: updates.lastActivity,\r\n          preferences: updates.preferences,\r\n          app_state: updates.appState,\r\n          profile_data: updates.profileData,\r\n          onboarding_data: updates.onboardingData,\r\n          behavior_data: updates.behaviorData,\r\n          feedback_data: updates.feedbackData,\r\n          usage_data: updates.usageData,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error updating user:', error, { userId, updates });\r\n        toastService.error('Failed to update user settings.');\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating user:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async updateUsage(userId: string, usage: { textCount?: number; imageCount?: number; textLimit?: number; imageLimit?: number }): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          text_count: usage.textCount,\r\n          image_count: usage.imageCount,\r\n          text_limit: usage.textLimit,\r\n          image_limit: usage.imageLimit,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error updating usage:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating usage:', error, { userId });\r\n      toastService.error('Failed to update usage data.');\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Conversation operations\r\n  async getConversations(userId: string): Promise<Conversation[]> {\r\n    try {\r\n      // ‚úÖ FIX: Query by auth_user_id directly (matches RLS policies)\r\n      console.log('üîç [Supabase] Querying conversations for auth_user_id:', userId);\r\n      \r\n      // üîç DIAGNOSTIC: Test if Game Hub exists with direct .single() query\r\n      const { data: gameHubTest, error: gameHubError } = await supabase\r\n        .from('conversations')\r\n        .select('id, title, auth_user_id')\r\n        .eq('id', 'game-hub')\r\n        .maybeSingle();\r\n      \r\n      if (gameHubTest) {\r\n        console.log('‚úÖ [Supabase] Game Hub exists via .single():', gameHubTest);\r\n      } else if (gameHubError) {\r\n        console.log('‚ùå [Supabase] Game Hub .single() error:', gameHubError.message);\r\n      } else {\r\n        console.log('üîç [Supabase] Game Hub does not exist yet');\r\n      }\r\n      \r\n      // ‚úÖ RLS WORKAROUND: Try query without filter - RLS should auto-filter by auth.uid()\r\n      // This bypasses potential issues with the auth_user_id column\r\n      const { data: dataNoFilter, error: errorNoFilter } = await supabase\r\n        .from('conversations')\r\n        .select('*')\r\n        .order('updated_at', { ascending: false});\r\n      \r\n      console.log('üîç [Supabase] Unfiltered query result:', {\r\n        error: errorNoFilter?.message,\r\n        count: dataNoFilter?.length || 0,\r\n        firstRow: dataNoFilter && dataNoFilter.length > 0 ? {\r\n          id: dataNoFilter[0].id,\r\n          title: dataNoFilter[0].title,\r\n          auth_user_id: dataNoFilter[0].auth_user_id\r\n        } : null\r\n      });\r\n      \r\n      if (!errorNoFilter && dataNoFilter && dataNoFilter.length > 0) {\r\n        console.log('‚úÖ [Supabase] RLS auto-filtering worked! Returned', dataNoFilter.length, 'conversations');\r\n        return this.mapConversations(dataNoFilter);\r\n      }\r\n      \r\n      // If unfiltered fails, try with explicit filter\r\n      console.log('üîç [Supabase] Trying with explicit auth_user_id filter...');\r\n      const { data, error } = await supabase\r\n        .from('conversations')\r\n        .select('*')\r\n        .eq('auth_user_id', userId)\r\n        .order('updated_at', { ascending: false});\r\n\r\n      if (error) {\r\n        console.error('‚ùå [Supabase] Error getting conversations:', error);\r\n        console.error('‚ùå [Supabase] Error details:', JSON.stringify(error));\r\n        return [];\r\n      }\r\n      \r\n      console.log('‚úÖ [Supabase] Filtered query returned', data.length, 'conversations');\r\n      if (data.length === 0) {\r\n        // üîç If we got 0 results, check session to verify auth context\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n        console.error('üîç [Supabase] Zero results diagnostic:', {\r\n          requestedUserId: userId,\r\n          sessionUserId: session?.user?.id,\r\n          match: session?.user?.id === userId,\r\n          message: 'RLS SELECT policy may be blocking reads'\r\n        });\r\n      }\r\n      return this.mapConversations(data);\r\n    } catch (error) {\r\n      console.error('Error getting conversations:', error);\r\n      toastService.error('Failed to load conversations. Please try again.');\r\n      return [];\r\n    }\r\n  }\r\n  \r\n  private mapConversations(data: Array<Record<string, unknown>>): Conversation[] {\r\n    // üîç DEBUG: Log what we're getting from Supabase\r\n    if (process.env.NODE_ENV === 'development' && data.length > 0) {\r\n      const sample = data[0];\r\n      const messages = sample.messages as import('../types').ChatMessage[];\r\n      const subtabs = sample.subtabs as import('../types').SubTab[];\r\n      console.error('üîç [Supabase] Sample conversation from DB:', {\r\n        id: sample.id,\r\n        title: sample.title,\r\n        messageCount: Array.isArray(messages) ? messages.length : 0,\r\n        hasMessagesField: 'messages' in sample,\r\n        messagesType: typeof messages,\r\n        subtabCount: Array.isArray(subtabs) ? subtabs.length : 0,\r\n        messagesRaw: messages // üîç Let's see the actual data\r\n      });\r\n    }\r\n\r\n    return data.map(conv => {\r\n      const messages = conv.messages as import('../types').ChatMessage[];\r\n      const processedMessages = Array.isArray(messages) ? messages as unknown[] : [];\r\n      \r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.error('üîç [Supabase] Processing conversation:', {\r\n          id: conv.id,\r\n          hasMessages: !!messages,\r\n          isArray: Array.isArray(messages),\r\n          messagesType: typeof messages,\r\n          messageCount: processedMessages.length\r\n        });\r\n      }\r\n      \r\n      return {\r\n        id: conv.id,\r\n        authUserId: conv.auth_user_id ?? undefined,\r\n        userId: conv.user_id ?? undefined,\r\n        title: conv.title,\r\n        messages: processedMessages,\r\n        gameId: conv.game_id ?? undefined,\r\n        gameTitle: conv.game_title ?? undefined,\r\n        genre: conv.genre ?? undefined,\r\n        subtabs: Array.isArray(conv.subtabs) ? conv.subtabs as unknown[] : [],\r\n        subtabsOrder: conv.subtabs_order || [],\r\n        isActiveSession: conv.is_active_session,\r\n        activeObjective: conv.active_objective ?? undefined,\r\n        gameProgress: conv.game_progress ?? undefined,\r\n        createdAt: safeParseDate(conv.created_at),\r\n        updatedAt: safeParseDate(conv.updated_at),\r\n        isActive: conv.is_active,\r\n        isPinned: conv.is_pinned ?? undefined,\r\n        pinnedAt: conv.pinned_at ? new Date(conv.pinned_at).getTime() : undefined,\r\n        isGameHub: conv.is_game_hub ?? undefined,\r\n        isUnreleased: conv.is_unreleased ?? undefined,\r\n        contextSummary: conv.context_summary ?? undefined,\r\n        lastSummarizedAt: conv.last_summarized_at ? new Date(conv.last_summarized_at).getTime() : undefined,\r\n      };\r\n    }) as Conversation[];\r\n  }\r\n\r\n  async createConversation(userId: string, conversation: Omit<Conversation, 'createdAt' | 'updatedAt'> & { id?: string }): Promise<string | null> {\r\n    try {\r\n      // ‚úÖ Verify session is active\r\n      const { data: { session } } = await supabase.auth.getSession();\r\n      console.log('üîç [Supabase] Current session user:', session?.user?.id, 'vs provided userId:', userId);\r\n      \r\n      if (!session || session.user.id !== userId) {\r\n        console.error('‚ùå [Supabase] Session mismatch! RLS will block reads. Session:', session?.user?.id, 'vs userId:', userId);\r\n      }\r\n      \r\n      // ‚úÖ FIX: Use auth_user_id directly instead of RPC function\r\n      // The RPC function get_user_id_from_auth_id was causing issues\r\n      // Now we use auth_user_id (which references auth.users.id) directly\r\n      // This matches the RLS policies which check auth_user_id = auth.uid()\r\n      \r\n      const insertData: Record<string, unknown> = {\r\n        auth_user_id: userId, // ‚úÖ Direct auth user ID\r\n        title: conversation.title,\r\n        messages: conversation.messages,\r\n        game_id: conversation.gameId,\r\n        game_title: conversation.gameTitle,\r\n        genre: conversation.genre,\r\n        subtabs: conversation.subtabs || [],\r\n        subtabs_order: conversation.subtabsOrder || [],\r\n        is_active_session: conversation.isActiveSession,\r\n        active_objective: conversation.activeObjective,\r\n        game_progress: conversation.gameProgress,\r\n        is_active: conversation.isActive,\r\n        is_pinned: conversation.isPinned,\r\n        pinned_at: conversation.pinnedAt ? new Date(conversation.pinnedAt).toISOString() : null,\r\n        is_game_hub: conversation.isGameHub,\r\n      };\r\n      \r\n      // ‚úÖ CRITICAL: For Game Hub, use the provided ID to maintain consistency\r\n      if (conversation.id) {\r\n        insertData.id = conversation.id;\r\n      }\r\n      \r\n      // ‚úÖ FIX: Use UPSERT to handle duplicate Game Hub (409 Conflict)\r\n      // If a conversation with this ID exists, update it instead of failing\r\n      console.log('üîç [Supabase] Upserting conversation:', {\r\n        id: insertData.id,\r\n        title: insertData.title,\r\n        auth_user_id: insertData.auth_user_id,\r\n        is_game_hub: insertData.is_game_hub,\r\n        is_active: insertData.is_active\r\n      });\r\n      \r\n      const { data, error } = await supabase\r\n        .from('conversations')\r\n        .upsert(insertData, { \r\n          onConflict: 'id',\r\n          ignoreDuplicates: false // Update existing record\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('‚ùå [Supabase] Error creating/updating conversation:', error);\r\n        console.error('‚ùå [Supabase] Error details:', JSON.stringify(error));\r\n        return null;\r\n      }\r\n\r\n      console.log('‚úÖ [Supabase] Conversation upserted successfully:', data.id);\r\n      \r\n      // ‚úÖ Verify we can read it back immediately with full data\r\n      const { data: verifyData, error: verifyError } = await supabase\r\n        .from('conversations')\r\n        .select('*')\r\n        .eq('id', data.id)\r\n        .single();\r\n      \r\n      if (verifyError) {\r\n        console.error('‚ö†Ô∏è [Supabase] Cannot read back conversation after upsert!', verifyError.message);\r\n        console.error('‚ö†Ô∏è [Supabase] This indicates RLS SELECT policy is blocking reads');\r\n      } else {\r\n        console.log('‚úÖ [Supabase] Verified conversation data:', {\r\n          id: verifyData.id,\r\n          title: verifyData.title,\r\n          auth_user_id: verifyData.auth_user_id,\r\n          auth_user_id_type: typeof verifyData.auth_user_id,\r\n          is_game_hub: verifyData.is_game_hub\r\n        });\r\n        \r\n        // üîç Check if this row would pass RLS\r\n        const { data: { session } } = await supabase.auth.getSession();\r\n        if (session?.user?.id !== verifyData.auth_user_id) {\r\n          console.error('üö® [Supabase] AUTH_USER_ID MISMATCH!', {\r\n            sessionUserId: session?.user?.id,\r\n            rowAuthUserId: verifyData.auth_user_id,\r\n            match: false\r\n          });\r\n        } else {\r\n          console.log('‚úÖ [Supabase] auth_user_id matches session perfectly');\r\n        }\r\n      }\r\n      \r\n      return data.id;\r\n    } catch (error) {\r\n      console.error('Error creating conversation:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async updateConversation(conversationId: string, updates: Partial<Conversation>): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('conversations')\r\n        .update({\r\n          title: updates.title,\r\n          messages: updates.messages ? toJson(updates.messages) : undefined,\r\n          game_id: updates.gameId,\r\n          game_title: updates.gameTitle,\r\n          genre: updates.genre,\r\n          subtabs: updates.subtabs ? toJson(updates.subtabs) : undefined,\r\n          subtabs_order: updates.subtabsOrder,\r\n          is_active_session: updates.isActiveSession,\r\n          active_objective: updates.activeObjective,\r\n          game_progress: updates.gameProgress,\r\n          is_active: updates.isActive,\r\n          is_pinned: updates.isPinned,\r\n          pinned_at: updates.pinnedAt ? new Date(updates.pinnedAt).toISOString() : null,\r\n          is_game_hub: updates.isGameHub,\r\n          is_unreleased: updates.isUnreleased,\r\n          context_summary: updates.contextSummary,\r\n          last_summarized_at: updates.lastSummarizedAt ? updates.lastSummarizedAt : null,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('id', conversationId);\r\n\r\n      if (error) {\r\n        console.error('Error updating conversation:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error updating conversation:', error, { conversationId });\r\n      toastService.error('Failed to update conversation.');\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async deleteConversation(conversationId: string): Promise<boolean> {\r\n    try {\r\n      const { error } = await supabase\r\n        .from('conversations')\r\n        .delete()\r\n        .eq('id', conversationId);\r\n\r\n      if (error) {\r\n        console.error('Error deleting conversation:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error deleting conversation:', error, { conversationId });\r\n      toastService.error('Failed to delete conversation. Please try again.');\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Message operations\r\n  async getGames(userId: string): Promise<Game[]> {\r\n    try {\r\n      // ‚úÖ OPTIMIZED: Direct auth_user_id comparison (no JOIN needed)\r\n      // RLS policy enforces ownership via games.auth_user_id = auth.uid()\r\n      const { data, error } = await supabase\r\n        .from('games')\r\n        .select('*')\r\n        .eq('auth_user_id', userId)\r\n        .order('created_at', { ascending: false });\r\n\r\n      if (error) {\r\n        console.error('Error getting games:', error);\r\n        return [];\r\n      }\r\n\r\n      return data.map(game => ({\r\n        id: game.id,\r\n        title: game.title,\r\n        description: game.notes ?? undefined,\r\n        genre: game.genre ?? undefined,\r\n        platform: game.platform ?? undefined,\r\n        releaseDate: '',\r\n        rating: game.rating ?? undefined,\r\n        imageUrl: game.cover_url ?? undefined,\r\n        metadata: jsonToRecord(game.metadata),\r\n        createdAt: safeParseDate(game.created_at),\r\n        updatedAt: safeParseDate(game.updated_at),\r\n      }));\r\n    } catch (error) {\r\n      console.error('Error getting games:', error);\r\n      return [];\r\n    }\r\n  }\r\n\r\n  async createGame(userId: string, game: Omit<Game, 'id' | 'createdAt' | 'updatedAt'>): Promise<string | null> {\r\n    try {\r\n      // ‚úÖ OPTIMIZED: Use database function to resolve user_id in single operation\r\n      const { data: userIdData, error: userIdError } = await supabase\r\n        .rpc('get_user_id_from_auth_id', { p_auth_user_id: userId });\r\n\r\n      if (userIdError || !userIdData) {\r\n        console.error('Error resolving user ID:', userIdError);\r\n        return null;\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from('games')\r\n        .insert({\r\n          user_id: userIdData,\r\n          auth_user_id: userId, // ‚úÖ Store auth_user_id for direct RLS checks\r\n          title: game.title,\r\n          notes: game.description,\r\n          genre: game.genre,\r\n          platform: game.platform,\r\n          rating: game.rating,\r\n          cover_url: game.imageUrl,\r\n          metadata: game.metadata,\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error creating game:', error);\r\n        return null;\r\n      }\r\n\r\n      return data.id;\r\n    } catch (error) {\r\n      console.error('Error creating game:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  // Trial operations\r\n  async getTrialStatus(userId: string): Promise<TrialStatus | null> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('has_used_trial, trial_started_at, trial_expires_at')\r\n        .eq('auth_user_id', userId)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error getting trial status:', error);\r\n        return null;\r\n      }\r\n\r\n      const now = Date.now();\r\n      const trialExpiresAt = data.trial_expires_at ? new Date(data.trial_expires_at).getTime() : null;\r\n      const isActive = trialExpiresAt ? now < trialExpiresAt : false;\r\n      const daysRemaining = trialExpiresAt ? Math.ceil((trialExpiresAt - now) / (1000 * 60 * 60 * 24)) : 0;\r\n\r\n      return {\r\n        isEligible: !data.has_used_trial,\r\n        hasUsed: safeBoolean(data.has_used_trial),\r\n        isActive,\r\n        expiresAt: trialExpiresAt || undefined,\r\n        daysRemaining: isActive ? daysRemaining : undefined,\r\n      };\r\n    } catch (error) {\r\n      console.error('Error getting trial status:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async startTrial(userId: string): Promise<boolean> {\r\n    try {\r\n      const trialExpiresAt = new Date();\r\n      trialExpiresAt.setDate(trialExpiresAt.getDate() + 14);\r\n\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          has_used_trial: true,\r\n          trial_started_at: new Date().toISOString(),\r\n          trial_expires_at: trialExpiresAt.toISOString(),\r\n          tier: USER_TIERS.PRO,\r\n          text_limit: TIER_LIMITS[USER_TIERS.PRO].text,\r\n          image_limit: TIER_LIMITS[USER_TIERS.PRO].image,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error starting trial:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error starting trial:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Usage operations\r\n  async canMakeRequest(userId: string, requestType: 'text' | 'image'): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('text_count, image_count, text_limit, image_limit, tier')\r\n        .eq('auth_user_id', userId)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error checking usage:', error);\r\n        return false;\r\n      }\r\n\r\n      if (requestType === 'text') {\r\n        return safeNumber(data.text_count) < safeNumber(data.text_limit);\r\n      } else {\r\n        return safeNumber(data.image_count) < safeNumber(data.image_limit);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error checking usage:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async incrementUsage(userId: string, requestType: 'text' | 'image'): Promise<boolean> {\r\n    try {\r\n      // First, get the current usage data\r\n      const { data: userData, error: fetchError } = await supabase\r\n        .from('users')\r\n        .select('usage_data')\r\n        .eq('auth_user_id', userId)\r\n        .single();\r\n\r\n      if (fetchError) {\r\n        console.error('Error fetching user data:', fetchError);\r\n        return false;\r\n      }\r\n\r\n      // Get current usage counts\r\n      const currentUsage = jsonToRecord(userData?.usage_data) as { textCount?: number; imageCount?: number; totalRequests?: number };\r\n\r\n      // Increment the appropriate counter\r\n      const textCount = requestType === 'text' ? (currentUsage.textCount || 0) + 1 : (currentUsage.textCount || 0);\r\n      const imageCount = requestType === 'image' ? (currentUsage.imageCount || 0) + 1 : (currentUsage.imageCount || 0);\r\n      \r\n      const updatedUsage = {\r\n        textCount,\r\n        imageCount,\r\n        totalRequests: (currentUsage.totalRequests || 0) + 1,\r\n      };\r\n\r\n      // Update the usage_data JSONB field\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          usage_data: toJson(updatedUsage),\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error incrementing usage:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error incrementing usage:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async resetUsage(userId: string): Promise<boolean> {\r\n    try {\r\n      // Reset counters but preserve limits\r\n      const resetUsage = {\r\n        textCount: 0,\r\n        imageCount: 0,\r\n        totalRequests: 0,\r\n        lastReset: Date.now()\r\n      };\r\n\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .update({\r\n          usage_data: toJson(resetUsage),\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('auth_user_id', userId);\r\n\r\n      if (error) {\r\n        console.error('Error resetting usage:', error);\r\n        return false;\r\n      }\r\n\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error resetting usage:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // ‚úÖ Query-based usage tracking (replaces message-based limits)\r\n  async recordQuery(authUserId: string, queryType: 'text' | 'image'): Promise<boolean> {\r\n    try {\r\n      const { data, error } = await supabase.rpc('increment_user_usage', {\r\n        p_auth_user_id: authUserId,\r\n        p_query_type: queryType,\r\n        p_increment: 1\r\n      });\r\n\r\n      if (error) {\r\n        console.error('Error recording query:', error);\r\n        return false;\r\n      }\r\n\r\n      return data === true;\r\n    } catch (error) {\r\n      console.error('Error recording query:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async getQueryUsage(authUserId: string): Promise<{ textCount: number; imageCount: number; textLimit: number; imageLimit: number; lastReset: Date } | null> {\r\n    try {\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('text_count, image_count, text_limit, image_limit, last_reset')\r\n        .eq('auth_user_id', authUserId)\r\n        .single();\r\n\r\n      if (error) {\r\n        console.error('Error getting query usage:', error);\r\n        return null;\r\n      }\r\n\r\n      return {\r\n        textCount: data.text_count || 0,\r\n        imageCount: data.image_count || 0,\r\n        textLimit: data.text_limit || 55,\r\n        imageLimit: data.image_limit || 25,\r\n        lastReset: new Date(data.last_reset || Date.now())\r\n      };\r\n    } catch (error) {\r\n      console.error('Error getting query usage:', error);\r\n      return null;\r\n    }\r\n  }\r\n}\r\n\r\nexport const supabaseService = SupabaseService.getInstance();\r\n"],"names":["isPWAMode","markAppAsInstalled","jsonToRecord","value","mapUserData","userData","authUserId","tier","textLimit","_a","TIER_LIMITS","imageLimit","_b","textCount","imageCount","totalRequests","lastReset","_AuthService","__publicField","origin","isPWA","callback","cleanup","identifier","rateLimitData","cacheService","now","user","cacheKey","session","supabase","localUser","error","toastService","authUser","provider","_c","userEmail","_d","_e","_f","_g","err","_h","existingLoad","loadPromise","cachedUser","rpcData","rpcError","tableData","tableError","createError","newState","previousState","listener","redirectUrl","ErrorService","data","errorMessage","email","password","isEmailConfirmationDisabled","sessionService","keysToRemove","i","key","sessionError","profileData","index","AuthService","authService","toJson","obj","safeParseDate","defaultValue","safeString","safeNumber","safeBoolean","_SupabaseService","userId","updates","usage","gameHubTest","gameHubError","dataNoFilter","errorNoFilter","conv","messages","processedMessages","conversation","insertData","verifyData","verifyError","conversationId","game","userIdData","userIdError","trialExpiresAt","isActive","daysRemaining","USER_TIERS","requestType","fetchError","currentUsage","updatedUsage","resetUsage","queryType","SupabaseService","supabaseService"],"mappings":"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"}