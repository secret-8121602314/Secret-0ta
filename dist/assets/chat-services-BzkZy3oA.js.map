{"version":3,"mappings":"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","names":["ConnectionStatus","newsPrompts","insightTabsConfig","USER_TIERS","TIER_LIMITS","STORAGE_KEYS","GAME_HUB_ID","DEFAULT_CONVERSATION_TITLE","supabaseService","SupabaseService","ConversationService","authService","__vitePreload","n","user","error","StorageService","textCount","textLimit","tier","toastService","imageCount","imageLimit","skipCache","userId","conversations","acc","conv","needsUpdate","retryCount","existingConvs","existingIds","c","savePromises","delay","resolve","toastService2","err","title","id","now","isGameHub","conversationId","conversation","creationPromise","newId","updates","message","m","chatMemoryService","cacheService","_a","subTabId","content","updatedSubTabs","tab","hydrateSubtabs","cachedConversations","existingGameHub","gameHub","isActive","progress","objective","__publicField","USE_EDGE_FUNCTION","HarmCategory","HarmBlockThreshold","AIService","supabaseUrl","request","session","supabase","response","result","candidate","_b","userMessage","isActiveSession","hasImages","imageData","abortSignal","dedupKey","pendingRequest","requestPromise","conversationService","queryCheck","messageHash","str","hash","i","char","cacheKey","cachedResponse","sessionContext","playerProfile","basePrompt","getPromptForPersona","immersionContext","characterImmersionService","prompt","rawContent","imageBase64","modelName","tools","edgeResponse","cleanContent","tags","parseOtakonTags","aiResponse","errorMessage","recoveryAction","errorRecoveryService","structuredInstructions","needsWebSearch","modelToUse","mimeType","base64Data","SchemaType","safetyCheck","rawResponse","structuredData","gamePillData","jsonError","context","gameTitle","genre","conversationContext","contextHash","cachedInsights","config","instructions","profile","profileAwareTabService","profileContext","contextSection","t","responseText","cleanedJson","insights","parseError","fixedJson","lastCompleteProperty","match","openBraces","closeBraces","missingTabs","aiService"],"ignoreList":[],"sources":["../../src/types/index.ts","../../src/constants/index.ts","../../src/services/conversationService.ts","../../src/services/aiService.ts"],"sourcesContent":["// User Types\r\nexport type UserTier = 'free' | 'pro' | 'vanguard_pro';\r\nexport type AuthMethod = 'google' | 'discord' | 'email';\r\n\r\n// Connection Status\r\nexport enum ConnectionStatus {\r\n  DISCONNECTED = 'DISCONNECTED',\r\n  CONNECTING = 'CONNECTING',\r\n  CONNECTED = 'CONNECTED',\r\n  ERROR = 'ERROR',\r\n}\r\n\r\nexport interface User {\r\n  id: string;\r\n  authUserId: string;\r\n  email: string;\r\n  tier: UserTier;\r\n  hasProfileSetup: boolean;\r\n  hasSeenSplashScreens: boolean;\r\n  hasSeenHowToUse: boolean;\r\n  hasSeenFeaturesConnected: boolean;\r\n  hasSeenProFeatures: boolean;\r\n  pcConnected: boolean;\r\n  pcConnectionSkipped: boolean;\r\n  onboardingCompleted: boolean;\r\n  hasWelcomeMessage: boolean;\r\n  isNewUser: boolean;\r\n  hasUsedTrial: boolean;\r\n  lastActivity: number;\r\n  // Query-based usage limits (from database)\r\n  textCount: number;\r\n  imageCount: number;\r\n  textLimit: number;\r\n  imageLimit: number;\r\n  totalRequests: number;\r\n  lastReset: number; // Unix timestamp (ms) - converted from DB timestamptz\r\n  // PC Connection fields (from database)\r\n  connectionCode?: string; // 6-digit pairing code for PC client\r\n  connectionCodeCreatedAt?: number; // Unix timestamp (ms) when code was generated\r\n  connectionActive?: boolean; // Whether PC connection is currently active\r\n  connectionDeviceInfo?: Record<string, any>; // Device information from PC client\r\n  lastConnectionAt?: number; // Unix timestamp (ms) of last successful connection\r\n  // Trial fields (from database)\r\n  trialStartedAt?: number; // Unix timestamp (ms) - converted from DB timestamptz\r\n  trialExpiresAt?: number; // Unix timestamp (ms) - converted from DB timestamptz\r\n  // Legacy nested usage object (kept for backward compatibility)\r\n  preferences: Record<string, any>;\r\n  usage: Usage;\r\n  appState: Record<string, any>;\r\n  profileData: Record<string, any>;\r\n  onboardingData: Record<string, any>;\r\n  behaviorData: Record<string, any>;\r\n  feedbackData: Record<string, any>;\r\n  usageData: Record<string, any>;\r\n  createdAt: number;\r\n  updatedAt: number;\r\n}\r\n\r\nexport interface Usage {\r\n  textCount: number;\r\n  imageCount: number;\r\n  textLimit: number;\r\n  imageLimit: number;\r\n  totalRequests: number;\r\n  lastReset: number;\r\n  tier: UserTier;\r\n}\r\n\r\n// App State\r\nexport type AppView = 'landing' | 'app';\r\nexport type OnboardingStatus = 'login' | 'initial' | 'features' | 'pro-features' | 'how-to-use' | 'features-connected' | 'tier-splash' | 'profile-setup' | 'complete' | 'loading';\r\nexport type ActiveModal = 'about' | 'privacy' | 'refund' | 'contact' | 'terms' | 'settings' | 'connection' | 'hands-free' | 'credit' | 'otaku-diary' | 'wishlist' | null;\r\n\r\nexport interface AppState {\r\n  view: AppView;\r\n  onboardingStatus: OnboardingStatus;\r\n  activeSubView: string;\r\n  isConnectionModalOpen: boolean;\r\n  isHandsFreeModalOpen: boolean;\r\n  isSettingsModalOpen: boolean;\r\n  isCreditModalOpen: boolean;\r\n  isOtakuDiaryModalOpen: boolean;\r\n  isWishlistModalOpen: boolean;\r\n  activeModal: ActiveModal;\r\n  isHandsFreeMode: boolean;\r\n  showUpgradeScreen: boolean;\r\n  showDailyCheckin: boolean;\r\n  currentAchievement: any | null;\r\n  loadingMessages: string[];\r\n  isCooldownActive: boolean;\r\n  isFirstTime: boolean;\r\n  contextMenu: any | null;\r\n  feedbackModalState: any | null;\r\n  confirmationModal: any | null;\r\n  trialEligibility: {\r\n    isEligible: boolean;\r\n    hasUsedTrial: boolean;\r\n  } | null;\r\n}\r\n\r\n// Chat Types\r\nexport interface ChatMessage {\r\n  id: string;\r\n  content: string;\r\n  role: 'user' | 'assistant' | 'system';\r\n  timestamp: number;\r\n  imageUrl?: string;\r\n  metadata?: Record<string, any>;\r\n}\r\n\r\nexport interface Conversation {\r\n  id: string; // TEXT type in DB - supports custom IDs like 'game-hub'\r\n  authUserId?: string; // Direct auth.users.id reference for RLS policies\r\n  userId?: string; // Legacy internal users.id reference (still in DB)\r\n  title: string;\r\n  messages: ChatMessage[];\r\n  gameId?: string;\r\n  gameTitle?: string;\r\n  genre?: string;\r\n  subtabs?: SubTab[];\r\n  subtabsOrder?: string[];\r\n  isActiveSession?: boolean;\r\n  activeObjective?: string;\r\n  gameProgress?: number;\r\n  createdAt: number;\r\n  updatedAt: number;\r\n  isActive: boolean;\r\n  isPinned?: boolean;\r\n  pinnedAt?: number;\r\n  isGameHub?: boolean; // Identifies the default Game Hub conversation - only one per user\r\n  isUnreleased?: boolean; // True for unreleased/upcoming games - no Playing mode, no subtabs\r\n  contextSummary?: string; // AI-generated summary of conversation history (max 500 words, text-only)\r\n  lastSummarizedAt?: number; // Unix timestamp (ms) of when context_summary was last updated\r\n}\r\n\r\nexport interface Conversations {\r\n  [id: string]: Conversation;\r\n}\r\n\r\n// Game Types\r\nexport interface Game {\r\n  id: string;\r\n  userId?: string; // Internal users.id reference\r\n  authUserId?: string; // Direct auth.users.id for RLS policies\r\n  title: string;\r\n  description?: string; // Maps to DB 'notes' field\r\n  genre?: string;\r\n  platform?: string;\r\n  status?: 'playing' | 'completed' | 'backlog' | 'wishlist'; // From DB CHECK constraint\r\n  progress?: number; // Percentage or custom progress value\r\n  playtimeHours?: number; // Total playtime in hours\r\n  tags?: string[]; // Array stored as JSONB in DB\r\n  rating?: number;\r\n  imageUrl?: string; // Maps to DB 'cover_url' field\r\n  metadata: Record<string, any>;\r\n  createdAt: number;\r\n  updatedAt: number;\r\n}\r\n\r\n// Waitlist Types\r\nexport interface WaitlistEntry {\r\n  id: string;\r\n  email: string;\r\n  source: string;\r\n  createdAt: number;\r\n  status: 'pending' | 'approved' | 'rejected'; // Match DB CHECK constraint\r\n  invitedAt?: number; // Unix timestamp (ms) when user was invited\r\n  emailSentAt?: number; // Unix timestamp (ms) when email was sent\r\n  emailStatus?: 'pending' | 'sent' | 'failed'; // Email delivery status\r\n  updatedAt: number;\r\n}\r\n\r\n// Trial Types\r\nexport interface TrialStatus {\r\n  isEligible: boolean;\r\n  hasUsed: boolean;\r\n  isActive: boolean;\r\n  expiresAt?: number;\r\n  daysRemaining?: number;\r\n}\r\n\r\n// Player Profile Types\r\nexport interface PlayerProfile {\r\n  hintStyle: 'Cryptic' | 'Balanced' | 'Direct';\r\n  playerFocus: 'Story-Driven' | 'Completionist' | 'Strategist';\r\n  preferredTone: 'Encouraging' | 'Professional' | 'Casual';\r\n  spoilerTolerance: 'Strict' | 'Moderate' | 'Relaxed';\r\n}\r\n\r\n// Auth Types\r\nexport interface AuthResult {\r\n  success: boolean;\r\n  error?: string;\r\n  user?: User;\r\n  requiresConfirmation?: boolean;\r\n  message?: string;\r\n}\r\n\r\nexport interface AuthState {\r\n  user: User | null;\r\n  isLoading: boolean;\r\n  error: string | null;\r\n}\r\n\r\n// AI Types\r\nexport interface SubTab {\r\n  id: string;\r\n  conversationId: string; // PRIMARY foreign key to conversations.id (required in DB)\r\n  gameId?: string; // DEPRECATED in DB (nullable) - use conversationId instead\r\n  title: string;\r\n  content: string;\r\n  type: 'chat' | 'walkthrough' | 'tips' | 'strategies' | 'story' | 'characters' | 'items';\r\n  orderIndex?: number; // For sorting subtabs (from DB order_index)\r\n  metadata?: Record<string, any>; // Additional data stored as JSONB in DB\r\n  createdAt?: number; // Unix timestamp (ms)\r\n  updatedAt?: number; // Unix timestamp (ms)\r\n  // Client-side only fields (not in DB)\r\n  isNew: boolean;\r\n  status: 'loading' | 'loaded' | 'error';\r\n  instruction?: string;\r\n}\r\n\r\nexport interface GameTab {\r\n  id: string; // Will correspond to conversationId\r\n  title: string;\r\n  gameId: string; // From OTAKON tag\r\n  gameTitle: string;\r\n  genre: string;\r\n  subtabs: SubTab[];\r\n  createdAt: number;\r\n  updatedAt: number;\r\n  isActiveSession?: boolean;\r\n}\r\n\r\nexport interface AIResponse {\r\n  content: string; // The user-facing text\r\n  suggestions: string[];\r\n  otakonTags: Map<string, any>; // Parsed OTAKON tags\r\n  rawContent: string; // Full response before stripping tags\r\n  metadata: {\r\n    model: string;\r\n    timestamp: number;\r\n    cost: number;\r\n    tokens: number;\r\n    fromCache?: boolean;\r\n  };\r\n  // Enhanced fields from old build (optional for backward compatibility)\r\n  followUpPrompts?: string[]; // 3-4 contextual suggested prompts\r\n  gamePillData?: {\r\n    shouldCreate: boolean;\r\n    gameName: string;\r\n    genre: string;\r\n    wikiContent: Record<string, string>; // Pre-filled subtab content\r\n  };\r\n  progressiveInsightUpdates?: Array<{\r\n    tabId: string;\r\n    title: string;\r\n    content: string;\r\n  }>;\r\n  suggestedTasks?: Array<{\r\n    title: string;\r\n    description: string;\r\n    category: string;\r\n    confidence: number;\r\n    source: string;\r\n  }>;\r\n  stateUpdateTags?: string[]; // Game state changes (OBJECTIVE_COMPLETE, TRIUMPH, etc.)\r\n}\r\n\r\nexport interface ActiveSessionState {\r\n  isActive: boolean;\r\n  currentGameId?: string; // Corresponds to conversation.id\r\n}\r\n\r\n// Configuration constants\r\nexport const newsPrompts: string[] = [\r\n  \"What's the latest gaming news?\",\r\n  \"Which games are releasing soon?\",\r\n  \"What are the latest game reviews?\",\r\n  \"Show me the hottest new game trailers.\",\r\n];\r\n\r\nexport const insightTabsConfig: Record<string, Omit<SubTab, 'conversationId' | 'content' | 'isNew' | 'status'>[]> = {\r\n  'Default': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'missed_items', title: 'Items You May Have Missed', type: 'items', instruction: \"Based on the player's current progress, identify 2-3 significant items, secrets, or side quests they might have overlooked in areas they have already visited. Provide clear, actionable hints about their locations without giving away the exact solution. Use landmarks and environmental descriptions. Example: 'In the Whispering Caverns, a waterfall hides more than just a damp cave wall.'\" },\r\n    { id: 'game_lore', title: 'Relevant Lore', type: 'story', instruction: \"Provide a fascinating, detailed, spoiler-free piece of lore about the game's world, characters, or backstory that is relevant to the player's current situation or recent events. This should be a deep-dive, not a short summary.\" },\r\n    { id: 'build_guide', title: 'Build Guide', type: 'strategies', instruction: \"Suggest one or two detailed, effective character builds or loadouts using items and skills available up to the current progress point. Be specific about the synergy between components, stat allocation, and how the build excels in the player's current or upcoming challenges.\" },\r\n    { id: 'next_session_plan', title: 'Plan Your Next Session', type: 'tips', instruction: \"Based on the player's progress and story so far, clearly list 3-4 concrete objectives or tasks they can tackle in their next gameplay session. This should include a mix of main quests, important side quests, and interesting areas to explore next. Provide a brief, compelling reason for each suggestion.\" },\r\n  ],\r\n  'Action RPG': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'quest_log', title: 'Active Quests', type: 'walkthrough', instruction: \"Summarize the active main quest and suggest 2-3 relevant side quests available in the current area. Explain the potential rewards or story connections.\" },\r\n    { id: 'build_optimization', title: 'Build Optimization', type: 'strategies', instruction: \"Analyze the player's likely stats and gear. Suggest 2-3 specific improvements, like stat allocation changes, better weapon affinities, or spells that synergize with their build.\" },\r\n    { id: 'boss_strategy', title: 'Upcoming Boss Strategy', type: 'strategies', instruction: \"A significant challenge may lie ahead. **Do not name the upcoming boss or describe its appearance.** Instead, provide clear, actionable tactical advice based on its likely attack patterns and weaknesses. Suggest effective weapon types, armor properties, status effects, and specific strategies (e.g., 'This foe is relentless up close; focus on ranged attacks and stay mobile,' or 'Its armor is vulnerable to fire damage; enchanted weapons will be key.'). The advice should be practical, not metaphorical.\" },\r\n    { id: 'hidden_paths', title: 'Hidden Paths & Secrets', type: 'tips', instruction: \"Hint at a secret path or hidden area nearby that the player may have missed. **Do not give explicit directions.** Instead, provide a clear clue tied to a specific landmark or environmental feature. The goal is to make the player think 'Aha!' not 'Huh?'. Example: 'The large statue in the Grand Hall seems to be pointing at a specific tapestry on the wall...' or 'Listen for the sound of running water behind the library's northern bookshelf.'\" },\r\n    { id: 'missed_items', title: 'Items You May Have Missed', type: 'items', instruction: \"Based on the player's current progress and story position, identify 2-3 significant items, weapons, armor pieces, or collectibles they might have overlooked in areas they have already visited or passed through. Provide clear, actionable hints about their locations using landmarks and environmental descriptions, without giving away the exact solution. Focus on items that would be valuable at their current level. Example: 'In the Crystalline Caverns you traversed earlier, a shimmering waterfall conceals more than just spray and stone.' or 'The merchant in Oldtown mentioned a hidden cache near the western bridge - look for the statue with the broken sword.'\" },\r\n    { id: 'points_of_interest', title: 'Points of Interest', type: 'tips', instruction: \"Identify 2-3 noteworthy locations, optional bosses, or side missions currently accessible that offer exceptional rewards such as rare loot, significant experience gains, unique gear upgrades, or compelling narrative content. Explain what makes each location valuable (without spoiling specific rewards) and provide hints about access requirements, recommended level/gear, or optimal timing. Focus on content that enhances the player's current build or progression path.\" },\r\n    { id: 'npc_interactions', title: 'NPC Interactions', type: 'tips', instruction: \"Identify 2-3 important NPCs in currently accessible areas whose questlines, merchant inventories, or dialogue options provide valuable rewards, story insights, or gameplay advantages. Highlight what makes each NPC worth seeking out (e.g., 'sells rare spell components', 'unlocks fast travel', 'provides critical lore') without spoiling their full storyline. Include hints about where to find them or conditions to unlock their interactions.\" },\r\n    { id: 'consumable_strategy', title: 'Consumable Strategy', type: 'strategies', instruction: \"Suggest optimal use of consumables (potions, buffs, food, throwables) based on the player's current challenges and upcoming content. Include crafting or purchasing priorities, when to save rare consumables versus using them freely, and specific consumable combinations that synergize well. Provide practical advice like 'Stock up on fire resistance potions before heading north' or 'Those expensive stat buffs are worth using for the arena challenges ahead.'\" },\r\n  ],\r\n  'RPG': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'character_building', title: 'Character Building', type: 'strategies', instruction: \"Provide detailed character building advice including stat allocation, skill trees, and class optimization based on the player's current progress and available options.\" },\r\n    { id: 'combat_strategies', title: 'Combat Strategies', type: 'strategies', instruction: \"Detail effective combat strategies, party composition advice, and tactical approaches for current or upcoming challenges.\" },\r\n    { id: 'quest_guide', title: 'Quest Guide', type: 'walkthrough', instruction: \"Provide guidance on active quests, including main story quests and important side quests. Include rewards and story connections.\" },\r\n    { id: 'lore_exploration', title: 'Lore Exploration', type: 'story', instruction: \"Dive deep into the game's lore, world-building, and backstory relevant to the player's current progress without spoiling future revelations.\" },\r\n    { id: 'missed_items', title: 'Items You May Have Missed', type: 'items', instruction: \"Based on the player's current progress, identify 2-3 significant items, equipment pieces, or collectibles they might have overlooked in previously visited areas. Provide clear location hints using landmarks without explicit directions. Focus on items valuable for current level and build.\" },\r\n    { id: 'points_of_interest', title: 'Points of Interest', type: 'tips', instruction: \"Identify 2-3 noteworthy locations or side missions in accessible areas that offer exceptional rewards (legendary items, significant XP, unique abilities) or compelling narrative content. Explain their value and provide access hints or timing recommendations.\" },\r\n    { id: 'companion_management', title: 'Companion Management', type: 'strategies', instruction: \"Provide detailed companion strategies including optimal party composition for current challenges, relationship building priorities, companion-specific quests worth pursuing, and how to maximize each companion's combat effectiveness and story benefits. Include romance options if applicable and not yet spoiled.\" },\r\n    { id: 'side_activity_guide', title: 'Side Activity Guide', type: 'tips', instruction: \"Highlight worthwhile side activities (mini-games, crafting systems, farming spots, card games, romance options, housing) currently available. Explain rewards, time investment required, and how these activities enhance main gameplay or provide useful resources. Prioritize activities that offer tangible benefits over pure novelty.\" },\r\n  ],\r\n  'First-Person Shooter': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'loadout_analysis', title: 'Loadout Analysis', type: 'strategies', instruction: \"Analyze the probable current weapon loadout. Suggest 2 alternative, powerful loadouts (primary, secondary, equipment) for the current situation or map, explaining the strategic advantage of each.\" },\r\n    { id: 'map_strategies', title: 'Map Strategies', type: 'strategies', instruction: \"Provide 3 key strategic tips for the likely current map or area, focusing on positioning, flanking routes, and objective control.\" },\r\n    { id: 'enemy_intel', title: 'Enemy Intel', type: 'tips', instruction: \"You'll encounter new threats in this zone. **Do not name the enemy types or describe their appearance in a way that spoils their reveal.** Describe their behavior, attack patterns, and a key vulnerability in a tactical, in-universe way. The advice must be actionable. For example: 'Some hostiles carry volatile canisters on their backs. A well-placed shot could trigger a chain reaction.' or 'Listen for a high-pitched whine; it signals a devastating charge you must evade immediately.'\" },\r\n    { id: 'pro_tips', title: 'Pro Tips', type: 'tips', instruction: \"Offer 3 advanced tips or 'pro strats' for this game that a new player might not know, such as movement tricks, ability combos, or unusual weapon uses.\" },\r\n    { id: 'weapon_mastery', title: 'Weapon Mastery', type: 'strategies', instruction: \"Detail advanced techniques for 2-3 currently available or recently unlocked weapons. Include recoil control patterns, optimal engagement ranges, attachment synergies, burst vs. full-auto usage, and situational applications. Provide practical tips that separate average accuracy from expert precision, such as 'The assault rifle's recoil pulls up-right after the 7th shot - compensate by pulling down-left' or 'This SMG excels in slide-shooting; maintain momentum while firing for maximum effectiveness.'\" },\r\n    { id: 'audio_cues', title: 'Audio Cues Guide', type: 'tips', instruction: \"Explain 3-4 critical audio cues players should actively listen for: distinct footstep sounds (enemy vs. teammate), reload audio tells, ability activation sounds, or environmental audio that signals danger. Include how to use sound to predict enemy movements, anticipate pushes, and gain information advantage. Example: 'Heavy footsteps with metallic clanking indicate armored enemies - they move slower but hit harder.' or 'A whistling sound precedes explosive ordnance by 2 seconds.'\" },\r\n    { id: 'progression_tracker', title: 'Progression Tracker', type: 'tips', instruction: \"Analyze current unlock progress and identify 2-3 priority objectives or challenges worth focusing on. Highlight weapons, attachments, equipment, or abilities that are close to unlocking and particularly valuable for the player's playstyle or current campaign progress. Include estimated time/kills needed and why each unlock is worthwhile. Example: 'You're 15 headshots away from unlocking the holographic sight for your rifle - this will significantly improve target acquisition in close quarters.'\" },\r\n  ],\r\n  'Strategy': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'current_board_state', title: 'Current State Analysis', type: 'strategies', instruction: \"Analyze the current game state (e.g., board position, resources, army composition). Provide a high-level summary of strengths, weaknesses, and immediate threats.\" },\r\n    { id: 'opening_moves', title: 'Opening Builds', type: 'strategies', instruction: \"Describe 2-3 popular and effective opening strategies or build orders for the player's faction or starting position.\" },\r\n    { id: 'unit_counters', title: 'Unit Counters', type: 'strategies', instruction: \"Intelligence suggests the enemy will deploy units with specific strengths. **Do not name the enemy units.** Instead, describe their function (e.g., 'fast-moving aerial threats', 'heavily armored ground forces') and suggest specific, effective counters from the player's available arsenal. Explain *why* the counter works (e.g., '...because your Stinger units have tracking projectiles that are effective against agile air targets.').\" },\r\n    { id: 'economy_guide', title: 'Economy Management', type: 'tips', instruction: \"Provide 3 tips for optimizing resource generation and spending at the player's current stage of the game.\" },\r\n    { id: 'tech_tree_priority', title: 'Tech Tree Priority', type: 'strategies', instruction: \"Recommend optimal technology research paths based on current match situation and observable enemy strategy. Explain which technologies provide immediate tactical advantage versus long-term strategic investment. Include timing considerations (e.g., 'Rush this tech before 10-minute mark for advantage' or 'Delay this expensive research until economy is stable'). Prioritize 2-3 tech paths that synergize with current army composition or counter enemy builds.\" },\r\n    { id: 'map_control_points', title: 'Map Control Points', type: 'strategies', instruction: \"Identify 3-4 critical map locations for the current match: expansion points, defensive chokepoints, high-ground positions, or resource-rich areas. Provide tactical advice on securing and holding these positions, including suggested unit compositions, defensive structures, and timing windows. Explain the strategic value of each location (e.g., 'Controlling the central bridge cuts enemy reinforcement routes in half' or 'The northern high ground provides vision over their main base').\" },\r\n    { id: 'opponent_analysis', title: 'Opponent Analysis', type: 'strategies', instruction: \"Based on observable enemy actions, unit compositions, and expansion patterns, predict 2-3 likely strategies they might employ. Suggest effective counter-measures for each possibility, including timing windows to exploit, key vulnerabilities to target, and defensive preparations. Use scout information and game sense rather than speculation. Example: 'Enemy has two barracks and is massing light infantry - prepare anti-infantry defenses and consider fast tech to armored units.'\" },\r\n  ],\r\n  'Adventure': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'exploration_tips', title: 'Exploration Tips', type: 'tips', instruction: \"Provide helpful exploration tips for the current area, including how to find hidden paths, secrets, and collectibles without explicit spoilers.\" },\r\n    { id: 'puzzle_solving', title: 'Puzzle Solving', type: 'strategies', instruction: \"Offer guidance on current or recent puzzles, providing hints that lead the player toward the solution without giving it away entirely.\" },\r\n    { id: 'story_progression', title: 'Story Progression', type: 'walkthrough', instruction: \"Guide the player through story progression, outlining what to do next while maintaining suspense and avoiding future spoilers.\" },\r\n    { id: 'hidden_secrets', title: 'Hidden Secrets', type: 'tips', instruction: \"Hint at hidden secrets, collectibles, or optional content the player may have missed, using environmental clues and landmarks.\" },\r\n    { id: 'missed_items', title: 'Items You May Have Missed', type: 'items', instruction: \"Based on the player's current progress and location, identify 2-3 collectible items, hidden treasures, or optional discoveries they may have overlooked in recently visited areas. Provide environmental clues (e.g., 'behind waterfall', 'requires returning with later ability') without exact coordinates. Explain the value of each item (e.g., 'grants permanent health boost' or 'unlocks secret ending requirement'). Focus on items within reasonable backtracking distance.\" },\r\n    { id: 'points_of_interest', title: 'Points of Interest', type: 'tips', instruction: \"Identify 2-3 noteworthy locations, landmarks, or environmental storytelling elements the player can explore in their current area. Highlight hidden pathways, scenic vistas, lore-rich locations, or interactive elements that enrich the experience. Include gentle hints about what makes each location special (e.g., 'The ancient mural on the temple wall depicts the civilization's creation myth' or 'Examining the clockwork mechanism reveals its connection to the tower's defense system'). Encourage curiosity-driven exploration.\" },\r\n    { id: 'inventory_optimization', title: 'Inventory Optimization', type: 'tips', instruction: \"Provide guidance on current inventory management: which items to keep/sell/discard, optimal loadouts for upcoming exploration, and suggestions for freeing inventory space. Identify items that have hidden utility or can be combined/upgraded. Warn about unique items that should never be sold. Recommend 2-3 essential tools or consumables to carry for upcoming area types (e.g., 'Stock rope for upcoming mountain region' or 'Keep fire-resistant potions for volcanic caves').\" },\r\n    { id: 'environmental_storytelling', title: 'Environmental Storytelling', type: 'story', instruction: \"Highlight 2-3 environmental details in the player's current area that tell a story through level design, object placement, or visual clues. Explain what these elements reveal about the world, past events, or character backgrounds. Examples: 'The scattered children's toys and barricaded doors suggest families fled in panic' or 'The overgrown machinery indicates this factory has been abandoned for decades.' Connect environmental clues to broader narrative themes when relevant.\" },\r\n  ],\r\n  'Simulation': [\r\n    { id: 'goal_suggestions', title: 'Goal Suggestions', type: 'tips', instruction: \"Based on the current state, suggest 3 short-term and 1 long-term goal to work towards. For example, expanding a facility, achieving a milestone, or unlocking a new technology.\" },\r\n    { id: 'efficiency_tips', title: 'Efficiency & Optimization', type: 'strategies', instruction: \"Provide 3 actionable tips for improving the efficiency of the player's current setup, such as optimizing a production line, improving traffic flow, or managing finances better.\" },\r\n    { id: 'hidden_mechanics', title: 'Hidden Mechanics', type: 'tips', instruction: \"Explain one non-obvious game mechanic that can significantly impact gameplay, which the player may not be aware of yet.\" },\r\n    { id: 'disaster_prep', title: 'Disaster Prep', type: 'strategies', instruction: \"Great endeavors are often tested. **Do not name the specific disaster or event.** Hint at a potential future challenge in a thematic way and suggest 2-3 concrete, preventative measures. For example: 'The markets are fickle; diversifying your income streams and building a cash reserve can weather any financial storm.' or 'The earth sometimes trembles. Ensuring your infrastructure is reinforced near fault lines could prevent a catastrophe.'\" },\r\n    { id: 'milestone_roadmap', title: 'Milestone Roadmap', type: 'strategies', instruction: \"Based on current progress, outline a clear path to the next 2-3 major milestones or unlocks. Break down each milestone into actionable steps with estimated resource/time requirements. Prioritize objectives that unlock new gameplay systems or significantly expand capabilities. Example: 'Reaching 10,000 population unlocks regional policies - requires zoning 15 residential blocks, upgrading water infrastructure, and establishing bus routes. Estimated: 2-3 hours gameplay.' Adjust complexity to match simulation type.\" },\r\n    { id: 'bottleneck_analysis', title: 'System Bottleneck Analysis', type: 'strategies', instruction: \"Identify 2-3 critical bottlenecks or inefficiencies limiting current growth or performance. Explain what's being constrained (production, traffic, resources, etc.), why it's happening, and provide specific solutions with expected impact. Examples: 'Cargo trains waiting at junction - add parallel track or staging area to increase throughput 40%' or 'Power generation at 95% capacity - brownouts imminent in 10 game-days, build coal plant now or solar farm for sustainability.' Focus on highest-impact fixes.\" },\r\n    { id: 'expansion_strategy', title: 'Expansion Strategy', type: 'strategies', instruction: \"Provide strategic guidance for next expansion phase: optimal location analysis, required infrastructure investments, risk assessment, and growth sequencing. Consider terrain advantages, resource proximity, transportation connections, and defensive positioning (if applicable). Recommend whether to expand existing areas or establish new zones. Include budget estimates and prerequisite systems. Example: 'Northern valley offers flat terrain near ore deposits - requires tunnel through mountain (50k), but reduces transport costs 30%. Alternative: expand eastward with existing roads but lower resource yield.'\" },\r\n  ],\r\n  'Sports': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'team_management', title: 'Team Management', type: 'strategies', instruction: \"Analyze the current team composition and suggest 2-3 strategic improvements. Consider player stats, chemistry, formation adjustments, or tactical changes that could enhance performance based on the current season progress.\" },\r\n    { id: 'training_focus', title: 'Training Focus', type: 'tips', instruction: \"Based on the current team's strengths and weaknesses, recommend specific training priorities. Suggest which players need development, what skills to focus on, and how to prepare for upcoming challenges.\" },\r\n    { id: 'tactical_analysis', title: 'Tactical Analysis', type: 'strategies', instruction: \"Provide detailed tactical advice for the current situation. This could include formation strategies, player positioning, set-piece tactics, or counter-strategies against specific opponents you've faced or are about to face.\" },\r\n    { id: 'season_progression', title: 'Season Progression', type: 'walkthrough', instruction: \"Outline the key objectives and milestones for the current season phase. Suggest realistic goals, important matches to focus on, and strategic decisions that could impact the team's long-term success.\" },\r\n    { id: 'transfer_market_insights', title: 'Transfer Market Insights', type: 'strategies', instruction: \"Based on team needs, budget constraints, and current season performance, identify 2-3 high-value transfer targets or academy prospects. Provide scouting intel on each candidate: strengths, weaknesses, estimated cost, contract details, and fit with team chemistry. Alternatively, suggest players to sell/loan who are underperforming or surplus to requirements. Include market timing advice (e.g., 'Wait until January window for better deals' or 'Act fast before competitors bid').\" },\r\n    { id: 'injury_fatigue_management', title: 'Injury & Fatigue Management', type: 'tips', instruction: \"Analyze current squad fitness levels and injury risks based on match schedule intensity. Identify 3-4 players at high fatigue/injury risk and recommend rotation strategies, rest periods, or medical priorities. Suggest optimal lineup rotations for upcoming fixture congestion (e.g., 'Rotate 4 starters for midweek cup match to preserve fitness for weekend league game'). Include recovery timeline for injured players and tactical adjustments to compensate for absences.\" },\r\n    { id: 'opposition_scouting', title: 'Opposition Scouting', type: 'strategies', instruction: \"Provide tactical dossier on next opponent or recent adversary: their formation, key players, tactical patterns, set-piece threats, and defensive vulnerabilities. Recommend counter-tactics, player matchups, and specific game plan adjustments. Example: 'Opponent plays high defensive line - exploit with through balls to pacy forwards. Mark #10 tightly as they control buildup play. Vulnerable to crosses from right flank.' Include mentality recommendations (aggressive press, cautious defense, etc.).\" },\r\n  ],\r\n  'Multiplayer Shooter': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'meta_analysis', title: 'Meta Analysis', type: 'strategies', instruction: \"Analyze the current meta and suggest 2-3 effective loadouts or strategies. Consider weapon balance, map-specific tactics, and counter-strategies against popular playstyles in the current meta.\" },\r\n    { id: 'team_coordination', title: 'Team Coordination', type: 'strategies', instruction: \"Provide advanced team play strategies. Suggest communication tactics, role assignments, positioning strategies, and how to counter common enemy team compositions or strategies.\" },\r\n    { id: 'map_control', title: 'Map Control', type: 'strategies', instruction: \"Offer detailed map control strategies for the current or upcoming maps. Include key positions, rotation paths, objective control tactics, and how to maintain map dominance.\" },\r\n    { id: 'skill_development', title: 'Skill Development', type: 'tips', instruction: \"Identify specific skills to improve based on current performance. Suggest aim training routines, movement techniques, game sense improvements, or mechanical skills that could elevate gameplay.\" },\r\n    { id: 'ranked_climbing_guide', title: 'Ranked Climbing Guide', type: 'strategies', instruction: \"Based on current rank and performance patterns, provide tailored advice for climbing ranked ladder. Identify 2-3 strategic focus areas: decision-making improvements, role mastery, clutch situations, mental game, or team synergy. Include rank-specific advice (e.g., 'At Silver, focus on crosshair placement over flick shots' or 'At Diamond, VOD review losses to eliminate repeated mistakes'). Suggest realistic rank goals and estimated timeline based on dedication level.\" },\r\n    { id: 'warmup_routine', title: 'Warm-up Routine', type: 'tips', instruction: \"Design a 10-15 minute pre-session warm-up routine tailored to current skill level and weaknesses. Include aim training exercises, movement drills, utility practice, and mental preparation. Specify training map/mode recommendations and target benchmarks. Example: '5 mins aim trainer (tracking + flicking), 5 mins deathmatch for movement, 3 mins utility lineups for tonight's map pool, 2 mins breathing exercises for focus.' Adjust for casual vs competitive sessions.\" },\r\n    { id: 'counter_meta_strategies', title: 'Counter-Meta Strategies', type: 'strategies', instruction: \"Identify 2-3 currently dominant strategies, compositions, or playstyles in the meta and provide specific counter-tactics. Explain the underlying principle of why each meta strategy is strong, then detail positional adjustments, utility usage, timing windows, or unconventional plays that exploit weaknesses. Example: 'Meta favors aggressive rushes - counter with early utility stacking at choke points and off-angle positions for crossfire.' Include when to adapt vs when to stick to fundamentals.\" },\r\n  ],\r\n  'Multiplayer Sports': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'competitive_strategy', title: 'Competitive Strategy', type: 'strategies', instruction: \"Analyze the competitive landscape and suggest strategies for ranked/competitive play. Consider meta shifts, opponent tendencies, and advanced tactics that separate good players from great ones.\" },\r\n    { id: 'team_synergy', title: 'Team Synergy', type: 'strategies', instruction: \"Provide advice on building effective team compositions and strategies. Suggest player combinations, communication protocols, and how to maximize team chemistry and coordination.\" },\r\n    { id: 'performance_optimization', title: 'Performance Optimization', type: 'tips', instruction: \"Offer specific tips for improving individual and team performance. Include practice routines, skill development priorities, and how to adapt to different opponents and playstyles.\" },\r\n    { id: 'ranked_progression', title: 'Ranked Progression', type: 'walkthrough', instruction: \"Outline a strategic approach to climbing ranks. Suggest focus areas, common mistakes to avoid, and how to maintain consistency in competitive matches.\" },\r\n    { id: 'seasonal_meta_shifts', title: 'Seasonal Meta Shifts', type: 'strategies', instruction: \"Analyze recent patches, balance changes, or seasonal updates affecting competitive meta. Identify 2-3 newly viable strategies, player builds, or team compositions gaining traction. Explain what changed and why it's effective now. Suggest adaptations to stay competitive: 'Patch increased stamina drain - prioritize possession over aggressive pressing' or 'New skill moves buffed - practice step-over combinations for 1v1 situations.' Include declining strategies to avoid.\" },\r\n    { id: 'communication_protocols', title: 'Communication Protocols', type: 'tips', instruction: \"Establish efficient team communication standards for competitive play. Define callout systems, priority information hierarchy, and tone management under pressure. Provide 3-4 communication best practices: concise enemy location calls, rotation announcements, resource status updates, morale management. Include examples: 'Call positioning before play starts, not during' or 'Use player numbers for quick identification.' Address tilt management and constructive feedback between teammates.\" },\r\n    { id: 'vod_review_focus', title: 'VOD Review Focus Points', type: 'strategies', instruction: \"Provide structured framework for reviewing recent match recordings (VODs). Identify 3-4 key analysis areas based on current rank/skill: decision-making mistakes, positioning errors, mechanical execution, team coordination breakdowns. Suggest specific moments to review: 'Rewatch all defensive breakdowns - identify first positioning error that led to goal' or 'Analyze successful opponent plays - what did they exploit?' Include self-assessment questions and improvement action items.\" },\r\n  ],\r\n  'Racing': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'vehicle_tuning', title: 'Vehicle Tuning', type: 'strategies', instruction: \"Analyze the current vehicle setup and suggest tuning adjustments. Consider track characteristics, weather conditions, and racing style to recommend optimal configurations for current or upcoming races.\" },\r\n    { id: 'track_strategy', title: 'Track Strategy', type: 'strategies', instruction: \"Provide detailed racing strategies for current or upcoming tracks. Include braking points, racing lines, overtaking opportunities, and how to handle specific track sections or challenges.\" },\r\n    { id: 'race_craft', title: 'Race Craft', type: 'tips', instruction: \"Offer advanced racing techniques and strategies. Include defensive driving, overtaking tactics, pit stop strategies, and how to manage tire wear and fuel consumption effectively.\" },\r\n    { id: 'championship_focus', title: 'Championship Focus', type: 'walkthrough', instruction: \"Outline strategic priorities for the current championship or season. Suggest which races to focus on, points management strategies, and how to maximize championship potential.\" },\r\n    { id: 'weather_adaptation', title: 'Weather Adaptation', type: 'strategies', instruction: \"Provide detailed strategies for adapting to current or forecasted weather conditions. Explain setup adjustments (tire compound selection, aerodynamics, brake bias, differential settings), driving technique modifications (throttle control, braking points, racing line variations), and timing decisions (when to pit for weather-appropriate tires). Include risk assessment for mixed conditions: 'Light rain expected lap 15 - monitor grip levels, be first to switch intermediates for track position advantage' or 'Drying line forming - gradually shift to outer edge for grip while maintaining defensive position.'\" },\r\n    { id: 'qualifying_strategy', title: 'Qualifying Strategy', type: 'strategies', instruction: \"Outline optimal qualifying approach based on track characteristics, tire allocation, and session format. Recommend out-lap timing to avoid traffic, optimal number of flying laps per tire set, and track evolution strategy. Example: 'First 5 minutes: banker lap on used tires for safety, final 3 minutes: two push laps on fresh softs when track is grippiest' or 'Monaco qualifying - prioritize first run before red flags, save set for Q3.' Include fuel load considerations and when to sacrifice Q1 position for better race tire allocation.\" },\r\n    { id: 'rival_analysis', title: 'Rival Analysis', type: 'strategies', instruction: \"Analyze 2-3 key championship rivals or immediate competitors: their driving style, common mistakes, overtaking patterns, and defensive weaknesses. Provide tactical advice for racing against each: 'Rival A brakes deep into Turn 1 - stay close through final corner for slipstream advantage' or 'Rival B struggles with tire management - apply pressure in middle stint to force errors.' Include qualifying pace comparison and strategic opportunities to gain points (e.g., 'They're weak in wet - maximize rain sessions').\" },\r\n  ],\r\n  'Fighting': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'character_analysis', title: 'Character Analysis', type: 'strategies', instruction: \"Analyze the current character's strengths, weaknesses, and optimal playstyle. Suggest advanced techniques, combo routes, and how to maximize the character's potential in different matchups.\" },\r\n    { id: 'matchup_strategy', title: 'Matchup Strategy', type: 'strategies', instruction: \"Provide detailed matchup strategies against common opponents. Include character-specific tactics, counter-strategies, and how to exploit opponent weaknesses while covering your own.\" },\r\n    { id: 'execution_training', title: 'Execution Training', type: 'tips', instruction: \"Suggest specific training routines to improve execution and consistency. Include combo practice, timing drills, and techniques to master difficult inputs or advanced mechanics.\" },\r\n    { id: 'tournament_prep', title: 'Tournament Prep', type: 'tips', instruction: \"Outline preparation strategies for competitive play. Include mental preparation, warm-up routines, and how to maintain peak performance during extended tournament sessions.\" },\r\n    { id: 'frame_data_insights', title: 'Frame Data Insights', type: 'strategies', instruction: \"Provide actionable frame data analysis for current character and recent opponents. Identify 3-4 key situations: 'Your jab is 4f - fastest punish for small gaps', 'Opponent's sweep is -12 on block - guaranteed launcher punish', 'Your overhead is reactable at 28f - use as mixup after conditioning with lows.' Explain practical applications: which moves are safe on block, optimal punishes by frame advantage, and frame trap setups. Avoid overwhelming technical detail - focus on game-changing information.\" },\r\n    { id: 'adaptation_tactics', title: 'Mid-Match Adaptation', type: 'strategies', instruction: \"Teach pattern recognition and adaptation strategies during matches. Identify 3-4 common opponent habits to exploit: 'They mash jab after blocking - frame trap with delayed normal', 'Jump-happy opponents - meet with anti-air or bait and punish landing', 'Always techs throws left - shimmy or throw right.' Include defensive adaptation: recognizing pressure gaps, escaping opponent's mixups, and adjusting to their preferred ranges. Provide mental framework: observe patterns for 1 round, then counter-adapt.\" },\r\n    { id: 'character_lab_work', title: 'Character Lab Work', type: 'tips', instruction: \"Outline 3-4 high-priority training mode objectives for current character mastery. Include: optimal punish combos by startup frame (light/medium/heavy punish), safe pressure strings with frame trap extensions, meaty setups after knockdowns, and option select techniques. Example: 'Lab anti-air conversions into corner carry combos - gives positioning advantage worth 20% extra damage opportunity.' Prioritize practical situations over max damage. Include 'homework': specific scenarios to practice for 15 mins before next session.\" },\r\n  ],\r\n  'Battle Royale': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'drop_strategy', title: 'Drop Strategy', type: 'strategies', instruction: \"Analyze optimal landing locations and early-game strategies. Consider loot quality, player density, and how to maximize survival chances while securing good equipment for the mid-game.\" },\r\n    { id: 'positioning_tactics', title: 'Positioning Tactics', type: 'strategies', instruction: \"Provide advanced positioning strategies for different phases of the match. Include rotation timing, zone management, and how to maintain advantageous positions while avoiding third-party situations.\" },\r\n    { id: 'loadout_optimization', title: 'Loadout Optimization', type: 'strategies', instruction: \"Suggest optimal weapon combinations and equipment priorities. Consider current meta, personal playstyle, and how to adapt loadouts based on available loot and enemy compositions.\" },\r\n    { id: 'endgame_strategy', title: 'Endgame Strategy', type: 'strategies', instruction: \"Offer detailed endgame tactics and positioning. Include final circle strategies, engagement timing, and how to maximize win probability in high-pressure final situations.\" },\r\n    { id: 'rotation_management', title: 'Rotation Management', type: 'strategies', instruction: \"Provide strategic guidance for zone rotations across all game phases. Analyze current circle position and suggest optimal rotation paths that balance safety, loot opportunities, and positional advantage. Include timing windows: 'Rotate early (60s before zone closes) for first pick of power positions' vs 'Rotate late to third-party fighting teams.' Identify dangerous chokepoints, alternative routes, and vehicle usage decisions. Recommend high-ground positions and natural cover along rotation path. Adjust strategy for circle RNG.\" },\r\n    { id: 'audio_warfare', title: 'Audio Warfare', type: 'tips', instruction: \"Teach advanced audio awareness and sound-based tactics. Explain how to: identify enemy direction/distance by footsteps, gunfire, and ability sounds; use silence strategically when approaching or hiding; make noise deliberately to bait or misdirect opponents. Provide 3-4 actionable tips: 'Crouch-walk final circles to stay undetected', 'Count gunshots to know when enemies are reloading', 'Use environmental sounds (vehicles, doors) to mask your approach', 'Recognize weapon types by audio signature to predict enemy loadout.' Include headphone settings advice.\" },\r\n    { id: 'inventory_economy', title: 'Inventory Economy', type: 'strategies', instruction: \"Optimize inventory management and resource allocation throughout match. Define item priority hierarchy based on playstyle and current situation: ammunition ratios (how much per weapon), healing item distribution (shields vs health), utility selection (grenades, mobility items). Recommend drop decisions when inventory is full: 'Drop excess light ammo after 240 rounds - pick up grenades for late-game utility.' Include looting speed tips, death box prioritization, and when to risk looting vs rotating. Adjust recommendations for solo vs squad play.\" },\r\n  ],\r\n  'MMORPG': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'class_optimization', title: 'Class Optimization', type: 'strategies', instruction: \"Analyze the current class build and suggest optimizations. Include talent choices, gear priorities, stat allocation, and how to maximize effectiveness for current content and playstyle.\" },\r\n    { id: 'content_progression', title: 'Content Progression', type: 'walkthrough', instruction: \"Provide a roadmap for progressing through current and upcoming content. Suggest priority activities, gear upgrades, and how to efficiently advance through dungeons, raids, or PvP content.\" },\r\n    { id: 'economy_management', title: 'Economy Management', type: 'tips', instruction: \"Offer strategies for managing in-game resources and economy. Include gold-making tips, auction house strategies, and how to optimize spending for maximum character progression.\" },\r\n    { id: 'social_strategies', title: 'Social Strategies', type: 'tips', instruction: \"Suggest approaches for building effective guild relationships and finding groups. Include communication tips, role expectations, and how to become a valuable team member in group content.\" },\r\n    { id: 'missed_items', title: 'Items You May Have Missed', type: 'items', instruction: \"Based on player level and progression, identify 2-3 easily overlooked collectibles, rare drops, quest rewards, or hidden treasures in previously visited zones. Provide location hints without exact coordinates: 'Underwater cave beneath northern waterfall in Ashenvale' or 'Rare spawn in southwestern corner - 2-4 hour respawn timer.' Explain item value: transmog rarity, stat benefits, quest chain starters, achievement requirements, or market value. Focus on items still accessible at current level.\" },\r\n    { id: 'points_of_interest', title: 'Points of Interest', type: 'tips', instruction: \"Highlight 2-3 noteworthy locations in current or adjacent zones: hidden areas with lore significance, rare NPC encounters, scenic exploration achievements, or easter eggs. Provide exploration incentives: 'The abandoned throne room reveals the zone's pre-Cataclysm history' or 'Climbing to mountain peak unlocks exploration achievement and rare battle pet spawn.' Include practical benefits when relevant: flight path discoveries, reputation vendor locations, or dungeon entrance shortcuts.\" },\r\n    { id: 'alt_character_strategy', title: 'Alt Character Strategy', type: 'strategies', instruction: \"Provide guidance on leveraging alt characters for main character progression. Recommend: optimal number and classes for alt army, what dailies/weeklies to prioritize per alt, cross-character resource funneling strategies, profession synergies between characters. Include time investment analysis: 'Two gathering alts (15 mins/day each) can fund main's consumables and repairs' or 'Healer alt for instant dungeon queues speeds up weekly valor farming.' Adjust advice based on available playtime and goals (casual, competitive raiding, gold-making).\" },\r\n    { id: 'reputation_faction_guide', title: 'Reputation & Faction Guide', type: 'strategies', instruction: \"Based on current level and factions unlocked, prioritize 2-3 reputation grinds offering highest value rewards. Explain optimal grinding methods: daily quests, dungeon tabards, token turn-ins, special events. Detail reward milestones: 'Revered unlocks epic gear useful until raid tier, Exalted gives best-in-slot enchant and mount.' Identify time-gated reputations requiring early start, highlight reputations with account-wide benefits, and suggest efficient multi-faction farming routes when zones overlap.\" },\r\n    { id: 'raid_preparation', title: 'Raid Preparation', type: 'strategies', instruction: \"Provide comprehensive raid readiness checklist tailored to player's progression level. Cover: optimal stat priorities and gear targets (pre-raid best-in-slot), consumable requirements (flasks, potions, food, runes), enchant/gem priorities by budget, rotation practice resources, dungeon mechanics that translate to raid encounters. Include weekly prep routine: 'Tuesday: craft consumables, Wednesday: practice rotation on training dummy for 20 mins, Thursday: review boss guides for tonight's raid targets.' Differentiate between normal/heroic/mythic expectations.\" },\r\n  ],\r\n  'Puzzle': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'puzzle_patterns', title: 'Puzzle Patterns', type: 'strategies', instruction: \"Identify common puzzle patterns and solution strategies. Provide systematic approaches to different puzzle types and how to recognize key elements that lead to solutions.\" },\r\n    { id: 'logical_reasoning', title: 'Logical Reasoning', type: 'strategies', instruction: \"Offer advanced logical reasoning techniques and problem-solving methods. Include how to break down complex puzzles, eliminate possibilities, and approach problems systematically.\" },\r\n    { id: 'time_optimization', title: 'Time Optimization', type: 'tips', instruction: \"Suggest strategies for solving puzzles more efficiently. Include speed-solving techniques, pattern recognition shortcuts, and how to minimize trial-and-error approaches.\" },\r\n    { id: 'difficulty_progression', title: 'Difficulty Progression', type: 'tips', instruction: \"Outline strategies for tackling increasingly difficult puzzles. Include preparation methods, skill development priorities, and how to build confidence for challenging content.\" },\r\n    { id: 'mental_breaks_strategy', title: 'Mental Breaks Strategy', type: 'tips', instruction: \"Provide cognitive management guidance for puzzle-solving sessions. Recommend break timing based on puzzle difficulty: 'Take 5-min break every 20 minutes on hard puzzles to prevent tunnel vision' or 'If stuck for 10+ minutes, step away completely - fresh perspective often reveals solutions immediately.' Suggest break activities that maintain problem-solving state without fatigue: light stretching, hydration, switching to easier puzzle temporarily. Include recognition signs for diminishing returns: making same mistakes repeatedly, frustration affecting enjoyment, or feeling mentally foggy.\" },\r\n    { id: 'pattern_library', title: 'Pattern Library', type: 'strategies', instruction: \"Build mental pattern recognition database based on puzzles encountered so far. Identify 3-4 recurring patterns or techniques: 'Many puzzles use color symmetry - always check for mirror patterns', 'Number sequences often follow Fibonacci or prime progressions', 'Spatial puzzles frequently require 180 mental rotation.' Provide pattern recognition training: 'When stuck, methodically check for: symmetry, sequences, transformations, elimination logic.' Include examples from recent puzzles the player solved and patterns they utilized successfully.\" },\r\n    { id: 'achievement_guide', title: 'Achievement & Challenge Guide', type: 'strategies', instruction: \"Based on current puzzle completion rate, identify 2-3 achievable challenge goals or achievement targets. Explain requirements, difficulty rating, and strategic approach. Example: 'Speed-run achievement for Chapter 3 requires sub-10-minute completion - master puzzle 3-7 shortcut pattern first as it saves 90 seconds.' Highlight achievements that unlock helpful tools or hint systems. Suggest achievement hunting order: start with easier completionist goals before attempting perfect-score or no-hint challenges. Include estimated time investment per achievement.\" },\r\n  ],\r\n  'Horror': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'survival_strategies', title: 'Survival Strategies', type: 'strategies', instruction: \"Provide comprehensive survival tactics for the current situation. Include resource management, safe zone identification, and how to navigate dangerous areas while minimizing risk.\" },\r\n    { id: 'enemy_behavior', title: 'Enemy Behavior', type: 'strategies', instruction: \"Analyze enemy patterns and suggest counter-strategies. Include how to avoid detection, exploit enemy weaknesses, and use the environment to your advantage against threats.\" },\r\n    { id: 'atmosphere_navigation', title: 'Atmosphere Navigation', type: 'tips', instruction: \"Offer strategies for managing the psychological aspects of horror gameplay. Include how to maintain composure, use audio cues effectively, and navigate tense situations.\" },\r\n    { id: 'resource_management', title: 'Resource Management', type: 'tips', instruction: \"Suggest optimal resource allocation and conservation strategies. Include inventory management, crafting priorities, and how to maximize survival potential with limited supplies.\" },\r\n    { id: 'missed_items', title: 'Items You May Have Missed', type: 'items', instruction: \"Based on player's current location and progress, identify 2-3 easily overlooked survival items, documents, or key items in recently explored areas. Provide cautious location hints: 'In the basement behind loose panel - check shadows' or 'Locked drawer in second-floor office - key found nearby.' Explain item value: ammunition type, healing effectiveness, story relevance, or puzzle requirements. Balance survival benefit against backtracking risk. Warn about dangerous areas: 'Item guarded by enemy patrol - wait for patrol pattern gap.'\" },\r\n    { id: 'points_of_interest', title: 'Points of Interest', type: 'tips', instruction: \"Highlight 2-3 atmospheric or narrative-rich locations in current area without spoiling scares. Focus on lore documents, environmental storytelling, or safe observation points. Example: 'The children's drawings on the asylum wall chronicle the facility's decline' or 'Camera feed room provides safe vantage point to study entity patrol patterns.' Include practical intel: 'Breaker room contains important fuse and reveals building's original layout via blueprints.' Avoid spoiling jump scares or major story reveals.\" },\r\n    { id: 'safe_zone_mapping', title: 'Safe Zone Mapping', type: 'strategies', instruction: \"Identify 2-3 secure locations in current area for regrouping, healing, or saving progress. Describe safety indicators: 'Room with single entrance/exit - barricadable door, no vents', 'Well-lit area where enemies avoid', or 'Locked safe room with save point and item box.' Provide navigation instructions from player's current position. Warn about false safe zones: areas that seem secure but have hidden spawn triggers or time limits. Include emergency escape route suggestions from each safe zone.\" },\r\n    { id: 'sanity_management', title: 'Sanity Management', type: 'tips', instruction: \"For games with sanity/mental health mechanics, provide management strategies based on current sanity level. Explain sanity reduction triggers: darkness exposure, witnessing events, taking damage, failed attempts. Recommend restoration methods: 'Use lantern only when necessary - natural light doesn't drain sanity', 'Complete side objectives for sanity restoration', or 'Stay in lit areas between exploration segments.' Include warning signs of critical sanity: visual distortions, audio hallucinations, gameplay changes. Suggest playstyle adjustments: cautious vs aggressive based on current mental state.\" },\r\n    { id: 'fear_adaptation', title: 'Progressive Fear Adaptation', type: 'tips', instruction: \"Provide psychological coping strategies for horror game stress management. Offer difficulty-appropriate advice: audio settings adjustments (lower scare sound effects, keep dialogue), lighting optimization (brightness vs atmosphere balance), play session pacing (break after intense sequences). Suggest desensitization techniques: 'Repeated exposure to enemy type reduces jump scare effectiveness', 'Understanding enemy AI patterns reduces fear of the unknown.' Include encouragement milestones: 'First encounter is always hardest - you've proven you can handle this.' Respect player's comfort levels - surviving, not suffering, is the goal.\" },\r\n  ],\r\n  'Souls-like': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'boss_strategy', title: 'Boss Strategy', type: 'strategies', instruction: \"A formidable adversary awaits. **Do not name the boss or describe its appearance.** Provide tactical guidance based on observable attack patterns: timing windows for punishing attacks, positioning strategies, elemental weaknesses or resistances, and phase transition tells. Include build-agnostic advice first, then specific tips for common playstyles (melee, ranged, magic). Example: 'Watch for the overhead wind-up - dodge toward the attack, not away. After the third strike in the combo, a 2-second opening appears.' Respect the challenge - give knowledge, not a free win.\" },\r\n    { id: 'hidden_paths', title: 'Hidden Paths & Secrets', type: 'tips', instruction: \"Hint at secret passages, illusory walls, or hidden shortcuts near the player's current location. Use environmental clues without explicit directions: 'The pattern of scorch marks on walls in this area isn't random' or 'Listen for echoes that sound different - some walls are thinner than they appear.' Focus on secrets that either shortcut tedious backtracking or contain significant upgrade materials.\" },\r\n    { id: 'build_optimization', title: 'Build Optimization', type: 'strategies', instruction: \"Analyze the player's apparent build direction and suggest 2-3 optimization paths. Include stat allocation priorities, weapon upgrade recommendations, and synergistic equipment/spell combinations available at their progress level. Address common build mistakes: 'If using strength weapons, diminishing returns start at 60 STR - consider investing in VIG for survivability.' Suggest respec timing if build feels ineffective.\" },\r\n    { id: 'missed_items', title: 'Items You May Have Missed', type: 'items', instruction: \"Identify 2-3 valuable items (upgrade materials, unique weapons, key items) in previously accessible areas that are easily overlooked. Provide landmark-based hints: 'In the cathedral you cleared earlier, a hidden prayer room lies behind the statue facing away from the altar.' Explain item significance without spoiling how to use it. Warn about point-of-no-return areas if relevant.\" },\r\n    { id: 'points_of_interest', title: 'Points of Interest', type: 'tips', instruction: \"Highlight 2-3 optional areas, NPC questlines, or mini-bosses currently accessible that offer exceptional rewards: rare weapons, powerful spells, lore-rich encounters. Provide access hints without explicit solutions: 'The locked tower in the swamp requires an item found in the catacombs - explore thoroughly.' Indicate difficulty relative to main path to help players gauge readiness.\" },\r\n    { id: 'death_recovery', title: 'Death Recovery Strategy', type: 'tips', instruction: \"Provide practical advice for safely recovering souls/currency after death based on death location difficulty. Suggest preparation: clearing path to death location, using stealth, or accepting the loss if retrieval risk is too high. Include emergency tactics: 'If your souls are in a boss room, you can sprint directly to them and use a homeward item before engaging.' Remind players that some losses are strategic - don't compound mistakes.\" },\r\n    { id: 'level_layout', title: 'Level Layout Insights', type: 'strategies', instruction: \"Help players understand current area's interconnected design. Identify key shortcuts they may have unlocked, suggest efficient exploration routes, and point out how different sections connect. Example: 'The elevator you just unlocked connects back to the second bonfire - you've completed a loop. The upper rampart path you haven't explored yet likely leads to the area boss.' Use cardinal directions and landmarks, not exact instructions.\" },\r\n    { id: 'npc_questlines', title: 'NPC Questlines', type: 'tips', instruction: \"Track important NPC questline progress without spoiling outcomes. Identify NPCs the player has encountered and suggest next steps if questlines are still active: 'The warrior you freed from the cell will appear in the next major area - exhaust their dialogue before progressing to the castle.' Warn about easily failed questlines: 'Speaking to NPC X before defeating the area boss will lock you out of their merchant services.' Focus on questlines with gameplay-relevant rewards.\" },\r\n  ],\r\n  'Metroidvania': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'ability_unlocks', title: 'New Ability Unlocked', type: 'tips', instruction: \"If the player recently gained a new movement ability, traversal upgrade, or tool, identify 2-3 previously inaccessible areas now available. Use map region names and ability-specific clues: 'With your new double-jump, the high platforms in the Crystal Mines are now reachable' or 'The underwater passage in the Sunken Temple can now be explored with your oxygen upgrade.' Prioritize areas containing useful upgrades over minor collectibles.\" },\r\n    { id: 'backtracking_guide', title: 'Backtracking Guide', type: 'strategies', instruction: \"Based on player's current abilities, create a prioritized backtracking checklist of 3-4 now-accessible locations containing significant upgrades: health expansions, weapon upgrades, fast travel unlocks, or ability enhancements. Organize by value and proximity: 'Closest: Crystal Caves upper section (health upgrade), 5 min from current save. Medium distance: Ancient Library secret room (damage boost).' Include fast travel waypoints for efficient routing.\" },\r\n    { id: 'map_completion', title: 'Map Completion', type: 'tips', instruction: \"Identify unexplored map sections or dead-ends marked on player's current map that likely contain progression items or major collectibles. Help players distinguish between optional collectible areas and critical path gaps: 'The unmapped western edge of the Forest Zone contains an optional challenge room, but the dark passage in the north is likely main story progression.' Use map percentage or visual cues to guide.\" },\r\n    { id: 'boss_strategy', title: 'Boss Strategy', type: 'strategies', instruction: \"Provide tactical guidance for the current boss encounter. **Do not name the boss.** Analyze attack patterns, identify damage windows, suggest effective weapon types or abilities. Include pattern recognition tips: 'The charge attack always follows the roar - dodge sideways and punish with 2-3 hits.' Mention if grinding levels/upgrades would significantly ease the fight versus pure skill requirements.\" },\r\n    { id: 'missed_items', title: 'Items You May Have Missed', type: 'items', instruction: \"Identify 2-3 easily overlooked collectibles, health/energy expansions, or lore items in areas the player has already visited. Provide ability-requirement context: 'In the starting village, a hidden energy tank is tucked behind destructible blocks (requires your new charge beam).' Focus on permanent upgrades over consumables. Use visual landmarks: 'Look for the statue with glowing eyes.'\" },\r\n    { id: 'points_of_interest', title: 'Points of Interest', type: 'tips', instruction: \"Highlight 2-3 optional challenge rooms, secret bosses, or lore-rich areas currently accessible with player's abilities. Explain rewards without spoiling encounters: 'The sealed chamber in the Forgotten Depths contains a powerful movement upgrade - prepare for a platforming gauntlet.' Indicate difficulty and whether completion is required for true ending if applicable.\" },\r\n    { id: 'sequence_breaking', title: 'Sequence Breaking Options', type: 'strategies', instruction: \"For players who enjoy non-linear exploration, identify 1-2 advanced techniques or ability combinations that could access later areas earlier: 'Skilled players can reach the Eastern Spire early using precise wall-jump chains on the waterfall section - saves 30 minutes but is very difficult.' Make it clear these are optional optimizations, not required paths. Only suggest if player has shown mastery of movement mechanics.\" },\r\n    { id: 'upgrade_priority', title: 'Upgrade Priority', type: 'strategies', instruction: \"Guide resource allocation for permanent upgrades available at player's progress point. Rank upgrade categories by impact: 'Prioritize health expansions first (survivability), then energy capacity (more special ability usage), finally damage boosts (late-game scaling).' If currency is limited, identify most efficient upgrade purchases: 'The 500-currency map reveal is worth delaying combat upgrades - reduces backtracking significantly.'\" },\r\n  ],\r\n  'Open-World': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'region_guide', title: 'Region Guide', type: 'tips', instruction: \"Provide an overview of the player's current region: key locations, available activities, recommended level range, and unique mechanics or challenges. Include fast travel points and how this region connects to others: 'The Northern Highlands connect to three other major zones - useful hub for exploration.' Mention region-specific resources or vendors worth noting.\" },\r\n    { id: 'activity_checklist', title: 'Activity Checklist', type: 'tips', instruction: \"Based on current location, list 3-5 nearby activities worth pursuing: side quests with good rewards, world events, collectible clusters, viewpoints, or challenges. Organize by distance and value: 'Closest: Bandit camp (10 min, rare weapon drop). Medium: Treasure hunt starting point (20 min, legendary gear). Far: Secret dungeon entrance (40 min, best-in-slot accessory).' Include variety - mix combat, exploration, and puzzles.\" },\r\n    { id: 'collectible_hunting', title: 'Collectible Hunting', type: 'strategies', instruction: \"Focus on one collectible type in player's current area with practical hunting tips. For scattered collectibles, identify cluster locations: 'Five of the region's twelve ancient tablets are concentrated around the old ruins.' For hidden collectibles, provide search techniques: 'Use eagle vision/detective mode in towns - collectibles glow briefly.' Mention if completing collection unlocks meaningful rewards.\" },\r\n    { id: 'world_events', title: 'Dynamic World Events', type: 'tips', instruction: \"Alert player to time-sensitive or location-based dynamic events in their current region: wandering world bosses, random encounters, merchant caravans, limited-time activities. Explain spawn conditions: 'The legendary beast spawns in the eastern valley during thunderstorms' or 'Merchants appear at crossroads every 30 in-game minutes.' Highlight unique rewards.\" },\r\n    { id: 'missed_items', title: 'Items You May Have Missed', type: 'items', instruction: \"Identify 2-3 significant items, legendary weapons, or unique collectibles in areas the player has already visited or passed through. Use region names and landmarks: 'In the Whispering Woods you explored earlier, a legendary bow is hidden in a cave behind the largest waterfall.' Explain why item is worth backtracking for: build-enabling, quest-related, or collection completion.\" },\r\n    { id: 'points_of_interest', title: 'Points of Interest', type: 'tips', instruction: \"Highlight 2-3 interesting locations in current region: scenic vistas, hidden dungeons, environmental storytelling sites, or challenging optional bosses. Explain what makes each special: 'The Abandoned Observatory offers the best view in the game and contains lore about the world's creation' or 'The Cursed Mines house an optional boss that drops materials for legendary armor.' Include recommended level if applicable.\" },\r\n    { id: 'exploration_route', title: 'Exploration Route', type: 'strategies', instruction: \"Suggest an efficient exploration path through current region that maximizes discovery while minimizing backtracking. Structure as a loop or hub-spoke pattern: 'Start at the central tower, clear the western camps moving counterclockwise, then sweep the outer perimeter.' Identify natural progress gates: 'The northern mountains require climbing gear found in the eastern mines.' Balance efficiency with organic discovery.\" },\r\n    { id: 'fast_travel_optimization', title: 'Fast Travel Optimization', type: 'tips', instruction: \"Recommend fast travel point unlocking priorities in current and adjacent regions. Identify strategic waypoints that minimize travel time to key services: merchants, trainers, quest givers. Example: 'Unlock the crossroads waypoint next - it's equidistant from three major quest hubs and a crafting vendor.' Note any fast travel limitations: costs, restrictions, or unlock requirements.\" },\r\n    { id: 'progression_balance', title: 'Progression Balance', type: 'strategies', instruction: \"Help players balance main story progression against side content exploration. Suggest when to push main story forward: 'Completing the next story mission unlocks a new region and higher-tier loot - consider progressing before clearing all current-zone activities.' Or encourage side content: 'You're over-leveled for main story - explore optional areas for better challenge and unique rewards.' Prevent level scaling issues or missed content due to poor pacing.\" },\r\n  ],\r\n  'Survival-Crafting': [\r\n    { id: 'story_so_far', title: 'Story So Far', type: 'story', instruction: \"Provide a concise summary of the main plot events that have occurred strictly up to the estimated game progress. Do not mention, hint at, or allude to any future events, characters, or plot twists. The summary should read like a journal entry of what has *already happened*.\" },\r\n    { id: 'resource_locations', title: 'Resource Locations', type: 'tips', instruction: \"Based on what the player is likely trying to craft or build, identify the specific resources they need and exactly where to find them. Include biome locations, gathering methods, respawn times, and quantity expectations: 'Iron ore veins are abundant in the mountain caves northwest of your base - respawn every 24 in-game hours, 3-5 ore per vein.' Mention required tools or upgrades to harvest efficiently.\" },\r\n    { id: 'base_building', title: 'Base Building Guide', type: 'strategies', instruction: \"Provide base construction advice tailored to player's progression stage. For early game: optimal starter base location, essential structures, defensive priorities. For mid-game: production efficiency layouts, resource storage optimization, expansion planning. For late-game: automation systems, aesthetic improvements, advanced defensive systems. Include blueprints for efficient layouts: 'Place crafting stations in a U-shape around central storage for minimal walking.'\" },\r\n    { id: 'crafting_priority', title: 'Crafting Priority', type: 'strategies', instruction: \"Based on current progression and available resources, prioritize crafting/building projects by impact. Rank next 3-4 goals: 'Priority 1: Forge (unlocks metal tools, massive efficiency boost). Priority 2: Drying rack (food preservation, enables long expeditions). Priority 3: Workbench upgrade (unlocks tier-3 weapons).' Explain why each matters and resource requirements. Warn about resource bottlenecks.\" },\r\n    { id: 'survival_tips', title: 'Survival Tips', type: 'tips', instruction: \"Address immediate survival challenges based on player's current situation: food/water management, temperature regulation, disease prevention, predator avoidance. Provide biome-specific survival strategies: 'In the frost biome, build campfires every 100 meters and wear full fur armor - hypothermia sets in after 2 minutes of exposure.' Include emergency procedures: getting lost, injured far from base, resource depletion.\" },\r\n    { id: 'exploration_targets', title: 'Exploration Targets', type: 'tips', instruction: \"Identify 2-3 high-value exploration objectives near player's current base or advancement stage: resource-rich biomes, dungeon locations, NPC camps, ancient structures. Explain what each location offers: 'The swamp biome northeast contains rare plants for advanced medicine and crypts with iron supplies.' Include preparation requirements: gear, food, tools. Estimate exploration time and difficulty.\" },\r\n    { id: 'progression_roadmap', title: 'Progression Roadmap', type: 'strategies', instruction: \"Outline clear path to next major progression tier. Break into sequential milestones: 'Current: Bronze Age. Next tier requirements: 1) Defeat the Elder to unlock swamp biome key, 2) Mine iron in swamp crypts, 3) Build forge, 4) Craft iron tools.' Include preparation steps, estimated time per milestone, and optional side-objectives that ease progression.\" },\r\n    { id: 'danger_warnings', title: 'Danger Warnings', type: 'tips', instruction: \"Alert player to nearby high-risk areas, dangerous biomes, or enemy types they may not be prepared for. Provide threat assessment: 'The black forest south of your base contains trolls that can destroy wooden structures - avoid until you have stone walls and bronze weapons.' Include readiness indicators: gear milestones, recommended skills, or companion requirements. Some warnings prevent hours of lost progress.\" },\r\n    { id: 'multiplayer_synergy', title: 'Multiplayer Synergy', type: 'strategies', instruction: \"For multiplayer sessions, suggest role specialization and coordinated strategies. Recommend task division: 'Player A: focus on base building and crafting. Player B: hunting and resource gathering. Player C: exploration and dungeon delving.' Include shared progression tips: 'Build multiple portals at main base labeled by destination - enables parallel exploration.' Address resource sharing priorities and cooperative building techniques.\" },\r\n    { id: 'seasonal_preparation', title: 'Seasonal Preparation', type: 'tips', instruction: \"If game has seasonal mechanics or progression phases, help players prepare for upcoming changes. Detail seasonal challenges: 'Winter approaches in 5 in-game days - stock 20+ cooked meat, gather firewood, craft warm clothing, reinforce base against cold-weather raids.' Include seasonal opportunities: unique resources, events, or activities only available during specific periods. Prevent being caught unprepared by sudden environmental shifts.\" },\r\n  ],\r\n};\r\n","export const USER_TIERS = {\r\n  FREE: 'free',\r\n  PRO: 'pro',\r\n  VANGUARD_PRO: 'vanguard_pro',\r\n} as const;\r\n\r\nexport const TIER_LIMITS = {\r\n  [USER_TIERS.FREE]: { text: 55, image: 25 },\r\n  [USER_TIERS.PRO]: { text: 1583, image: 328 },\r\n  [USER_TIERS.VANGUARD_PRO]: { text: 1583, image: 328 },\r\n} as const;\r\n\r\nexport const TIER_FEATURES = {\r\n  [USER_TIERS.FREE]: [\r\n    '55 text queries per month',\r\n    '25 image queries per month',\r\n    'Basic conversation features',\r\n    'Standard response quality'\r\n  ],\r\n  [USER_TIERS.PRO]: [\r\n    '1,583 text queries per month',\r\n    '328 image queries per month',\r\n    'Enhanced conversation features',\r\n    'Improved response quality',\r\n    'Priority support',\r\n    'No ads',\r\n    'Grounding search enabled'\r\n  ],\r\n  [USER_TIERS.VANGUARD_PRO]: [\r\n    '1,583 text queries per month',\r\n    '328 image queries per month',\r\n    'All Pro features',\r\n    'Exclusive Vanguard content',\r\n    'VIP support',\r\n    'Early access to new features',\r\n    'Grounding search enabled'\r\n  ],\r\n} as const;\r\n\r\nexport const TIER_PRICES = {\r\n  [USER_TIERS.FREE]: undefined,\r\n  [USER_TIERS.PRO]: 3.99,\r\n  [USER_TIERS.VANGUARD_PRO]: 20.00,\r\n} as const;\r\n\r\nexport const STORAGE_KEYS = {\r\n  USER: 'otakon_user',\r\n  APP_STATE: 'otakon_app_state',\r\n  CONVERSATIONS: 'otakon_conversations',\r\n  GAMES: 'otakon_games',\r\n  WAITLIST: 'otakon_waitlist',\r\n  USAGE: 'otakon_usage',\r\n  PREFERENCES: 'otakon_preferences',\r\n  ONBOARDING: 'otakon_onboarding',\r\n  TRIAL: 'otakon_trial',\r\n} as const;\r\n\r\nexport const GAME_HUB_ID = 'game-hub';\r\nexport const DEFAULT_CONVERSATION_TITLE = 'Game Hub';\r\n\r\n// Feature Flags\r\nexport const FEATURE_FLAGS = {\r\n  //  Set to true to use normalized messages table instead of conversations.messages JSONB\r\n  // This enables better performance, pagination, and message search capabilities\r\n  USE_NORMALIZED_MESSAGES: true,\r\n  \r\n  //  Set to true to use normalized subtabs table instead of conversations.subtabs JSONB\r\n  // This enables better performance, pagination, and subtab search capabilities\r\n  USE_NORMALIZED_SUBTABS: true,\r\n  \r\n  // Enable context summarization for conversations\r\n  USE_CONTEXT_SUMMARIZATION: true,\r\n  \r\n  // Enable conversation slugs for human-readable URLs\r\n  USE_CONVERSATION_SLUGS: true,\r\n} as const;\r\n","import { StorageService } from './storageService';\r\nimport { cacheService } from './cacheService';\r\nimport { chatMemoryService } from './chatMemoryService';\r\nimport { SupabaseService } from './supabaseService';\r\nimport { toastService } from './toastService';\r\nimport { Conversations, Conversation, ChatMessage, UserTier } from '../types';\r\nimport { STORAGE_KEYS, DEFAULT_CONVERSATION_TITLE, GAME_HUB_ID, USER_TIERS } from '../constants';\r\n\r\n// Initialize Supabase service instance\r\nconst supabaseService = SupabaseService.getInstance();\r\n\r\n//  QUERY-BASED LIMITS: Conversations are unlimited for all tiers.\r\n// Limits are based on queries (text vs image) per month, tracked in database:\r\n// - Free: 55 text + 25 image queries/month\r\n// - Pro: 1,583 text + 328 image queries/month\r\n// - Vanguard Pro: 1,583 text + 328 image queries/month\r\n// See: users table (text_count, image_count, text_limit, image_limit, last_reset)\r\n\r\nexport class ConversationService {\r\n  //  PERFORMANCE: Deduplicate conversation creation attempts\r\n  private static pendingCreations = new Map<string, Promise<{ success: boolean; reason?: string }>>();\r\n  \r\n  //  Get current user ID for Supabase operations\r\n  private static async getCurrentUserId(): Promise<string | null> {\r\n    try {\r\n      const { authService } = await import('./authService');\r\n      const user = authService.getCurrentUser();\r\n      return user?.authUserId || null;\r\n    } catch (error) {\r\n      console.warn('Could not get user ID from auth service:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  //  SCALABILITY: Get user tier from auth service\r\n  private static async getUserTier(): Promise<UserTier> {\r\n    try {\r\n      // Try to get from auth service first\r\n      const { authService } = await import('./authService');\r\n      const user = authService.getCurrentUser();\r\n      if (user?.tier) {\r\n        return user.tier;\r\n      }\r\n    } catch (error) {\r\n      console.warn('Could not get user tier from auth service:', error);\r\n    }\r\n    \r\n    // Fallback to localStorage\r\n    const user = StorageService.get(STORAGE_KEYS.USER, null) as any;\r\n    return user?.tier || USER_TIERS.FREE;\r\n  }\r\n\r\n  //  QUERY-BASED LIMITS: Check if user can send a text query\r\n  static async canSendTextQuery(): Promise<{ allowed: boolean; reason?: string; used?: number; limit?: number }> {\r\n    try {\r\n      const { authService } = await import('./authService');\r\n      const user = authService.getCurrentUser();\r\n      \r\n      if (!user) {\r\n        return { allowed: false, reason: 'User not authenticated' };\r\n      }\r\n\r\n      const textCount = user.textCount || 0;\r\n      const textLimit = user.textLimit || 55; // Default to free tier\r\n      \r\n      if (textCount >= textLimit) {\r\n        const tier = user.tier || 'free';\r\n        return {\r\n          allowed: false,\r\n          reason: `You've used all ${textLimit} text queries this month. ${tier === 'free' ? 'Upgrade to Pro for 1,583 queries!' : 'Your queries will reset next month.'}`,\r\n          used: textCount,\r\n          limit: textLimit\r\n        };\r\n      }\r\n      \r\n      return { allowed: true, used: textCount, limit: textLimit };\r\n    } catch (error) {\r\n      console.error('Error checking text query limit:', error);\r\n      toastService.error('Failed to check query limit. Please try again.');\r\n      return { allowed: false, reason: 'Failed to check query limit' };\r\n    }\r\n  }\r\n\r\n  //  QUERY-BASED LIMITS: Check if user can send an image query\r\n  static async canSendImageQuery(): Promise<{ allowed: boolean; reason?: string; used?: number; limit?: number }> {\r\n    try {\r\n      const { authService } = await import('./authService');\r\n      const user = authService.getCurrentUser();\r\n      \r\n      if (!user) {\r\n        return { allowed: false, reason: 'User not authenticated' };\r\n      }\r\n\r\n      const imageCount = user.imageCount || 0;\r\n      const imageLimit = user.imageLimit || 25; // Default to free tier\r\n      \r\n      if (imageCount >= imageLimit) {\r\n        const tier = user.tier || 'free';\r\n        return {\r\n          allowed: false,\r\n          reason: `You've used all ${imageLimit} image queries this month. ${tier === 'free' ? 'Upgrade to Pro for 328 image queries!' : 'Your queries will reset next month.'}`,\r\n          used: imageCount,\r\n          limit: imageLimit\r\n        };\r\n      }\r\n      \r\n      return { allowed: true, used: imageCount, limit: imageLimit };\r\n    } catch (error) {\r\n      console.error('Error checking image query limit:', error);\r\n      toastService.error('Failed to check query limit. Please try again.');\r\n      return { allowed: false, reason: 'Failed to check query limit' };\r\n    }\r\n  }\r\n\r\n  //  In-memory cache to reduce Supabase reads during polling\r\n  private static conversationsCache: { data: Conversations; timestamp: number } | null = null;\r\n  private static CACHE_TTL = 5000; // 5 second cache (balance between real-time and performance)\r\n\r\n  /**\r\n   * Clear the conversations cache to force fresh database read\r\n   */\r\n  static clearCache(): void {\r\n    console.error(' [ConversationService] Cache cleared, next read will be fresh');\r\n    this.conversationsCache = null;\r\n  }\r\n\r\n  /**\r\n   * Get cached conversations without querying Supabase\r\n   * Returns null if cache is empty or expired\r\n   */\r\n  static getCachedConversations(): Conversations | null {\r\n    if (this.conversationsCache && Date.now() - this.conversationsCache.timestamp < this.CACHE_TTL) {\r\n      console.log(' [ConversationService] Returning cached conversations (age:', Date.now() - this.conversationsCache.timestamp, 'ms)');\r\n      return this.conversationsCache.data;\r\n    }\r\n    console.log(' [ConversationService] No valid cache available');\r\n    return null;\r\n  }\r\n\r\n  static async getConversations(skipCache = false): Promise<Conversations> {\r\n    const userId = await this.getCurrentUserId();\r\n    let conversations: Conversations = {};\r\n    \r\n    //  PERFORMANCE: Check in-memory cache first (unless explicitly skipped)\r\n    if (!skipCache && this.conversationsCache && Date.now() - this.conversationsCache.timestamp < this.CACHE_TTL) {\r\n      console.log(' [ConversationService] Using cached conversations (age:', Date.now() - this.conversationsCache.timestamp, 'ms)');\r\n      return this.conversationsCache.data;\r\n    }\r\n    \r\n    //  PRIMARY: Load from Supabase\r\n    if (userId) {\r\n      try {\r\n        console.log(' [ConversationService] Loading conversations from Supabase for user:', userId);\r\n        const supabaseConvs = await supabaseService.getConversations(userId);\r\n        \r\n        // Convert array to object format\r\n        conversations = supabaseConvs.reduce((acc, conv) => {\r\n          acc[conv.id] = conv;\r\n          return acc;\r\n        }, {} as Conversations);\r\n        \r\n        console.log(' [ConversationService] Loaded', Object.keys(conversations).length, 'conversations from Supabase');\r\n        \r\n        //  Update cache\r\n        this.conversationsCache = {\r\n          data: conversations,\r\n          timestamp: Date.now()\r\n        };\r\n        \r\n        // Also update localStorage as backup\r\n        if (Object.keys(conversations).length > 0) {\r\n          StorageService.set(STORAGE_KEYS.CONVERSATIONS, conversations);\r\n        }\r\n        \r\n      } catch (error) {\r\n        console.error(' [ConversationService] Failed to load from Supabase, falling back to localStorage:', error);\r\n        toastService.warning('Using offline conversations. Some data may not be synced.');\r\n        conversations = StorageService.get(STORAGE_KEYS.CONVERSATIONS, {}) as Conversations;\r\n      }\r\n    } else {\r\n      // No user logged in, use localStorage\r\n      console.log(' [ConversationService] No user ID, loading from localStorage');\r\n      conversations = StorageService.get(STORAGE_KEYS.CONVERSATIONS, {}) as Conversations;\r\n    }\r\n    \r\n    // Migration: Update existing \"General Chat\" or \"Everything else\" titles to \"Game Hub\"\r\n    let needsUpdate = false;\r\n    Object.values(conversations).forEach((conv: Conversation) => {\r\n      if (conv.title === 'General Chat' || conv.title === 'Everything else') {\r\n        console.log(' [GAME_HUB_PROTECTION] Migrating legacy conversation to Game Hub:', {\r\n          oldTitle: conv.title,\r\n          oldId: conv.id,\r\n          oldIsGameHub: conv.isGameHub\r\n        });\r\n        conv.title = DEFAULT_CONVERSATION_TITLE; // \"Game Hub\"\r\n        conv.id = GAME_HUB_ID; // Ensure ID is correct\r\n        conv.isGameHub = true; // Mark as Game Hub\r\n        needsUpdate = true;\r\n      }\r\n      // Also ensure any conversation with game-hub ID has the flag set\r\n      if (conv.id === GAME_HUB_ID && !conv.isGameHub) {\r\n        console.warn(' [GAME_HUB_PROTECTION] Fixing missing isGameHub flag for:', conv.id);\r\n        conv.isGameHub = true;\r\n        needsUpdate = true;\r\n      }\r\n    });\r\n    \r\n    if (needsUpdate) {\r\n      await this.setConversations(conversations);\r\n    }\r\n    \r\n    //  QUERY-BASED LIMITS: Conversations are now unlimited for all tiers\r\n    // Limits are based on queries (text/image) per month, not conversation counts\r\n    \r\n    return conversations;\r\n  }\r\n\r\n  static async setConversations(conversations: Conversations, retryCount = 0): Promise<void> {\r\n    const userId = await this.getCurrentUserId();\r\n    console.log(' [ConversationService] Saving', Object.keys(conversations).length, 'conversations');\r\n    \r\n    //  Invalidate cache when writing\r\n    this.conversationsCache = null;\r\n    \r\n    // Always save to localStorage as backup\r\n    StorageService.set(STORAGE_KEYS.CONVERSATIONS, conversations);\r\n    console.log(' [ConversationService] Saved to localStorage');\r\n    \r\n    //  PRIMARY: Save to Supabase if user is logged in (with retry logic)\r\n    if (userId) {\r\n      try {\r\n        console.log(' [ConversationService] Syncing to Supabase...');\r\n        \r\n        //  FIX: Fetch existing conversations ONCE before the loop to prevent race conditions\r\n        const existingConvs = await supabaseService.getConversations(userId);\r\n        const existingIds = new Set(existingConvs.map(c => c.id));\r\n        console.log(' [ConversationService] Found', existingIds.size, 'existing conversations in Supabase');\r\n        \r\n        // Save each conversation to Supabase\r\n        const savePromises = Object.values(conversations).map(async (conv) => {\r\n          try {\r\n            // Check if conversation exists in Supabase (using pre-fetched list)\r\n            const exists = existingIds.has(conv.id);\r\n            \r\n            if (exists) {\r\n              // Update existing\r\n              await supabaseService.updateConversation(conv.id, conv);\r\n            } else {\r\n              // Create new - UPSERT will handle duplicates gracefully\r\n              const newId = await supabaseService.createConversation(userId, conv);\r\n              if (!newId) {\r\n                console.warn(`Failed to create conversation ${conv.id} in Supabase (returned null)`);\r\n              }\r\n            }\r\n          } catch (error) {\r\n            console.warn(`Failed to save conversation ${conv.id} to Supabase:`, error);\r\n            // Don't re-throw - allow other conversations to sync\r\n          }\r\n        });\r\n        \r\n        await Promise.all(savePromises);\r\n        console.log(' [ConversationService] Synced to Supabase successfully');\r\n        \r\n      } catch (error) {\r\n        console.error(' [ConversationService] Failed to sync to Supabase:', error);\r\n        \r\n        //  Retry with exponential backoff (3 attempts)\r\n        if (retryCount < 3) {\r\n          const delay = 1000 * Math.pow(2, retryCount); // 1s, 2s, 4s\r\n          console.warn(` [ConversationService] Retrying in ${delay}ms (attempt ${retryCount + 1}/3)...`);\r\n          await new Promise(resolve => setTimeout(resolve, delay));\r\n          return this.setConversations(conversations, retryCount + 1);\r\n        } else {\r\n          //  Final failure - notify user\r\n          console.error(' [ConversationService] Supabase sync failed after 3 attempts');\r\n          // Import toastService dynamically to avoid circular dependency\r\n          import('./toastService').then(({ toastService }) => {\r\n            toastService.warning('Changes saved locally. Will sync when online.');\r\n          }).catch(err => console.error('Failed to show toast:', err));\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  static createConversation(title?: string, id?: string): Conversation {\r\n    const now = Date.now();\r\n    const isGameHub = title === DEFAULT_CONVERSATION_TITLE;\r\n    // Use 'game-hub' as ID for the default Game Hub conversation\r\n    const conversationId = id || (isGameHub ? GAME_HUB_ID : `conv_${now}`);\r\n    \r\n    console.log(' [GAME_HUB_PROTECTION] createConversation called:', {\r\n      title,\r\n      providedId: id,\r\n      isGameHub,\r\n      conversationId,\r\n      GAME_HUB_ID_VALUE: GAME_HUB_ID,\r\n      DEFAULT_TITLE: DEFAULT_CONVERSATION_TITLE\r\n    });\r\n    \r\n    return {\r\n      id: conversationId,\r\n      title: title || DEFAULT_CONVERSATION_TITLE,\r\n      messages: [],\r\n      subtabs: [],\r\n      subtabsOrder: [],\r\n      createdAt: now,\r\n      updatedAt: now,\r\n      isActive: true,\r\n      isActiveSession: false,\r\n      isPinned: false,\r\n      isGameHub: isGameHub, // Set flag for Game Hub\r\n    };\r\n  }\r\n\r\n  static async addConversation(conversation: Conversation): Promise<{ success: boolean; reason?: string }> {\r\n    //  PERFORMANCE: Check if there's already a pending creation for this conversation\r\n    if (this.pendingCreations.has(conversation.id)) {\r\n      console.log(' [ConversationService] Deduplicating conversation creation for:', conversation.id);\r\n      return await this.pendingCreations.get(conversation.id)!;\r\n    }\r\n\r\n    // Create a new promise and store it\r\n    const creationPromise = this._addConversationInternal(conversation);\r\n    this.pendingCreations.set(conversation.id, creationPromise);\r\n\r\n    try {\r\n      const result = await creationPromise;\r\n      return result;\r\n    } finally {\r\n      // Clean up the pending request\r\n      this.pendingCreations.delete(conversation.id);\r\n    }\r\n  }\r\n\r\n  private static async _addConversationInternal(conversation: Conversation): Promise<{ success: boolean; reason?: string }> {\r\n    const userId = await this.getCurrentUserId();\r\n    \r\n    //  QUERY-BASED LIMITS: Conversations are unlimited, no need to check count\r\n    // Query limits (text/image) are checked in aiService before sending messages\r\n    \r\n    const conversations = await this.getConversations();\r\n    \r\n    //  FIX: Prevent duplicate Game Hub conversations\r\n    if (conversation.isGameHub || conversation.title === DEFAULT_CONVERSATION_TITLE) {\r\n      const existingGameHub = Object.values(conversations).find(\r\n        conv => conv.isGameHub || conv.title === DEFAULT_CONVERSATION_TITLE || conv.id === GAME_HUB_ID\r\n      );\r\n      if (existingGameHub) {\r\n        return { \r\n          success: false, \r\n          reason: 'A \"Game Hub\" conversation already exists. Please use the existing one or create a conversation with a different title.' \r\n        };\r\n      }\r\n    }\r\n    \r\n    //  Set authUserId on the conversation object\r\n    if (userId) {\r\n      conversation.authUserId = userId;\r\n    }\r\n    \r\n    //  Conversations are unlimited - add the new conversation\r\n    conversations[conversation.id] = conversation;\r\n    console.log(' [ConversationService] Adding new conversation:', conversation.id, conversation.title);\r\n    \r\n    //  PRIMARY: Save to Supabase first if user logged in\r\n    if (userId) {\r\n      try {\r\n        // Pass the conversation with its ID to ensure Game Hub uses 'game-hub' consistently\r\n        const newId = await supabaseService.createConversation(userId, conversation);\r\n        if (newId) {\r\n          // Update conversation with Supabase-returned ID if different\r\n          if (newId !== conversation.id) {\r\n            console.log(' [ConversationService] Supabase returned different ID, updating:', conversation.id, '', newId);\r\n            delete conversations[conversation.id];\r\n            conversation.id = newId;\r\n            conversations[newId] = conversation;\r\n          } else {\r\n            console.log(' [ConversationService] Created in Supabase with consistent ID:', newId);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error(' [ConversationService] Failed to create in Supabase:', error);\r\n      }\r\n    }\r\n    \r\n    // Save to localStorage as backup\r\n    await this.setConversations(conversations);\r\n    \r\n    console.log(' [ConversationService] New conversation persisted successfully');\r\n    return { success: true };\r\n  }\r\n\r\n  static async updateConversation(id: string, updates: Partial<Conversation>): Promise<void> {\r\n    const userId = await this.getCurrentUserId();\r\n    const conversations = await this.getConversations();\r\n    \r\n    if (conversations[id]) {\r\n      conversations[id] = {\r\n        ...conversations[id],\r\n        ...updates,\r\n        updatedAt: Date.now(),\r\n      };\r\n      \r\n      //  PRIMARY: Update in Supabase first\r\n      if (userId) {\r\n        try {\r\n          await supabaseService.updateConversation(id, conversations[id]);\r\n          console.log(' [ConversationService] Updated conversation in Supabase:', id);\r\n        } catch (error) {\r\n          console.error(' [ConversationService] Failed to update in Supabase:', error);\r\n        }\r\n      }\r\n      \r\n      // Save to localStorage as backup\r\n      await this.setConversations(conversations);\r\n    }\r\n  }\r\n\r\n  static async deleteConversation(id: string): Promise<void> {\r\n    const userId = await this.getCurrentUserId();\r\n    const conversations = await this.getConversations();\r\n    \r\n    //  PROTECTION: Prevent deletion of Game Hub\r\n    const conversation = conversations[id];\r\n    console.log(' [GAME_HUB_PROTECTION] deleteConversation called:', { \r\n      conversationId: id, \r\n      isGameHub: conversation?.isGameHub, \r\n      matchesConstant: id === GAME_HUB_ID,\r\n      conversationTitle: conversation?.title,\r\n      GAME_HUB_ID_VALUE: GAME_HUB_ID\r\n    });\r\n    \r\n    if (conversation?.isGameHub || id === GAME_HUB_ID) {\r\n      console.error(' [GAME_HUB_PROTECTION] BLOCKED: Attempted to delete Game Hub conversation!');\r\n      toastService.warning('Cannot delete the Game Hub conversation. It\\'s your main conversation space!');\r\n      throw new Error('Cannot delete the Game Hub conversation');\r\n    }\r\n    \r\n    delete conversations[id];\r\n    \r\n    //  PRIMARY: Delete from Supabase first\r\n    if (userId) {\r\n      try {\r\n        await supabaseService.deleteConversation(id);\r\n        console.log(' [ConversationService] Deleted conversation from Supabase:', id);\r\n      } catch (error) {\r\n        console.error(' [ConversationService] Failed to delete from Supabase:', error);\r\n      }\r\n    }\r\n    \r\n    // Update localStorage as backup\r\n    await this.setConversations(conversations);\r\n  }\r\n\r\n  static async addMessage(conversationId: string, message: ChatMessage): Promise<{ success: boolean; reason?: string }> {\r\n    //  QUERY-BASED LIMITS: Message limits removed - unlimited messages per conversation\r\n    // Query limits (text/image) are checked in aiService before sending to AI\r\n    \r\n    const conversations = await this.getConversations();\r\n    if (conversations[conversationId]) {\r\n      const conversation = conversations[conversationId];\r\n      \r\n      //  Check for duplicates to prevent race condition issues\r\n      const exists = conversation.messages.some(m => m.id === message.id);\r\n      if (exists) {\r\n        console.warn(` [ConversationService] Message ${message.id} already exists in conversation ${conversationId}, skipping`);\r\n        return { success: true, reason: 'Message already exists' };\r\n      }\r\n      \r\n      // Simply add the message - no limits\r\n      conversation.messages.push(message);\r\n      conversation.updatedAt = Date.now();\r\n      \r\n      await this.setConversations(conversations);\r\n      \r\n      //  SCALABILITY: Save individual conversation to cache (non-blocking)\r\n      chatMemoryService.saveConversation(conversation)\r\n        .catch(error => console.warn('Failed to save conversation to cache:', error));\r\n      \r\n      //  SCALABILITY: Save chat context for AI memory (non-blocking)\r\n      // Fire and forget - don't block on this operation\r\n      import('./authService').then(({ authService }) => {\r\n        const user = authService.getCurrentUser();\r\n        if (user?.authUserId) {\r\n          chatMemoryService.saveChatContext(user.authUserId, {\r\n            recentMessages: conversation.messages.slice(-10), // Last 10 messages\r\n            userPreferences: {}, // This would come from user service\r\n            gameContext: {}, // This would come from game context\r\n            conversationSummary: conversation.title\r\n          }).catch(error => console.warn('Failed to save chat context:', error));\r\n        }\r\n      }).catch(error => console.warn('Failed to import authService:', error));\r\n      \r\n      return { success: true };\r\n    }\r\n    \r\n    return { success: false, reason: 'Conversation not found' };\r\n  }\r\n\r\n  static async getActiveConversation(): Promise<Conversation | null> {\r\n    const conversations = await this.getConversations();\r\n    const activeConversation = Object.values(conversations).find(conv => conv.isActive);\r\n    return activeConversation || null;\r\n  }\r\n\r\n  //  QUERY-BASED USAGE: Get user's current query usage statistics\r\n  static async getUsageStats(): Promise<{\r\n    textQueries: { current: number; limit: number; tier: UserTier };\r\n    imageQueries: { current: number; limit: number; tier: UserTier };\r\n    conversations: { current: number; tier: UserTier };\r\n  }> {\r\n    const { authService } = await import('./authService');\r\n    const user = authService.getCurrentUser();\r\n    const conversations = await this.getConversations();\r\n    const tier = await this.getUserTier();\r\n    \r\n    if (!user) {\r\n      // Return defaults if no user\r\n      return {\r\n        textQueries: { current: 0, limit: 55, tier },\r\n        imageQueries: { current: 0, limit: 25, tier },\r\n        conversations: { current: 0, tier }\r\n      };\r\n    }\r\n    \r\n    return {\r\n      textQueries: {\r\n        current: user.textCount || 0,\r\n        limit: user.textLimit || 55,\r\n        tier\r\n      },\r\n      imageQueries: {\r\n        current: user.imageCount || 0,\r\n        limit: user.imageLimit || 25,\r\n        tier\r\n      },\r\n      conversations: {\r\n        current: Object.keys(conversations).length,\r\n        tier\r\n      }\r\n    };\r\n  }\r\n\r\n  static async setActiveConversation(id: string): Promise<void> {\r\n    const conversations = await this.getConversations();\r\n    \r\n    // Set all conversations to inactive\r\n    Object.values(conversations).forEach(conv => {\r\n      conv.isActive = false;\r\n    });\r\n    \r\n    // Set the selected conversation as active\r\n    if (conversations[id]) {\r\n      conversations[id].isActive = true;\r\n    }\r\n    \r\n    await this.setConversations(conversations);\r\n  }\r\n\r\n  static async clearAllConversations(): Promise<void> {\r\n    await this.setConversations({});\r\n    \r\n    //  SCALABILITY: Clear all conversation cache entries\r\n    try {\r\n      await cacheService.clear();\r\n    } catch (error) {\r\n      console.warn('Failed to clear conversation cache:', error);\r\n    }\r\n  }\r\n\r\n  static async clearConversation(conversationId: string): Promise<void> {\r\n    const conversations = await this.getConversations();\r\n    const conversation = conversations[conversationId];\r\n    \r\n    if (!conversation) {\r\n      console.warn(' [ConversationService] clearConversation: Conversation not found:', conversationId);\r\n      return;\r\n    }\r\n    \r\n    //  PROTECTION: Prevent clearing Game Hub messages\r\n    console.log(' [GAME_HUB_PROTECTION] clearConversation called:', { \r\n      conversationId, \r\n      isGameHub: conversation.isGameHub, \r\n      matchesConstant: conversationId === GAME_HUB_ID,\r\n      conversationTitle: conversation.title,\r\n      messageCount: conversation.messages?.length || 0,\r\n      GAME_HUB_ID_VALUE: GAME_HUB_ID\r\n    });\r\n    \r\n    if (conversation.isGameHub || conversationId === GAME_HUB_ID) {\r\n      console.error(' [GAME_HUB_PROTECTION] BLOCKED: Attempted to clear Game Hub conversation messages!');\r\n      toastService.warning('Cannot clear the Game Hub conversation. It\\'s your main conversation space!');\r\n      throw new Error('Cannot clear the Game Hub conversation');\r\n    }\r\n    \r\n    // Clear messages but keep the conversation\r\n    conversations[conversationId] = {\r\n      ...conversations[conversationId],\r\n      messages: [],\r\n      updatedAt: Date.now(),\r\n    };\r\n    \r\n    await this.setConversations(conversations);\r\n    await chatMemoryService.saveConversation(conversations[conversationId]);\r\n  }\r\n\r\n  /**\r\n   * Update sub-tab content for a conversation\r\n   */\r\n  static async updateSubTabContent(conversationId: string, subTabId: string, content: string): Promise<void> {\r\n    const conversations = await this.getConversations();\r\n    const conversation = conversations[conversationId];\r\n    \r\n    if (!conversation || !conversation.subtabs) {\r\n      throw new Error('Conversation or sub-tabs not found');\r\n    }\r\n\r\n    const updatedSubTabs = conversation.subtabs.map(tab => \r\n      tab.id === subTabId \r\n        ? { ...tab, content, isNew: false, status: 'loaded' as const }\r\n        : tab\r\n    );\r\n\r\n    await this.updateConversation(conversationId, {\r\n      subtabs: updatedSubTabs,\r\n      updatedAt: Date.now()\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get a specific conversation by ID\r\n   * Optionally hydrate subtabs from normalized table if feature flag is enabled\r\n   */\r\n  static async getConversation(conversationId: string, hydrateSubtabs = true): Promise<Conversation | null> {\r\n    const conversations = await this.getConversations();\r\n    const conversation = conversations[conversationId] || null;\r\n    \r\n    if (!conversation || !hydrateSubtabs) {\r\n      return conversation;\r\n    }\r\n    \r\n    // If using normalized subtabs, hydrate them from the subtabs table\r\n    // This is handled automatically by subtabsService.getSubtabs()\r\n    // which checks FEATURE_FLAGS.USE_NORMALIZED_SUBTABS\r\n    return conversation;\r\n  }\r\n\r\n  /**\r\n   * Ensure Game Hub exists - creates it if missing\r\n   * Returns the Game Hub conversation\r\n   */\r\n  static async ensureGameHubExists(): Promise<Conversation> {\r\n    // Check cache first without clearing it\r\n    const cachedConversations = this.getCachedConversations();\r\n    if (cachedConversations) {\r\n      const existingGameHub = Object.values(cachedConversations).find(\r\n        conv => conv.isGameHub || conv.id === GAME_HUB_ID || conv.title === DEFAULT_CONVERSATION_TITLE\r\n      );\r\n      \r\n      if (existingGameHub) {\r\n        console.log(' [ConversationService] Game Hub found in cache:', existingGameHub.id);\r\n        return existingGameHub;\r\n      }\r\n    }\r\n    \r\n    // Not in cache, create new Game Hub\r\n    console.log(' [ConversationService] Creating Game Hub...');\r\n    const gameHub = this.createConversation(DEFAULT_CONVERSATION_TITLE, GAME_HUB_ID);\r\n    await this.addConversation(gameHub);\r\n    \r\n    //  RLS WORKAROUND: Update cache with the new Game Hub\r\n    // Don't reload from Supabase as list queries fail due to RLS\r\n    console.log(' [ConversationService] Game Hub created, updating cache directly (RLS workaround)');\r\n    \r\n    const conversations: Conversations = cachedConversations || {};\r\n    conversations[GAME_HUB_ID] = gameHub;\r\n    \r\n    this.conversationsCache = {\r\n      data: conversations,\r\n      timestamp: Date.now()\r\n    };\r\n    \r\n    return gameHub;\r\n  }\r\n\r\n  /**\r\n   * Update session state for a conversation\r\n   */\r\n  static async setSessionState(conversationId: string, isActive: boolean): Promise<void> {\r\n    await this.updateConversation(conversationId, {\r\n      isActiveSession: isActive,\r\n      updatedAt: Date.now()\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update game progress and active objective\r\n   */\r\n  static async updateGameProgress(conversationId: string, progress: number, objective: string): Promise<void> {\r\n    await this.updateConversation(conversationId, {\r\n      gameProgress: progress,\r\n      activeObjective: objective,\r\n      updatedAt: Date.now()\r\n    });\r\n  }\r\n}\r\n","import { GoogleGenerativeAI, GenerativeModel, SchemaType, HarmCategory, HarmBlockThreshold, SafetySetting } from \"@google/generative-ai\";\r\nimport { parseOtakonTags } from './otakonTags';\r\nimport { AIResponse, Conversation, User, insightTabsConfig, PlayerProfile } from '../types';\r\nimport { cacheService } from './cacheService';\r\nimport { getPromptForPersona } from './promptSystem';\r\nimport { errorRecoveryService } from './errorRecoveryService';\r\nimport { characterImmersionService } from './characterImmersionService';\r\nimport { profileAwareTabService } from './profileAwareTabService';\r\nimport { toastService } from './toastService';\r\nimport { supabase } from '../lib/supabase';\r\n\r\n//  SECURITY FIX: Use Edge Function proxy instead of exposed API key\r\nconst USE_EDGE_FUNCTION = true; // Set to true to use secure server-side proxy\r\nconst API_KEY = (import.meta as any).env.VITE_GEMINI_API_KEY; // Only used if USE_EDGE_FUNCTION = false\r\n\r\n//  FIX 1: Gemini API Safety Settings\r\nconst SAFETY_SETTINGS: SafetySetting[] = [\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_HARASSMENT,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n  {\r\n    category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,\r\n    threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n  },\r\n];\r\n\r\nclass AIService {\r\n  private genAI: GoogleGenerativeAI;\r\n  private flashModel: GenerativeModel;\r\n  private proModel: GenerativeModel;\r\n  private flashModelWithGrounding: GenerativeModel;\r\n  private edgeFunctionUrl: string;\r\n  \r\n  //  REQUEST DEDUPLICATION: Track pending requests to prevent duplicate API calls\r\n  private pendingRequests: Map<string, Promise<AIResponse>> = new Map();\r\n\r\n  constructor() {\r\n    //  SECURITY: Initialize Edge Function URL\r\n    const supabaseUrl = (import.meta as any).env.VITE_SUPABASE_URL;\r\n    this.edgeFunctionUrl = `${supabaseUrl}/functions/v1/ai-proxy`;\r\n\r\n    if (!USE_EDGE_FUNCTION) {\r\n      // Legacy: Direct API mode (only for development/testing)\r\n      if (!API_KEY) {\r\n        throw new Error(\"VITE_GEMINI_API_KEY is not set in the environment variables.\");\r\n      }\r\n      this.genAI = new GoogleGenerativeAI(API_KEY);\r\n      // Using gemini-2.5-flash-preview-09-2025 for all operations (enhanced performance)\r\n      //  FIX 2: Apply safety settings to all model initializations\r\n      this.flashModel = this.genAI.getGenerativeModel({ \r\n        model: \"gemini-2.5-flash-preview-09-2025\",\r\n        safetySettings: SAFETY_SETTINGS\r\n      });\r\n      this.proModel = this.genAI.getGenerativeModel({ \r\n        model: \"gemini-2.5-flash-preview-09-2025\",\r\n        safetySettings: SAFETY_SETTINGS\r\n      });\r\n      //  NEW: Model with Google Search grounding enabled\r\n      this.flashModelWithGrounding = this.genAI.getGenerativeModel({\r\n        model: \"gemini-2.5-flash-preview-09-2025\",\r\n        safetySettings: SAFETY_SETTINGS,\r\n        tools: [{\r\n          googleSearchRetrieval: {}\r\n        }]\r\n      });\r\n    } else {\r\n      // Edge Function mode: Initialize dummy models (won't be used)\r\n      this.genAI = {} as GoogleGenerativeAI;\r\n      this.flashModel = {} as GenerativeModel;\r\n      this.proModel = {} as GenerativeModel;\r\n      this.flashModelWithGrounding = {} as GenerativeModel;\r\n    }\r\n  }\r\n\r\n  /**\r\n   *  SECURITY: Call Edge Function proxy instead of direct API\r\n   */\r\n  private async callEdgeFunction(request: {\r\n    prompt: string;\r\n    image?: string;\r\n    systemPrompt?: string;\r\n    temperature?: number;\r\n    maxTokens?: number;\r\n    requestType: 'text' | 'image';\r\n    model?: string;\r\n    tools?: any[];\r\n  }): Promise<{ response: string; success: boolean; usage?: any; groundingMetadata?: any }> {\r\n    // Get user's JWT token\r\n    const { data: { session } } = await supabase.auth.getSession();\r\n    \r\n    if (!session) {\r\n      throw new Error('Not authenticated');\r\n    }\r\n\r\n    // Call Edge Function (server-side proxy)\r\n    const response = await fetch(this.edgeFunctionUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Authorization': `Bearer ${session.access_token}`,\r\n        'Content-Type': 'application/json'\r\n      },\r\n      body: JSON.stringify(request)\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const error = await response.json();\r\n      throw new Error(error.error || 'AI service error');\r\n    }\r\n\r\n    return await response.json();\r\n  }\r\n\r\n  /**\r\n   *  FIX 3: Check if AI response was blocked by safety filters\r\n   */\r\n  private checkSafetyResponse(result: any): { safe: boolean; reason?: string } {\r\n    // Check if prompt was blocked\r\n    if (result.response.promptFeedback?.blockReason) {\r\n      return {\r\n        safe: false,\r\n        reason: `Content blocked: ${result.response.promptFeedback.blockReason}`\r\n      };\r\n    }\r\n    \r\n    // Check if response was blocked by safety filters\r\n    const candidate = result.response.candidates?.[0];\r\n    if (!candidate) {\r\n      return {\r\n        safe: false,\r\n        reason: 'No response generated'\r\n      };\r\n    }\r\n    \r\n    if (candidate.finishReason === 'SAFETY') {\r\n      return {\r\n        safe: false,\r\n        reason: 'Response blocked by safety filters'\r\n      };\r\n    }\r\n    \r\n    return { safe: true };\r\n  }\r\n\r\n  /**\r\n   *  REQUEST DEDUPLICATION: Wrapper to prevent duplicate API calls\r\n   * If same request is already in progress, return the existing promise\r\n   */\r\n  private async getChatResponseWithDeduplication(\r\n    conversation: Conversation,\r\n    user: User,\r\n    userMessage: string,\r\n    isActiveSession: boolean,\r\n    hasImages: boolean = false,\r\n    imageData?: string,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<AIResponse> {\r\n    // Create deduplication key (conversation + message + session state)\r\n    const dedupKey = `${conversation.id}_${userMessage}_${isActiveSession}_${hasImages}`;\r\n    \r\n    // Check if identical request is already pending\r\n    const pendingRequest = this.pendingRequests.get(dedupKey);\r\n    if (pendingRequest) {\r\n      console.warn(' [AIService] Duplicate request detected, returning existing promise');\r\n      return pendingRequest;\r\n    }\r\n    \r\n    // Create new request promise\r\n    const requestPromise = this.getChatResponseInternal(\r\n      conversation,\r\n      user,\r\n      userMessage,\r\n      isActiveSession,\r\n      hasImages,\r\n      imageData,\r\n      abortSignal\r\n    );\r\n    \r\n    // Store pending request\r\n    this.pendingRequests.set(dedupKey, requestPromise);\r\n    \r\n    // Clean up after completion (success or failure)\r\n    try {\r\n      const result = await requestPromise;\r\n      return result;\r\n    } finally {\r\n      this.pendingRequests.delete(dedupKey);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Main method to get AI chat response (public API)\r\n   */\r\n  public async getChatResponse(\r\n    conversation: Conversation,\r\n    user: User,\r\n    userMessage: string,\r\n    isActiveSession: boolean,\r\n    hasImages: boolean = false,\r\n    imageData?: string,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<AIResponse> {\r\n    // Use deduplication wrapper\r\n    return this.getChatResponseWithDeduplication(\r\n      conversation,\r\n      user,\r\n      userMessage,\r\n      isActiveSession,\r\n      hasImages,\r\n      imageData,\r\n      abortSignal\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Internal method to get AI chat response (actual implementation)\r\n   */\r\n  private async getChatResponseInternal(\r\n    conversation: Conversation,\r\n    user: User,\r\n    userMessage: string,\r\n    isActiveSession: boolean,\r\n    hasImages: boolean = false,\r\n    imageData?: string,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<AIResponse> {\r\n    //  QUERY LIMIT: Check if user can send this query\r\n    const { ConversationService } = await import('./conversationService');\r\n    const queryCheck = hasImages \r\n      ? await ConversationService.canSendImageQuery()\r\n      : await ConversationService.canSendTextQuery();\r\n    \r\n    if (!queryCheck.allowed) {\r\n      // Throw error with upgrade prompt\r\n      throw new Error(queryCheck.reason || 'Query limit reached. Please upgrade your tier.');\r\n    }\r\n    \r\n    console.log(` [AIService] Query limit check passed. ${hasImages ? 'Image' : 'Text'} queries: ${queryCheck.used}/${queryCheck.limit}`);\r\n    \r\n    // Create cache key for this request - use full message hash to avoid collisions\r\n    // Simple hash function for cache key\r\n    const hashString = (str: string) => {\r\n      let hash = 0;\r\n      for (let i = 0; i < str.length; i++) {\r\n        const char = str.charCodeAt(i);\r\n        hash = ((hash << 5) - hash) + char;\r\n        hash = hash & hash; // Convert to 32-bit integer\r\n      }\r\n      return hash.toString(36);\r\n    };\r\n    \r\n    const messageHash = hashString(userMessage + (imageData || ''));\r\n    const cacheKey = `ai_response_${conversation.id}_${messageHash}_${isActiveSession}_${hasImages}`;\r\n    \r\n    // Check cache first (memory only for speed - skip Supabase for real-time operations)\r\n    const cachedResponse = await cacheService.get<AIResponse>(cacheKey, true); // true = memory only\r\n    if (cachedResponse) {\r\n      return { ...cachedResponse, metadata: { ...cachedResponse.metadata, fromCache: true } };\r\n    }\r\n\r\n    // Skip session context for now - it's returning null and slowing things down\r\n    // TODO: Implement proper session context when needed\r\n    const sessionContext = '';\r\n\r\n    // Get player profile from user preferences\r\n    const playerProfile = user.profileData as any; // PlayerProfile is stored in profileData\r\n    \r\n    // Use the enhanced prompt system with session context and player profile\r\n    const basePrompt = getPromptForPersona(\r\n      conversation, \r\n      userMessage, \r\n      user, \r\n      isActiveSession, \r\n      hasImages,\r\n      playerProfile\r\n    );\r\n    \r\n    // Add immersion context for game conversations (not Game Hub)\r\n    let immersionContext = '';\r\n    if (!conversation.isGameHub && conversation.gameTitle && conversation.genre) {\r\n      immersionContext = characterImmersionService.generateImmersionContext({\r\n        gameTitle: conversation.gameTitle,\r\n        genre: conversation.genre,\r\n        currentLocation: conversation.activeObjective,\r\n        playerProgress: conversation.gameProgress\r\n      });\r\n    }\r\n    \r\n    const prompt = basePrompt + sessionContext + '\\n\\n' + immersionContext;\r\n    \r\n    console.log(' [AIService] Processing request:', { \r\n      hasImages, \r\n      hasImageData: !!imageData, \r\n      imageDataLength: imageData?.length,\r\n      conversationId: conversation.id \r\n    });\r\n    \r\n    // Check if request was aborted before starting\r\n    if (abortSignal?.aborted) {\r\n      throw new DOMException('Request was aborted', 'AbortError');\r\n    }\r\n    \r\n    try {\r\n      //  ENABLE GROUNDING FOR ALL QUERIES (text and image)\r\n      const needsWebSearch = true;\r\n      \r\n      // Use grounding model for queries that need current information\r\n      //  SECURITY: Use Edge Function if enabled\r\n      let rawContent: string;\r\n\r\n      if (USE_EDGE_FUNCTION) {\r\n        // Extract base64 image data if present\r\n        let imageBase64: string | undefined;\r\n        if (hasImages && imageData) {\r\n          imageBase64 = imageData.split(',')[1];\r\n        }\r\n\r\n        // Determine which model and tools to use\r\n        const modelName = 'gemini-2.5-flash-preview-09-2025';\r\n        \r\n        //  ENHANCEMENT: Enable Google Search grounding for both text AND images\r\n        // This allows game detection from screenshots to access current information\r\n        const tools = needsWebSearch \r\n          ? [{ google_search: {} }]  // Updated to Gemini 2.5 syntax\r\n          : [];\r\n\r\n        // Call Edge Function proxy\r\n        const edgeResponse = await this.callEdgeFunction({\r\n          prompt,\r\n          image: imageBase64,\r\n          temperature: 0.7,\r\n          maxTokens: 2048,\r\n          requestType: hasImages ? 'image' : 'text',\r\n          model: modelName,\r\n          tools: tools.length > 0 ? tools : undefined\r\n        });\r\n\r\n        if (!edgeResponse.success) {\r\n          throw new Error(edgeResponse.response || 'AI request failed');\r\n        }\r\n\r\n        rawContent = edgeResponse.response;\r\n\r\n      } else {\r\n        // Legacy: Direct API mode (only for development)\r\n        // Note: Grounding doesn't work with image inputs, so fallback to regular model\r\n        const modelToUse = needsWebSearch && !hasImages \r\n          ? this.flashModelWithGrounding \r\n          : this.flashModel;\r\n        \r\n        if (needsWebSearch && !hasImages) {\r\n          console.log(' [AIService] Using Google Search grounding for current information:', {\r\n            gameTitle: conversation.gameTitle,\r\n            query: userMessage.substring(0, 50) + '...'\r\n          });\r\n        }\r\n        \r\n        // Prepare content for Gemini API\r\n        let content: any;\r\n        if (hasImages && imageData) {\r\n          // Extract MIME type from data URL\r\n          const mimeType = imageData.split(';')[0].split(':')[1] || 'image/jpeg';\r\n          const base64Data = imageData.split(',')[1];\r\n          \r\n          // For image analysis, we need to send both text and image\r\n          content = [\r\n            {\r\n              text: prompt\r\n            },\r\n            {\r\n              inlineData: {\r\n                mimeType: mimeType,\r\n                data: base64Data\r\n              }\r\n            }\r\n          ];\r\n        } else {\r\n          // For text-only requests\r\n          content = prompt;\r\n        }\r\n        \r\n        const result = await modelToUse.generateContent(content);\r\n        \r\n        //  FIX 4: Check safety response\r\n        const safetyCheck = this.checkSafetyResponse(result);\r\n        if (!safetyCheck.safe) {\r\n          toastService.error('Unable to generate response due to content policy');\r\n          throw new Error(safetyCheck.reason);\r\n        }\r\n        \r\n        // Check if request was aborted after API call but before processing\r\n        if (abortSignal?.aborted) {\r\n          throw new DOMException('Request was aborted', 'AbortError');\r\n        }\r\n        \r\n        rawContent = await result.response.text();\r\n      }\r\n      \r\n      // Check if request was aborted after API call but before processing\r\n      if (abortSignal?.aborted) {\r\n        throw new DOMException('Request was aborted', 'AbortError');\r\n      }\r\n      const { cleanContent, tags } = parseOtakonTags(rawContent);\r\n\r\n      const aiResponse: AIResponse = {\r\n        content: cleanContent,\r\n        suggestions: [],\r\n        otakonTags: tags,\r\n        rawContent: rawContent,\r\n        metadata: {\r\n          model: 'gemini-flash',\r\n          timestamp: Date.now(),\r\n          cost: 0, // Placeholder\r\n          tokens: 0, // Placeholder\r\n        }\r\n      };\r\n      \r\n      //  QUERY TRACKING: Record usage in database (non-blocking)\r\n      const { SupabaseService } = await import('./supabaseService');\r\n      const supabaseService = SupabaseService.getInstance();\r\n      supabaseService.recordQuery(user.authUserId, hasImages ? 'image' : 'text')\r\n        .catch(error => console.warn('Failed to record query usage:', error));\r\n      \r\n      // Invalidate user cache so next request gets fresh usage data\r\n      const { authService } = await import('./authService');\r\n      authService.refreshUser()\r\n        .catch(error => console.warn('Failed to refresh user after query:', error));\r\n      \r\n      // Cache the response for 1 hour (non-blocking - fire and forget)\r\n      cacheService.set(cacheKey, aiResponse, 60 * 60 * 1000)\r\n        .catch(error => console.warn('Failed to cache AI response:', error));\r\n      \r\n      return aiResponse;\r\n\r\n    } catch (error) {\r\n      console.error(\"AI Service Error:\", error);\r\n      \r\n      //  FIX 4: Enhanced error handling for safety blocks\r\n      const errorMessage = (error as Error).message || '';\r\n      if (errorMessage.includes('blocked') || errorMessage.includes('SAFETY') || errorMessage.includes('content policy')) {\r\n        toastService.error('Your message contains inappropriate content');\r\n        throw new Error('Content blocked by safety filters');\r\n      }\r\n      \r\n      toastService.error('AI response failed. Please try again.');\r\n      \r\n      // Use error recovery service\r\n      const recoveryAction = await errorRecoveryService.handleAIError(\r\n        error as Error,\r\n        {\r\n          operation: 'getChatResponse',\r\n          conversationId: conversation.id,\r\n          userId: user.id,\r\n          timestamp: Date.now(),\r\n          retryCount: 0\r\n        }\r\n      );\r\n      \r\n      if (recoveryAction.type === 'retry') {\r\n        // Retry the request\r\n        return this.getChatResponse(conversation, user, userMessage, isActiveSession, hasImages, imageData, abortSignal);\r\n      } else if (recoveryAction.type === 'user_notification') {\r\n        // Return a user-friendly error response\r\n        return {\r\n          content: recoveryAction.message || \"I'm having trouble thinking right now. Please try again later.\",\r\n          suggestions: [\"Try again\", \"Check your connection\", \"Contact support\"],\r\n          otakonTags: new Map(),\r\n          rawContent: recoveryAction.message || \"Error occurred\",\r\n          metadata: {\r\n            model: 'error',\r\n            timestamp: Date.now(),\r\n            cost: 0,\r\n            tokens: 0\r\n          }\r\n        };\r\n      }\r\n      \r\n      throw new Error(\"Failed to get response from AI service.\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Enhanced method to get AI chat response with structured data\r\n   * Returns enhanced AIResponse with optional fields for better integration\r\n   * Falls back to OTAKON_TAG parsing if JSON mode fails\r\n   */\r\n  public async getChatResponseWithStructure(\r\n    conversation: Conversation,\r\n    user: User,\r\n    userMessage: string,\r\n    isActiveSession: boolean,\r\n    hasImages: boolean = false,\r\n    imageData?: string,\r\n    abortSignal?: AbortSignal\r\n  ): Promise<AIResponse> {\r\n    // Create cache key for this request - use full message hash to avoid collisions\r\n    const hashString = (str: string) => {\r\n      let hash = 0;\r\n      for (let i = 0; i < str.length; i++) {\r\n        const char = str.charCodeAt(i);\r\n        hash = ((hash << 5) - hash) + char;\r\n        hash = hash & hash;\r\n      }\r\n      return hash.toString(36);\r\n    };\r\n    \r\n    const messageHash = hashString(userMessage + (imageData || ''));\r\n    const cacheKey = `ai_structured_${conversation.id}_${messageHash}_${isActiveSession}_${hasImages}`;\r\n    \r\n    // Check cache first\r\n    const cachedResponse = await cacheService.get<AIResponse>(cacheKey, true);\r\n    if (cachedResponse) {\r\n      return { ...cachedResponse, metadata: { ...cachedResponse.metadata, fromCache: true } };\r\n    }\r\n\r\n    // Get enhanced prompt with context\r\n    const basePrompt = getPromptForPersona(conversation, userMessage, user, isActiveSession, hasImages);\r\n    \r\n    // Add immersion context for game conversations (not Game Hub)\r\n    let immersionContext = '';\r\n    if (!conversation.isGameHub && conversation.gameTitle && conversation.genre) {\r\n      immersionContext = characterImmersionService.generateImmersionContext({\r\n        gameTitle: conversation.gameTitle,\r\n        genre: conversation.genre,\r\n        currentLocation: conversation.activeObjective,\r\n        playerProgress: conversation.gameProgress\r\n      });\r\n    }\r\n\r\n    // Add structured response instructions\r\n    const structuredInstructions = `\r\n\r\n**ENHANCED RESPONSE FORMAT:**\r\nIn addition to your regular response, provide structured data in the following optional fields:\r\n\r\n1. **followUpPrompts** (array of 3-4 strings): Generate contextual follow-up questions directly related to your response content\r\n   ${!conversation.isGameHub ? `\r\n   - Session Mode: ${isActiveSession ? 'PLAYING MODE - User is actively playing' : 'PLANNING MODE - User is preparing/strategizing'}\r\n   - ${isActiveSession \r\n       ? 'Generate immediate, actionable prompts (e.g., \"How do I beat this boss?\", \"What should I do next?\")'\r\n       : 'Generate strategic, planning prompts (e.g., \"What should I prepare?\", \"What builds are recommended?\")'\r\n     }` : ''}\r\n2. **progressiveInsightUpdates** (array): If conversation provides new info, update existing subtabs (e.g., story_so_far, characters)\r\n3. **stateUpdateTags** (array): Detect game events (e.g., \"OBJECTIVE_COMPLETE: true\", \"TRIUMPH: Boss Name\")\r\n4. **gamePillData** (object): ${conversation.isGameHub ? 'Set shouldCreate: true if user asks about a specific game, and include game details with pre-filled wikiContent' : 'Set shouldCreate: false (already in game tab)'}\r\n\r\nNote: These are optional enhancements. If not applicable, omit or return empty arrays.\r\n`;\r\n    \r\n    const prompt = basePrompt + immersionContext + structuredInstructions;\r\n    \r\n    console.log(' [AIService] Processing structured request:', { \r\n      hasImages, \r\n      conversationId: conversation.id,\r\n      useStructuredMode: !hasImages // Only use JSON mode for text\r\n    });\r\n    \r\n    // Check if request was aborted\r\n    if (abortSignal?.aborted) {\r\n      throw new DOMException('Request was aborted', 'AbortError');\r\n    }\r\n    \r\n    try {\r\n      //  NEW: Also use grounding for structured requests when appropriate\r\n      const needsWebSearch = \r\n        userMessage.toLowerCase().includes('release') ||\r\n        userMessage.toLowerCase().includes('new games') ||\r\n        userMessage.toLowerCase().includes('latest') ||\r\n        userMessage.toLowerCase().includes('news') ||\r\n        userMessage.toLowerCase().includes('announced') ||\r\n        userMessage.toLowerCase().includes('update') ||\r\n        userMessage.toLowerCase().includes('patch') ||\r\n        userMessage.toLowerCase().includes('current') ||\r\n        userMessage.toLowerCase().includes('recent') ||\r\n        (conversation.gameTitle && (\r\n          conversation.gameTitle.toLowerCase().includes('2025') ||\r\n          conversation.gameTitle.toLowerCase().includes('2024')\r\n        ));\r\n      \r\n      //  SECURITY: Use Edge Function for structured responses\r\n      if (USE_EDGE_FUNCTION) {\r\n        // Extract base64 image data if present\r\n        let imageBase64: string | undefined;\r\n        if (hasImages && imageData) {\r\n          imageBase64 = imageData.split(',')[1];\r\n        }\r\n\r\n        const modelName = 'gemini-2.5-flash-preview-09-2025';\r\n        \r\n        //  FIX: Don't use Google Search grounding for now - it's causing 500 errors\r\n        // We'll use the model's built-in knowledge which is sufficient for most queries\r\n        const tools = undefined; // Disabled temporarily until edge function is fixed\r\n        // const tools = needsWebSearch && !hasImages \r\n        //   ? [{ googleSearchRetrieval: {} }]\r\n        //   : [];\r\n\r\n        const edgeResponse = await this.callEdgeFunction({\r\n          prompt,\r\n          image: imageBase64,\r\n          temperature: 0.7,\r\n          maxTokens: 2048,\r\n          requestType: hasImages ? 'image' : 'text',\r\n          model: modelName,\r\n          tools: tools\r\n        });\r\n\r\n        if (!edgeResponse.success) {\r\n          throw new Error(edgeResponse.response || 'AI request failed');\r\n        }\r\n\r\n        const rawContent = edgeResponse.response;\r\n        const { cleanContent, tags } = parseOtakonTags(rawContent);\r\n\r\n        const aiResponse: AIResponse = {\r\n          content: cleanContent,\r\n          suggestions: tags.get('SUGGESTIONS') || [],\r\n          otakonTags: tags,\r\n          rawContent: rawContent,\r\n          metadata: {\r\n            model: modelName,\r\n            timestamp: Date.now(),\r\n            cost: 0,\r\n            tokens: 0,\r\n          }\r\n        };\r\n\r\n        cacheService.set(cacheKey, aiResponse, 60 * 60 * 1000).catch(err => console.warn(err));\r\n        return aiResponse;\r\n      }\r\n\r\n      // Legacy: Direct API mode\r\n      const modelToUse = needsWebSearch && !hasImages \r\n        ? this.flashModelWithGrounding \r\n        : this.flashModel;\r\n      \r\n      if (needsWebSearch && !hasImages) {\r\n        console.log(' [AIService] Using Google Search grounding for structured response:', {\r\n          gameTitle: conversation.gameTitle,\r\n          query: userMessage.substring(0, 50) + '...'\r\n        });\r\n      }\r\n      \r\n      // Prepare content\r\n      let content: any;\r\n      if (hasImages && imageData) {\r\n        const mimeType = imageData.split(';')[0].split(':')[1] || 'image/jpeg';\r\n        const base64Data = imageData.split(',')[1];\r\n        \r\n        content = [\r\n          { text: prompt },\r\n          { inlineData: { mimeType, data: base64Data } }\r\n        ];\r\n        \r\n        // For images, use regular mode (not JSON) because images don't work well with JSON schema\r\n        const result = await modelToUse.generateContent(content);\r\n        const rawContent = await result.response.text();\r\n        const { cleanContent, tags } = parseOtakonTags(rawContent);\r\n        \r\n        const aiResponse: AIResponse = {\r\n          content: cleanContent,\r\n          suggestions: tags.get('SUGGESTIONS') || [],\r\n          otakonTags: tags,\r\n          rawContent: rawContent,\r\n          metadata: {\r\n            model: 'gemini-2.5-flash-preview-09-2025',\r\n            timestamp: Date.now(),\r\n            cost: 0,\r\n            tokens: 0,\r\n          }\r\n        };\r\n        \r\n        cacheService.set(cacheKey, aiResponse, 60 * 60 * 1000).catch(err => console.warn(err));\r\n        return aiResponse;\r\n      }\r\n      \r\n      // For text-only, try JSON schema mode for structured response\r\n      try {\r\n        const result = await modelToUse.generateContent({\r\n          contents: [{ role: 'user', parts: [{ text: prompt }] }],\r\n          generationConfig: {\r\n            responseMimeType: \"application/json\",\r\n            responseSchema: {\r\n              type: SchemaType.OBJECT,\r\n              properties: {\r\n                content: { type: SchemaType.STRING, description: \"The main chat response for the user\" },\r\n                followUpPrompts: { \r\n                  type: SchemaType.ARRAY, \r\n                  items: { type: SchemaType.STRING },\r\n                  description: \"3-4 contextual follow-up questions\"\r\n                },\r\n                progressiveInsightUpdates: {\r\n                  type: SchemaType.ARRAY,\r\n                  items: {\r\n                    type: SchemaType.OBJECT,\r\n                    properties: {\r\n                      tabId: { type: SchemaType.STRING },\r\n                      title: { type: SchemaType.STRING },\r\n                      content: { type: SchemaType.STRING }\r\n                    }\r\n                  }\r\n                },\r\n                stateUpdateTags: {\r\n                  type: SchemaType.ARRAY,\r\n                  items: { type: SchemaType.STRING }\r\n                },\r\n                gamePillData: {\r\n                  type: SchemaType.OBJECT,\r\n                  properties: {\r\n                    shouldCreate: { type: SchemaType.BOOLEAN },\r\n                    gameName: { type: SchemaType.STRING },\r\n                    genre: { type: SchemaType.STRING },\r\n                    wikiContent: { \r\n                      type: SchemaType.STRING,\r\n                      description: \"JSON string containing pre-filled subtab content\"\r\n                    }\r\n                  }\r\n                }\r\n              },\r\n              required: [\"content\"]\r\n            }\r\n          }\r\n        });\r\n        \r\n        //  FIX 5: Check safety response\r\n        const safetyCheck = this.checkSafetyResponse(result);\r\n        if (!safetyCheck.safe) {\r\n          toastService.error('Unable to generate response due to content policy');\r\n          throw new Error(safetyCheck.reason);\r\n        }\r\n        \r\n        const rawResponse = await result.response.text();\r\n        const structuredData = JSON.parse(rawResponse);\r\n        \r\n        //  Clean content: Remove any JSON-like structured data from the main content\r\n        let cleanContent = structuredData.content || '';\r\n        \r\n        // Remove structured fields if AI accidentally includes them in content\r\n        // This handles cases where AI outputs: \"Hint: ... followUpPrompts: [...]\"\r\n        cleanContent = cleanContent\r\n          //  FIX: Remove ANY leading brackets/JSON artifacts more aggressively\r\n          .replace(/^[\\s\\]}\\[{),]+/g, '') // eslint-disable-line no-useless-escape\r\n          //  CRITICAL: Remove entire JSON block at the end (starts with { and contains \"followUpPrompts\")\r\n          .replace(/\\s*\\{[\\s\\S]*?\"followUpPrompts\"[\\s\\S]*?\\}\\s*$/gi, '')\r\n          // Alternative: Remove JSON block if it starts with newline + {\r\n          .replace(/\\n\\s*\\{[\\s\\S]*$/g, '')\r\n          //  FIX: Remove trailing brackets/JSON at the end (before metadata sections)\r\n          .replace(/\\s*[\\]}\\s]*(?=\\s*(?:Enhanced Response Data|followUpPrompts|progressiveInsightUpdates|stateUpdateTags|gamePillData|$))/gi, '')\r\n          //  NEW: Remove structured data section markers like \"***]\" or \"---Structured Data:\"\r\n          .replace(/\\*{2,}\\]?\\s*$/g, '')\r\n          .replace(/---+\\s*Structured Data:?[\\s\\S]*$/gi, '')\r\n          .replace(/```json[\\s\\S]*?```/gi, '')\r\n          .trim()\r\n          // Remove \"Enhanced Response Data\" header if present\r\n          .replace(/Enhanced Response Data\\s*/gi, '')\r\n          // Remove followUpPrompts section (non-JSON format)\r\n          .replace(/followUpPrompts:\\s*\\[[\\s\\S]*?\\](?=\\s*(?:progressiveInsightUpdates|stateUpdateTags|gamePillData|$))/gi, '')\r\n          // Remove progressiveInsightUpdates section\r\n          .replace(/progressiveInsightUpdates:\\s*\\[[\\s\\S]*?\\](?=\\s*(?:followUpPrompts|stateUpdateTags|gamePillData|$))/gi, '')\r\n          // Remove stateUpdateTags section\r\n          .replace(/stateUpdateTags:\\s*\\[[\\s\\S]*?\\](?=\\s*(?:followUpPrompts|progressiveInsightUpdates|gamePillData|$))/gi, '')\r\n          // Remove gamePillData section (most complex - handles multi-line objects)\r\n          .replace(/gamePillData:\\s*\\{[\\s\\S]*?\\}(?=\\s*$)/gi, '')\r\n          //  FIX: Remove any standalone brackets that might appear in the middle\r\n          .replace(/^\\s*[\\]}]\\s*$/gm, '')\r\n          // Clean up any remaining JSON artifacts\r\n          .replace(/\\{[\\s\\S]*?\"OTAKON_[A-Z_]+\":[\\s\\S]*?\\}/g, '')\r\n          //  Fix malformed bold markers (spaces between ** and text)\r\n          .replace(/\\*\\*\\s+([^*]+?)\\s+\\*\\*/g, '**$1**') // Fix ** text **  **text**\r\n          .replace(/\\*\\*\\s+([^*]+?):/g, '**$1:**') // Fix ** Header:  **Header:**\r\n          //  Format section headers with proper spacing and bold\r\n          // First, ensure headers are properly closed with ** and add line breaks (handles trailing space)\r\n          .replace(/\\*\\*Hint:\\*\\*\\s*/gi, '**Hint:**\\n') // Add line break after Hint\r\n          .replace(/\\*\\*Lore:\\*\\*\\s*/gi, '\\n\\n**Lore:**\\n') // Add line breaks around Lore\r\n          .replace(/\\*\\*Places of Interest:\\*\\*\\s*/gi, '\\n\\n**Places of Interest:**\\n') // Add line breaks around Places\r\n          .replace(/\\*\\*Strategy:\\*\\*\\s*/gi, '\\n\\n**Strategy:**\\n') // Add line breaks around Strategy\r\n          .replace(/\\*\\*What to focus on:\\*\\*\\s*/gi, '\\n\\n**What to focus on:**\\n') // Add line breaks around What to focus\r\n          // Handle headers without existing bold (with or without trailing space)\r\n          .replace(/^Hint:\\s*/i, '**Hint:**\\n') // First Hint at very start\r\n          .replace(/\\nHint:\\s*/gi, '\\n\\n**Hint:**\\n') // Subsequent Hints after newline\r\n          .replace(/\\nLore:\\s*/gi, '\\n\\n**Lore:**\\n') // Lore after newline\r\n          .replace(/\\nPlaces of Interest:\\s*/gi, '\\n\\n**Places of Interest:**\\n') // Places after newline\r\n          .replace(/\\nStrategy:\\s*/gi, '\\n\\n**Strategy:**\\n') // Strategy after newline\r\n          // Remove excessive newlines (but keep double newlines for paragraphs)\r\n          .replace(/\\n{3,}/g, '\\n\\n')\r\n          .trim();\r\n        \r\n        // Parse wikiContent if it's a JSON string\r\n        let gamePillData = structuredData.gamePillData;\r\n        if (gamePillData && typeof gamePillData.wikiContent === 'string') {\r\n          try {\r\n            gamePillData = {\r\n              ...gamePillData,\r\n              wikiContent: JSON.parse(gamePillData.wikiContent)\r\n            };\r\n          } catch {\r\n            // If parsing fails, keep it as is\r\n            console.warn('Failed to parse wikiContent as JSON');\r\n          }\r\n        }\r\n        \r\n        // Build enhanced AIResponse\r\n        const aiResponse: AIResponse = {\r\n          content: cleanContent,\r\n          suggestions: structuredData.followUpPrompts || [],\r\n          otakonTags: new Map(), // Empty for JSON mode\r\n          rawContent: rawResponse,\r\n          metadata: {\r\n            model: 'gemini-2.5-flash-preview-09-2025',\r\n            timestamp: Date.now(),\r\n            cost: 0,\r\n            tokens: 0,\r\n          },\r\n          // Enhanced fields\r\n          followUpPrompts: structuredData.followUpPrompts,\r\n          progressiveInsightUpdates: structuredData.progressiveInsightUpdates,\r\n          stateUpdateTags: structuredData.stateUpdateTags,\r\n          gamePillData\r\n        };\r\n        \r\n        cacheService.set(cacheKey, aiResponse, 60 * 60 * 1000).catch(err => console.warn(err));\r\n        return aiResponse;\r\n        \r\n      } catch (jsonError) {\r\n        console.warn('JSON mode failed, falling back to OTAKON_TAG parsing:', jsonError);\r\n        \r\n        // Fallback to regular OTAKON_TAG parsing\r\n        let rawContent: string;\r\n\r\n        if (USE_EDGE_FUNCTION) {\r\n          // Use Edge Function for fallback\r\n          const edgeResponse = await this.callEdgeFunction({\r\n            prompt,\r\n            temperature: 0.7,\r\n            maxTokens: 2048,\r\n            requestType: 'text',\r\n            model: 'gemini-2.5-flash-preview-09-2025'\r\n          });\r\n\r\n          if (!edgeResponse.success) {\r\n            throw new Error(edgeResponse.response || 'AI request failed');\r\n          }\r\n\r\n          rawContent = edgeResponse.response;\r\n        } else {\r\n          // Legacy: Direct API\r\n          const result = await modelToUse.generateContent(prompt);\r\n          \r\n          //  FIX 5: Check safety response in fallback\r\n          const safetyCheck = this.checkSafetyResponse(result);\r\n          if (!safetyCheck.safe) {\r\n            toastService.error('Unable to generate response due to content policy');\r\n            throw new Error(safetyCheck.reason);\r\n          }\r\n          \r\n          rawContent = await result.response.text();\r\n        }\r\n\r\n        const { cleanContent, tags } = parseOtakonTags(rawContent);\r\n        \r\n        const aiResponse: AIResponse = {\r\n          content: cleanContent,\r\n          suggestions: tags.get('SUGGESTIONS') || [],\r\n          otakonTags: tags,\r\n          rawContent: rawContent,\r\n          metadata: {\r\n            model: 'gemini-2.5-flash-preview-09-2025',\r\n            timestamp: Date.now(),\r\n            cost: 0,\r\n            tokens: 0,\r\n          }\r\n        };\r\n        \r\n        cacheService.set(cacheKey, aiResponse, 60 * 60 * 1000).catch(err => console.warn(err));\r\n        return aiResponse;\r\n      }\r\n      \r\n    } catch (error) {\r\n      console.error(\"Structured AI Service Error:\", error);\r\n      \r\n      //  FIX 5: Enhanced error handling for safety blocks\r\n      const errorMessage = (error as Error).message || '';\r\n      if (errorMessage.includes('blocked') || errorMessage.includes('SAFETY') || errorMessage.includes('content policy')) {\r\n        toastService.error('Your message contains inappropriate content');\r\n        throw new Error('Content blocked by safety filters');\r\n      }\r\n      \r\n      toastService.error('AI response failed. Please try again.');\r\n      \r\n      // Use error recovery with proper retry tracking\r\n      const context = {\r\n        operation: 'getChatResponseWithStructure',\r\n        conversationId: conversation.id,\r\n        userId: user.id,\r\n        timestamp: Date.now(),\r\n        retryCount: 0\r\n      };\r\n      \r\n      const recoveryAction = await errorRecoveryService.handleAIError(\r\n        error as Error,\r\n        context\r\n      );\r\n      \r\n      if (recoveryAction.type === 'retry') {\r\n        errorRecoveryService.incrementRetryCount(context);\r\n        return this.getChatResponseWithStructure(conversation, user, userMessage, isActiveSession, hasImages, imageData, abortSignal);\r\n      } else if (recoveryAction.type === 'user_notification') {\r\n        errorRecoveryService.resetRetryCount(context);\r\n        return {\r\n          content: recoveryAction.message || \"I'm having trouble thinking right now. Please try again later.\",\r\n          suggestions: [\"Try again\", \"Check your connection\", \"Contact support\"],\r\n          otakonTags: new Map(),\r\n          rawContent: recoveryAction.message || \"Error occurred\",\r\n          metadata: {\r\n            model: 'error',\r\n            timestamp: Date.now(),\r\n            cost: 0,\r\n            tokens: 0\r\n          }\r\n        };\r\n      }\r\n      \r\n      throw new Error(\"Failed to get structured response from AI service.\");\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generates initial sub-tab content for a new game\r\n   */\r\n  public async generateInitialInsights(\r\n    gameTitle: string, \r\n    genre: string,\r\n    playerProfile?: PlayerProfile,\r\n    conversationContext?: string //  NEW: Actual conversation messages for context-aware generation\r\n  ): Promise<Record<string, string>> {\r\n    //  CRITICAL: Use conversation context in cache key if provided\r\n    const contextHash = conversationContext \r\n      ? conversationContext.substring(0, 50).replace(/[^a-z0-9]/gi, '') \r\n      : 'default';\r\n    const cacheKey = `insights_${gameTitle.toLowerCase().replace(/\\s+/g, '-')}_${contextHash}`;\r\n    \r\n    // Check cache first\r\n    const cachedInsights = await cacheService.get<Record<string, string>>(cacheKey);\r\n    if (cachedInsights) {\r\n      return cachedInsights;\r\n    }\r\n\r\n    const config = insightTabsConfig[genre] || insightTabsConfig['Default'];\r\n    const instructions = config\r\n      .map(tab => `- ${tab.title} (${tab.id}): ${tab.instruction}`)\r\n      .join('\\n');\r\n\r\n    // Get player profile context if available\r\n    const profile = playerProfile || profileAwareTabService.getDefaultProfile();\r\n    const profileContext = profileAwareTabService.buildProfileContext(profile);\r\n\r\n    //  CRITICAL: Include conversation context for relevant subtab generation\r\n    const contextSection = conversationContext \r\n      ? `\\nConversation Context:\\n${conversationContext}\\n\\n USE THIS CONTEXT to generate relevant subtab content based on what was discussed!\\n` \r\n      : '';\r\n\r\n    const prompt = `\r\nYou are a gaming assistant generating initial content for ${gameTitle} (${genre} game).\r\n\r\nPlayer Profile:\r\n${profileContext}\r\n${contextSection}\r\nInstructions for each tab:\r\n${instructions}\r\n\r\nCRITICAL FORMATTING RULES:\r\n1. Return ONLY valid JSON, nothing else (no markdown fences, no explanations)\r\n2. Use this exact format: {\"tab_id\": \"content\", \"tab_id\": \"content\"}\r\n3. Each content value should be 2-4 detailed paragraphs (150-250 words per tab for comprehensive insights)\r\n4. Keep content STRUCTURED and informative:\r\n   - Use **bold** for key terms and important points\r\n   - Use *italic* for emphasis\r\n   - Use \\\\n\\\\n for paragraph breaks (double newline)\r\n   - Escape ALL quotes with \\\\\"\r\n   - NO line breaks inside strings (use \\\\n instead)\r\n   - Use bullet points with  for lists when appropriate\r\n5. Content should be detailed, spoiler-free, and helpful for players at this stage\r\n6. Adapt content style based on the Player Profile above\r\n7. YOU MUST generate comprehensive content for ALL ${config.length} tab IDs listed below\r\n8. Provide actionable advice, specific details, and contextual information\r\n\r\nExample valid JSON (TARGET THIS LEVEL OF DETAIL):\r\n{\r\n  \"story_so_far\": \"Following the disastrous **Konpeki Plaza heist**, you barely escaped with your life. The Relic, an advanced biochip containing the digital ghost of legendary rockerboy **Johnny Silverhand**, is now killing you from the inside. You have mere weeks to find a solution.\\\\n\\\\nYou've been working with **Takemura**, a disgraced Arasaka bodyguard seeking to clear his name and expose the conspiracy behind the assassination of his former boss. The investigation has led you through Night City's criminal underworld, uncovering corporate secrets and dangerous truths.\\\\n\\\\nYour current location in **Jig-Jig Street** suggests you're deep in the heart of Westbrook, a district known for high-end entertainment and corporate intrigue. Every decision matters as you race against time.\",\r\n  \"quest_log\": \"**Main Quest: The Space in Between**\\\\nTakemura has information crucial to your survival. His message indicated urgency and possible security concerns. Meeting him could provide vital leads on removing the Relic or expose you to Arasaka operatives still hunting you both.\\\\n\\\\n**Recommended Side Activities:**\\\\n Explore Jig-Jig Street for vendors offering rare cyberware upgrades\\\\n Check nearby ripperdocs for health monitoring and neural optimization\\\\n Investigate gig opportunities from local fixers to build street cred\",\r\n  \"build_optimization\": \"Based on your current progress, consider these optimization strategies:\\\\n\\\\n**Cyberware Focus:** Invest in neural processors and reflex boosters to improve combat responsiveness. The **Sandevistan** operating system offers time dilation for tactical advantages during firefights.\\\\n\\\\n**Skill Synergies:** Balance Technical Ability for crafting legendary gear with Intelligence for quickhacking capabilities. This combination allows both direct combat and stealthy netrunning approaches.\\\\n\\\\n**Weapon Loadout:** Maintain variety - keep a silenced pistol for stealth, a tech weapon for cover penetration, and a power weapon for raw damage.\",\r\n  \"boss_strategy\": \"Upcoming encounters in this arc will test your combat adaptability. **Tactical Recommendations:**\\\\n\\\\nYour opponents likely use advanced corporate-grade cyberware and coordinated tactics. Prioritize cover-based gameplay and use the environment to your advantage. Explosive barrels and electrical panels can turn the battlefield in your favor.\\\\n\\\\n**Key Strategies:**\\\\n Maintain distance and use tech weapons to attack through walls\\\\n Neutralize enemy netrunners first to prevent quickhacks\\\\n Stock up on MaxDoc inhalers and bounce-back injectors\\\\n Save frequently before major confrontations\",\r\n  \"hidden_paths\": \"**Jig-Jig Street Secrets:**\\\\nLook for the **Clouds** entertainment establishment - there's a hidden databank terminal behind the reception desk containing valuable corporate intel. Access requires moderate Technical Ability or convincing dialogue options.\\\\n\\\\n**Exploration Tip:**\\\\nThe alleyways near the main street have vertical access points leading to rooftop areas. These elevated positions offer tactical advantages and often contain loot crates with rare crafting components. Watch for glowing yellow ledges indicating climbable surfaces.\"\r\n}\r\n\r\nNOW generate COMPREHENSIVE valid JSON for ALL these tab IDs (MUST include every single one): ${config.map(t => t.id).join(', ')}\r\n`;\r\n\r\n    try {\r\n      let responseText: string;\r\n\r\n      if (USE_EDGE_FUNCTION) {\r\n        // Use Edge Function for insights generation\r\n        const edgeResponse = await this.callEdgeFunction({\r\n          prompt,\r\n          temperature: 0.7,\r\n          maxTokens: 5000, //  Increased to 5000 to accommodate comprehensive 150-250 word insights per tab\r\n          requestType: 'text',\r\n          model: 'gemini-2.5-flash-preview-09-2025' // Back to Flash model\r\n        });\r\n\r\n        if (!edgeResponse.success) {\r\n          throw new Error(edgeResponse.response || 'AI request failed');\r\n        }\r\n\r\n        responseText = edgeResponse.response;\r\n      } else {\r\n        // Legacy: Direct API\r\n        const result = await this.proModel.generateContent(prompt);\r\n        \r\n        //  FIX 6: Check safety response\r\n        const safetyCheck = this.checkSafetyResponse(result);\r\n        if (!safetyCheck.safe) {\r\n          toastService.error('Unable to generate insights due to content policy');\r\n          throw new Error(safetyCheck.reason);\r\n        }\r\n\r\n        responseText = await result.response.text();\r\n      }\r\n      \r\n      const cleanedJson = responseText.replace(/```json\\n?|\\n?```/g, '').trim();\r\n      \r\n      //  FIX: Better JSON parsing with fallback\r\n      let insights: Record<string, string>;\r\n      try {\r\n        insights = JSON.parse(cleanedJson);\r\n      } catch (parseError) {\r\n        console.error(\"JSON parse failed, attempting to fix malformed JSON:\", parseError);\r\n        console.error(\"Raw response (first 500 chars):\", responseText.substring(0, 500));\r\n        \r\n        // Try to fix common JSON issues\r\n        let fixedJson = cleanedJson;\r\n        \r\n        //  IMPROVED: More robust unterminated string fixing\r\n        // Step 1: Find the last complete property before truncation\r\n        const lastCompleteProperty = fixedJson.lastIndexOf('\",');\r\n        if (lastCompleteProperty > 0 && !fixedJson.endsWith('}')) {\r\n          // Truncate at last complete property and close JSON\r\n          fixedJson = fixedJson.substring(0, lastCompleteProperty + 1) + '\\n}';\r\n          console.error(\" Detected truncated response, using last complete property\");\r\n        } else {\r\n          // Try pattern-based fixes\r\n          // Fix unterminated strings by adding closing quote\r\n          fixedJson = fixedJson.replace(/(\"(?:[^\"\\\\]|\\\\.)*?)(?=\\n\\s*\"[^\"]+\"\\s*:|$)/gm, (match) => {\r\n            if (!match.endsWith('\"')) {\r\n              return match + '\"';\r\n            }\r\n            return match;\r\n          });\r\n          \r\n          // Fix missing commas between properties\r\n          fixedJson = fixedJson.replace(/\"\\s*\\n\\s*\"/g, '\",\\n\"');\r\n          \r\n          // Fix missing closing brace\r\n          if (!fixedJson.endsWith('}')) {\r\n            const openBraces = (fixedJson.match(/{/g) || []).length;\r\n            const closeBraces = (fixedJson.match(/}/g) || []).length;\r\n            for (let i = 0; i < openBraces - closeBraces; i++) {\r\n              fixedJson += '\\n}';\r\n            }\r\n          }\r\n        }\r\n        \r\n        try {\r\n          insights = JSON.parse(fixedJson);\r\n          console.error(\" Successfully fixed malformed JSON\");\r\n          console.error(\" Recovered\", Object.keys(insights).length, \"insights\");\r\n          \r\n          //  NEW: If AI only returned some insights, generate fallback for missing ones\r\n          const config = insightTabsConfig[genre] || insightTabsConfig['Default'];\r\n          const missingTabs = config.filter(tab => !insights[tab.id]);\r\n          if (missingTabs.length > 0) {\r\n            console.error(` AI only generated ${Object.keys(insights).length}/${config.length} insights, filling ${missingTabs.length} missing tabs with fallback`);\r\n            missingTabs.forEach(tab => {\r\n              insights[tab.id] = `Welcome to **${tab.title}** for ${gameTitle}!\\n\\nThis section will be populated as you explore and chat about the game.`;\r\n            });\r\n          }\r\n        } catch (_secondError) {\r\n          console.error(\" Could not fix JSON, using fallback content for all tabs\");\r\n          console.error(\" Raw response that failed (first 1000 chars):\", responseText.substring(0, 1000));\r\n          console.error(\" This may be an AI generation issue - consider retrying or checking prompt\");\r\n          \r\n          // Return generic welcome content for each tab\r\n          const config = insightTabsConfig[genre] || insightTabsConfig['Default'];\r\n          insights = config.reduce((acc, tab) => {\r\n            acc[tab.id] = `Welcome to **${tab.title}** for ${gameTitle}!\\n\\nThis section will be populated as you explore and chat about the game.`;\r\n            return acc;\r\n          }, {} as Record<string, string>);\r\n        }\r\n      }\r\n\r\n      // Cache for 24 hours\r\n      await cacheService.set(cacheKey, insights, 24 * 60 * 60 * 1000);\r\n      return insights;\r\n\r\n    } catch (error) {\r\n      console.error(\"Failed to generate initial insights:\", error);\r\n      \r\n      //  FIX 6: Enhanced error handling for safety blocks\r\n      const errorMessage = (error as Error).message || '';\r\n      if (errorMessage.includes('blocked') || errorMessage.includes('SAFETY') || errorMessage.includes('content policy')) {\r\n        toastService.warning('Unable to generate insights due to content policy');\r\n        return {};\r\n      }\r\n      \r\n      toastService.warning('Failed to generate game insights. You can still continue chatting!');\r\n      return {};\r\n    }\r\n  }\r\n}\r\n\r\nexport const aiService = new AIService();\r\n"],"file":"assets/chat-services-BzkZy3oA.js"}