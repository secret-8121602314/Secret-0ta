import{s as I}from"./auth-kUTsFur_.js";import{C as y,i as j,d as V,e as Z}from"./chat-services-CwxifS3-.js";import{m as C,i as K,t as Y}from"./services-B9QpZZw_.js";const O=new Map,R=new Map,ee=1800*1e3,J="otagon_igdb_cache",F=1440*60*1e3,Q="otagon_cover_urls";function te(){try{const a=localStorage.getItem(J);if(a){const e=JSON.parse(a);if(e.version===1&&Date.now()-e.timestamp<F){for(const[t,r]of Object.entries(e.games))Date.now()-r.timestamp<F&&R.set(t,r);console.log("[IGDBService] Loaded",R.size,"games from localStorage cache")}}}catch(a){console.warn("[IGDBService] Error loading localStorage cache:",a)}}function ae(){try{const a={};R.forEach((t,r)=>{a[r]=t});const e={version:1,timestamp:Date.now(),games:a};localStorage.setItem(J,JSON.stringify(e))}catch(a){console.warn("[IGDBService] Error saving localStorage cache:",a)}}function re(){try{const a=localStorage.getItem(Q);if(a){const e=JSON.parse(a);if(e.version===1&&Date.now()-e.timestamp<F)return console.log("[IGDBService] Loaded",Object.keys(e.urls).length,"cover URLs from localStorage"),new Map(Object.entries(e.urls))}}catch(a){console.warn("[IGDBService] Error loading cover URL cache:",a)}return new Map}function X(a){try{const e={version:1,timestamp:Date.now(),urls:Object.fromEntries(a)};localStorage.setItem(Q,JSON.stringify(e))}catch(e){console.warn("[IGDBService] Error saving cover URL cache:",e)}}te();const x=re();function z(a,e="cover_small"){if(!a)return;let t=a;return t=t.replace(/t_(thumb|cover_small|cover_big|720p|1080p|screenshot_huge)/g,`t_${e}`),t.startsWith("//")?t="https:"+t:t.startsWith("http")||(t="https://"+t),t}function be(a){var e;if((e=a==null?void 0:a.cover)!=null&&e.url)return z(a.cover.url,"cover_small")}async function ne(a){if(!a||a.trim().length===0)return console.warn("[IGDBService] Empty game name provided"),null;const e=a.toLowerCase().trim(),t=R.get(e);if(t&&Date.now()-t.timestamp<ee)return console.log("[IGDBService] Session cache hit:",a),t.data;if(O.has(e)){console.log("[IGDBService] Waiting for pending request:",a);const n=O.get(e);if(n)return n}const r=(async()=>{var n,o,s;try{console.log("[IGDBService] Fetching game data:",a);const{data:{session:l}}=await I.auth.getSession(),p={"Content-Type":"application/json"};l!=null&&l.access_token&&(p.Authorization=`Bearer ${l.access_token}`),console.log("[IGDBService] Invoking igdb-proxy with gameName:",a);const h=await I.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:a}),headers:p});if(h.error){console.error("[IGDBService] Edge function error:",h.error);const u=h.error;return((n=u==null?void 0:u.message)!=null&&n.includes("IGDB_NOT_CONFIGURED")||(o=u==null?void 0:u.message)!=null&&o.includes("503"))&&console.warn("[IGDBService] IGDB service not configured - game data will not be available"),null}const c=h.data;if((c==null?void 0:c.code)==="IGDB_NOT_CONFIGURED")return console.warn("[IGDBService] IGDB service not configured on server"),null;if(!c.success||!c.data)return console.log("[IGDBService] No data found for:",a),null;const i=c.data;if(R.set(e,{data:i,timestamp:Date.now()}),ae(),(s=i.cover)!=null&&s.url){const u=z(i.cover.url,"cover_small");u&&(x.set(e,u),X(x),console.log("[IGDBService] Saved cover URL to cache:",e))}return console.log("[IGDBService] Successfully fetched:",i.name,c.cached?"(cached)":"(fresh)"),i}catch(l){return console.error("[IGDBService] Error fetching game data:",l),null}finally{O.delete(e)}})();return O.set(e,r),r}async function ye(a){return ne(`id:${a}`)}async function Se(a){if(!a||a.trim().length<2)return[];try{console.log("[IGDBService] Searching games:",a);const{data:{session:e}}=await I.auth.getSession(),t={"Content-Type":"application/json"};e!=null&&e.access_token&&(t.Authorization=`Bearer ${e.access_token}`);const r=await I.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:a,searchMode:"multi"}),headers:t});if(r.error)return console.error("[IGDBService] Search error:",r.error),[];const n=r.data;if(!n.success||!n.data)return[];const o=n.data;console.log("[IGDBService] Search found",o.length,"games");for(const s of o){const l=s.name.toLowerCase().trim();R.set(l,{data:s,timestamp:Date.now()})}return o}catch(e){return console.error("[IGDBService] Search error:",e),[]}}function _e(a,e="high"){return`https://img.youtube.com/vi/${a}/${{default:"default",medium:"mqdefault",high:"hqdefault",maxres:"maxresdefault"}[e]}.jpg`}function ve(a){return{1:"Official",2:"Wikia",3:"Wikipedia",4:"Facebook",5:"Twitter",6:"Twitch",8:"Instagram",9:"YouTube",10:"iPhone",11:"iPad",12:"Android",13:"Steam",14:"Reddit",15:"Itch.io",16:"Epic Games",17:"GOG",18:"Discord"}[a]||"Website"}function Te(a,e){return a===1?{6:"RP (Rating Pending)",7:"EC (Early Childhood)",8:"E (Everyone)",9:"E10+ (Everyone 10+)",10:"T (Teen)",11:"M (Mature 17+)",12:"AO (Adults Only)"}[e]||"Not Rated":a===2&&{1:"PEGI 3",2:"PEGI 7",3:"PEGI 12",4:"PEGI 16",5:"PEGI 18"}[e]||"Not Rated"}function we(a){return a?new Date(a*1e3).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"TBA"}function Ge(a){return a?a.filter(e=>e.developer).map(e=>e.company.name):[]}function Ae(a){return a.total_rating??a.aggregated_rating??a.rating??null}async function Ce(a){var n;const e=new Map;if(a.length===0)return e;const t=a.map(o=>o.toLowerCase().trim()),r=[];for(const o of t){const s=x.get(o);s?e.set(o,s):r.push(o)}if(r.length===0)return console.log("[IGDBService] All cover URLs from localStorage cache:",e.size),e;try{const{data:o,error:s}=await I.from("igdb_game_cache").select("game_name_key, game_data").in("game_name_key",r).gt("expires_at",new Date().toISOString());if(s)return console.warn("[IGDBService] Error fetching cover URLs from cache:",s.message),e;if(o){for(const l of o){const p=l.game_data;if((n=p==null?void 0:p.cover)!=null&&n.url){const h=z(p.cover.url,"cover_small");h&&(e.set(l.game_name_key,h),x.set(l.game_name_key,h))}}X(x)}console.log("[IGDBService] Fetched cover URLs:",e.size,"of",a.length,"(",e.size-r.length+((o==null?void 0:o.length)??0),"from localStorage,",(o==null?void 0:o.length)||0,"from Supabase)")}catch(o){console.warn("[IGDBService] Error in fetchCoverUrlsFromCache:",o)}return e}const m={LIBRARY:"otagon_gaming_library",TIMELINE:"otagon_gaming_timeline",NEWS_CACHE:"otagon_gaming_news_cache",NEWS_GENERATION_LOG:"otagon_news_generation_log",GAME_KNOWLEDGE:"otagon_game_knowledge",USER_PROFILE:"otagon_user_gaming_profile",GAMEPLAY_SESSIONS:"otagon_gameplay_sessions",IGDB_HOME_CACHE:"otagon_igdb_home_cache",SEARCH_HISTORY:"otagon_game_search_history"};function L(){var a;return((a=crypto.randomUUID)==null?void 0:a.call(crypto))||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function _(a,e){try{const t=localStorage.getItem(a);return t?JSON.parse(t):e}catch(t){return console.warn(`[GamingExplorerStorage] Error reading ${a}:`,t),e}}function S(a,e){try{return localStorage.setItem(a,JSON.stringify(e)),!0}catch(t){return console.error(`[GamingExplorerStorage] Error writing ${a}:`,t),!1}}const Ie={getAll(){return _(m.LIBRARY,[])},getByCategory(a){return this.getAll().filter(t=>t.category===a)},getByIgdbId(a){return this.getAll().find(t=>t.igdbGameId===a)},getByGameTitle(a){const e=this.getAll(),t=a.toLowerCase().trim();return e.find(r=>r.gameName.toLowerCase().trim()===t)},getGameCategories(a){return this.getAll().filter(t=>t.igdbGameId===a).map(t=>t.category)},addGame(a,e,t,r,n){const o=this.getAll(),s=o.find(p=>p.igdbGameId===a&&p.category===t);if(s)return s.updatedAt=Date.now(),n!=null&&n.platform&&(s.platform=n.platform),n!=null&&n.personalRating&&(s.personalRating=n.personalRating),n!=null&&n.completionStatus&&(s.completionStatus=n.completionStatus),r&&(s.igdbData=r),S(m.LIBRARY,o),this.updateStats(),s;const l={id:L(),igdbGameId:a,gameName:e,category:t,platform:n==null?void 0:n.platform,personalRating:n==null?void 0:n.personalRating,completionStatus:(n==null?void 0:n.completionStatus)||(t==="own"?"not_started":void 0),igdbData:r,dateAdded:Date.now(),updatedAt:Date.now()};return o.push(l),S(m.LIBRARY,o),this.updateStats(),t==="own"&&de(a,e),l},updateGame(a,e){const t=this.getAll(),r=t.findIndex(n=>n.id===a);return r===-1?null:(t[r]={...t[r],...e,updatedAt:Date.now()},S(m.LIBRARY,t),this.updateStats(),t[r])},removeGame(a,e){const t=this.getAll(),r=t.filter(n=>!(n.igdbGameId===a&&n.category===e));return r.length===t.length?!1:(S(m.LIBRARY,r),this.updateStats(),!0)},moveGame(a,e,t){const r=this.getAll(),n=r.find(o=>o.igdbGameId===a&&o.category===e);return n?(n.category=t,n.updatedAt=Date.now(),S(m.LIBRARY,r),this.updateStats(),!0):!1},toggleCategory(a,e,t,r){return this.getAll().find(s=>s.igdbGameId===a&&s.category===t)?(this.removeGame(a,t),{added:!1}):{added:!0,item:this.addGame(a,e,t,r)}},updateStats(){const a=this.getAll(),e=W.get();e.libraryStats={ownedCount:a.filter(t=>t.category==="own").length,completedCount:a.filter(t=>t.category==="own"&&t.completionStatus==="completed").length,wishlistCount:a.filter(t=>t.category==="wishlist").length,favoritesCount:a.filter(t=>t.category==="favorite").length,dislikedCount:a.filter(t=>t.category==="disliked").length,totalHoursPlayed:a.reduce((t,r)=>t+(r.hoursPlayed||0),0)},e.lastUpdated=Date.now(),W.save(e)}},oe={getAll(){return _(m.TIMELINE,[]).sort((e,t)=>new Date(t.eventDate).getTime()-new Date(e.eventDate).getTime())},getByYear(a){return this.getAll().filter(t=>t.year===a)},getYears(){const a=this.getAll();return[...new Set(a.map(t=>t.year))].sort((t,r)=>r-t)},addEvent(a){const e=this.getAll(),t={...a,id:L(),createdAt:Date.now(),updatedAt:Date.now()};return e.push(t),S(m.TIMELINE,e),t},updateEvent(a,e){const t=_(m.TIMELINE,[]),r=t.findIndex(n=>n.id===a);return r===-1?null:(t[r]={...t[r],...e,updatedAt:Date.now()},S(m.TIMELINE,t),t[r])},deleteEvent(a){const e=_(m.TIMELINE,[]),t=e.filter(r=>r.id!==a);return t.length===e.length?!1:(S(m.TIMELINE,t),!0)},addConsole(a,e,t,r){return this.addEvent({type:"console",eventDate:`${e}-01-01`,year:e,title:a,description:t,photos:r?[r]:void 0})},addPCBuild(a,e,t,r){return this.addEvent({type:"pc_build",eventDate:`${e}-01-01`,year:e,title:a,specs:t,photos:r})},addGameMilestone(a,e,t,r,n){return this.addEvent({type:"game",eventDate:`${t}-01-01`,year:t,title:a,description:r,igdbGameId:e,igdbData:n})}},Ee={getAll(){return _(m.GAMEPLAY_SESSIONS,[])},getByGame(a){return this.getAll().filter(t=>t.igdbGameId===a)},getByDateAndGame(a,e){return this.getAll().find(r=>r.sessionDate===a&&r.igdbGameId===e)},addScreenshot(a,e,t){const r=this.getAll(),n=new Date().toISOString().split("T")[0];let o=r.find(l=>l.sessionDate===n&&l.igdbGameId===a);o||(o={id:L(),igdbGameId:a,gameName:e,sessionDate:n,screenshots:[],createdAt:Date.now()},r.push(o));const s={...t,id:L(),sessionId:o.id};return o.screenshots.push(s),S(m.GAMEPLAY_SESSIONS,r),o},getScreenshotCount(a){return this.getByGame(a).reduce((t,r)=>t+r.screenshots.length,0)}},De={get(a){const t=_(m.NEWS_CACHE,[]).find(r=>r.promptType===a);return t&&t.expiresAt>Date.now()?t:null},save(a){const e=_(m.NEWS_CACHE,[]),t=e.findIndex(r=>r.promptType===a.promptType);t>=0?e[t]=a:e.push(a),S(m.NEWS_CACHE,e)},canGenerate(a,e){const t=_(m.NEWS_GENERATION_LOG,[]),r=Date.now()-1440*60*1e3,n=t.find(o=>o.userId===a&&o.promptType===e&&o.generatedAt>r);return n?{allowed:!1,nextAvailableAt:n.generatedAt+1440*60*1e3}:{allowed:!0}},logGeneration(a,e){const r=_(m.NEWS_GENERATION_LOG,[]).filter(n=>!(n.userId===a&&n.promptType===e));r.push({userId:a,promptType:e,generatedAt:Date.now()}),S(m.NEWS_GENERATION_LOG,r)},getCacheAge(a){const e=this.get(a);return e?Math.floor((Date.now()-e.cachedAt)/(3600*1e3)):null}},H={get(a){return _(m.GAME_KNOWLEDGE,[]).find(t=>t.igdbGameId===a)||null},exists(a){return this.get(a)!==null},save(a){const e=_(m.GAME_KNOWLEDGE,[]),t=e.findIndex(r=>r.igdbGameId===a.igdbGameId);t>=0?e[t]={...a,lastUpdated:Date.now()}:e.push(a),S(m.GAME_KNOWLEDGE,e)},getAllExtracted(){return _(m.GAME_KNOWLEDGE,[]).map(e=>e.igdbGameId)}},W={get(){return _(m.USER_PROFILE,{libraryStats:{ownedCount:0,completedCount:0,wishlistCount:0,favoritesCount:0,dislikedCount:0,totalHoursPlayed:0},lastUpdated:Date.now()})},save(a){S(m.USER_PROFILE,a)},setGamingStartYear(a){const e=this.get();e.gamingStartYear=a,e.lastUpdated=Date.now(),this.save(e)},getGamingStartYear(){return this.get().gamingStartYear},needsOnboarding(){return this.get().gamingStartYear===void 0}},se=1440*60*1e3,Re={get(){const a=_(m.IGDB_HOME_CACHE,null);return a?Date.now()-a.cachedAt>se?(this.clear(),null):a:null},set(a){const e={...a,cachedAt:Date.now()};S(m.IGDB_HOME_CACHE,e)},clear(){localStorage.removeItem(m.IGDB_HOME_CACHE)},isValid(){return this.get()!==null}},ie=12,xe={getAll(){return _(m.SEARCH_HISTORY,[])},getGames(){return this.getAll().map(a=>a.gameData)},add(a){const t=this.getAll().filter(n=>n.gameData.id!==a.id),r=[{gameData:a,searchedAt:Date.now()},...t].slice(0,ie);S(m.SEARCH_HISTORY,r)},remove(a){const t=this.getAll().filter(r=>r.gameData.id!==a);S(m.SEARCH_HISTORY,t)},clear(){localStorage.removeItem(m.SEARCH_HISTORY)},hasHistory(){return this.getAll().length>0}},P=new Set,ce=()=>"https://qajcxgkqloumogioomiz.supabase.co/functions/v1/ai-proxy",le=a=>`
You are a comprehensive gaming knowledge base. Provide detailed, structured information about "${a}".

Please provide the following in a clear, organized format:

**GAME MECHANICS:**
- Core gameplay loop
- Key systems and how they interact
- Combat/movement mechanics (if applicable)
- Progression systems

**TIPS AND TRICKS:**
- Essential beginner tips (5-7 tips)
- Advanced strategies
- Common mistakes to avoid
- Efficiency tips

**BOSS/CHALLENGE STRATEGIES:**
- Key boss fights or challenging encounters
- Recommended approaches for each
- Equipment/loadout suggestions

**COLLECTIBLES & SECRETS:**
- Types of collectibles in the game
- Notable secrets or hidden content
- Achievement/trophy guidance

**CHARACTER BUILDS (if applicable):**
- Popular/meta builds
- Build archetypes
- Stat priorities

**STORY CONTEXT (spoiler-free):**
- Main themes
- Setting overview
- Key factions/characters (no plot spoilers)

Keep information practical and actionable. Focus on helping players succeed and enjoy the game.
Format with clear headers and bullet points for easy reference.
`;function ge(a,e,t){const r={gameMechanics:"",tipsAndTricks:"",bossStrategies:{},collectibles:{},characterBuilds:{},storyProgression:{}},n=t.match(/\*\*GAME MECHANICS:\*\*[\s\S]*?(?=\*\*TIPS AND TRICKS:|$)/i);n&&(r.gameMechanics=n[0].replace(/\*\*GAME MECHANICS:\*\*/i,"").trim());const o=t.match(/\*\*TIPS AND TRICKS:\*\*[\s\S]*?(?=\*\*BOSS|$)/i);o&&(r.tipsAndTricks=o[0].replace(/\*\*TIPS AND TRICKS:\*\*/i,"").trim());const s=t.match(/\*\*BOSS[\s\S]*?(?=\*\*COLLECTIBLES|$)/i);s&&(r.bossStrategies={content:s[0].trim()});const l=t.match(/\*\*COLLECTIBLES[\s\S]*?(?=\*\*CHARACTER|$)/i);l&&(r.collectibles={content:l[0].trim()});const p=t.match(/\*\*CHARACTER BUILDS[\s\S]*?(?=\*\*STORY|$)/i);p&&(r.characterBuilds={content:p[0].trim()});const h=t.match(/\*\*STORY CONTEXT[\s\S]*$/i);return h&&(r.storyProgression={context:h[0].trim()}),{igdbGameId:e,gameName:a,gameMechanics:r.gameMechanics||void 0,tipsAndTricks:r.tipsAndTricks||void 0,bossStrategies:Object.keys(r.bossStrategies).length>0?r.bossStrategies:void 0,collectibles:Object.keys(r.collectibles).length>0?r.collectibles:void 0,characterBuilds:Object.keys(r.characterBuilds).length>0?r.characterBuilds:void 0,storyProgression:Object.keys(r.storyProgression).length>0?r.storyProgression:void 0,extractedAt:Date.now(),lastUpdated:Date.now()}}async function ue(a,e){if(P.has(a)){console.log(`üéÆ [GameKnowledge] Already fetching knowledge for ${e}`);return}if(H.exists(a)){console.log(`üéÆ [GameKnowledge] Knowledge already exists for ${e}`);return}P.add(a),console.log(`üéÆ [GameKnowledge] Starting background fetch for ${e}...`);try{const{data:{session:t}}=await I.auth.getSession();if(!t){console.warn("üéÆ [GameKnowledge] No auth session, skipping knowledge fetch");return}const r=await fetch(ce(),{method:"POST",headers:{Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({prompt:le(e),requestType:"text",model:"gemini-2.5-flash",temperature:.7,maxTokens:4096,systemPrompt:"You are a helpful gaming knowledge assistant. Provide accurate, practical gaming information."})});if(!r.ok){const o=await r.json();throw new Error(o.error||"Failed to fetch game knowledge")}const n=await r.json();if(n.success&&n.response){const o=ge(e,a,n.response);H.save(o),console.log(`üéÆ [GameKnowledge] ‚úÖ Stored knowledge for ${e}`)}else console.warn(`üéÆ [GameKnowledge] Empty response for ${e}`)}catch(t){console.error(`üéÆ [GameKnowledge] Failed to fetch for ${e}:`,t)}finally{P.delete(a)}}function de(a,e){ue(a,e).catch(t=>{console.error("üéÆ [GameKnowledge] Background fetch failed:",t)})}const B=800,U=2500;function N(a,e){return a.length<=e?a:a.slice(0,e-3)+"..."}function ke(a){const e=H.get(a);if(!e)return null;const t=[];let r=0;if(e.gameMechanics&&r<U){const o=N(e.gameMechanics,B);t.push(`**Game Mechanics:**
${o}`),r+=o.length+20}if(e.tipsAndTricks&&r<U){const o=N(e.tipsAndTricks,B);t.push(`**Tips & Tricks:**
${o}`),r+=o.length+20}if(e.bossStrategies&&typeof e.bossStrategies=="object"&&r<U){const o=e.bossStrategies.content;if(o){const s=N(o,B);t.push(`**Boss Strategies:**
${s}`),r+=s.length+20}}if(t.length===0)return null;const n=`

=== GAME KNOWLEDGE (${e.gameName}) ===
${t.join(`

`)}
===`;return console.log(`üéÆ [GameKnowledge] Injecting ${n.length} chars of context for ${e.gameName}`),n}const q=3e3;function $(){var a;return((a=globalThis.crypto)==null?void 0:a.randomUUID())||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}class me{async createGameTab(e){var l,p,h;const t=await y.getConversation(e.conversationId);if(t){if(e.aiResponse&&((l=t.subtabs)!=null&&l.some(c=>c.status==="loading"||c.content==="Loading..."))){const c=this.extractInsightsFromAIResponse(e.aiResponse,t.subtabs);return await y.updateConversation(t.id,{subtabs:c,updatedAt:Date.now()}),{...t,subtabs:c}}return t}const r=e.userTier||"free",n=r==="pro"||r==="vanguard_pro";console.log("üéÆ [GameTabService] Creating new game tab:",{gameTitle:e.gameTitle,userTier:r,isPro:n,isUnreleased:e.isUnreleased,hasAiResponse:!!e.aiResponse});let o=[];if(!e.isUnreleased&&n)if(e.aiResponse)if(console.error("üéÆ [GameTabService] Extracting subtabs from AI response"),(p=e.aiResponse.gamePillData)!=null&&p.wikiContent&&Object.keys(e.aiResponse.gamePillData.wikiContent).length>0)console.error("üéÆ [GameTabService] Found gamePillData.wikiContent with",Object.keys(e.aiResponse.gamePillData.wikiContent).length,"tabs"),o=Object.entries(e.aiResponse.gamePillData.wikiContent).map(([c,i])=>({id:$(),title:this.formatTabTitle(c),type:this.determineTabType(c),content:i,isNew:!1,status:"loaded"})),console.error("üéÆ [GameTabService] Created",o.length,"subtabs from gamePillData.wikiContent");else if(e.aiResponse.progressiveInsightUpdates&&e.aiResponse.progressiveInsightUpdates.length>0)console.error("üéÆ [GameTabService] Found progressiveInsightUpdates with",e.aiResponse.progressiveInsightUpdates.length,"updates"),o=e.aiResponse.progressiveInsightUpdates.map(c=>({id:$(),title:c.title,type:this.determineTabType(c.tabId),content:c.content,isNew:!1,status:"loaded"})),console.error("üéÆ [GameTabService] Created",o.length,"subtabs from progressiveInsightUpdates");else{const c=this.extractInsightsFromAIResponse(e.aiResponse,[]);c.length>0?(o=c,console.error("üéÆ [GameTabService] Created",o.length,"subtabs from INSIGHT_UPDATE tags")):(o=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile),console.error("üéÆ [GameTabService] Created",o.length,"template subtabs (will populate via background AI using conversation context)"))}else o=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile),console.error("üéÆ [GameTabService] Created",o.length,"initial template subtabs (no AI response)");else e.isUnreleased?console.error("üéÆ [GameTabService] Creating unreleased game tab (no subtabs, Discuss mode only)"):console.error("üîí [GameTabService] Subtabs disabled for free tier users");const s={id:e.conversationId,title:e.gameTitle,messages:[],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,gameId:e.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:e.gameTitle,genre:e.genre,subtabs:o,subtabsOrder:o.map(c=>c.id),isActiveSession:!0,activeObjective:"",gameProgress:0,isUnreleased:e.isUnreleased||!1};if(await y.addConversation(s),o.length>0&&n){console.error("üéÆ [GameTabService] Saving",o.length,"subtabs for conversation:",s.id),console.error("üéÆ [GameTabService] Subtabs:",JSON.stringify(o.map(i=>({id:i.id,title:i.title,type:i.type,hasType:!!i.type})),null,2)),await new Promise(i=>setTimeout(i,200));let c=await C.setSubtabs(s.id,o);c||(console.error("‚ö†Ô∏è [GameTabService] First setSubtabs attempt failed, waiting and retrying..."),await new Promise(i=>setTimeout(i,500)),c=await C.setSubtabs(s.id,o),console.error(c?"‚úÖ [GameTabService] Retry succeeded":"‚ùå [GameTabService] Retry also failed - subtabs will be created by generateInitialInsights"))}else n?console.error("üéÆ [GameTabService] No subtabs to save for conversation:",s.id):console.error("üîí [GameTabService] Skipping subtabs save for free tier user");return n?e.aiResponse?(h=s.subtabs)!=null&&h.some(i=>i.content==="Loading...")&&this.generateInitialInsights(s,e.playerProfile,e.aiResponse).catch(i=>console.error("Background insight generation failed:",i)):this.generateInitialInsights(s,e.playerProfile,e.aiResponse).catch(c=>console.error("Background insight generation failed:",c)):console.error("üîí [GameTabService] Skipping AI insight generation for free tier user"),s}generateInitialSubTabs(e,t,r){let o=(j[e]||j.Default).map(s=>({...s,priority:"medium",isProfileSpecific:!1}));if(t){console.error("üéÆ [GameTabService] Generating profile-specific tabs for:",t.playerFocus);const s=K.generateProfileSpecificTabs(t,r);o=[...o,...s],o=K.prioritizeTabsForProfile(o,t)}return o.map(s=>({id:$(),title:s.title,type:s.type,content:"Loading...",isNew:!0,status:"loading",instruction:s.instruction}))}extractInsightsFromAIResponse(e,t){console.error("ü§ñ [GameTabService] Extracting dynamic insights from AI response");const r=e.otakonTags.get("INSIGHT_UPDATE");if(r){console.error("ü§ñ [GameTabService] Found INSIGHT_UPDATE:",r);const n=r;if(!n.id)return console.error("ü§ñ [GameTabService] INSIGHT_UPDATE missing id, skipping"),t;if(t.find(s=>s.id===n.id))return t.map(s=>s.id===n.id?{...s,content:n.content||s.content,isNew:!0,status:"loaded"}:s);{const s={id:$(),title:this.formatTabTitle(n.id),type:this.determineTabType(n.id),content:n.content||"",isNew:!0,status:"loaded"};return[...t,s]}}return t}formatTabTitle(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}determineTabType(e){return e.includes("story")?"story":e.includes("character")?"characters":e.includes("strategy")||e.includes("tips")?"tips":e.includes("boss")?"strategies":e.includes("quest")||e.includes("walkthrough")?"walkthrough":e.includes("item")?"items":"chat"}async generateInitialInsights(e,t,r){var s,l,p;const n=e.id,o=e.gameTitle;console.error(`ü§ñ [GameTabService] üîÑ [${n}] Generating initial insights for: ${o}`);try{const h=await y.getConversations(!0);if(!h[n]){console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è Conversation no longer exists, aborting insight generation`);return}let c="";const i=h[n],u=((s=i.messages)==null?void 0:s.length)||0;if(u>10)try{const g=await V.loadConversationSummary(n),f=i.messages.slice(-5).map(G=>`${G.role==="user"?"User":"AI"}: ${G.content}`).join(`

`);g?(c=`Previous Context Summary:
${JSON.stringify(g)}

Recent Messages (guaranteed fresh):
${f}`,console.error(`ü§ñ [GameTabService] [${n}] ‚úÖ Using summary + 5 recent messages (${u} total msgs)`)):(c=i.messages.slice(-10).map(G=>`${G.role==="user"?"User":"AI"}: ${G.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${n}] Using last 10 messages (no summary available)`))}catch{c=i.messages.slice(-10).map(f=>`${f.role==="user"?"User":"AI"}: ${f.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${n}] Using last 10 messages (summary load failed)`)}else u>0?(c=i.messages.map(g=>`${g.role==="user"?"User":"AI"}: ${g.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${n}] ‚úÖ Using all ${u} messages`)):r!=null&&r.content?(c=`AI Analysis: ${r.content}`,console.error(`ü§ñ [GameTabService] [${n}] Using AI response as context (${r.content.length} chars)`)):console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è No context available`);console.error(`ü§ñ [GameTabService] [${n}] üöÄ Calling AI generateInitialInsights...`);const d=await Z.generateInitialInsights(o||"Unknown Game",e.genre||"Action RPG",t,c,i.gameProgress||0);console.error(`ü§ñ [GameTabService] [${n}] üì• AI returned:`,Object.keys(d).length,"insights");const v=d&&Object.keys(d).length>0;v?console.error(`ü§ñ [GameTabService] [${n}] ‚úÖ Got ${Object.keys(d).length} insights:`,Object.keys(d)):console.error(`ü§ñ [GameTabService] [${n}] ‚ùå Empty insights, using fallback`);const b=h[n];if(!b){console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è Conversation not found, may have been deleted`);return}let T=await C.getSubtabs(n);console.error(`ü§ñ [GameTabService] [${n}] üìñ Read ${T.length} subtabs from database`),T.length===0&&e.subtabs&&e.subtabs.length>0&&(console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è No subtabs in DB but ${e.subtabs.length} in memory - retrying write`),await new Promise(f=>setTimeout(f,500)),await C.setSubtabs(n,e.subtabs)?(console.error(`ü§ñ [GameTabService] [${n}] ‚úÖ Retry write succeeded`),T=await C.getSubtabs(n),console.error(`ü§ñ [GameTabService] [${n}] üìñ Re-read ${T.length} subtabs from database`)):(console.error(`ü§ñ [GameTabService] [${n}] ‚ùå Retry write failed - using memory subtabs as fallback`),T=e.subtabs)),b.subtabs=T;const A={"Story So Far":"story_so_far","Items You May Have Missed":"missed_items","Relevant Lore":"game_lore","Build Guide":"build_guide","Plan Your Next Session":"next_session_plan","Active Quests":"quest_log","Build Optimization":"build_optimization","Upcoming Boss Strategy":"boss_strategy","Boss Strategy":"boss_strategy","Hidden Paths & Secrets":"hidden_paths","Points of Interest":"points_of_interest","NPC Interactions":"npc_interactions","Consumable Strategy":"consumable_strategy","Character Building":"character_building","Combat Strategies":"combat_strategies","Quest Guide":"quest_guide","Lore Exploration":"lore_exploration","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Pro Tips":"pro_tips","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Exploration Tips":"exploration_tips","Puzzle Solving":"puzzle_solving","Story Progression":"story_progression","Hidden Secrets":"hidden_secrets","Inventory Optimization":"inventory_optimization","Environmental Storytelling":"environmental_storytelling","Goal Suggestions":"goal_suggestions","Efficiency & Optimization":"efficiency_tips","Hidden Mechanics":"hidden_mechanics","Disaster Prep":"disaster_prep","Milestone Roadmap":"milestone_roadmap","System Bottleneck Analysis":"bottleneck_analysis","Expansion Strategy":"expansion_strategy","Team Management":"team_management","Training Focus":"training_focus","Tactical Analysis":"tactical_analysis","Season Progression":"season_progression","Transfer Market Insights":"transfer_market_insights","Injury & Fatigue Management":"injury_fatigue_management","Opposition Scouting":"opposition_scouting","Meta Analysis":"meta_analysis","Team Coordination":"team_coordination","Map Control":"map_control","Skill Development":"skill_development","Ranked Climbing Guide":"ranked_climbing_guide","Warm-up Routine":"warmup_routine","Counter-Meta Strategies":"counter_meta_strategies","Competitive Strategy":"competitive_strategy","Team Synergy":"team_synergy","Performance Optimization":"performance_optimization","Ranked Progression":"ranked_progression","Seasonal Meta Shifts":"seasonal_meta_shifts","Communication Protocols":"communication_protocols","VOD Review Focus Points":"vod_review_focus","Vehicle Tuning":"vehicle_tuning","Track Strategy":"track_strategy","Race Craft":"race_craft","Championship Focus":"championship_focus","Weather Adaptation":"weather_adaptation","Qualifying Strategy":"qualifying_strategy","Rival Analysis":"rival_analysis","Character Analysis":"character_analysis","Matchup Strategy":"matchup_strategy","Execution Training":"execution_training","Tournament Prep":"tournament_prep","Frame Data Insights":"frame_data_insights","Mid-Match Adaptation":"adaptation_tactics","Character Lab Work":"character_lab_work","Drop Strategy":"drop_strategy","Positioning Tactics":"positioning_tactics","Loadout Optimization":"loadout_optimization","Endgame Strategy":"endgame_strategy","Rotation Management":"rotation_management","Audio Warfare":"audio_warfare","Inventory Economy":"inventory_economy","Class Optimization":"class_optimization","Content Progression":"content_progression","Social Strategies":"social_strategies","Alt Character Strategy":"alt_character_strategy","Reputation & Faction Guide":"reputation_faction_guide","Raid Preparation":"raid_preparation","Puzzle Patterns":"puzzle_patterns","Logical Reasoning":"logical_reasoning","Time Optimization":"time_optimization","Difficulty Progression":"difficulty_progression","Mental Breaks Strategy":"mental_breaks_strategy","Pattern Library":"pattern_library","Achievement & Challenge Guide":"achievement_guide","Survival Strategies":"survival_strategies","Enemy Behavior":"enemy_behavior","Atmosphere Navigation":"atmosphere_navigation","Resource Management":"resource_management","Safe Zone Mapping":"safe_zone_mapping","Sanity Management":"sanity_management","Progressive Fear Adaptation":"fear_adaptation","Death Recovery Strategy":"death_recovery","Level Layout Insights":"level_layout","NPC Questlines":"npc_questlines","New Ability Unlocked":"ability_unlocks","Backtracking Guide":"backtracking_guide","Map Completion":"map_completion","Sequence Breaking Options":"sequence_breaking","Upgrade Priority":"upgrade_priority","Region Guide":"region_guide","Activity Checklist":"activity_checklist","Collectible Hunting":"collectible_hunting","Dynamic World Events":"world_events","Exploration Route":"exploration_route","Fast Travel Optimization":"fast_travel_optimization","Progression Balance":"progression_balance","Resource Locations":"resource_locations","Base Building Guide":"base_building","Crafting Priority":"crafting_priority","Survival Tips":"survival_tips","Exploration Targets":"exploration_targets","Progression Roadmap":"progression_roadmap","Danger Warnings":"danger_warnings","Multiplayer Synergy":"multiplayer_synergy","Seasonal Preparation":"seasonal_preparation"};console.error("ü§ñ [GameTabService] Building content mapping for subtabs..."),console.error("ü§ñ [GameTabService] AI returned insight keys:",Object.keys(d));const w=((l=b.subtabs)==null?void 0:l.map(g=>{let f="";const G=A[g.title];if(G||console.error(`‚ö†Ô∏è [GameTabService] MISSING MAPPING: No titleToKeyMap entry for "${g.title}" - will use fallback`),v&&G&&d[G]?(f=d[G],console.error(`‚úÖ [GameTabService] Subtab "${g.title}" ‚Üí key "${G}" ‚Üí AI content (${f.length} chars)`)):v&&G&&console.error(`‚ö†Ô∏è [GameTabService] Subtab "${g.title}" ‚Üí key "${G}" ‚Üí NOT FOUND in AI response`),!f){let M=c;if(g.type==="story"&&c.includes("Lore:")){const E=c.match(/Lore:(.*?)(?=\n\n|\n[A-Z]|$)/s);M=E?E[1].trim():c}else if(g.type==="strategies"&&c.includes("Analysis:")){const E=c.match(/Analysis:(.*?)(?=\n\n|\n[A-Z]|$)/s);M=E?E[1].trim():c}else if(g.type==="tips"&&c.includes("Hint:")){const E=c.match(/Hint:(.*?)(?=\n\n|\n[A-Z]|$)/s);M=E?E[1].trim():c}f=`## ${g.title}

${M}`,console.error(`ü§ñ [GameTabService] Subtab "${g.title}" using fallback content from AI response (${f.length} chars)`),console.error("ü§ñ [GameTabService] Preview:",f.substring(0,150)+"...")}return{...g,content:f,isNew:!1,status:"loaded",type:g.type}}))||[];if(w.length===0){console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è No subtabs to update - aborting`);return}console.error("ü§ñ [GameTabService] Updating subtabs with content...");const D=w.map(g=>{var f;return{id:g.id,title:g.title,type:g.type,status:g.status,contentLength:((f=g.content)==null?void 0:f.length)||0,isNew:g.isNew,hasType:!!g.type}});if(console.error("ü§ñ [GameTabService] Subtabs to save:",D),console.error("ü§ñ [GameTabService] ALL statuses:",w.map(g=>g.status)),console.error("ü§ñ [GameTabService] ALL types:",w.map(g=>g.type||"MISSING_TYPE")),console.error("ü§ñ [GameTabService] üóëÔ∏è Clearing cache BEFORE subtabs write..."),y.clearCache(),!await C.setSubtabs(e.id,w))throw new Error("Failed to update subtabs in database");console.error("ü§ñ [GameTabService] ‚úÖ Subtabs dual-write complete (table + JSONB)"),y.clearCache(),console.error("ü§ñ [GameTabService] üîç Subtabs saved successfully, skipping verification read"),await y.updateConversation(e.id,{updatedAt:Date.now()}),console.error("ü§ñ [GameTabService] ‚úÖ Conversation metadata updated")}catch(h){console.error("ü§ñ [GameTabService] ‚ùå Failed to generate initial insights:",h),Y.warning("Failed to load game insights. You can still chat about the game!");try{const i=(await y.getConversations(!0))[e.id];if(!i){console.error("ü§ñ [GameTabService] Conversation not found for error update:",e.id);return}const u=((p=i.subtabs)==null?void 0:p.map(d=>({...d,content:`Failed to load ${d.title} content. Please try again later.`,isNew:!1,status:"error"})))||[];await C.setSubtabs(e.id,u),await y.updateConversation(e.id,{updatedAt:Date.now()})}catch(c){console.error("ü§ñ [GameTabService] Failed to update error state:",c)}}}async updateSubTabContent(e,t,r){console.error("üìù [GameTabService] Updating sub-tab content:",{conversationId:e,subTabId:t});try{const o=(await y.getConversations())[e];if(!o||!o.subtabs)throw new Error("Conversation or sub-tabs not found");const s=o.subtabs.map(l=>l.id===t?{...l,content:r,isNew:!1,status:"loaded"}:l);await C.setSubtabs(e,s),await y.updateConversation(e,{updatedAt:Date.now()})}catch(n){throw console.error("Failed to update sub-tab content:",n),n}}async getGameTab(e){try{const r=(await y.getConversations())[e];return!r||!r.gameTitle?null:{id:r.id,title:r.title,gameId:r.gameId||r.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:r.gameTitle,genre:r.genre||"Unknown",subtabs:r.subtabs||[],createdAt:r.createdAt,updatedAt:r.updatedAt,isActiveSession:r.isActiveSession||!1}}catch(t){return console.error("Failed to get game tab:",t),Y.error("Failed to load game tab."),null}}isGameTab(e){return!e.isGameHub&&!!e.gameTitle}generateGameConversationId(e){return`game-${e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-")}`}async updateSubtabsAfterMigration(e,t){console.error(`üîÑ [GameTabService] [${e}] Updating subtabs after migration...`);try{const n=(await y.getConversations(!0))[e];if(!n){console.error(`üîÑ [GameTabService] [${e}] ‚ö†Ô∏è Conversation not found, aborting`);return}if(!n.subtabs||n.subtabs.length===0){console.error(`üîÑ [GameTabService] [${e}] No subtabs to update`);return}t!=null&&t.progressiveInsightUpdates&&t.progressiveInsightUpdates.length>0?(console.error(`üîÑ [GameTabService] [${e}] Applying ${t.progressiveInsightUpdates.length} progressive updates`),await this.updateSubTabsFromAIResponse(e,t.progressiveInsightUpdates)):console.error(`üîÑ [GameTabService] [${e}] No progressive updates in AI response`),console.error(`üîÑ [GameTabService] [${e}] ‚úÖ Subtab update complete`)}catch(r){console.error(`üîÑ [GameTabService] [${e}] ‚ùå Failed to update subtabs:`,r)}}async updateSubTabsFromAIResponse(e,t){console.error(`üìù [GameTabService] [${e}] Updating subtabs from AI response:`,t.length),console.error(`üìù [GameTabService] [${e}] Updates to apply:`,t.map(r=>{var n;return{tabId:r.tabId,title:r.title,contentLength:((n=r.content)==null?void 0:n.length)||0}}));try{const n=(await y.getConversations(!0))[e];if(!n||!n.subtabs){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Conversation or subtabs not found, aborting update`);return}console.error(`üìù [GameTabService] [${e}] Found ${n.subtabs.length} subtabs:`,n.subtabs.map(i=>({id:i.id,title:i.title})));const o={"Story So Far":"story_so_far","Items You May Have Missed":"missed_items","Relevant Lore":"game_lore","Build Guide":"build_guide","Plan Your Next Session":"next_session_plan","Active Quests":"quest_log","Build Optimization":"build_optimization","Upcoming Boss Strategy":"boss_strategy","Boss Strategy":"boss_strategy","Hidden Paths & Secrets":"hidden_paths","Points of Interest":"points_of_interest","NPC Interactions":"npc_interactions","Consumable Strategy":"consumable_strategy","Character Building":"character_building","Combat Strategies":"combat_strategies","Quest Guide":"quest_guide","Lore Exploration":"lore_exploration","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Pro Tips":"pro_tips","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Exploration Tips":"exploration_tips","Puzzle Solving":"puzzle_solving","Story Progression":"story_progression","Hidden Secrets":"hidden_secrets","Inventory Optimization":"inventory_optimization","Environmental Storytelling":"environmental_storytelling","Goal Suggestions":"goal_suggestions","Efficiency & Optimization":"efficiency_tips","Hidden Mechanics":"hidden_mechanics","Disaster Prep":"disaster_prep","Milestone Roadmap":"milestone_roadmap","System Bottleneck Analysis":"bottleneck_analysis","Expansion Strategy":"expansion_strategy","Team Management":"team_management","Training Focus":"training_focus","Tactical Analysis":"tactical_analysis","Season Progression":"season_progression","Transfer Market Insights":"transfer_market_insights","Injury & Fatigue Management":"injury_fatigue_management","Opposition Scouting":"opposition_scouting","Meta Analysis":"meta_analysis","Team Coordination":"team_coordination","Map Control":"map_control","Skill Development":"skill_development","Ranked Climbing Guide":"ranked_climbing_guide","Warm-up Routine":"warmup_routine","Counter-Meta Strategies":"counter_meta_strategies","Competitive Strategy":"competitive_strategy","Team Synergy":"team_synergy","Performance Optimization":"performance_optimization","Ranked Progression":"ranked_progression","Seasonal Meta Shifts":"seasonal_meta_shifts","Communication Protocols":"communication_protocols","VOD Review Focus Points":"vod_review_focus","Vehicle Tuning":"vehicle_tuning","Track Strategy":"track_strategy","Race Craft":"race_craft","Championship Focus":"championship_focus","Weather Adaptation":"weather_adaptation","Qualifying Strategy":"qualifying_strategy","Rival Analysis":"rival_analysis","Character Analysis":"character_analysis","Matchup Strategy":"matchup_strategy","Execution Training":"execution_training","Tournament Prep":"tournament_prep","Frame Data Insights":"frame_data_insights","Mid-Match Adaptation":"adaptation_tactics","Character Lab Work":"character_lab_work","Drop Strategy":"drop_strategy","Positioning Tactics":"positioning_tactics","Loadout Optimization":"loadout_optimization","Endgame Strategy":"endgame_strategy","Rotation Management":"rotation_management","Audio Warfare":"audio_warfare","Inventory Economy":"inventory_economy","Class Optimization":"class_optimization","Content Progression":"content_progression","Social Strategies":"social_strategies","Alt Character Strategy":"alt_character_strategy","Reputation & Faction Guide":"reputation_faction_guide","Raid Preparation":"raid_preparation","Puzzle Patterns":"puzzle_patterns","Logical Reasoning":"logical_reasoning","Time Optimization":"time_optimization","Difficulty Progression":"difficulty_progression","Mental Breaks Strategy":"mental_breaks_strategy","Pattern Library":"pattern_library","Achievement & Challenge Guide":"achievement_guide","Survival Strategies":"survival_strategies","Enemy Behavior":"enemy_behavior","Atmosphere Navigation":"atmosphere_navigation","Resource Management":"resource_management","Safe Zone Mapping":"safe_zone_mapping","Sanity Management":"sanity_management","Progressive Fear Adaptation":"fear_adaptation","Death Recovery Strategy":"death_recovery","Level Layout Insights":"level_layout","NPC Questlines":"npc_questlines","New Ability Unlocked":"ability_unlocks","Backtracking Guide":"backtracking_guide","Map Completion":"map_completion","Sequence Breaking Options":"sequence_breaking","Upgrade Priority":"upgrade_priority","Region Guide":"region_guide","Activity Checklist":"activity_checklist","Collectible Hunting":"collectible_hunting","Dynamic World Events":"world_events","Exploration Route":"exploration_route","Fast Travel Optimization":"fast_travel_optimization","Progression Balance":"progression_balance","Resource Locations":"resource_locations","Base Building Guide":"base_building","Crafting Priority":"crafting_priority","Survival Tips":"survival_tips","Exploration Targets":"exploration_targets","Progression Roadmap":"progression_roadmap","Danger Warnings":"danger_warnings","Multiplayer Synergy":"multiplayer_synergy","Seasonal Preparation":"seasonal_preparation"},s={};for(const[i,u]of Object.entries(o))s[u]=i;let l=0;const p=n.subtabs.map(i=>{const u=t.find(d=>{if(d.tabId===i.id||d.tabId.toLowerCase()===i.title.toLowerCase()||d.title&&d.title.toLowerCase()===i.title.toLowerCase())return!0;const v=s[d.tabId];if(v&&v===i.title)return!0;const b=o[i.title];return!!(b&&b===d.tabId)});if(u){l++,console.error(`üìù [GameTabService] [${e}] ‚úÖ Matched subtab "${i.title}" (${i.id}) with update.tabId="${u.tabId}"`);const d=new Date().toLocaleString(),v=i.content&&i.content.trim().length>0&&i.content!=="Loading..."&&i.status==="loaded";let b;if(v){const T=i.content,A="<!-- LATEST_UPDATE -->";if(T.includes(A)){const D=T.indexOf(A),k=T.substring(0,D).trim(),g=T.substring(D+A.length).trim(),f=`<details>
<summary>üìã Update from ${d}</summary>

${g}

</details>
`;b=(k?k+`

`+f:f)+`

`+A+`

`+u.content}else b=`<details>
<summary>üìã Initial Content</summary>

${T}

</details>
`+`

`+A+`

`+u.content}else b=`<!-- LATEST_UPDATE -->

`+u.content;if(b.length>q){console.error(`üìù [GameTabService] [${e}] Subtab ${i.id} exceeds ${q} chars, trimming old collapsed sections`);const T=/<details>\s*<summary>.*?<\/summary>[\s\S]*?<\/details>/g,A=b.match(T)||[];if(A.length>2){let w=b;A.slice(0,A.length-2).forEach(g=>{w=w.replace(g,"")}),!w.includes("Earlier history removed")&&w.includes("<!-- LATEST_UPDATE -->")&&(w=`<details>
<summary>‚ÑπÔ∏è Earlier history removed to save space</summary>

Older updates have been automatically removed. Recent updates are preserved.

</details>

`+w),b=w}console.error(`üìù [GameTabService] [${e}] Subtab ${i.id} content trimmed to ${b.length} chars`)}return{...i,title:u.title||i.title,content:b,isNew:!0,status:"loaded"}}return i});if(l===0){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è No subtabs matched for update`),t.forEach(i=>{console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Unmatched update: tabId="${i.tabId}", title="${i.title}"`)});return}const h=new Set;if(n.subtabs.forEach(i=>{const u=t.find(d=>{if(d.tabId===i.id||d.tabId.toLowerCase()===i.title.toLowerCase()||d.title&&d.title.toLowerCase()===i.title.toLowerCase())return!0;const v=s[d.tabId];if(v&&v===i.title)return!0;const b=o[i.title];return!!(b&&b===d.tabId)});u&&h.add(u.tabId)}),t.forEach(i=>{h.has(i.tabId)||console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Update not matched to any subtab: tabId="${i.tabId}", title="${i.title}"`)}),console.error(`üìù [GameTabService] [${e}] Writing ${l} updated subtabs to normalized table...`),!await C.setSubtabs(e,p))throw console.error(`üìù [GameTabService] [${e}] ‚ùå Failed to write subtabs to table`),new Error("Failed to update subtabs in database");y.clearCache(),await y.updateConversation(e,{updatedAt:Date.now()}),console.error(`üìù [GameTabService] [${e}] ‚úÖ Updated ${l} subtabs successfully (table + cache cleared)`)}catch(r){throw console.error(`üìù [GameTabService] [${e}] ‚ùå Failed to update subtabs:`,r),r}}async generateSubtabsForExistingGameTabs(e,t,r){const n=Object.values(e).filter(o=>!o.isGameHub&&!o.isUnreleased&&o.gameTitle&&(!o.subtabs||o.subtabs.length===0));if(n.length===0){console.log("üîÑ [GameTabService] No game tabs need subtabs generation");return}console.log(`üîÑ [GameTabService] Found ${n.length} game tabs that need subtabs`);for(let o=0;o<n.length;o++){const s=n[o];try{console.log(`üîÑ [GameTabService] Generating subtabs for "${s.gameTitle}" (${o+1}/${n.length})`);const l=this.generateInitialSubTabs(s.genre||"Default",t);await y.updateConversation(s.id,{subtabs:l,subtabsOrder:l.map(p=>p.id),updatedAt:Date.now()}),await C.setSubtabs(s.id,l),await this.generateInitialInsights({...s,subtabs:l},t),console.log(`‚úÖ [GameTabService] Successfully generated subtabs for "${s.gameTitle}"`),r==null||r(o,n.length,s.gameTitle||s.title),o<n.length-1&&await new Promise(p=>setTimeout(p,1e3))}catch(l){console.error(`‚ùå [GameTabService] Failed to generate subtabs for "${s.gameTitle}":`,l)}}r==null||r(n.length,n.length,"Complete"),console.log(`üîÑ [GameTabService] Finished generating subtabs for ${n.length} game tabs`)}}const Me=new me,Oe={async fetchGalleryData(a){try{const{data:e,error:t}=await I.from("conversations").select("id, title, game_title").eq("user_id",a);if(t)return console.error("[GalleryService] Error fetching conversations:",t),{albums:[],totalImages:0,loading:!1,error:t.message};if(!e||e.length===0)return{albums:[],totalImages:0,loading:!1};const r=e.map(c=>c.id),{data:n,error:o}=await I.from("messages").select("id, image_url, conversation_id, content, role, created_at").in("conversation_id",r).not("image_url","is",null).order("created_at",{ascending:!1});if(o)return console.error("[GalleryService] Error fetching messages:",o),{albums:[],totalImages:0,loading:!1,error:o.message};const s=new Map(e.map(c=>[c.id,{title:c.title,gameTitle:c.game_title}])),l=new Map;(n||[]).forEach(c=>{var v;if(!c.image_url)return;const i=s.get(c.conversation_id);if(!i)return;const u={id:c.id,imageUrl:c.image_url,conversationId:c.conversation_id,conversationTitle:i.title||"Untitled",gameTitle:i.gameTitle||void 0,messageContent:((v=c.content)==null?void 0:v.substring(0,100))||void 0,capturedAt:new Date(c.created_at||Date.now()).getTime(),role:c.role},d=l.get(c.conversation_id);d?(d.images.push(u),d.imageCount++,d.latestImageAt=Math.max(d.latestImageAt,u.capturedAt)):l.set(c.conversation_id,{conversationId:c.conversation_id,conversationTitle:i.title||"Untitled",gameTitle:i.gameTitle||void 0,coverUrl:void 0,images:[u],imageCount:1,latestImageAt:u.capturedAt})});const p=Array.from(l.values()).sort((c,i)=>i.latestImageAt-c.latestImageAt),h=p.reduce((c,i)=>c+i.imageCount,0);return{albums:p,totalImages:h,loading:!1}}catch(e){return console.error("[GalleryService] Exception:",e),{albums:[],totalImages:0,loading:!1,error:e instanceof Error?e.message:"Unknown error"}}},async downloadImage(a,e){try{const r=await(await fetch(a)).blob(),n=URL.createObjectURL(r),o=document.createElement("a");return o.href=n,o.download=e||`screenshot_${Date.now()}.png`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),!0}catch(t){return console.error("[GalleryService] Download failed:",t),!1}},addToTimeline(a,e,t,r){oe.addEvent({type:"album",eventDate:new Date(a.capturedAt).toISOString().split("T")[0],year:t,title:e,description:r||`Screenshot from ${a.gameTitle||a.conversationTitle}`,photos:[a.imageUrl]})},async getImageCount(a){try{const{data:e}=await I.from("conversations").select("id").eq("user_id",a);if(!e||e.length===0)return 0;const t=e.map(o=>o.id),{count:r,error:n}=await I.from("messages").select("id",{count:"exact",head:!0}).in("conversation_id",t).not("image_url","is",null);return n?(console.error("[GalleryService] Count error:",n),0):r||0}catch(e){return console.error("[GalleryService] Count exception:",e),0}},filterByGame(a,e){return a.filter(t=>{var r;return(r=t.gameTitle)==null?void 0:r.toLowerCase().includes(e.toLowerCase())})},getGameTitles(a){const e=new Set;return a.forEach(t=>{t.gameTitle&&e.add(t.gameTitle)}),Array.from(e).sort()}};export{ne as a,z as b,Ee as c,Se as d,Oe as e,Ce as f,Me as g,ye as h,Re as i,Ge as j,Ae as k,Ie as l,we as m,De as n,Te as o,ve as p,_e as q,ke as r,xe as s,oe as t,W as u,be as v};
