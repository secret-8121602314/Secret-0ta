var U=Object.defineProperty;var P=(n,t,e)=>t in n?U(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var y=(n,t,e)=>P(n,typeof t!="symbol"?t+"":t,e);import{s as o}from"./auth-C7rany9s.js";import{T as f,U as x}from"./chat-services-BBVD4nNg.js";import{a as w,t as d,E as O}from"./services-DpBIFzuP.js";function u(n){return!n||typeof n!="object"||Array.isArray(n)?{}:n}function b(n){if(n==null)return null;if(typeof n=="string"||typeof n=="number"||typeof n=="boolean")return n;if(Array.isArray(n))return n.map(b);if(typeof n=="object"){const t={};for(const e in n)Object.prototype.hasOwnProperty.call(n,e)&&(t[e]=b(n[e]));return t}return null}function D(n,t=Date.now()){if(!n)return t;try{return new Date(n).getTime()}catch{return t}}function G(n,t=""){return n??t}function C(n,t=0){return n??t}function T(n,t=!1){return n??t}const v=class v{constructor(){y(this,"authState",{user:null,isLoading:!0,error:null});y(this,"listeners",[]);y(this,"pendingUserLoads",new Map);y(this,"cleanupFunctions",[]);y(this,"isDestroyed",!1);this.initializeAuth(),this.setupCleanup()}getCallbackUrl(){const t=window.location.origin;return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"?`${t}/auth/callback`:`${t}/Otagon/auth/callback`}static getInstance(){return v.instance||(v.instance=new v),v.instance}setupCleanup(){const t=()=>{this.isDestroyed||this.cleanup()};window.addEventListener("beforeunload",t),this.cleanupFunctions.push(()=>{window.removeEventListener("beforeunload",t)})}async checkRateLimit(t){if(this.isDestroyed)return!1;const e=await w.getRateLimit(t),r=Date.now();return!e||r>e.resetTime?(await w.setRateLimit(t,{count:1,resetTime:r+900*1e3}),!0):e.count>=10?!1:(await w.setRateLimit(t,{count:e.count+1,resetTime:e.resetTime}),!0)}async getCachedUser(t){return this.isDestroyed?null:await w.getUser(t)}async setCachedUser(t,e){this.isDestroyed||await w.setUser(t,e)}async clearCache(){await w.clear()}async invalidateUserCache(t){const e=`user:${t}`;await w.delete(e)}async initializeAuth(){try{if(window.location.pathname==="/auth/callback"||window.location.pathname==="/Otagon/auth/callback"){console.log("ğŸ” [AuthService] OAuth callback detected, but AuthCallback component will handle it");return}try{const{data:{session:e}}=await o.auth.getSession();e!=null&&e.user?await this.loadUserFromSupabase(e.user.id):this.updateAuthState({user:null,isLoading:!1,error:null})}catch{const r=localStorage.getItem("otakon_user");if(r)try{const a=JSON.parse(r);this.updateAuthState({user:a,isLoading:!1,error:null})}catch{this.updateAuthState({user:null,isLoading:!1,error:null})}else this.updateAuthState({user:null,isLoading:!1,error:null})}}catch(t){console.error("Auth initialization error:",t),d.error("Failed to initialize authentication. Please refresh the page.",{action:{label:"Refresh",onClick:()=>window.location.reload()}}),this.updateAuthState({user:null,isLoading:!1,error:null})}}async createUserRecord(t){var e,r,a,i,l,g,m,_;try{console.log("ğŸ” [AuthService] Creating user record for:",t.email);let c="email";(e=t.app_metadata)!=null&&e.provider?c=t.app_metadata.provider:(r=t.app_metadata)!=null&&r.providers&&t.app_metadata.providers.length>0?c=t.app_metadata.providers[0]:t.identities&&t.identities.length>0?c=t.identities[0].provider:(a=t.user_metadata)!=null&&a.provider&&(c=t.user_metadata.provider),console.log("ğŸ” [AuthService] Auth user metadata:",{app_metadata:t.app_metadata,user_metadata:t.user_metadata,identities:t.identities,provider:c}),console.log("ğŸ” [AuthService] OAuth provider:",c);let p;c==="email"?p=t.email:p=`${c}_${t.email}`,console.log("ğŸ” [AuthService] Unique email identifier:",p);const{error:S}=await o.rpc("create_user_record",{p_auth_user_id:t.id,p_email:p,p_full_name:((i=t.user_metadata)==null?void 0:i.full_name)||((l=t.user_metadata)==null?void 0:l.name)||"User",p_avatar_url:(g=t.user_metadata)==null?void 0:g.avatar_url,p_is_developer:!1,p_tier:"free"});if(S){if(S.code==="23505"||(m=S.message)!=null&&m.includes("duplicate key")){console.log("ğŸ” [AuthService] User record already exists (duplicate key), continuing...");return}throw console.error("ğŸ” [AuthService] Error creating user record:",S),d.error("Failed to create your account. Please try again."),S}console.log("ğŸ” [AuthService] User record created successfully")}catch(c){if(c.code==="23505"||(_=c.message)!=null&&_.includes("duplicate key")){console.log("ğŸ” [AuthService] User record already exists (duplicate key in catch), continuing...");return}throw console.error("ğŸ” [AuthService] Error creating user record:",c),d.error("Failed to create your account. Please try again."),c}}extractOriginalEmail(t){const e=["google","discord","github","facebook","twitter","apple"],r=t.split("_");return r.length>1&&e.includes(r[0])?r.slice(1).join("_"):t}async loadUserFromSupabase(t){const e=this.pendingUserLoads.get(t);if(e)return console.log("ğŸ” [AuthService] Deduplicating user load request for:",t),await e;const r=(async()=>{try{await this._loadUserFromSupabaseInternal(t)}finally{this.pendingUserLoads.delete(t)}})();return this.pendingUserLoads.set(t,r),await r}async _loadUserFromSupabaseInternal(t){var e,r,a,i,l,g,m,_;try{const c=await this.getCachedUser(t);if(c){console.log("ğŸ” [AuthService] Using cached user data"),this.updateAuthState({user:c,isLoading:!1,error:null});return}console.log("ğŸ” [AuthService] Loading user data from database for authUserId:",t);const{data:p,error:S}=await o.rpc("get_complete_user_data",{p_auth_user_id:t});if(S){console.log("ğŸ” [AuthService] RPC function failed, trying direct table query...",S);const{data:s,error:h}=await o.from("users").select("*").eq("auth_user_id",t).single();if(h){console.error("ğŸ” [AuthService] Direct table query also failed:",h),this.updateAuthState({user:null,isLoading:!1,error:"Failed to load user data"});return}if(s){console.log("ğŸ” [AuthService] User found via direct table query");const L={id:s.id,authUserId:s.auth_user_id||t,email:this.extractOriginalEmail(s.email),tier:s.tier,hasProfileSetup:s.has_profile_setup||!1,hasSeenSplashScreens:s.has_seen_splash_screens||!1,hasSeenHowToUse:s.has_seen_how_to_use||!1,hasSeenFeaturesConnected:s.has_seen_features_connected||!1,hasSeenProFeatures:s.has_seen_pro_features||!1,pcConnected:s.pc_connected||!1,pcConnectionSkipped:s.pc_connection_skipped||!1,onboardingCompleted:s.onboarding_completed||!1,hasWelcomeMessage:s.has_welcome_message||!1,isNewUser:s.is_new_user||!0,hasUsedTrial:s.has_used_trial||!1,lastActivity:Date.now(),textCount:s.text_count||0,imageCount:s.image_count||0,textLimit:s.text_limit||((e=f[s.tier])==null?void 0:e.text)||0,imageLimit:s.image_limit||((r=f[s.tier])==null?void 0:r.image)||0,totalRequests:s.total_requests||0,lastReset:s.last_reset?new Date(s.last_reset).getTime():Date.now(),preferences:u(s.preferences),usage:{textCount:s.text_count||0,imageCount:s.image_count||0,textLimit:s.text_limit||((a=f[s.tier])==null?void 0:a.text)||0,imageLimit:s.image_limit||((i=f[s.tier])==null?void 0:i.image)||0,totalRequests:s.total_requests||0,lastReset:s.last_reset?new Date(s.last_reset).getTime():Date.now(),tier:s.tier},appState:u(s.app_state),profileData:u(s.profile_data),onboardingData:u(s.onboarding_data),behaviorData:u(s.behavior_data),feedbackData:u(s.feedback_data),usageData:u(s.usage_data),createdAt:s.created_at?new Date(s.created_at).getTime():Date.now(),updatedAt:s.updated_at?new Date(s.updated_at).getTime():Date.now()};await this.setCachedUser(t,L),this.updateAuthState({user:L,isLoading:!1,error:null});return}}if(p&&p.length>0){console.log("ğŸ” [AuthService] User found via RPC function"),console.log("ğŸ” [AuthService] RPC data:",p[0]);const s=p[0],h={id:s.id,authUserId:s.auth_user_id||t,email:this.extractOriginalEmail(s.email),tier:s.tier,hasProfileSetup:s.has_profile_setup||!1,hasSeenSplashScreens:s.has_seen_splash_screens||!1,hasSeenHowToUse:s.has_seen_how_to_use||!1,hasSeenFeaturesConnected:s.has_seen_features_connected||!1,hasSeenProFeatures:s.has_seen_pro_features||!1,pcConnected:s.pc_connected||!1,pcConnectionSkipped:s.pc_connection_skipped||!1,onboardingCompleted:s.onboarding_completed||!1,hasWelcomeMessage:s.has_welcome_message||!1,isNewUser:s.is_new_user||!0,hasUsedTrial:s.has_used_trial||!1,lastActivity:Date.now(),textCount:s.text_count||0,imageCount:s.image_count||0,textLimit:s.text_limit||((l=f[s.tier])==null?void 0:l.text)||0,imageLimit:s.image_limit||((g=f[s.tier])==null?void 0:g.image)||0,totalRequests:s.total_requests||0,lastReset:s.last_reset?new Date(s.last_reset).getTime():Date.now(),preferences:u(s.preferences),usage:{textCount:s.text_count||0,imageCount:s.image_count||0,textLimit:s.text_limit||((m=f[s.tier])==null?void 0:m.text)||0,imageLimit:s.image_limit||((_=f[s.tier])==null?void 0:_.image)||0,totalRequests:s.total_requests||0,lastReset:s.last_reset?new Date(s.last_reset).getTime():Date.now(),tier:s.tier},appState:u(s.app_state),profileData:u(s.profile_data),onboardingData:u(s.onboarding_data),behaviorData:u(s.behavior_data),feedbackData:u(s.feedback_data),usageData:u(s.usage_data),createdAt:s.created_at?new Date(s.created_at).getTime():Date.now(),updatedAt:s.updated_at?new Date(s.updated_at).getTime():Date.now()};console.log("ğŸ” [AuthService] User onboarding flags:",{hasProfileSetup:h.hasProfileSetup,hasSeenSplashScreens:h.hasSeenSplashScreens,hasSeenHowToUse:h.hasSeenHowToUse,hasSeenFeaturesConnected:h.hasSeenFeaturesConnected,hasSeenProFeatures:h.hasSeenProFeatures,pcConnected:h.pcConnected,pcConnectionSkipped:h.pcConnectionSkipped,onboardingCompleted:h.onboardingCompleted}),await this.setCachedUser(t,h),this.updateAuthState({user:h,isLoading:!1,error:null})}else{console.log("ğŸ” [AuthService] User not found, trying to create manually...");try{const{data:{user:s}}=await o.auth.getUser();s?(console.log("ğŸ” [AuthService] Creating user record for auth user:",s.email),await this.createUserRecord(s),await this._loadUserFromSupabaseInternal(t)):this.updateAuthState({user:null,isLoading:!1,error:"User not found and could not create user record"})}catch(s){console.error("ğŸ” [AuthService] Failed to create user record manually:",s),this.updateAuthState({user:null,isLoading:!1,error:"User not found and could not create user record"})}}}catch(c){console.error("Error loading user from Supabase:",c),this.updateAuthState({user:null,isLoading:!1,error:"Failed to load user data"})}}updateAuthState(t){const e={...this.authState};this.authState={...this.authState,...t},JSON.stringify(e)!==JSON.stringify(this.authState)&&this.listeners.forEach(a=>a(this.authState))}async signInWithGoogle(){try{if(!await this.checkRateLimit("google_signin"))return{success:!1,error:"Too many sign-in attempts. Please wait before trying again."};this.updateAuthState({isLoading:!0,error:null}),console.log("ğŸ” [AuthService] Starting Google OAuth...");const t=this.getCallbackUrl();console.log("ğŸ” [AuthService] Redirect URL:",t);const{error:e}=await o.auth.signInWithOAuth({provider:"google",options:{redirectTo:t,queryParams:{prompt:"select_account"}}});return e?(console.error("ğŸ” [AuthService] Google OAuth error:",e),d.error("Failed to sign in with Google. Please try again."),this.updateAuthState({isLoading:!1,error:e.message}),{success:!1,error:e.message}):(console.log("ğŸ” [AuthService] Google OAuth initiated successfully"),{success:!0})}catch(t){return O.handleAuthError(t,"signInWithGoogle"),d.error("Google sign-in failed. Please try again."),this.updateAuthState({user:null,isLoading:!1,error:"Google sign-in failed. Please try again."}),{success:!1,error:"Google sign-in failed. Please try again."}}}async signInWithDiscord(){if(!this.checkRateLimit("discord_signin"))return{success:!1,error:"Too many sign-in attempts. Please wait before trying again."};try{this.updateAuthState({isLoading:!0,error:null}),console.log("ğŸ” [AuthService] Starting Discord OAuth...");const t=this.getCallbackUrl();if(console.log("ğŸ” [AuthService] Redirect URL:",t),console.log("ğŸ” [AuthService] Current origin:",window.location.origin),console.log("ğŸ” [AuthService] Current pathname:",window.location.pathname),console.log("ğŸ” [AuthService] Current port:",window.location.port),console.log("ğŸ” [AuthService] Full URL:",window.location.href),window.location.pathname==="/auth/callback"||window.location.pathname==="/Otagon/auth/callback")return console.log("ğŸ” [AuthService] Already on callback page, skipping OAuth initiation"),this.updateAuthState({isLoading:!1,error:null}),{success:!1,error:"Already on callback page"};localStorage.setItem("otakon_discord_auth_attempt",Date.now().toString()),console.log("ğŸ” [AuthService] Initiating Discord OAuth with redirectTo:",t);const{data:r,error:a}=await o.auth.signInWithOAuth({provider:"discord",options:{redirectTo:t,queryParams:{access_type:"offline",prompt:"consent"}}});if(a){console.error("ğŸ” [AuthService] Discord OAuth error:",a),console.error("ğŸ” [AuthService] Error details:",{message:a.message,status:a.status});let i="Discord authentication failed. ";return a.message.includes("Invalid redirect URI")?i+="Please check Discord OAuth configuration in Supabase dashboard.":a.message.includes("Invalid client")?i+="Discord OAuth credentials are invalid. Please check Supabase configuration.":a.message.includes("access_denied")?i+="Discord authorization was cancelled.":i+=a.message,d.error(`Failed to sign in with Discord. ${i}`),this.updateAuthState({isLoading:!1,error:i}),{success:!1,error:i}}return console.log("ğŸ” [AuthService] Discord OAuth initiated successfully"),console.log("ğŸ” [AuthService] OAuth data:",r),{success:!0}}catch(t){const e=t instanceof Error?t.message:"Unknown error";return console.error("ğŸ” [AuthService] Discord OAuth exception:",t),console.error("ğŸ” [AuthService] Exception details:",{name:t instanceof Error?t.name:"Unknown",message:e,stack:t instanceof Error?t.stack:"No stack trace"}),this.updateAuthState({isLoading:!1,error:e}),{success:!1,error:e}}}async signInWithEmail(t,e){if(!this.checkRateLimit(`email_signin_${t}`))return{success:!1,error:"Too many sign-in attempts. Please wait before trying again."};try{this.updateAuthState({isLoading:!0,error:null}),console.log("ğŸ” [AuthService] Starting email sign-in...");const{data:r,error:a}=await o.auth.signInWithPassword({email:t,password:e});if(a){console.error("ğŸ” [AuthService] Email sign-in error:",a);let i=a.message;return a.message.includes("Invalid login credentials")?i="Invalid email or password. If you signed up with Google or Discord, please use those options instead.":a.message.includes("Email not confirmed")?i="Please check your email and click the confirmation link before signing in.":a.message.includes("Too many requests")&&(i="Too many sign-in attempts. Please wait a moment before trying again."),d.error(i),this.updateAuthState({isLoading:!1,error:i}),{success:!1,error:i}}return r.user?(console.log("ğŸ” [AuthService] Email sign-in successful:",r.user.email),d.success("Welcome back! Successfully signed in."),await this.loadUserFromSupabase(r.user.id),{success:!0,user:this.authState.user||void 0}):{success:!1,error:"No user data returned"}}catch(r){const a=r instanceof Error?r.message:"Unknown error";return console.error("ğŸ” [AuthService] Email sign-in exception:",r),d.error("Sign-in failed. Please try again."),this.updateAuthState({isLoading:!1,error:a}),{success:!1,error:a}}}async signUpWithEmail(t,e){try{this.updateAuthState({isLoading:!0,error:null}),console.log("ğŸ” [AuthService] Starting email sign-up...");const{data:r,error:a}=await o.auth.signUp({email:t,password:e,options:{emailRedirectTo:this.getCallbackUrl()}});let i=!1;if(a)if(console.error("ğŸ” [AuthService] Email sign-up error:",a),a.message.includes("Error sending confirmation email"))console.log("ğŸ” [AuthService] Email confirmation disabled, proceeding with sign-up..."),i=!0;else return d.error(`Sign-up failed: ${a.message}`),this.updateAuthState({isLoading:!1,error:a.message}),{success:!1,error:a.message};return r.user?(console.log("ğŸ” [AuthService] Email sign-up successful:",r.user.email),console.log("ğŸ” [AuthService] User confirmation required:",!r.user.email_confirmed_at),r.user.email_confirmed_at?(await this.loadUserFromSupabase(r.user.id),{success:!0,user:this.authState.user||void 0}):(console.log("ğŸ” [AuthService] Email confirmation required, user not yet signed in"),i?(console.log("ğŸ” [AuthService] Email confirmation disabled, creating user record anyway..."),d.success("Account created successfully! Welcome to Otakon!"),await this.loadUserFromSupabase(r.user.id),{success:!0,user:this.authState.user||void 0}):(this.updateAuthState({isLoading:!1,error:null}),{success:!0,user:void 0,requiresConfirmation:!0,message:"Please check your email and click the confirmation link to complete your account setup."}))):{success:!1,error:"No user data returned"}}catch(r){const a=r instanceof Error?r.message:"Unknown error";return console.error("ğŸ” [AuthService] Email sign-up exception:",r),this.updateAuthState({isLoading:!1,error:a}),{success:!1,error:a}}}async resetPassword(t){try{this.updateAuthState({isLoading:!0,error:null});const{error:e}=await o.auth.resetPasswordForEmail(t,{redirectTo:this.getCallbackUrl()});return e?(this.updateAuthState({isLoading:!1,error:e.message}),{success:!1,error:e.message}):(this.updateAuthState({isLoading:!1,error:null}),{success:!0})}catch(e){const r=e instanceof Error?e.message:"Unknown error";return this.updateAuthState({isLoading:!1,error:r}),{success:!1,error:r}}}async signOut(){try{console.log("ğŸ” [AuthService] Starting sign out process..."),await o.auth.signOut();const t=[];for(let e=0;e<localStorage.length;e++){const r=localStorage.key(e);r&&r.startsWith("sb-")&&t.push(r)}t.forEach(e=>localStorage.removeItem(e)),console.log("ğŸ” [AuthService] Cleared Supabase localStorage keys:",t),localStorage.removeItem("otakon_auth_method"),localStorage.removeItem("otakon_remember_me"),localStorage.removeItem("otakon_remembered_email"),localStorage.removeItem("otakon_discord_auth_attempt"),localStorage.removeItem("otakon_has_used_app"),localStorage.removeItem("otakon_user"),localStorage.removeItem("otakon_conversations"),localStorage.removeItem("otakon_app_state"),sessionStorage.clear(),this.clearCache(),this.updateAuthState({user:null,isLoading:!1,error:null}),console.log("ğŸ” [AuthService] Sign out completed successfully"),d.success("Successfully signed out. See you next time!")}catch(t){console.error("ğŸ” [AuthService] Sign out error:",t),d.error("Sign out failed. Please try again."),this.updateAuthState({user:null,isLoading:!1,error:null})}}getCurrentUser(){return this.authState.user}getAuthState(){return this.authState}async clearAllUserData(){try{console.log("ğŸ” [AuthService] Clearing all user data for testing..."),localStorage.removeItem("otakon_auth_method"),localStorage.removeItem("otakon_remember_me"),localStorage.removeItem("otakon_remembered_email"),await o.auth.signOut(),this.updateAuthState({user:null,isLoading:!1,error:null}),console.log("ğŸ” [AuthService] All user data cleared successfully")}catch(t){console.error("ğŸ” [AuthService] Error clearing user data:",t)}}async checkEmailProvider(t){try{return console.log("ğŸ” [AuthService] Checking provider for email:",t),console.log("ğŸ” [AuthService] Skipping provider check to avoid 401 errors during sign-in"),{provider:null,message:""}}catch(e){return console.error("ğŸ” [AuthService] Error checking email provider:",e),{provider:null,message:""}}}async resendConfirmationEmail(t){try{console.log("ğŸ” [AuthService] Resending confirmation email for:",t),this.updateAuthState({isLoading:!0,error:null});const{error:e}=await o.auth.resend({type:"signup",email:t,options:{emailRedirectTo:this.getCallbackUrl()}});return e?(console.error("ğŸ” [AuthService] Error resending confirmation email:",e),d.error("Failed to resend confirmation email. Please try again."),this.updateAuthState({isLoading:!1,error:e.message}),{success:!1,error:e.message}):(console.log("ğŸ” [AuthService] Confirmation email resent successfully"),d.success("Confirmation email sent! Please check your inbox."),this.updateAuthState({isLoading:!1,error:null}),{success:!0,message:"Confirmation email sent! Please check your inbox and click the confirmation link."})}catch(e){const r=e instanceof Error?e.message:"Unknown error";return console.error("ğŸ” [AuthService] Exception resending confirmation email:",e),d.error("Failed to resend confirmation email. Please try again."),this.updateAuthState({isLoading:!1,error:r}),{success:!1,error:r}}}async testDiscordConfiguration(){try{console.log("ğŸ” [AuthService] Testing Discord OAuth configuration...");const{error:t}=await o.auth.getSession();if(t)return{isValid:!1,message:"Cannot access Supabase auth service",details:{sessionError:t}};const e=`${window.location.origin}/auth/callback`;return console.log("ğŸ” [AuthService] Test redirect URL:",e),{isValid:!0,message:"Discord OAuth configuration appears to be valid",details:{redirectUrl:e,currentOrigin:window.location.origin,currentPathname:window.location.pathname}}}catch(t){return console.error("ğŸ” [AuthService] Error testing Discord configuration:",t),{isValid:!1,message:"Error testing Discord configuration",details:{error:t instanceof Error?t.message:"Unknown error"}}}}async refreshUser(){this.authState.user&&(console.log("ğŸ” [AuthService] Refreshing user data..."),await this.invalidateUserCache(this.authState.user.authUserId),await this.loadUserFromSupabase(this.authState.user.authUserId))}async updateUserProfile(t,e){try{const{error:r}=await o.from("users").update({profile_data:e}).eq("auth_user_id",t);if(r)throw console.error("Error updating profile:",r),d.error("Failed to update profile. Please try again."),r;await this.invalidateUserCache(t),await this.loadUserFromSupabase(t),console.log("âœ… Profile preferences updated successfully"),d.success("Profile updated successfully!")}catch(r){throw console.error("Failed to update profile preferences:",r),d.error("Failed to update profile. Please try again."),r}}subscribe(t){return this.listeners.push(t),t(this.authState),()=>{const e=this.listeners.indexOf(t);e>-1&&this.listeners.splice(e,1)}}cleanup(){this.isDestroyed||(console.log("ğŸ§¹ [AuthService] Cleaning up..."),this.isDestroyed=!0,this.clearCache(),this.listeners.length=0,this.cleanupFunctions.forEach(t=>{try{t()}catch(e){console.error("Error during auth service cleanup:",e)}}),this.cleanupFunctions.length=0,console.log("ğŸ§¹ [AuthService] Cleanup completed"))}};y(v,"instance");let E=v;const R=E.getInstance(),W=Object.freeze(Object.defineProperty({__proto__:null,AuthService:E,authService:R},Symbol.toStringTag,{value:"Module"})),A=class A{static getInstance(){return A.instance||(A.instance=new A),A.instance}async getUser(t){try{const{data:e,error:r}=await o.rpc("get_complete_user_data",{p_auth_user_id:t});if(r)return console.error("Error getting user:",r),null;if(e&&e.length>0){const a=e[0];return{id:a.id,authUserId:a.auth_user_id,email:a.email,tier:a.tier,hasProfileSetup:!1,hasSeenSplashScreens:!1,hasSeenHowToUse:!1,hasSeenFeaturesConnected:!1,hasSeenProFeatures:!1,pcConnected:!1,pcConnectionSkipped:!1,onboardingCompleted:!1,hasWelcomeMessage:!1,isNewUser:!0,hasUsedTrial:a.has_used_trial,lastActivity:Date.now(),textCount:a.text_count||0,imageCount:a.image_count||0,textLimit:a.text_limit||55,imageLimit:a.image_limit||25,totalRequests:a.total_requests||0,lastReset:a.last_reset?new Date(a.last_reset).getTime():Date.now(),connectionCode:a.connection_code??void 0,connectionCodeCreatedAt:a.connection_code_created_at?new Date(a.connection_code_created_at).getTime():void 0,connectionActive:a.connection_active??void 0,connectionDeviceInfo:u(a.connection_device_info),lastConnectionAt:a.last_connection_at?new Date(a.last_connection_at).getTime():void 0,trialStartedAt:a.trial_started_at?new Date(a.trial_started_at).getTime():void 0,trialExpiresAt:a.trial_expires_at?new Date(a.trial_expires_at).getTime():void 0,preferences:u(a.preferences),usage:{textCount:a.text_count,imageCount:a.image_count,textLimit:a.text_limit,imageLimit:a.image_limit,totalRequests:0,lastReset:Date.now(),tier:a.tier},appState:u(a.app_state),profileData:u(a.profile_data),onboardingData:{},behaviorData:{},feedbackData:{},usageData:{},createdAt:Date.now(),updatedAt:Date.now()}}return null}catch(e){return console.error("Error getting user:",e),null}}async updateUser(t,e){try{const{error:r}=await o.from("users").update({tier:e.tier,has_used_trial:e.hasUsedTrial,last_activity:e.lastActivity,preferences:e.preferences,app_state:e.appState,profile_data:e.profileData,onboarding_data:e.onboardingData,behavior_data:e.behaviorData,feedback_data:e.feedbackData,usage_data:e.usageData,updated_at:new Date().toISOString()}).eq("auth_user_id",t);return r?(console.error("Error updating user:",r),!1):!0}catch(r){return console.error("Error updating user:",r),!1}}async updateUsage(t,e){try{const{error:r}=await o.from("users").update({text_count:e.textCount,image_count:e.imageCount,text_limit:e.textLimit,image_limit:e.imageLimit,updated_at:new Date().toISOString()}).eq("auth_user_id",t);return r?(console.error("Error updating usage:",r),!1):!0}catch(r){return console.error("Error updating usage:",r),!1}}async getConversations(t){try{console.log("ğŸ” [Supabase] Querying conversations for auth_user_id:",t);const{data:e,error:r}=await o.from("conversations").select("*").order("updated_at",{ascending:!1});if(console.log("ğŸ” [Supabase] Unfiltered query result:",{error:r==null?void 0:r.message,count:(e==null?void 0:e.length)||0}),!r&&e&&e.length>0)return console.log("âœ… [Supabase] RLS auto-filtering worked! Returned",e.length,"conversations"),this.mapConversations(e);console.log("ğŸ” [Supabase] Trying with explicit auth_user_id filter...");const{data:a,error:i}=await o.from("conversations").select("*").eq("auth_user_id",t).order("updated_at",{ascending:!1});return i?(console.error("âŒ [Supabase] Error getting conversations:",i),console.error("âŒ [Supabase] Error details:",JSON.stringify(i)),[]):(console.log("âœ… [Supabase] Filtered query returned",a.length,"conversations"),this.mapConversations(a))}catch(e){return console.error("Error getting conversations:",e),[]}}mapConversations(t){return t.map(e=>({id:e.id,authUserId:e.auth_user_id??void 0,userId:e.user_id??void 0,title:e.title,messages:Array.isArray(e.messages)?e.messages:[],gameId:e.game_id??void 0,gameTitle:e.game_title??void 0,genre:e.genre??void 0,subtabs:Array.isArray(e.subtabs)?e.subtabs:[],subtabsOrder:e.subtabs_order||[],isActiveSession:e.is_active_session,activeObjective:e.active_objective??void 0,gameProgress:e.game_progress??void 0,createdAt:D(e.created_at),updatedAt:D(e.updated_at),isActive:e.is_active,isPinned:e.is_pinned??void 0,pinnedAt:e.pinned_at?new Date(e.pinned_at).getTime():void 0,isGameHub:e.is_game_hub??void 0,isUnreleased:e.is_unreleased??void 0,contextSummary:e.context_summary??void 0,lastSummarizedAt:e.last_summarized_at?new Date(e.last_summarized_at).getTime():void 0}))}async createConversation(t,e){var r,a;try{const{data:{session:i}}=await o.auth.getSession();console.log("ğŸ” [Supabase] Current session user:",(r=i==null?void 0:i.user)==null?void 0:r.id,"vs provided userId:",t),(!i||i.user.id!==t)&&console.error("âŒ [Supabase] Session mismatch! RLS will block reads. Session:",(a=i==null?void 0:i.user)==null?void 0:a.id,"vs userId:",t);const l={auth_user_id:t,title:e.title,messages:e.messages,game_id:e.gameId,game_title:e.gameTitle,genre:e.genre,subtabs:e.subtabs||[],subtabs_order:e.subtabsOrder||[],is_active_session:e.isActiveSession,active_objective:e.activeObjective,game_progress:e.gameProgress,is_active:e.isActive,is_pinned:e.isPinned,pinned_at:e.pinnedAt?new Date(e.pinnedAt).toISOString():null,is_game_hub:e.isGameHub};e.id&&(l.id=e.id),console.log("ğŸ” [Supabase] Upserting conversation:",{id:l.id,title:l.title,auth_user_id:l.auth_user_id,is_game_hub:l.is_game_hub,is_active:l.is_active});const{data:g,error:m}=await o.from("conversations").upsert(l,{onConflict:"id",ignoreDuplicates:!1}).select("id").single();if(m)return console.error("âŒ [Supabase] Error creating/updating conversation:",m),console.error("âŒ [Supabase] Error details:",JSON.stringify(m)),null;console.log("âœ… [Supabase] Conversation upserted successfully:",g.id);const{data:_,error:c}=await o.from("conversations").select("id, title").eq("id",g.id).single();return c?(console.error("âš ï¸ [Supabase] Cannot read back conversation after upsert!",c.message),console.error("âš ï¸ [Supabase] This indicates RLS SELECT policy is blocking reads")):console.log("âœ… [Supabase] Verified conversation is readable:",_),g.id}catch(i){return console.error("Error creating conversation:",i),null}}async updateConversation(t,e){try{const{error:r}=await o.from("conversations").update({title:e.title,messages:e.messages?b(e.messages):void 0,game_id:e.gameId,game_title:e.gameTitle,genre:e.genre,subtabs:e.subtabs?b(e.subtabs):void 0,subtabs_order:e.subtabsOrder,is_active_session:e.isActiveSession,active_objective:e.activeObjective,game_progress:e.gameProgress,is_active:e.isActive,is_pinned:e.isPinned,pinned_at:e.pinnedAt?new Date(e.pinnedAt).toISOString():null,is_game_hub:e.isGameHub,is_unreleased:e.isUnreleased,context_summary:e.contextSummary,last_summarized_at:e.lastSummarizedAt?e.lastSummarizedAt:null,updated_at:new Date().toISOString()}).eq("id",t);return r?(console.error("Error updating conversation:",r),!1):!0}catch(r){return console.error("Error updating conversation:",r),!1}}async deleteConversation(t){try{const{error:e}=await o.from("conversations").delete().eq("id",t);return e?(console.error("Error deleting conversation:",e),!1):!0}catch(e){return console.error("Error deleting conversation:",e),!1}}async getGames(t){try{const{data:e,error:r}=await o.from("games").select("*").eq("auth_user_id",t).order("created_at",{ascending:!1});return r?(console.error("Error getting games:",r),[]):e.map(a=>({id:a.id,title:a.title,description:a.notes??void 0,genre:a.genre??void 0,platform:a.platform??void 0,releaseDate:"",rating:a.rating??void 0,imageUrl:a.cover_url??void 0,metadata:u(a.metadata),createdAt:D(a.created_at),updatedAt:D(a.updated_at)}))}catch(e){return console.error("Error getting games:",e),[]}}async createGame(t,e){try{const{data:r,error:a}=await o.rpc("get_user_id_from_auth_id",{p_auth_user_id:t});if(a||!r)return console.error("Error resolving user ID:",a),null;const{data:i,error:l}=await o.from("games").insert({user_id:r,auth_user_id:t,title:e.title,notes:e.description,genre:e.genre,platform:e.platform,rating:e.rating,cover_url:e.imageUrl,metadata:e.metadata}).select("id").single();return l?(console.error("Error creating game:",l),null):i.id}catch(r){return console.error("Error creating game:",r),null}}async getTrialStatus(t){try{const{data:e,error:r}=await o.from("users").select("has_used_trial, trial_started_at, trial_expires_at").eq("auth_user_id",t).single();if(r)return console.error("Error getting trial status:",r),null;const a=Date.now(),i=e.trial_expires_at?new Date(e.trial_expires_at).getTime():null,l=i?a<i:!1,g=i?Math.ceil((i-a)/(1e3*60*60*24)):0;return{isEligible:!e.has_used_trial,hasUsed:T(e.has_used_trial),isActive:l,expiresAt:i||void 0,daysRemaining:l?g:void 0}}catch(e){return console.error("Error getting trial status:",e),null}}async startTrial(t){try{const e=new Date;e.setDate(e.getDate()+14);const{error:r}=await o.from("users").update({has_used_trial:!0,trial_started_at:new Date().toISOString(),trial_expires_at:e.toISOString(),tier:x.PRO,text_limit:f[x.PRO].text,image_limit:f[x.PRO].image,updated_at:new Date().toISOString()}).eq("auth_user_id",t);return r?(console.error("Error starting trial:",r),!1):!0}catch(e){return console.error("Error starting trial:",e),!1}}async canMakeRequest(t,e){try{const{data:r,error:a}=await o.from("users").select("text_count, image_count, text_limit, image_limit, tier").eq("auth_user_id",t).single();return a?(console.error("Error checking usage:",a),!1):e==="text"?C(r.text_count)<C(r.text_limit):C(r.image_count)<C(r.image_limit)}catch(r){return console.error("Error checking usage:",r),!1}}async incrementUsage(t,e){try{const{data:r,error:a}=await o.from("users").select("usage_data").eq("auth_user_id",t).single();if(a)return console.error("Error fetching user data:",a),!1;const i=u(r==null?void 0:r.usage_data),l=e==="text"?(i.textCount||0)+1:i.textCount||0,g=e==="image"?(i.imageCount||0)+1:i.imageCount||0,m={textCount:l,imageCount:g,totalRequests:(i.totalRequests||0)+1},{error:_}=await o.from("users").update({usage_data:b(m),updated_at:new Date().toISOString()}).eq("auth_user_id",t);return _?(console.error("Error incrementing usage:",_),!1):!0}catch(r){return console.error("Error incrementing usage:",r),!1}}async resetUsage(t){try{const e={textCount:0,imageCount:0,totalRequests:0,lastReset:Date.now()},{error:r}=await o.from("users").update({usage_data:b(e),updated_at:new Date().toISOString()}).eq("auth_user_id",t);return r?(console.error("Error resetting usage:",r),!1):!0}catch(e){return console.error("Error resetting usage:",e),!1}}async recordQuery(t,e){try{const{data:r,error:a}=await o.rpc("increment_user_usage",{p_auth_user_id:t,p_query_type:e,p_increment:1});return a?(console.error("Error recording query:",a),!1):r===!0}catch(r){return console.error("Error recording query:",r),!1}}async getQueryUsage(t){try{const{data:e,error:r}=await o.from("users").select("text_count, image_count, text_limit, image_limit, last_reset").eq("auth_user_id",t).single();return r?(console.error("Error getting query usage:",r),null):{textCount:e.text_count||0,imageCount:e.image_count||0,textLimit:e.text_limit||55,imageLimit:e.image_limit||25,lastReset:new Date(e.last_reset||Date.now())}}catch(e){return console.error("Error getting query usage:",e),null}}};y(A,"instance");let k=A;const q=k.getInstance(),z=Object.freeze(Object.defineProperty({__proto__:null,SupabaseService:k,supabaseService:q},Symbol.toStringTag,{value:"Module"}));export{k as S,R as a,G as b,D as c,C as d,W as e,z as f,u as j,q as s};
//# sourceMappingURL=core-services-B6nsqxvT.js.map
