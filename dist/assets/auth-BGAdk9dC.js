import{r as m,j as t}from"./react-vendor-ytDMyTZl.js";import{c as R}from"./supabase-vendor-BCAdzdMx.js";import{a as k}from"./core-services-CQStMRoS.js";const U="https://qajcxgkqloumogioomiz.supabase.co",D="sb_publishable_GoW6G_umt1lFF-KPbbm-Ow_D2PYxPLw",f=R(U,D,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0}});typeof window<"u"&&f.auth.onAuthStateChange((o,a)=>{o==="SIGNED_IN"||o==="TOKEN_REFRESHED"?a!=null&&a.access_token&&(localStorage.setItem("otakon_session_refreshed",Date.now().toString()),localStorage.setItem("otakon_last_session_check",Date.now().toString()),window.dispatchEvent(new CustomEvent("otakon:session-refreshed",{detail:{event:o,session:a}}))):o==="SIGNED_OUT"?(localStorage.removeItem("otakon_session_refreshed"),localStorage.removeItem("otakon_last_session_check"),window.dispatchEvent(new CustomEvent("otakon:signed-out"))):o==="USER_UPDATED"&&window.dispatchEvent(new CustomEvent("otakon:user-updated",{detail:{session:a}}))});const G=({onAuthSuccess:o,onAuthError:a})=>{const[w,i]=m.useState("loading"),[x,d]=m.useState(null),C=m.useRef(!1),g=m.useRef(null);return m.useEffect(()=>C.current?void 0:(C.current=!0,(async()=>{var v,P;try{if(!(window.location.search.includes("code")||window.location.hash.includes("access_token"))&&(await f.auth.getSession()).data.session){const r=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,r),i("success"),o();return}const c=new URLSearchParams(window.location.search),b=new URLSearchParams(window.location.hash.substring(1)),s=c.get("error")||b.get("error"),n=c.get("error_description")||b.get("error_description"),A=c.get("error_code")||b.get("error_code");if(console.log("ðŸ” [AuthCallback] OAuth parameters:",{oauthError:s,errorDescription:n,errorCode:A,urlParams:Object.fromEntries(c.entries()),hashParams:Object.fromEntries(b.entries())}),s){console.error("ðŸ” [AuthCallback] OAuth error detected:",{oauthError:s,errorDescription:n,errorCode:A});let e="Authentication failed";s==="access_denied"&&A==="otp_expired"?e="Email confirmation link has expired. Please request a new confirmation email.":s==="access_denied"&&(n!=null&&n.includes("Email link is invalid"))?e="Email confirmation link is invalid. Please request a new confirmation email.":s==="access_denied"&&(n!=null&&n.includes("expired"))?e="Email confirmation link has expired. Please request a new confirmation email.":s==="server_error"?e="Authentication server error. This may be due to Supabase configuration. Please try again.":s==="access_denied"?e="Authentication was cancelled. Please try again.":s==="invalid_request"?e="Invalid authentication request. Please check configuration.":s==="unauthorized_client"?e="Authentication client is not authorized. Please check Supabase configuration.":s==="unsupported_response_type"?e="Authentication response type not supported. Please check Supabase configuration.":s==="invalid_scope"?e="Authentication scope is invalid. Please check Supabase configuration.":n&&(e=decodeURIComponent(n)),d(e),i("error"),a(e);return}const{data:{subscription:l}}=f.auth.onAuthStateChange(async(e,r)=>{var h,u,j,N,y;if(e==="SIGNED_IN"&&(r!=null&&r.user)){const I=((h=r.user.app_metadata)==null?void 0:h.provider)||((j=(u=r.user.app_metadata)==null?void 0:u.providers)==null?void 0:j[0])||((y=(N=r.user.identities)==null?void 0:N[0])==null?void 0:y.provider)||"unknown";await new Promise(S=>setTimeout(S,1500));try{await k.loadUserFromSupabase(r.user.id),i("success"),o()}catch(S){console.error("ðŸ” [AuthCallback] Error loading user data:",S),d("Failed to load user data. Please try again."),i("error"),a("Failed to load user data")}l.unsubscribe()}else e==="SIGNED_OUT"&&(d("Authentication failed"),i("error"),a("Authentication failed"),l.unsubscribe())});g.current=l;const{data:F,error:p}=await f.auth.getSession();if(p){console.error("ðŸ” [AuthCallback] Auth callback error:",p),d(p.message),i("error"),a(p.message),l.unsubscribe();return}if((v=F.session)!=null&&v.user)await new Promise(e=>setTimeout(e,1e3)),await k.loadUserFromSupabase(F.session.user.id),i("success"),o(),l.unsubscribe();else{const e=new URLSearchParams(window.location.search),r=new URLSearchParams(window.location.hash.substring(1));if(e.has("code")||e.has("error")||r.has("access_token")){await new Promise(u=>setTimeout(u,1e3));const h=await f.auth.getSession();if((P=h.data.session)!=null&&P.user){await new Promise(u=>setTimeout(u,500)),await k.loadUserFromSupabase(h.data.session.user.id),i("success"),o(),l.unsubscribe();return}}setTimeout(()=>{w==="loading"&&(d("Authentication timeout"),i("error"),a("Authentication timeout"),l.unsubscribe())},1e4)}}catch(E){console.error("ðŸ” [AuthCallback] Auth callback error:",E);const c="An unexpected error occurred";d(c),i("error"),a(c)}})(),()=>{g.current&&g.current.unsubscribe()}),[]),w==="loading"?t.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-[#FF4D4D] mx-auto mb-4"}),t.jsx("p",{className:"text-[#CFCFCF] text-lg",children:"Completing authentication..."})]})}):w==="error"?t.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-red-500 text-6xl mb-4",children:"âš ï¸"}),t.jsx("h2",{className:"text-2xl font-bold text-[#F5F5F5] mb-2",children:"Authentication Error"}),t.jsx("p",{className:"text-[#CFCFCF] mb-6",children:x}),t.jsxs("div",{className:"space-y-3",children:[t.jsx("button",{onClick:()=>{const _=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,_),a("User cancelled authentication")},className:"bg-gradient-to-r from-[#E53A3A] to-[#D98C1F] md:hover:from-[#D42A2A] md:hover:to-[#C87A1A] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 md:hover:scale-105 active:scale-95",children:"Return to Login"}),x&&x.includes("Email confirmation link")&&t.jsx("button",{onClick:()=>{window.history.replaceState({},document.title,"/"),a("Email confirmation expired - show resend option")},className:"bg-gradient-to-r from-[#4F46E5] to-[#7C3AED] md:hover:from-[#4338CA] md:hover:to-[#6D28D9] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 md:hover:scale-105 active:scale-95",children:"Request New Confirmation Email"})]})]})}):t.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-green-500 text-6xl mb-4",children:"âœ…"}),t.jsx("h2",{className:"text-2xl font-bold text-[#F5F5F5] mb-2",children:"Authentication Successful"}),t.jsx("p",{className:"text-[#CFCFCF]",children:"Redirecting to the app..."})]})})};export{G as A,f as s};
