import{r as g,j as a}from"./react-vendor-GN48U5Y-.js";import{c as R}from"./supabase-vendor-Q7d2eXAy.js";import{a as v}from"./core-services-CJiE5Dr-.js";const O="https://qajcxgkqloumogioomiz.supabase.co",D="sb_publishable_GoW6G_umt1lFF-KPbbm-Ow_D2PYxPLw",b=R(O,D,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0}});typeof window<"u"&&b.auth.onAuthStateChange((r,o)=>{console.log("ðŸ” [Supabase] Global auth event:",r),r==="SIGNED_IN"||r==="TOKEN_REFRESHED"?o!=null&&o.access_token&&(localStorage.setItem("otakon_session_refreshed",Date.now().toString()),localStorage.setItem("otakon_last_session_check",Date.now().toString()),window.dispatchEvent(new CustomEvent("otakon:session-refreshed",{detail:{event:r,session:o}})),console.log("âœ… [Supabase] Session refreshed/established")):r==="SIGNED_OUT"?(localStorage.removeItem("otakon_session_refreshed"),localStorage.removeItem("otakon_last_session_check"),window.dispatchEvent(new CustomEvent("otakon:signed-out")),console.log("ðŸ” [Supabase] User signed out")):r==="USER_UPDATED"&&(console.log("ðŸ” [Supabase] User data updated"),window.dispatchEvent(new CustomEvent("otakon:user-updated",{detail:{session:o}})))});const q=({onAuthSuccess:r,onAuthError:o})=>{const[k,n]=g.useState("loading"),[C,d]=g.useState(null),P=g.useRef(!1),x=g.useRef(null);return g.useEffect(()=>{if(P.current){console.log("ðŸ” [AuthCallback] Already processed, skipping...");return}return P.current=!0,(async()=>{var y,E;try{console.log("ðŸ” [AuthCallback] Handling OAuth callback..."),console.log("ðŸ” [AuthCallback] Current URL:",window.location.href),console.log("ðŸ” [AuthCallback] URL search params:",window.location.search),console.log("ðŸ” [AuthCallback] URL hash:",window.location.hash);const p=window.location.search.includes("code")||window.location.hash.includes("access_token");if(console.log("ðŸ” [AuthCallback] Has OAuth code/token:",p),!p){console.log("ðŸ” [AuthCallback] No OAuth parameters found, checking existing session...");const e=await b.auth.getSession();if(e.data.session){console.log("ðŸ” [AuthCallback] Already logged in, no OAuth to process:",e.data.session.user.email);const t=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,t),n("success"),r();return}}console.log("ðŸ” [AuthCallback] Processing OAuth callback...");const l=new URLSearchParams(window.location.search),w=new URLSearchParams(window.location.hash.substring(1)),s=l.get("error")||w.get("error"),i=l.get("error_description")||w.get("error_description"),S=l.get("error_code")||w.get("error_code");if(console.log("ðŸ” [AuthCallback] OAuth parameters:",{oauthError:s,errorDescription:i,errorCode:S,urlParams:Object.fromEntries(l.entries()),hashParams:Object.fromEntries(w.entries())}),s){console.error("ðŸ” [AuthCallback] OAuth error detected:",{oauthError:s,errorDescription:i,errorCode:S});let e="Authentication failed";s==="access_denied"&&S==="otp_expired"?e="Email confirmation link has expired. Please request a new confirmation email.":s==="access_denied"&&(i!=null&&i.includes("Email link is invalid"))?e="Email confirmation link is invalid. Please request a new confirmation email.":s==="access_denied"&&(i!=null&&i.includes("expired"))?e="Email confirmation link has expired. Please request a new confirmation email.":s==="server_error"?e="Authentication server error. This may be due to Supabase configuration. Please try again.":s==="access_denied"?e="Authentication was cancelled. Please try again.":s==="invalid_request"?e="Invalid authentication request. Please check configuration.":s==="unauthorized_client"?e="Authentication client is not authorized. Please check Supabase configuration.":s==="unsupported_response_type"?e="Authentication response type not supported. Please check Supabase configuration.":s==="invalid_scope"?e="Authentication scope is invalid. Please check Supabase configuration.":i&&(e=decodeURIComponent(i)),d(e),n("error"),o(e);return}const{data:{subscription:c}}=b.auth.onAuthStateChange(async(e,t)=>{var u,h,U,F,N;if(console.log("ðŸ” [AuthCallback] Auth state change:",{event:e,session:t}),e==="SIGNED_IN"&&(t!=null&&t.user)){console.log("ðŸ” [AuthCallback] User signed in:",t.user.email),console.log("ðŸ” [AuthCallback] User metadata:",t.user.user_metadata),console.log("ðŸ” [AuthCallback] App metadata:",t.user.app_metadata),console.log("ðŸ” [AuthCallback] User identities:",t.user.identities);const j=((u=t.user.app_metadata)==null?void 0:u.provider)||((U=(h=t.user.app_metadata)==null?void 0:h.providers)==null?void 0:U[0])||((N=(F=t.user.identities)==null?void 0:F[0])==null?void 0:N.provider)||"unknown";console.log("ðŸ” [AuthCallback] Detected provider:",j),console.log("ðŸ” [AuthCallback] Waiting for database trigger to create user record..."),await new Promise(_=>setTimeout(_,1500));try{await v.loadUserFromSupabase(t.user.id),console.log("ðŸ” [AuthCallback] User data loaded successfully"),n("success"),r()}catch(_){console.error("ðŸ” [AuthCallback] Error loading user data:",_),d("Failed to load user data. Please try again."),n("error"),o("Failed to load user data")}c.unsubscribe()}else e==="SIGNED_OUT"&&(console.log("ðŸ” [AuthCallback] User signed out"),d("Authentication failed"),n("error"),o("Authentication failed"),c.unsubscribe())});x.current=c;const{data:A,error:m}=await b.auth.getSession();if(console.log("ðŸ” [AuthCallback] Current session:",{data:A,error:m}),m){console.error("ðŸ” [AuthCallback] Auth callback error:",m),d(m.message),n("error"),o(m.message),c.unsubscribe();return}if((y=A.session)!=null&&y.user)console.log("ðŸ” [AuthCallback] User already authenticated:",A.session.user.email),console.log("ðŸ” [AuthCallback] Waiting for database trigger to create user record..."),await new Promise(e=>setTimeout(e,1e3)),await v.loadUserFromSupabase(A.session.user.id),n("success"),r(),c.unsubscribe();else{console.log("ðŸ” [AuthCallback] No session found, waiting for auth state change..."),console.log("ðŸ” [AuthCallback] URL search params:",window.location.search);const e=new URLSearchParams(window.location.search),t=new URLSearchParams(window.location.hash.substring(1));if(e.has("code")||e.has("error")||t.has("access_token")){console.log("ðŸ” [AuthCallback] OAuth parameters found, trying manual handling..."),await new Promise(h=>setTimeout(h,1e3));const u=await b.auth.getSession();if(console.log("ðŸ” [AuthCallback] Retry session after manual handling:",u),(E=u.data.session)!=null&&E.user){console.log("ðŸ” [AuthCallback] User authenticated after retry:",u.data.session.user.email),console.log("ðŸ” [AuthCallback] Waiting for database trigger to create user record..."),await new Promise(h=>setTimeout(h,500)),await v.loadUserFromSupabase(u.data.session.user.id),n("success"),r(),c.unsubscribe();return}}setTimeout(()=>{k==="loading"&&(console.log("ðŸ” [AuthCallback] Timeout waiting for auth state change"),d("Authentication timeout"),n("error"),o("Authentication timeout"),c.unsubscribe())},1e4)}}catch(p){console.error("ðŸ” [AuthCallback] Auth callback error:",p);const l="An unexpected error occurred";d(l),n("error"),o(l)}})(),()=>{x.current&&x.current.unsubscribe()}},[]),k==="loading"?a.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-[#FF4D4D] mx-auto mb-4"}),a.jsx("p",{className:"text-[#CFCFCF] text-lg",children:"Completing authentication..."})]})}):k==="error"?a.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-red-500 text-6xl mb-4",children:"âš ï¸"}),a.jsx("h2",{className:"text-2xl font-bold text-[#F5F5F5] mb-2",children:"Authentication Error"}),a.jsx("p",{className:"text-[#CFCFCF] mb-6",children:C}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("button",{onClick:()=>{const f=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,f),o("User cancelled authentication")},className:"bg-gradient-to-r from-[#E53A3A] to-[#D98C1F] hover:from-[#D42A2A] hover:to-[#C87A1A] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95",children:"Return to Login"}),C&&C.includes("Email confirmation link")&&a.jsx("button",{onClick:()=>{const f=window.location.hostname==="localhost"?"/":"/Otagon/";window.history.replaceState({},document.title,f),o("Email confirmation expired - show resend option")},className:"bg-gradient-to-r from-[#4F46E5] to-[#7C3AED] hover:from-[#4338CA] hover:to-[#6D28D9] text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 hover:scale-105 active:scale-95",children:"Request New Confirmation Email"})]})]})}):a.jsx("div",{className:"h-screen bg-gradient-to-br from-[#111111] to-[#0A0A0A] flex items-center justify-center",children:a.jsxs("div",{className:"text-center",children:[a.jsx("div",{className:"text-green-500 text-6xl mb-4",children:"âœ…"}),a.jsx("h2",{className:"text-2xl font-bold text-[#F5F5F5] mb-2",children:"Authentication Successful"}),a.jsx("p",{className:"text-[#CFCFCF]",children:"Redirecting to the app..."})]})})};export{q as A,b as s};
//# sourceMappingURL=auth-BapcAVYZ.js.map
