const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/services-DFNjQf9R.js","assets/auth-Da-vLZGV.js","assets/react-vendor-BZRXxuJQ.js","assets/vendor-DG60-2r7.js","assets/carousel-vendor-DbqMuwPS.js","assets/supabase-vendor-CRAcqdEg.js","assets/supabase-realtime-8-W1bgUD.js","assets/core-services-sHekN4Fr.js","assets/chat-services-CgiJwh09.js","assets/ai-vendor-DDPwdD9r.js","assets/storage-services-0pSarXA5.js"])))=>i.map(i=>d[i]);
import{s as v}from"./auth-Da-vLZGV.js";import{_ as ue,C as T,i as J,d as me,e as pe}from"./chat-services-CgiJwh09.js";import{m as U,n as K,o as Q,q as he,u as Z,r as k,i as V,t as O}from"./services-DFNjQf9R.js";import{a as R}from"./core-services-sHekN4Fr.js";const z=new Map,$=new Map,fe=1800*1e3,ne="otagon_igdb_cache",Y=1440*60*1e3,ie="otagon_cover_urls";function ye(){try{const a=localStorage.getItem(ne);if(a){const e=JSON.parse(a);if(e.version===1&&Date.now()-e.timestamp<Y){for(const[t,r]of Object.entries(e.games))Date.now()-r.timestamp<Y&&$.set(t,r);console.log("[IGDBService] Loaded",$.size,"games from localStorage cache")}}}catch(a){console.warn("[IGDBService] Error loading localStorage cache:",a)}}function be(){try{const a={};$.forEach((t,r)=>{a[r]=t});const e={version:1,timestamp:Date.now(),games:a};localStorage.setItem(ne,JSON.stringify(e))}catch(a){console.warn("[IGDBService] Error saving localStorage cache:",a)}}function Se(){try{const a=localStorage.getItem(ie);if(a){const e=JSON.parse(a);if(e.version===1&&Date.now()-e.timestamp<Y)return console.log("[IGDBService] Loaded",Object.keys(e.urls).length,"cover URLs from localStorage"),new Map(Object.entries(e.urls))}}catch(a){console.warn("[IGDBService] Error loading cover URL cache:",a)}return new Map}function se(a){try{const e={version:1,timestamp:Date.now(),urls:Object.fromEntries(a)};localStorage.setItem(ie,JSON.stringify(e))}catch(e){console.warn("[IGDBService] Error saving cover URL cache:",e)}}ye();const B=Se();function q(a,e="cover_small"){if(!a)return;let t=a;return t=t.replace(/t_(thumb|cover_small|cover_big|720p|1080p|screenshot_huge)/g,`t_${e}`),t.startsWith("//")?t="https:"+t:t.startsWith("http")||(t="https://"+t),t}function Me(a){var e;if((e=a==null?void 0:a.cover)!=null&&e.url)return q(a.cover.url,"cover_small")}async function _e(a){if(!a||a.trim().length===0)return console.warn("[IGDBService] Empty game name provided"),null;const e=a.toLowerCase().trim(),t=$.get(e);if(t&&Date.now()-t.timestamp<fe)return console.log("[IGDBService] Session cache hit:",a),t.data;if(z.has(e)){console.log("[IGDBService] Waiting for pending request:",a);const o=z.get(e);if(o)return o}const r=(async()=>{var o,n,i;try{console.log("[IGDBService] Fetching game data:",a);const{data:{session:l}}=await v.auth.getSession(),g={"Content-Type":"application/json"};l!=null&&l.access_token&&(g.Authorization=`Bearer ${l.access_token}`),console.log("[IGDBService] Invoking igdb-proxy with gameName:",a);const d=await v.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:a}),headers:g});if(d.error){console.error("[IGDBService] Edge function error:",d.error);const u=d.error;return((o=u==null?void 0:u.message)!=null&&o.includes("IGDB_NOT_CONFIGURED")||(n=u==null?void 0:u.message)!=null&&n.includes("503"))&&console.warn("[IGDBService] IGDB service not configured - game data will not be available"),null}const c=d.data;if((c==null?void 0:c.code)==="IGDB_NOT_CONFIGURED")return console.warn("[IGDBService] IGDB service not configured on server"),null;if(!c.success||!c.data)return console.log("[IGDBService] No data found for:",a),null;const s=c.data;if($.set(e,{data:s,timestamp:Date.now()}),be(),(i=s.cover)!=null&&i.url){const u=q(s.cover.url,"cover_small");u&&(B.set(e,u),se(B),console.log("[IGDBService] Saved cover URL to cache:",e))}return console.log("[IGDBService] Successfully fetched:",s.name,c.cached?"(cached)":"(fresh)"),s}catch(l){return console.error("[IGDBService] Error fetching game data:",l),null}finally{z.delete(e)}})();return z.set(e,r),r}async function Ue(a){return _e(`id:${a}`)}async function Oe(a,e=10){try{console.log("[IGDBService] Querying games by criteria:",a,"limit:",e);const{data:{session:t}}=await v.auth.getSession(),r={"Content-Type":"application/json"};t!=null&&t.access_token&&(r.Authorization=`Bearer ${t.access_token}`);const o=await v.functions.invoke("igdb-proxy",{body:JSON.stringify({queryType:a,limit:e}),headers:r});if(o.error)return console.error("[IGDBService] Query by criteria error:",o.error),[];const n=o.data;if(!n.success||!n.data)return[];const i=n.data;console.log("[IGDBService] Query found",i.length,"games for",a);for(const l of i){const g=l.name.toLowerCase().trim();$.set(g,{data:l,timestamp:Date.now()})}return i}catch(t){return console.error("[IGDBService] Query by criteria error:",t),[]}}async function Be(a){if(!a||a.trim().length<2)return[];try{console.log("[IGDBService] Searching games:",a);const{data:{session:e}}=await v.auth.getSession(),t={"Content-Type":"application/json"};e!=null&&e.access_token&&(t.Authorization=`Bearer ${e.access_token}`);const r=await v.functions.invoke("igdb-proxy",{body:JSON.stringify({gameName:a,searchMode:"multi"}),headers:t});if(r.error)return console.error("[IGDBService] Search error:",r.error),[];const o=r.data;if(!o.success||!o.data)return[];const n=o.data;console.log("[IGDBService] Search found",n.length,"games");for(const i of n){const l=i.name.toLowerCase().trim();$.set(l,{data:i,timestamp:Date.now()})}return n}catch(e){return console.error("[IGDBService] Search error:",e),[]}}function Ne(a,e="high"){return`https://img.youtube.com/vi/${a}/${{default:"default",medium:"mqdefault",high:"hqdefault",maxres:"maxresdefault"}[e]}.jpg`}function Fe(a){return{1:"Official",2:"Wikia",3:"Wikipedia",4:"Facebook",5:"Twitter",6:"Twitch",8:"Instagram",9:"YouTube",10:"iPhone",11:"iPad",12:"Android",13:"Steam",14:"Reddit",15:"Itch.io",16:"Epic Games",17:"GOG",18:"Discord"}[a]||"Website"}function Ke(a,e){return a===1?{6:"RP (Rating Pending)",7:"EC (Early Childhood)",8:"E (Everyone)",9:"E10+ (Everyone 10+)",10:"T (Teen)",11:"M (Mature 17+)",12:"AO (Adults Only)"}[e]||"Not Rated":a===2&&{1:"PEGI 3",2:"PEGI 7",3:"PEGI 12",4:"PEGI 16",5:"PEGI 18"}[e]||"Not Rated"}function ze(a){return a?new Date(a*1e3).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"TBA"}function He(a){return a?a.filter(e=>e.developer).map(e=>e.company.name):[]}function je(a){return a.total_rating??a.aggregated_rating??a.rating??null}async function We(a){var o;const e=new Map;if(a.length===0)return e;const t=a.map(n=>n.toLowerCase().trim()),r=[];for(const n of t){const i=B.get(n);i?e.set(n,i):r.push(n)}if(r.length===0)return console.log("[IGDBService] All cover URLs from localStorage cache:",e.size),e;try{const{data:n,error:i}=await v.from("igdb_game_cache").select("game_name_key, game_data").in("game_name_key",r).gt("expires_at",new Date().toISOString());if(i)return console.warn("[IGDBService] Error fetching cover URLs from cache:",i.message),e;if(n){for(const l of n){const g=l.game_data;if((o=g==null?void 0:g.cover)!=null&&o.url){const d=q(g.cover.url,"cover_small");d&&(e.set(l.game_name_key,d),B.set(l.game_name_key,d))}}se(B)}console.log("[IGDBService] Fetched cover URLs:",e.size,"of",a.length,"(",e.size-r.length+((n==null?void 0:n.length)??0),"from localStorage,",(n==null?void 0:n.length)||0,"from Supabase)")}catch(n){console.warn("[IGDBService] Error in fetchCoverUrlsFromCache:",n)}return e}const x=new Map,X=1800*1e3,H=new Map;class ve{async get(e){const t=H.get(e);if(t)return console.log(`üéÆ [GameKnowledgeCache] Waiting for in-flight request: ${e}`),t;const r=this._fetchFromCache(e);H.set(e,r);try{return await r}finally{H.delete(e)}}async _fetchFromCache(e){const t=x.get(e);if(t&&Date.now()-t.timestamp<X)return console.log(`üéÆ [GameKnowledgeCache] Memory hit for igdbId: ${e}`),{knowledge:t.knowledge,cached:!0,version:t.version,source:"memory"};try{const{data:r,error:o}=await v.from("game_knowledge_cache").select("comprehensive_knowledge, version").eq("igdb_id",e).single();if(o)return o.code!=="PGRST116"&&console.warn("üéÆ [GameKnowledgeCache] Supabase error:",o),{knowledge:"",cached:!1,version:0,source:"none"};if(r)return console.log(`üéÆ [GameKnowledgeCache] Supabase hit for igdbId: ${e}`),x.set(e,{knowledge:r.comprehensive_knowledge,version:r.version,timestamp:Date.now()}),this._updateAccessStats(e).catch(()=>{}),{knowledge:r.comprehensive_knowledge,cached:!0,version:r.version,source:"supabase"}}catch(r){console.warn("üéÆ [GameKnowledgeCache] Failed to fetch from Supabase:",r)}return{knowledge:"",cached:!1,version:0,source:"none"}}async store(e,t,r,o={}){var n;try{const i={igdb_id:e,game_name:t,game_slug:o.gameSlug||null,comprehensive_knowledge:r,knowledge_summary:o.knowledgeSummary||null,tokens_used:o.tokensUsed||0,fetched_with_grounding:o.fetchedWithGrounding??!0,is_post_cutoff:o.isPostCutoff??!1,is_unreleased:o.isUnreleased??!1,release_date:((n=o.releaseDate)==null?void 0:n.toISOString().split("T")[0])||null,version:1,updated_at:new Date().toISOString(),access_count:0},{error:l}=await v.from("game_knowledge_cache").upsert(i,{onConflict:"igdb_id",ignoreDuplicates:!1});return l?(console.error("üéÆ [GameKnowledgeCache] Failed to store:",l),!1):(x.set(e,{knowledge:r,version:1,timestamp:Date.now()}),console.log(`üéÆ [GameKnowledgeCache] ‚úÖ Stored knowledge for: ${t}`),!0)}catch(i){return console.error("üéÆ [GameKnowledgeCache] Store error:",i),!1}}async exists(e){const t=x.get(e);if(t&&Date.now()-t.timestamp<X)return!0;try{const{count:r,error:o}=await v.from("game_knowledge_cache").select("*",{count:"exact",head:!0}).eq("igdb_id",e);return o?(console.warn("üéÆ [GameKnowledgeCache] Exists check error:",o),!1):(r??0)>0}catch{return!1}}shouldPrioritizeFetch(e){return e?e>new Date("2025-01-01"):!1}async getForContext(e){const t=await this.get(e);return!t.cached||!t.knowledge?null:t.knowledge}async _updateAccessStats(e){try{await v.from("game_knowledge_cache").update({last_accessed_at:new Date().toISOString()}).eq("igdb_id",e)}catch{}}clearMemoryCache(){x.clear(),console.log("üéÆ [GameKnowledgeCache] Memory cache cleared")}getStats(){return{memoryCacheSize:x.size,pendingRequests:H.size}}}const N=new ve,y={LIBRARY:"otagon_gaming_library",TIMELINE:"otagon_gaming_timeline",TIMELINE_ALBUMS:"otagon_timeline_albums",TIMELINE_PHOTOS:"otagon_timeline_photos",NEWS_CACHE:"otagon_gaming_news_cache",NEWS_GENERATION_LOG:"otagon_news_generation_log",GAME_KNOWLEDGE:"otagon_game_knowledge",USER_PROFILE:"otagon_user_gaming_profile",GAMEPLAY_SESSIONS:"otagon_gameplay_sessions",IGDB_HOME_CACHE:"otagon_igdb_home_cache",SEARCH_HISTORY:"otagon_game_search_history"};function W(){var a;return((a=crypto.randomUUID)==null?void 0:a.call(crypto))||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function C(a,e){try{const t=localStorage.getItem(a);return t?JSON.parse(t):e}catch(t){return console.warn(`[GamingExplorerStorage] Error reading ${a}:`,t),e}}function G(a,e){try{return localStorage.setItem(a,JSON.stringify(e)),!0}catch(t){return console.error(`[GamingExplorerStorage] Error writing ${a}:`,t),!1}}const le={async loadFromSupabase(a){try{console.log("[LibraryStorage] Loading from Supabase...");const e=await U.getAll(a),t=this.getAll();e.length===0&&t.length>0?(console.log("[LibraryStorage] First sync: Uploading localStorage to Supabase"),await U.syncFromLocalStorage(a,t)):e.length>0&&(console.log(`[LibraryStorage] Loaded ${e.length} items from Supabase`),G(y.LIBRARY,e),this.updateStats())}catch(e){console.error("[LibraryStorage] Failed to load from Supabase:",e)}},getAll(){return C(y.LIBRARY,[])},getByCategory(a){return this.getAll().filter(t=>t.category===a)},getByIgdbId(a){return this.getAll().find(t=>t.igdbGameId===a)},getByGameTitle(a){const e=this.getAll(),t=a.toLowerCase().trim();return e.find(r=>r.gameName.toLowerCase().trim()===t)},getGameCategories(a){return this.getAll().filter(t=>t.igdbGameId===a).map(t=>t.category)},addGame(a,e,t,r,o){const n=this.getAll(),i=n.find(d=>d.igdbGameId===a&&d.category===t);if(i)return i.updatedAt=Date.now(),o!=null&&o.platform&&(i.platform=o.platform),o!=null&&o.personalRating&&(i.personalRating=o.personalRating),o!=null&&o.completionStatus&&(i.completionStatus=o.completionStatus),r&&(i.igdbData=r),G(y.LIBRARY,n),this.updateStats(),i;const l={id:W(),igdbGameId:a,gameName:e,category:t,platform:o==null?void 0:o.platform,personalRating:o==null?void 0:o.personalRating,completionStatus:(o==null?void 0:o.completionStatus)||(t==="own"?"not_started":void 0),igdbData:r,dateAdded:Date.now(),updatedAt:Date.now()};n.push(l),G(y.LIBRARY,n),this.updateStats(),t==="own"&&(console.log(`üéÆ [LibraryStorage] Game added as OWNED: "${e}" (IGDB ID: ${a})`),console.log("üéÆ [LibraryStorage] Knowledge fetch will happen when user creates a game tab"));const g=R.getCurrentUser();return g!=null&&g.authUserId&&U.add(g.authUserId,l).catch(d=>{console.error("[LibraryStorage] Failed to sync to Supabase:",d)}),l},updateGame(a,e){const t=this.getAll(),r=t.findIndex(n=>n.id===a);if(r===-1)return null;t[r]={...t[r],...e,updatedAt:Date.now()},G(y.LIBRARY,t),this.updateStats();const o=R.getCurrentUser();return o!=null&&o.authUserId&&U.update(o.authUserId,t[r]).catch(n=>{console.error("[LibraryStorage] Failed to update in Supabase:",n)}),t[r]},removeGame(a,e){const t=this.getAll(),r=t.filter(n=>!(n.igdbGameId===a&&n.category===e));if(r.length===t.length)return!1;G(y.LIBRARY,r),this.updateStats();const o=R.getCurrentUser();return o!=null&&o.authUserId&&U.remove(o.authUserId,a,e).catch(n=>{console.error("[LibraryStorage] Failed to remove from Supabase:",n)}),!0},moveGame(a,e,t){const r=this.getAll(),o=r.find(n=>n.igdbGameId===a&&n.category===e);return o?(o.category=t,o.updatedAt=Date.now(),G(y.LIBRARY,r),this.updateStats(),!0):!1},toggleCategory(a,e,t,r){return this.getAll().find(i=>i.igdbGameId===a&&i.category===t)?(this.removeGame(a,t),{added:!1}):{added:!0,item:this.addGame(a,e,t,r)}},updateStats(){const a=this.getAll(),e=te.get();e.libraryStats={ownedCount:a.filter(t=>t.category==="own").length,completedCount:a.filter(t=>t.category==="own"&&t.completionStatus==="completed").length,wishlistCount:a.filter(t=>t.category==="wishlist").length,favoritesCount:a.filter(t=>t.category==="favorite").length,dislikedCount:a.filter(t=>t.category==="disliked").length,totalHoursPlayed:a.reduce((t,r)=>t+(r.hoursPlayed||0),0)},e.lastUpdated=Date.now(),te.save(e)}},we={async loadFromSupabase(a){try{console.log("[TimelineStorage] Loading from Supabase...");const e=await K.getAll(a),t=this.getAll();e.length===0&&t.length>0?(console.log("[TimelineStorage] First sync: Uploading localStorage to Supabase"),await K.syncFromLocalStorage(a,t)):e.length>0&&(console.log(`[TimelineStorage] Loaded ${e.length} events from Supabase`),G(y.TIMELINE,e))}catch(e){console.error("[TimelineStorage] Failed to load from Supabase:",e)}},getAll(){return C(y.TIMELINE,[]).sort((e,t)=>new Date(t.eventDate).getTime()-new Date(e.eventDate).getTime())},getByYear(a){return this.getAll().filter(t=>t.year===a)},getYears(){const a=this.getAll();return[...new Set(a.map(t=>t.year))].sort((t,r)=>r-t)},addEvent(a){const e=this.getAll(),t={...a,id:W(),createdAt:Date.now(),updatedAt:Date.now()};e.push(t),G(y.TIMELINE,e);const r=R.getCurrentUser();return r!=null&&r.authUserId&&K.add(r.authUserId,t).catch(o=>{console.error("[TimelineStorage] Failed to sync to Supabase:",o)}),t},updateEvent(a,e){const t=C(y.TIMELINE,[]),r=t.findIndex(o=>o.id===a);return r===-1?null:(t[r]={...t[r],...e,updatedAt:Date.now()},G(y.TIMELINE,t),t[r])},deleteEvent(a){const e=C(y.TIMELINE,[]),t=e.filter(o=>o.id!==a);if(t.length===e.length)return!1;G(y.TIMELINE,t);const r=R.getCurrentUser();return r!=null&&r.authUserId&&K.remove(r.authUserId,a).catch(o=>{console.error("[TimelineStorage] Failed to remove from Supabase:",o)}),!0},addConsole(a,e,t,r){return this.addEvent({type:"console",eventDate:`${e}-01-01`,year:e,title:a,description:t,photos:r?[r]:void 0})},addPCBuild(a,e,t,r){return this.addEvent({type:"pc_build",eventDate:`${e}-01-01`,year:e,title:a,specs:t,photos:r})},addGameMilestone(a,e,t,r,o){return this.addEvent({type:"game",eventDate:`${t}-01-01`,year:t,title:a,description:r,igdbGameId:e,igdbData:o})}},Ye={getAll(){return C(y.GAMEPLAY_SESSIONS,[])},getByGame(a){return this.getAll().filter(t=>t.igdbGameId===a)},getByDateAndGame(a,e){return this.getAll().find(r=>r.sessionDate===a&&r.igdbGameId===e)},addScreenshot(a,e,t){const r=this.getAll(),o=new Date().toISOString().split("T")[0];let n=r.find(g=>g.sessionDate===o&&g.igdbGameId===a);n||(n={id:W(),igdbGameId:a,gameName:e,sessionDate:o,screenshots:[],createdAt:Date.now()},r.push(n));const i={...t,id:W(),sessionId:n.id};n.screenshots.push(i),G(y.GAMEPLAY_SESSIONS,r);const l=R.getCurrentUser();return l!=null&&l.authUserId&&he.add(l.authUserId,i,e).catch(g=>{console.error("[GameplaySessionsStorage] Failed to sync screenshot to Supabase:",g)}),n},getScreenshotCount(a){return this.getByGame(a).reduce((t,r)=>t+r.screenshots.length,0)}},qe={get(a){const t=C(y.NEWS_CACHE,[]).find(r=>r.promptType===a);return t&&t.expiresAt>Date.now()?t:null},async getAsync(a){const e=await Q.getCache(a);if(e){const t=Date.now();return{promptType:a,items:e.map(r=>({...r,cachedAt:t})),cachedAt:t,expiresAt:t+1440*60*1e3}}return this.get(a)},save(a){const e=C(y.NEWS_CACHE,[]),t=e.findIndex(r=>r.promptType===a.promptType);t>=0?e[t]=a:e.push(a),G(y.NEWS_CACHE,e),Q.setCache(a.promptType,a.items).catch(r=>{console.error("[NewsCache] Failed to save to Supabase:",r)})},canGenerate(a,e){const t=C(y.NEWS_GENERATION_LOG,[]),r=Date.now()-1440*60*1e3,o=t.find(n=>n.userId===a&&n.promptType===e&&n.generatedAt>r);return o?{allowed:!1,nextAvailableAt:o.generatedAt+1440*60*1e3}:{allowed:!0}},logGeneration(a,e){const r=C(y.NEWS_GENERATION_LOG,[]).filter(o=>!(o.userId===a&&o.promptType===e));r.push({userId:a,promptType:e,generatedAt:Date.now()}),G(y.NEWS_GENERATION_LOG,r)},getCacheAge(a){const e=this.get(a);return e?Math.floor((Date.now()-e.cachedAt)/(3600*1e3)):null}},ee={get(a){return C(y.GAME_KNOWLEDGE,[]).find(t=>t.igdbGameId===a)||null},exists(a){return this.get(a)!==null},save(a){const e=C(y.GAME_KNOWLEDGE,[]),t=e.findIndex(r=>r.igdbGameId===a.igdbGameId);t>=0?e[t]={...a,lastUpdated:Date.now()}:e.push(a),G(y.GAME_KNOWLEDGE,e)},getAllExtracted(){return C(y.GAME_KNOWLEDGE,[]).map(e=>e.igdbGameId)}},te={get(){return C(y.USER_PROFILE,{libraryStats:{ownedCount:0,completedCount:0,wishlistCount:0,favoritesCount:0,dislikedCount:0,totalHoursPlayed:0},lastUpdated:Date.now()})},save(a){G(y.USER_PROFILE,a)},setGamingStartYear(a){const e=this.get();e.gamingStartYear=a,e.lastUpdated=Date.now(),this.save(e)},getGamingStartYear(){return this.get().gamingStartYear},needsOnboarding(){return this.get().gamingStartYear===void 0}},Te=12,Je={getAll(){return C(y.SEARCH_HISTORY,[])},getGames(){return this.getAll().map(a=>a.gameData)},add(a){const t=this.getAll().filter(o=>o.gameData.id!==a.id),r=[{gameData:a,searchedAt:Date.now()},...t].slice(0,Te);G(y.SEARCH_HISTORY,r)},remove(a){const t=this.getAll().filter(r=>r.gameData.id!==a);G(y.SEARCH_HISTORY,t)},clear(){localStorage.removeItem(y.SEARCH_HISTORY)},hasHistory(){return this.getAll().length>0}},j=new Set;let ae=!1;const L=new Map,Ge=()=>"https://qajcxgkqloumogioomiz.supabase.co/functions/v1/ai-background",Ce=a=>`
You are a comprehensive gaming knowledge expert. Provide EXTREMELY DETAILED, EXHAUSTIVE, encyclopedic information about "${a}".

Your response will be used as a knowledge base for an AI gaming assistant. Be MAXIMALLY THOROUGH and cover EVERYTHING a player might ask about.

IMPORTANT: You have 60,000 tokens available. Use them ALL to provide the most comprehensive game knowledge possible. Include extensive details, examples, specific numbers, exact locations, detailed strategies, and thorough explanations for every section.

## CORE GAME MECHANICS
- Complete gameplay systems breakdown
- All progression mechanics (leveling, skills, upgrades)
- Combat system (if applicable) - every attack type, combo, counter
- Movement and traversal mechanics
- Resource management and economy
- Crafting/building systems (if applicable)

## COMPLETE WALKTHROUGH FRAMEWORK
- Main story progression points
- All major areas/chapters in order
- Key objectives and how to complete them
- Recommended level/gear for each section
- Points of no return warnings

## DETAILED BOSS/CHALLENGE GUIDE
- Every major boss with full strategies
- Attack patterns and telegraphs
- Recommended builds/loadouts for each
- Cheese strategies and easy methods
- No-hit or challenge run tips

## COMPREHENSIVE TIPS AND TRICKS
- Essential beginner knowledge
- Intermediate optimization strategies
- Advanced/expert techniques
- Hidden mechanics most players miss
- Efficiency and speedrun tips

## COLLECTIBLES AND SECRETS
- All collectible types and locations
- Hidden areas and secret content
- Easter eggs and references
- Achievement/trophy guide
- 100% completion requirements

## CHARACTER BUILDS AND LOADOUTS
- All viable build archetypes
- Meta/optimal builds with explanations
- Fun/unique build ideas
- Stat allocation priorities
- Equipment recommendations per build

## STORY AND LORE
- Complete world lore (spoiler-tagged context)
- Character backgrounds and motivations
- Timeline of events
- Faction information
- Ending explanations (MAJOR SPOILERS clearly marked)

## MULTIPLAYER/ONLINE (if applicable)
- PvP strategies and meta
- Co-op tips and etiquette
- Server/region information
- Community resources

## TECHNICAL INFORMATION
- Known bugs and workarounds
- Performance optimization tips
- PC-specific settings recommendations
- Save management

Be comprehensive. This knowledge base will help players with ANY question about the game.
Use clear headers, bullet points, and organize information for easy searching.
`;async function Ae(){if(!ae){ae=!0;try{const e=localStorage.getItem("otagon_game_knowledge");if(!e)return;const t=JSON.parse(e);if(!Array.isArray(t)||t.length===0)return;console.log(`üéÆ [GameKnowledge] Found ${t.length} items in LocalStorage to migrate`);for(const r of t){if(await N.exists(r.igdbGameId)){console.log(`üéÆ [GameKnowledge] ${r.gameName} already in Supabase, skipping`);continue}const n=[];if(r.gameMechanics&&n.push(`## Game Mechanics
${r.gameMechanics}`),r.tipsAndTricks&&n.push(`## Tips and Tricks
${r.tipsAndTricks}`),r.bossStrategies){const l=typeof r.bossStrategies=="object"?JSON.stringify(r.bossStrategies,null,2):String(r.bossStrategies);n.push(`## Boss Strategies
${l}`)}if(r.collectibles){const l=typeof r.collectibles=="object"?JSON.stringify(r.collectibles,null,2):String(r.collectibles);n.push(`## Collectibles
${l}`)}if(r.characterBuilds){const l=typeof r.characterBuilds=="object"?JSON.stringify(r.characterBuilds,null,2):String(r.characterBuilds);n.push(`## Character Builds
${l}`)}if(n.length===0)continue;const i=n.join(`

`);await N.store(r.igdbGameId,r.gameName,i,{fetchedWithGrounding:!1,isPostCutoff:!1}),console.log(`üéÆ [GameKnowledge] Migrated ${r.gameName} to Supabase`)}console.log("üéÆ [GameKnowledge] ‚úÖ Migration complete")}catch(a){console.warn("üéÆ [GameKnowledge] Migration failed (non-critical):",a)}}}async function ce(a,e){var r,o,n;if(Ae().catch(()=>{}),j.has(a)){console.log(`üéÆ [GameKnowledge] Already fetching knowledge for ${e}`);return}if(await N.exists(a)){console.log(`üéÆ [GameKnowledge] Knowledge already exists in global cache for ${e}`);return}if(ee.exists(a)){console.log(`üéÆ [GameKnowledge] Knowledge exists in LocalStorage for ${e}, will migrate`);return}j.add(a),console.log(`üéÆ [GameKnowledge] Starting background fetch for ${e}...`);try{console.log("üéÆ [GameKnowledge] üîë Checking for auth session...");const{data:{session:i}}=await v.auth.getSession();if(!i){console.warn("üéÆ [GameKnowledge] ‚ùå No auth session found - user not logged in!"),console.warn("üéÆ [GameKnowledge] üí° Knowledge fetch requires authenticated user");return}console.log("üéÆ [GameKnowledge] ‚úÖ Auth session found, proceeding with fetch...");const{data:l}=await v.from("games_library").select("igdb_data").eq("igdb_game_id",a).single(),g=(r=l==null?void 0:l.igdb_data)==null?void 0:r.first_release_date,d=g?g*1e3>new Date("2025-01-31T23:59:59Z").getTime():!1;console.log("üéÆ [GameKnowledge] Game release date check:",{gameName:e,releaseDate:g?new Date(g*1e3).toISOString():"Unknown",isPostCutoff:d});const{data:c}=await v.from("profiles").select("tier").eq("auth_user_id",i.user.id).single(),s=(c==null?void 0:c.tier)||"free";if(d&&!(s==="pro"||s==="vanguard_pro")){console.log("üîí [GameKnowledge] Game released after Jan 2025 - requires Pro/Vanguard for grounding"),console.log(`üîí [GameKnowledge] User is ${s} tier - cannot fetch knowledge for post-cutoff games`);return}console.log(d?`üéÆ [GameKnowledge] ‚úÖ User is ${s}, can fetch post-cutoff game WITH grounding`:"üéÆ [GameKnowledge] ‚úÖ Pre-cutoff game, all users can fetch (no grounding needed)"),console.log(`üì° [GEMINI CALL] üéÆ Game Knowledge Fetch | Game: ${e} | Post-Cutoff: ${d} | Grounding: ${d?"YES":"NO"} | Max Tokens: 60000`);const f=await fetch(Ge(),{method:"POST",headers:{Authorization:`Bearer ${i.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({prompt:Ce(e),requestType:"text",model:"gemini-2.5-flash",temperature:.7,maxTokens:6e4,systemPrompt:d?"You are a comprehensive gaming knowledge expert. Provide EXTREMELY detailed, exhaustive, accurate, and practical gaming information. Use ALL available tokens to create the most comprehensive knowledge base possible. Use Google Search grounding to ensure all information is up-to-date and accurate for this recently released game.":"You are a comprehensive gaming knowledge expert. Provide EXTREMELY detailed, exhaustive, accurate, and practical gaming information about this classic/established game. Use ALL available tokens to create the most comprehensive knowledge base possible.",useGrounding:d,groundingConfig:d?{dynamicRetrievalConfig:{mode:"MODE_DYNAMIC",dynamicThreshold:.3}}:void 0})});if(!f.ok){const b=await f.json();throw console.error("üéÆ [GameKnowledge] ‚ùå Edge function error:",b),new Error(b.error||"Failed to fetch game knowledge")}const p=await f.json();if(console.log("üéÆ [GameKnowledge] üì¶ Received response:",{success:p.success,responseLength:((o=p.response)==null?void 0:o.length)||0,tokensUsed:p.tokensUsed||0}),console.log(`‚úÖ [GEMINI CALL] Game Knowledge Fetch SUCCESS | Game: ${e} | Grounding: ${d?"YES":"NO"} | Response Length: ${((n=p.response)==null?void 0:n.length)||0} chars`),p.success&&p.response)if(await N.store(a,e,p.response,{tokensUsed:p.tokensUsed||0,fetchedWithGrounding:d,isPostCutoff:d,knowledgeSummary:p.response.slice(0,500)}))console.log(`üéÆ [GameKnowledge] ‚úÖ Stored ${p.response.length} chars in global cache for ${e}`),ue(async()=>{const{toastService:w}=await import("./services-DFNjQf9R.js").then(S=>S.C);return{toastService:w}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10])).then(({toastService:w})=>{w.success(`Game knowledge created for ${e}`)}),L.delete(a);else{const w=Ie(e,a,p.response);ee.save(w),console.log(`üéÆ [GameKnowledge] ‚ö†Ô∏è Stored in LocalStorage fallback for ${e}`),L.delete(a)}else console.warn(`üéÆ [GameKnowledge] Empty response for ${e}`)}catch(i){console.error(`üéÆ [GameKnowledge] Failed to fetch for ${e}:`,i);const l=L.get(a)||0,g=3;l<g?(L.set(a,l+1),console.log(`üîÑ [GameKnowledge] Retry ${l+1}/${g} for ${e} in 1 second...`),setTimeout(()=>{j.delete(a),ce(a,e).catch(()=>{L.delete(a)})},1e3)):(console.error(`‚ùå [GameKnowledge] Max retries reached for ${e}`),L.delete(a))}finally{(L.get(a)||0)===0&&j.delete(a)}}function Ie(a,e,t){return{igdbGameId:e,gameName:a,gameMechanics:t.slice(0,2e3),tipsAndTricks:void 0,extractedAt:Date.now(),lastUpdated:Date.now()}}function ge(a,e){console.log(`üéÆ [GameKnowledge] üöÄ TRIGGER called for: ${e} (IGDB ID: ${a})`),ce(a,e).catch(t=>{console.error(`üéÆ [GameKnowledge] ‚ùå Background fetch FAILED for ${e}:`,t),console.error("üéÆ [GameKnowledge] ‚ùå Error details:",{message:t.message,stack:t.stack,igdbGameId:a,gameName:e})}),console.log(`üéÆ [GameKnowledge] ‚úÖ Background fetch initiated for ${e}`)}const Qe=Object.freeze(Object.defineProperty({__proto__:null,triggerGameKnowledgeFetch:ge},Symbol.toStringTag,{value:"Module"})),re=3e3;function m(){var a;return((a=globalThis.crypto)==null?void 0:a.randomUUID())||"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}const oe=new Set;class Ee{async createGameTab(e){var g,d;const t=await T.getConversation(e.conversationId);if(t){if(e.aiResponse&&((g=t.subtabs)!=null&&g.some(c=>c.status==="loading"||c.content==="Loading..."))){const c=this.extractInsightsFromAIResponse(e.aiResponse,t.subtabs);return await T.updateConversation(t.id,{subtabs:c,updatedAt:Date.now()}),{...t,subtabs:c}}return t}const r=e.userTier||"free",o=r==="pro"||r==="vanguard_pro";if(e.isUnreleased){const c=await Z.canCreateUnreleasedTab(e.userId,r);if(!c.canCreate)throw new Error(`You've reached your limit of ${c.limit} unreleased game tabs. ${o?"Delete an existing unreleased tab to add a new one.":"Upgrade to Pro for up to 10 unreleased game tabs."}`)}console.log("üéÆ [GameTabService] Creating new game tab:",{gameTitle:e.gameTitle,userTier:r,isPro:o,isUnreleased:e.isUnreleased,hasAiResponse:!!e.aiResponse});let n=[];!e.isUnreleased&&o?(n=this.generateInitialSubTabs(e.genre||"Default",e.playerProfile,{}),console.error("üéÆ [GameTabService] Created",n.length,"template subtabs (will be populated by generateInitialInsights)")):e.isUnreleased?console.error("üéÆ [GameTabService] Creating unreleased game tab (no subtabs, Discuss mode only)"):console.error("üîí [GameTabService] Subtabs disabled for free tier users");const i={id:e.conversationId,title:e.gameTitle,messages:[],createdAt:Date.now(),updatedAt:Date.now(),isActive:!1,gameId:e.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:e.gameTitle,genre:e.genre,subtabs:n,subtabsOrder:n.map(c=>c.id),isActiveSession:!0,activeObjective:"",gameProgress:0,isUnreleased:e.isUnreleased||!1};if(await T.addConversation(i),console.log("üéÆ [GameTabService] Created new tab (cache preserved for performance):",i.id),!e.isUnreleased){const c=le.getByGameTitle(e.gameTitle);c!=null&&c.igdbGameId?(console.log(`üéÆ [GameTabService] Triggering background game knowledge fetch for ${e.gameTitle} (IGDB: ${c.igdbGameId})`),ge(c.igdbGameId,e.gameTitle)):console.log(`üéÆ [GameTabService] No IGDB ID for ${e.gameTitle}, skipping knowledge fetch`)}if(e.isUnreleased&&await Z.trackUnreleasedTab(e.userId,i.id,0,e.gameTitle),n.length>0&&o){console.error("üéÆ [GameTabService] Saving",n.length,"subtabs for conversation:",i.id),console.error("üéÆ [GameTabService] Subtabs:",JSON.stringify(n.map(s=>({id:s.id,title:s.title,type:s.type,hasType:!!s.type})),null,2)),await new Promise(s=>setTimeout(s,200));let c=await k.setSubtabs(i.id,n);c||(console.error("‚ö†Ô∏è [GameTabService] First setSubtabs attempt failed, waiting and retrying..."),await new Promise(s=>setTimeout(s,500)),c=await k.setSubtabs(i.id,n),console.error(c?"‚úÖ [GameTabService] Retry succeeded":"‚ùå [GameTabService] Retry also failed - subtabs will be created by generateInitialInsights"))}else o?console.error("üéÆ [GameTabService] No subtabs to save for conversation:",i.id):console.error("üîí [GameTabService] Skipping subtabs save for free tier user");const l=i.messages.length<=2;return o&&l?(console.log(`üéØ [GameTabService] First message detected - will generate initial insights for: ${i.gameTitle}`),e.aiResponse?(d=i.subtabs)!=null&&d.some(s=>s.content==="Loading...")&&this.generateInitialInsights(i,e.playerProfile,e.aiResponse,r).catch(s=>console.error("Background insight generation failed:",s)):this.generateInitialInsights(i,e.playerProfile,e.aiResponse,r).catch(c=>console.error("Background insight generation failed:",c))):o&&!l?console.log(`üìù [GameTabService] Subsequent message (${i.messages.length} msgs) - skipping insight generation to save Gemini calls`):console.error("üîí [GameTabService] Skipping AI insight generation for free tier user"),i}getGameSpecificTabCustomizations(e){const t=e.toLowerCase();return t.includes("elden ring")?[{id:m(),title:"Story So Far",type:"story",instruction:"Track the Tarnished's journey through the Lands Between, major demigod encounters, and story progression.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Sites of Grace Nearby",type:"tips",instruction:"List nearby Sites of Grace, their locations, and what areas they unlock.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Boss Strategy",type:"strategies",instruction:"Detailed strategies for Great Rune bearers, remembrance bosses, and field bosses.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Character Questlines",type:"characters",instruction:"Track NPC questlines like Ranni, Fia, Millicent, and their current progress.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Remembrances & Items",type:"items",instruction:"Track collected remembrances, Great Runes, and legendary armaments/ashes of war.",priority:"high",isProfileSpecific:!1}]:t.includes("cyberpunk")?[{id:m(),title:"Story Progress",type:"story",instruction:"Track main story missions, relationship with Johnny Silverhand, and key choices made.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Fixers & Gigs",type:"walkthrough",instruction:"List available fixers in current district, active gigs, and completed contracts.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Cyberware Build",type:"strategies",instruction:"Current cyberware loadout, recommended upgrades, and build synergies.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Characters & Relationships",type:"characters",instruction:"Track relationships with Panam, Judy, River, Kerry, and romance options.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Night City Secrets",type:"tips",instruction:"Hidden legendary weapons, iconic gear locations, and easter eggs in current area.",priority:"high",isProfileSpecific:!1}]:t.includes("dark souls")?[{id:m(),title:"Story So Far",type:"story",instruction:"Track the Chosen Undead's journey, Lords of Cinder defeated, and covenant allegiances.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Nearby Bonfires",type:"tips",instruction:"List nearby bonfires, their locations, and connectivity to other areas.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Boss Strategy",type:"strategies",instruction:"Strategies for Lord Souls, required bosses, and optional powerful enemies.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Covenant Progress",type:"walkthrough",instruction:"Track covenant memberships, offering progress, and covenant-specific rewards.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Upgrade Paths",type:"items",instruction:"Weapon upgrade materials, blacksmith locations, and recommended upgrade paths for current build.",priority:"high",isProfileSpecific:!1}]:t.includes("baldur")||t.includes("bg3")?[{id:m(),title:"Story & Choices",type:"story",instruction:"Track main story progress, major decisions made, and their consequences. Note which companions were recruited and key story branches taken.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Companion Approval",type:"characters",instruction:"Track companion relationships, approval ratings, personal quests, and romance progress.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Build & Multiclass",type:"strategies",instruction:"Current character build, multiclass options, and synergistic spell/ability combinations.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Active Quests",type:"walkthrough",instruction:"List active main quests and important side quests in current act, with quest objectives.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Secrets & Items",type:"items",instruction:"Hidden legendary items, secret areas, and missable content in current region.",priority:"high",isProfileSpecific:!1}]:t.includes("witcher")?[{id:m(),title:"Story Progress",type:"story",instruction:"Track main story, key decisions, Ciri's journey, and major political developments.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Contracts & Quests",type:"walkthrough",instruction:"Active witcher contracts, treasure hunts, and important side quests in current region.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Combat & Alchemy",type:"strategies",instruction:"Best potions, oils, and decoctions for current enemies. Sign usage tips and combat strategies.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Characters & Romance",type:"characters",instruction:"Track relationships with Yennefer, Triss, and other key characters. Romance quest progress.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Gear & Diagrams",type:"items",instruction:"Witcher gear sets available, diagram locations, and upgrade materials needed.",priority:"high",isProfileSpecific:!1}]:t.includes("hollow knight")?[{id:m(),title:"Exploration Progress",type:"story",instruction:"Track areas explored, lore discovered, and connections between regions.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Boss Strategies",type:"strategies",instruction:"Detailed strategies for current and nearby bosses, including dream versions and optional challenges.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Charm Builds",type:"items",instruction:"Recommended charm combinations for current playstyle, and where to find new charms.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Hidden Secrets",type:"tips",instruction:"Secret paths, hidden rooms, and breakable walls in current and nearby areas.",priority:"high",isProfileSpecific:!1},{id:m(),title:"NPC Questlines",type:"characters",instruction:"Track NPC locations, quest progress for characters like Hornet, Quirrel, and Bretta.",priority:"high",isProfileSpecific:!1}]:t.includes("god of war")?[{id:m(),title:"Story & Mythology",type:"story",instruction:"Track main story progress, realm visits, and Norse mythology lore discovered.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Boss & Enemy Tactics",type:"strategies",instruction:"Strategies for bosses and tough enemies, including optimal runic attacks and Spartan Rage usage.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Gear & Upgrades",type:"items",instruction:"Best armor sets for current level, weapon upgrades, and where to find crafting materials.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Realm Exploration",type:"tips",instruction:"Areas to explore in current realm, hidden chests, and optional content.",priority:"high",isProfileSpecific:!1},{id:m(),title:"Collectibles",type:"walkthrough",instruction:"Track Odin's Ravens, Nornir Chests, artifacts, and other collectibles in current regions.",priority:"high",isProfileSpecific:!1}]:null}generateInitialSubTabs(e,t,r){let o;if(o=(J[e]||J.Default).map(i=>({...i,priority:"medium",isProfileSpecific:!1})),console.error("üéÆ [GameTabService] Using genre-based subtabs for genre:",e),t){console.error("üéÆ [GameTabService] Generating profile-specific tabs for:",t.playerFocus);const n=V.generateProfileSpecificTabs(t,r);o=[...o,...n],o=V.prioritizeTabsForProfile(o,t)}return o.map(n=>({id:m(),title:n.title,type:n.type,content:"Loading...",isNew:!0,status:"loading",instruction:n.instruction}))}extractInsightsFromAIResponse(e,t){console.error("ü§ñ [GameTabService] Extracting dynamic insights from AI response");const r=e.otakonTags.get("INSIGHT_UPDATE");if(r){console.error("ü§ñ [GameTabService] Found INSIGHT_UPDATE:",r);const o=r;if(!o.id)return console.error("ü§ñ [GameTabService] INSIGHT_UPDATE missing id, skipping"),t;if(t.find(i=>i.id===o.id))return t.map(i=>i.id===o.id?{...i,content:o.content||i.content,isNew:!0,status:"loaded"}:i);{const i={id:m(),title:this.formatTabTitle(o.id),type:this.determineTabType(o.id),content:o.content||"",isNew:!0,status:"loaded"};return[...t,i]}}return t}formatTabTitle(e){return e.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}determineTabType(e){return e.includes("story")?"story":e.includes("character")?"characters":e.includes("strategy")||e.includes("tips")?"tips":e.includes("boss")?"strategies":e.includes("quest")||e.includes("walkthrough")?"walkthrough":e.includes("item")?"items":"chat"}async generateInitialInsights(e,t,r,o){var l,g,d;const n=e.id,i=e.gameTitle;console.error(`ü§ñ [GameTabService] üîÑ [${n}] Generating initial insights for: ${i}`),oe.add(n);try{const c=await T.getConversations(!0);if(!c[n]){console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è Conversation no longer exists, aborting insight generation`);return}let s="";const u=c[n],f=((l=u.messages)==null?void 0:l.length)||0;if(f>10)try{const h=await me.loadConversationSummary(n),_=u.messages.slice(-5).map(A=>`${A.role==="user"?"User":"AI"}: ${A.content}`).join(`

`);h?(s=`Previous Context Summary:
${JSON.stringify(h)}

Recent Messages (guaranteed fresh):
${_}`,console.error(`ü§ñ [GameTabService] [${n}] ‚úÖ Using summary + 5 recent messages (${f} total msgs)`)):(s=u.messages.slice(-10).map(A=>`${A.role==="user"?"User":"AI"}: ${A.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${n}] Using last 10 messages (no summary available)`))}catch{s=u.messages.slice(-10).map(_=>`${_.role==="user"?"User":"AI"}: ${_.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${n}] Using last 10 messages (summary load failed)`)}else f>0?(s=u.messages.map(h=>`${h.role==="user"?"User":"AI"}: ${h.content}`).join(`

`),console.error(`ü§ñ [GameTabService] [${n}] ‚úÖ Using all ${f} messages`)):r!=null&&r.content?(s=`AI Analysis: ${r.content}`,console.error(`ü§ñ [GameTabService] [${n}] Using AI response as context (${r.content.length} chars)`)):console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è No context available`);console.error(`ü§ñ [GameTabService] [${n}] üöÄ Calling AI generateInitialInsights...`);const p=await pe.generateInitialInsights(i||"Unknown Game",e.genre||"Action RPG",t,s,u.gameProgress||0,o);console.error(`ü§ñ [GameTabService] [${n}] üì• AI returned:`,Object.keys(p).length,"insights");const b=p&&Object.keys(p).length>0;b?console.error(`ü§ñ [GameTabService] [${n}] ‚úÖ Got ${Object.keys(p).length} insights:`,Object.keys(p)):console.error(`ü§ñ [GameTabService] [${n}] ‚ùå Empty insights, using fallback`);const w=c[n];if(!w){console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è Conversation not found, may have been deleted`);return}let S=await k.getSubtabs(n);console.error(`ü§ñ [GameTabService] [${n}] üìñ Read ${S.length} subtabs from database`),S.length===0&&e.subtabs&&e.subtabs.length>0&&(console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è No subtabs in DB but ${e.subtabs.length} in memory - retrying write`),await new Promise(_=>setTimeout(_,500)),await k.setSubtabs(n,e.subtabs)?(console.error(`ü§ñ [GameTabService] [${n}] ‚úÖ Retry write succeeded`),S=await k.getSubtabs(n),console.error(`ü§ñ [GameTabService] [${n}] üìñ Re-read ${S.length} subtabs from database`)):(console.error(`ü§ñ [GameTabService] [${n}] ‚ùå Retry write failed - using memory subtabs as fallback`),S=e.subtabs)),w.subtabs=S;const I={"Story So Far":"story_so_far","Items You May Have Missed":"missed_items","Relevant Lore":"game_lore","Build Guide":"build_guide","Plan Your Next Session":"next_session_plan","Active Quests":"quest_log","Build Optimization":"build_optimization","Upcoming Boss Strategy":"boss_strategy","Boss Strategy":"boss_strategy","Hidden Paths & Secrets":"hidden_paths","Points of Interest":"points_of_interest","NPC Interactions":"npc_interactions","Consumable Strategy":"consumable_strategy","Character Building":"character_building","Combat Strategies":"combat_strategies","Quest Guide":"quest_guide","Lore Exploration":"lore_exploration","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Pro Tips":"pro_tips","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Exploration Tips":"exploration_tips","Puzzle Solving":"puzzle_solving","Story Progression":"story_progression","Hidden Secrets":"hidden_secrets","Inventory Optimization":"inventory_optimization","Environmental Storytelling":"environmental_storytelling","Goal Suggestions":"goal_suggestions","Efficiency & Optimization":"efficiency_tips","Hidden Mechanics":"hidden_mechanics","Disaster Prep":"disaster_prep","Milestone Roadmap":"milestone_roadmap","System Bottleneck Analysis":"bottleneck_analysis","Expansion Strategy":"expansion_strategy","Team Management":"team_management","Training Focus":"training_focus","Tactical Analysis":"tactical_analysis","Season Progression":"season_progression","Transfer Market Insights":"transfer_market_insights","Injury & Fatigue Management":"injury_fatigue_management","Opposition Scouting":"opposition_scouting","Meta Analysis":"meta_analysis","Team Coordination":"team_coordination","Map Control":"map_control","Skill Development":"skill_development","Ranked Climbing Guide":"ranked_climbing_guide","Warm-up Routine":"warmup_routine","Counter-Meta Strategies":"counter_meta_strategies","Competitive Strategy":"competitive_strategy","Team Synergy":"team_synergy","Performance Optimization":"performance_optimization","Ranked Progression":"ranked_progression","Seasonal Meta Shifts":"seasonal_meta_shifts","Communication Protocols":"communication_protocols","VOD Review Focus Points":"vod_review_focus","Vehicle Tuning":"vehicle_tuning","Track Strategy":"track_strategy","Race Craft":"race_craft","Championship Focus":"championship_focus","Weather Adaptation":"weather_adaptation","Qualifying Strategy":"qualifying_strategy","Rival Analysis":"rival_analysis","Character Analysis":"character_analysis","Matchup Strategy":"matchup_strategy","Execution Training":"execution_training","Tournament Prep":"tournament_prep","Frame Data Insights":"frame_data_insights","Mid-Match Adaptation":"adaptation_tactics","Character Lab Work":"character_lab_work","Drop Strategy":"drop_strategy","Positioning Tactics":"positioning_tactics","Loadout Optimization":"loadout_optimization","Endgame Strategy":"endgame_strategy","Rotation Management":"rotation_management","Audio Warfare":"audio_warfare","Inventory Economy":"inventory_economy","Class Optimization":"class_optimization","Content Progression":"content_progression","Social Strategies":"social_strategies","Alt Character Strategy":"alt_character_strategy","Reputation & Faction Guide":"reputation_faction_guide","Raid Preparation":"raid_preparation","Puzzle Patterns":"puzzle_patterns","Logical Reasoning":"logical_reasoning","Time Optimization":"time_optimization","Difficulty Progression":"difficulty_progression","Mental Breaks Strategy":"mental_breaks_strategy","Pattern Library":"pattern_library","Achievement & Challenge Guide":"achievement_guide","Survival Strategies":"survival_strategies","Enemy Behavior":"enemy_behavior","Atmosphere Navigation":"atmosphere_navigation","Resource Management":"resource_management","Safe Zone Mapping":"safe_zone_mapping","Sanity Management":"sanity_management","Progressive Fear Adaptation":"fear_adaptation","Death Recovery Strategy":"death_recovery","Level Layout Insights":"level_layout","NPC Questlines":"npc_questlines","New Ability Unlocked":"ability_unlocks","Backtracking Guide":"backtracking_guide","Map Completion":"map_completion","Sequence Breaking Options":"sequence_breaking","Upgrade Priority":"upgrade_priority","Region Guide":"region_guide","Activity Checklist":"activity_checklist","Collectible Hunting":"collectible_hunting","Dynamic World Events":"world_events","Exploration Route":"exploration_route","Fast Travel Optimization":"fast_travel_optimization","Progression Balance":"progression_balance","Resource Locations":"resource_locations","Base Building Guide":"base_building","Crafting Priority":"crafting_priority","Survival Tips":"survival_tips","Exploration Targets":"exploration_targets","Progression Roadmap":"progression_roadmap","Danger Warnings":"danger_warnings","Multiplayer Synergy":"multiplayer_synergy","Seasonal Preparation":"seasonal_preparation"};console.error("ü§ñ [GameTabService] Building content mapping for subtabs..."),console.error("ü§ñ [GameTabService] AI returned insight keys:",Object.keys(p));const E=((g=w.subtabs)==null?void 0:g.map(h=>{let _="";const A=I[h.title];if(A||console.error(`‚ö†Ô∏è [GameTabService] MISSING MAPPING: No titleToKeyMap entry for "${h.title}" - will use fallback`),b&&A&&p[A]?(_=p[A],console.error(`‚úÖ [GameTabService] Subtab "${h.title}" ‚Üí key "${A}" ‚Üí AI content (${_.length} chars)`)):b&&A&&console.error(`‚ö†Ô∏è [GameTabService] Subtab "${h.title}" ‚Üí key "${A}" ‚Üí NOT FOUND in AI response`),!_){let F=s;if(h.type==="story"&&s.includes("Lore:")){const D=s.match(/Lore:(.*?)(?=\n\n|\n[A-Z]|$)/s);F=D?D[1].trim():s}else if(h.type==="strategies"&&s.includes("Analysis:")){const D=s.match(/Analysis:(.*?)(?=\n\n|\n[A-Z]|$)/s);F=D?D[1].trim():s}else if(h.type==="tips"&&s.includes("Hint:")){const D=s.match(/Hint:(.*?)(?=\n\n|\n[A-Z]|$)/s);F=D?D[1].trim():s}_=`## ${h.title}

${F}`,console.error(`ü§ñ [GameTabService] Subtab "${h.title}" using fallback content from AI response (${_.length} chars)`),console.error("ü§ñ [GameTabService] Preview:",_.substring(0,150)+"...")}return{...h,content:_,isNew:!1,status:"loaded",type:h.type}}))||[];if(E.length===0){console.error(`ü§ñ [GameTabService] [${n}] ‚ö†Ô∏è No subtabs to update - aborting`);return}console.error("ü§ñ [GameTabService] Updating subtabs with content...");const P=E.map(h=>{var _;return{id:h.id,title:h.title,type:h.type,status:h.status,contentLength:((_=h.content)==null?void 0:_.length)||0,isNew:h.isNew,hasType:!!h.type}});if(console.error("ü§ñ [GameTabService] Subtabs to save:",P),console.error("ü§ñ [GameTabService] ALL statuses:",E.map(h=>h.status)),console.error("ü§ñ [GameTabService] ALL types:",E.map(h=>h.type||"MISSING_TYPE")),console.error("ü§ñ [GameTabService] üóëÔ∏è Clearing cache BEFORE subtabs write..."),T.clearCache(),!await k.setSubtabs(e.id,E,!0))throw new Error("Failed to update subtabs in database");console.error("ü§ñ [GameTabService] ‚úÖ Subtabs dual-write complete (table + JSONB)"),T.clearCache(),console.error("ü§ñ [GameTabService] üîç Subtabs saved successfully, skipping verification read"),await T.updateConversation(e.id,{updatedAt:Date.now()}),console.error("ü§ñ [GameTabService] ‚úÖ Conversation metadata updated")}catch(c){console.error("ü§ñ [GameTabService] ‚ùå Failed to generate initial insights:",c),O.warning("Failed to load game insights. You can still chat about the game!");try{const u=(await T.getConversations(!0))[e.id];if(!u){console.error("ü§ñ [GameTabService] Conversation not found for error update:",e.id);return}const f=((d=u.subtabs)==null?void 0:d.map(p=>({...p,content:`Failed to load ${p.title} content. Please try again later.`,isNew:!1,status:"error"})))||[];await k.setSubtabs(e.id,f),await T.updateConversation(e.id,{updatedAt:Date.now()})}catch(s){console.error("ü§ñ [GameTabService] Failed to update error state:",s)}}finally{oe.delete(e.id),console.error(`ü§ñ [GameTabService] [${e.id}] Generation tracking cleaned up`)}}async updateSubTabContent(e,t,r){console.error("üìù [GameTabService] Updating sub-tab content:",{conversationId:e,subTabId:t});try{const n=(await T.getConversations())[e];if(!n||!n.subtabs)throw new Error("Conversation or sub-tabs not found");const i=n.subtabs.map(l=>l.id===t?{...l,content:r,isNew:!1,status:"loaded"}:l);await k.setSubtabs(e,i),await T.updateConversation(e,{updatedAt:Date.now()})}catch(o){throw console.error("Failed to update sub-tab content:",o),o}}async getGameTab(e){try{const r=(await T.getConversations())[e];return!r||!r.gameTitle?null:{id:r.id,title:r.title,gameId:r.gameId||r.gameTitle.toLowerCase().replace(/\s+/g,"-"),gameTitle:r.gameTitle,genre:r.genre||"Unknown",subtabs:r.subtabs||[],createdAt:r.createdAt,updatedAt:r.updatedAt,isActiveSession:r.isActiveSession||!1}}catch(t){return console.error("Failed to get game tab:",t),O.error("Failed to load game tab."),null}}isGameTab(e){return!e.isGameHub&&!!e.gameTitle}generateGameConversationId(e){return`game-${e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-")}`}async updateSubtabsAfterMigration(e,t){console.error(`üîÑ [GameTabService] [${e}] Updating subtabs after migration...`);try{const o=(await T.getConversations(!0))[e];if(!o){console.error(`üîÑ [GameTabService] [${e}] ‚ö†Ô∏è Conversation not found, aborting`);return}if(!o.subtabs||o.subtabs.length===0){console.error(`üîÑ [GameTabService] [${e}] No subtabs to update`);return}t!=null&&t.progressiveInsightUpdates&&t.progressiveInsightUpdates.length>0?(console.error(`üîÑ [GameTabService] [${e}] Applying ${t.progressiveInsightUpdates.length} progressive updates`),await this.updateSubTabsFromAIResponse(e,t.progressiveInsightUpdates)):console.error(`üîÑ [GameTabService] [${e}] No progressive updates in AI response`),console.error(`üîÑ [GameTabService] [${e}] ‚úÖ Subtab update complete`)}catch(r){console.error(`üîÑ [GameTabService] [${e}] ‚ùå Failed to update subtabs:`,r)}}async updateSubTabsFromAIResponse(e,t){console.error(`üìù [GameTabService] [${e}] Updating subtabs from AI response:`,t.length),console.error(`üìù [GameTabService] [${e}] Updates to apply:`,t.map(r=>{var o;return{tabId:r.tabId,title:r.title,contentLength:((o=r.content)==null?void 0:o.length)||0}}));try{const o=(await T.getConversations(!0))[e];if(!o||!o.subtabs){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Conversation or subtabs not found, aborting update`);return}console.error(`üìù [GameTabService] [${e}] Found ${o.subtabs.length} subtabs:`,o.subtabs.map(s=>({id:s.id,title:s.title})));const n={"Story So Far":"story_so_far","Items You May Have Missed":"missed_items","Relevant Lore":"game_lore","Build Guide":"build_guide","Plan Your Next Session":"next_session_plan","Active Quests":"quest_log","Build Optimization":"build_optimization","Upcoming Boss Strategy":"boss_strategy","Boss Strategy":"boss_strategy","Hidden Paths & Secrets":"hidden_paths","Points of Interest":"points_of_interest","NPC Interactions":"npc_interactions","Consumable Strategy":"consumable_strategy","Character Building":"character_building","Combat Strategies":"combat_strategies","Quest Guide":"quest_guide","Lore Exploration":"lore_exploration","Companion Management":"companion_management","Side Activity Guide":"side_activity_guide","Loadout Analysis":"loadout_analysis","Map Strategies":"map_strategies","Enemy Intel":"enemy_intel","Pro Tips":"pro_tips","Weapon Mastery":"weapon_mastery","Audio Cues Guide":"audio_cues","Progression Tracker":"progression_tracker","Current State Analysis":"current_board_state","Opening Builds":"opening_moves","Unit Counters":"unit_counters","Economy Management":"economy_guide","Tech Tree Priority":"tech_tree_priority","Map Control Points":"map_control_points","Opponent Analysis":"opponent_analysis","Exploration Tips":"exploration_tips","Puzzle Solving":"puzzle_solving","Story Progression":"story_progression","Hidden Secrets":"hidden_secrets","Inventory Optimization":"inventory_optimization","Environmental Storytelling":"environmental_storytelling","Goal Suggestions":"goal_suggestions","Efficiency & Optimization":"efficiency_tips","Hidden Mechanics":"hidden_mechanics","Disaster Prep":"disaster_prep","Milestone Roadmap":"milestone_roadmap","System Bottleneck Analysis":"bottleneck_analysis","Expansion Strategy":"expansion_strategy","Team Management":"team_management","Training Focus":"training_focus","Tactical Analysis":"tactical_analysis","Season Progression":"season_progression","Transfer Market Insights":"transfer_market_insights","Injury & Fatigue Management":"injury_fatigue_management","Opposition Scouting":"opposition_scouting","Meta Analysis":"meta_analysis","Team Coordination":"team_coordination","Map Control":"map_control","Skill Development":"skill_development","Ranked Climbing Guide":"ranked_climbing_guide","Warm-up Routine":"warmup_routine","Counter-Meta Strategies":"counter_meta_strategies","Competitive Strategy":"competitive_strategy","Team Synergy":"team_synergy","Performance Optimization":"performance_optimization","Ranked Progression":"ranked_progression","Seasonal Meta Shifts":"seasonal_meta_shifts","Communication Protocols":"communication_protocols","VOD Review Focus Points":"vod_review_focus","Vehicle Tuning":"vehicle_tuning","Track Strategy":"track_strategy","Race Craft":"race_craft","Championship Focus":"championship_focus","Weather Adaptation":"weather_adaptation","Qualifying Strategy":"qualifying_strategy","Rival Analysis":"rival_analysis","Character Analysis":"character_analysis","Matchup Strategy":"matchup_strategy","Execution Training":"execution_training","Tournament Prep":"tournament_prep","Frame Data Insights":"frame_data_insights","Mid-Match Adaptation":"adaptation_tactics","Character Lab Work":"character_lab_work","Drop Strategy":"drop_strategy","Positioning Tactics":"positioning_tactics","Loadout Optimization":"loadout_optimization","Endgame Strategy":"endgame_strategy","Rotation Management":"rotation_management","Audio Warfare":"audio_warfare","Inventory Economy":"inventory_economy","Class Optimization":"class_optimization","Content Progression":"content_progression","Social Strategies":"social_strategies","Alt Character Strategy":"alt_character_strategy","Reputation & Faction Guide":"reputation_faction_guide","Raid Preparation":"raid_preparation","Puzzle Patterns":"puzzle_patterns","Logical Reasoning":"logical_reasoning","Time Optimization":"time_optimization","Difficulty Progression":"difficulty_progression","Mental Breaks Strategy":"mental_breaks_strategy","Pattern Library":"pattern_library","Achievement & Challenge Guide":"achievement_guide","Survival Strategies":"survival_strategies","Enemy Behavior":"enemy_behavior","Atmosphere Navigation":"atmosphere_navigation","Resource Management":"resource_management","Safe Zone Mapping":"safe_zone_mapping","Sanity Management":"sanity_management","Progressive Fear Adaptation":"fear_adaptation","Death Recovery Strategy":"death_recovery","Level Layout Insights":"level_layout","NPC Questlines":"npc_questlines","New Ability Unlocked":"ability_unlocks","Backtracking Guide":"backtracking_guide","Map Completion":"map_completion","Sequence Breaking Options":"sequence_breaking","Upgrade Priority":"upgrade_priority","Region Guide":"region_guide","Activity Checklist":"activity_checklist","Collectible Hunting":"collectible_hunting","Dynamic World Events":"world_events","Exploration Route":"exploration_route","Fast Travel Optimization":"fast_travel_optimization","Progression Balance":"progression_balance","Resource Locations":"resource_locations","Base Building Guide":"base_building","Crafting Priority":"crafting_priority","Survival Tips":"survival_tips","Exploration Targets":"exploration_targets","Progression Roadmap":"progression_roadmap","Danger Warnings":"danger_warnings","Multiplayer Synergy":"multiplayer_synergy","Seasonal Preparation":"seasonal_preparation"},i={};for(const[s,u]of Object.entries(n))i[u]=s;let l=0;const g=o.subtabs.map(s=>{const u=t.find(f=>{if(f.tabId===s.id||f.tabId.toLowerCase()===s.title.toLowerCase()||f.title&&f.title.toLowerCase()===s.title.toLowerCase())return!0;const p=i[f.tabId];if(p&&p===s.title)return!0;const b=n[s.title];return!!(b&&b===f.tabId)});if(u){l++,console.error(`üìù [GameTabService] [${e}] ‚úÖ Matched subtab "${s.title}" (${s.id}) with update.tabId="${u.tabId}"`);const f=new Date().toLocaleString(),p=s.content&&s.content.trim().length>0&&s.content!=="Loading..."&&s.status==="loaded";let b;if(p){const w=s.content,S="<!-- LATEST_UPDATE -->";if(w.includes(S)){const E=w.indexOf(S),P=w.substring(0,E).trim(),M=w.substring(E+S.length).trim(),h=`<details>
<summary>üìã Update from ${f}</summary>

${M}

</details>
`;b=(P?P+`

`+h:h)+`

`+S+`

`+u.content}else b=`<details>
<summary>üìã Previous Updates</summary>

${w}

</details>
`+`

`+S+`

`+u.content}else b=`<!-- LATEST_UPDATE -->

`+u.content;if(b.length>re){console.error(`üìù [GameTabService] [${e}] Subtab ${s.id} exceeds ${re} chars, trimming old collapsed sections`);const w=/<details>\s*<summary>.*?<\/summary>[\s\S]*?<\/details>/g,S=b.match(w)||[];if(S.length>2){let I=b;S.slice(0,S.length-2).forEach(M=>{I=I.replace(M,"")}),!I.includes("Earlier history removed")&&I.includes("<!-- LATEST_UPDATE -->")&&(I=`<details>
<summary>‚ÑπÔ∏è Earlier history removed to save space</summary>

Older updates have been automatically removed. Recent updates are preserved.

</details>

`+I),b=I}console.error(`üìù [GameTabService] [${e}] Subtab ${s.id} content trimmed to ${b.length} chars`)}return{...s,title:u.title||s.title,content:b,isNew:!0,status:"loaded"}}return s});if(l===0){console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è No subtabs matched for update`),t.forEach(s=>{console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Unmatched update: tabId="${s.tabId}", title="${s.title}"`)});return}const d=new Set;if(o.subtabs.forEach(s=>{const u=t.find(f=>{if(f.tabId===s.id||f.tabId.toLowerCase()===s.title.toLowerCase()||f.title&&f.title.toLowerCase()===s.title.toLowerCase())return!0;const p=i[f.tabId];if(p&&p===s.title)return!0;const b=n[s.title];return!!(b&&b===f.tabId)});u&&d.add(u.tabId)}),t.forEach(s=>{d.has(s.tabId)||console.error(`üìù [GameTabService] [${e}] ‚ö†Ô∏è Update not matched to any subtab: tabId="${s.tabId}", title="${s.title}"`)}),console.error(`üìù [GameTabService] [${e}] Writing ${l} updated subtabs to normalized table...`),!await k.setSubtabs(e,g))throw console.error(`üìù [GameTabService] [${e}] ‚ùå Failed to write subtabs to table`),new Error("Failed to update subtabs in database");T.clearCache(),await T.updateConversation(e,{updatedAt:Date.now()}),console.error(`üìù [GameTabService] [${e}] ‚úÖ Updated ${l} subtabs successfully (table + cache cleared)`)}catch(r){throw console.error(`üìù [GameTabService] [${e}] ‚ùå Failed to update subtabs:`,r),r}}async generateSubtabsForExistingGameTabs(e,t,r){const o=Object.values(e).filter(n=>!n.isGameHub&&!n.isUnreleased&&n.gameTitle&&(!n.subtabs||n.subtabs.length===0));if(o.length===0){console.log("üîÑ [GameTabService] No game tabs need subtabs generation"),console.log("üîÑ [GameTabService] Existing game tabs:",Object.values(e).filter(n=>!n.isGameHub&&n.gameTitle).map(n=>{var i;return{title:n.gameTitle,hasSubtabs:!!((i=n.subtabs)!=null&&i.length),isUnreleased:n.isUnreleased}}));return}console.log(`üîÑ [GameTabService] Found ${o.length} game tabs that need subtabs:`,o.map(n=>n.gameTitle));for(let n=0;n<o.length;n++){const i=o[n];try{console.log(`üîÑ [GameTabService] Generating subtabs for "${i.gameTitle}" (${n+1}/${o.length})`),o.length>1&&O.info(`Generating insights for ${i.gameTitle}... (${n+1}/${o.length})`);const l=this.generateInitialSubTabs(i.genre||"Default",t,{});if(await T.updateConversation(i.id,{subtabs:l,subtabsOrder:l.map(g=>g.id),updatedAt:Date.now()}),await k.setSubtabs(i.id,l),await this.generateInitialInsights({...i,subtabs:l},t,void 0,"pro"),console.log(`‚úÖ [GameTabService] Successfully generated subtabs for "${i.gameTitle}"`),o.length>1&&O.success(`‚ú® ${i.gameTitle} insights ready!`),r==null||r(n,o.length,i.gameTitle||i.title),n<o.length-1){const g=3e3+Math.random()*2e3;console.log(`üîÑ [GameTabService] Waiting ${Math.round(g)}ms before next game...`),await new Promise(d=>setTimeout(d,g))}}catch(l){console.error(`‚ùå [GameTabService] Failed to generate subtabs for "${i.gameTitle}":`,l),O.error(`Failed to generate insights for ${i.gameTitle}`)}}r==null||r(o.length,o.length,"Complete"),console.log(`üîÑ [GameTabService] Finished generating subtabs for ${o.length} game tabs`)}}const Ze=new Ee,Ve={async fetchGalleryData(a){try{console.log("üñºÔ∏è [GalleryService] Fetching gallery data for user:",a);const{data:e,error:t}=await v.from("conversations").select("id, title, game_title").eq("auth_user_id",a);if(t)return console.error("[GalleryService] Error fetching conversations:",t),{albums:[],totalImages:0,loading:!1,error:t.message};if(!e||e.length===0)return console.log("üñºÔ∏è [GalleryService] No conversations found"),{albums:[],totalImages:0,loading:!1};console.log("üñºÔ∏è [GalleryService] Found",e.length,"conversations");const r=e.map(c=>c.id),{data:o,error:n}=await v.from("messages").select("id, image_url, conversation_id, content, role, created_at").in("conversation_id",r).not("image_url","is",null).order("created_at",{ascending:!1});if(n)return console.error("[GalleryService] Error fetching messages:",n),{albums:[],totalImages:0,loading:!1,error:n.message};console.log("üñºÔ∏è [GalleryService] Found",(o==null?void 0:o.length)||0,"messages with images"),console.log("üñºÔ∏è [GalleryService] Sample image URLs:",o==null?void 0:o.slice(0,3).map(c=>c.image_url));const i=new Map(e.map(c=>[c.id,{title:c.title,gameTitle:c.game_title}])),l=new Map;(o||[]).forEach(c=>{var p;if(!c.image_url)return;const s=i.get(c.conversation_id);if(!s)return;const u={id:c.id,imageUrl:c.image_url,conversationId:c.conversation_id,conversationTitle:s.title||"Untitled",gameTitle:s.gameTitle||void 0,messageContent:((p=c.content)==null?void 0:p.substring(0,100))||void 0,capturedAt:new Date(c.created_at||Date.now()).getTime(),role:c.role},f=l.get(c.conversation_id);f?(f.images.push(u),f.imageCount++,f.latestImageAt=Math.max(f.latestImageAt,u.capturedAt)):l.set(c.conversation_id,{conversationId:c.conversation_id,conversationTitle:s.title||"Untitled",gameTitle:s.gameTitle||void 0,coverUrl:void 0,images:[u],imageCount:1,latestImageAt:u.capturedAt})});const g=Array.from(l.values()).sort((c,s)=>s.latestImageAt-c.latestImageAt),d=g.reduce((c,s)=>c+s.imageCount,0);return{albums:g,totalImages:d,loading:!1}}catch(e){return console.error("[GalleryService] Exception:",e),{albums:[],totalImages:0,loading:!1,error:e instanceof Error?e.message:"Unknown error"}}},async downloadImage(a,e){try{const r=await(await fetch(a)).blob(),o=URL.createObjectURL(r),n=document.createElement("a");return n.href=o,n.download=e||`screenshot_${Date.now()}.png`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),!0}catch(t){return console.error("[GalleryService] Download failed:",t),!1}},addToTimeline(a,e,t,r){we.addEvent({type:"album",eventDate:new Date(a.capturedAt).toISOString().split("T")[0],year:t,title:e,description:r||`Screenshot from ${a.gameTitle||a.conversationTitle}`,photos:[a.imageUrl]})},async getImageCount(a){try{const{data:e}=await v.from("conversations").select("id").eq("auth_user_id",a);if(!e||e.length===0)return 0;const t=e.map(n=>n.id),{count:r,error:o}=await v.from("messages").select("id",{count:"exact",head:!0}).in("conversation_id",t).not("image_url","is",null);return o?(console.error("[GalleryService] Count error:",o),0):r||0}catch(e){return console.error("[GalleryService] Count exception:",e),0}},filterByGame(a,e){return a.filter(t=>{var r;return(r=t.gameTitle)==null?void 0:r.toLowerCase().includes(e.toLowerCase())})},getGameTitles(a){const e=new Set;return a.forEach(t=>{t.gameTitle&&e.add(t.gameTitle)}),Array.from(e).sort()}},ke=[{pattern:/\b(elden ring)\b/i,game:"Elden Ring"},{pattern:/\b(dark souls 3|ds3|darksouls 3)\b/i,game:"Dark Souls III"},{pattern:/\b(dark souls 2|ds2|darksouls 2)\b/i,game:"Dark Souls II"},{pattern:/\b(dark souls|ds1|darksouls)\b/i,game:"Dark Souls"},{pattern:/\b(bloodborne)\b/i,game:"Bloodborne"},{pattern:/\b(sekiro)\b/i,game:"Sekiro: Shadows Die Twice"},{pattern:/\b(god of war ragnarok|gow ragnarok)\b/i,game:"God of War Ragnar√∂k"},{pattern:/\b(god of war|gow)\b/i,game:"God of War"},{pattern:/\b(horizon forbidden west|hfw)\b/i,game:"Horizon Forbidden West"},{pattern:/\b(zelda totk|tears of the kingdom)\b/i,game:"The Legend of Zelda: Tears of the Kingdom"},{pattern:/\b(zelda botw|breath of the wild)\b/i,game:"The Legend of Zelda: Breath of the Wild"},{pattern:/\b(baldur's gate 3|bg3)\b/i,game:"Baldur's Gate 3"},{pattern:/\b(witcher 3)\b/i,game:"The Witcher 3: Wild Hunt"},{pattern:/\b(cyberpunk 2077|cyberpunk)\b/i,game:"Cyberpunk 2077"},{pattern:/\b(minecraft)\b/i,game:"Minecraft"},{pattern:/\b(terraria)\b/i,game:"Terraria"},{pattern:/\b(stardew valley)\b/i,game:"Stardew Valley"},{pattern:/\b(hollow knight)\b/i,game:"Hollow Knight"},{pattern:/\b(hades)\b/i,game:"Hades"},{pattern:/\b(celeste)\b/i,game:"Celeste"},{pattern:/\bplaying\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,4})\b/,capture:1},{pattern:/\bin\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,4})\b/,capture:1},{pattern:/\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,4})\s+boss\b/,capture:1}];function De(a){const e=a.trim();for(const{pattern:t,game:r,capture:o}of ke){const n=e.match(t);if(n)return r||(o?n[o]:null)}return null}async function de(a,e,t){const r=De(e);return r?(console.log(`üìù [KnowledgeInjection] Game detected from text: "${r}"`),a.gameTitle&&r.toLowerCase()!==a.gameTitle.toLowerCase()&&console.log(`üîÑ [KnowledgeInjection] Different game mentioned: "${r}" (current tab: "${a.gameTitle}")`),r):a.gameTitle?(t?(console.log(`üì∑ [KnowledgeInjection] Screenshot in "${a.gameTitle}" tab ‚Üí Injecting knowledge WITH conditional instructions`),console.log("üí° [KnowledgeInjection] AI will verify game context and ignore if screenshot is different game")):console.log(`üéÆ [KnowledgeInjection] Text in "${a.gameTitle}" tab ‚Üí Using tab's knowledge`),a.gameTitle):(console.log("‚ùì [KnowledgeInjection] No game context ‚Üí Using AI training data only"),null)}async function Le(a,e,t){const r=await de(a,e,t);if(!r)return"";const o=le.getByGameTitle(r);if(!(o!=null&&o.igdbGameId))return console.warn(`‚ö†Ô∏è [KnowledgeInjection] Game "${r}" not in library, no IGDB ID`),"";try{const n=await N.get(o.igdbGameId);if(!n.cached||!n.knowledge)return console.log(`üíæ [KnowledgeInjection] No cached knowledge for "${r}", using AI training data`),"";const i=Math.ceil(n.knowledge.length/4);return console.log(`‚úÖ [KnowledgeInjection] Injecting FULL knowledge for "${r}": ${n.knowledge.length} chars (~${i} tokens)`),console.log(`üåç [KnowledgeInjection] Source: ${n.source} (populated by Pro/Vanguard, benefits ALL users)`),`

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üéÆ GAME KNOWLEDGE DATABASE: "${r.toUpperCase()}"
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ö†Ô∏è VERIFY FIRST - BEFORE READING FURTHER:

Is this query about "${r}"?
  ‚úÖ YES ‚Üí Continue reading, use this knowledge
  ‚ùå NO ‚Üí STOP, ignore everything below, use training data instead

Quick verification checklist:
‚Ä¢ Does query mention "${r}" by name? 
‚Ä¢ Do boss/item/location names match "${r}"?
‚Ä¢ Does screenshot show "${r}" UI/visuals?

If verification FAILS:
‚Üí Do NOT read or use the knowledge below
‚Üí Use your training data for the actual game
‚Üí Return [OTAKON_GAME_ID: ActualGameName]

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìö COMPREHENSIVE KNOWLEDGE FOR "${r}" (${i} tokens):

${n.knowledge}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
END OF ${r.toUpperCase()} KNOWLEDGE DATABASE
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

`}catch(n){return console.error(`‚ùå [KnowledgeInjection] Failed to fetch knowledge for "${r}":`,n),""}}const Xe=Object.freeze(Object.defineProperty({__proto__:null,determineGameForKnowledgeInjection:de,getGameKnowledgeContext:Le},Symbol.toStringTag,{value:"Module"}));export{Be as a,_e as b,q as c,Ye as d,Ve as e,We as f,Ze as g,ge as h,Ue as i,He as j,je as k,le as l,ze as m,qe as n,Ke as o,Fe as p,Oe as q,Ne as r,Je as s,we as t,te as u,N as v,Me as w,Qe as x,Xe as y};
